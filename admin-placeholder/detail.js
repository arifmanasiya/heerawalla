"use strict";(()=>{(()=>{let n={tab:"orders",role:"",email:"",selectedId:"",selectedItem:null,originalValues:{},originalRaw:{},originalNotes:"",orderDetails:{},dirtySections:{edits:!1,fulfillment:!1},criticalDirty:!1,pendingChanges:[],confirmation:null,isNewRow:!1,catalogHeaders:[],catalogEnums:null,catalogFormState:null,catalogOriginalFields:null,catalogMediaState:null,catalogStoneOptions:null,catalogMetalOptions:null,catalogNotes:null,catalogValidation:null,mediaLibraryItems:[],sizingSpec:null,recommendedOptionIndex:null},T={orders:["NEW","ACKNOWLEDGED","PENDING_CONFIRMATION","INVOICED","INVOICE_EXPIRED","INVOICE_PAID","PROCESSING","SHIPPED","DELIVERED","CANCELLED"],quotes:["NEW","ACKNOWLEDGED","QUOTED","QUOTE_ACTIONED","DROPPED"],tickets:["NEW","PENDING","RESOLVED"],contacts:[],products:[],inspirations:[],"media-library":[],"price-chart":[],"cost-chart":[],"diamond-price-chart":[]},A={orders:[{action:"acknowledge",label:"Acknowledge",confirm:"Mark as acknowledged?"},{action:"send_invoice",label:"Send invoice",confirm:"Send invoice and mark invoiced?"},{action:"mark_paid",label:"Mark paid",confirm:"Confirm payment received?"},{action:"mark_invoice_expired",label:"Mark invoice expired",confirm:"Mark invoice as expired?"},{action:"mark_processing",label:"Mark processing",confirm:"Move order into processing?"},{action:"mark_shipped",label:"Mark shipped",confirm:"Mark as shipped?"},{action:"mark_delivered",label:"Mark delivered",confirm:"Mark as delivered?"},{action:"cancel",label:"Cancel order",confirm:"Cancel this order?"},{action:"delete",label:"Delete",confirm:"Delete this order? This cannot be undone."}],quotes:[{action:"acknowledge",label:"Acknowledge",confirm:"Mark as acknowledged?"},{action:"submit_quote",label:"Send quote link",confirm:"Send quote link to customer?"},{action:"refresh_quote",label:"Refresh quote link",confirm:"Send a refreshed quote link?"},{action:"mark_actioned",label:"Mark quote actioned",confirm:"Mark quote as actioned?"},{action:"drop",label:"Drop",confirm:"Drop this quote?"},{action:"delete",label:"Delete",confirm:"Delete this quote? This cannot be undone."}],tickets:[{action:"mark_pending",label:"Mark pending",confirm:"Mark as pending?"},{action:"mark_resolved",label:"Mark resolved",confirm:"Mark as resolved?"},{action:"send_email",label:"Send email",confirm:"Send an email to this customer?"},{action:"delete",label:"Delete",confirm:"Delete this ticket? This cannot be undone."}],contacts:[],products:[{action:"delete",label:"Delete",confirm:"Delete this product? This cannot be undone."}],inspirations:[],"media-library":[],"price-chart":[],"cost-chart":[],"diamond-price-chart":[]},E={orders:["price","timeline","timeline_adjustment_weeks","metal","metal_weight","metal_weight_adjustment","stone","stone_weight","notes"],quotes:["timeline","timeline_adjustment_weeks","metal","metal_weight","stone","stone_weight","diamond_breakdown","size","quote_metal_options","quote_option_1_clarity","quote_option_1_color","quote_option_1_price_18k","quote_option_2_clarity","quote_option_2_color","quote_option_2_price_18k","quote_option_3_clarity","quote_option_3_color","quote_option_3_price_18k","quote_discount_type","quote_discount_percent","notes"],tickets:["notes"],contacts:[],products:[],inspirations:[],"media-library":[],"price-chart":["metal","adjustment_type","adjustment_value","notes"],"cost-chart":["key","value","unit","notes"],"diamond-price-chart":["clarity","color","weight_min","weight_max","price_per_ct","notes"]},I=[{key:"price",label:"Price",normalize:Ha,format:ne},{key:"timeline",label:"Timeline",normalize:Tt,format:ze},{key:"timeline_adjustment_weeks",label:"Timeline delay",normalize:$e,format:ot},{key:"metal",label:"Metal",normalize:be,format:Ot},{key:"metal_weight",label:"Metal weight (g)",normalize:$e,format:xt},{key:"metal_weight_adjustment",label:"Final Metal weight difference (g)",normalize:$e,format:Dt},{key:"stone",label:"Stone type",normalize:be,format:Ot},{key:"stone_weight",label:"Stone weight",normalize:$e,format:at}],U=["shipping_method","shipping_carrier","tracking_number","tracking_url","shipping_status","delivery_eta","shipping_notes","certificates","care_details","warranty_details","service_details"],z=["shipping_carrier","tracking_number","certificates","care_details","warranty_details","service_details"],G={NEW:["ACKNOWLEDGED","CANCELLED"],ACKNOWLEDGED:["PENDING_CONFIRMATION","INVOICED","CANCELLED"],PENDING_CONFIRMATION:["INVOICED","CANCELLED"],INVOICED:["INVOICE_PAID","INVOICE_EXPIRED","CANCELLED"],INVOICE_EXPIRED:["INVOICED","CANCELLED"],INVOICE_PAID:["PROCESSING","SHIPPED"],PROCESSING:["SHIPPED"],SHIPPED:["DELIVERED"],DELIVERED:[],CANCELLED:["INVOICED"]},R={NEW:["acknowledge","cancel"],ACKNOWLEDGED:["send_invoice","cancel"],PENDING_CONFIRMATION:["send_invoice","cancel"],INVOICED:["mark_paid","mark_invoice_expired","cancel"],INVOICE_EXPIRED:["send_invoice","cancel"],INVOICE_PAID:["mark_processing","mark_shipped"],PROCESSING:["mark_shipped"],SHIPPED:["mark_delivered"],DELIVERED:[],CANCELLED:["send_invoice"]},Q={orders:"Order",quotes:"Quote",tickets:"Customer ticket",contacts:"Contact",products:"Product",inspirations:"Inspiration","media-library":"Media library","price-chart":"Price chart","cost-chart":"Cost chart","diamond-price-chart":"Diamond price chart"},h=new Set(["price-chart","cost-chart","diamond-price-chart"]),S=new Set(["products","inspirations","media-library"]),te=new Set(["products","inspirations"]),fe="basics",f=[{clarity:"quote_option_1_clarity",color:"quote_option_1_color",price:"quote_option_1_price_18k"},{clarity:"quote_option_2_clarity",color:"quote_option_2_color",price:"quote_option_2_price_18k"},{clarity:"quote_option_3_clarity",color:"quote_option_3_color",price:"quote_option_3_price_18k"}],q=new Set(f.map(e=>e.price)),w=new Set(["metal","metal_weight","stone","stone_weight","diamond_breakdown","timeline","timeline_adjustment_weeks","quote_discount_type","quote_discount_percent","size","size_label","size_ring","size_bracelet","size_chain"]),_=new Map;f.forEach((e,t)=>{_.set(e.clarity,t),_.set(e.color,t),_.set(e.price,t)});let N=["metal","metal_weight","stone","stone_weight","diamond_breakdown","diamond_breakdown_components","timeline","timeline_adjustment_weeks","quote_discount_type","quote_discount_percent","size","size_label","size_ring","size_bracelet","size_chain","clarity","color"],ae=new Set(["price","timeline","timeline_adjustment_weeks","metal","metal_weight","metal_weight_adjustment","stone","stone_weight"]),Y={fedex:"https://www.fedex.com/apps/fedextrack/?tracknumbers=",ups:"https://www.ups.com/track?tracknum=",dhl:"https://www.dhl.com/en/express/tracking.html?AWB=",usps:"https://tools.usps.com/go/TrackConfirmAction?tLabels="},V=new Set(["in transit","out for delivery","delivered","picked up","exception"]),pe=["diamond","lab grown diamond"],De=[{value:"center",label:"Center"},{value:"accent",label:"Accent"},{value:"side",label:"Side"},{value:"halo",label:"Halo"}],Et=[{value:"xsmall",label:"X-Small"},{value:"small",label:"Small"},{value:"medium",label:"Medium"},{value:"large",label:"Large"},{value:"xlarge",label:"X-Large"},{value:"xxlarge",label:"XX-Large"}],Ra=[{value:"round",label:"Round"},{value:"pear",label:"Pear"},{value:"oval",label:"Oval"},{value:"marquise",label:"Marquise"},{value:"princess",label:"Princess"},{value:"emerald",label:"Emerald"},{value:"radiant",label:"Radiant"},{value:"cushion",label:"Cushion"},{value:"heart",label:"Heart"},{value:"asscher",label:"Asscher"},{value:"baguette",label:"Baguette"}],qt=["description","long_desc"],Xe=["takeaway","translation_note"],Fa=["Metal weight confirmed","Diamond breakdown confirmed","Customer confirmation sent","Vendor assigned","Tracking added"],Lt=40,ge=[],ye=e=>{let t=String(e||"NEW").trim().toUpperCase();return t==="INVOICE_NOT_PAID"?"INVOICE_EXPIRED":t||"NEW"},$n=()=>{let e=ye(n.selectedItem?.status);return(G[e]||[]).filter(a=>a!=="PENDING_CONFIRMATION")};function Ze(){return n.tab==="orders"||n.tab==="quotes"||n.tab==="tickets"?n.role==="admin"||n.role==="ops":n.tab==="price-chart"||n.tab==="cost-chart"||n.tab==="diamond-price-chart"?n.role==="admin":S.has(n.tab)?n.role==="admin"||n.role==="ops":!1}let i={syncLine:document.querySelector("[data-sync-line]"),userRole:document.querySelector("[data-user-role]"),userEmail:document.querySelector("[data-user-email]"),backLink:document.querySelector("[data-back-link]"),detailHeader:document.querySelector("[data-detail-header]"),detailType:document.querySelector("[data-detail-type]"),detailTitle:document.querySelector("[data-detail-title]"),detailSub:document.querySelector("[data-detail-sub]"),detailError:document.querySelector("[data-detail-error]"),detailStatusCorner:document.querySelector("[data-detail-status-corner]"),detailGrid:document.querySelector("[data-detail-grid]"),overviewSection:document.querySelector("[data-overview-section]"),catalogSection:document.querySelector("[data-catalog-section]"),catalogTitle:document.querySelector("[data-catalog-title]"),catalogTabs:Array.from(document.querySelectorAll("[data-catalog-tab]")),catalogPanels:Array.from(document.querySelectorAll("[data-catalog-panel]")),catalogFields:document.querySelector("[data-catalog-fields]"),catalogFieldsBasic:document.querySelector("[data-catalog-fields-basic]"),catalogFieldsTaxonomy:document.querySelector("[data-catalog-fields-taxonomy]"),catalogFieldsMaterials:document.querySelector("[data-catalog-fields-materials]"),catalogFieldsAudit:document.querySelector("[data-catalog-fields-audit]"),catalogMediaSection:document.querySelector("[data-catalog-media-section]"),catalogMediaList:document.querySelector("[data-catalog-media-list]"),mediaFile:document.querySelector("[data-media-file]"),mediaLabel:document.querySelector("[data-media-label]"),mediaAlt:document.querySelector("[data-media-alt]"),mediaDescription:document.querySelector("[data-media-description]"),mediaPosition:document.querySelector("[data-media-position]"),mediaOrder:document.querySelector("[data-media-order]"),mediaPrimary:document.querySelector("[data-media-primary]"),mediaUpload:document.querySelector("[data-media-upload]"),mediaId:document.querySelector("[data-media-id]"),mediaPreview:document.querySelector("[data-media-preview]"),mediaPositionExisting:document.querySelector("[data-media-position-existing]"),mediaOrderExisting:document.querySelector("[data-media-order-existing]"),mediaPrimaryExisting:document.querySelector("[data-media-primary-existing]"),mediaLink:document.querySelector("[data-media-link]"),mediaDetailSection:document.querySelector("[data-media-detail-section]"),mediaDetailPreview:document.querySelector("[data-media-detail-preview]"),mediaDetailGenerate:document.querySelector("[data-media-detail-generate]"),mediaDetailId:document.querySelector("[data-media-detail-id]"),mediaDetailType:document.querySelector("[data-media-detail-type]"),mediaDetailUrl:document.querySelector("[data-media-detail-url]"),catalogNotesSection:document.querySelector("[data-catalog-notes-section]"),noteEditors:Array.from(document.querySelectorAll("[data-note-editor]")),noteSaveButtons:Array.from(document.querySelectorAll("[data-note-save]")),noteAddButtons:Array.from(document.querySelectorAll("[data-note-add]")),noteRows:Array.from(document.querySelectorAll("[data-note-rows]")),noteInputs:Array.from(document.querySelectorAll("[data-note-input]")),noteOrders:Array.from(document.querySelectorAll("[data-note-order]")),catalogStoneSection:document.querySelector("[data-catalog-stone-section]"),catalogStoneList:document.querySelector("[data-catalog-stone-list]"),stoneAddRole:document.querySelector("[data-stone-add-role]"),stoneAddCarat:document.querySelector("[data-stone-add-carat]"),stoneAddCount:document.querySelector("[data-stone-add-count]"),stoneAddSizeType:document.querySelector("[data-stone-add-size-type]"),stoneAddShape:document.querySelector("[data-stone-add-shape]"),stoneAddPrimary:document.querySelector("[data-stone-add-primary]"),stoneAddButton:document.querySelector("[data-stone-add]"),catalogMetalSection:document.querySelector("[data-catalog-metal-section]"),catalogMetalList:document.querySelector("[data-catalog-metal-list]"),metalAddWeight:document.querySelector("[data-metal-add-weight]"),metalAddSizeType:document.querySelector("[data-metal-add-size-type]"),metalAddPrimary:document.querySelector("[data-metal-add-primary]"),metalAddButton:document.querySelector("[data-metal-add]"),actionRow:document.querySelector("[data-action-row]"),actionSelect:document.querySelector("[data-action-select]"),actionRun:document.querySelector("[data-action-run]"),editSection:document.querySelector("[data-edit-section]"),quoteSection:document.querySelector("[data-quote-section]"),quoteMetals:Array.from(document.querySelectorAll('[data-quote-metals] input[type="checkbox"]')),quoteMetalInput:document.querySelector('[data-field="quote_metal_options"]'),quoteOptionCards:Array.from(document.querySelectorAll("[data-quote-option-card]")),quoteOptionStatuses:Array.from(document.querySelectorAll("[data-quote-option-status]")),quoteExtras:document.querySelector("[data-quote-extras]"),metalWeightLabel:document.querySelector("[data-metal-weight-label]"),metalWeightAdjustmentLabel:document.querySelector("[data-metal-weight-adjustment-label]"),metalWeightFinal:document.querySelector("[data-metal-weight-final]"),metalWeightError:document.querySelector("[data-metal-weight-error]"),metalWeightAdjustmentError:document.querySelector("[data-metal-weight-adjustment-error]"),editFields:Array.from(document.querySelectorAll("[data-field]")),orderDetailsSection:document.querySelector("[data-order-details-section]"),orderDetailsFields:Array.from(document.querySelectorAll("[data-order-details-field]")),diamondBreakdown:document.querySelector("[data-diamond-breakdown]"),diamondBreakdownRows:document.querySelector("[data-diamond-breakdown-rows]"),diamondBreakdownAdd:document.querySelector("[data-diamond-breakdown-add]"),diamondPieceCount:document.querySelector("[data-diamond-piece-count]"),diamondCaratTotal:document.querySelector("[data-diamond-carat-total]"),sizeRing:document.querySelector("[data-size-ring] input"),sizeBracelet:document.querySelector("[data-size-bracelet] input"),sizeChain:document.querySelector("[data-size-chain] input"),sizeBlock:document.querySelector("[data-size-block]"),detailsSave:document.querySelector("[data-details-save]"),primaryAction:document.querySelector("[data-primary-action]"),notesSave:document.querySelector("[data-notes-save]"),goldRefresh:document.querySelector("[data-gold-refresh]"),confirmModal:document.querySelector("[data-confirm-modal]"),confirmClose:document.querySelector("[data-confirm-close]"),confirmTo:document.querySelector("[data-confirm-to]"),confirmSubject:document.querySelector("[data-confirm-subject]"),confirmPreview:document.querySelector("[data-confirm-preview]"),confirmSend:document.querySelector("[data-confirm-send]"),dirtyIndicator:document.querySelector("[data-dirty-indicator]"),missingPanel:document.querySelector("[data-missing-panel]"),missingList:document.querySelector("[data-missing-list]"),activityFeed:document.querySelector("[data-activity-feed]"),summaryStatus:document.querySelector("[data-summary-status]"),summaryProduct:document.querySelector("[data-summary-product]"),summaryDesignCode:document.querySelector("[data-summary-design-code]"),summaryRequest:document.querySelector("[data-summary-request]"),summaryCreated:document.querySelector("[data-summary-created]"),summaryPrice:document.querySelector("[data-summary-price]"),summaryTimeline:document.querySelector("[data-summary-timeline]"),summaryTimelineDelay:document.querySelector("[data-summary-timeline-delay]"),summaryMetal:document.querySelector("[data-summary-metal]"),summaryStone:document.querySelector("[data-summary-stone]"),summaryStoneWeight:document.querySelector("[data-summary-stone-weight]"),summaryMetalWeight:document.querySelector("[data-summary-metal-weight]"),summaryMetalAdjustment:document.querySelector("[data-summary-metal-adjustment]"),summaryDiamondBreakdown:document.querySelector("[data-summary-diamond-breakdown]"),summaryDiscount:document.querySelector("[data-summary-discount]"),summaryPricingStatus:document.querySelector("[data-summary-pricing-status]"),summaryInterests:document.querySelector("[data-summary-interests]"),summaryContactPreference:document.querySelector("[data-summary-contact-preference]"),summarySubscription:document.querySelector("[data-summary-subscription]"),summaryCustomerNotes:document.querySelector("[data-summary-customer-notes]"),summaryOption1:document.querySelector("[data-summary-option-1]"),summaryOption2:document.querySelector("[data-summary-option-2]"),summaryOption3:document.querySelector("[data-summary-option-3]"),summaryOptionRecommended:document.querySelector("[data-summary-option-recommended]"),summaryLastPriced:document.querySelector("[data-summary-last-priced]"),summarySizeRing:document.querySelector("[data-summary-size-ring]"),summarySizeBracelet:document.querySelector("[data-summary-size-bracelet]"),summarySizeChain:document.querySelector("[data-summary-size-chain]"),summaryCustomer:document.querySelector("[data-summary-customer]"),summaryEmail:document.querySelector("[data-summary-email]"),summaryPhone:document.querySelector("[data-summary-phone]"),summaryAddress:document.querySelector("[data-summary-address]"),summaryCard:document.querySelector("[data-summary-card]"),detailAside:document.querySelector(".detail-aside"),summaryQuoteBlock:document.querySelector("[data-summary-quote-block]"),summaryPreferencesBlock:document.querySelector("[data-summary-preferences-block]"),summaryOptionsBlock:document.querySelector("[data-summary-options-block]"),summaryNotesBlock:document.querySelector("[data-summary-notes-block]"),summarySizesBlock:document.querySelector("[data-summary-sizes-block]"),summaryMore:document.querySelector("[data-summary-more]"),summaryPriceRow:document.querySelector("[data-summary-price-row]"),nextActionPanel:document.querySelector("[data-next-action-panel]"),copyCustomer:document.querySelector("[data-copy-customer]"),copyEmail:document.querySelector("[data-copy-email]"),copyPhone:document.querySelector("[data-copy-phone]"),copyAddress:document.querySelector("[data-copy-address]"),copySummary:document.querySelector("[data-copy-summary]"),nextActionText:document.querySelector("[data-next-action-text]"),discountPanel:document.querySelector("[data-discount-panel]"),discountType:document.querySelector("[data-discount-type]"),discountPercent:document.querySelector("[data-discount-percent]"),discountFinal:document.querySelector("[data-discount-final]"),breakdownRaw:document.querySelector("[data-breakdown-raw]"),breakdownRawToggle:document.querySelector("[data-breakdown-raw-toggle]"),optionFinals:Array.from(document.querySelectorAll("[data-option-final]")),optionActiveToggles:Array.from(document.querySelectorAll("[data-option-active]")),optionRecommendRadios:Array.from(document.querySelectorAll("[data-option-recommend]")),optionCopyButtons:Array.from(document.querySelectorAll("[data-option-copy]")),optionAutoButtons:Array.from(document.querySelectorAll("[data-option-auto]")),activitySection:document.querySelector("[data-activity-section]"),activitySlot:document.querySelector("[data-activity-slot]"),diamondPresets:document.querySelector("[data-diamond-presets]"),noteTimestamp:document.querySelector("[data-note-timestamp]"),noteTemplate:document.querySelector("[data-note-template]"),noteTags:Array.from(document.querySelectorAll("[data-note-tag]")),notesToggle:document.querySelector("[data-notes-toggle]"),openTracking:document.querySelector("[data-open-tracking]"),toast:document.querySelector("[data-toast]")};function Me(){if(typeof window>"u")return"";let e=localStorage.getItem("adminApiBase")||"";if(e)return e;let t=document.body?.dataset?.apiBase;if(t)return t;let a=window.location.hostname;return a==="localhost"||a==="127.0.0.1"||a.startsWith("127.")||a==="::1"?`${window.location.origin}/admin`:"https://admin-api.heerawalla.com/admin"}let zn=Me(),ke=(document.body.dataset.siteBase||"https://www.heerawalla.com").replace(/\/$/,""),Pe=!1,et=null,Ee=new Set,ie={options:f.map(()=>({status:"idle",signature:"",lastPayload:null,lastError:"",lastPricedAt:""})),inflight:new Map,cache:new Map},K={data:null,promise:null},tt=new Map;function At(){if(typeof window>"u")return"";try{return localStorage.getItem("adminEmail")||""}catch{return""}}function Ba(e={},t=""){let a={"Content-Type":"application/json",...e},o=t||"";return o&&(a["X-Admin-Email"]=o),a}function qe(e){return e.startsWith("http://localhost")||e.startsWith("http://127.0.0.1")}function Nt(e,t,a){qe(t)&&a&&e.searchParams.set("admin_email",a)}function It(e,t){e&&(e.disabled=!t,e.classList.toggle("is-disabled",!t))}function Ua(e){if(!e)return;let t=document.querySelector(e);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),typeof t.focus=="function"&&t.focus({preventScroll:!0}))}function ja(e,t){if(!e||typeof t!="function")return;e.querySelectorAll("input,select,textarea").forEach(o=>{let r=()=>t(o);o.addEventListener("input",r),o.addEventListener("change",r)})}function Va(e){if(e)if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(e).catch(()=>{});else{let t=document.createElement("textarea");t.value=e,t.setAttribute("readonly","true"),t.style.position="fixed",t.style.left="-9999px",document.body.appendChild(t),t.select();try{document.execCommand("copy")}catch{}document.body.removeChild(t)}}function C(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function b(e){return C(e).replace(/`/g,"&#96;")}function he(e){let t=String(e||"").trim();if(!t)return"";if(/^(https?:|data:|blob:)/i.test(t)){try{let a=new URL(t);if(ke&&(a.hostname==="business.heerawalla.com"||a.hostname==="admin-api.heerawalla.com"))return`${ke}${a.pathname}${a.search||""}`}catch{return t}return t}return t.startsWith("//")?`https:${t}`:ke?t.startsWith("/")?`${ke}${t}`:`${ke}/${t}`:t}function be(e){return String(e||"").trim().toLowerCase()}function $e(e){let t=String(e||"").trim();if(!t)return"";let a=Number(t);return Number.isNaN(a)?t.toLowerCase():String(a)}function Ha(e){let t=String(e||"").replace(/[^0-9.]/g,"");if(!t)return"";let a=Number(t);return Number.isNaN(a)?t:String(a)}function Tt(e){let t=be(e);return t?t.includes("rush")?"rush":t.includes("standard")?"standard":t:""}function Ot(e){return String(e||"").trim()}function at(e){let t=String(e||"").trim();if(!t)return"";let a=Number(t);return Number.isNaN(a)?t:`${a} ct`}function xt(e){let t=String(e||"").trim();if(!t)return"";let a=Number(t);return Number.isNaN(a)?t:`${a} g`}function Dt(e){let t=String(e||"").trim();if(!t)return"";let a=Number(t);return Number.isNaN(a)?t:`${a>0?"+":""}${a} g`}function M(e){return e!=null&&String(e).trim()!==""}function Mt(e){let t=e?.sizing||e?.sizing_details||e?.sizing_info||e?.size_details||e?.size_info;if(!t)return{};if(typeof t=="object")return t;if(typeof t=="string")try{let a=JSON.parse(t);if(a&&typeof a=="object")return a}catch{return{}}return{}}function se(e,t,a,o){for(let r of o){let s=e?e[r]:"";if(M(s))return s;let l=t?t[r]:"";if(M(l))return l;let c=a?a[r]:"";if(M(c))return c}return""}function Pt(e){return[e?.notes,e?.customer_notes,e?.request_notes,e?.size,e?.size_details,e?.sizeDetails,e?.body,e?.email_body,e?.email_text,e?.request_body,e?.quote_body,e?.summary,e?.summary_text,e?.details,e?.inquiry,e?.message].filter(M).join(`
`)}function $t(e){if(!M(e))return{};let t=a=>{let o=e.match(a);return o&&o[1]?o[1].trim():""};return{ring:t(/\bring(?:\s*size)?\s*:\s*([^|\n,;]+)/i),wrist:t(/\b(?:wrist|bracelet)(?:\s*size)?\s*:\s*([^|\n,;]+)/i),neck:t(/\b(?:neck|necklace|chain)(?:\s*(?:size|length))?\s*:\s*([^|\n,;]+)/i),earring:t(/\bearrings?(?:\s*(?:style|type|size|preference))?\s*:\s*([^|\n,;]+)/i)}}function Rn(e){let t=Mt(e),a=[],o=$t(Pt(e)),r=se(e,t,o,["ring_size","ring","ringSize"]),s=se(e,t,o,["wrist_size","wrist","bracelet_size","bracelet"]),l=se(e,t,o,["neck_size","neck","chain_size","chain_length","necklace_size","necklace_length"]),c=se(e,t,o,["earring_style","earring_type","earring","earring_size"]);return M(r)&&a.push(["Ring size",r]),M(s)&&a.push(["Wrist size",s]),M(l)&&a.push(["Neck/chain size",l]),M(c)&&a.push(["Earring style",c]),!a.length&&M(e?.size)&&a.push(["Size",e.size]),a}function Wa(e){let t=e?.tags,a=(Array.isArray(t)?t:String(t||"").split(/[|,;\n]/)).map(m=>String(m||"").trim().toLowerCase()).filter(Boolean),o=m=>m.some(p=>a.includes(p)),r=o(["set","sets"]),s=o(["ring","rings","band","bands"]),l=o(["bracelet","bracelets","bangle","bangles","wrist"]),c=o(["pendant","pendants","necklace","necklaces","chain","chains"]);if(a.length){let m=r&&!s&&!l&&!c;return{ring:s||m,bracelet:l||m,chain:c||m}}let d=String(e?.category||e?.categories||"").toLowerCase().replace(/\s+/g," ");return d.includes("set")?{ring:!0,bracelet:!0,chain:!0}:{ring:d.includes("ring")||d.includes("band"),bracelet:d.includes("bracelet")||d.includes("bangle"),chain:d.includes("pendant")||d.includes("necklace")||d.includes("chain")}}let it=!1;function Ga(e){let t=[];return M(e.ring)&&t.push(`Ring size: ${e.ring}`),M(e.bracelet)&&t.push(`Bracelet size: ${e.bracelet}`),M(e.chain)&&t.push(`Chain size: ${e.chain}`),t.join(" | ")}function nt(){if(it)return;let e=x("size");if(!e)return;let t={ring:i.sizeRing?i.sizeRing.value.trim():"",bracelet:i.sizeBracelet?i.sizeBracelet.value.trim():"",chain:i.sizeChain?i.sizeChain.value.trim():""},a=Ga(t);e.value=a,e.dataset.activityValue=a}function Ka(e){if(!i.sizeBlock)return;let t=e&&(e.ring||e.bracelet||e.chain);i.sizeBlock.classList.toggle("is-hidden",!t||n.tab!=="quotes");let a=(o,r)=>{if(!o)return;let s=o.closest(".field");s&&s.classList.toggle("is-hidden",!r)};a(i.sizeRing,!!e?.ring),a(i.sizeBracelet,!!e?.bracelet),a(i.sizeChain,!!e?.chain)}async function Ja(e){if(n.tab!=="quotes")return;let t=await Kt(),a=Jt(e,t),o=Mt(e),r=$t(Pt(e));it=!0;let s=se(e,o,r,["ring_size","ring","ringSize"]),l=se(e,o,r,["wrist_size","wrist","bracelet_size","bracelet"]),c=se(e,o,r,["neck_size","neck","chain_size","chain_length","necklace_size","necklace_length"]),d=Wa(a);!d.ring&&!d.bracelet&&!d.chain&&(d={ring:M(s),bracelet:M(l),chain:M(c)}),Ka(d),n.sizingSpec=d,i.sizeRing&&(i.sizeRing.value=s),i.sizeBracelet&&(i.sizeBracelet.value=l),i.sizeChain&&(i.sizeChain.value=c),nt(),it=!1}function Qa(e){return"Metal weight (g)"}function Ya(e){return"Final Metal weight difference (g)"}function zt(e){i.metalWeightLabel&&(i.metalWeightLabel.textContent=Qa(e)),i.metalWeightAdjustmentLabel&&(i.metalWeightAdjustmentLabel.textContent=Ya(e))}function Rt(e){let t=be(e);return t.includes("platinum")?"Platinum":t.includes("14k")?"14K":t.includes("18k")?"18K":""}function ot(e){let t=String(e||"").trim();if(!t)return"";let a=Number(t);return Number.isNaN(a)?t:a?`${a} week${a===1?"":"s"} delay`:"No delay"}function ze(e){let t=Tt(e);return t?t==="rush"?"Rush":t==="standard"?"Standard":e:""}function Xa(e,t){let a=ze(e)||"Standard",o=Number(String(t||"").trim());return!Number.isNaN(o)&&o>0?`Estimated delivery after payment: ${a} + ${o} week${o===1?"":"s"}.`:`Estimated delivery after payment: ${a}.`}function rt(){return i.editFields.find(e=>e.dataset.field==="diamond_breakdown")}function st(e){let t=String(e||"").toLowerCase();return t.includes("lab")?"lab":t.includes("natural")?"natural":""}function Le(){let e=String(y("stone")||"").toLowerCase();return e?e.includes("lab")?"lab":e.includes("natural")||pe.some(a=>e.includes(a))?"natural":"":""}function Fn(e){return e?String(e).split(/\n|;|,/).map(t=>t.trim()).filter(Boolean).map(t=>{let a=t.match(/([0-9]*\.?[0-9]+)\s*(?:ct)?\s*[xÃ—]\s*([0-9]*\.?[0-9]+)/i);if(a)return{weight:a[1],count:a[2]};let o=t.match(/[0-9]*\.?[0-9]+/g)||[];return o.length>=2?{weight:o[0],count:o[1]}:o.length===1?{weight:o[0],count:"1"}:null}).filter(Boolean):[]}function Bn(e){return e.map(t=>{let a=String(t.weight||"").trim(),o=String(t.count||"").trim();return!a||!o?"":`${a} x ${o}`}).filter(Boolean).join(`
`)}function Za(e){return e?String(e).split(/\n|;|,/).map(t=>t.trim()).filter(Boolean).map(t=>{let a="",o=t,r=t.match(/^(lab(?:\s+grown)?|natural)(?:\s+diamond)?\s*[:=-]\s*(.+)$/i);r&&(a=st(r[1]),o=r[2]);let s=o.match(/([0-9]*\.?[0-9]+)\s*(?:ct)?\s*[xA-]\s*([0-9]*\.?[0-9]+)/i);if(s)return{weight:s[1],count:s[2],stoneType:a};let l=o.match(/[0-9]*\.?[0-9]+/g)||[];return l.length>=2?{weight:l[0],count:l[1],stoneType:a}:l.length===1?{weight:l[0],count:"1",stoneType:a}:null}).filter(Boolean):[]}function ei(e){return e.map(t=>{let a=String(t.weight||"").trim(),o=String(t.count||"").trim();if(!a||!o)return"";let r=t.stoneType==="lab"?"Lab":t.stoneType==="natural"?"Natural":"";return`${r?`${r}: `:""}${a} x ${o}`}).filter(Boolean).join(`
`)}function le(){return i.diamondBreakdownRows?Array.from(i.diamondBreakdownRows.querySelectorAll("[data-diamond-row]")).map(e=>{let t=e.querySelector("[data-diamond-weight]")?.value?.trim()||"",a=e.querySelector("[data-diamond-count]")?.value?.trim()||"",o=e.querySelector("[data-diamond-type]")?.value?.trim()||"";return{weight:t,count:a,stoneType:o}}):[]}function Re(){if(Pe)return;let e=rt();if(!e)return;let t=Le(),a=le().map(o=>({...o,stoneType:o.stoneType||t}));Pe=!0,e.value=ei(a),Pe=!1}function Fe(e){if(!i.diamondBreakdownRows)return;if(!e.length){i.diamondBreakdownRows.innerHTML='<p class="muted">No diamond pieces yet. Add a row to begin.</p>',Ae([]);return}let t=Le();i.diamondBreakdownRows.innerHTML=e.map((a,o)=>{let r=String(a.weight||"").trim(),s=String(a.count||"").trim(),l=Number(r||0)*Number(s||0),c=lt(l),d=st(a.stoneType)||t;return`
          <div class="diamond-row" data-diamond-row data-row-index="${o}">
            <label>
              <span>ct</span>
              <input type="text" data-diamond-weight placeholder="0.10" value="${b(r)}" />
            </label>
            <label>
              <span>count</span>
              <input type="text" data-diamond-count placeholder="1" value="${b(s)}" />
            </label>
            <label>
              <span>Type</span>
              <select data-diamond-type>
                <option value="">Auto</option>
                <option value="natural" ${d==="natural"?"selected":""}>Natural</option>
                <option value="lab" ${d==="lab"?"selected":""}>Lab</option>
              </select>
            </label>
            <div class="diamond-total">
              <span>Total ct</span>
              <strong data-diamond-row-total>${c}</strong>
            </div>
            <button class="btn btn-ghost" type="button" data-diamond-remove>Remove</button>
          </div>`}).join(""),Ae(e)}function lt(e){return Number.isFinite(e)?`${e%1===0?e.toFixed(0):e.toFixed(2).replace(/\.?0+$/,"")} ct`:"--"}function ti(){if(n.tab!=="quotes")return[];let e=le();if(!e.length)return[];let t=Le(),a=new Map;return e.forEach(o=>{let r=String(o.weight||"").trim(),s=String(o.count||"").trim();if(!r||!s)return;let l=st(o.stoneType)||t;if(!l)return;let c=l,d=a.get(c)||[];d.push(`${r} x ${s}`),a.set(c,d)}),Array.from(a.entries()).map(([o,r])=>({stone_type:o,diamond_breakdown:r.join(`
`)}))}function Ae(e){if(!i.diamondPieceCount||!i.diamondCaratTotal)return;let t=e.reduce((s,l)=>s+(Number(l.count)||0),0),a=e.reduce((s,l)=>s+(Number(l.weight)||0)*(Number(l.count)||0),0);i.diamondPieceCount.textContent=t,i.diamondCaratTotal.textContent=lt(a);let o=y("stone").toLowerCase();if(pe.some(s=>o.includes(s))){let s=x("stone_weight");if(s){let l=a&&Number.isFinite(a)?a%1===0?a.toFixed(0):a.toFixed(2).replace(/\.?0+$/,""):"";s.value=l,s.dataset.activityValue=l,n.selectedItem&&(n.selectedItem.stone_weight=l,re(n.selectedItem))}}}function Ft(){if(!i.diamondBreakdownRows)return;Array.from(i.diamondBreakdownRows.querySelectorAll("[data-diamond-row]")).forEach(t=>{let a=Number(t.querySelector("[data-diamond-weight]")?.value||0),o=Number(t.querySelector("[data-diamond-count]")?.value||0),r=a*o,s=t.querySelector("[data-diamond-row-total]");s&&(s.textContent=lt(r))})}function ai(e){if(!e)return;let t=e.match(/([0-9]*\.?[0-9]+)x([0-9]+)/i);if(!t)return;let a=Le(),o=le();o.push({weight:t[1],count:t[2],stoneType:a}),Fe(o),Re(),i.diamondPresets&&(i.diamondPresets.value="")}function Bt(){let e=rt();if(!e)return;let t=Za(e.value);Fe(t)}function Ut(){if(!i.diamondBreakdown)return;let e=y("stone").toLowerCase(),t=pe.some(o=>e.includes(o)),a=n.tab==="quotes"&&t;i.diamondBreakdown.classList.toggle("is-hidden",!a)}function x(e){return i.editFields.find(t=>t.dataset.field===e)}function ii(e){e&&(e.dataset.auto="false",e.dataset.manual="true")}function ni(e){return!(!e||e.dataset.manual==="true"&&e.value)}function oi(){n.tab==="quotes"&&f.forEach(e=>{let t=x(e.price);t&&(t.dataset.auto="true",t.dataset.manual="")})}function ri(){n.tab==="quotes"&&(f.forEach((e,t)=>{let a=x(e.price);(a?a.value.trim():"")?D(t,"priced"):D(t,"idle")}),si(),Vt())}function si(){if(n.tab==="quotes"&&(f.forEach((e,t)=>{let a=y(e.clarity),o=y(e.color),r=y(e.price);jt(t,!!(a||o||r||t===0))}),n.recommendedOptionIndex===null)){let e=f.findIndex((t,a)=>Se(a));n.recommendedOptionIndex=e>=0?e:null,dt()}}function li(e){return N.map(t=>t==="diamond_breakdown_components"?`${t}:${JSON.stringify(e[t]||[])}`:`${t}:${String(e[t]??"")}`).join("|")}function ct(){if(n.tab!=="quotes")return null;nt();let e=ti();return{metal:y("metal")||"",metal_weight:y("metal_weight")||"",stone:y("stone")||"",stone_weight:y("stone_weight")||"",diamond_breakdown:y("diamond_breakdown")||"",diamond_breakdown_components:e,timeline:y("timeline")||"",timeline_adjustment_weeks:y("timeline_adjustment_weeks")||"",quote_discount_type:y("quote_discount_type")||"",quote_discount_percent:y("quote_discount_percent")||"",size:y("size")||"",size_label:"",size_ring:i.sizeRing?i.sizeRing.value.trim():"",size_bracelet:i.sizeBracelet?i.sizeBracelet.value.trim():"",size_chain:i.sizeChain?i.sizeChain.value.trim():""}}function ci(e,t){let a=f[e];if(!a)return null;let o=y(a.clarity)||"",r=y(a.color)||"";return{...t,clarity:o,color:r}}function ce(e){let t=f[e];return t?x(t.price):null}function D(e,t,a=""){let o=ie.options[e];if(!o)return;o.status=t,o.lastError=t==="error"?a:"",t==="priced"&&(o.lastPricedAt=new Date().toISOString());let r=i.quoteOptionCards[e],s=i.quoteOptionStatuses[e];if(r&&(r.classList.toggle("is-pricing",t==="pricing"),r.classList.toggle("is-stale",t==="stale"),r.classList.toggle("is-error",t==="error"),r.classList.toggle("is-manual",t==="manual"),r.classList.toggle("is-inactive",!Se(e))),s){let l=t==="pricing"?"Pricing...":t==="stale"?"Stale":t==="error"?"Error":t==="manual"?"Manual":t==="priced"?"Priced":"Idle";s.textContent=a?`${l} \xB7 ${a}`:l}_a(),re(n.selectedItem)}function di(e){e!=null&&D(e,"manual")}function ui(){let e=ie.options.map(a=>a.lastPricedAt).filter(Boolean);if(!e.length)return"--";let t=e.sort().slice(-1)[0];return ka(t)}function Se(e){let t=i.optionActiveToggles[e];return t?t.checked:!0}function jt(e,t){let a=i.optionActiveToggles[e];a&&(a.checked=t);let o=f[e];if(!o)return;[o.clarity,o.color,o.price].forEach(d=>{let m=x(d);m&&(m.disabled=!t)});let r=i.optionRecommendRadios[e];r&&(r.disabled=!t);let s=i.optionCopyButtons[e];s&&(s.disabled=!t);let l=i.optionAutoButtons[e];l&&(l.disabled=!t);let c=i.quoteOptionCards[e];c&&c.classList.toggle("is-inactive",!t),!t&&n.recommendedOptionIndex===e&&(n.recommendedOptionIndex=null,dt()),t||D(e,"idle","Inactive"),J()}function dt(){i.optionRecommendRadios.forEach((e,t)=>{e.checked=n.recommendedOptionIndex===t}),n.selectedItem&&re(n.selectedItem)}function ut(e){let t=i.optionFinals[e];if(!t)return;let a=ce(e),o=Number(a?.value||"");if(!o||Number.isNaN(o)){t.textContent="Final: --";return}let r=be(y("quote_discount_type")),s=Number(y("quote_discount_percent"))||0,c=r==="custom"&&s>0?Math.max(0,o*(1-s/100)):o;t.textContent=`Final: ${ne(c)||"--"}`}function Vt(){f.forEach((e,t)=>ut(t))}function Ht(e,t){let a=ce(e);if(!(!a||!ni(a))){if(a.value=t,a.dataset.auto="true",a.dataset.manual="",n.selectedItem){let o=f[e].price;n.selectedItem[o]=t,re(n.selectedItem)}Te(),ut(e)}}function Wt(e,t){let a=f[e];if(!a||!Se(e))return!1;let o=ce(e);if(o&&o.dataset.manual==="true"&&o.value.trim())return!1;let s=y(a.clarity),l=y(a.color),c=yt();return!!(s||l||c&&e===0)}function mt(e){let t=[];if(!e)return t;e.metal||t.push(P("Metal missing",'[data-field="metal"]')),e.metal_weight||t.push(P("Metal weight missing",'[data-field="metal_weight"]')),e.timeline||t.push(P("Timeline missing",'[data-field="timeline"]'));let a=String(e.stone||"").toLowerCase(),o=pe.some(c=>a.includes(c)),r=Array.isArray(e.diamond_breakdown_components)?e.diamond_breakdown_components:[];a&&(o&&!e.diamond_breakdown&&r.length===0&&t.push(P("Diamond breakdown missing",'[data-field="diamond_breakdown"]')),!o&&!e.stone_weight&&t.push(P("Stone weight missing",'[data-field="stone_weight"]')));let s=n.sizingSpec||{};return s.ring&&!e.size_ring&&t.push(P("Ring size missing","[data-size-ring] input")),s.bracelet&&!e.size_bracelet&&t.push(P("Bracelet size missing","[data-size-bracelet] input")),s.chain&&!e.size_chain&&t.push(P("Chain size missing","[data-size-chain] input")),yt()||f.forEach((c,d)=>{if(!Se(d))return;let m=y(c.clarity),p=y(c.color);m||t.push(P(`Option ${d+1} clarity missing`,`[data-field="${c.clarity}"]`)),p||t.push(P(`Option ${d+1} color missing`,`[data-field="${c.color}"]`))}),t}async function mi(e,t){if(!f[e]||!t)return;let o=li(t),r=ie.cache.get(o);if(r){Ht(e,r.price),D(e,"priced");return}let s=ie.inflight.get(e);if(s&&s.signature===o)return s.promise;D(e,"pricing");let l=Gt(),c=fetch(`${l}/pricing/estimate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(d=>d.json().catch(()=>({})).then(m=>({response:d,data:m}))).then(({response:d,data:m})=>{if(!d.ok||!m?.ok){D(e,"error");return}let p=String(m.price??"");ie.cache.set(o,{price:p}),Ht(e,p),D(e,"priced")}).catch(()=>{D(e,"error")}).finally(()=>{ie.inflight.delete(e),L(),J()});return ie.inflight.set(e,{promise:c,signature:o}),c}async function fi(e){if(n.tab!=="quotes")return;let t=ct();if(!t)return;if(f.forEach((s,l)=>{if(Wt(l,t))return;let c=ce(l);c&&c.dataset.manual==="true"&&c.value.trim()?D(l,"manual"):c&&c.value.trim()?D(l,"priced"):D(l,"idle")}),mt(t).length){L(),J();return}let r=(e&&e.length?e:[]).filter(s=>Wt(s,t));if(!r.length){L(),J();return}await Promise.all(r.map(s=>{let l=ci(s,t);return mi(s,l)}))}function $({baseChanged:e=!1,optionIndex:t=null}={}){n.tab==="quotes"&&(e?f.forEach((a,o)=>{Ee.add(o)}):typeof t=="number"&&Ee.add(t),Ee.forEach(a=>{let o=ce(a),r=o&&o.dataset.manual==="true"&&o.value.trim();if(!Se(a)){D(a,"idle");return}if(r){D(a,"manual");return}D(a,"stale")}),et&&clearTimeout(et),et=setTimeout(()=>{let a=Array.from(Ee);Ee.clear(),fi(a)},500))}function Gt(){return Me().replace(/\/admin\/?$/,"")}function pi(e){if(!e)return"";try{let a=new URL(e,"https://www.heerawalla.com").pathname.split("/").filter(Boolean),o=a[a.length-1]||"";return o.toLowerCase()==="bespoke"&&a.length>1?a[a.length-2]||"":o}catch{return""}}function gi(e){if(!e)return"";try{let a=new URL(e,"https://www.heerawalla.com").pathname.split("/").filter(Boolean);return a.includes("inspirations")?"inspirations":a.includes("product")||a.includes("products")?"products":""}catch{return""}}async function Kt(){if(K.data)return K.data;if(K.promise)return K.promise;let e=`${Gt()}/catalog?include=products,inspirations`;return K.promise=fetch(e).then(t=>t.json()).then(t=>(K.data=t||{},K.data)).catch(()=>(K.data={},K.data)).finally(()=>{K.promise=null}),K.promise}function yi(e){return String(e||"uncategorized").split("/").map(t=>t.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"")||"uncategorized").filter(Boolean).join("/")}function hi(e){let t=yi(e.category||"uncategorized"),a=`/images/products/${t}/${e.id}`,o=["img-hero-1.png","img-hero-1.jpeg","img-hero-1.jpg","img-hero-2.png","img-hero-2.jpeg","img-hero-2.jpg","img-hero-03.jpeg","img-1.png","img-1.jpeg","img-1.jpg","image-1.svg"].map(r=>`${a}/${r}`);return o.push(`/images/products/${t}/image-1.svg`),o.push("/images/products/placeholder.svg"),o}function bi(e){if(!e)return[he("/images/products/placeholder.svg")].filter(Boolean);let t=[];return e.hero_image&&t.push(e.hero_image),e.heroImage&&t.push(e.heroImage),Array.isArray(e.images)&&e.images.forEach(a=>t.push(a)),!t.length&&e.id&&e.category&&(t=hi(e)),t.length||(t=["/images/products/placeholder.svg"]),Array.from(new Set(t.map(he).filter(Boolean)))}function Jt(e,t){if(!t)return null;let a=e.product_url||"",o=pi(a),r=gi(a),s=e.design_code||"",l=e.product_name||"",c=Array.isArray(t.inspirations)?t.inspirations:[],d=Array.isArray(t.products)?t.products:[],m=k=>s&&(k.design_code||k.designCode||"").toLowerCase()===s.toLowerCase(),p=k=>l&&String(k.name||k.title||"").toLowerCase()===l.toLowerCase(),v=k=>o&&String(k.slug||"").toLowerCase()===o.toLowerCase();return r==="inspirations"?c.find(v)||c.find(m)||c.find(p)||null:r==="products"?d.find(v)||d.find(m)||d.find(p)||null:c.find(v)||d.find(v)||c.find(m)||d.find(m)||c.find(p)||d.find(p)||null}function Qt(e){if(!e.length)return'<div class="media-empty muted">No images available.</div>';let t=b(he("/images/products/placeholder.svg"));return e.length===1?`<div class="media-frame"><img src="${b(e[0])}" alt="" loading="lazy" onerror="this.onerror=null;this.src='${t}';"></div>`:`
      <div class="media-carousel" data-media-carousel>
        <button class="carousel-btn" type="button" data-carousel-prev aria-label="Previous image">\u2039</button>
        <div class="media-track" data-carousel-track>${e.map(o=>`<div class="media-slide"><img src="${b(o)}" alt="" loading="lazy" onerror="this.onerror=null;this.src='${t}';"></div>`).join("")}</div>
        <button class="carousel-btn" type="button" data-carousel-next aria-label="Next image">\u203A</button>
      </div>`}function Un(){return'<div class="media-slot" data-media-slot><span class="muted">Loading images...</span></div>'}async function Si(e){if(n.tab!=="quotes"&&n.tab!=="orders"||!i.detailGrid)return;let t=i.detailGrid.querySelector("[data-media-slot]");if(!t)return;let a=e.design_code||e.product_url||e.product_name||"";if(a&&tt.has(a)){t.innerHTML=Qt(tt.get(a));return}let o=await Kt(),r=Jt(e,o),s=bi(r);a&&tt.set(a,s),t.innerHTML=Qt(s)}function u(e,t){i.toast&&(i.toast.textContent=e,i.toast.classList.add("is-visible"),t==="error"?i.toast.style.background="#b42318":i.toast.style.background="var(--ink)",setTimeout(()=>i.toast.classList.remove("is-visible"),2400))}function we(e){i.syncLine&&(i.syncLine.textContent=e)}function ve(e){if(!e)return"";let t=new Date(e);return Number.isNaN(t.getTime())?String(e):t.toLocaleString()}function ne(e){if(e==null||e==="")return"";let t=Number(String(e).replace(/[^0-9.]/g,""));return Number.isNaN(t)?String(e):t.toLocaleString("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0})}function Be(e){let t=String(e||"").replace(/\D/g,"");return t?t.length===10?`(${t.slice(0,3)}) ${t.slice(3,6)}-${t.slice(6)}`:t.length===11&&t.startsWith("1")?`+1 (${t.slice(1,4)}) ${t.slice(4,7)}-${t.slice(7)}`:t.length>11?`+${t}`:t:"--"}function wi(e){return e!=null&&e!==""}async function g(e,t={}){let a=Me();if(!a)throw new Error("Missing API base");let o=a.endsWith("/")?a:`${a}/`,r=new URL(e.replace(/^\//,""),o),s=qe(o)?At():"";Nt(r,o,s);let l=Ba(t.headers||{},s),c=await fetch(r.toString(),{credentials:qe(o)?"omit":"include",headers:l,...t});if(!c.ok){let d=await c.text();throw new Error(d||c.statusText)}return await c.json()}function Yt(e){return e==="orders"?"/orders":e==="quotes"?"/quotes":e==="tickets"?"/tickets":e==="contacts"?"/contacts":e==="products"?"/products":e==="inspirations"?"/inspirations":e==="media-library"?"/media-library":e==="price-chart"?"/price-chart":e==="cost-chart"?"/cost-chart":e==="diamond-price-chart"?"/diamond-price-chart":`/${e}`}function Ue(){return n.tab==="orders"?"/orders/action":n.tab==="quotes"?"/quotes/action":n.tab==="tickets"?"/tickets/action":n.tab==="contacts"?"/contacts/action":n.tab==="products"?"/products/action":n.tab==="inspirations"?"/inspirations/action":n.tab==="media-library"?"/media-library/action":n.tab==="price-chart"?"/price-chart/action":n.tab==="cost-chart"?"/cost-chart/action":n.tab==="diamond-price-chart"?"/diamond-price-chart/action":""}function je(){return n.selectedItem&&(n.selectedItem.request_id||n.selectedItem.email||n.selectedItem.row_number||n.selectedItem.slug||n.selectedItem.id||n.selectedItem.media_id)||""}function ft(){if(S.has(n.tab)){i.editSection&&i.editSection.classList.add("is-hidden");return}let e=new Set(E[n.tab]);i.editFields.forEach(t=>{let a=t.closest(".field"),o=t.dataset.field||"",r=e.has(o);a&&a.classList.toggle("is-hidden",!r)}),i.editSection&&i.editSection.classList.toggle("is-hidden",e.size===0),fa()}function Xt(){let e=S.has(n.tab);if(i.catalogSection&&i.catalogSection.classList.toggle("is-hidden",!e),e){let t=i.catalogTabs.find(a=>a.classList.contains("is-active"))?.dataset.catalogTab||fe;Zt(t)}else i.catalogPanels.forEach(t=>t.classList.add("is-hidden"));i.missingPanel&&i.missingPanel.classList.toggle("is-hidden",!1),i.activityFeed&&i.activityFeed.closest(".drawer-section")?.classList.toggle("is-hidden",e),i.orderDetailsSection&&i.orderDetailsSection.classList.toggle("is-hidden",e),i.sizeBlock&&i.sizeBlock.classList.toggle("is-hidden",e),i.summaryCard&&i.summaryCard.classList.toggle("is-hidden",e),i.detailAside&&i.detailAside.classList.toggle("is-hidden",e),i.nextActionPanel&&i.nextActionPanel.classList.toggle("is-hidden",e)}function Zt(e){if(!i.catalogTabs.length||!i.catalogPanels.length)return;let t=e||fe;i.catalogTabs.forEach(a=>{a.classList.toggle("is-active",a.dataset.catalogTab===t)}),i.catalogPanels.forEach(a=>{let o=a.dataset.catalogPanel||"";a.classList.toggle("is-hidden",o!==t)})}function ea(e,t){if(!i.catalogFields&&!i.catalogFieldsBasic)return;if(n.tab==="media-library"){let H=(Array.isArray(n.catalogHeaders)&&n.catalogHeaders.length?n.catalogHeaders:Object.keys(e||{})).map(j=>String(j||"").trim()).filter(j=>j&&j!=="row_number"),W=new Set(["description","label","alt","url"]);i.catalogFields.innerHTML=H.map(j=>{let Ye=e?.[j]??"",xa=j.replace(/_/g," "),Tn=W.has(j),Da=j==="created_at";return Tn?`
              <label class="field full-span">
                <span>${C(xa)}</span>
                <textarea rows="2" data-field="${b(j)}" ${Da?'data-readonly="true" disabled':""}>${C(String(Ye||""))}</textarea>
              </label>
            `:`
            <label class="field">
              <span>${C(xa)}</span>
              <input type="text" data-field="${b(j)}" value="${b(String(Ye||""))}" ${Da?'data-readonly="true" disabled':""} />
            </label>
          `}).join("");return}if(!window.CatalogForm)return;let a=window.CatalogForm,o=t||{};Object.entries({categories:["RING","PENDANT","BRACELET","BAND","NECKLACE","BANGLE"],styles:["Bold","Subtle","Minimalist","Contemporary","Traditional","Vintage","Modern","Classic","Art Deco","Bohemian","Romantic"],motifs:["Gift","Wedding","Engagement","Anniversary","Birthday","Promise","Eternal Love","Family","Celebration"],tags:["RING","PENDANT","BRACELET","BAND","NECKLACE","BANGLE"]}).forEach(([B,H])=>{o[B]=H.map(W=>({value:W}))});let s=e||{},l=new Set([]),c=s.is_active===void 0||s.is_active===null?n.isNewRow:!!s.is_active,d=!!s.is_featured,p=[a.renderTextInput({label:"ID",field:"id",value:s.id||"",readOnly:!n.isNewRow}),a.renderTextInput({label:"Name",field:"name",value:s.name||""}),a.renderTextInput({label:"Slug",field:"slug",value:s.slug||"",helperHtml:'<button class="btn btn-ghost btn-small" type="button" data-slug-generate>Generate</button>'}),a.renderEnumSelect({label:"Design code",field:"design_code",value:s.design_code||"",options:o.design_codes,includeEmpty:!0,placeholder:"Select"}),a.renderToggle({label:"Active",field:"is_active",value:c}),a.renderToggle({label:"Featured",field:"is_featured",value:d})],v=[a.renderEnumSelect({label:"Gender",field:"gender",value:s.gender||"",options:o.genders,includeEmpty:!0,placeholder:"Select"}),a.renderMultiSelectChips({label:"Categories",field:"categories",values:s.categories||[],enumKey:"categories",allowCustom:l.has("categories"),placeholder:"Add category",fullSpan:!0}),a.renderMultiSelectChips({label:"Styles",field:"styles",values:s.styles||[],enumKey:"styles",allowCustom:l.has("styles"),placeholder:"Add style",fullSpan:!0}),a.renderMultiSelectChips({label:"Motifs",field:"motifs",values:s.motifs||[],enumKey:"motifs",allowCustom:l.has("motifs"),placeholder:"Add motif",fullSpan:!0}),a.renderMultiSelectChips({label:"Tags",field:"tags",values:s.tags||[],enumKey:"tags",allowCustom:l.has("tags"),placeholder:"Add tag",fullSpan:!0})],k=[a.renderMultiSelectChips({label:"Metals",field:"metals",values:s.metals||[],enumKey:"metals",allowCustom:!1,placeholder:"Add metal",fullSpan:!0}),a.renderMultiSelectChips({label:"Stone types",field:"stone_types",values:s.stone_types||[],enumKey:"stone_types",allowCustom:!1,placeholder:"Add stone type",fullSpan:!0}),a.renderMultiSelectChips({label:"Cut",field:"cut",values:s.cut||[],enumKey:"cuts",allowCustom:!1,placeholder:"Add cut",fullSpan:!0}),a.renderMultiSelectChips({label:"Clarity",field:"clarity",values:s.clarity||[],enumKey:"clarities",allowCustom:!1,placeholder:"Add clarity",fullSpan:!0}),a.renderMultiSelectChips({label:"Color",field:"color",values:s.color||[],enumKey:"colors",allowCustom:!1,placeholder:"Add color",fullSpan:!0})],F=[a.renderTextInput({label:"Created at",field:"created_at",value:s.created_at||"",readOnly:!0}),a.renderTextInput({label:"Updated at",field:"updated_at",value:s.updated_at||"",readOnly:!0}),a.renderTextInput({label:"Updated by",field:"updated_by",value:s.updated_by||"",readOnly:!0})];i.catalogFieldsBasic&&(i.catalogFieldsBasic.innerHTML=p.join("")),i.catalogFieldsTaxonomy&&(i.catalogFieldsTaxonomy.innerHTML=v.join("")),i.catalogFieldsMaterials&&(i.catalogFieldsMaterials.innerHTML=k.join("")),i.catalogFieldsAudit&&(i.catalogFieldsAudit.innerHTML=F.join("")),i.catalogFields&&!i.catalogFieldsBasic&&(i.catalogFields.innerHTML=[...p,...v,...k,...F].join(""));let O=()=>{X(),L(),J()};[i.catalogFieldsBasic,i.catalogFieldsTaxonomy,i.catalogFieldsMaterials,i.catalogFieldsAudit,i.catalogFields].filter(Boolean).forEach(B=>{a.init(B,o,O)});let Z=document.querySelector("[data-slug-generate]");Z&&Z.addEventListener("click",()=>{let B=i.catalogFieldsBasic||i.catalogFields;if(!B)return;let H=B.querySelector('[data-field="name"]'),W=B.querySelector('[data-field="slug"]');!H||!W||!window.CatalogUtils||(W.value=window.CatalogUtils.normalizeSlug(H.value||""),W.dispatchEvent(new Event("input",{bubbles:!0})))}),document.querySelectorAll("[data-char-count]").forEach(B=>{let H=B.closest(".field")?.querySelector("[data-char-counter]");if(!H)return;let W=()=>{H.textContent=String(B.value.length||0)};W(),B.addEventListener("input",W)})}function vi(){return i.catalogFields?i.catalogFields.querySelector('[data-field="description"]'):null}function _i(e){if(!i.mediaDetailSection)return;let t=n.tab==="media-library";if(i.mediaDetailSection.classList.toggle("is-hidden",!t),!t)return;let a=String(e?.media_id||e?.id||e?.row_number||""),o=String(e?.media_type||"image").trim()||"image",r=e?.url||e?.media_url||"",s=he(r);i.mediaDetailId&&(i.mediaDetailId.textContent=a||"--"),i.mediaDetailType&&(i.mediaDetailType.textContent=o||"--"),i.mediaDetailUrl&&(s?(i.mediaDetailUrl.href=s,i.mediaDetailUrl.textContent="Open file"):(i.mediaDetailUrl.href="#",i.mediaDetailUrl.textContent="No file")),i.mediaDetailPreview&&(s?o.toLowerCase().includes("video")?i.mediaDetailPreview.innerHTML=`<video controls src="${b(s)}"></video>`:i.mediaDetailPreview.innerHTML=`<img src="${b(s)}" alt="" loading="lazy" />`:i.mediaDetailPreview.innerHTML='<span class="muted">No preview available.</span>')}async function _e(e){if(!i.catalogMediaList)return;if(!te.has(n.tab)){i.catalogMediaList.innerHTML="";return}let t=e?.slug||"";if(!t){n.catalogMediaState={items:[]},n.mediaLibraryItems=[],pt([]),i.catalogMediaList.innerHTML='<div class="muted">Save this record before linking media.</div>';return}let a=n.tab==="products"?"/product-media":"/inspiration-media",o=n.tab==="products"?"product_slug":"inspiration_slug";try{let[r,s]=await Promise.all([g("/media-library?limit=500&offset=0"),g(`${a}?${o}=${encodeURIComponent(t)}&limit=500&offset=0`)]);n.catalogMediaState={items:s.items||[]},n.mediaLibraryItems=Array.isArray(r.items)?r.items:[],pt(n.mediaLibraryItems);let l=new Map((r.items||[]).map(m=>[m.media_id,m])),d=(s.items||[]).slice().sort((m,p)=>{let v=Number(m.sort_order||m.order||0),k=Number(p.sort_order||p.order||0);if(v!=k)return v-k;let F=Number(m.id||0),O=Number(p.id||0);return F-O}).map(m=>{let p=l.get(m.media_id)||{},v=he(p.url||""),F=String(p.media_type||"").toLowerCase().startsWith("video")?`<video src="${b(v)}" controls></video>`:`<img src="${b(v)}" alt="">`,O=m.position||"",Z=String(m.sort_order||m.order||""),ee=Z||"--",B=String(m.is_primary||"")==="1"?"Yes":"No",H=String(m.position||"").toLowerCase()==="hero",W=H?'<span class="media-hero-badge">Hero</span>':"",j=String(p.label||""),Ye=Ne((n.catalogEnums||{}).media_positions||[],O,!0,"Select");return`
          <div class="catalog-media-item" data-position="${b(O)}" data-media-id="${b(m.media_id||"")}">
            ${F}
            <div class="catalog-media-header">
              <div class="catalog-media-meta">${C(m.media_id||"--")}</div>
              <details class="catalog-media-info">
                <summary aria-label="Media details">i</summary>
                <div class="catalog-media-info-content">
                  <div class="catalog-media-meta">${C(p.label||p.description||"")}</div>
                  <div class="catalog-media-meta">Position: ${C(O||"--")} \xB7 Order: ${C(ee)} \xB7 Primary: ${C(B)} ${W}</div>
                </div>
              </details>
            </div>
            <div class="catalog-media-controls">
              <div class="media-control-row">
                <label class="field field-inline">
                  <span>Order</span>
                  <input type="number" data-media-order value="${b(Z)}" />
                </label>
                <label class="field field-inline">
                  <span>Position</span>
                  <select data-media-position>${Ye}</select>
                </label>
                <label class="field field-inline">
                  <span>Hero</span>
                  <input type="checkbox" data-media-hero-toggle ${H?"checked":""} />
                </label>
              </div>
              <div class="media-control-row">
                <label class="field field-inline media-label-field">
                  <span>Label</span>
                  <input type="text" data-media-label value="${b(j)}" />
                </label>
                <label class="field field-inline media-description-field">
                  <span>Description</span>
                  <textarea rows="2" data-media-description>${b(m.description||"")}</textarea>
                </label>
              </div>
              <div class="media-control-row media-control-actions">
                <button class="btn btn-ghost btn-small" type="button" data-media-save data-mapping-id="${b(m.id||m.row_number||"")}">Save</button>
                <button class="btn btn-ghost btn-small" type="button" data-media-delete data-mapping-id="${b(m.id||m.row_number||"")}">Delete</button>
                <button class="btn btn-ghost btn-small" type="button" data-media-describe data-media-id="${b(m.media_id||"")}">Generate description</button>
              </div>
            </div>
          </div>
        `});i.catalogMediaList.innerHTML=d.length?d.join(""):'<div class="muted">No media linked yet.</div>'}catch{n.catalogMediaState={items:[]},n.mediaLibraryItems=[],pt([]),i.catalogMediaList.innerHTML='<div class="muted">Unable to load media.</div>'}}function pt(e){if(!i.mediaId)return;let t=i.mediaId.value||"",a=['<option value="">Select</option>'];(e||[]).slice().sort((o,r)=>String(o.media_id||"").localeCompare(String(r.media_id||""))).forEach(o=>{let r=String(o.media_id||"").trim();r&&a.push(`<option value="${b(r)}">${C(r)}</option>`)}),i.mediaId.innerHTML=a.join(""),t&&(i.mediaId.value=t),ta(i.mediaId.value||"")}function ta(e){if(!i.mediaPreview)return;let a=(Array.isArray(n.mediaLibraryItems)?n.mediaLibraryItems:[]).find(s=>String(s.media_id||"")===String(e||""));if(!a||!e){i.mediaPreview.innerHTML='<span class="muted">Select a media item to preview.</span>';return}let o=he(a.url||"");if(!o){i.mediaPreview.innerHTML='<span class="muted">No URL available for this media.</span>';return}let r=String(a.media_type||"").toLowerCase().startsWith("video");i.mediaPreview.innerHTML=r?`<video src="${b(o)}" controls></video>`:`<img src="${b(o)}" alt="${b(a.alt||a.label||"")}">`}function aa(e){let t=e?.stone_roles;return Array.isArray(t)&&t.length?t:De}function ia(e){let t=e?.stone_size_types;return Array.isArray(t)&&t.length?t:Et}function na(e){let t=e?.metal_size_types;return Array.isArray(t)&&t.length?t:Et}function oa(e){let t=e?.stone_shapes;return Array.isArray(t)&&t.length?t:Ra}function Ne(e,t,a,o){let r=String(t||""),s=[];return a&&s.push(`<option value="">${C(o||"Select")}</option>`),(e||[]).forEach(l=>{let c=String(l.value||""),d=String(l.label||l.value||""),m=r&&c.toLowerCase()===r.toLowerCase();s.push(`<option value="${b(c)}"${m?" selected":""}>${C(d)}</option>`)}),s.join("")}function Ci(e,t){let a=aa(t),o=ia(t),r=oa(t),s=String(e.is_primary||e.isPrimary||"")==="1"||e.is_primary===!0;return`
      <div class="catalog-stone-row" data-stone-option-id="${b(e.id||"")}">
        <div class="catalog-stone-grid">
          <label class="field">
            <span>Role</span>
            <select data-stone-field="role">
              ${Ne(a,e.role,!0,"Select")}
            </select>
          </label>
          <label class="field">
            <span>Carat</span>
            <input type="number" step="0.01" min="0" data-stone-field="carat" value="${b(e.carat??"")}">
          </label>
          <label class="field">
            <span>Count</span>
            <input type="number" step="1" min="0" data-stone-field="count" value="${b(e.count??"")}">
          </label>
          <label class="field">
            <span>Size type</span>
            <select data-stone-field="size_type">
              ${Ne(o,e.size_type,!0,"Select")}
            </select>
          </label>
          <label class="field">
            <span>Shape</span>
            <select data-stone-field="shape">
              ${Ne(r,e.shape,!0,"Select")}
            </select>
          </label>
          <label class="field">
            <span>Primary</span>
            <select data-stone-field="is_primary">
              <option value="" ${s?"":"selected"}>No</option>
              <option value="1" ${s?"selected":""}>Yes</option>
            </select>
          </label>
        </div>
        <div class="catalog-stone-actions">
          <button class="btn btn-ghost btn-small" type="button" data-stone-save>Save</button>
          <button class="btn btn-ghost btn-small" type="button" data-stone-delete>Delete</button>
        </div>
      </div>
    `}function ki(e){if(!Array.isArray(e))return[];let t=["xsmall","small","medium","large","xlarge","xxlarge"],a=new Map(t.map((o,r)=>[o,r]));return[...e].sort((o,r)=>{let s=String(o.size_type||"").toLowerCase(),l=String(r.size_type||"").toLowerCase(),c=a.has(s)?a.get(s):t.length+1,d=a.has(l)?a.get(l):t.length+1;if(c!==d)return c-d;let m=String(o.role||""),p=String(r.role||"");if(m!==p)return m.localeCompare(p);let v=Number(o.carat||0),k=Number(r.carat||0);return!Number.isNaN(v)&&!Number.isNaN(k)&&v!==k?v-k:String(o.id||"").localeCompare(String(r.id||""))})}function Ei(e){let t=ki(e),a=new Map;return t.forEach(o=>{let r=String(o.size_type||"unspecified").toLowerCase()||"unspecified";a.has(r)||a.set(r,[]),a.get(r).push(o)}),Array.from(a.entries())}function qi(e){let t=a=>{let o=e.querySelector(`[data-stone-field="${a}"]`);return o?o.value.trim():""};return{role:t("role"),carat:t("carat"),count:t("count"),size_type:t("size_type"),shape:t("shape"),is_primary:t("is_primary")}}async function Ve(e){if(!i.catalogStoneList)return;if(!te.has(n.tab)){i.catalogStoneList.innerHTML="";return}let t=e?.id||"";if(!t){n.catalogStoneOptions={items:[]},i.catalogStoneList.innerHTML='<div class="muted">Save this record before adding stone options.</div>';return}let a=new URLSearchParams;a.set("catalog_id",t);try{let o=await g(`/catalog-stone-options?${a.toString()}`),r=Array.isArray(o.items)?o.items:[];n.catalogStoneOptions={items:r};let s=n.catalogEnums||{},l=Ei(r);if(!l.length){i.catalogStoneList.innerHTML='<div class="muted">No stone options yet.</div>';return}let c=l.map(([d,m])=>{let p=d==="unspecified"?"Unspecified size":d.replace(/_/g," "),v=m.map(k=>Ci(k,s)).join("");return`
          <div class="stone-size-group" data-size-type="${b(d)}">
            <div class="stone-size-header">${C(p)}</div>
            <div class="stone-size-rows">${v}</div>
          </div>
        `});i.catalogStoneList.innerHTML=c.join("")}catch{n.catalogStoneOptions={items:[]},i.catalogStoneList.innerHTML='<div class="muted">Unable to load stone options.</div>'}}function Li(){return{role:i.stoneAddRole?.value.trim()||"",carat:i.stoneAddCarat?.value.trim()||"",count:i.stoneAddCount?.value.trim()||"",size_type:i.stoneAddSizeType?.value.trim()||"",shape:i.stoneAddShape?.value.trim()||"",is_primary:i.stoneAddPrimary?.value||""}}function Ai(){i.stoneAddRole&&(i.stoneAddRole.value=""),i.stoneAddCarat&&(i.stoneAddCarat.value=""),i.stoneAddCount&&(i.stoneAddCount.value=""),i.stoneAddSizeType&&(i.stoneAddSizeType.value=""),i.stoneAddShape&&(i.stoneAddShape.value=""),i.stoneAddPrimary&&(i.stoneAddPrimary.value="")}async function Ni(){if(!n.selectedItem)return;let e=n.selectedItem.id||"";if(!e){u("Save the item before adding stone options.","error");return}let t=Li();if(!t.role||!t.carat){u("Role and carat are required.","error");return}try{await g("/catalog-stone-options/action",{method:"POST",body:JSON.stringify({action:"add_row",fields:{catalog_id:e,...t}})}),Ai(),await Ve(n.selectedItem),u("Stone option added.")}catch{u("Unable to add stone option.","error")}}async function Ii(e){let t=e.getAttribute("data-stone-option-id")||"";if(!t)return;let a=qi(e);if(!a.role||!a.carat){u("Role and carat are required.","error");return}try{await g("/catalog-stone-options/action",{method:"POST",body:JSON.stringify({action:"update",id:t,fields:a})}),await Ve(n.selectedItem),u("Stone option saved.")}catch{u("Unable to save stone option.","error")}}async function Ti(e){let t=e.getAttribute("data-stone-option-id")||"";if(t&&confirm("Delete this stone option?"))try{await g("/catalog-stone-options/action",{method:"POST",body:JSON.stringify({action:"delete",id:t})}),await Ve(n.selectedItem),u("Stone option deleted.")}catch{u("Unable to delete stone option.","error")}}function Oi(e,t){let a=String(e.is_primary||e.isPrimary||"")==="1"||e.is_primary===!0,o=na(t||{}),r=Ne(o,e.size_type||"",!0,"Select");return`
      <div class="catalog-stone-row" data-metal-option-id="${b(e.id||"")}">
        <div class="catalog-stone-grid">
          <label class="field">
            <span>Metal weight</span>
            <input type="number" step="0.01" min="0" data-metal-field="metal_weight" value="${b(e.metal_weight??"")}">
          </label>
          <label class="field">
            <span>Size type</span>
            <select data-metal-field="size_type">
              ${r}
            </select>
          </label>
          <label class="field">
            <span>Primary</span>
            <select data-metal-field="is_primary">
              <option value="" ${a?"":"selected"}>No</option>
              <option value="1" ${a?"selected":""}>Yes</option>
            </select>
          </label>
        </div>
        <div class="catalog-stone-actions">
          <button class="btn btn-ghost btn-small" type="button" data-metal-save>Save</button>
          <button class="btn btn-ghost btn-small" type="button" data-metal-delete>Delete</button>
        </div>
      </div>
    `}function xi(e){if(!Array.isArray(e))return[];let t=["xsmall","small","medium","large","xlarge","xxlarge"],a=new Map(t.map((o,r)=>[o,r]));return[...e].sort((o,r)=>{let s=String(o.size_type||"").toLowerCase(),l=String(r.size_type||"").toLowerCase(),c=a.has(s)?a.get(s):t.length+1,d=a.has(l)?a.get(l):t.length+1;if(c!==d)return c-d;let m=Number(o.metal_weight||0),p=Number(r.metal_weight||0);return!Number.isNaN(m)&&!Number.isNaN(p)&&m!==p?m-p:String(o.id||"").localeCompare(String(r.id||""))})}function Di(e){let t=xi(e),a=new Map;return t.forEach(o=>{let r=String(o.size_type||"unspecified").toLowerCase()||"unspecified";a.has(r)||a.set(r,[]),a.get(r).push(o)}),Array.from(a.entries())}function Mi(e){let t=a=>{let o=e.querySelector(`[data-metal-field="${a}"]`);return o?o.value.trim():""};return{metal_weight:t("metal_weight"),size_type:t("size_type"),is_primary:t("is_primary")}}async function He(e){if(!i.catalogMetalList)return;if(!te.has(n.tab)){i.catalogMetalList.innerHTML="";return}let t=e?.id||"";if(!t){n.catalogMetalOptions={items:[]},i.catalogMetalList.innerHTML='<div class="muted">Save this record before adding metal options.</div>';return}let a=new URLSearchParams({catalog_id:t});try{let o=await g(`/catalog-metal-options?${a.toString()}`),r=Array.isArray(o.items)?o.items:[];n.catalogMetalOptions={items:r};let s=Di(r);if(!s.length){i.catalogMetalList.innerHTML='<div class="muted">No metal options yet.</div>';return}let l=s.map(([c,d])=>{let m=c==="unspecified"?"Unspecified size":c.replace(/_/g," "),p=d.map(v=>Oi(v,n.catalogEnums)).join("");return`
          <div class="stone-size-group" data-size-type="${b(c)}">
            <div class="stone-size-header">${C(m)}</div>
            <div class="stone-size-rows">${p}</div>
          </div>
        `});i.catalogMetalList.innerHTML=l.join("")}catch{n.catalogMetalOptions={items:[]},i.catalogMetalList.innerHTML='<div class="muted">Unable to load metal options.</div>'}}function Pi(){return{metal_weight:i.metalAddWeight?.value.trim()||"",size_type:i.metalAddSizeType?.value.trim()||"",is_primary:i.metalAddPrimary?.value||""}}function $i(){i.metalAddWeight&&(i.metalAddWeight.value=""),i.metalAddSizeType&&(i.metalAddSizeType.value=""),i.metalAddPrimary&&(i.metalAddPrimary.value="")}async function zi(){if(!n.selectedItem)return;let e=n.selectedItem.id||"";if(!e){u("Save the item before adding metal options.","error");return}let t=Pi();if(!t.metal_weight){u("Metal weight is required.","error");return}try{await g("/catalog-metal-options/action",{method:"POST",body:JSON.stringify({action:"add_row",fields:{catalog_id:e,...t}})}),$i(),await He(n.selectedItem),u("Metal option added.")}catch{u("Unable to add metal option.","error")}}async function Ri(e){let t=e.getAttribute("data-metal-option-id")||"";if(!t)return;let a=Mi(e);if(!a.metal_weight){u("Metal weight is required.","error");return}try{await g("/catalog-metal-options/action",{method:"POST",body:JSON.stringify({action:"update",id:t,fields:a})}),await He(n.selectedItem),u("Metal option saved.")}catch{u("Unable to save metal option.","error")}}async function Fi(e){let t=e.getAttribute("data-metal-option-id")||"";if(t&&confirm("Delete this metal option?"))try{await g("/catalog-metal-options/action",{method:"POST",body:JSON.stringify({action:"delete",id:t})}),await He(n.selectedItem),u("Metal option deleted.")}catch{u("Unable to delete metal option.","error")}}function ra(e){return i.noteEditors.find(t=>t.dataset.noteEditor===e)||null}function sa(e){return i.noteRows.find(t=>t.dataset.noteRows===e)||null}function Bi(e){return i.noteInputs.find(t=>t.dataset.noteInput===e)||null}function Ui(e){return i.noteOrders.find(t=>t.dataset.noteOrder===e)||null}function la(e,t){let a=ra(e);a&&(a.value=t?.note||"",a.dataset.noteId=t?.id||"")}function ca(e,t){let a=sa(e);if(a){if(!t.length){a.innerHTML='<div class="muted">No notes yet.</div>';return}a.innerHTML=t.map(o=>`
        <div class="note-row" data-note-id="${b(o.id||"")}">
          <input type="text" data-note-field="note" value="${b(o.note||"")}" />
          <input type="number" data-note-field="sort_order" value="${b(o.sort_order||"0")}" />
          <div class="note-actions">
            <button class="btn btn-ghost btn-small" type="button" data-note-row-save>Save</button>
            <button class="btn btn-ghost btn-small" type="button" data-note-row-delete>Delete</button>
          </div>
        </div>
      `).join("")}}async function gt(e){if(!i.catalogNotesSection)return;let t=e?.id||"",a=e?.slug||"";if(!t){i.noteEditors.forEach(r=>{r.value="",r.dataset.noteId="",r.disabled=!0}),i.noteInputs.forEach(r=>{r.value="",r.disabled=!0}),i.noteOrders.forEach(r=>{r.value="",r.disabled=!0}),Xe.forEach(r=>{let s=sa(r);s&&(s.innerHTML='<div class="muted">Save this record before adding notes.</div>')});return}i.noteEditors.forEach(r=>{r.disabled=!1}),i.noteInputs.forEach(r=>{r.disabled=!1}),i.noteOrders.forEach(r=>{r.disabled=!1});let o=new URLSearchParams({catalog_id:t});a&&o.set("catalog_slug",a);try{let r=await g(`/catalog-notes?${o.toString()}`),s=Array.isArray(r.items)?r.items:[];n.catalogNotes=s,qt.forEach(l=>{let c=s.find(d=>String(d.kind||"")===l);la(l,c||null)}),Xe.forEach(l=>{let c=s.filter(d=>String(d.kind||"")===l);ca(l,c)})}catch{n.catalogNotes=[],qt.forEach(s=>la(s,null)),Xe.forEach(s=>ca(s,[]))}}async function ji(e){if(!n.selectedItem)return;let t=ra(e);if(!t)return;let a=t.value.trim(),o=t.dataset.noteId||"",r=n.selectedItem.id||"",s=n.selectedItem.slug||"";if(!r){u("Save the item before adding notes.","error");return}if(!a){if(!o||!confirm("Delete this note?"))return;try{await g("/catalog-notes/action",{method:"POST",body:JSON.stringify({action:"delete",id:o})}),t.value="",t.dataset.noteId="",u("Note removed.")}catch{u("Unable to delete note.","error")}return}let l=o?{action:"update",id:o,fields:{note:a,sort_order:"0"}}:{action:"add_row",fields:{catalog_id:r,catalog_slug:s,kind:e,note:a,sort_order:"0"}};try{let c=await g("/catalog-notes/action",{method:"POST",body:JSON.stringify(l)});!o&&c.id&&(t.dataset.noteId=c.id),u("Note saved.")}catch{u("Unable to save note.","error")}}async function Vi(e){let t=e.getAttribute("data-note-id")||"";if(!t)return;let a=e.querySelector('[data-note-field="note"]'),o=e.querySelector('[data-note-field="sort_order"]'),r=a?a.value.trim():"",s=o?o.value.trim():"";if(!r){u("Note text is required.","error");return}try{await g("/catalog-notes/action",{method:"POST",body:JSON.stringify({action:"update",id:t,fields:{note:r,sort_order:s||"0"}})}),u("Note updated.")}catch{u("Unable to save note.","error")}}async function Hi(e){let t=e.getAttribute("data-note-id")||"";if(t&&confirm("Delete this note?"))try{await g("/catalog-notes/action",{method:"POST",body:JSON.stringify({action:"delete",id:t})}),await gt(n.selectedItem),u("Note deleted.")}catch{u("Unable to delete note.","error")}}async function Wi(e){if(!n.selectedItem)return;let t=n.selectedItem.id||"",a=n.selectedItem.slug||"";if(!t){u("Save the item before adding notes.","error");return}let o=Bi(e);if(!o)return;let r=o.value.trim();if(!r){u("Note text is required.","error");return}let s=Ui(e),l=s?s.value.trim():"";try{await g("/catalog-notes/action",{method:"POST",body:JSON.stringify({action:"add_row",fields:{catalog_id:t,catalog_slug:a,kind:e,note:r,sort_order:l||"0"}})}),o.value="",s&&(s.value=""),await gt(n.selectedItem),u("Note added.")}catch{u("Unable to add note.","error")}}function Gi(){return n.selectedItem?.slug||""}function Ie(){return n.tab==="products"?"/product-media/action":"/inspiration-media/action"}function da(e,t,a,o){let r=Gi();return r?{action:"add_row",fields:n.tab==="products"?{product_slug:r,media_id:e,position:t,order:a,is_primary:o}:{inspiration_slug:r,media_id:e,position:t,order:a,is_primary:o}}:null}async function Ki(){let e=i.mediaId?.value.trim();if(!e){u("Add a media ID first.","error");return}let t=i.mediaPositionExisting?.value.trim()||"",a=i.mediaOrderExisting?.value.trim()||"";if(!t){u("Choose a media position.","error");return}let o=i.mediaPrimaryExisting?.value||"";if(a&&Number.isNaN(Number(a))){u("Order must be a number.","error");return}let r=da(e,t,a,o);if(!r){u("Save the record before linking media.","error");return}if(!(await g(Ie(),{method:"POST",body:JSON.stringify(r)})).ok){u("Linking failed.","error");return}u("Media linked"),_e(n.selectedItem)}async function Ji(){let e=i.mediaFile?.files?.[0];if(!e){u("Choose a file first.","error");return}let t=i.mediaLabel?.value.trim()||"",a=i.mediaAlt?.value.trim()||"",o=i.mediaDescription?.value.trim()||"",r=i.mediaPosition?.value.trim()||"",s=i.mediaOrder?.value.trim()||"",l=i.mediaPrimary?.value||"";if(s&&Number.isNaN(Number(s))){u("Order must be a number.","error");return}if(!r){u("Choose a media position.","error");return}try{let c=Me(),d=c.endsWith("/")?c:`${c}/`,m=qe(d)?At():"",p=new FormData;p.append("file",e),t&&p.append("label",t);let v=new URL("media/upload",d);Nt(v,d,m);let F=await(await fetch(v.toString(),{method:"POST",credentials:qe(d)?"omit":"include",body:p})).json();if(!F.ok)throw new Error("upload_failed");let O=F.media||{},Z=new Date().toISOString();await g("/media-library/action",{method:"POST",body:JSON.stringify({action:"add_row",fields:{media_id:O.media_id,url:O.url,media_type:O.media_type||"image",label:t,alt:a,description:o,created_at:Z}})});let ee=da(O.media_id,r,s,l);ee&&await g(Ie(),{method:"POST",body:JSON.stringify(ee)}),u("Media uploaded"),_e(n.selectedItem),i.mediaFile&&(i.mediaFile.value="")}catch{u("Upload failed.","error")}}async function jn(e){if(e)try{await g(Ie(),{method:"POST",body:JSON.stringify({action:"edit",rowNumber:e,fields:{position:"hero",is_primary:"1",sort_order:"0"}})}),u("Hero media updated."),_e(n.selectedItem)}catch{u("Unable to set hero media.","error")}}async function Qi(e,t){if(!e||!t)return;let a=t.querySelector("[data-media-order]"),o=t.querySelector("[data-media-position]"),r=t.querySelector("[data-media-hero-toggle]"),s=t.querySelector("[data-media-label]"),l=t.querySelector("[data-media-description]"),c=a?a.value.trim():"";if(c&&Number.isNaN(Number(c))){u("Order must be a number.","error");return}let d=t.dataset.position||"",m=o?o.value.trim():"",p=r?r.checked:!1,v=String(m||"").toLowerCase()==="hero",k=p||v,F=k?"hero":m||d;!k&&String(d||"").toLowerCase()==="hero"&&(F="");try{let O=t.dataset.mediaId||"";O&&(s||l)&&await g("/media-library/action",{method:"POST",body:JSON.stringify({action:"edit",rowNumber:O,fields:{label:s?s.value.trim():void 0,description:l?l.value.trim():void 0}})}),await g(Ie(),{method:"POST",body:JSON.stringify({action:"edit",rowNumber:e,fields:{position:F,is_primary:k?"1":"0",sort_order:c}})}),u("Media updated."),_e(n.selectedItem)}catch{u("Unable to update media.","error")}}async function Yi(e,t){let a=t?.querySelector("[data-media-describe]");a&&(a.disabled=!0,a.textContent="Generating...");try{let o=await g("/media/describe",{method:"POST",body:JSON.stringify({media_id:e})});if(!o?.ok){u(o?.error||"Failed to generate description.","error");return}let r=t?.querySelector("[data-media-description]");r&&(r.value=o.description||""),u("Description generated. Review and click Save to store.","success")}catch(o){console.error(o),u("Failed to generate description.","error")}finally{a&&(a.disabled=!1,a.textContent="Generate description")}}async function Xi(e){if(e&&window.confirm("Delete this media?"))try{await g(Ie(),{method:"POST",body:JSON.stringify({action:"delete",rowNumber:e,delete_media:!0})}),u("Media deleted."),_e(n.selectedItem)}catch{u("Unable to delete media.","error")}}function Zi(){if(!i.orderDetailsSection)return;let e=n.tab==="orders";i.orderDetailsSection.classList.toggle("is-hidden",!e)}function yt(){if(n.tab!=="quotes")return!1;let e=Number(y("stone_weight")),t=y("diamond_breakdown"),a=!!String(t||"").trim();return(!Number.isFinite(e)||e<=0)&&!a}function ua(e,t){let a=x(e);if(!a)return;let o=a.closest(".field");o&&o.classList.toggle("is-hidden",!t)}function ht(){if(n.tab!=="quotes")return;let e=yt();Array.from(document.querySelectorAll(".quote-option-card")).forEach((a,o)=>{o===0?a.classList.toggle("is-hidden",!1):a.classList.toggle("is-hidden",e)}),ua("quote_option_1_clarity",!e),ua("quote_option_1_color",!e),e&&f.forEach((a,o)=>{o>0&&D(o,"idle")})}function ma(){if(n.tab!=="quotes")return;let e=be(y("quote_discount_type")),t=x("quote_discount_percent");if(!t)return;let a=e==="custom";t.disabled=!a,i.discountPercent&&(i.discountPercent.disabled=!a)}function fa(){i.quoteSection&&(i.quoteSection.classList.toggle("is-hidden",n.tab!=="quotes"),Ut(),ht(),i.sizeBlock&&n.tab!=="quotes"&&i.sizeBlock.classList.add("is-hidden"),i.quoteExtras&&i.quoteExtras.classList.toggle("is-hidden",n.tab==="quotes"),i.notesToggle&&(i.notesToggle.open=n.tab!=="quotes"),i.summaryMore&&i.summaryMore.classList.toggle("is-hidden",n.tab!=="quotes"),i.summaryPriceRow&&i.summaryPriceRow.classList.toggle("is-hidden",n.tab==="quotes"),en())}function en(){if(!(!i.activitySection||!i.activitySlot)){if(n.tab==="quotes")i.activitySection.dataset.originalParent||(i.activitySection.dataset.originalParent="detail-main"),i.activitySlot.appendChild(i.activitySection);else if(i.activitySection.dataset.originalParent==="detail-main"){let e=document.querySelector(".detail-main");e&&!e.contains(i.activitySection)&&e.insertBefore(i.activitySection,e.firstChild)}}}function pa(){if(!i.quoteMetalInput)return;let e=y("metal"),t=Rt(e);if(t){bt(t,e);return}let a=i.quoteMetals.filter(o=>o.checked).map(o=>o.value);i.quoteMetalInput.value=a.join(", ")}function bt(e,t=""){if(!i.quoteMetalInput)return;let a=Rt(t),o=String(e||"").split(",").map(r=>r.trim()).filter(Boolean);a?(o.length=0,o.push(a)):o.length||o.push("18K"),i.quoteMetalInput.value=o.join(", "),i.quoteMetals.forEach(r=>{r.checked=o.includes(r.value),a?r.disabled=r.value!==a:r.disabled=!1})}function oe(e){let t=i.orderDetailsFields.find(a=>a.dataset.orderDetailsField===e);return t?t.value.trim():""}function tn(e){return i.orderDetailsFields.find(t=>t.dataset.orderDetailsField===e)}function ga(){let e={};return U.forEach(t=>{let a=oe(t);a&&(e[t]=a)}),e}function ya(){let e=oe("shipping_carrier").toLowerCase(),t=oe("tracking_number"),a=tn("tracking_url");if(!a)return;let o=Y[e];if(o&&t){let r=`${o}${encodeURIComponent(t)}`;(!a.value||a.dataset.autoGenerated==="true")&&(a.value=r,a.dataset.autoGenerated="true")}(!o||!t)&&(a.dataset.autoGenerated==="true"&&(a.value=""),a.dataset.autoGenerated=""),It(i.openTracking,!!a.value)}function an(e){e&&(e.dataset.orderDetailsField==="tracking_url"&&(e.dataset.autoGenerated=""),ya(),X(),Oe())}function We(e={}){n.orderDetails=e||{},i.orderDetailsFields.forEach(t=>{let a=t.dataset.orderDetailsField;if(!a)return;let o=a==="shipping_method"?"Express":"";t.value=e[a]||o,t.dataset.activityValue=t.value}),Oe(),ya(),n.selectedItem&&re(n.selectedItem)}function ha(e){return[e.address_line1,e.address_line2,e.city,e.state,e.postal_code,e.country].filter(Boolean).join(", ")||"--"}function re(e){if(!e)return;let t=ye(e.status),a=n.tab==="quotes"||n.tab==="orders",o=n.tab==="quotes";if(i.summaryQuoteBlock&&i.summaryQuoteBlock.classList.toggle("is-hidden",!a),i.summaryPreferencesBlock&&i.summaryPreferencesBlock.classList.toggle("is-hidden",!a),i.summaryOptionsBlock&&i.summaryOptionsBlock.classList.toggle("is-hidden",!o),i.summaryNotesBlock&&i.summaryNotesBlock.classList.toggle("is-hidden",!a),i.summarySizesBlock&&i.summarySizesBlock.classList.toggle("is-hidden",!o),i.summaryStatus&&(i.summaryStatus.textContent=t,i.summaryStatus.dataset.status=t),i.summaryProduct&&(i.summaryProduct.textContent=e.product_name||"--"),i.summaryDesignCode&&(i.summaryDesignCode.textContent=e.design_code||"--"),i.summaryRequest&&(i.summaryRequest.textContent=e.request_id||"--"),i.summaryCreated&&(i.summaryCreated.textContent=ve(e.created_at)||"--"),i.summaryPrice&&(i.summaryPrice.textContent=ne(e.price)||"--"),i.summaryTimeline&&(i.summaryTimeline.textContent=ze(e.timeline)||"--"),i.summaryTimelineDelay){let l=ot(e.timeline_adjustment_weeks);i.summaryTimelineDelay.textContent=l||"--"}let r=e.stone||n.orderDetails&&n.orderDetails.stone||"",s=e.stone_weight||n.orderDetails&&n.orderDetails.stone_weight||"";if(i.summaryMetal&&(i.summaryMetal.textContent=e.metal||"--"),i.summaryStone&&(i.summaryStone.textContent=r||"--"),i.summaryStoneWeight&&(i.summaryStoneWeight.textContent=at(s)||"--"),i.summaryMetalWeight&&(i.summaryMetalWeight.textContent=xt(e.metal_weight)||"--"),i.summaryMetalAdjustment&&(i.summaryMetalAdjustment.textContent=Dt(e.metal_weight_adjustment)||"--"),i.summaryDiamondBreakdown&&(i.summaryDiamondBreakdown.textContent=e.diamond_breakdown||"--"),i.summaryDiscount){let l=String(e.quote_discount_type||"").trim(),c=String(e.quote_discount_percent||"").trim();l&&c?i.summaryDiscount.textContent=`${l} ${c}%`:l?i.summaryDiscount.textContent=l:c?i.summaryDiscount.textContent=`${c}%`:i.summaryDiscount.textContent="--"}if(i.summaryInterests&&(i.summaryInterests.textContent=e.interests||"--"),i.summaryContactPreference&&(i.summaryContactPreference.textContent=e.contact_preference||"--"),i.summarySubscription&&(i.summarySubscription.textContent=e.subscription_status||"--"),i.summaryCustomerNotes&&(i.summaryCustomerNotes.textContent=e.customer_notes||e.request_notes||"--"),i.summaryOption1&&(i.summaryOption1.textContent=ne(e.quote_option_1_price_18k)||"--"),i.summaryOption2&&(i.summaryOption2.textContent=ne(e.quote_option_2_price_18k)||"--"),i.summaryOption3&&(i.summaryOption3.textContent=ne(e.quote_option_3_price_18k)||"--"),[i.summaryOption1,i.summaryOption2,i.summaryOption3].forEach((l,c)=>{if(!l)return;let d=l.closest(".summary-line");d&&d.classList.toggle("is-recommended",n.recommendedOptionIndex===c)}),i.summaryOptionRecommended){let l=n.recommendedOptionIndex===null?"--":`Option ${n.recommendedOptionIndex+1}`;i.summaryOptionRecommended.textContent=l}i.summaryLastPriced&&(i.summaryLastPriced.textContent=ui()),i.summarySizeRing&&(i.summarySizeRing.textContent=i.sizeRing?.value?.trim()||"--"),i.summarySizeBracelet&&(i.summarySizeBracelet.textContent=i.sizeBracelet?.value?.trim()||"--"),i.summarySizeChain&&(i.summarySizeChain.textContent=i.sizeChain?.value?.trim()||"--"),i.summaryCustomer&&(i.summaryCustomer.textContent=e.name||"--"),i.summaryEmail&&(i.summaryEmail.textContent=e.email||"--"),i.summaryPhone&&(i.summaryPhone.textContent=Be(e.phone)),i.summaryAddress&&(i.summaryAddress.textContent=ha(e))}function P(e,t){return`<button class="chip missing-chip" type="button" data-focus-target='${t}'>${e}</button>`}function nn(e,t){return`<button class="chip is-warning" type="button" data-focus-target='${t}'>${e}</button>`}function X(){if(!i.missingList)return;let e=[];if(n.tab==="media-library"){i.missingList.innerHTML='<span class="muted">No missing details.</span>',Ke();return}if(S.has(n.tab)){let t=qa();if(window.CatalogUtils){let a=n.catalogEnums||{},o=window.CatalogUtils.normalizeCatalogItem(t,a);n.catalogFormState=o.normalized,n.catalogValidation=window.CatalogUtils.validateCatalogItem(o.normalized,a,n.catalogMediaState);let r=n.catalogValidation.missingCritical||[],s=n.catalogValidation.warnings||[];e=[...r.map(l=>P(l.message,l.selector||"")),...s.map(l=>nn(l.message,`[data-field="${l.field}"]`))]}i.missingList.innerHTML=e.length?e.join(""):'<span class="muted">No missing details.</span>',Ke();return}if(n.tab==="quotes"){let t=ct();e=mt(t)}else{y("metal_weight")||e.push(P("Metal weight missing",'[data-field="metal_weight"]')),y("stone_weight")||e.push(P("Stone weight missing",'[data-field="stone_weight"]'));let o=y("stone").toLowerCase(),r=y("diamond_breakdown");pe.some(m=>o.includes(m))&&!r&&e.push(P("Diamond breakdown empty",'[data-field="diamond_breakdown"]'));let l=oe("shipping_status").toLowerCase(),c=oe("tracking_number");V.has(l)&&!c&&e.push(P("Tracking # required for shipping",'[data-order-details-field="tracking_number"]'));let d=oe("delivery_eta");d&&!/^\d{4}-\d{2}-\d{2}$/.test(d)&&e.push(P("Delivery ETA needs YYYY-MM-DD",'[data-order-details-field="delivery_eta"]'))}i.missingList.innerHTML=e.length?e.join(""):'<span class="muted">No missing details.</span>',Ke()}function on(){if(!i.discountType||!i.discountPercent)return;let e=x("quote_discount_type"),t=x("quote_discount_percent");e&&(i.discountType.value=e.value||"none"),t&&(i.discountPercent.value=t.value||"")}function ba(){let e=x("quote_discount_type"),t=x("quote_discount_percent");e&&i.discountType&&(e.value=i.discountType.value),t&&i.discountPercent&&(t.value=i.discountPercent.value.trim())}function Te(){if(!i.discountFinal)return;let e=y("price")||y("quote_option_1_price_18k"),t=Number(e),a=Number(i.discountPercent?.value)||0;if(i.discountType&&i.discountPercent&&(i.discountPercent.disabled=i.discountType.value!=="custom"),!t||Number.isNaN(t)){i.discountFinal.textContent="--",ba();return}let o=a&&a>0?Math.max(0,t*(1-a/100)):t;i.discountFinal.textContent=ne(o)||"--",ba(),Vt()}function rn(e){return e?[`Order: ${e.request_id||"--"}`,`Created: ${ve(e.created_at)||"--"}`,`Status: ${ye(e.status)}`,`Product: ${e.product_name||"--"} (${e.design_code||"--"})`,`Specs: ${e.metal||"--"} / ${e.stone||"--"} ${at(e.stone_weight)}`,`Price: ${ne(e.price)||"--"}`,`Timeline: ${ze(e.timeline)||"--"} ${ot(e.timeline_adjustment_weeks)||""}`,`Customer: ${e.name||"--"} (${e.email||"--"} / ${Be(e.phone)})`,`Address: ${ha(e)}`].filter(Boolean).join(`
`):""}function Sa(){if(!i.metalWeightFinal)return;let e=Number(y("metal_weight")),t=Number(y("metal_weight_adjustment")),a=Number.isFinite(e),o=Number.isFinite(t);if(!a&&!o){i.metalWeightFinal.textContent="--";return}let r=(a?e:0)+(o?t:0);i.metalWeightFinal.textContent=`${r.toFixed(2).replace(/\.?0+$/,"")} g`}function wa(){let e=x("metal_weight"),t=x("metal_weight_adjustment"),a=i.metalWeightError,o=i.metalWeightAdjustmentError,r=/^[+-]?\d+(\.\d+)?$/,s=e?e.value.trim():"",l=t?t.value.trim():"";a&&(a.textContent=s&&!r.test(s)?"Enter a valid weight":""),o&&(o.textContent=l&&!r.test(l)?"Use + or - followed by a number":"")}function Oe(){if(!i.detailsSave)return;let e=U.some(t=>String(oe(t))!==String(n.orderDetails[t]||""));n.dirtySections.fulfillment=e,It(i.detailsSave,e&&Ze()),Ge()}function sn(){n.criticalDirty=I.some(e=>{if(!ae.has(e.key))return!1;let t=e.normalize(y(e.key)),a=n.originalValues[e.key]||"";return t!==a})}function Ge(){if(!i.dirtyIndicator)return;let e=[];n.dirtySections.edits&&e.push("Unsaved edits"),n.tab==="orders"&&n.dirtySections.fulfillment&&e.push("Unsaved fulfillment");let t=e.length?e.join(" / "):"All changes saved";i.dirtyIndicator.textContent=t,i.dirtyIndicator.classList.toggle("is-dirty",e.length>0),Ke()}function va(e="edits"){if(e==="fulfillment"){Oe();return}L()}function Ke(){if(!i.nextActionText)return;let e=i.missingList?i.missingList.querySelectorAll(".missing-chip").length:0;if(e){i.nextActionText.textContent=`${e} critical items need attention.`;return}if(n.tab==="quotes"){let t=Je();if(t.blocked&&t.reason){i.nextActionText.textContent=t.reason;return}}if(n.criticalDirty){i.nextActionText.textContent="Critical edits pending. Save before actions.";return}if(n.dirtySections.fulfillment){i.nextActionText.textContent="Save fulfillment details to keep tracking current.";return}if(n.dirtySections.edits){i.nextActionText.textContent="Review edits and request confirmation.";return}i.nextActionText.textContent="Review edits or choose an action."}function ln(){return x("notes")}function St(e){let t=ln();if(!t)return;let a=t.selectionStart||0,o=t.selectionEnd||0;t.value=`${t.value.slice(0,a)}${e}${t.value.slice(o)}`;let r=a+e.length;t.setSelectionRange(r,r),t.focus()}function cn(){let e=new Date,t=o=>String(o).padStart(2,"0"),a=`[${e.getFullYear()}-${t(e.getMonth()+1)}-${t(e.getDate())} ${t(e.getHours())}:${t(e.getMinutes())} CT] `;St(a)}function dn(){let e=Fa.map(t=>`- ${t}`).join(`
`);St(`${e}
`)}function Ce(e,t){t&&(Va(t),u(`${e} copied`))}function un(e){return A[n.tab].find(t=>t.action===e)}function J(){if(!i.actionRun||!i.actionSelect)return;let e=i.actionSelect.disabled||!i.actionSelect.value;if(n.tab==="quotes"){let t=Je();i.actionRun.disabled=e||t.blocked,_a(t);return}if(te.has(n.tab)){let t=n.catalogValidation?.missingCritical?.length||0,a=i.actionSelect.value==="delete";i.actionRun.disabled=e||a&&(t>0||n.dirtySections.edits);return}i.actionRun.disabled=e}function _a(e){if(!i.summaryPricingStatus)return;if(n.tab!=="quotes"){i.summaryPricingStatus.textContent="--";return}let t=e||Je();if(t.reason==="Pricing in progress"){i.summaryPricingStatus.textContent="Pricing...";return}if(t.reason==="Missing pricing inputs"){i.summaryPricingStatus.textContent="Missing inputs";return}if(t.reason==="Pricing stale"){i.summaryPricingStatus.textContent="Stale";return}if(t.reason==="No active options"){i.summaryPricingStatus.textContent="No active options";return}i.summaryPricingStatus.textContent="Current"}function Je(){if(n.tab!=="quotes")return{blocked:!1,reason:""};let e=ct(),t=mt(e),a=f.map((d,m)=>m).filter(d=>Se(d)),o=a.map(d=>ie.options[d]?.status||"idle"),r=o.some(d=>d==="pricing"),s=a.length>0&&o.every(d=>d==="priced"||d==="manual"),l=t.length>0||r||!s||a.length===0,c="";return t.length?c="Missing pricing inputs":r?c="Pricing in progress":s?a.length===0&&(c="No active options"):c="Pricing stale",{blocked:l,reason:c}}function wt(){let e=Ze(),t=n.tab==="orders"&&n.selectedItem?A.orders.filter(a=>a.action==="delete"?!0:(R[ye(n.selectedItem.status)]||[]).includes(a.action)):A[n.tab];if(i.actionSelect&&(i.actionSelect.innerHTML='<option value="">Select an action</option>'+t.map(a=>`<option value="${a.action}">${a.label}</option>`).join(""),i.actionSelect.disabled=!e||t.length===0),i.actionRun&&(i.actionRun.disabled=!e||!i.actionSelect||!i.actionSelect.value),i.actionRow&&(i.actionRow.style.display=""),i.primaryAction&&(i.primaryAction.disabled=!e),i.notesSave&&(i.notesSave.disabled=!e),i.goldRefresh){let a=n.tab==="cost-chart"&&n.selectedItem&&(n.selectedItem.key==="gold_price_per_gram_usd"||n.selectedItem.key==="gold-price-per-gram-usd");i.goldRefresh.classList.toggle("is-hidden",!a),i.goldRefresh.disabled=!e||!a}i.editFields.forEach(a=>{a.disabled=!e}),i.detailsSave&&(i.detailsSave.disabled=!e),i.orderDetailsFields.forEach(a=>{a.disabled=!e}),i.catalogFields&&i.catalogFields.querySelectorAll("input,textarea,select").forEach(a=>{a.disabled=!e||a.hasAttribute("data-readonly")})}function mn(e,t){let a=C(e),o=String(t);if(e==="Product URL"){let r=b(o),s=C(o);return`<div><span>${a}</span><a href="${r}" target="_blank" rel="noreferrer">${s}</a></div>`}return e==="Images"?`<div class="detail-media"><span>${a}</span>${o}</div>`:`<div><span>${a}</span>${C(o)}</div>`}function Ca(e){return e.filter(([,t])=>wi(t)).map(([t,a])=>mn(t,a)).join("")}function fn(e){return e.map(t=>{let a=Ca(t.rows||[]);return a?`<div class="detail-section">
          <p class="detail-section-title">${C(t.title)}</p>
          <div class="detail-grid">${a}</div>
        </div>`:""}).join("")}function ka(e){let t=new Date(e);return Number.isNaN(t.getTime())?"--":t.toLocaleString(void 0,{dateStyle:"short",timeStyle:"short"})}function Ea(){if(!i.activityFeed)return;if(!ge.length){i.activityFeed.innerHTML='<div class="activity-item muted">No activity yet.</div>';return}let e=[...ge].sort((t,a)=>new Date(a.time)-new Date(t.time)).slice(0,Lt);i.activityFeed.innerHTML=e.map(t=>{let a=t.detail?`<p class="activity-detail">${C(t.detail)}</p>`:"";return`<div class="activity-item activity-${t.type||"system"}">
          <div class="activity-meta">
            <span class="activity-time">${ka(t.time)}</span>
            <strong class="activity-title">${C(t.title||"Updated")}</strong>
          </div>
          ${a}
        </div>`}).join("")}function de(e){let t=e.time?new Date(e.time):new Date,a={...e,time:Number.isNaN(t.getTime())?new Date().toISOString():t.toISOString()};ge.unshift(a),ge.length>Lt&&ge.pop(),Ea()}function pn(e){if(ge.length=0,!e){Ea();return}let a=n.tab==="tickets"?"Ticket created":"Order created";e.created_at&&de({time:e.created_at,type:"system",title:a,detail:`Status: ${ye(e.status)}`}),e.status&&de({time:new Date().toISOString(),type:"status",title:`Current status: ${ye(e.status)}`})}function y(e){let t=i.editFields.find(a=>a.dataset.field===e);return t?t.value.trim():""}function gn(e){n.originalValues={},n.originalRaw={},I.forEach(t=>{let a=String(e[t.key]||"");n.originalRaw[t.key]=a,n.originalValues[t.key]=t.normalize(a)}),n.originalNotes=String(e.notes||"")}function vt(){let e=[];return I.forEach(t=>{let a=y(t.key);if(!a&&!n.originalValues[t.key]||!a&&n.originalValues[t.key])return;let o=t.normalize(a),r=n.originalValues[t.key]||"";o!==r&&e.push({key:t.key,label:t.label,from:t.format(n.originalRaw[t.key]),to:t.format(a)})}),e}function qa(){if(!window.CatalogForm)return{};let e={};return[i.catalogFieldsBasic,i.catalogFieldsTaxonomy,i.catalogFieldsMaterials,i.catalogFieldsAudit,i.catalogFields].filter(Boolean).forEach(t=>{Object.assign(e,window.CatalogForm.readFormState(t))}),e}function xe(){if(S.has(n.tab)){if(n.tab==="media-library"){let l={};if(!i.catalogFields)return l;i.catalogFields.querySelectorAll("input,textarea,select").forEach(p=>{let v=p.dataset.field;if(!v||p.disabled)return;let k=p.value;k!==void 0&&(l[v]=k.trim())});let d=n.catalogOriginalFields||{},m={};return Object.keys(l).forEach(p=>{let v=l[p],k=d[p];String(v??"")!==String(k??"")&&(m[p]=v)}),m}let t=qa();if(!window.CatalogUtils||!window.CatalogUtils.normalizeCatalogItem)return t;let a=n.catalogEnums||{},o=window.CatalogUtils.normalizeCatalogItem(t,a);n.catalogFormState=o.normalized;let r=n.catalogOriginalFields||{},s={};return Object.keys(o.fields||{}).forEach(l=>{let c=o.fields[l],d=r[l];String(c??"")!==String(d??"")&&(s[l]=c)}),s}let e={};return pa(),i.editFields.forEach(t=>{let a=t.dataset.field;a&&a!=="notes"&&E[n.tab].includes(a)&&t.value&&(e[a]=t.value.trim())}),e}function ue(){let e=i.editFields.find(t=>t.dataset.field==="notes");return e?e.value.trim():""}function L(){let e=Ze(),t=ue()!==n.originalNotes.trim();if(i.notesSave&&(h.has(n.tab)||S.has(n.tab)||n.tab==="quotes"?i.notesSave.style.display="none":(i.notesSave.style.display="",i.notesSave.disabled=!e||!t)),!i.primaryAction)return;if(i.primaryAction.style.display=n.tab==="contacts"?"none":"",n.tab!=="orders"){let o=xe();h.has(n.tab)&&(o.notes=ue());let r=Object.keys(o).length>0||n.tab==="quotes"&&t;i.primaryAction.textContent=n.isNewRow&&(h.has(n.tab)||S.has(n.tab))?"Add row":"Save updates",i.primaryAction.disabled=!e||!r,n.dirtySections.edits=r,Ge();return}i.primaryAction.textContent="Get Customer Confirmation";let a=vt();n.pendingChanges=a,i.primaryAction.disabled=!e||a.length===0,n.dirtySections.edits=a.length>0||t,Ge()}function yn(e){return e.map(t=>`
          <div class="confirm-row">
            <div class="confirm-field">${C(t.label)}</div>
            <div class="confirm-values">
              <span class="confirm-old">${C(t.from||"--")}</span>
              <span class="confirm-arrow">-></span>
              <span class="confirm-new">${C(t.to||"--")}</span>
            </div>
          </div>`).join("")}function hn(e){return e.map(t=>`
          <tr>
            <td style="padding:10px 0;border-bottom:1px solid #e5e7eb;">
              <div style="font-size:11px;letter-spacing:0.2em;text-transform:uppercase;color:#64748b;margin-bottom:6px;">
                ${C(t.label)}
              </div>
              <div style="font-size:14px;line-height:1.6;color:#0f172a;">
                <span style="color:#94a3b8;text-decoration:line-through;">${C(t.from||"--")}</span>
                <span style="color:#94a3b8;padding:0 8px;">-></span>
                <span style="font-weight:600;color:#0f172a;">${C(t.to||"--")}</span>
              </div>
            </td>
          </tr>`).join("")}function bn(e,t,a){let o=e.request_id||"",r=e.name||"there",s=e.product_name||"your order",l=y("timeline")||e.timeline||"",c=y("timeline_adjustment_weeks")||e.timeline_adjustment_weeks||"",d=Xa(l,c),m=o?`Heerawalla - Confirm order update (${o})`:"Heerawalla - Confirm order update",p=t.map(ee=>`${ee.label}: ${ee.from||"--"} -> ${ee.to||"--"}`),v=[`Hello ${r},`,"",`We reviewed your order for ${s}. Please confirm the updated details below (previous -> updated):`,"",...p,"",d,"",`Use your private confirmation link (Heerawalla.com/order_confirmation): ${a}`,"","Once confirmed, you will be guided to a secure checkout to reserve your piece.","Secure checkout supports major cards and wallets.","If anything looks incorrect, choose cancel on the confirmation page or reply to this email.","","Warm regards,","Heerawalla","www.heerawalla.com"].join(`
`),k=yn(t),F=hn(t),O=`<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body style="margin:0;padding:0;background:#f6f5f2;color:#0f172a;font-family:-apple-system, Segoe UI, Helvetica, Arial, sans-serif;">
  <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse;">
    <tr>
      <td align="center" style="padding:32px 16px;">
        <table role="presentation" width="600" cellpadding="0" cellspacing="0" style="border-collapse:collapse;background:#ffffff;border:1px solid #e5e7eb;">
          <tr>
            <td style="padding:36px 40px 28px 40px;">
              <div style="margin:0 0 16px 0;">
                <img src="https://www.heerawalla.com/images/engraving_mark.svg" width="36" height="36" alt="Heerawalla" style="display:block;">
              </div>
              <div style="font-size:12px;letter-spacing:0.32em;text-transform:uppercase;color:#64748b;margin-bottom:12px;">Heerawalla</div>
              <h1 style="margin:0 0 16px 0;font-size:22px;line-height:1.4;font-weight:600;color:#0f172a;">Please confirm your order update</h1>
              <p style="margin:0 0 16px 0;font-size:15px;line-height:1.7;color:#334155;">Hello ${C(r)},</p>
              <p style="margin:0 0 18px 0;font-size:15px;line-height:1.7;color:#334155;">
                We reviewed your order for ${C(s)}. Please confirm the updated details below (previous -> updated).
              </p>
              <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse;border:1px solid #e5e7eb;background:#fdfbf7;margin-bottom:18px;">
                <tbody>
                  ${F}
                </tbody>
              </table>
              <p style="margin:0 0 18px 0;font-size:14px;line-height:1.7;color:#334155;">
                ${C(d)}
              </p>
              <table role="presentation" cellpadding="0" cellspacing="0" style="margin:0 0 18px 0;">
                <tr>
                  <td style="background:#0f172a;border:1px solid #0f172a;">
                    <a href="${b(a)}" style="display:inline-block;padding:12px 22px;font-size:12px;letter-spacing:0.2em;text-transform:uppercase;color:#ffffff;text-decoration:none;">Review and confirm</a>
                  </td>
                </tr>
              </table>
              <p style="margin:0 0 6px 0;font-size:13px;line-height:1.7;color:#475569;">
                Use your private confirmation link at Heerawalla.com/order_confirmation.
              </p>
              <p style="margin:0 0 6px 0;font-size:13px;line-height:1.7;color:#475569;">
                Once confirmed, you will be guided to a secure checkout to reserve your piece.
              </p>
              <p style="margin:0 0 6px 0;font-size:13px;line-height:1.7;color:#475569;">
                Secure checkout supports major cards and wallets.
              </p>
              <p style="margin:0 0 24px 0;font-size:13px;line-height:1.7;color:#475569;">
                If anything looks incorrect, choose cancel on the confirmation page or reply to this email.
              </p>
              <div style="height:1px;background:#e5e7eb;margin:0 0 18px 0;"></div>
              <p style="margin:0 0 6px 0;font-size:14px;color:#0f172a;">Warm regards,</p>
              <p style="margin:0 0 10px 0;font-size:14px;font-weight:600;color:#0f172a;">Heerawalla</p>
              <p style="margin:0;font-size:12px;color:#64748b;">
                <a href="https://www.heerawalla.com" style="color:#64748b;text-decoration:underline;">www.heerawalla.com</a>
              </p>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`,Z=`
      <div class="confirm-preview-card">
        <p class="confirm-title">Order update to confirm</p>
        <p class="confirm-sub">${C(s)}${o?` (${C(o)})`:""}</p>
        <div class="confirm-list">${k}</div>
        <a class="confirm-cta" href="${b(a)}" target="_blank" rel="noreferrer">Review and confirm</a>
        <p class="confirm-foot">${C(d)}</p>
        <p class="confirm-foot">
          Private confirmation link lets the customer confirm or cancel before secure checkout.
        </p>
      </div>`;return{subject:m,textBody:v,htmlBody:O,previewHtml:Z}}function Sn(e){let t=e.confirmationUrl||e.url||"";if(t)return t.startsWith("http")?t:t.startsWith("/")?`https://www.heerawalla.com${t}`:t;let a=e.token||e.confirmationToken||"";return a?`https://www.heerawalla.com/order_confirmation?token=${encodeURIComponent(a)}`:""}let Qe=null;function wn(){if(!i.confirmModal)return;let e=i.confirmClose||i.confirmModal.querySelector("button, [href], input, select, textarea, [tabindex]:not([tabindex='-1'])");e&&typeof e.focus=="function"&&e.focus()}function vn(e){i.confirmModal&&(Qe=document.activeElement,i.confirmTo.textContent=e.to,i.confirmSubject.textContent=e.subject,i.confirmPreview.innerHTML=e.previewHtml,i.confirmModal.classList.add("is-open"),i.confirmModal.removeAttribute("inert"),i.confirmModal.setAttribute("aria-hidden","false"),requestAnimationFrame(wn))}function _t(){i.confirmModal&&(i.confirmModal.contains(document.activeElement)&&(Qe&&typeof Qe.focus=="function"?Qe.focus():document.body.focus?.()),i.confirmModal.classList.remove("is-open"),i.confirmModal.setAttribute("aria-hidden","true"),i.confirmModal.setAttribute("inert",""))}async function La(e){let t=S.has(n.tab),a=n.isNewRow?"New row":e.request_id||e.email||e.slug||e.id||e.media_id||"Record",o=e.status||"NEW";n.selectedId=a,n.selectedItem=e,gn(e),n.dirtySections={edits:!1,fulfillment:!1},n.criticalDirty=!1,n.pendingChanges=[],n.confirmation=null;let r=Q[n.tab]||n.tab;if(i.detailType.textContent=`${r} details`,i.detailTitle.textContent=e.product_name||e.name||e.key||e.metal||e.clarity||a,i.detailSub.textContent=a,i.detailStatusCorner){let c=t||n.tab==="contacts"||n.tab==="price-chart"||n.tab==="cost-chart"||n.tab==="diamond-price-chart"?"--":o;i.detailStatusCorner.textContent=c,i.detailStatusCorner.dataset.status=c}if(i.detailError&&(i.detailError.textContent=""),t){await Aa(e);return}Xt();let s=n.tab==="contacts"?[["Created",ve(e.created_at)],["Name",e.name],["Email",e.email],["Phone",Be(e.phone)],["Source",e.source],["Request ID",e.request_id],["Contact preference",e.contact_preference],["Interests",e.interests],["Page URL",e.page_url],["Updated",ve(e.updated_at)]]:n.tab==="tickets"?[["Request ID",e.request_id],["Created",ve(e.created_at)],["Status",o],["Name",e.name],["Email",e.email],["Phone",Be(e.phone)],["Subject",e.subject],["Summary",e.summary],["Page URL",e.page_url],["Updated",ve(e.updated_at)]]:n.tab==="price-chart"?[["Row",e.row_number],["Metal",e.metal],["Adjustment type",e.adjustment_type],["Adjustment value",e.adjustment_value],["Notes",e.notes]]:n.tab==="cost-chart"?[["Row",e.row_number],["Key",e.key],["Value",e.value],["Unit",e.unit],["Notes",e.notes]]:n.tab==="diamond-price-chart"?[["Row",e.row_number],["Clarity",e.clarity],["Color",e.color],["Weight min",e.weight_min],["Weight max",e.weight_max],["Price per ct",e.price_per_ct],["Notes",e.notes]]:[],l=n.tab==="quotes"||n.tab==="orders"?[]:[];if(l.length?(i.detailGrid.classList.add("detail-sections"),i.detailGrid.innerHTML=fn(l)):(i.detailGrid.classList.remove("detail-sections"),i.detailGrid.innerHTML=Ca(s)),i.overviewSection){let c=n.tab==="quotes"||n.tab==="orders";i.overviewSection.classList.toggle("is-hidden",c)}Si(e),Ja(e),i.editFields.forEach(c=>{let d=c.dataset.field;if(d){if(d==="notes"){c.value=n.tab==="tickets"?"":e.notes||"",c.dataset.activityValue=c.value;return}c.value=e[d]||"",c.dataset.activityValue=c.value}}),zt(e.metal||""),bt(e.quote_metal_options||"",e.metal||""),Bt(),oi(),ri(),$({baseChanged:!0}),ft(),Zi(),fa(),ma(),ht(),wt(),J(),L(),re(e),X(),pn(e),on(),Te(),Sa(),wa(),Oe(),Ge()}async function Aa(e){Xt(),i.detailGrid&&(i.detailGrid.innerHTML=""),i.catalogTitle&&(i.catalogTitle.textContent=`${Q[n.tab]||"Catalog"} details`);let t=await kn();if(n.tab==="media-library"){n.catalogFormState=e||{},n.catalogOriginalFields={},n.catalogValidation=null,n.selectedItem=e||{},Object.keys(e||{}).forEach(r=>{n.catalogOriginalFields[r]=String(e?.[r]??"")}),ea(e||{},t),_i(e||{}),ft(),wt(),J(),L(),X();return}let a=window.CatalogUtils?window.CatalogUtils.parseLegacyFields(e,t):e||{};n.isNewRow&&a.is_active===void 0&&(a.is_active=!0);let o=window.CatalogUtils&&window.CatalogUtils.normalizeCatalogItem?window.CatalogUtils.normalizeCatalogItem(a,t):{normalized:a,fields:{}};if(n.catalogFormState=o.normalized||a,n.catalogOriginalFields=o.fields||{},n.catalogValidation=null,n.selectedItem=a,ea(a,t),window.CatalogForm){window.CatalogForm.setSelectOptions(i.mediaPosition,t.media_positions,!0,"Select"),window.CatalogForm.setSelectOptions(i.mediaPositionExisting,t.media_positions,!0,"Select");let r=aa(t);window.CatalogForm.setSelectOptions(i.stoneAddRole,r,!0,"Select");let s=ia(t);window.CatalogForm.setSelectOptions(i.stoneAddSizeType,s,!0,"Select");let l=na(t);window.CatalogForm.setSelectOptions(i.metalAddSizeType,l,!0,"Select");let c=oa(t);window.CatalogForm.setSelectOptions(i.stoneAddShape,c,!0,"Select")}await _e(a),await Ve(a),await He(a),await gt(a),ft(),wt(),J(),L(),X()}async function _n(){try{let e=await g("/me");n.role=e.role||"",n.email=e.email||"",i.userRole&&(i.userRole.textContent=n.role||"Unknown"),i.userEmail&&(i.userEmail.textContent=n.email||"Not authorized")}catch{u("Access denied. Check Access policy.","error")}}async function me(e){if(!e){we("Missing request ID"),i.detailError&&(i.detailError.textContent="Missing request ID.");return}we("Loading");try{let t=new URLSearchParams({limit:"1",offset:"0"});n.tab==="contacts"?String(e).includes("@")?t.set("email",e):t.set("request_id",e):n.tab==="price-chart"||n.tab==="cost-chart"||n.tab==="diamond-price-chart"?t.set("row_number",e):S.has(n.tab)?n.tab==="media-library"?t.set("media_id",e):(t.set("slug",e),t.set("id",e)):t.set("request_id",e);let a=await g(`${Yt(n.tab)}?${t.toString()}`);n.catalogHeaders=Array.isArray(a.headers)?a.headers:[];let o=(a.items||[])[0];if(!o){we("Not found"),i.detailError&&(i.detailError.textContent="Record not found.");return}await La(o),n.tab==="orders"?await Na(o.request_id):n.tab==="tickets"?await Ct(o.request_id):We({}),we("Loaded")}catch{we("Error"),i.detailError&&(i.detailError.textContent="Failed to load record."),u("Failed to load record.","error")}}async function Cn(){try{let e=await g(`${Yt(n.tab)}?limit=1&offset=0`);n.catalogHeaders=Array.isArray(e.headers)?e.headers:[]}catch{n.catalogHeaders=[]}}async function kn(){if(n.catalogEnums)return n.catalogEnums;try{let e=await g("/enums");return n.catalogEnums=e||{},n.catalogEnums}catch{return window.AdminEnums&&window.AdminEnums.FALLBACK_ENUMS?(n.catalogEnums=window.AdminEnums.FALLBACK_ENUMS,n.catalogEnums):(n.catalogEnums={},n.catalogEnums)}}async function Na(e){if(!e||n.tab!=="orders"){We({});return}try{let t=await g(`/orders/details?request_id=${encodeURIComponent(e)}`);We(t.details||{})}catch{We({})}}async function Ct(e){if(!(!e||n.tab!=="tickets"))try{let t=await g(`/tickets/details?request_id=${encodeURIComponent(e)}`);(Array.isArray(t.details)?t.details:[]).forEach(o=>{let r=String(o.kind||"note").toLowerCase(),s=r==="email"?"Email sent":r==="status"?"Status update":"Comment";de({time:o.created_at||new Date().toISOString(),type:r,title:s,detail:o.note||""})})}catch{}}async function En(e){if(n.tab!=="quotes")return!0;let t=xe(),a=ue();if(!Object.keys(t).length&&!a)return!0;let o=Ue();return o?(await g(o,{method:"POST",body:JSON.stringify({action:"edit",requestId:e,fields:t,notes:a})})).ok?!0:(u("Save failed","error"),!1):(u("No edits allowed.","error"),!1)}async function qn(e){let t=je();if(!t){u("Missing record ID","error");return}if(n.tab==="quotes"&&e==="refresh_quote"&&!await En(t))return;let a=n.tab==="orders"?ga():{};if(n.tab==="orders"&&e==="mark_shipped"&&z.filter(c=>!a[c]).length){u("Add required fulfillment details before shipping.","error");return}if(n.tab==="tickets"&&e==="send_email"){let l=window.prompt("Email subject");if(!l)return;let c=window.prompt("Email message");if(!c)return;(await g("/tickets/action",{method:"POST",body:JSON.stringify({action:"send_email",requestId:t,subject:l,body:c})})).ok?(u("Email sent"),await Ct(t)):u("Email failed","error");return}let o={action:e};n.tab==="price-chart"||n.tab==="cost-chart"||n.tab==="diamond-price-chart"?o.rowNumber=t:o.requestId=t,n.tab==="orders"&&Object.keys(a).length&&(o.details=a),n.tab==="quotes"&&e==="submit_quote"&&(o.fields=xe());let r=Ue();if(!r){u("No actions available.","error");return}if((await g(r,{method:"POST",body:JSON.stringify(o)})).ok){u("Action saved");let l=je();l&&await me(l)}else u("Action failed","error")}async function Ia(){let e=je(),t=h.has(n.tab),a=S.has(n.tab);if(!e&&!(n.isNewRow&&(t||a))){u("Missing record ID","error");return}let o=xe(),r=ue();t&&(o.notes=r);let s={action:n.isNewRow&&(t||a)?"add_row":"edit",fields:o};if(t&&!n.isNewRow)s.rowNumber=e;else if(a&&!n.isNewRow){let d=n.selectedItem?.row_number||e;s.rowNumber=d}else!t&&!a&&(s.requestId=e,s.notes=r);let l=Ue();if(!l){u("No edits allowed.","error");return}(await g(l,{method:"POST",body:JSON.stringify(s)})).ok?(u("Updates saved"),n.isNewRow&&(h.has(n.tab)||a)?window.location.href=`/?tab=${encodeURIComponent(n.tab)}`:h.has(n.tab)?await me(e):a?await me(e):await me(n.selectedItem.request_id)):u("Update failed","error")}async function Ta(){if(h.has(n.tab)){u("Use Save updates for pricing notes.","error");return}let e=je();if(!e){u("Missing record ID","error");return}if(n.tab==="tickets"){let s=ue();if(!s){u("Add a comment first.","error");return}if((await g("/tickets/action",{method:"POST",body:JSON.stringify({action:"add_note",requestId:e,note:s})})).ok){u("Comment added");let c=x("notes");c&&(c.value=""),await Ct(e)}else u("Comment failed","error");return}let t=ue();if(n.tab==="orders"&&i.discountType){let s=i.discountType.value||"none",l=i.discountPercent?.value?.trim()||"";if(s!=="none"){let c=`DISCOUNT: ${s}${l?` ${l}%`:""} (internal)`;if(!t.includes(c)){t=t?`${t}
${c}`:c;let d=x("notes");d&&(d.value=t)}}}let a={action:"edit",notes:t};n.tab==="price-chart"||n.tab==="cost-chart"||n.tab==="diamond-price-chart"?a.rowNumber=e:a.requestId=e;let o=Ue();if(!o){u("No edits allowed.","error");return}(await g(o,{method:"POST",body:JSON.stringify(a)})).ok?(u("Notes saved"),de({type:"notes",title:"Internal notes saved",detail:"Updated internal notes"}),await me(n.selectedItem.request_id)):u("Notes failed","error")}async function Oa(){if(!n.selectedItem||!n.selectedItem.request_id){u("Missing request ID","error");return}let e=ga();if(!Object.keys(e).length){u("No fulfillment details to save.","error");return}let t={requestId:n.selectedItem.request_id,action:"edit",details:e};(await g("/orders/action",{method:"POST",body:JSON.stringify(t)})).ok?(u("Fulfillment details saved"),de({type:"fulfillment",title:"Fulfillment details saved",detail:`${e.shipping_carrier||"Carrier"} / ${e.tracking_number||"No tracking"}`}),await Na(n.selectedItem.request_id)):u("Fulfillment save failed","error")}async function Ln(){if(!n.selectedItem||!n.selectedItem.request_id){u("Missing request ID","error");return}let e=vt();if(!e.length){u("No order updates to confirm.","error");return}i.confirmSend.disabled=!0;try{let t=await g("/orders/confirm",{method:"POST",body:JSON.stringify({requestId:n.selectedItem.request_id,changes:e,email:n.selectedItem.email||"",name:n.selectedItem.name||"",productName:n.selectedItem.product_name||""})}),a=Sn(t);if(!t.ok||!a)throw new Error("confirmation_failed");let o=bn(n.selectedItem,e,a);n.pendingChanges=e,n.confirmation={confirmationUrl:a,emailPayload:o,changes:e},vn({to:n.selectedItem.email||"--",subject:o.subject,previewHtml:o.previewHtml})}catch{u("Unable to build confirmation email.","error")}finally{i.confirmSend.disabled=!1}}async function An(){if(!n.selectedItem||!n.selectedItem.request_id){u("Missing request ID","error");return}if(!vt().length){u("No order updates to confirm.","error");return}let t=n.confirmation;if(!t||!t.confirmationUrl){u("Open the confirmation preview first.","error");return}let a=t.emailPayload;if(!a){u("Confirmation email is missing.","error");return}let o=xe(),r=ue(),s={requestId:n.selectedItem.request_id,action:"request_confirmation",status:"PENDING_CONFIRMATION",notes:r,fields:o};if(!(await g("/orders/action",{method:"POST",body:JSON.stringify(s)})).ok){u("Update failed before email.","error");return}(await g("/email",{method:"POST",body:JSON.stringify({to:n.selectedItem.email||"",subject:a.subject,textBody:a.textBody,htmlBody:a.htmlBody,requestId:n.selectedItem.request_id,orderStatus:"PENDING_CONFIRMATION"})})).ok?(u("Confirmation sent"),_t(),await me(n.selectedItem.request_id)):u("Email failed","error")}function Nn(){i.actionSelect&&i.actionSelect.addEventListener("change",()=>{J()}),i.actionRun&&i.actionRun.addEventListener("click",()=>{let t=i.actionSelect?i.actionSelect.value:"";if(!t)return;if(n.tab==="quotes"){let o=Je();if(o.blocked){u(o.reason||"Pricing not ready.","error");return}}let a=un(t);a&&a.confirm&&!window.confirm(a.confirm)||n.criticalDirty&&!window.confirm("Proceed without saving critical edits?")||qn(t)}),i.detailGrid&&i.detailGrid.addEventListener("click",t=>{let a=t.target;if(!(a instanceof HTMLElement))return;let o=a.closest("[data-carousel-prev]"),r=a.closest("[data-carousel-next]");if(!o&&!r)return;let s=a.closest("[data-media-carousel]");if(!s)return;let l=s.querySelector("[data-carousel-track]");if(!(l instanceof HTMLElement))return;let c=o?-1:1;l.scrollBy({left:l.clientWidth*c,behavior:"smooth"})}),i.editFields.forEach(t=>{let a=o=>{let r=t.dataset.field||"";if(r==="metal"&&(zt(t.value),bt(i.quoteMetalInput?i.quoteMetalInput.value:"",t.value)),(r==="quote_discount_type"||r==="quote_discount_percent")&&ma(),(r==="stone_weight"||r==="diamond_breakdown")&&ht(),r==="stone"&&Ut(),n.tab==="quotes"&&r)if(q.has(r)){let s=_.get(r);t.value?(ii(t),di(s)):(t.dataset.manual="",t.dataset.auto="true",$({optionIndex:s})),ut(s)}else w.has(r)?$({baseChanged:!0}):_.has(r)&&$({optionIndex:_.get(r)});if((r==="metal_weight"||r==="metal_weight_adjustment")&&(Sa(),wa()),["price","quote_discount_type","quote_discount_percent"].includes(r)&&Te(),n.selectedItem&&r&&(n.selectedItem[r]=t.value,re(n.selectedItem)),o.type==="change"&&r){let s=t.dataset.activityValue||"",l=t.value.trim();if(s!==l){let c=t.closest(".field")?.querySelector("span")?.textContent?.trim()||r;de({type:"edit",title:`${c} updated`,detail:`${s||"--"} -> ${l||"--"}`}),t.dataset.activityValue=l}}sn(),X(),L(),J()};t.addEventListener("input",a),t.addEventListener("change",a)}),[i.catalogFieldsBasic,i.catalogFieldsTaxonomy,i.catalogFieldsMaterials,i.catalogFieldsAudit,i.catalogFields].filter(Boolean).forEach(t=>{["input","change"].forEach(a=>{t.addEventListener(a,()=>{X(),L(),J()})})}),i.catalogTabs.length&&i.catalogTabs.forEach(t=>{t.addEventListener("click",()=>{Zt(t.dataset.catalogTab||fe)})}),i.mediaUpload&&i.mediaUpload.addEventListener("click",()=>{Ji()}),i.mediaLink&&i.mediaLink.addEventListener("click",()=>{Ki()}),i.mediaId&&i.mediaId.addEventListener("change",()=>{ta(i.mediaId.value||"")}),i.mediaDetailGenerate&&i.mediaDetailGenerate.addEventListener("click",async()=>{let t=String(n.selectedItem?.media_id||n.selectedItem?.id||"").trim();if(!t){u("Missing media ID.","error");return}i.mediaDetailGenerate.disabled=!0,i.mediaDetailGenerate.textContent="Generating...";try{let a=await g("/media/describe",{method:"POST",body:JSON.stringify({media_id:t})});if(!a?.ok){u(a?.error||"Failed to generate description.","error");return}let o=vi();o&&(o.value=a.description||"",o.dispatchEvent(new Event("input",{bubbles:!0}))),L(),u("Description generated. Review and save updates.","success")}catch(a){console.error(a),u("Failed to generate description.","error")}finally{i.mediaDetailGenerate.disabled=!1,i.mediaDetailGenerate.textContent="Generate description"}}),i.catalogMediaList&&i.catalogMediaList.addEventListener("click",t=>{let a=t.target;if(!(a instanceof HTMLElement))return;let o=a.closest(".catalog-media-item");if(a.hasAttribute("data-media-save")){let r=a.dataset.mappingId||"";if(r){if(!o){u("Unable to locate media row.","error");return}Qi(r,o)}else u("Missing media mapping id.","error")}if(a.hasAttribute("data-media-delete")){let r=a.dataset.mappingId||"";r?Xi(r):u("Missing media mapping id.","error")}if(a.hasAttribute("data-media-describe")){let r=a.dataset.mediaId||"";if(!r){u("Missing media id.","error");return}Yi(r,o)}}),i.catalogStoneList&&i.catalogStoneList.addEventListener("click",t=>{let a=t.target;if(!(a instanceof HTMLElement))return;let o=a.closest("[data-stone-option-id]");if(o){if(a.hasAttribute("data-stone-save")){Ii(o);return}a.hasAttribute("data-stone-delete")&&Ti(o)}}),i.stoneAddButton&&i.stoneAddButton.addEventListener("click",()=>{Ni()}),i.catalogMetalList&&i.catalogMetalList.addEventListener("click",t=>{let a=t.target;if(!(a instanceof HTMLElement))return;let o=a.closest("[data-metal-option-id]");if(o){if(a.hasAttribute("data-metal-save")){Ri(o);return}a.hasAttribute("data-metal-delete")&&Fi(o)}}),i.metalAddButton&&i.metalAddButton.addEventListener("click",()=>{zi()}),i.catalogNotesSection&&i.catalogNotesSection.addEventListener("click",t=>{let a=t.target;if(!(a instanceof HTMLElement))return;if(a.hasAttribute("data-note-save")){let r=a.dataset.noteSave||"";r&&ji(r);return}if(a.hasAttribute("data-note-add")){let r=a.dataset.noteAdd||"";r&&Wi(r);return}let o=a.closest("[data-note-id]");if(o){if(a.hasAttribute("data-note-row-save")){Vi(o);return}a.hasAttribute("data-note-row-delete")&&Hi(o)}}),i.quoteMetals.forEach(t=>{t.addEventListener("change",()=>{pa(),L()})}),i.optionActiveToggles.forEach((t,a)=>{t.addEventListener("change",()=>{jt(a,t.checked),X(),L(),$({optionIndex:a})})}),i.optionRecommendRadios.forEach((t,a)=>{t.addEventListener("change",()=>{t.checked&&(n.recommendedOptionIndex=a,dt())})}),i.optionCopyButtons.forEach(t=>{t.addEventListener("click",()=>{let a=Number(t.dataset.optionCopy),o=ce(a),r=o?o.value.trim():"";Ce(`Option ${a+1} price`,r)})}),i.optionAutoButtons.forEach(t=>{t.addEventListener("click",()=>{let a=Number(t.dataset.optionAuto),o=ce(a);o&&(o.dataset.manual="",o.dataset.auto="true",o.value=""),D(a,"stale"),$({optionIndex:a})})}),i.breakdownRawToggle&&i.breakdownRaw&&i.breakdownRawToggle.addEventListener("click",()=>{i.breakdownRaw.classList.toggle("is-hidden")}),i.diamondBreakdownAdd&&i.diamondBreakdownAdd.addEventListener("click",()=>{let t=Le(),a=le();a.push({weight:"",count:"",stoneType:t}),Fe(a),$({baseChanged:!0})}),i.diamondBreakdownRows&&(i.diamondBreakdownRows.addEventListener("input",t=>{t.target instanceof HTMLInputElement&&(!t.target.hasAttribute("data-diamond-weight")&&!t.target.hasAttribute("data-diamond-count")||(Re(),Ae(le()),Ft(),L(),$({baseChanged:!0})))}),i.diamondBreakdownRows.addEventListener("change",t=>{let a=t.target;a instanceof HTMLElement&&a.hasAttribute("data-diamond-type")&&(Re(),Ae(le()),L(),$({baseChanged:!0}))}),i.diamondBreakdownRows.addEventListener("click",t=>{let a=t.target;if(!(a instanceof HTMLElement)||!a.hasAttribute("data-diamond-remove"))return;let o=a.closest("[data-diamond-row]");o&&o.remove(),Re(),Ae(le()),Ft(),L(),$({baseChanged:!0}),i.diamondBreakdownRows.querySelector("[data-diamond-row]")||Fe([])})),i.missingList&&i.missingList.addEventListener("click",t=>{let a=t.target;if(!(a instanceof HTMLElement))return;let o=a.dataset.focusTarget;o&&Ua(o)}),i.diamondPresets&&i.diamondPresets.addEventListener("change",()=>{ai(i.diamondPresets.value),$({baseChanged:!0}),L()}),i.discountType&&i.discountType.addEventListener("change",()=>{Te(),$({baseChanged:!0}),L()}),i.discountPercent&&i.discountPercent.addEventListener("input",()=>{Te(),$({baseChanged:!0}),L()}),i.orderDetailsFields.forEach(t=>{["input","change"].forEach(a=>{t.addEventListener(a,o=>{if(an(t),o.type==="change"){let r=t.dataset.activityValue||"",s=t.value.trim();if(r!==s){let l=t.closest(".field")?.querySelector("span")?.textContent?.trim()||t.dataset.orderDetailsField||"Fulfillment update";de({type:"edit",title:`${l} updated`,detail:`${r||"--"} -> ${s||"--"}`}),t.dataset.activityValue=s}}})})}),ja(i.orderDetailsSection,()=>{X(),Oe()}),i.openTracking&&i.openTracking.addEventListener("click",()=>{let t=oe("tracking_url");t&&window.open(t,"_blank")});let e=rt();e&&e.addEventListener("input",()=>{Pe||(Bt(),L(),$({baseChanged:!0}))}),[i.sizeRing,i.sizeBracelet,i.sizeChain].forEach(t=>{t&&["input","change"].forEach(a=>{t.addEventListener(a,()=>{nt(),$({baseChanged:!0}),L(),n.selectedItem&&re(n.selectedItem)})})}),i.primaryAction&&i.primaryAction.addEventListener("click",()=>{if(n.tab!=="orders"){Ia();return}n.criticalDirty&&!window.confirm("Proceed without saving critical edits?")||Ln()}),i.notesSave&&i.notesSave.addEventListener("click",()=>{window.confirm("Save internal notes?")&&Ta()}),i.noteTimestamp&&i.noteTimestamp.addEventListener("click",()=>{cn(),L()}),i.noteTemplate&&i.noteTemplate.addEventListener("click",()=>{dn(),L()}),i.noteTags.forEach(t=>{t.addEventListener("click",()=>{St(`${t.dataset.noteTag} `),L()})}),i.copyCustomer&&i.copyCustomer.addEventListener("click",()=>Ce("Customer name",i.summaryCustomer?.textContent?.trim())),i.copyEmail&&i.copyEmail.addEventListener("click",()=>Ce("Email",i.summaryEmail?.textContent?.trim())),i.copyPhone&&i.copyPhone.addEventListener("click",()=>Ce("Phone",i.summaryPhone?.textContent?.trim())),i.copyAddress&&i.copyAddress.addEventListener("click",()=>Ce("Address",i.summaryAddress?.textContent?.trim())),i.copySummary&&i.copySummary.addEventListener("click",()=>{let t=rn(n.selectedItem);Ce("Order summary",t)}),i.goldRefresh&&i.goldRefresh.addEventListener("click",async()=>{i.goldRefresh.disabled=!0,i.goldRefresh.textContent="Refreshing...";try{let t=await g("/cost-chart/gold-refresh",{method:"POST"});if(t.ok){let a=document.querySelector('[data-field="value"]'),o=document.querySelector('[data-field="notes"]');a&&t.value!==void 0&&(a.value=t.value,va()),o&&t.notes!==void 0&&(o.value=t.notes||"",va()),u("Gold price refreshed. Review and click Save.")}else u(t.error||"Failed to refresh gold price","error")}catch{u("Failed to refresh gold price","error")}finally{i.goldRefresh.textContent="Refresh gold price",i.goldRefresh.disabled=!1}}),i.detailsSave&&i.detailsSave.addEventListener("click",()=>{window.confirm("Save fulfillment details?")&&Oa()}),document.addEventListener("keydown",t=>{if((t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="s"){t.preventDefault();let a=document.activeElement;a&&a.closest("[data-order-details-section]")?Oa():S.has(n.tab)?Ia():Ta()}}),i.confirmClose&&i.confirmClose.addEventListener("click",_t),i.confirmModal&&i.confirmModal.addEventListener("click",t=>{t.target===i.confirmModal&&_t()}),i.confirmSend&&i.confirmSend.addEventListener("click",()=>{n.criticalDirty&&!window.confirm("Proceed without saving critical edits?")||window.confirm("Send confirmation to customer?")&&An()})}async function In(){let e=new URLSearchParams(window.location.search),t=document.body.dataset.detailTab||"",a=e.get("tab")||t,o=e.get("id");if(!a||!o)try{let r=localStorage.getItem("adminDetailTab")||"",s=localStorage.getItem("adminDetailId")||"";if(!a&&r&&!t&&(a=r),!o&&s&&(o=s),(a||o)&&!t){let l=new URLSearchParams(window.location.search);a&&l.set("tab",a),o&&l.set("id",o);let c=`${window.location.pathname}?${l.toString()}`;window.history.replaceState({},"",c)}}catch{}if(a&&T[a]&&(n.tab=a),i.backLink&&(i.backLink.href=`/?tab=${encodeURIComponent(n.tab)}`),Nn(),await _n(),o==="new"&&(h.has(n.tab)||S.has(n.tab))){n.isNewRow=!0,S.has(n.tab)?(await Cn(),await Aa({})):await La({}),we("New row");return}n.isNewRow=!1,await me(o)}In()})();function Ma({ui:n,apiFetch:T,showToast:A}){let E=f=>{f&&Object.entries(f).forEach(([q,w])=>{let _=document.querySelector(`[data-count-${q}]`);if(!_)return;let N=Number(w)||0;_.textContent=String(N),_.style.display=N>0?"inline-flex":"none"})},I=async()=>{try{let f=await T("/navigation/counts");E(f||{})}catch(f){if(f?.status===404){E({});return}A("Failed to load sidebar counts.","error")}},U=()=>{I(),setInterval(I,3e4)},z=f=>{f.forEach(q=>{q.style.display="",q.classList.remove("search-highlight")}),document.querySelector(".side-search__no-results")?.remove()},G=(f,q)=>{let w=document.querySelector(".side-search__no-results");if(f&&!w){let _=document.querySelector(".side-search");if(!_)return;let N=document.createElement("div");N.className="side-search__no-results",N.innerHTML=`
        <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.3;margin-bottom:8px;">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <p>No sections matching<br/><strong>"${q}"</strong></p>
      `,_.after(N)}else!f&&w&&w.remove()},R=(f,q,w)=>{let _=!1;w.forEach(N=>{let ae=Array.from(N.querySelectorAll(".side-link")),Y=!1;if(ae.forEach(V=>{let De=(V.querySelector(".side-link__label")?.textContent?.toLowerCase()||"").includes(f);V.style.display=De?"":"none",De?(V.classList.add("search-highlight"),Y=!0,_=!0):V.classList.remove("search-highlight")}),Y&&N.classList.contains("is-collapsed")){N.classList.remove("is-collapsed");let V=N.querySelector("[data-side-toggle]");V&&(V.textContent="-")}}),G(!_,f)},Q=()=>{let f=n.sidebarSearch;if(!f)return;let q=Array.from(document.querySelectorAll(".side-link")),w=Array.from(document.querySelectorAll(".side-block"));f.addEventListener("input",_=>{let N=String(_.target.value||"").toLowerCase().trim();if(!N){z(q);return}R(N,q,w)}),f.addEventListener("keydown",_=>{_.key==="Escape"&&(f.value="",f.dispatchEvent(new Event("input")),f.blur())})},h=()=>{let f=Array.from(document.querySelectorAll(".side-link")),q=f.findIndex(w=>w.classList.contains("is-active"));q<0&&(q=0),document.addEventListener("keydown",w=>{if(!w.target.matches("input, textarea, select")){if((w.metaKey||w.ctrlKey)&&w.key.toLowerCase()==="k"){w.preventDefault(),n.sidebarSearch?.focus(),n.sidebarSearch?.select();return}if(w.altKey&&w.key>="1"&&w.key<="9"){w.preventDefault();let _=Number(w.key)-1;f[_]&&(f[_].click(),f[_].focus());return}w.altKey&&(w.key==="ArrowUp"||w.key==="ArrowDown")&&(w.preventDefault(),w.key==="ArrowUp"?q=q>0?q-1:f.length-1:q=q<f.length-1?q+1:0,f[q].click(),f[q].focus())}})},S=()=>{n.sidebar&&(n.sidebar.classList.remove("is-collapsed"),n.appShell?.classList.remove("sidebar-collapsed"))},te=()=>{document.querySelectorAll("[data-side-toggle]").forEach(w=>{w.addEventListener("click",()=>{let _=w.closest(".side-block");if(!_)return;let N=_.classList.toggle("is-collapsed");w.textContent=N?"+":"-";let ae=_.dataset.blockId;if(ae){let Y=JSON.parse(localStorage.getItem("sidebar-collapsed-blocks")||"[]");if(N)Y.includes(ae)||Y.push(ae);else{let V=Y.indexOf(ae);V>-1&&Y.splice(V,1)}localStorage.setItem("sidebar-collapsed-blocks",JSON.stringify(Y))}})}),JSON.parse(localStorage.getItem("sidebar-collapsed-blocks")||"[]").forEach(w=>{let _=document.querySelector(`[data-block-id="${w}"]`);if(_&&!_.classList.contains("is-collapsed")){_.classList.add("is-collapsed");let N=_.querySelector("[data-side-toggle]");N&&(N.textContent="+")}})};return{initSidebar:()=>{S(),Q(),h(),te(),U(),console.log("Sidebar initialized")},updateNavigationCounts:E}}function Pa(n){return function(A,E){n&&(n.textContent=A,n.classList.add("is-visible"),E==="error"?n.style.background="#b42318":n.style.background="var(--ink)",setTimeout(()=>n.classList.remove("is-visible"),2400))}}function $a({ui:n,apiFetch:T,showToast:A,windowRef:E}){let I=[],U=h=>{n.notificationsPanel&&(n.notificationsPanel.classList.toggle("is-open",h),n.notificationsPanel.setAttribute("aria-hidden",h?"false":"true"),h?n.notificationsPanel.removeAttribute("inert"):n.notificationsPanel.setAttribute("inert",""))},z=()=>{if(!n.notificationsList)return;if(!I.length){n.notificationsList.innerHTML='<p class="muted">No notifications right now.</p>',n.notificationsBadge&&(n.notificationsBadge.textContent="",n.notificationsBadge.classList.add("is-hidden"));return}let h=I.filter(S=>!S.read).length;n.notificationsBadge&&(n.notificationsBadge.textContent=h?String(h):"",n.notificationsBadge.classList.toggle("is-hidden",h===0)),n.notificationsList.innerHTML=I.map(S=>{let te=S.title||S.type||"Update",fe=S.message||S.body||"",f=S.created_at||S.createdAt||"";return`
          <button class="notification-item ${S.read?"":"is-unread"}" type="button" data-notification-id="${S.id||""}">
            <div class="notification-title">${te}</div>
            <div class="notification-body">${fe}</div>
            <div class="notification-meta">${f}</div>
          </button>
        `}).join("")},G=async()=>{try{let h=await T("/notifications");I=Array.isArray(h?.items)?h.items:h||[],z()}catch(h){if(h?.status===404){I=[],z();return}I=[],z(),E.location.hostname==="localhost"&&A("Notifications unavailable.","error")}},R=async h=>{if(h)try{await T(`/notifications/${h}/read`,{method:"POST"}),I=I.map(S=>String(S.id)===String(h)?{...S,read:!0}:S),z()}catch{A("Failed to mark notification read.","error")}};return{bindNotifications:()=>{n.notificationsToggle&&n.notificationsToggle.addEventListener("click",()=>{let h=n.notificationsPanel?.classList.contains("is-open");U(!h),h||G()}),n.notificationsClose&&n.notificationsClose.addEventListener("click",()=>U(!1)),n.notificationsList&&n.notificationsList.addEventListener("click",h=>{let S=h.target.closest("[data-notification-id]");S&&R(S.dataset.notificationId)})},loadNotifications:G}}function On(){return typeof window>"u"?"":localStorage.getItem("adminApiBase")||""||document.body.dataset.apiBase||""}function za(){if(typeof window>"u")return"";let n=window.location.origin||"";if(!n.startsWith("http://localhost")&&!n.startsWith("http://127.0.0.1"))return"";let T=localStorage.getItem("adminEmail")||"";if(T)return T;let A=new URLSearchParams(window.location.search),E=A.get("adminEmail")||A.get("admin_email")||"";return E&&E.includes("@")?(localStorage.setItem("adminEmail",E),E):""}function xn(){if(typeof window>"u")return"";try{return localStorage.getItem("adminEmail")||""}catch{return""}}function Dn(n={},T=""){let A={"Content-Type":"application/json",...n},E=T||za();return E&&(A["X-Admin-Email"]=E),A}async function kt(n,T={}){let A=On();if(!A)throw new Error("Missing API base");let E=A.endsWith("/")?A:`${A}/`,I=new URL(n.replace(/^\//,""),E),U=E.startsWith("http://localhost")||E.startsWith("http://127.0.0.1"),z=U?xn():za(),G=Dn(T.headers||{},z);U&&z&&I.searchParams.set("admin_email",z);let R=await fetch(I.toString(),{credentials:U?"omit":"include",headers:G,...T});if(!R.ok){let Q=await R.text(),h=new Error(Q||R.statusText);throw h.status=R.status,h}return await R.json()}var Mn={orders:"Orders",quotes:"Quotes",tickets:"Tickets",contacts:"Contacts",products:"Products",inspirations:"Inspirations","media-library":"Media","cost-chart":"Cost Chart","diamond-price-chart":"Diamond Pricing"},Pn=()=>{let n=document.querySelector("[data-sidebar]");if(!n)return;let T={sidebar:n,sidebarSearch:document.querySelector("[data-sidebar-search]"),appShell:document.querySelector(".app-shell"),notificationsToggle:document.querySelector("[data-notifications-toggle]"),notificationsPanel:document.querySelector("[data-notifications-panel]"),notificationsList:document.querySelector("[data-notifications-list]"),notificationsBadge:document.querySelector("[data-notifications-badge]"),notificationsClose:document.querySelector("[data-notifications-close]")},A=document.querySelector("[data-toast]"),E=Pa(A),{initSidebar:I,updateNavigationCounts:U}=Ma({ui:T,apiFetch:kt,showToast:E}),{bindNotifications:z}=$a({ui:T,apiFetch:kt,showToast:E,windowRef:window}),G=document.body.dataset.detailTab||"",R=n.querySelector(`.side-link[data-tab="${G}"]`);R&&R.classList.add("is-active");let Q=document.querySelector("[data-tab-title]");Q&&(Q.textContent=Mn[G]||"Details"),n.querySelectorAll(".side-link[data-tab]").forEach(h=>{h.addEventListener("click",()=>{let S=h.dataset.tab||"";S&&(window.location.href=`/?tab=${encodeURIComponent(S)}`)})}),I(),z(),document.body.dataset.enableNavCounts!=="true"&&U({})};Pn();})();
