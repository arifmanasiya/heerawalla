"use strict";(()=>{(()=>{(()=>{let n={tab:"orders",role:"",email:"",selectedId:"",selectedItem:null,originalValues:{},originalRaw:{},originalNotes:"",orderDetails:{},dirtySections:{edits:!1,fulfillment:!1},criticalDirty:!1,pendingChanges:[],confirmation:null,isNewRow:!1,catalogHeaders:[],catalogEnums:null,catalogFormState:null,catalogOriginalFields:null,catalogMediaState:null,catalogStoneOptions:null,catalogMetalOptions:null,catalogNotes:null,catalogValidation:null,mediaLibraryItems:[],sizingSpec:null,recommendedOptionIndex:null},b={orders:["NEW","ACKNOWLEDGED","PENDING_CONFIRMATION","INVOICED","INVOICE_EXPIRED","INVOICE_PAID","PROCESSING","SHIPPED","DELIVERED","CANCELLED"],quotes:["NEW","ACKNOWLEDGED","QUOTED","QUOTE_ACTIONED","DROPPED"],tickets:["NEW","PENDING","RESOLVED"],contacts:[],products:[],inspirations:[],"media-library":[],"price-chart":[],"cost-chart":[],"diamond-price-chart":[]},T={orders:[{action:"acknowledge",label:"Acknowledge",confirm:"Mark as acknowledged?"},{action:"send_invoice",label:"Send invoice",confirm:"Send invoice and mark invoiced?"},{action:"mark_paid",label:"Mark paid",confirm:"Confirm payment received?"},{action:"mark_invoice_expired",label:"Mark invoice expired",confirm:"Mark invoice as expired?"},{action:"mark_processing",label:"Mark processing",confirm:"Move order into processing?"},{action:"mark_shipped",label:"Mark shipped",confirm:"Mark as shipped?"},{action:"mark_delivered",label:"Mark delivered",confirm:"Mark as delivered?"},{action:"cancel",label:"Cancel order",confirm:"Cancel this order?"},{action:"delete",label:"Delete",confirm:"Delete this order? This cannot be undone."}],quotes:[{action:"acknowledge",label:"Acknowledge",confirm:"Mark as acknowledged?"},{action:"submit_quote",label:"Send quote link",confirm:"Send quote link to customer?"},{action:"refresh_quote",label:"Refresh quote link",confirm:"Send a refreshed quote link?"},{action:"mark_actioned",label:"Mark quote actioned",confirm:"Mark quote as actioned?"},{action:"drop",label:"Drop",confirm:"Drop this quote?"},{action:"delete",label:"Delete",confirm:"Delete this quote? This cannot be undone."}],tickets:[{action:"mark_pending",label:"Mark pending",confirm:"Mark as pending?"},{action:"mark_resolved",label:"Mark resolved",confirm:"Mark as resolved?"},{action:"send_email",label:"Send email",confirm:"Send an email to this customer?"},{action:"delete",label:"Delete",confirm:"Delete this ticket? This cannot be undone."}],contacts:[],products:[{action:"delete",label:"Delete",confirm:"Delete this product? This cannot be undone."}],inspirations:[],"media-library":[],"price-chart":[],"cost-chart":[],"diamond-price-chart":[]},M={orders:["price","timeline","timeline_adjustment_weeks","metal","metal_weight","metal_weight_adjustment","stone","stone_weight","notes"],quotes:["timeline","timeline_adjustment_weeks","metal","metal_weight","stone","stone_weight","diamond_breakdown","size","quote_metal_options","quote_option_1_clarity","quote_option_1_color","quote_option_1_price_18k","quote_option_2_clarity","quote_option_2_color","quote_option_2_price_18k","quote_option_3_clarity","quote_option_3_color","quote_option_3_price_18k","quote_discount_type","quote_discount_percent","notes"],tickets:["notes"],contacts:[],products:[],inspirations:[],"media-library":[],"price-chart":["metal","adjustment_type","adjustment_value","notes"],"cost-chart":["key","value","unit","notes"],"diamond-price-chart":["clarity","color","weight_min","weight_max","price_per_ct","notes"]},f=[{key:"price",label:"Price",normalize:Ya,format:se},{key:"timeline",label:"Timeline",normalize:zt,format:Ue},{key:"timeline_adjustment_weeks",label:"Timeline delay",normalize:je,format:ut},{key:"metal",label:"Metal",normalize:ve,format:Rt},{key:"metal_weight",label:"Metal weight (g)",normalize:je,format:Ft},{key:"metal_weight_adjustment",label:"Final Metal weight difference (g)",normalize:je,format:Bt},{key:"stone",label:"Stone type",normalize:ve,format:Rt},{key:"stone_weight",label:"Stone weight",normalize:je,format:st}],L=["shipping_method","shipping_carrier","tracking_number","tracking_url","shipping_status","delivery_eta","shipping_notes","certificates","care_details","warranty_details","service_details"],y=["shipping_carrier","tracking_number","certificates","care_details","warranty_details","service_details"],q={NEW:["ACKNOWLEDGED","CANCELLED"],ACKNOWLEDGED:["PENDING_CONFIRMATION","INVOICED","CANCELLED"],PENDING_CONFIRMATION:["INVOICED","CANCELLED"],INVOICED:["INVOICE_PAID","INVOICE_EXPIRED","CANCELLED"],INVOICE_EXPIRED:["INVOICED","CANCELLED"],INVOICE_PAID:["PROCESSING","SHIPPED"],PROCESSING:["SHIPPED"],SHIPPED:["DELIVERED"],DELIVERED:[],CANCELLED:["INVOICED"]},E={NEW:["acknowledge","cancel"],ACKNOWLEDGED:["send_invoice","cancel"],PENDING_CONFIRMATION:["send_invoice","cancel"],INVOICED:["mark_paid","mark_invoice_expired","cancel"],INVOICE_EXPIRED:["send_invoice","cancel"],INVOICE_PAID:["mark_processing","mark_shipped"],PROCESSING:["mark_shipped"],SHIPPED:["mark_delivered"],DELIVERED:[],CANCELLED:["send_invoice"]},k={orders:"Order",quotes:"Quote",tickets:"Customer ticket",contacts:"Contact",products:"Product",inspirations:"Inspiration","media-library":"Media library","price-chart":"Price chart","cost-chart":"Cost chart","diamond-price-chart":"Diamond price chart"},S=new Set(["price-chart","cost-chart","diamond-price-chart"]),I=new Set(["products","inspirations","media-library"]),ne=new Set(["products","inspirations"]),h="basics",g=[{clarity:"quote_option_1_clarity",color:"quote_option_1_color",price:"quote_option_1_price_18k"},{clarity:"quote_option_2_clarity",color:"quote_option_2_color",price:"quote_option_2_price_18k"},{clarity:"quote_option_3_clarity",color:"quote_option_3_color",price:"quote_option_3_price_18k"}],A=new Set(g.map(e=>e.price)),z=new Set(["metal","metal_weight","stone","stone_weight","diamond_breakdown","timeline","timeline_adjustment_weeks","quote_discount_type","quote_discount_percent","size","size_label","size_ring","size_bracelet","size_chain"]),P=new Map;g.forEach((e,t)=>{P.set(e.clarity,t),P.set(e.color,t),P.set(e.price,t)});let he=["metal","metal_weight","stone","stone_weight","diamond_breakdown","diamond_breakdown_components","timeline","timeline_adjustment_weeks","quote_discount_type","quote_discount_percent","size","size_label","size_ring","size_bracelet","size_chain","clarity","color"],ze=new Set(["price","timeline","timeline_adjustment_weeks","metal","metal_weight","metal_weight_adjustment","stone","stone_weight"]),re={fedex:"https://www.fedex.com/apps/fedextrack/?tracknumbers=",ups:"https://www.ups.com/track?tracknum=",dhl:"https://www.dhl.com/en/express/tracking.html?AWB=",usps:"https://tools.usps.com/go/TrackConfirmAction?tLabels="},Re=new Set(["in transit","out for delivery","delivered","picked up","exception"]),Ee=["diamond","lab grown diamond"],Wa=[{value:"center",label:"Center"},{value:"accent",label:"Accent"},{value:"side",label:"Side"},{value:"halo",label:"Halo"}],$t=[{value:"xsmall",label:"X-Small"},{value:"small",label:"Small"},{value:"medium",label:"Medium"},{value:"large",label:"Large"},{value:"xlarge",label:"X-Large"},{value:"xxlarge",label:"XX-Large"}],Ga=[{value:"round",label:"Round"},{value:"pear",label:"Pear"},{value:"oval",label:"Oval"},{value:"marquise",label:"Marquise"},{value:"princess",label:"Princess"},{value:"emerald",label:"Emerald"},{value:"radiant",label:"Radiant"},{value:"cushion",label:"Cushion"},{value:"heart",label:"Heart"},{value:"asscher",label:"Asscher"},{value:"baguette",label:"Baguette"}],Tt=["description","long_desc"],nt=["takeaway","translation_note"],Va=["Metal weight confirmed","Diamond breakdown confirmed","Customer confirmation sent","Vendor assigned","Tracking added"],Pt=40,be=[],Se=e=>{let t=String(e||"NEW").trim().toUpperCase();return t==="INVOICE_NOT_PAID"?"INVOICE_EXPIRED":t||"NEW"},Un=()=>{let e=Se(n.selectedItem?.status);return(q[e]||[]).filter(t=>t!=="PENDING_CONFIRMATION")};function rt(){return n.tab==="orders"||n.tab==="quotes"||n.tab==="tickets"?n.role==="admin"||n.role==="ops":n.tab==="price-chart"||n.tab==="cost-chart"||n.tab==="diamond-price-chart"?n.role==="admin":I.has(n.tab)?n.role==="admin"||n.role==="ops":!1}let a={syncLine:document.querySelector("[data-sync-line]"),userRole:document.querySelector("[data-user-role]"),userEmail:document.querySelector("[data-user-email]"),backLink:document.querySelector("[data-back-link]"),detailHeader:document.querySelector("[data-detail-header]"),detailType:document.querySelector("[data-detail-type]"),detailTitle:document.querySelector("[data-detail-title]"),detailSub:document.querySelector("[data-detail-sub]"),detailError:document.querySelector("[data-detail-error]"),detailStatusCorner:document.querySelector("[data-detail-status-corner]"),detailGrid:document.querySelector("[data-detail-grid]"),overviewSection:document.querySelector("[data-overview-section]"),catalogSection:document.querySelector("[data-catalog-section]"),catalogTitle:document.querySelector("[data-catalog-title]"),catalogTabs:Array.from(document.querySelectorAll("[data-catalog-tab]")),catalogPanels:Array.from(document.querySelectorAll("[data-catalog-panel]")),catalogFields:document.querySelector("[data-catalog-fields]"),catalogFieldsBasic:document.querySelector("[data-catalog-fields-basic]"),catalogFieldsTaxonomy:document.querySelector("[data-catalog-fields-taxonomy]"),catalogFieldsMaterials:document.querySelector("[data-catalog-fields-materials]"),catalogFieldsAudit:document.querySelector("[data-catalog-fields-audit]"),catalogMediaSection:document.querySelector("[data-catalog-media-section]"),catalogMediaList:document.querySelector("[data-catalog-media-list]"),mediaFile:document.querySelector("[data-media-file]"),mediaLabel:document.querySelector("[data-media-label]"),mediaAlt:document.querySelector("[data-media-alt]"),mediaDescription:document.querySelector("[data-media-description]"),mediaPosition:document.querySelector("[data-media-position]"),mediaOrder:document.querySelector("[data-media-order]"),mediaPrimary:document.querySelector("[data-media-primary]"),mediaUpload:document.querySelector("[data-media-upload]"),mediaId:document.querySelector("[data-media-id]"),mediaPreview:document.querySelector("[data-media-preview]"),mediaPositionExisting:document.querySelector("[data-media-position-existing]"),mediaOrderExisting:document.querySelector("[data-media-order-existing]"),mediaPrimaryExisting:document.querySelector("[data-media-primary-existing]"),mediaLink:document.querySelector("[data-media-link]"),mediaDetailSection:document.querySelector("[data-media-detail-section]"),mediaDetailPreview:document.querySelector("[data-media-detail-preview]"),mediaDetailGenerate:document.querySelector("[data-media-detail-generate]"),mediaDetailId:document.querySelector("[data-media-detail-id]"),mediaDetailType:document.querySelector("[data-media-detail-type]"),mediaDetailUrl:document.querySelector("[data-media-detail-url]"),catalogNotesSection:document.querySelector("[data-catalog-notes-section]"),noteEditors:Array.from(document.querySelectorAll("[data-note-editor]")),noteSaveButtons:Array.from(document.querySelectorAll("[data-note-save]")),noteAddButtons:Array.from(document.querySelectorAll("[data-note-add]")),noteRows:Array.from(document.querySelectorAll("[data-note-rows]")),noteInputs:Array.from(document.querySelectorAll("[data-note-input]")),noteOrders:Array.from(document.querySelectorAll("[data-note-order]")),catalogStoneSection:document.querySelector("[data-catalog-stone-section]"),catalogStoneList:document.querySelector("[data-catalog-stone-list]"),stoneAddRole:document.querySelector("[data-stone-add-role]"),stoneAddCarat:document.querySelector("[data-stone-add-carat]"),stoneAddCount:document.querySelector("[data-stone-add-count]"),stoneAddSizeType:document.querySelector("[data-stone-add-size-type]"),stoneAddShape:document.querySelector("[data-stone-add-shape]"),stoneAddPrimary:document.querySelector("[data-stone-add-primary]"),stoneAddButton:document.querySelector("[data-stone-add]"),catalogMetalSection:document.querySelector("[data-catalog-metal-section]"),catalogMetalList:document.querySelector("[data-catalog-metal-list]"),metalAddWeight:document.querySelector("[data-metal-add-weight]"),metalAddSizeType:document.querySelector("[data-metal-add-size-type]"),metalAddPrimary:document.querySelector("[data-metal-add-primary]"),metalAddButton:document.querySelector("[data-metal-add]"),actionRow:document.querySelector("[data-action-row]"),actionSelect:document.querySelector("[data-action-select]"),actionRun:document.querySelector("[data-action-run]"),editSection:document.querySelector("[data-edit-section]"),quoteSection:document.querySelector("[data-quote-section]"),quoteMetals:Array.from(document.querySelectorAll('[data-quote-metals] input[type="checkbox"]')),quoteMetalInput:document.querySelector('[data-field="quote_metal_options"]'),quoteOptionCards:Array.from(document.querySelectorAll("[data-quote-option-card]")),quoteOptionStatuses:Array.from(document.querySelectorAll("[data-quote-option-status]")),quoteExtras:document.querySelector("[data-quote-extras]"),metalWeightLabel:document.querySelector("[data-metal-weight-label]"),metalWeightAdjustmentLabel:document.querySelector("[data-metal-weight-adjustment-label]"),metalWeightFinal:document.querySelector("[data-metal-weight-final]"),metalWeightError:document.querySelector("[data-metal-weight-error]"),metalWeightAdjustmentError:document.querySelector("[data-metal-weight-adjustment-error]"),editFields:Array.from(document.querySelectorAll("[data-field]")),orderDetailsSection:document.querySelector("[data-order-details-section]"),orderDetailsFields:Array.from(document.querySelectorAll("[data-order-details-field]")),diamondBreakdown:document.querySelector("[data-diamond-breakdown]"),diamondBreakdownRows:document.querySelector("[data-diamond-breakdown-rows]"),diamondBreakdownAdd:document.querySelector("[data-diamond-breakdown-add]"),diamondPieceCount:document.querySelector("[data-diamond-piece-count]"),diamondCaratTotal:document.querySelector("[data-diamond-carat-total]"),sizeRing:document.querySelector("[data-size-ring] input"),sizeBracelet:document.querySelector("[data-size-bracelet] input"),sizeChain:document.querySelector("[data-size-chain] input"),sizeBlock:document.querySelector("[data-size-block]"),detailsSave:document.querySelector("[data-details-save]"),primaryAction:document.querySelector("[data-primary-action]"),notesSave:document.querySelector("[data-notes-save]"),goldRefresh:document.querySelector("[data-gold-refresh]"),confirmModal:document.querySelector("[data-confirm-modal]"),confirmClose:document.querySelector("[data-confirm-close]"),confirmTo:document.querySelector("[data-confirm-to]"),confirmSubject:document.querySelector("[data-confirm-subject]"),confirmPreview:document.querySelector("[data-confirm-preview]"),confirmSend:document.querySelector("[data-confirm-send]"),dirtyIndicator:document.querySelector("[data-dirty-indicator]"),missingPanel:document.querySelector("[data-missing-panel]"),missingList:document.querySelector("[data-missing-list]"),activityFeed:document.querySelector("[data-activity-feed]"),summaryStatus:document.querySelector("[data-summary-status]"),summaryProduct:document.querySelector("[data-summary-product]"),summaryDesignCode:document.querySelector("[data-summary-design-code]"),summaryRequest:document.querySelector("[data-summary-request]"),summaryCreated:document.querySelector("[data-summary-created]"),summaryPrice:document.querySelector("[data-summary-price]"),summaryTimeline:document.querySelector("[data-summary-timeline]"),summaryTimelineDelay:document.querySelector("[data-summary-timeline-delay]"),summaryMetal:document.querySelector("[data-summary-metal]"),summaryStone:document.querySelector("[data-summary-stone]"),summaryStoneWeight:document.querySelector("[data-summary-stone-weight]"),summaryMetalWeight:document.querySelector("[data-summary-metal-weight]"),summaryMetalAdjustment:document.querySelector("[data-summary-metal-adjustment]"),summaryDiamondBreakdown:document.querySelector("[data-summary-diamond-breakdown]"),summaryDiscount:document.querySelector("[data-summary-discount]"),summaryPricingStatus:document.querySelector("[data-summary-pricing-status]"),summaryInterests:document.querySelector("[data-summary-interests]"),summaryContactPreference:document.querySelector("[data-summary-contact-preference]"),summarySubscription:document.querySelector("[data-summary-subscription]"),summaryCustomerNotes:document.querySelector("[data-summary-customer-notes]"),summaryOption1:document.querySelector("[data-summary-option-1]"),summaryOption2:document.querySelector("[data-summary-option-2]"),summaryOption3:document.querySelector("[data-summary-option-3]"),summaryOptionRecommended:document.querySelector("[data-summary-option-recommended]"),summaryLastPriced:document.querySelector("[data-summary-last-priced]"),summarySizeRing:document.querySelector("[data-summary-size-ring]"),summarySizeBracelet:document.querySelector("[data-summary-size-bracelet]"),summarySizeChain:document.querySelector("[data-summary-size-chain]"),summaryCustomer:document.querySelector("[data-summary-customer]"),summaryEmail:document.querySelector("[data-summary-email]"),summaryPhone:document.querySelector("[data-summary-phone]"),summaryAddress:document.querySelector("[data-summary-address]"),summaryCard:document.querySelector("[data-summary-card]"),detailAside:document.querySelector(".detail-aside"),summaryQuoteBlock:document.querySelector("[data-summary-quote-block]"),summaryPreferencesBlock:document.querySelector("[data-summary-preferences-block]"),summaryOptionsBlock:document.querySelector("[data-summary-options-block]"),summaryNotesBlock:document.querySelector("[data-summary-notes-block]"),summarySizesBlock:document.querySelector("[data-summary-sizes-block]"),summaryMore:document.querySelector("[data-summary-more]"),summaryPriceRow:document.querySelector("[data-summary-price-row]"),nextActionPanel:document.querySelector("[data-next-action-panel]"),copyCustomer:document.querySelector("[data-copy-customer]"),copyEmail:document.querySelector("[data-copy-email]"),copyPhone:document.querySelector("[data-copy-phone]"),copyAddress:document.querySelector("[data-copy-address]"),copySummary:document.querySelector("[data-copy-summary]"),nextActionText:document.querySelector("[data-next-action-text]"),discountPanel:document.querySelector("[data-discount-panel]"),discountType:document.querySelector("[data-discount-type]"),discountPercent:document.querySelector("[data-discount-percent]"),discountFinal:document.querySelector("[data-discount-final]"),breakdownRaw:document.querySelector("[data-breakdown-raw]"),breakdownRawToggle:document.querySelector("[data-breakdown-raw-toggle]"),optionFinals:Array.from(document.querySelectorAll("[data-option-final]")),optionActiveToggles:Array.from(document.querySelectorAll("[data-option-active]")),optionRecommendRadios:Array.from(document.querySelectorAll("[data-option-recommend]")),optionCopyButtons:Array.from(document.querySelectorAll("[data-option-copy]")),optionAutoButtons:Array.from(document.querySelectorAll("[data-option-auto]")),activitySection:document.querySelector("[data-activity-section]"),activitySlot:document.querySelector("[data-activity-slot]"),diamondPresets:document.querySelector("[data-diamond-presets]"),noteTimestamp:document.querySelector("[data-note-timestamp]"),noteTemplate:document.querySelector("[data-note-template]"),noteTags:Array.from(document.querySelectorAll("[data-note-tag]")),notesToggle:document.querySelector("[data-notes-toggle]"),openTracking:document.querySelector("[data-open-tracking]"),toast:document.querySelector("[data-toast]")};function Fe(){if(typeof window>"u")return"";let e=localStorage.getItem("adminApiBase")||"";if(e)return e;let t=document.body?.dataset?.apiBase;if(t)return t;let i=window.location.hostname;return i==="localhost"||i==="127.0.0.1"||i.startsWith("127.")||i==="::1"?`${window.location.origin}/admin`:"https://admin-api.heerawalla.com/admin"}let Hn=Fe(),Ae=(document.body.dataset.siteBase||"https://www.heerawalla.com").replace(/\/$/,""),Be=!1,ot=null,Ne=new Set,le={options:g.map(()=>({status:"idle",signature:"",lastPayload:null,lastError:"",lastPricedAt:""})),inflight:new Map,cache:new Map},te={data:null,promise:null},lt=new Map;function Ot(){if(typeof window>"u")return"";try{return localStorage.getItem("adminEmail")||""}catch{return""}}function Ja(e={},t=""){let i={"Content-Type":"application/json",...e},r=t||"";return r&&(i["X-Admin-Email"]=r),i}function xe(e){return e.startsWith("http://localhost")||e.startsWith("http://127.0.0.1")}function Mt(e,t,i){xe(t)&&i&&e.searchParams.set("admin_email",i)}function Dt(e,t){e&&(e.disabled=!t,e.classList.toggle("is-disabled",!t))}function Ka(e){if(!e)return;let t=document.querySelector(e);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),typeof t.focus=="function"&&t.focus({preventScroll:!0}))}function Qa(e,t){!e||typeof t!="function"||e.querySelectorAll("input,select,textarea").forEach(i=>{let r=()=>t(i);i.addEventListener("input",r),i.addEventListener("change",r)})}function Xa(e){if(e)if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(e).catch(()=>{});else{let t=document.createElement("textarea");t.value=e,t.setAttribute("readonly","true"),t.style.position="fixed",t.style.left="-9999px",document.body.appendChild(t),t.select();try{document.execCommand("copy")}catch{}document.body.removeChild(t)}}function N(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function C(e){return N(e).replace(/`/g,"&#96;")}function we(e){let t=String(e||"").trim();if(!t)return"";if(/^(https?:|data:|blob:)/i.test(t)){try{let i=new URL(t);if(Ae&&(i.hostname==="business.heerawalla.com"||i.hostname==="admin-api.heerawalla.com"))return`${Ae}${i.pathname}${i.search||""}`}catch{return t}return t}return t.startsWith("//")?`https:${t}`:Ae?t.startsWith("/")?`${Ae}${t}`:`${Ae}/${t}`:t}function ve(e){return String(e||"").trim().toLowerCase()}function je(e){let t=String(e||"").trim();if(!t)return"";let i=Number(t);return Number.isNaN(i)?t.toLowerCase():String(i)}function Ya(e){let t=String(e||"").replace(/[^0-9.]/g,"");if(!t)return"";let i=Number(t);return Number.isNaN(i)?t:String(i)}function zt(e){let t=ve(e);return t?t.includes("rush")?"rush":t.includes("standard")?"standard":t:""}function Rt(e){return String(e||"").trim()}function st(e){let t=String(e||"").trim();if(!t)return"";let i=Number(t);return Number.isNaN(i)?t:`${i} ct`}function Ft(e){let t=String(e||"").trim();if(!t)return"";let i=Number(t);return Number.isNaN(i)?t:`${i} g`}function Bt(e){let t=String(e||"").trim();if(!t)return"";let i=Number(t);return Number.isNaN(i)?t:`${i>0?"+":""}${i} g`}function V(e){return e!=null&&String(e).trim()!==""}function jt(e){let t=e?.sizing||e?.sizing_details||e?.sizing_info||e?.size_details||e?.size_info;if(!t)return{};if(typeof t=="object")return t;if(typeof t=="string")try{let i=JSON.parse(t);if(i&&typeof i=="object")return i}catch{return{}}return{}}function ue(e,t,i,r){for(let o of r){let l=e?e[o]:"";if(V(l))return l;let s=t?t[o]:"";if(V(s))return s;let d=i?i[o]:"";if(V(d))return d}return""}function Ut(e){return[e?.notes,e?.customer_notes,e?.request_notes,e?.size,e?.size_details,e?.sizeDetails,e?.body,e?.email_body,e?.email_text,e?.request_body,e?.quote_body,e?.summary,e?.summary_text,e?.details,e?.inquiry,e?.message].filter(V).join(`
`)}function Ht(e){if(!V(e))return{};let t=i=>{let r=e.match(i);return r&&r[1]?r[1].trim():""};return{ring:t(/\bring(?:\s*size)?\s*:\s*([^|\n,;]+)/i),wrist:t(/\b(?:wrist|bracelet)(?:\s*size)?\s*:\s*([^|\n,;]+)/i),neck:t(/\b(?:neck|necklace|chain)(?:\s*(?:size|length))?\s*:\s*([^|\n,;]+)/i),earring:t(/\bearrings?(?:\s*(?:style|type|size|preference))?\s*:\s*([^|\n,;]+)/i)}}function Wn(e){let t=jt(e),i=[],r=Ht(Ut(e)),o=ue(e,t,r,["ring_size","ring","ringSize"]),l=ue(e,t,r,["wrist_size","wrist","bracelet_size","bracelet"]),s=ue(e,t,r,["neck_size","neck","chain_size","chain_length","necklace_size","necklace_length"]),d=ue(e,t,r,["earring_style","earring_type","earring","earring_size"]);return V(o)&&i.push(["Ring size",o]),V(l)&&i.push(["Wrist size",l]),V(s)&&i.push(["Neck/chain size",s]),V(d)&&i.push(["Earring style",d]),!i.length&&V(e?.size)&&i.push(["Size",e.size]),i}function Za(e){let t=e?.tags,i=(Array.isArray(t)?t:String(t||"").split(/[|,;\n]/)).map(m=>String(m||"").trim().toLowerCase()).filter(Boolean),r=m=>m.some(_=>i.includes(_)),o=r(["set","sets"]),l=r(["ring","rings","band","bands"]),s=r(["bracelet","bracelets","bangle","bangles","wrist"]),d=r(["pendant","pendants","necklace","necklaces","chain","chains"]);if(i.length){let m=o&&!l&&!s&&!d;return{ring:l||m,bracelet:s||m,chain:d||m}}let c=String(e?.category||e?.categories||"").toLowerCase().replace(/\s+/g," ");return c.includes("set")?{ring:!0,bracelet:!0,chain:!0}:{ring:c.includes("ring")||c.includes("band"),bracelet:c.includes("bracelet")||c.includes("bangle"),chain:c.includes("pendant")||c.includes("necklace")||c.includes("chain")}}let dt=!1;function ei(e){let t=[];return V(e.ring)&&t.push(`Ring size: ${e.ring}`),V(e.bracelet)&&t.push(`Bracelet size: ${e.bracelet}`),V(e.chain)&&t.push(`Chain size: ${e.chain}`),t.join(" | ")}function ct(){if(dt)return;let e=H("size");if(!e)return;let t={ring:a.sizeRing?a.sizeRing.value.trim():"",bracelet:a.sizeBracelet?a.sizeBracelet.value.trim():"",chain:a.sizeChain?a.sizeChain.value.trim():""},i=ei(t);e.value=i,e.dataset.activityValue=i}function ti(e){if(!a.sizeBlock)return;let t=e&&(e.ring||e.bracelet||e.chain);a.sizeBlock.classList.toggle("is-hidden",!t||n.tab!=="quotes");let i=(r,o)=>{if(!r)return;let l=r.closest(".field");l&&l.classList.toggle("is-hidden",!o)};i(a.sizeRing,!!e?.ring),i(a.sizeBracelet,!!e?.bracelet),i(a.sizeChain,!!e?.chain)}async function ai(e){if(n.tab!=="quotes")return;let t=await ta(),i=aa(e,t),r=jt(e),o=Ht(Ut(e));dt=!0;let l=ue(e,r,o,["ring_size","ring","ringSize"]),s=ue(e,r,o,["wrist_size","wrist","bracelet_size","bracelet"]),d=ue(e,r,o,["neck_size","neck","chain_size","chain_length","necklace_size","necklace_length"]),c=Za(i);!c.ring&&!c.bracelet&&!c.chain&&(c={ring:V(l),bracelet:V(s),chain:V(d)}),ti(c),n.sizingSpec=c,a.sizeRing&&(a.sizeRing.value=l),a.sizeBracelet&&(a.sizeBracelet.value=s),a.sizeChain&&(a.sizeChain.value=d),ct(),dt=!1}function ii(e){return"Metal weight (g)"}function ni(e){return"Final Metal weight difference (g)"}function Wt(e){a.metalWeightLabel&&(a.metalWeightLabel.textContent=ii(e)),a.metalWeightAdjustmentLabel&&(a.metalWeightAdjustmentLabel.textContent=ni(e))}function Gt(e){let t=ve(e);return t.includes("platinum")?"Platinum":t.includes("14k")?"14K":t.includes("18k")?"18K":""}function ut(e){let t=String(e||"").trim();if(!t)return"";let i=Number(t);return Number.isNaN(i)?t:i?`${i} week${i===1?"":"s"} delay`:"No delay"}function Ue(e){let t=zt(e);return t?t==="rush"?"Rush":t==="standard"?"Standard":e:""}function ri(e,t){let i=Ue(e)||"Standard",r=Number(String(t||"").trim());return!Number.isNaN(r)&&r>0?`Estimated delivery after payment: ${i} + ${r} week${r===1?"":"s"}.`:`Estimated delivery after payment: ${i}.`}function mt(){return a.editFields.find(e=>e.dataset.field==="diamond_breakdown")}function ft(e){let t=String(e||"").toLowerCase();return t.includes("lab")?"lab":t.includes("natural")?"natural":""}function Ie(){let e=String(v("stone")||"").toLowerCase();return e?e.includes("lab")?"lab":e.includes("natural")||Ee.some(t=>e.includes(t))?"natural":"":""}function Gn(e){return e?String(e).split(/\n|;|,/).map(t=>t.trim()).filter(Boolean).map(t=>{let i=t.match(/([0-9]*\.?[0-9]+)\s*(?:ct)?\s*[xÃ—]\s*([0-9]*\.?[0-9]+)/i);if(i)return{weight:i[1],count:i[2]};let r=t.match(/[0-9]*\.?[0-9]+/g)||[];return r.length>=2?{weight:r[0],count:r[1]}:r.length===1?{weight:r[0],count:"1"}:null}).filter(Boolean):[]}function Vn(e){return e.map(t=>{let i=String(t.weight||"").trim(),r=String(t.count||"").trim();return!i||!r?"":`${i} x ${r}`}).filter(Boolean).join(`
`)}function oi(e){return e?String(e).split(/\n|;|,/).map(t=>t.trim()).filter(Boolean).map(t=>{let i="",r=t,o=t.match(/^(lab(?:\s+grown)?|natural)(?:\s+diamond)?\s*[:=-]\s*(.+)$/i);o&&(i=ft(o[1]),r=o[2]);let l=r.match(/([0-9]*\.?[0-9]+)\s*(?:ct)?\s*[xA-]\s*([0-9]*\.?[0-9]+)/i);if(l)return{weight:l[1],count:l[2],stoneType:i};let s=r.match(/[0-9]*\.?[0-9]+/g)||[];return s.length>=2?{weight:s[0],count:s[1],stoneType:i}:s.length===1?{weight:s[0],count:"1",stoneType:i}:null}).filter(Boolean):[]}function li(e){return e.map(t=>{let i=String(t.weight||"").trim(),r=String(t.count||"").trim();if(!i||!r)return"";let o=t.stoneType==="lab"?"Lab":t.stoneType==="natural"?"Natural":"";return`${o?`${o}: `:""}${i} x ${r}`}).filter(Boolean).join(`
`)}function me(){return a.diamondBreakdownRows?Array.from(a.diamondBreakdownRows.querySelectorAll("[data-diamond-row]")).map(e=>{let t=e.querySelector("[data-diamond-weight]")?.value?.trim()||"",i=e.querySelector("[data-diamond-count]")?.value?.trim()||"",r=e.querySelector("[data-diamond-type]")?.value?.trim()||"";return{weight:t,count:i,stoneType:r}}):[]}function He(){if(Be)return;let e=mt();if(!e)return;let t=Ie(),i=me().map(r=>({...r,stoneType:r.stoneType||t}));Be=!0,e.value=li(i),Be=!1}function We(e){if(!a.diamondBreakdownRows)return;if(!e.length){a.diamondBreakdownRows.innerHTML='<p class="muted">No diamond pieces yet. Add a row to begin.</p>',$e([]);return}let t=Ie();a.diamondBreakdownRows.innerHTML=e.map((i,r)=>{let o=String(i.weight||"").trim(),l=String(i.count||"").trim(),s=Number(o||0)*Number(l||0),d=pt(s),c=ft(i.stoneType)||t;return`
          <div class="diamond-row" data-diamond-row data-row-index="${r}">
            <label>
              <span>ct</span>
              <input type="text" data-diamond-weight placeholder="0.10" value="${C(o)}" />
            </label>
            <label>
              <span>count</span>
              <input type="text" data-diamond-count placeholder="1" value="${C(l)}" />
            </label>
            <label>
              <span>Type</span>
              <select data-diamond-type>
                <option value="">Auto</option>
                <option value="natural" ${c==="natural"?"selected":""}>Natural</option>
                <option value="lab" ${c==="lab"?"selected":""}>Lab</option>
              </select>
            </label>
            <div class="diamond-total">
              <span>Total ct</span>
              <strong data-diamond-row-total>${d}</strong>
            </div>
            <button class="btn btn-ghost" type="button" data-diamond-remove>Remove</button>
          </div>`}).join(""),$e(e)}function pt(e){return Number.isFinite(e)?`${e%1===0?e.toFixed(0):e.toFixed(2).replace(/\.?0+$/,"")} ct`:"--"}function si(){if(n.tab!=="quotes")return[];let e=me();if(!e.length)return[];let t=Ie(),i=new Map;return e.forEach(r=>{let o=String(r.weight||"").trim(),l=String(r.count||"").trim();if(!o||!l)return;let s=ft(r.stoneType)||t;if(!s)return;let d=s,c=i.get(d)||[];c.push(`${o} x ${l}`),i.set(d,c)}),Array.from(i.entries()).map(([r,o])=>({stone_type:r,diamond_breakdown:o.join(`
`)}))}function $e(e){if(!a.diamondPieceCount||!a.diamondCaratTotal)return;let t=e.reduce((o,l)=>o+(Number(l.count)||0),0),i=e.reduce((o,l)=>o+(Number(l.weight)||0)*(Number(l.count)||0),0);a.diamondPieceCount.textContent=t,a.diamondCaratTotal.textContent=pt(i);let r=v("stone").toLowerCase();if(Ee.some(o=>r.includes(o))){let o=H("stone_weight");if(o){let l=i&&Number.isFinite(i)?i%1===0?i.toFixed(0):i.toFixed(2).replace(/\.?0+$/,""):"";o.value=l,o.dataset.activityValue=l,n.selectedItem&&(n.selectedItem.stone_weight=l,ce(n.selectedItem))}}}function Vt(){a.diamondBreakdownRows&&Array.from(a.diamondBreakdownRows.querySelectorAll("[data-diamond-row]")).forEach(e=>{let t=Number(e.querySelector("[data-diamond-weight]")?.value||0),i=Number(e.querySelector("[data-diamond-count]")?.value||0),r=t*i,o=e.querySelector("[data-diamond-row-total]");o&&(o.textContent=pt(r))})}function di(e){if(!e)return;let t=e.match(/([0-9]*\.?[0-9]+)x([0-9]+)/i);if(!t)return;let i=Ie(),r=me();r.push({weight:t[1],count:t[2],stoneType:i}),We(r),He(),a.diamondPresets&&(a.diamondPresets.value="")}function Jt(){let e=mt();if(!e)return;let t=oi(e.value);We(t)}function Kt(){if(!a.diamondBreakdown)return;let e=v("stone").toLowerCase(),t=Ee.some(r=>e.includes(r)),i=n.tab==="quotes"&&t;a.diamondBreakdown.classList.toggle("is-hidden",!i)}function H(e){return a.editFields.find(t=>t.dataset.field===e)}function ci(e){e&&(e.dataset.auto="false",e.dataset.manual="true")}function ui(e){return!(!e||e.dataset.manual==="true"&&e.value)}function mi(){n.tab==="quotes"&&g.forEach(e=>{let t=H(e.price);t&&(t.dataset.auto="true",t.dataset.manual="")})}function fi(){n.tab==="quotes"&&(g.forEach((e,t)=>{let i=H(e.price);i&&i.value.trim()?W(t,"priced"):W(t,"idle")}),pi(),Xt())}function pi(){if(n.tab==="quotes"&&(g.forEach((e,t)=>{let i=v(e.clarity),r=v(e.color),o=v(e.price);Qt(t,!!(i||r||o||t===0))}),n.recommendedOptionIndex===null)){let e=g.findIndex((t,i)=>_e(i));n.recommendedOptionIndex=e>=0?e:null,yt()}}function gi(e){return he.map(t=>t==="diamond_breakdown_components"?`${t}:${JSON.stringify(e[t]||[])}`:`${t}:${String(e[t]??"")}`).join("|")}function gt(){if(n.tab!=="quotes")return null;ct();let e=si();return{metal:v("metal")||"",metal_weight:v("metal_weight")||"",stone:v("stone")||"",stone_weight:v("stone_weight")||"",diamond_breakdown:v("diamond_breakdown")||"",diamond_breakdown_components:e,timeline:v("timeline")||"",timeline_adjustment_weeks:v("timeline_adjustment_weeks")||"",quote_discount_type:v("quote_discount_type")||"",quote_discount_percent:v("quote_discount_percent")||"",size:v("size")||"",size_label:"",size_ring:a.sizeRing?a.sizeRing.value.trim():"",size_bracelet:a.sizeBracelet?a.sizeBracelet.value.trim():"",size_chain:a.sizeChain?a.sizeChain.value.trim():""}}function yi(e,t){let i=g[e];if(!i)return null;let r=v(i.clarity)||"",o=v(i.color)||"";return{...t,clarity:r,color:o}}function fe(e){let t=g[e];return t?H(t.price):null}function W(e,t,i=""){let r=le.options[e];if(!r)return;r.status=t,r.lastError=t==="error"?i:"",t==="priced"&&(r.lastPricedAt=new Date().toISOString());let o=a.quoteOptionCards[e],l=a.quoteOptionStatuses[e];if(o&&(o.classList.toggle("is-pricing",t==="pricing"),o.classList.toggle("is-stale",t==="stale"),o.classList.toggle("is-error",t==="error"),o.classList.toggle("is-manual",t==="manual"),o.classList.toggle("is-inactive",!_e(e))),l){let s=t==="pricing"?"Pricing...":t==="stale"?"Stale":t==="error"?"Error":t==="manual"?"Manual":t==="priced"?"Priced":"Idle";l.textContent=i?`${s} \xB7 ${i}`:s}Na(),ce(n.selectedItem)}function hi(e){e!=null&&W(e,"manual")}function bi(){let e=le.options.map(i=>i.lastPricedAt).filter(Boolean);if(!e.length)return"--";let t=e.sort().slice(-1)[0];return Ia(t)}function _e(e){let t=a.optionActiveToggles[e];return t?t.checked:!0}function Qt(e,t){let i=a.optionActiveToggles[e];i&&(i.checked=t);let r=g[e];if(!r)return;[r.clarity,r.color,r.price].forEach(c=>{let m=H(c);m&&(m.disabled=!t)});let o=a.optionRecommendRadios[e];o&&(o.disabled=!t);let l=a.optionCopyButtons[e];l&&(l.disabled=!t);let s=a.optionAutoButtons[e];s&&(s.disabled=!t);let d=a.quoteOptionCards[e];d&&d.classList.toggle("is-inactive",!t),!t&&n.recommendedOptionIndex===e&&(n.recommendedOptionIndex=null,yt()),t||W(e,"idle","Inactive"),ae()}function yt(){a.optionRecommendRadios.forEach((e,t)=>{e.checked=n.recommendedOptionIndex===t}),n.selectedItem&&ce(n.selectedItem)}function ht(e){let t=a.optionFinals[e];if(!t)return;let i=fe(e),r=Number(i?.value||"");if(!r||Number.isNaN(r)){t.textContent="Final: --";return}let o=ve(v("quote_discount_type")),l=Number(v("quote_discount_percent"))||0,s=o==="custom"&&l>0?Math.max(0,r*(1-l/100)):r;t.textContent=`Final: ${se(s)||"--"}`}function Xt(){g.forEach((e,t)=>ht(t))}function Yt(e,t){let i=fe(e);if(!(!i||!ui(i))){if(i.value=t,i.dataset.auto="true",i.dataset.manual="",n.selectedItem){let r=g[e].price;n.selectedItem[r]=t,ce(n.selectedItem)}Oe(),ht(e)}}function Zt(e,t){let i=g[e];if(!i||!_e(e))return!1;let r=fe(e);if(r&&r.dataset.manual==="true"&&r.value.trim())return!1;let o=v(i.clarity),l=v(i.color),s=_t();return!!(o||l||s&&e===0)}function bt(e){let t=[];if(!e)return t;e.metal||t.push(J("Metal missing",'[data-field="metal"]')),e.metal_weight||t.push(J("Metal weight missing",'[data-field="metal_weight"]')),e.timeline||t.push(J("Timeline missing",'[data-field="timeline"]'));let i=String(e.stone||"").toLowerCase(),r=Ee.some(s=>i.includes(s)),o=Array.isArray(e.diamond_breakdown_components)?e.diamond_breakdown_components:[];i&&(r&&!e.diamond_breakdown&&o.length===0&&t.push(J("Diamond breakdown missing",'[data-field="diamond_breakdown"]')),!r&&!e.stone_weight&&t.push(J("Stone weight missing",'[data-field="stone_weight"]')));let l=n.sizingSpec||{};return l.ring&&!e.size_ring&&t.push(J("Ring size missing","[data-size-ring] input")),l.bracelet&&!e.size_bracelet&&t.push(J("Bracelet size missing","[data-size-bracelet] input")),l.chain&&!e.size_chain&&t.push(J("Chain size missing","[data-size-chain] input")),_t()||g.forEach((s,d)=>{if(!_e(d))return;let c=v(s.clarity),m=v(s.color);c||t.push(J(`Option ${d+1} clarity missing`,`[data-field="${s.clarity}"]`)),m||t.push(J(`Option ${d+1} color missing`,`[data-field="${s.color}"]`))}),t}async function Si(e,t){if(!g[e]||!t)return;let i=gi(t),r=le.cache.get(i);if(r){Yt(e,r.price),W(e,"priced");return}let o=le.inflight.get(e);if(o&&o.signature===i)return o.promise;W(e,"pricing");let l=ea(),s=fetch(`${l}/pricing/estimate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(d=>d.json().catch(()=>({})).then(c=>({response:d,data:c}))).then(({response:d,data:c})=>{if(!d.ok||!c?.ok){W(e,"error");return}let m=String(c.price??"");le.cache.set(i,{price:m}),Yt(e,m),W(e,"priced")}).catch(()=>{W(e,"error")}).finally(()=>{le.inflight.delete(e),R(),ae()});return le.inflight.set(e,{promise:s,signature:i}),s}async function wi(e){if(n.tab!=="quotes")return;let t=gt();if(!t)return;if(g.forEach((r,o)=>{if(Zt(o,t))return;let l=fe(o);l&&l.dataset.manual==="true"&&l.value.trim()?W(o,"manual"):l&&l.value.trim()?W(o,"priced"):W(o,"idle")}),bt(t).length){R(),ae();return}let i=(e&&e.length?e:[]).filter(r=>Zt(r,t));if(!i.length){R(),ae();return}await Promise.all(i.map(r=>{let o=yi(r,t);return Si(r,o)}))}function Q({baseChanged:e=!1,optionIndex:t=null}={}){n.tab==="quotes"&&(e?g.forEach((i,r)=>{Ne.add(r)}):typeof t=="number"&&Ne.add(t),Ne.forEach(i=>{let r=fe(i),o=r&&r.dataset.manual==="true"&&r.value.trim();if(!_e(i)){W(i,"idle");return}if(o){W(i,"manual");return}W(i,"stale")}),ot&&clearTimeout(ot),ot=setTimeout(()=>{let i=Array.from(Ne);Ne.clear(),wi(i)},500))}function ea(){return Fe().replace(/\/admin\/?$/,"")}function vi(e){if(!e)return"";try{let t=new URL(e,"https://www.heerawalla.com").pathname.split("/").filter(Boolean),i=t[t.length-1]||"";return i.toLowerCase()==="bespoke"&&t.length>1?t[t.length-2]||"":i}catch{return""}}function _i(e){if(!e)return"";try{let t=new URL(e,"https://www.heerawalla.com").pathname.split("/").filter(Boolean);return t.includes("inspirations")?"inspirations":t.includes("product")||t.includes("products")?"products":""}catch{return""}}async function ta(){if(te.data)return te.data;if(te.promise)return te.promise;let e=`${ea()}/catalog?include=products,inspirations`;return te.promise=fetch(e).then(t=>t.json()).then(t=>(te.data=t||{},te.data)).catch(()=>(te.data={},te.data)).finally(()=>{te.promise=null}),te.promise}function ki(e){return String(e||"uncategorized").split("/").map(t=>t.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"")||"uncategorized").filter(Boolean).join("/")}function qi(e){let t=ki(e.category||"uncategorized"),i=`/images/products/${t}/${e.id}`,r=["img-hero-1.png","img-hero-1.jpeg","img-hero-1.jpg","img-hero-2.png","img-hero-2.jpeg","img-hero-2.jpg","img-hero-03.jpeg","img-1.png","img-1.jpeg","img-1.jpg","image-1.svg"].map(o=>`${i}/${o}`);return r.push(`/images/products/${t}/image-1.svg`),r.push("/images/products/placeholder.svg"),r}function Ci(e){if(!e)return[we("/images/products/placeholder.svg")].filter(Boolean);let t=[];return e.hero_image&&t.push(e.hero_image),e.heroImage&&t.push(e.heroImage),Array.isArray(e.images)&&e.images.forEach(i=>t.push(i)),!t.length&&e.id&&e.category&&(t=qi(e)),t.length||(t=["/images/products/placeholder.svg"]),Array.from(new Set(t.map(we).filter(Boolean)))}function aa(e,t){if(!t)return null;let i=e.product_url||"",r=vi(i),o=_i(i),l=e.design_code||"",s=e.product_name||"",d=Array.isArray(t.inspirations)?t.inspirations:[],c=Array.isArray(t.products)?t.products:[],m=$=>l&&($.design_code||$.designCode||"").toLowerCase()===l.toLowerCase(),_=$=>s&&String($.name||$.title||"").toLowerCase()===s.toLowerCase(),x=$=>r&&String($.slug||"").toLowerCase()===r.toLowerCase();return o==="inspirations"?d.find(x)||d.find(m)||d.find(_)||null:o==="products"?c.find(x)||c.find(m)||c.find(_)||null:d.find(x)||c.find(x)||d.find(m)||c.find(m)||d.find(_)||c.find(_)||null}function ia(e){if(!e.length)return'<div class="media-empty muted">No images available.</div>';let t=C(we("/images/products/placeholder.svg"));return e.length===1?`<div class="media-frame"><img src="${C(e[0])}" alt="" loading="lazy" onerror="this.onerror=null;this.src='${t}';"></div>`:`
      <div class="media-carousel" data-media-carousel>
        <button class="carousel-btn" type="button" data-carousel-prev aria-label="Previous image">\u2039</button>
        <div class="media-track" data-carousel-track>${e.map(i=>`<div class="media-slide"><img src="${C(i)}" alt="" loading="lazy" onerror="this.onerror=null;this.src='${t}';"></div>`).join("")}</div>
        <button class="carousel-btn" type="button" data-carousel-next aria-label="Next image">\u203A</button>
      </div>`}function Jn(){return'<div class="media-slot" data-media-slot><span class="muted">Loading images...</span></div>'}async function Li(e){if(n.tab!=="quotes"&&n.tab!=="orders"||!a.detailGrid)return;let t=a.detailGrid.querySelector("[data-media-slot]");if(!t)return;let i=e.design_code||e.product_url||e.product_name||"";if(i&&lt.has(i)){t.innerHTML=ia(lt.get(i));return}let r=await ta(),o=aa(e,r),l=Ci(o);i&&lt.set(i,l),t.innerHTML=ia(l)}function u(e,t){a.toast&&(a.toast.textContent=e,a.toast.classList.add("is-visible"),t==="error"?a.toast.style.background="#b42318":a.toast.style.background="var(--ink)",setTimeout(()=>a.toast.classList.remove("is-visible"),2400))}function ke(e){a.syncLine&&(a.syncLine.textContent=e)}function qe(e){if(!e)return"";let t=new Date(e);return Number.isNaN(t.getTime())?String(e):t.toLocaleString()}function se(e){if(e==null||e==="")return"";let t=Number(String(e).replace(/[^0-9.]/g,""));return Number.isNaN(t)?String(e):t.toLocaleString("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0})}function Ge(e){let t=String(e||"").replace(/\D/g,"");return t?t.length===10?`(${t.slice(0,3)}) ${t.slice(3,6)}-${t.slice(6)}`:t.length===11&&t.startsWith("1")?`+1 (${t.slice(1,4)}) ${t.slice(4,7)}-${t.slice(7)}`:t.length>11?`+${t}`:t:"--"}function Ei(e){return e!=null&&e!==""}async function w(e,t={}){let i=Fe();if(!i)throw new Error("Missing API base");let r=i.endsWith("/")?i:`${i}/`,o=new URL(e.replace(/^\//,""),r),l=xe(r)?Ot():"";Mt(o,r,l);let s=Ja(t.headers||{},l),d=await fetch(o.toString(),{credentials:xe(r)?"omit":"include",headers:s,...t});if(!d.ok){let c=await d.text();throw new Error(c||d.statusText)}return await d.json()}function na(e){return e==="orders"?"/orders":e==="quotes"?"/quotes":e==="tickets"?"/tickets":e==="contacts"?"/contacts":e==="products"?"/products":e==="inspirations"?"/inspirations":e==="media-library"?"/media-library":e==="price-chart"?"/price-chart":e==="cost-chart"?"/cost-chart":e==="diamond-price-chart"?"/diamond-price-chart":`/${e}`}function Ve(){return n.tab==="orders"?"/orders/action":n.tab==="quotes"?"/quotes/action":n.tab==="tickets"?"/tickets/action":n.tab==="contacts"?"/contacts/action":n.tab==="products"?"/products/action":n.tab==="inspirations"?"/inspirations/action":n.tab==="media-library"?"/media-library/action":n.tab==="price-chart"?"/price-chart/action":n.tab==="cost-chart"?"/cost-chart/action":n.tab==="diamond-price-chart"?"/diamond-price-chart/action":""}function Je(){return n.selectedItem&&(n.selectedItem.request_id||n.selectedItem.email||n.selectedItem.row_number||n.selectedItem.slug||n.selectedItem.id||n.selectedItem.media_id)||""}function St(){if(I.has(n.tab)){a.editSection&&a.editSection.classList.add("is-hidden");return}let e=new Set(M[n.tab]);a.editFields.forEach(t=>{let i=t.closest(".field"),r=t.dataset.field||"",o=e.has(r);i&&i.classList.toggle("is-hidden",!o)}),a.editSection&&a.editSection.classList.toggle("is-hidden",e.size===0),wa()}function ra(){let e=I.has(n.tab);if(a.catalogSection&&a.catalogSection.classList.toggle("is-hidden",!e),e){let t=a.catalogTabs.find(i=>i.classList.contains("is-active"))?.dataset.catalogTab||h;oa(t)}else a.catalogPanels.forEach(t=>t.classList.add("is-hidden"));a.missingPanel&&a.missingPanel.classList.toggle("is-hidden",!1),a.activityFeed&&a.activityFeed.closest(".drawer-section")?.classList.toggle("is-hidden",e),a.orderDetailsSection&&a.orderDetailsSection.classList.toggle("is-hidden",e),a.sizeBlock&&a.sizeBlock.classList.toggle("is-hidden",e),a.summaryCard&&a.summaryCard.classList.toggle("is-hidden",e),a.detailAside&&a.detailAside.classList.toggle("is-hidden",e),a.nextActionPanel&&a.nextActionPanel.classList.toggle("is-hidden",e)}function oa(e){if(!a.catalogTabs.length||!a.catalogPanels.length)return;let t=e||h;a.catalogTabs.forEach(i=>{i.classList.toggle("is-active",i.dataset.catalogTab===t)}),a.catalogPanels.forEach(i=>{let r=i.dataset.catalogPanel||"";i.classList.toggle("is-hidden",r!==t)})}function la(e,t){if(!a.catalogFields&&!a.catalogFieldsBasic)return;if(n.tab==="media-library"){let F=(Array.isArray(n.catalogHeaders)&&n.catalogHeaders.length?n.catalogHeaders:Object.keys(e||{})).map(O=>String(O||"").trim()).filter(O=>O&&O!=="row_number"),K=new Set(["description","label","alt","url"]);a.catalogFields.innerHTML=F.map(O=>{let at=e?.[O]??"",it=O.replace(/_/g," "),xt=K.has(O),Fa=O==="created_at";return xt?`
              <label class="field full-span">
                <span>${N(it)}</span>
                <textarea rows="2" data-field="${C(O)}" ${Fa?'data-readonly="true" disabled':""}>${N(String(at||""))}</textarea>
              </label>
            `:`
            <label class="field">
              <span>${N(it)}</span>
              <input type="text" data-field="${C(O)}" value="${C(String(at||""))}" ${Fa?'data-readonly="true" disabled':""} />
            </label>
          `}).join("");return}if(!window.CatalogForm)return;let i=window.CatalogForm,r=t||{};Object.entries({categories:["RING","PENDANT","BRACELET","BAND","NECKLACE","BANGLE"],styles:["Bold","Subtle","Minimalist","Contemporary","Traditional","Vintage","Modern","Classic","Art Deco","Bohemian","Romantic"],motifs:["Gift","Wedding","Engagement","Anniversary","Birthday","Promise","Eternal Love","Family","Celebration"],tags:["RING","PENDANT","BRACELET","BAND","NECKLACE","BANGLE"]}).forEach(([F,K])=>{r[F]=K.map(O=>({value:O}))});let o=e||{},l=new Set([]),s=o.is_active===void 0||o.is_active===null?n.isNewRow:!!o.is_active,d=!!o.is_featured,c=[i.renderTextInput({label:"ID",field:"id",value:o.id||"",readOnly:!n.isNewRow}),i.renderTextInput({label:"Name",field:"name",value:o.name||""}),i.renderTextInput({label:"Slug",field:"slug",value:o.slug||"",helperHtml:'<button class="btn btn-ghost btn-small" type="button" data-slug-generate>Generate</button>'}),i.renderEnumSelect({label:"Design code",field:"design_code",value:o.design_code||"",options:r.design_codes,includeEmpty:!0,placeholder:"Select"}),i.renderToggle({label:"Active",field:"is_active",value:s}),i.renderToggle({label:"Featured",field:"is_featured",value:d})],m=[i.renderEnumSelect({label:"Gender",field:"gender",value:o.gender||"",options:r.genders,includeEmpty:!0,placeholder:"Select"}),i.renderMultiSelectChips({label:"Categories",field:"categories",values:o.categories||[],enumKey:"categories",allowCustom:l.has("categories"),placeholder:"Add category",fullSpan:!0}),i.renderMultiSelectChips({label:"Styles",field:"styles",values:o.styles||[],enumKey:"styles",allowCustom:l.has("styles"),placeholder:"Add style",fullSpan:!0}),i.renderMultiSelectChips({label:"Motifs",field:"motifs",values:o.motifs||[],enumKey:"motifs",allowCustom:l.has("motifs"),placeholder:"Add motif",fullSpan:!0}),i.renderMultiSelectChips({label:"Tags",field:"tags",values:o.tags||[],enumKey:"tags",allowCustom:l.has("tags"),placeholder:"Add tag",fullSpan:!0})],_=[i.renderMultiSelectChips({label:"Metals",field:"metals",values:o.metals||[],enumKey:"metals",allowCustom:!1,placeholder:"Add metal",fullSpan:!0}),i.renderMultiSelectChips({label:"Stone types",field:"stone_types",values:o.stone_types||[],enumKey:"stone_types",allowCustom:!1,placeholder:"Add stone type",fullSpan:!0}),i.renderMultiSelectChips({label:"Cut",field:"cut",values:o.cut||[],enumKey:"cuts",allowCustom:!1,placeholder:"Add cut",fullSpan:!0}),i.renderMultiSelectChips({label:"Clarity",field:"clarity",values:o.clarity||[],enumKey:"clarities",allowCustom:!1,placeholder:"Add clarity",fullSpan:!0}),i.renderMultiSelectChips({label:"Color",field:"color",values:o.color||[],enumKey:"colors",allowCustom:!1,placeholder:"Add color",fullSpan:!0})],x=[i.renderTextInput({label:"Created at",field:"created_at",value:o.created_at||"",readOnly:!0}),i.renderTextInput({label:"Updated at",field:"updated_at",value:o.updated_at||"",readOnly:!0}),i.renderTextInput({label:"Updated by",field:"updated_by",value:o.updated_by||"",readOnly:!0})];a.catalogFieldsBasic&&(a.catalogFieldsBasic.innerHTML=c.join("")),a.catalogFieldsTaxonomy&&(a.catalogFieldsTaxonomy.innerHTML=m.join("")),a.catalogFieldsMaterials&&(a.catalogFieldsMaterials.innerHTML=_.join("")),a.catalogFieldsAudit&&(a.catalogFieldsAudit.innerHTML=x.join("")),a.catalogFields&&!a.catalogFieldsBasic&&(a.catalogFields.innerHTML=[...c,...m,..._,...x].join(""));let $=()=>{oe(),R(),ae()};[a.catalogFieldsBasic,a.catalogFieldsTaxonomy,a.catalogFieldsMaterials,a.catalogFieldsAudit,a.catalogFields].filter(Boolean).forEach(F=>{i.init(F,r,$)});let G=document.querySelector("[data-slug-generate]");G&&G.addEventListener("click",()=>{let F=a.catalogFieldsBasic||a.catalogFields;if(!F)return;let K=F.querySelector('[data-field="name"]'),O=F.querySelector('[data-field="slug"]');!K||!O||!window.CatalogUtils||(O.value=window.CatalogUtils.normalizeSlug(K.value||""),O.dispatchEvent(new Event("input",{bubbles:!0})))}),document.querySelectorAll("[data-char-count]").forEach(F=>{let K=F.closest(".field")?.querySelector("[data-char-counter]");if(!K)return;let O=()=>{K.textContent=String(F.value.length||0)};O(),F.addEventListener("input",O)})}function Ai(){return a.catalogFields?a.catalogFields.querySelector('[data-field="description"]'):null}function Ni(e){if(!a.mediaDetailSection)return;let t=n.tab==="media-library";if(a.mediaDetailSection.classList.toggle("is-hidden",!t),!t)return;let i=String(e?.media_id||e?.id||e?.row_number||""),r=String(e?.media_type||"image").trim()||"image",o=e?.url||e?.media_url||"",l=we(o);a.mediaDetailId&&(a.mediaDetailId.textContent=i||"--"),a.mediaDetailType&&(a.mediaDetailType.textContent=r||"--"),a.mediaDetailUrl&&(l?(a.mediaDetailUrl.href=l,a.mediaDetailUrl.textContent="Open file"):(a.mediaDetailUrl.href="#",a.mediaDetailUrl.textContent="No file")),a.mediaDetailPreview&&(l?r.toLowerCase().includes("video")?a.mediaDetailPreview.innerHTML=`<video controls src="${C(l)}"></video>`:a.mediaDetailPreview.innerHTML=`<img src="${C(l)}" alt="" loading="lazy" />`:a.mediaDetailPreview.innerHTML='<span class="muted">No preview available.</span>')}async function Ce(e){if(!a.catalogMediaList)return;if(!ne.has(n.tab)){a.catalogMediaList.innerHTML="";return}let t=e?.slug||"";if(!t){n.catalogMediaState={items:[]},n.mediaLibraryItems=[],wt([]),a.catalogMediaList.innerHTML='<div class="muted">Save this record before linking media.</div>';return}let i=n.tab==="products"?"/product-media":"/inspiration-media",r=n.tab==="products"?"product_slug":"inspiration_slug";try{let[o,l]=await Promise.all([w("/media-library?limit=500&offset=0"),w(`${i}?${r}=${encodeURIComponent(t)}&limit=500&offset=0`)]);n.catalogMediaState={items:l.items||[]},n.mediaLibraryItems=Array.isArray(o.items)?o.items:[],wt(n.mediaLibraryItems);let s=new Map((o.items||[]).map(c=>[c.media_id,c])),d=(l.items||[]).slice().sort((c,m)=>{let _=Number(c.sort_order||c.order||0),x=Number(m.sort_order||m.order||0);if(_!=x)return _-x;let $=Number(c.id||0),G=Number(m.id||0);return $-G}).map(c=>{let m=s.get(c.media_id)||{},_=we(m.url||""),x=String(m.media_type||"").toLowerCase().startsWith("video")?`<video src="${C(_)}" controls></video>`:`<img src="${C(_)}" alt="">`,$=c.position||"",G=String(c.sort_order||c.order||""),F=G||"--",K=String(c.is_primary||"")==="1"?"Yes":"No",O=String(c.position||"").toLowerCase()==="hero",at=O?'<span class="media-hero-badge">Hero</span>':"",it=String(m.label||""),xt=Te((n.catalogEnums||{}).media_positions||[],$,!0,"Select");return`
          <div class="catalog-media-item" data-position="${C($)}" data-media-id="${C(c.media_id||"")}">
            ${x}
            <div class="catalog-media-header">
              <div class="catalog-media-meta">${N(c.media_id||"--")}</div>
              <details class="catalog-media-info">
                <summary aria-label="Media details">i</summary>
                <div class="catalog-media-info-content">
                  <div class="catalog-media-meta">${N(m.label||m.description||"")}</div>
                  <div class="catalog-media-meta">Position: ${N($||"--")} \xB7 Order: ${N(F)} \xB7 Primary: ${N(K)} ${at}</div>
                </div>
              </details>
            </div>
            <div class="catalog-media-controls">
              <div class="media-control-row">
                <label class="field field-inline">
                  <span>Order</span>
                  <input type="number" data-media-order value="${C(G)}" />
                </label>
                <label class="field field-inline">
                  <span>Position</span>
                  <select data-media-position>${xt}</select>
                </label>
                <label class="field field-inline">
                  <span>Hero</span>
                  <input type="checkbox" data-media-hero-toggle ${O?"checked":""} />
                </label>
              </div>
              <div class="media-control-row">
                <label class="field field-inline media-label-field">
                  <span>Label</span>
                  <input type="text" data-media-label value="${C(it)}" />
                </label>
                <label class="field field-inline media-description-field">
                  <span>Description</span>
                  <textarea rows="2" data-media-description>${C(c.description||"")}</textarea>
                </label>
              </div>
              <div class="media-control-row media-control-actions">
                <button class="btn btn-ghost btn-small" type="button" data-media-save data-mapping-id="${C(c.id||c.row_number||"")}">Save</button>
                <button class="btn btn-ghost btn-small" type="button" data-media-delete data-mapping-id="${C(c.id||c.row_number||"")}">Delete</button>
                <button class="btn btn-ghost btn-small" type="button" data-media-describe data-media-id="${C(c.media_id||"")}">Generate description</button>
              </div>
            </div>
          </div>
        `});a.catalogMediaList.innerHTML=d.length?d.join(""):'<div class="muted">No media linked yet.</div>'}catch{n.catalogMediaState={items:[]},n.mediaLibraryItems=[],wt([]),a.catalogMediaList.innerHTML='<div class="muted">Unable to load media.</div>'}}function wt(e){if(!a.mediaId)return;let t=a.mediaId.value||"",i=['<option value="">Select</option>'];(e||[]).slice().sort((r,o)=>String(r.media_id||"").localeCompare(String(o.media_id||""))).forEach(r=>{let o=String(r.media_id||"").trim();o&&i.push(`<option value="${C(o)}">${N(o)}</option>`)}),a.mediaId.innerHTML=i.join(""),t&&(a.mediaId.value=t),sa(a.mediaId.value||"")}function sa(e){if(!a.mediaPreview)return;let t=(Array.isArray(n.mediaLibraryItems)?n.mediaLibraryItems:[]).find(o=>String(o.media_id||"")===String(e||""));if(!t||!e){a.mediaPreview.innerHTML='<span class="muted">Select a media item to preview.</span>';return}let i=we(t.url||"");if(!i){a.mediaPreview.innerHTML='<span class="muted">No URL available for this media.</span>';return}let r=String(t.media_type||"").toLowerCase().startsWith("video");a.mediaPreview.innerHTML=r?`<video src="${C(i)}" controls></video>`:`<img src="${C(i)}" alt="${C(t.alt||t.label||"")}">`}function da(e){let t=e?.stone_roles;return Array.isArray(t)&&t.length?t:Wa}function ca(e){let t=e?.stone_size_types;return Array.isArray(t)&&t.length?t:$t}function ua(e){let t=e?.metal_size_types;return Array.isArray(t)&&t.length?t:$t}function ma(e){let t=e?.stone_shapes;return Array.isArray(t)&&t.length?t:Ga}function Te(e,t,i,r){let o=String(t||""),l=[];return i&&l.push(`<option value="">${N(r||"Select")}</option>`),(e||[]).forEach(s=>{let d=String(s.value||""),c=String(s.label||s.value||""),m=o&&d.toLowerCase()===o.toLowerCase();l.push(`<option value="${C(d)}"${m?" selected":""}>${N(c)}</option>`)}),l.join("")}function xi(e,t){let i=da(t),r=ca(t),o=ma(t),l=String(e.is_primary||e.isPrimary||"")==="1"||e.is_primary===!0;return`
      <div class="catalog-stone-row" data-stone-option-id="${C(e.id||"")}">
        <div class="catalog-stone-grid">
          <label class="field">
            <span>Role</span>
            <select data-stone-field="role">
              ${Te(i,e.role,!0,"Select")}
            </select>
          </label>
          <label class="field">
            <span>Carat</span>
            <input type="number" step="0.01" min="0" data-stone-field="carat" value="${C(e.carat??"")}">
          </label>
          <label class="field">
            <span>Count</span>
            <input type="number" step="1" min="0" data-stone-field="count" value="${C(e.count??"")}">
          </label>
          <label class="field">
            <span>Size type</span>
            <select data-stone-field="size_type">
              ${Te(r,e.size_type,!0,"Select")}
            </select>
          </label>
          <label class="field">
            <span>Shape</span>
            <select data-stone-field="shape">
              ${Te(o,e.shape,!0,"Select")}
            </select>
          </label>
          <label class="field">
            <span>Primary</span>
            <select data-stone-field="is_primary">
              <option value="" ${l?"":"selected"}>No</option>
              <option value="1" ${l?"selected":""}>Yes</option>
            </select>
          </label>
        </div>
        <div class="catalog-stone-actions">
          <button class="btn btn-ghost btn-small" type="button" data-stone-save>Save</button>
          <button class="btn btn-ghost btn-small" type="button" data-stone-delete>Delete</button>
        </div>
      </div>
    `}function Ii(e){if(!Array.isArray(e))return[];let t=["xsmall","small","medium","large","xlarge","xxlarge"],i=new Map(t.map((r,o)=>[r,o]));return[...e].sort((r,o)=>{let l=String(r.size_type||"").toLowerCase(),s=String(o.size_type||"").toLowerCase(),d=i.has(l)?i.get(l):t.length+1,c=i.has(s)?i.get(s):t.length+1;if(d!==c)return d-c;let m=String(r.role||""),_=String(o.role||"");if(m!==_)return m.localeCompare(_);let x=Number(r.carat||0),$=Number(o.carat||0);return!Number.isNaN(x)&&!Number.isNaN($)&&x!==$?x-$:String(r.id||"").localeCompare(String(o.id||""))})}function $i(e){let t=Ii(e),i=new Map;return t.forEach(r=>{let o=String(r.size_type||"unspecified").toLowerCase()||"unspecified";i.has(o)||i.set(o,[]),i.get(o).push(r)}),Array.from(i.entries())}function Ti(e){let t=i=>{let r=e.querySelector(`[data-stone-field="${i}"]`);return r?r.value.trim():""};return{role:t("role"),carat:t("carat"),count:t("count"),size_type:t("size_type"),shape:t("shape"),is_primary:t("is_primary")}}async function Ke(e){if(!a.catalogStoneList)return;if(!ne.has(n.tab)){a.catalogStoneList.innerHTML="";return}let t=e?.id||"";if(!t){n.catalogStoneOptions={items:[]},a.catalogStoneList.innerHTML='<div class="muted">Save this record before adding stone options.</div>';return}let i=new URLSearchParams;i.set("catalog_id",t);try{let r=await w(`/catalog-stone-options?${i.toString()}`),o=Array.isArray(r.items)?r.items:[];n.catalogStoneOptions={items:o};let l=n.catalogEnums||{},s=$i(o);if(!s.length){a.catalogStoneList.innerHTML='<div class="muted">No stone options yet.</div>';return}let d=s.map(([c,m])=>{let _=c==="unspecified"?"Unspecified size":c.replace(/_/g," "),x=m.map($=>xi($,l)).join("");return`
          <div class="stone-size-group" data-size-type="${C(c)}">
            <div class="stone-size-header">${N(_)}</div>
            <div class="stone-size-rows">${x}</div>
          </div>
        `});a.catalogStoneList.innerHTML=d.join("")}catch{n.catalogStoneOptions={items:[]},a.catalogStoneList.innerHTML='<div class="muted">Unable to load stone options.</div>'}}function Pi(){return{role:a.stoneAddRole?.value.trim()||"",carat:a.stoneAddCarat?.value.trim()||"",count:a.stoneAddCount?.value.trim()||"",size_type:a.stoneAddSizeType?.value.trim()||"",shape:a.stoneAddShape?.value.trim()||"",is_primary:a.stoneAddPrimary?.value||""}}function Oi(){a.stoneAddRole&&(a.stoneAddRole.value=""),a.stoneAddCarat&&(a.stoneAddCarat.value=""),a.stoneAddCount&&(a.stoneAddCount.value=""),a.stoneAddSizeType&&(a.stoneAddSizeType.value=""),a.stoneAddShape&&(a.stoneAddShape.value=""),a.stoneAddPrimary&&(a.stoneAddPrimary.value="")}async function Mi(){if(!n.selectedItem)return;let e=n.selectedItem.id||"";if(!e){u("Save the item before adding stone options.","error");return}let t=Pi();if(!t.role||!t.carat){u("Role and carat are required.","error");return}try{await w("/catalog-stone-options/action",{method:"POST",body:JSON.stringify({action:"add_row",fields:{catalog_id:e,...t}})}),Oi(),await Ke(n.selectedItem),u("Stone option added.")}catch{u("Unable to add stone option.","error")}}async function Di(e){let t=e.getAttribute("data-stone-option-id")||"";if(!t)return;let i=Ti(e);if(!i.role||!i.carat){u("Role and carat are required.","error");return}try{await w("/catalog-stone-options/action",{method:"POST",body:JSON.stringify({action:"update",id:t,fields:i})}),await Ke(n.selectedItem),u("Stone option saved.")}catch{u("Unable to save stone option.","error")}}async function zi(e){let t=e.getAttribute("data-stone-option-id")||"";if(t&&confirm("Delete this stone option?"))try{await w("/catalog-stone-options/action",{method:"POST",body:JSON.stringify({action:"delete",id:t})}),await Ke(n.selectedItem),u("Stone option deleted.")}catch{u("Unable to delete stone option.","error")}}function Ri(e,t){let i=String(e.is_primary||e.isPrimary||"")==="1"||e.is_primary===!0,r=ua(t||{}),o=Te(r,e.size_type||"",!0,"Select");return`
      <div class="catalog-stone-row" data-metal-option-id="${C(e.id||"")}">
        <div class="catalog-stone-grid">
          <label class="field">
            <span>Metal weight</span>
            <input type="number" step="0.01" min="0" data-metal-field="metal_weight" value="${C(e.metal_weight??"")}">
          </label>
          <label class="field">
            <span>Size type</span>
            <select data-metal-field="size_type">
              ${o}
            </select>
          </label>
          <label class="field">
            <span>Primary</span>
            <select data-metal-field="is_primary">
              <option value="" ${i?"":"selected"}>No</option>
              <option value="1" ${i?"selected":""}>Yes</option>
            </select>
          </label>
        </div>
        <div class="catalog-stone-actions">
          <button class="btn btn-ghost btn-small" type="button" data-metal-save>Save</button>
          <button class="btn btn-ghost btn-small" type="button" data-metal-delete>Delete</button>
        </div>
      </div>
    `}function Fi(e){if(!Array.isArray(e))return[];let t=["xsmall","small","medium","large","xlarge","xxlarge"],i=new Map(t.map((r,o)=>[r,o]));return[...e].sort((r,o)=>{let l=String(r.size_type||"").toLowerCase(),s=String(o.size_type||"").toLowerCase(),d=i.has(l)?i.get(l):t.length+1,c=i.has(s)?i.get(s):t.length+1;if(d!==c)return d-c;let m=Number(r.metal_weight||0),_=Number(o.metal_weight||0);return!Number.isNaN(m)&&!Number.isNaN(_)&&m!==_?m-_:String(r.id||"").localeCompare(String(o.id||""))})}function Bi(e){let t=Fi(e),i=new Map;return t.forEach(r=>{let o=String(r.size_type||"unspecified").toLowerCase()||"unspecified";i.has(o)||i.set(o,[]),i.get(o).push(r)}),Array.from(i.entries())}function ji(e){let t=i=>{let r=e.querySelector(`[data-metal-field="${i}"]`);return r?r.value.trim():""};return{metal_weight:t("metal_weight"),size_type:t("size_type"),is_primary:t("is_primary")}}async function Qe(e){if(!a.catalogMetalList)return;if(!ne.has(n.tab)){a.catalogMetalList.innerHTML="";return}let t=e?.id||"";if(!t){n.catalogMetalOptions={items:[]},a.catalogMetalList.innerHTML='<div class="muted">Save this record before adding metal options.</div>';return}let i=new URLSearchParams({catalog_id:t});try{let r=await w(`/catalog-metal-options?${i.toString()}`),o=Array.isArray(r.items)?r.items:[];n.catalogMetalOptions={items:o};let l=Bi(o);if(!l.length){a.catalogMetalList.innerHTML='<div class="muted">No metal options yet.</div>';return}let s=l.map(([d,c])=>{let m=d==="unspecified"?"Unspecified size":d.replace(/_/g," "),_=c.map(x=>Ri(x,n.catalogEnums)).join("");return`
          <div class="stone-size-group" data-size-type="${C(d)}">
            <div class="stone-size-header">${N(m)}</div>
            <div class="stone-size-rows">${_}</div>
          </div>
        `});a.catalogMetalList.innerHTML=s.join("")}catch{n.catalogMetalOptions={items:[]},a.catalogMetalList.innerHTML='<div class="muted">Unable to load metal options.</div>'}}function Ui(){return{metal_weight:a.metalAddWeight?.value.trim()||"",size_type:a.metalAddSizeType?.value.trim()||"",is_primary:a.metalAddPrimary?.value||""}}function Hi(){a.metalAddWeight&&(a.metalAddWeight.value=""),a.metalAddSizeType&&(a.metalAddSizeType.value=""),a.metalAddPrimary&&(a.metalAddPrimary.value="")}async function Wi(){if(!n.selectedItem)return;let e=n.selectedItem.id||"";if(!e){u("Save the item before adding metal options.","error");return}let t=Ui();if(!t.metal_weight){u("Metal weight is required.","error");return}try{await w("/catalog-metal-options/action",{method:"POST",body:JSON.stringify({action:"add_row",fields:{catalog_id:e,...t}})}),Hi(),await Qe(n.selectedItem),u("Metal option added.")}catch{u("Unable to add metal option.","error")}}async function Gi(e){let t=e.getAttribute("data-metal-option-id")||"";if(!t)return;let i=ji(e);if(!i.metal_weight){u("Metal weight is required.","error");return}try{await w("/catalog-metal-options/action",{method:"POST",body:JSON.stringify({action:"update",id:t,fields:i})}),await Qe(n.selectedItem),u("Metal option saved.")}catch{u("Unable to save metal option.","error")}}async function Vi(e){let t=e.getAttribute("data-metal-option-id")||"";if(t&&confirm("Delete this metal option?"))try{await w("/catalog-metal-options/action",{method:"POST",body:JSON.stringify({action:"delete",id:t})}),await Qe(n.selectedItem),u("Metal option deleted.")}catch{u("Unable to delete metal option.","error")}}function fa(e){return a.noteEditors.find(t=>t.dataset.noteEditor===e)||null}function pa(e){return a.noteRows.find(t=>t.dataset.noteRows===e)||null}function Ji(e){return a.noteInputs.find(t=>t.dataset.noteInput===e)||null}function Ki(e){return a.noteOrders.find(t=>t.dataset.noteOrder===e)||null}function ga(e,t){let i=fa(e);i&&(i.value=t?.note||"",i.dataset.noteId=t?.id||"")}function ya(e,t){let i=pa(e);if(i){if(!t.length){i.innerHTML='<div class="muted">No notes yet.</div>';return}i.innerHTML=t.map(r=>`
        <div class="note-row" data-note-id="${C(r.id||"")}">
          <input type="text" data-note-field="note" value="${C(r.note||"")}" />
          <input type="number" data-note-field="sort_order" value="${C(r.sort_order||"0")}" />
          <div class="note-actions">
            <button class="btn btn-ghost btn-small" type="button" data-note-row-save>Save</button>
            <button class="btn btn-ghost btn-small" type="button" data-note-row-delete>Delete</button>
          </div>
        </div>
      `).join("")}}async function vt(e){if(!a.catalogNotesSection)return;let t=e?.id||"",i=e?.slug||"";if(!t){a.noteEditors.forEach(o=>{o.value="",o.dataset.noteId="",o.disabled=!0}),a.noteInputs.forEach(o=>{o.value="",o.disabled=!0}),a.noteOrders.forEach(o=>{o.value="",o.disabled=!0}),nt.forEach(o=>{let l=pa(o);l&&(l.innerHTML='<div class="muted">Save this record before adding notes.</div>')});return}a.noteEditors.forEach(o=>{o.disabled=!1}),a.noteInputs.forEach(o=>{o.disabled=!1}),a.noteOrders.forEach(o=>{o.disabled=!1});let r=new URLSearchParams({catalog_id:t});i&&r.set("catalog_slug",i);try{let o=await w(`/catalog-notes?${r.toString()}`),l=Array.isArray(o.items)?o.items:[];n.catalogNotes=l,Tt.forEach(s=>{let d=l.find(c=>String(c.kind||"")===s);ga(s,d||null)}),nt.forEach(s=>{let d=l.filter(c=>String(c.kind||"")===s);ya(s,d)})}catch{n.catalogNotes=[],Tt.forEach(o=>ga(o,null)),nt.forEach(o=>ya(o,[]))}}async function Qi(e){if(!n.selectedItem)return;let t=fa(e);if(!t)return;let i=t.value.trim(),r=t.dataset.noteId||"",o=n.selectedItem.id||"",l=n.selectedItem.slug||"";if(!o){u("Save the item before adding notes.","error");return}if(!i){if(!r||!confirm("Delete this note?"))return;try{await w("/catalog-notes/action",{method:"POST",body:JSON.stringify({action:"delete",id:r})}),t.value="",t.dataset.noteId="",u("Note removed.")}catch{u("Unable to delete note.","error")}return}let s=r?{action:"update",id:r,fields:{note:i,sort_order:"0"}}:{action:"add_row",fields:{catalog_id:o,catalog_slug:l,kind:e,note:i,sort_order:"0"}};try{let d=await w("/catalog-notes/action",{method:"POST",body:JSON.stringify(s)});!r&&d.id&&(t.dataset.noteId=d.id),u("Note saved.")}catch{u("Unable to save note.","error")}}async function Xi(e){let t=e.getAttribute("data-note-id")||"";if(!t)return;let i=e.querySelector('[data-note-field="note"]'),r=e.querySelector('[data-note-field="sort_order"]'),o=i?i.value.trim():"",l=r?r.value.trim():"";if(!o){u("Note text is required.","error");return}try{await w("/catalog-notes/action",{method:"POST",body:JSON.stringify({action:"update",id:t,fields:{note:o,sort_order:l||"0"}})}),u("Note updated.")}catch{u("Unable to save note.","error")}}async function Yi(e){let t=e.getAttribute("data-note-id")||"";if(t&&confirm("Delete this note?"))try{await w("/catalog-notes/action",{method:"POST",body:JSON.stringify({action:"delete",id:t})}),await vt(n.selectedItem),u("Note deleted.")}catch{u("Unable to delete note.","error")}}async function Zi(e){if(!n.selectedItem)return;let t=n.selectedItem.id||"",i=n.selectedItem.slug||"";if(!t){u("Save the item before adding notes.","error");return}let r=Ji(e);if(!r)return;let o=r.value.trim();if(!o){u("Note text is required.","error");return}let l=Ki(e),s=l?l.value.trim():"";try{await w("/catalog-notes/action",{method:"POST",body:JSON.stringify({action:"add_row",fields:{catalog_id:t,catalog_slug:i,kind:e,note:o,sort_order:s||"0"}})}),r.value="",l&&(l.value=""),await vt(n.selectedItem),u("Note added.")}catch{u("Unable to add note.","error")}}function en(){return n.selectedItem?.slug||""}function Pe(){return n.tab==="products"?"/product-media/action":"/inspiration-media/action"}function ha(e,t,i,r){let o=en();return o?{action:"add_row",fields:n.tab==="products"?{product_slug:o,media_id:e,position:t,order:i,is_primary:r}:{inspiration_slug:o,media_id:e,position:t,order:i,is_primary:r}}:null}async function tn(){let e=a.mediaId?.value.trim();if(!e){u("Add a media ID first.","error");return}let t=a.mediaPositionExisting?.value.trim()||"",i=a.mediaOrderExisting?.value.trim()||"";if(!t){u("Choose a media position.","error");return}let r=a.mediaPrimaryExisting?.value||"";if(i&&Number.isNaN(Number(i))){u("Order must be a number.","error");return}let o=ha(e,t,i,r);if(!o){u("Save the record before linking media.","error");return}if(!(await w(Pe(),{method:"POST",body:JSON.stringify(o)})).ok){u("Linking failed.","error");return}u("Media linked"),Ce(n.selectedItem)}async function an(){let e=a.mediaFile?.files?.[0];if(!e){u("Choose a file first.","error");return}let t=a.mediaLabel?.value.trim()||"",i=a.mediaAlt?.value.trim()||"",r=a.mediaDescription?.value.trim()||"",o=a.mediaPosition?.value.trim()||"",l=a.mediaOrder?.value.trim()||"",s=a.mediaPrimary?.value||"";if(l&&Number.isNaN(Number(l))){u("Order must be a number.","error");return}if(!o){u("Choose a media position.","error");return}try{let d=Fe(),c=d.endsWith("/")?d:`${d}/`,m=xe(c)?Ot():"",_=new FormData;_.append("file",e),t&&_.append("label",t);let x=new URL("media/upload",c);Mt(x,c,m);let $=await(await fetch(x.toString(),{method:"POST",credentials:xe(c)?"omit":"include",body:_})).json();if(!$.ok)throw new Error("upload_failed");let G=$.media||{},F=new Date().toISOString();await w("/media-library/action",{method:"POST",body:JSON.stringify({action:"add_row",fields:{media_id:G.media_id,url:G.url,media_type:G.media_type||"image",label:t,alt:i,description:r,created_at:F}})});let K=ha(G.media_id,o,l,s);K&&await w(Pe(),{method:"POST",body:JSON.stringify(K)}),u("Media uploaded"),Ce(n.selectedItem),a.mediaFile&&(a.mediaFile.value="")}catch{u("Upload failed.","error")}}async function Kn(e){if(e)try{await w(Pe(),{method:"POST",body:JSON.stringify({action:"edit",rowNumber:e,fields:{position:"hero",is_primary:"1",sort_order:"0"}})}),u("Hero media updated."),Ce(n.selectedItem)}catch{u("Unable to set hero media.","error")}}async function nn(e,t){if(!e||!t)return;let i=t.querySelector("[data-media-order]"),r=t.querySelector("[data-media-position]"),o=t.querySelector("[data-media-hero-toggle]"),l=t.querySelector("[data-media-label]"),s=t.querySelector("[data-media-description]"),d=i?i.value.trim():"";if(d&&Number.isNaN(Number(d))){u("Order must be a number.","error");return}let c=t.dataset.position||"",m=r?r.value.trim():"",_=o?o.checked:!1,x=String(m||"").toLowerCase()==="hero",$=_||x,G=$?"hero":m||c;!$&&String(c||"").toLowerCase()==="hero"&&(G="");try{let F=t.dataset.mediaId||"";F&&(l||s)&&await w("/media-library/action",{method:"POST",body:JSON.stringify({action:"edit",rowNumber:F,fields:{label:l?l.value.trim():void 0,description:s?s.value.trim():void 0}})}),await w(Pe(),{method:"POST",body:JSON.stringify({action:"edit",rowNumber:e,fields:{position:G,is_primary:$?"1":"0",sort_order:d}})}),u("Media updated."),Ce(n.selectedItem)}catch{u("Unable to update media.","error")}}async function rn(e,t){let i=t?.querySelector("[data-media-describe]");i&&(i.disabled=!0,i.textContent="Generating...");try{let r=await w("/media/describe",{method:"POST",body:JSON.stringify({media_id:e})});if(!r?.ok){u(r?.error||"Failed to generate description.","error");return}let o=t?.querySelector("[data-media-description]");o&&(o.value=r.description||""),u("Description generated. Review and click Save to store.","success")}catch(r){console.error(r),u("Failed to generate description.","error")}finally{i&&(i.disabled=!1,i.textContent="Generate description")}}async function on(e){if(e&&window.confirm("Delete this media?"))try{await w(Pe(),{method:"POST",body:JSON.stringify({action:"delete",rowNumber:e,delete_media:!0})}),u("Media deleted."),Ce(n.selectedItem)}catch{u("Unable to delete media.","error")}}function ln(){if(!a.orderDetailsSection)return;let e=n.tab==="orders";a.orderDetailsSection.classList.toggle("is-hidden",!e)}function _t(){if(n.tab!=="quotes")return!1;let e=Number(v("stone_weight")),t=v("diamond_breakdown"),i=!!String(t||"").trim();return(!Number.isFinite(e)||e<=0)&&!i}function ba(e,t){let i=H(e);if(!i)return;let r=i.closest(".field");r&&r.classList.toggle("is-hidden",!t)}function kt(){if(n.tab!=="quotes")return;let e=_t();Array.from(document.querySelectorAll(".quote-option-card")).forEach((t,i)=>{i===0?t.classList.toggle("is-hidden",!1):t.classList.toggle("is-hidden",e)}),ba("quote_option_1_clarity",!e),ba("quote_option_1_color",!e),e&&g.forEach((t,i)=>{i>0&&W(i,"idle")})}function Sa(){if(n.tab!=="quotes")return;let e=ve(v("quote_discount_type")),t=H("quote_discount_percent");if(!t)return;let i=e==="custom";t.disabled=!i,a.discountPercent&&(a.discountPercent.disabled=!i)}function wa(){a.quoteSection&&(a.quoteSection.classList.toggle("is-hidden",n.tab!=="quotes"),Kt(),kt(),a.sizeBlock&&n.tab!=="quotes"&&a.sizeBlock.classList.add("is-hidden"),a.quoteExtras&&a.quoteExtras.classList.toggle("is-hidden",n.tab==="quotes"),a.notesToggle&&(a.notesToggle.open=n.tab!=="quotes"),a.summaryMore&&a.summaryMore.classList.toggle("is-hidden",n.tab!=="quotes"),a.summaryPriceRow&&a.summaryPriceRow.classList.toggle("is-hidden",n.tab==="quotes"),sn())}function sn(){if(!(!a.activitySection||!a.activitySlot)){if(n.tab==="quotes")a.activitySection.dataset.originalParent||(a.activitySection.dataset.originalParent="detail-main"),a.activitySlot.appendChild(a.activitySection);else if(a.activitySection.dataset.originalParent==="detail-main"){let e=document.querySelector(".detail-main");e&&!e.contains(a.activitySection)&&e.insertBefore(a.activitySection,e.firstChild)}}}function va(){if(!a.quoteMetalInput)return;let e=v("metal"),t=Gt(e);if(t){qt(t,e);return}let i=a.quoteMetals.filter(r=>r.checked).map(r=>r.value);a.quoteMetalInput.value=i.join(", ")}function qt(e,t=""){if(!a.quoteMetalInput)return;let i=Gt(t),r=String(e||"").split(",").map(o=>o.trim()).filter(Boolean);i?(r.length=0,r.push(i)):r.length||r.push("18K"),a.quoteMetalInput.value=r.join(", "),a.quoteMetals.forEach(o=>{o.checked=r.includes(o.value),i?o.disabled=o.value!==i:o.disabled=!1})}function de(e){let t=a.orderDetailsFields.find(i=>i.dataset.orderDetailsField===e);return t?t.value.trim():""}function dn(e){return a.orderDetailsFields.find(t=>t.dataset.orderDetailsField===e)}function _a(){let e={};return L.forEach(t=>{let i=de(t);i&&(e[t]=i)}),e}function ka(){let e=de("shipping_carrier").toLowerCase(),t=de("tracking_number"),i=dn("tracking_url");if(!i)return;let r=re[e];if(r&&t){let o=`${r}${encodeURIComponent(t)}`;(!i.value||i.dataset.autoGenerated==="true")&&(i.value=o,i.dataset.autoGenerated="true")}(!r||!t)&&(i.dataset.autoGenerated==="true"&&(i.value=""),i.dataset.autoGenerated=""),Dt(a.openTracking,!!i.value)}function cn(e){e&&(e.dataset.orderDetailsField==="tracking_url"&&(e.dataset.autoGenerated=""),ka(),oe(),Me())}function Xe(e={}){n.orderDetails=e||{},a.orderDetailsFields.forEach(t=>{let i=t.dataset.orderDetailsField;if(!i)return;let r=i==="shipping_method"?"Express":"";t.value=e[i]||r,t.dataset.activityValue=t.value}),Me(),ka(),n.selectedItem&&ce(n.selectedItem)}function qa(e){return[e.address_line1,e.address_line2,e.city,e.state,e.postal_code,e.country].filter(Boolean).join(", ")||"--"}function ce(e){if(!e)return;let t=Se(e.status),i=n.tab==="quotes"||n.tab==="orders",r=n.tab==="quotes";if(a.summaryQuoteBlock&&a.summaryQuoteBlock.classList.toggle("is-hidden",!i),a.summaryPreferencesBlock&&a.summaryPreferencesBlock.classList.toggle("is-hidden",!i),a.summaryOptionsBlock&&a.summaryOptionsBlock.classList.toggle("is-hidden",!r),a.summaryNotesBlock&&a.summaryNotesBlock.classList.toggle("is-hidden",!i),a.summarySizesBlock&&a.summarySizesBlock.classList.toggle("is-hidden",!r),a.summaryStatus&&(a.summaryStatus.textContent=t,a.summaryStatus.dataset.status=t),a.summaryProduct&&(a.summaryProduct.textContent=e.product_name||"--"),a.summaryDesignCode&&(a.summaryDesignCode.textContent=e.design_code||"--"),a.summaryRequest&&(a.summaryRequest.textContent=e.request_id||"--"),a.summaryCreated&&(a.summaryCreated.textContent=qe(e.created_at)||"--"),a.summaryPrice&&(a.summaryPrice.textContent=se(e.price)||"--"),a.summaryTimeline&&(a.summaryTimeline.textContent=Ue(e.timeline)||"--"),a.summaryTimelineDelay){let s=ut(e.timeline_adjustment_weeks);a.summaryTimelineDelay.textContent=s||"--"}let o=e.stone||n.orderDetails&&n.orderDetails.stone||"",l=e.stone_weight||n.orderDetails&&n.orderDetails.stone_weight||"";if(a.summaryMetal&&(a.summaryMetal.textContent=e.metal||"--"),a.summaryStone&&(a.summaryStone.textContent=o||"--"),a.summaryStoneWeight&&(a.summaryStoneWeight.textContent=st(l)||"--"),a.summaryMetalWeight&&(a.summaryMetalWeight.textContent=Ft(e.metal_weight)||"--"),a.summaryMetalAdjustment&&(a.summaryMetalAdjustment.textContent=Bt(e.metal_weight_adjustment)||"--"),a.summaryDiamondBreakdown&&(a.summaryDiamondBreakdown.textContent=e.diamond_breakdown||"--"),a.summaryDiscount){let s=String(e.quote_discount_type||"").trim(),d=String(e.quote_discount_percent||"").trim();s&&d?a.summaryDiscount.textContent=`${s} ${d}%`:s?a.summaryDiscount.textContent=s:d?a.summaryDiscount.textContent=`${d}%`:a.summaryDiscount.textContent="--"}if(a.summaryInterests&&(a.summaryInterests.textContent=e.interests||"--"),a.summaryContactPreference&&(a.summaryContactPreference.textContent=e.contact_preference||"--"),a.summarySubscription&&(a.summarySubscription.textContent=e.subscription_status||"--"),a.summaryCustomerNotes&&(a.summaryCustomerNotes.textContent=e.customer_notes||e.request_notes||"--"),a.summaryOption1&&(a.summaryOption1.textContent=se(e.quote_option_1_price_18k)||"--"),a.summaryOption2&&(a.summaryOption2.textContent=se(e.quote_option_2_price_18k)||"--"),a.summaryOption3&&(a.summaryOption3.textContent=se(e.quote_option_3_price_18k)||"--"),[a.summaryOption1,a.summaryOption2,a.summaryOption3].forEach((s,d)=>{if(!s)return;let c=s.closest(".summary-line");c&&c.classList.toggle("is-recommended",n.recommendedOptionIndex===d)}),a.summaryOptionRecommended){let s=n.recommendedOptionIndex===null?"--":`Option ${n.recommendedOptionIndex+1}`;a.summaryOptionRecommended.textContent=s}a.summaryLastPriced&&(a.summaryLastPriced.textContent=bi()),a.summarySizeRing&&(a.summarySizeRing.textContent=a.sizeRing?.value?.trim()||"--"),a.summarySizeBracelet&&(a.summarySizeBracelet.textContent=a.sizeBracelet?.value?.trim()||"--"),a.summarySizeChain&&(a.summarySizeChain.textContent=a.sizeChain?.value?.trim()||"--"),a.summaryCustomer&&(a.summaryCustomer.textContent=e.name||"--"),a.summaryEmail&&(a.summaryEmail.textContent=e.email||"--"),a.summaryPhone&&(a.summaryPhone.textContent=Ge(e.phone)),a.summaryAddress&&(a.summaryAddress.textContent=qa(e))}function J(e,t){return`<button class="chip missing-chip" type="button" data-focus-target='${t}'>${e}</button>`}function un(e,t){return`<button class="chip is-warning" type="button" data-focus-target='${t}'>${e}</button>`}function oe(){if(!a.missingList)return;let e=[];if(n.tab==="media-library"){a.missingList.innerHTML='<span class="muted">No missing details.</span>',Ze();return}if(I.has(n.tab)){let t=Ta();if(window.CatalogUtils){let i=n.catalogEnums||{},r=window.CatalogUtils.normalizeCatalogItem(t,i);n.catalogFormState=r.normalized,n.catalogValidation=window.CatalogUtils.validateCatalogItem(r.normalized,i,n.catalogMediaState);let o=n.catalogValidation.missingCritical||[],l=n.catalogValidation.warnings||[];e=[...o.map(s=>J(s.message,s.selector||"")),...l.map(s=>un(s.message,`[data-field="${s.field}"]`))]}a.missingList.innerHTML=e.length?e.join(""):'<span class="muted">No missing details.</span>',Ze();return}if(n.tab==="quotes"){let t=gt();e=bt(t)}else{v("metal_weight")||e.push(J("Metal weight missing",'[data-field="metal_weight"]')),v("stone_weight")||e.push(J("Stone weight missing",'[data-field="stone_weight"]'));let t=v("stone").toLowerCase(),i=v("diamond_breakdown");Ee.some(s=>t.includes(s))&&!i&&e.push(J("Diamond breakdown empty",'[data-field="diamond_breakdown"]'));let r=de("shipping_status").toLowerCase(),o=de("tracking_number");Re.has(r)&&!o&&e.push(J("Tracking # required for shipping",'[data-order-details-field="tracking_number"]'));let l=de("delivery_eta");l&&!/^\d{4}-\d{2}-\d{2}$/.test(l)&&e.push(J("Delivery ETA needs YYYY-MM-DD",'[data-order-details-field="delivery_eta"]'))}a.missingList.innerHTML=e.length?e.join(""):'<span class="muted">No missing details.</span>',Ze()}function mn(){if(!a.discountType||!a.discountPercent)return;let e=H("quote_discount_type"),t=H("quote_discount_percent");e&&(a.discountType.value=e.value||"none"),t&&(a.discountPercent.value=t.value||"")}function Ca(){let e=H("quote_discount_type"),t=H("quote_discount_percent");e&&a.discountType&&(e.value=a.discountType.value),t&&a.discountPercent&&(t.value=a.discountPercent.value.trim())}function Oe(){if(!a.discountFinal)return;let e=v("price")||v("quote_option_1_price_18k"),t=Number(e),i=Number(a.discountPercent?.value)||0;if(a.discountType&&a.discountPercent&&(a.discountPercent.disabled=a.discountType.value!=="custom"),!t||Number.isNaN(t)){a.discountFinal.textContent="--",Ca();return}let r=i&&i>0?Math.max(0,t*(1-i/100)):t;a.discountFinal.textContent=se(r)||"--",Ca(),Xt()}function fn(e){return e?[`Order: ${e.request_id||"--"}`,`Created: ${qe(e.created_at)||"--"}`,`Status: ${Se(e.status)}`,`Product: ${e.product_name||"--"} (${e.design_code||"--"})`,`Specs: ${e.metal||"--"} / ${e.stone||"--"} ${st(e.stone_weight)}`,`Price: ${se(e.price)||"--"}`,`Timeline: ${Ue(e.timeline)||"--"} ${ut(e.timeline_adjustment_weeks)||""}`,`Customer: ${e.name||"--"} (${e.email||"--"} / ${Ge(e.phone)})`,`Address: ${qa(e)}`].filter(Boolean).join(`
`):""}function La(){if(!a.metalWeightFinal)return;let e=Number(v("metal_weight")),t=Number(v("metal_weight_adjustment")),i=Number.isFinite(e),r=Number.isFinite(t);if(!i&&!r){a.metalWeightFinal.textContent="--";return}let o=(i?e:0)+(r?t:0);a.metalWeightFinal.textContent=`${o.toFixed(2).replace(/\.?0+$/,"")} g`}function Ea(){let e=H("metal_weight"),t=H("metal_weight_adjustment"),i=a.metalWeightError,r=a.metalWeightAdjustmentError,o=/^[+-]?\d+(\.\d+)?$/,l=e?e.value.trim():"",s=t?t.value.trim():"";i&&(i.textContent=l&&!o.test(l)?"Enter a valid weight":""),r&&(r.textContent=s&&!o.test(s)?"Use + or - followed by a number":"")}function Me(){if(!a.detailsSave)return;let e=L.some(t=>String(de(t))!==String(n.orderDetails[t]||""));n.dirtySections.fulfillment=e,Dt(a.detailsSave,e&&rt()),Ye()}function pn(){n.criticalDirty=f.some(e=>{if(!ze.has(e.key))return!1;let t=e.normalize(v(e.key)),i=n.originalValues[e.key]||"";return t!==i})}function Ye(){if(!a.dirtyIndicator)return;let e=[];n.dirtySections.edits&&e.push("Unsaved edits"),n.tab==="orders"&&n.dirtySections.fulfillment&&e.push("Unsaved fulfillment");let t=e.length?e.join(" / "):"All changes saved";a.dirtyIndicator.textContent=t,a.dirtyIndicator.classList.toggle("is-dirty",e.length>0),Ze()}function Aa(e="edits"){if(e==="fulfillment"){Me();return}R()}function Ze(){if(!a.nextActionText)return;let e=a.missingList?a.missingList.querySelectorAll(".missing-chip").length:0;if(e){a.nextActionText.textContent=`${e} critical items need attention.`;return}if(n.tab==="quotes"){let t=et();if(t.blocked&&t.reason){a.nextActionText.textContent=t.reason;return}}if(n.criticalDirty){a.nextActionText.textContent="Critical edits pending. Save before actions.";return}if(n.dirtySections.fulfillment){a.nextActionText.textContent="Save fulfillment details to keep tracking current.";return}if(n.dirtySections.edits){a.nextActionText.textContent="Review edits and request confirmation.";return}a.nextActionText.textContent="Review edits or choose an action."}function gn(){return H("notes")}function Ct(e){let t=gn();if(!t)return;let i=t.selectionStart||0,r=t.selectionEnd||0;t.value=`${t.value.slice(0,i)}${e}${t.value.slice(r)}`;let o=i+e.length;t.setSelectionRange(o,o),t.focus()}function yn(){let e=new Date,t=r=>String(r).padStart(2,"0"),i=`[${e.getFullYear()}-${t(e.getMonth()+1)}-${t(e.getDate())} ${t(e.getHours())}:${t(e.getMinutes())} CT] `;Ct(i)}function hn(){let e=Va.map(t=>`- ${t}`).join(`
`);Ct(`${e}
`)}function Le(e,t){t&&(Xa(t),u(`${e} copied`))}function bn(e){return T[n.tab].find(t=>t.action===e)}function ae(){if(!a.actionRun||!a.actionSelect)return;let e=a.actionSelect.disabled||!a.actionSelect.value;if(n.tab==="quotes"){let t=et();a.actionRun.disabled=e||t.blocked,Na(t);return}if(ne.has(n.tab)){let t=n.catalogValidation?.missingCritical?.length||0,i=a.actionSelect.value==="delete";a.actionRun.disabled=e||i&&(t>0||n.dirtySections.edits);return}a.actionRun.disabled=e}function Na(e){if(!a.summaryPricingStatus)return;if(n.tab!=="quotes"){a.summaryPricingStatus.textContent="--";return}let t=e||et();if(t.reason==="Pricing in progress"){a.summaryPricingStatus.textContent="Pricing...";return}if(t.reason==="Missing pricing inputs"){a.summaryPricingStatus.textContent="Missing inputs";return}if(t.reason==="Pricing stale"){a.summaryPricingStatus.textContent="Stale";return}if(t.reason==="No active options"){a.summaryPricingStatus.textContent="No active options";return}a.summaryPricingStatus.textContent="Current"}function et(){if(n.tab!=="quotes")return{blocked:!1,reason:""};let e=gt(),t=bt(e),i=g.map((c,m)=>m).filter(c=>_e(c)),r=i.map(c=>le.options[c]?.status||"idle"),o=r.some(c=>c==="pricing"),l=i.length>0&&r.every(c=>c==="priced"||c==="manual"),s=t.length>0||o||!l||i.length===0,d="";return t.length?d="Missing pricing inputs":o?d="Pricing in progress":l?i.length===0&&(d="No active options"):d="Pricing stale",{blocked:s,reason:d}}function Lt(){let e=rt(),t=n.tab==="orders"&&n.selectedItem?T.orders.filter(i=>i.action==="delete"?!0:(E[Se(n.selectedItem.status)]||[]).includes(i.action)):T[n.tab];if(a.actionSelect&&(a.actionSelect.innerHTML='<option value="">Select an action</option>'+t.map(i=>`<option value="${i.action}">${i.label}</option>`).join(""),a.actionSelect.disabled=!e||t.length===0),a.actionRun&&(a.actionRun.disabled=!e||!a.actionSelect||!a.actionSelect.value),a.actionRow&&(a.actionRow.style.display=""),a.primaryAction&&(a.primaryAction.disabled=!e),a.notesSave&&(a.notesSave.disabled=!e),a.goldRefresh){let i=n.tab==="cost-chart"&&n.selectedItem&&(n.selectedItem.key==="gold_price_per_gram_usd"||n.selectedItem.key==="gold-price-per-gram-usd");a.goldRefresh.classList.toggle("is-hidden",!i),a.goldRefresh.disabled=!e||!i}a.editFields.forEach(i=>{i.disabled=!e}),a.detailsSave&&(a.detailsSave.disabled=!e),a.orderDetailsFields.forEach(i=>{i.disabled=!e}),a.catalogFields&&a.catalogFields.querySelectorAll("input,textarea,select").forEach(i=>{i.disabled=!e||i.hasAttribute("data-readonly")})}function Sn(e,t){let i=N(e),r=String(t);if(e==="Product URL"){let o=C(r),l=N(r);return`<div><span>${i}</span><a href="${o}" target="_blank" rel="noreferrer">${l}</a></div>`}return e==="Images"?`<div class="detail-media"><span>${i}</span>${r}</div>`:`<div><span>${i}</span>${N(r)}</div>`}function xa(e){return e.filter(([,t])=>Ei(t)).map(([t,i])=>Sn(t,i)).join("")}function wn(e){return e.map(t=>{let i=xa(t.rows||[]);return i?`<div class="detail-section">
          <p class="detail-section-title">${N(t.title)}</p>
          <div class="detail-grid">${i}</div>
        </div>`:""}).join("")}function Ia(e){let t=new Date(e);return Number.isNaN(t.getTime())?"--":t.toLocaleString(void 0,{dateStyle:"short",timeStyle:"short"})}function $a(){if(!a.activityFeed)return;if(!be.length){a.activityFeed.innerHTML='<div class="activity-item muted">No activity yet.</div>';return}let e=[...be].sort((t,i)=>new Date(i.time)-new Date(t.time)).slice(0,Pt);a.activityFeed.innerHTML=e.map(t=>{let i=t.detail?`<p class="activity-detail">${N(t.detail)}</p>`:"";return`<div class="activity-item activity-${t.type||"system"}">
          <div class="activity-meta">
            <span class="activity-time">${Ia(t.time)}</span>
            <strong class="activity-title">${N(t.title||"Updated")}</strong>
          </div>
          ${i}
        </div>`}).join("")}function pe(e){let t=e.time?new Date(e.time):new Date,i={...e,time:Number.isNaN(t.getTime())?new Date().toISOString():t.toISOString()};be.unshift(i),be.length>Pt&&be.pop(),$a()}function vn(e){if(be.length=0,!e){$a();return}let t=n.tab==="tickets"?"Ticket created":"Order created";e.created_at&&pe({time:e.created_at,type:"system",title:t,detail:`Status: ${Se(e.status)}`}),e.status&&pe({time:new Date().toISOString(),type:"status",title:`Current status: ${Se(e.status)}`})}function v(e){let t=a.editFields.find(i=>i.dataset.field===e);return t?t.value.trim():""}function _n(e){n.originalValues={},n.originalRaw={},f.forEach(t=>{let i=String(e[t.key]||"");n.originalRaw[t.key]=i,n.originalValues[t.key]=t.normalize(i)}),n.originalNotes=String(e.notes||"")}function Et(){let e=[];return f.forEach(t=>{let i=v(t.key);if(!i&&!n.originalValues[t.key]||!i&&n.originalValues[t.key])return;let r=t.normalize(i),o=n.originalValues[t.key]||"";r!==o&&e.push({key:t.key,label:t.label,from:t.format(n.originalRaw[t.key]),to:t.format(i)})}),e}function Ta(){if(!window.CatalogForm)return{};let e={};return[a.catalogFieldsBasic,a.catalogFieldsTaxonomy,a.catalogFieldsMaterials,a.catalogFieldsAudit,a.catalogFields].filter(Boolean).forEach(t=>{Object.assign(e,window.CatalogForm.readFormState(t))}),e}function De(){if(I.has(n.tab)){if(n.tab==="media-library"){let s={};if(!a.catalogFields)return s;a.catalogFields.querySelectorAll("input,textarea,select").forEach(m=>{let _=m.dataset.field;if(!_||m.disabled)return;let x=m.value;x!==void 0&&(s[_]=x.trim())});let d=n.catalogOriginalFields||{},c={};return Object.keys(s).forEach(m=>{let _=s[m],x=d[m];String(_??"")!==String(x??"")&&(c[m]=_)}),c}let t=Ta();if(!window.CatalogUtils||!window.CatalogUtils.normalizeCatalogItem)return t;let i=n.catalogEnums||{},r=window.CatalogUtils.normalizeCatalogItem(t,i);n.catalogFormState=r.normalized;let o=n.catalogOriginalFields||{},l={};return Object.keys(r.fields||{}).forEach(s=>{let d=r.fields[s],c=o[s];String(d??"")!==String(c??"")&&(l[s]=d)}),l}let e={};return va(),a.editFields.forEach(t=>{let i=t.dataset.field;i&&i!=="notes"&&M[n.tab].includes(i)&&t.value&&(e[i]=t.value.trim())}),e}function ge(){let e=a.editFields.find(t=>t.dataset.field==="notes");return e?e.value.trim():""}function R(){let e=rt(),t=ge()!==n.originalNotes.trim();if(a.notesSave&&(S.has(n.tab)||I.has(n.tab)||n.tab==="quotes"?a.notesSave.style.display="none":(a.notesSave.style.display="",a.notesSave.disabled=!e||!t)),!a.primaryAction)return;if(a.primaryAction.style.display=n.tab==="contacts"?"none":"",n.tab!=="orders"){let r=De();S.has(n.tab)&&(r.notes=ge());let o=Object.keys(r).length>0||n.tab==="quotes"&&t;a.primaryAction.textContent=n.isNewRow&&(S.has(n.tab)||I.has(n.tab))?"Add row":"Save updates",a.primaryAction.disabled=!e||!o,n.dirtySections.edits=o,Ye();return}a.primaryAction.textContent="Get Customer Confirmation";let i=Et();n.pendingChanges=i,a.primaryAction.disabled=!e||i.length===0,n.dirtySections.edits=i.length>0||t,Ye()}function kn(e){return e.map(t=>`
          <div class="confirm-row">
            <div class="confirm-field">${N(t.label)}</div>
            <div class="confirm-values">
              <span class="confirm-old">${N(t.from||"--")}</span>
              <span class="confirm-arrow">-></span>
              <span class="confirm-new">${N(t.to||"--")}</span>
            </div>
          </div>`).join("")}function qn(e){return e.map(t=>`
          <tr>
            <td style="padding:10px 0;border-bottom:1px solid #e5e7eb;">
              <div style="font-size:11px;letter-spacing:0.2em;text-transform:uppercase;color:#64748b;margin-bottom:6px;">
                ${N(t.label)}
              </div>
              <div style="font-size:14px;line-height:1.6;color:#0f172a;">
                <span style="color:#94a3b8;text-decoration:line-through;">${N(t.from||"--")}</span>
                <span style="color:#94a3b8;padding:0 8px;">-></span>
                <span style="font-weight:600;color:#0f172a;">${N(t.to||"--")}</span>
              </div>
            </td>
          </tr>`).join("")}function Cn(e,t,i){let r=e.request_id||"",o=e.name||"there",l=e.product_name||"your order",s=v("timeline")||e.timeline||"",d=v("timeline_adjustment_weeks")||e.timeline_adjustment_weeks||"",c=ri(s,d),m=r?`Heerawalla - Confirm order update (${r})`:"Heerawalla - Confirm order update",_=t.map(O=>`${O.label}: ${O.from||"--"} -> ${O.to||"--"}`),x=[`Hello ${o},`,"",`We reviewed your order for ${l}. Please confirm the updated details below (previous -> updated):`,"",..._,"",c,"",`Use your private confirmation link (Heerawalla.com/order_confirmation): ${i}`,"","Once confirmed, you will be guided to a secure checkout to reserve your piece.","Secure checkout supports major cards and wallets.","If anything looks incorrect, choose cancel on the confirmation page or reply to this email.","","Warm regards,","Heerawalla","www.heerawalla.com"].join(`
`),$=kn(t),G=qn(t),F=`<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body style="margin:0;padding:0;background:#f6f5f2;color:#0f172a;font-family:-apple-system, Segoe UI, Helvetica, Arial, sans-serif;">
  <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse;">
    <tr>
      <td align="center" style="padding:32px 16px;">
        <table role="presentation" width="600" cellpadding="0" cellspacing="0" style="border-collapse:collapse;background:#ffffff;border:1px solid #e5e7eb;">
          <tr>
            <td style="padding:36px 40px 28px 40px;">
              <div style="margin:0 0 16px 0;">
                <img src="https://www.heerawalla.com/images/engraving_mark.svg" width="36" height="36" alt="Heerawalla" style="display:block;">
              </div>
              <div style="font-size:12px;letter-spacing:0.32em;text-transform:uppercase;color:#64748b;margin-bottom:12px;">Heerawalla</div>
              <h1 style="margin:0 0 16px 0;font-size:22px;line-height:1.4;font-weight:600;color:#0f172a;">Please confirm your order update</h1>
              <p style="margin:0 0 16px 0;font-size:15px;line-height:1.7;color:#334155;">Hello ${N(o)},</p>
              <p style="margin:0 0 18px 0;font-size:15px;line-height:1.7;color:#334155;">
                We reviewed your order for ${N(l)}. Please confirm the updated details below (previous -> updated).
              </p>
              <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse;border:1px solid #e5e7eb;background:#fdfbf7;margin-bottom:18px;">
                <tbody>
                  ${G}
                </tbody>
              </table>
              <p style="margin:0 0 18px 0;font-size:14px;line-height:1.7;color:#334155;">
                ${N(c)}
              </p>
              <table role="presentation" cellpadding="0" cellspacing="0" style="margin:0 0 18px 0;">
                <tr>
                  <td style="background:#0f172a;border:1px solid #0f172a;">
                    <a href="${C(i)}" style="display:inline-block;padding:12px 22px;font-size:12px;letter-spacing:0.2em;text-transform:uppercase;color:#ffffff;text-decoration:none;">Review and confirm</a>
                  </td>
                </tr>
              </table>
              <p style="margin:0 0 6px 0;font-size:13px;line-height:1.7;color:#475569;">
                Use your private confirmation link at Heerawalla.com/order_confirmation.
              </p>
              <p style="margin:0 0 6px 0;font-size:13px;line-height:1.7;color:#475569;">
                Once confirmed, you will be guided to a secure checkout to reserve your piece.
              </p>
              <p style="margin:0 0 6px 0;font-size:13px;line-height:1.7;color:#475569;">
                Secure checkout supports major cards and wallets.
              </p>
              <p style="margin:0 0 24px 0;font-size:13px;line-height:1.7;color:#475569;">
                If anything looks incorrect, choose cancel on the confirmation page or reply to this email.
              </p>
              <div style="height:1px;background:#e5e7eb;margin:0 0 18px 0;"></div>
              <p style="margin:0 0 6px 0;font-size:14px;color:#0f172a;">Warm regards,</p>
              <p style="margin:0 0 10px 0;font-size:14px;font-weight:600;color:#0f172a;">Heerawalla</p>
              <p style="margin:0;font-size:12px;color:#64748b;">
                <a href="https://www.heerawalla.com" style="color:#64748b;text-decoration:underline;">www.heerawalla.com</a>
              </p>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`,K=`
      <div class="confirm-preview-card">
        <p class="confirm-title">Order update to confirm</p>
        <p class="confirm-sub">${N(l)}${r?` (${N(r)})`:""}</p>
        <div class="confirm-list">${$}</div>
        <a class="confirm-cta" href="${C(i)}" target="_blank" rel="noreferrer">Review and confirm</a>
        <p class="confirm-foot">${N(c)}</p>
        <p class="confirm-foot">
          Private confirmation link lets the customer confirm or cancel before secure checkout.
        </p>
      </div>`;return{subject:m,textBody:x,htmlBody:F,previewHtml:K}}function Ln(e){let t=e.confirmationUrl||e.url||"";if(t)return t.startsWith("http")?t:t.startsWith("/")?`https://www.heerawalla.com${t}`:t;let i=e.token||e.confirmationToken||"";return i?`https://www.heerawalla.com/order_confirmation?token=${encodeURIComponent(i)}`:""}let tt=null;function En(){if(!a.confirmModal)return;let e=a.confirmClose||a.confirmModal.querySelector("button, [href], input, select, textarea, [tabindex]:not([tabindex='-1'])");e&&typeof e.focus=="function"&&e.focus()}function An(e){a.confirmModal&&(tt=document.activeElement,a.confirmTo.textContent=e.to,a.confirmSubject.textContent=e.subject,a.confirmPreview.innerHTML=e.previewHtml,a.confirmModal.classList.add("is-open"),a.confirmModal.removeAttribute("inert"),a.confirmModal.setAttribute("aria-hidden","false"),requestAnimationFrame(En))}function At(){a.confirmModal&&(a.confirmModal.contains(document.activeElement)&&(tt&&typeof tt.focus=="function"?tt.focus():document.body.focus?.()),a.confirmModal.classList.remove("is-open"),a.confirmModal.setAttribute("aria-hidden","true"),a.confirmModal.setAttribute("inert",""))}async function Pa(e){let t=I.has(n.tab),i=n.isNewRow?"New row":e.request_id||e.email||e.slug||e.id||e.media_id||"Record",r=e.status||"NEW";n.selectedId=i,n.selectedItem=e,_n(e),n.dirtySections={edits:!1,fulfillment:!1},n.criticalDirty=!1,n.pendingChanges=[],n.confirmation=null;let o=k[n.tab]||n.tab;if(a.detailType.textContent=`${o} details`,a.detailTitle.textContent=e.product_name||e.name||e.key||e.metal||e.clarity||i,a.detailSub.textContent=i,a.detailStatusCorner){let d=t||n.tab==="contacts"||n.tab==="price-chart"||n.tab==="cost-chart"||n.tab==="diamond-price-chart"?"--":r;a.detailStatusCorner.textContent=d,a.detailStatusCorner.dataset.status=d}if(a.detailError&&(a.detailError.textContent=""),t){await Oa(e);return}ra();let l=n.tab==="contacts"?[["Created",qe(e.created_at)],["Name",e.name],["Email",e.email],["Phone",Ge(e.phone)],["Source",e.source],["Request ID",e.request_id],["Contact preference",e.contact_preference],["Interests",e.interests],["Page URL",e.page_url],["Updated",qe(e.updated_at)]]:n.tab==="tickets"?[["Request ID",e.request_id],["Created",qe(e.created_at)],["Status",r],["Name",e.name],["Email",e.email],["Phone",Ge(e.phone)],["Subject",e.subject],["Summary",e.summary],["Page URL",e.page_url],["Updated",qe(e.updated_at)]]:n.tab==="price-chart"?[["Row",e.row_number],["Metal",e.metal],["Adjustment type",e.adjustment_type],["Adjustment value",e.adjustment_value],["Notes",e.notes]]:n.tab==="cost-chart"?[["Row",e.row_number],["Key",e.key],["Value",e.value],["Unit",e.unit],["Notes",e.notes]]:n.tab==="diamond-price-chart"?[["Row",e.row_number],["Clarity",e.clarity],["Color",e.color],["Weight min",e.weight_min],["Weight max",e.weight_max],["Price per ct",e.price_per_ct],["Notes",e.notes]]:[],s=n.tab==="quotes"||n.tab==="orders"?[]:[];if(s.length?(a.detailGrid.classList.add("detail-sections"),a.detailGrid.innerHTML=wn(s)):(a.detailGrid.classList.remove("detail-sections"),a.detailGrid.innerHTML=xa(l)),a.overviewSection){let d=n.tab==="quotes"||n.tab==="orders";a.overviewSection.classList.toggle("is-hidden",d)}Li(e),ai(e),a.editFields.forEach(d=>{let c=d.dataset.field;if(c){if(c==="notes"){d.value=n.tab==="tickets"?"":e.notes||"",d.dataset.activityValue=d.value;return}d.value=e[c]||"",d.dataset.activityValue=d.value}}),Wt(e.metal||""),qt(e.quote_metal_options||"",e.metal||""),Jt(),mi(),fi(),Q({baseChanged:!0}),St(),ln(),wa(),Sa(),kt(),Lt(),ae(),R(),ce(e),oe(),vn(e),mn(),Oe(),La(),Ea(),Me(),Ye()}async function Oa(e){ra(),a.detailGrid&&(a.detailGrid.innerHTML=""),a.catalogTitle&&(a.catalogTitle.textContent=`${k[n.tab]||"Catalog"} details`);let t=await In();if(n.tab==="media-library"){n.catalogFormState=e||{},n.catalogOriginalFields={},n.catalogValidation=null,n.selectedItem=e||{},Object.keys(e||{}).forEach(o=>{n.catalogOriginalFields[o]=String(e?.[o]??"")}),la(e||{},t),Ni(e||{}),St(),Lt(),ae(),R(),oe();return}let i=window.CatalogUtils?window.CatalogUtils.parseLegacyFields(e,t):e||{};n.isNewRow&&i.is_active===void 0&&(i.is_active=!0);let r=window.CatalogUtils&&window.CatalogUtils.normalizeCatalogItem?window.CatalogUtils.normalizeCatalogItem(i,t):{normalized:i,fields:{}};if(n.catalogFormState=r.normalized||i,n.catalogOriginalFields=r.fields||{},n.catalogValidation=null,n.selectedItem=i,la(i,t),window.CatalogForm){window.CatalogForm.setSelectOptions(a.mediaPosition,t.media_positions,!0,"Select"),window.CatalogForm.setSelectOptions(a.mediaPositionExisting,t.media_positions,!0,"Select");let o=da(t);window.CatalogForm.setSelectOptions(a.stoneAddRole,o,!0,"Select");let l=ca(t);window.CatalogForm.setSelectOptions(a.stoneAddSizeType,l,!0,"Select");let s=ua(t);window.CatalogForm.setSelectOptions(a.metalAddSizeType,s,!0,"Select");let d=ma(t);window.CatalogForm.setSelectOptions(a.stoneAddShape,d,!0,"Select")}await Ce(i),await Ke(i),await Qe(i),await vt(i),St(),Lt(),ae(),R(),oe()}async function Nn(){try{let e=await w("/me");n.role=e.role||"",n.email=e.email||"",a.userRole&&(a.userRole.textContent=n.role||"Unknown"),a.userEmail&&(a.userEmail.textContent=n.email||"Not authorized")}catch{u("Access denied. Check Access policy.","error")}}async function ye(e){if(!e){ke("Missing request ID"),a.detailError&&(a.detailError.textContent="Missing request ID.");return}ke("Loading");try{let t=new URLSearchParams({limit:"1",offset:"0"});n.tab==="contacts"?String(e).includes("@")?t.set("email",e):t.set("request_id",e):n.tab==="price-chart"||n.tab==="cost-chart"||n.tab==="diamond-price-chart"?t.set("row_number",e):I.has(n.tab)?n.tab==="media-library"?t.set("media_id",e):(t.set("slug",e),t.set("id",e)):t.set("request_id",e);let i=await w(`${na(n.tab)}?${t.toString()}`);n.catalogHeaders=Array.isArray(i.headers)?i.headers:[];let r=(i.items||[])[0];if(!r){ke("Not found"),a.detailError&&(a.detailError.textContent="Record not found.");return}await Pa(r),n.tab==="orders"?await Ma(r.request_id):n.tab==="tickets"?await Nt(r.request_id):Xe({}),ke("Loaded")}catch{ke("Error"),a.detailError&&(a.detailError.textContent="Failed to load record."),u("Failed to load record.","error")}}async function xn(){try{let e=await w(`${na(n.tab)}?limit=1&offset=0`);n.catalogHeaders=Array.isArray(e.headers)?e.headers:[]}catch{n.catalogHeaders=[]}}async function In(){if(n.catalogEnums)return n.catalogEnums;try{let e=await w("/enums");return n.catalogEnums=e||{},n.catalogEnums}catch{return window.AdminEnums&&window.AdminEnums.FALLBACK_ENUMS?(n.catalogEnums=window.AdminEnums.FALLBACK_ENUMS,n.catalogEnums):(n.catalogEnums={},n.catalogEnums)}}async function Ma(e){if(!e||n.tab!=="orders"){Xe({});return}try{let t=await w(`/orders/details?request_id=${encodeURIComponent(e)}`);Xe(t.details||{})}catch{Xe({})}}async function Nt(e){if(!(!e||n.tab!=="tickets"))try{let t=await w(`/tickets/details?request_id=${encodeURIComponent(e)}`);(Array.isArray(t.details)?t.details:[]).forEach(i=>{let r=String(i.kind||"note").toLowerCase(),o=r==="email"?"Email sent":r==="status"?"Status update":"Comment";pe({time:i.created_at||new Date().toISOString(),type:r,title:o,detail:i.note||""})})}catch{}}async function $n(e){if(n.tab!=="quotes")return!0;let t=De(),i=ge();if(!Object.keys(t).length&&!i)return!0;let r=Ve();return r?(await w(r,{method:"POST",body:JSON.stringify({action:"edit",requestId:e,fields:t,notes:i})})).ok?!0:(u("Save failed","error"),!1):(u("No edits allowed.","error"),!1)}async function Tn(e){let t=Je();if(!t){u("Missing record ID","error");return}if(n.tab==="quotes"&&e==="refresh_quote"&&!await $n(t))return;let i=n.tab==="orders"?_a():{};if(n.tab==="orders"&&e==="mark_shipped"&&y.filter(l=>!i[l]).length){u("Add required fulfillment details before shipping.","error");return}if(n.tab==="tickets"&&e==="send_email"){let l=window.prompt("Email subject");if(!l)return;let s=window.prompt("Email message");if(!s)return;(await w("/tickets/action",{method:"POST",body:JSON.stringify({action:"send_email",requestId:t,subject:l,body:s})})).ok?(u("Email sent"),await Nt(t)):u("Email failed","error");return}let r={action:e};n.tab==="price-chart"||n.tab==="cost-chart"||n.tab==="diamond-price-chart"?r.rowNumber=t:r.requestId=t,n.tab==="orders"&&Object.keys(i).length&&(r.details=i),n.tab==="quotes"&&e==="submit_quote"&&(r.fields=De());let o=Ve();if(!o){u("No actions available.","error");return}if((await w(o,{method:"POST",body:JSON.stringify(r)})).ok){u("Action saved");let l=Je();l&&await ye(l)}else u("Action failed","error")}async function Da(){let e=Je(),t=S.has(n.tab),i=I.has(n.tab);if(!e&&!(n.isNewRow&&(t||i))){u("Missing record ID","error");return}let r=De(),o=ge();t&&(r.notes=o);let l={action:n.isNewRow&&(t||i)?"add_row":"edit",fields:r};if(t&&!n.isNewRow)l.rowNumber=e;else if(i&&!n.isNewRow){let d=n.selectedItem?.row_number||e;l.rowNumber=d}else!t&&!i&&(l.requestId=e,l.notes=o);let s=Ve();if(!s){u("No edits allowed.","error");return}(await w(s,{method:"POST",body:JSON.stringify(l)})).ok?(u("Updates saved"),n.isNewRow&&(S.has(n.tab)||i)?window.location.href=`/?tab=${encodeURIComponent(n.tab)}`:S.has(n.tab)?await ye(e):i?await ye(e):await ye(n.selectedItem.request_id)):u("Update failed","error")}async function za(){if(S.has(n.tab)){u("Use Save updates for pricing notes.","error");return}let e=Je();if(!e){u("Missing record ID","error");return}if(n.tab==="tickets"){let o=ge();if(!o){u("Add a comment first.","error");return}if((await w("/tickets/action",{method:"POST",body:JSON.stringify({action:"add_note",requestId:e,note:o})})).ok){u("Comment added");let l=H("notes");l&&(l.value=""),await Nt(e)}else u("Comment failed","error");return}let t=ge();if(n.tab==="orders"&&a.discountType){let o=a.discountType.value||"none",l=a.discountPercent?.value?.trim()||"";if(o!=="none"){let s=`DISCOUNT: ${o}${l?` ${l}%`:""} (internal)`;if(!t.includes(s)){t=t?`${t}
${s}`:s;let d=H("notes");d&&(d.value=t)}}}let i={action:"edit",notes:t};n.tab==="price-chart"||n.tab==="cost-chart"||n.tab==="diamond-price-chart"?i.rowNumber=e:i.requestId=e;let r=Ve();if(!r){u("No edits allowed.","error");return}(await w(r,{method:"POST",body:JSON.stringify(i)})).ok?(u("Notes saved"),pe({type:"notes",title:"Internal notes saved",detail:"Updated internal notes"}),await ye(n.selectedItem.request_id)):u("Notes failed","error")}async function Ra(){if(!n.selectedItem||!n.selectedItem.request_id){u("Missing request ID","error");return}let e=_a();if(!Object.keys(e).length){u("No fulfillment details to save.","error");return}let t={requestId:n.selectedItem.request_id,action:"edit",details:e};(await w("/orders/action",{method:"POST",body:JSON.stringify(t)})).ok?(u("Fulfillment details saved"),pe({type:"fulfillment",title:"Fulfillment details saved",detail:`${e.shipping_carrier||"Carrier"} / ${e.tracking_number||"No tracking"}`}),await Ma(n.selectedItem.request_id)):u("Fulfillment save failed","error")}async function Pn(){if(!n.selectedItem||!n.selectedItem.request_id){u("Missing request ID","error");return}let e=Et();if(!e.length){u("No order updates to confirm.","error");return}a.confirmSend.disabled=!0;try{let t=await w("/orders/confirm",{method:"POST",body:JSON.stringify({requestId:n.selectedItem.request_id,changes:e,email:n.selectedItem.email||"",name:n.selectedItem.name||"",productName:n.selectedItem.product_name||""})}),i=Ln(t);if(!t.ok||!i)throw new Error("confirmation_failed");let r=Cn(n.selectedItem,e,i);n.pendingChanges=e,n.confirmation={confirmationUrl:i,emailPayload:r,changes:e},An({to:n.selectedItem.email||"--",subject:r.subject,previewHtml:r.previewHtml})}catch{u("Unable to build confirmation email.","error")}finally{a.confirmSend.disabled=!1}}async function On(){if(!n.selectedItem||!n.selectedItem.request_id){u("Missing request ID","error");return}if(!Et().length){u("No order updates to confirm.","error");return}let e=n.confirmation;if(!e||!e.confirmationUrl){u("Open the confirmation preview first.","error");return}let t=e.emailPayload;if(!t){u("Confirmation email is missing.","error");return}let i=De(),r=ge(),o={requestId:n.selectedItem.request_id,action:"request_confirmation",status:"PENDING_CONFIRMATION",notes:r,fields:i};if(!(await w("/orders/action",{method:"POST",body:JSON.stringify(o)})).ok){u("Update failed before email.","error");return}(await w("/email",{method:"POST",body:JSON.stringify({to:n.selectedItem.email||"",subject:t.subject,textBody:t.textBody,htmlBody:t.htmlBody,requestId:n.selectedItem.request_id,orderStatus:"PENDING_CONFIRMATION"})})).ok?(u("Confirmation sent"),At(),await ye(n.selectedItem.request_id)):u("Email failed","error")}function Mn(){a.actionSelect&&a.actionSelect.addEventListener("change",()=>{ae()}),a.actionRun&&a.actionRun.addEventListener("click",()=>{let t=a.actionSelect?a.actionSelect.value:"";if(!t)return;if(n.tab==="quotes"){let r=et();if(r.blocked){u(r.reason||"Pricing not ready.","error");return}}let i=bn(t);i&&i.confirm&&!window.confirm(i.confirm)||n.criticalDirty&&!window.confirm("Proceed without saving critical edits?")||Tn(t)}),a.detailGrid&&a.detailGrid.addEventListener("click",t=>{let i=t.target;if(!(i instanceof HTMLElement))return;let r=i.closest("[data-carousel-prev]"),o=i.closest("[data-carousel-next]");if(!r&&!o)return;let l=i.closest("[data-media-carousel]");if(!l)return;let s=l.querySelector("[data-carousel-track]");if(!(s instanceof HTMLElement))return;let d=r?-1:1;s.scrollBy({left:s.clientWidth*d,behavior:"smooth"})}),a.editFields.forEach(t=>{let i=r=>{let o=t.dataset.field||"";if(o==="metal"&&(Wt(t.value),qt(a.quoteMetalInput?a.quoteMetalInput.value:"",t.value)),(o==="quote_discount_type"||o==="quote_discount_percent")&&Sa(),(o==="stone_weight"||o==="diamond_breakdown")&&kt(),o==="stone"&&Kt(),n.tab==="quotes"&&o)if(A.has(o)){let l=P.get(o);t.value?(ci(t),hi(l)):(t.dataset.manual="",t.dataset.auto="true",Q({optionIndex:l})),ht(l)}else z.has(o)?Q({baseChanged:!0}):P.has(o)&&Q({optionIndex:P.get(o)});if((o==="metal_weight"||o==="metal_weight_adjustment")&&(La(),Ea()),["price","quote_discount_type","quote_discount_percent"].includes(o)&&Oe(),n.selectedItem&&o&&(n.selectedItem[o]=t.value,ce(n.selectedItem)),r.type==="change"&&o){let l=t.dataset.activityValue||"",s=t.value.trim();if(l!==s){let d=t.closest(".field")?.querySelector("span")?.textContent?.trim()||o;pe({type:"edit",title:`${d} updated`,detail:`${l||"--"} -> ${s||"--"}`}),t.dataset.activityValue=s}}pn(),oe(),R(),ae()};t.addEventListener("input",i),t.addEventListener("change",i)}),[a.catalogFieldsBasic,a.catalogFieldsTaxonomy,a.catalogFieldsMaterials,a.catalogFieldsAudit,a.catalogFields].filter(Boolean).forEach(t=>{["input","change"].forEach(i=>{t.addEventListener(i,()=>{oe(),R(),ae()})})}),a.catalogTabs.length&&a.catalogTabs.forEach(t=>{t.addEventListener("click",()=>{oa(t.dataset.catalogTab||h)})}),a.mediaUpload&&a.mediaUpload.addEventListener("click",()=>{an()}),a.mediaLink&&a.mediaLink.addEventListener("click",()=>{tn()}),a.mediaId&&a.mediaId.addEventListener("change",()=>{sa(a.mediaId.value||"")}),a.mediaDetailGenerate&&a.mediaDetailGenerate.addEventListener("click",async()=>{let t=String(n.selectedItem?.media_id||n.selectedItem?.id||"").trim();if(!t){u("Missing media ID.","error");return}a.mediaDetailGenerate.disabled=!0,a.mediaDetailGenerate.textContent="Generating...";try{let i=await w("/media/describe",{method:"POST",body:JSON.stringify({media_id:t})});if(!i?.ok){u(i?.error||"Failed to generate description.","error");return}let r=Ai();r&&(r.value=i.description||"",r.dispatchEvent(new Event("input",{bubbles:!0}))),R(),u("Description generated. Review and save updates.","success")}catch(i){console.error(i),u("Failed to generate description.","error")}finally{a.mediaDetailGenerate.disabled=!1,a.mediaDetailGenerate.textContent="Generate description"}}),a.catalogMediaList&&a.catalogMediaList.addEventListener("click",t=>{let i=t.target;if(!(i instanceof HTMLElement))return;let r=i.closest(".catalog-media-item");if(i.hasAttribute("data-media-save")){let o=i.dataset.mappingId||"";if(o){if(!r){u("Unable to locate media row.","error");return}nn(o,r)}else u("Missing media mapping id.","error")}if(i.hasAttribute("data-media-delete")){let o=i.dataset.mappingId||"";o?on(o):u("Missing media mapping id.","error")}if(i.hasAttribute("data-media-describe")){let o=i.dataset.mediaId||"";if(!o){u("Missing media id.","error");return}rn(o,r)}}),a.catalogStoneList&&a.catalogStoneList.addEventListener("click",t=>{let i=t.target;if(!(i instanceof HTMLElement))return;let r=i.closest("[data-stone-option-id]");if(r){if(i.hasAttribute("data-stone-save")){Di(r);return}i.hasAttribute("data-stone-delete")&&zi(r)}}),a.stoneAddButton&&a.stoneAddButton.addEventListener("click",()=>{Mi()}),a.catalogMetalList&&a.catalogMetalList.addEventListener("click",t=>{let i=t.target;if(!(i instanceof HTMLElement))return;let r=i.closest("[data-metal-option-id]");if(r){if(i.hasAttribute("data-metal-save")){Gi(r);return}i.hasAttribute("data-metal-delete")&&Vi(r)}}),a.metalAddButton&&a.metalAddButton.addEventListener("click",()=>{Wi()}),a.catalogNotesSection&&a.catalogNotesSection.addEventListener("click",t=>{let i=t.target;if(!(i instanceof HTMLElement))return;if(i.hasAttribute("data-note-save")){let o=i.dataset.noteSave||"";o&&Qi(o);return}if(i.hasAttribute("data-note-add")){let o=i.dataset.noteAdd||"";o&&Zi(o);return}let r=i.closest("[data-note-id]");if(r){if(i.hasAttribute("data-note-row-save")){Xi(r);return}i.hasAttribute("data-note-row-delete")&&Yi(r)}}),a.quoteMetals.forEach(t=>{t.addEventListener("change",()=>{va(),R()})}),a.optionActiveToggles.forEach((t,i)=>{t.addEventListener("change",()=>{Qt(i,t.checked),oe(),R(),Q({optionIndex:i})})}),a.optionRecommendRadios.forEach((t,i)=>{t.addEventListener("change",()=>{t.checked&&(n.recommendedOptionIndex=i,yt())})}),a.optionCopyButtons.forEach(t=>{t.addEventListener("click",()=>{let i=Number(t.dataset.optionCopy),r=fe(i),o=r?r.value.trim():"";Le(`Option ${i+1} price`,o)})}),a.optionAutoButtons.forEach(t=>{t.addEventListener("click",()=>{let i=Number(t.dataset.optionAuto),r=fe(i);r&&(r.dataset.manual="",r.dataset.auto="true",r.value=""),W(i,"stale"),Q({optionIndex:i})})}),a.breakdownRawToggle&&a.breakdownRaw&&a.breakdownRawToggle.addEventListener("click",()=>{a.breakdownRaw.classList.toggle("is-hidden")}),a.diamondBreakdownAdd&&a.diamondBreakdownAdd.addEventListener("click",()=>{let t=Ie(),i=me();i.push({weight:"",count:"",stoneType:t}),We(i),Q({baseChanged:!0})}),a.diamondBreakdownRows&&(a.diamondBreakdownRows.addEventListener("input",t=>{t.target instanceof HTMLInputElement&&(!t.target.hasAttribute("data-diamond-weight")&&!t.target.hasAttribute("data-diamond-count")||(He(),$e(me()),Vt(),R(),Q({baseChanged:!0})))}),a.diamondBreakdownRows.addEventListener("change",t=>{let i=t.target;i instanceof HTMLElement&&i.hasAttribute("data-diamond-type")&&(He(),$e(me()),R(),Q({baseChanged:!0}))}),a.diamondBreakdownRows.addEventListener("click",t=>{let i=t.target;if(!(i instanceof HTMLElement)||!i.hasAttribute("data-diamond-remove"))return;let r=i.closest("[data-diamond-row]");r&&r.remove(),He(),$e(me()),Vt(),R(),Q({baseChanged:!0}),a.diamondBreakdownRows.querySelector("[data-diamond-row]")||We([])})),a.missingList&&a.missingList.addEventListener("click",t=>{let i=t.target;if(!(i instanceof HTMLElement))return;let r=i.dataset.focusTarget;r&&Ka(r)}),a.diamondPresets&&a.diamondPresets.addEventListener("change",()=>{di(a.diamondPresets.value),Q({baseChanged:!0}),R()}),a.discountType&&a.discountType.addEventListener("change",()=>{Oe(),Q({baseChanged:!0}),R()}),a.discountPercent&&a.discountPercent.addEventListener("input",()=>{Oe(),Q({baseChanged:!0}),R()}),a.orderDetailsFields.forEach(t=>{["input","change"].forEach(i=>{t.addEventListener(i,r=>{if(cn(t),r.type==="change"){let o=t.dataset.activityValue||"",l=t.value.trim();if(o!==l){let s=t.closest(".field")?.querySelector("span")?.textContent?.trim()||t.dataset.orderDetailsField||"Fulfillment update";pe({type:"edit",title:`${s} updated`,detail:`${o||"--"} -> ${l||"--"}`}),t.dataset.activityValue=l}}})})}),Qa(a.orderDetailsSection,()=>{oe(),Me()}),a.openTracking&&a.openTracking.addEventListener("click",()=>{let t=de("tracking_url");t&&window.open(t,"_blank")});let e=mt();e&&e.addEventListener("input",()=>{Be||(Jt(),R(),Q({baseChanged:!0}))}),[a.sizeRing,a.sizeBracelet,a.sizeChain].forEach(t=>{t&&["input","change"].forEach(i=>{t.addEventListener(i,()=>{ct(),Q({baseChanged:!0}),R(),n.selectedItem&&ce(n.selectedItem)})})}),a.primaryAction&&a.primaryAction.addEventListener("click",()=>{if(n.tab!=="orders"){Da();return}n.criticalDirty&&!window.confirm("Proceed without saving critical edits?")||Pn()}),a.notesSave&&a.notesSave.addEventListener("click",()=>{window.confirm("Save internal notes?")&&za()}),a.noteTimestamp&&a.noteTimestamp.addEventListener("click",()=>{yn(),R()}),a.noteTemplate&&a.noteTemplate.addEventListener("click",()=>{hn(),R()}),a.noteTags.forEach(t=>{t.addEventListener("click",()=>{Ct(`${t.dataset.noteTag} `),R()})}),a.copyCustomer&&a.copyCustomer.addEventListener("click",()=>Le("Customer name",a.summaryCustomer?.textContent?.trim())),a.copyEmail&&a.copyEmail.addEventListener("click",()=>Le("Email",a.summaryEmail?.textContent?.trim())),a.copyPhone&&a.copyPhone.addEventListener("click",()=>Le("Phone",a.summaryPhone?.textContent?.trim())),a.copyAddress&&a.copyAddress.addEventListener("click",()=>Le("Address",a.summaryAddress?.textContent?.trim())),a.copySummary&&a.copySummary.addEventListener("click",()=>{let t=fn(n.selectedItem);Le("Order summary",t)}),a.goldRefresh&&a.goldRefresh.addEventListener("click",async()=>{a.goldRefresh.disabled=!0,a.goldRefresh.textContent="Refreshing...";try{let t=await w("/cost-chart/gold-refresh",{method:"POST"});if(t.ok){let i=document.querySelector('[data-field="value"]'),r=document.querySelector('[data-field="notes"]');i&&t.value!==void 0&&(i.value=t.value,Aa()),r&&t.notes!==void 0&&(r.value=t.notes||"",Aa()),u("Gold price refreshed. Review and click Save.")}else u(t.error||"Failed to refresh gold price","error")}catch{u("Failed to refresh gold price","error")}finally{a.goldRefresh.textContent="Refresh gold price",a.goldRefresh.disabled=!1}}),a.detailsSave&&a.detailsSave.addEventListener("click",()=>{window.confirm("Save fulfillment details?")&&Ra()}),document.addEventListener("keydown",t=>{if((t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="s"){t.preventDefault();let i=document.activeElement;i&&i.closest("[data-order-details-section]")?Ra():I.has(n.tab)?Da():za()}}),a.confirmClose&&a.confirmClose.addEventListener("click",At),a.confirmModal&&a.confirmModal.addEventListener("click",t=>{t.target===a.confirmModal&&At()}),a.confirmSend&&a.confirmSend.addEventListener("click",()=>{n.criticalDirty&&!window.confirm("Proceed without saving critical edits?")||window.confirm("Send confirmation to customer?")&&On()})}async function Dn(){let e=new URLSearchParams(window.location.search),t=document.body.dataset.detailTab||"",i=e.get("tab")||t,r=e.get("id");if(!i||!r)try{let o=localStorage.getItem("adminDetailTab")||"",l=localStorage.getItem("adminDetailId")||"";if(!i&&o&&!t&&(i=o),!r&&l&&(r=l),(i||r)&&!t){let s=new URLSearchParams(window.location.search);i&&s.set("tab",i),r&&s.set("id",r);let d=`${window.location.pathname}?${s.toString()}`;window.history.replaceState({},"",d)}}catch{}if(i&&b[i]&&(n.tab=i),a.backLink&&(a.backLink.href=`/?tab=${encodeURIComponent(n.tab)}`),Mn(),await Nn(),r==="new"&&(S.has(n.tab)||I.has(n.tab))){n.isNewRow=!0,I.has(n.tab)?(await xn(),await Oa({})):await Pa({}),ke("New row");return}n.isNewRow=!1,await ye(r)}Dn()})();function p({ui:n,apiFetch:b,showToast:T}){let M=h=>{h&&Object.entries(h).forEach(([g,A])=>{let z=document.querySelector(`[data-count-${g}]`);if(!z)return;let P=Number(A)||0;z.textContent=String(P),z.style.display=P>0?"inline-flex":"none"})},f=async()=>{try{let h=await b("/navigation/counts");M(h||{})}catch(h){if(h?.status===404){M({});return}T("Failed to load sidebar counts.","error")}},L=()=>{f(),setInterval(f,3e4)},y=h=>{h.forEach(g=>{g.style.display="",g.classList.remove("search-highlight")}),document.querySelector(".side-search__no-results")?.remove()},q=(h,g)=>{let A=document.querySelector(".side-search__no-results");if(h&&!A){let z=document.querySelector(".side-search");if(!z)return;let P=document.createElement("div");P.className="side-search__no-results",P.innerHTML=`
        <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.3;margin-bottom:8px;">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <p>No sections matching<br/><strong>"${g}"</strong></p>
      `,z.after(P)}else!h&&A&&A.remove()},E=(h,g,A)=>{let z=!1;A.forEach(P=>{let he=Array.from(P.querySelectorAll(".side-link")),ze=!1;if(he.forEach(re=>{let Re=(re.querySelector(".side-link__label")?.textContent?.toLowerCase()||"").includes(h);re.style.display=Re?"":"none",Re?(re.classList.add("search-highlight"),ze=!0,z=!0):re.classList.remove("search-highlight")}),ze&&P.classList.contains("is-collapsed")){P.classList.remove("is-collapsed");let re=P.querySelector("[data-side-toggle]");re&&(re.textContent="-")}}),q(!z,h)},k=()=>{let h=n.sidebarSearch;if(!h)return;let g=Array.from(document.querySelectorAll(".side-link")),A=Array.from(document.querySelectorAll(".side-block"));h.addEventListener("input",z=>{let P=String(z.target.value||"").toLowerCase().trim();if(!P){y(g);return}E(P,g,A)}),h.addEventListener("keydown",z=>{z.key==="Escape"&&(h.value="",h.dispatchEvent(new Event("input")),h.blur())})},S=()=>{let h=Array.from(document.querySelectorAll(".side-link")),g=h.findIndex(A=>A.classList.contains("is-active"));g<0&&(g=0),document.addEventListener("keydown",A=>{if(!A.target.matches("input, textarea, select")){if((A.metaKey||A.ctrlKey)&&A.key.toLowerCase()==="k"){A.preventDefault(),n.sidebarSearch?.focus(),n.sidebarSearch?.select();return}if(A.altKey&&A.key>="1"&&A.key<="9"){A.preventDefault();let z=Number(A.key)-1;h[z]&&(h[z].click(),h[z].focus());return}A.altKey&&(A.key==="ArrowUp"||A.key==="ArrowDown")&&(A.preventDefault(),A.key==="ArrowUp"?g=g>0?g-1:h.length-1:g=g<h.length-1?g+1:0,h[g].click(),h[g].focus())}})},I=()=>{n.sidebar&&(n.sidebar.classList.remove("is-collapsed"),n.appShell?.classList.remove("sidebar-collapsed"))},ne=()=>{document.querySelectorAll("[data-side-toggle]").forEach(h=>{h.addEventListener("click",()=>{let g=h.closest(".side-block");if(!g)return;let A=g.classList.toggle("is-collapsed");h.textContent=A?"+":"-";let z=g.dataset.blockId;if(z){let P=JSON.parse(localStorage.getItem("sidebar-collapsed-blocks")||"[]");if(A)P.includes(z)||P.push(z);else{let he=P.indexOf(z);he>-1&&P.splice(he,1)}localStorage.setItem("sidebar-collapsed-blocks",JSON.stringify(P))}})}),JSON.parse(localStorage.getItem("sidebar-collapsed-blocks")||"[]").forEach(h=>{let g=document.querySelector(`[data-block-id="${h}"]`);if(g&&!g.classList.contains("is-collapsed")){g.classList.add("is-collapsed");let A=g.querySelector("[data-side-toggle]");A&&(A.textContent="+")}})};return{initSidebar:()=>{I(),k(),S(),ne(),L(),console.log("Sidebar initialized")},updateNavigationCounts:M}}function U(n){return function(b,T){n&&(n.textContent=b,n.classList.add("is-visible"),T==="error"?n.style.background="#b42318":n.style.background="var(--ink)",setTimeout(()=>n.classList.remove("is-visible"),2400))}}function B({ui:n,apiFetch:b,showToast:T,windowRef:M}){let f=[],L=k=>{n.notificationsPanel&&(n.notificationsPanel.classList.toggle("is-open",k),n.notificationsPanel.setAttribute("aria-hidden",k?"false":"true"),k?n.notificationsPanel.removeAttribute("inert"):n.notificationsPanel.setAttribute("inert",""))},y=()=>{if(!n.notificationsList)return;if(!f.length){n.notificationsList.innerHTML='<p class="muted">No notifications right now.</p>',n.notificationsBadge&&(n.notificationsBadge.textContent="",n.notificationsBadge.classList.add("is-hidden"));return}let k=f.filter(S=>!S.read).length;n.notificationsBadge&&(n.notificationsBadge.textContent=k?String(k):"",n.notificationsBadge.classList.toggle("is-hidden",k===0)),n.notificationsList.innerHTML=f.map(S=>{let I=S.title||S.type||"Update",ne=S.message||S.body||"",h=S.created_at||S.createdAt||"";return`
          <button class="notification-item ${S.read?"":"is-unread"}" type="button" data-notification-id="${S.id||""}">
            <div class="notification-title">${I}</div>
            <div class="notification-body">${ne}</div>
            <div class="notification-meta">${h}</div>
          </button>
        `}).join("")},q=async()=>{try{let k=await b("/notifications");f=Array.isArray(k?.items)?k.items:k||[],y()}catch(k){if(k?.status===404){f=[],y();return}f=[],y(),M.location.hostname==="localhost"&&T("Notifications unavailable.","error")}},E=async k=>{if(k)try{await b(`/notifications/${k}/read`,{method:"POST"}),f=f.map(S=>String(S.id)===String(k)?{...S,read:!0}:S),y()}catch{T("Failed to mark notification read.","error")}};return{bindNotifications:()=>{n.notificationsToggle&&n.notificationsToggle.addEventListener("click",()=>{let k=n.notificationsPanel?.classList.contains("is-open");L(!k),k||q()}),n.notificationsClose&&n.notificationsClose.addEventListener("click",()=>L(!1)),n.notificationsList&&n.notificationsList.addEventListener("click",k=>{let S=k.target.closest("[data-notification-id]");S&&E(S.dataset.notificationId)})},loadNotifications:q}}function D(){return typeof window>"u"?"":localStorage.getItem("adminApiBase")||""||document.body.dataset.apiBase||""}function j(){if(typeof window>"u")return"";let n=window.location.origin||"";if(!n.startsWith("http://localhost")&&!n.startsWith("http://127.0.0.1"))return"";let b=localStorage.getItem("adminEmail")||"";if(b)return b;let T=new URLSearchParams(window.location.search),M=T.get("adminEmail")||T.get("admin_email")||"";return M&&M.includes("@")?(localStorage.setItem("adminEmail",M),M):""}function Z(){if(typeof window>"u")return"";try{return localStorage.getItem("adminEmail")||""}catch{return""}}function X(n={},b=""){let T={"Content-Type":"application/json",...n},M=b||j();return M&&(T["X-Admin-Email"]=M),T}async function ee(n,b={}){let T=D();if(!T)throw new Error("Missing API base");let M=T.endsWith("/")?T:`${T}/`,f=new URL(n.replace(/^\//,""),M),L=M.startsWith("http://localhost")||M.startsWith("http://127.0.0.1"),y=L?Z():j(),q=X(b.headers||{},y);L&&y&&f.searchParams.set("admin_email",y);let E=await fetch(f.toString(),{credentials:L?"omit":"include",headers:q,...b});if(!E.ok){let k=await E.text(),S=new Error(k||E.statusText);throw S.status=E.status,S}return await E.json()}var Y={orders:"Orders",quotes:"Quotes",tickets:"Tickets",contacts:"Contacts",products:"Products",inspirations:"Inspirations","media-library":"Media","cost-chart":"Cost Chart","diamond-price-chart":"Diamond Pricing"},ie=()=>{let n=document.querySelector("[data-sidebar]");if(!n)return;let b={sidebar:n,sidebarSearch:document.querySelector("[data-sidebar-search]"),appShell:document.querySelector(".app-shell"),notificationsToggle:document.querySelector("[data-notifications-toggle]"),notificationsPanel:document.querySelector("[data-notifications-panel]"),notificationsList:document.querySelector("[data-notifications-list]"),notificationsBadge:document.querySelector("[data-notifications-badge]"),notificationsClose:document.querySelector("[data-notifications-close]")},T=document.querySelector("[data-toast]"),M=U(T),{initSidebar:f,updateNavigationCounts:L}=p({ui:b,apiFetch:ee,showToast:M}),{bindNotifications:y}=B({ui:b,apiFetch:ee,showToast:M,windowRef:window}),q=document.body.dataset.detailTab||"",E=n.querySelector(`.side-link[data-tab="${q}"]`);E&&E.classList.add("is-active");let k=document.querySelector("[data-tab-title]");k&&(k.textContent=Y[q]||"Details"),n.querySelectorAll(".side-link[data-tab]").forEach(S=>{S.addEventListener("click",()=>{let I=S.dataset.tab||"";I&&(window.location.href=`/?tab=${encodeURIComponent(I)}`)})}),f(),y(),document.body.dataset.enableNavCounts!=="true"&&L({})};ie()})();function Ba({ui:p,apiFetch:U,showToast:B}){let D=f=>{f&&Object.entries(f).forEach(([L,y])=>{let q=document.querySelector(`[data-count-${L}]`);if(!q)return;let E=Number(y)||0;q.textContent=String(E),q.style.display=E>0?"inline-flex":"none"})},j=async()=>{try{let f=await U("/navigation/counts");D(f||{})}catch(f){if(f?.status===404){D({});return}B("Failed to load sidebar counts.","error")}},Z=()=>{j(),setInterval(j,3e4)},X=f=>{f.forEach(L=>{L.style.display="",L.classList.remove("search-highlight")}),document.querySelector(".side-search__no-results")?.remove()},ee=(f,L)=>{let y=document.querySelector(".side-search__no-results");if(f&&!y){let q=document.querySelector(".side-search");if(!q)return;let E=document.createElement("div");E.className="side-search__no-results",E.innerHTML=`
        <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.3;margin-bottom:8px;">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <p>No sections matching<br/><strong>"${L}"</strong></p>
      `,q.after(E)}else!f&&y&&y.remove()},Y=(f,L,y)=>{let q=!1;y.forEach(E=>{let k=Array.from(E.querySelectorAll(".side-link")),S=!1;if(k.forEach(I=>{let h=(I.querySelector(".side-link__label")?.textContent?.toLowerCase()||"").includes(f);I.style.display=h?"":"none",h?(I.classList.add("search-highlight"),S=!0,q=!0):I.classList.remove("search-highlight")}),S&&E.classList.contains("is-collapsed")){E.classList.remove("is-collapsed");let I=E.querySelector("[data-side-toggle]");I&&(I.textContent="-")}}),ee(!q,f)},ie=()=>{let f=p.sidebarSearch;if(!f)return;let L=Array.from(document.querySelectorAll(".side-link")),y=Array.from(document.querySelectorAll(".side-block"));f.addEventListener("input",q=>{let E=String(q.target.value||"").toLowerCase().trim();if(!E){X(L);return}Y(E,L,y)}),f.addEventListener("keydown",q=>{q.key==="Escape"&&(f.value="",f.dispatchEvent(new Event("input")),f.blur())})},n=()=>{let f=Array.from(document.querySelectorAll(".side-link")),L=f.findIndex(y=>y.classList.contains("is-active"));L<0&&(L=0),document.addEventListener("keydown",y=>{if(!y.target.matches("input, textarea, select")){if((y.metaKey||y.ctrlKey)&&y.key.toLowerCase()==="k"){y.preventDefault(),p.sidebarSearch?.focus(),p.sidebarSearch?.select();return}if(y.altKey&&y.key>="1"&&y.key<="9"){y.preventDefault();let q=Number(y.key)-1;f[q]&&(f[q].click(),f[q].focus());return}y.altKey&&(y.key==="ArrowUp"||y.key==="ArrowDown")&&(y.preventDefault(),y.key==="ArrowUp"?L=L>0?L-1:f.length-1:L=L<f.length-1?L+1:0,f[L].click(),f[L].focus())}})},b=()=>{p.sidebar&&(p.sidebar.classList.remove("is-collapsed"),p.appShell?.classList.remove("sidebar-collapsed"))},T=()=>{document.querySelectorAll("[data-side-toggle]").forEach(y=>{y.addEventListener("click",()=>{let q=y.closest(".side-block");if(!q)return;let E=q.classList.toggle("is-collapsed");y.textContent=E?"+":"-";let k=q.dataset.blockId;if(k){let S=JSON.parse(localStorage.getItem("sidebar-collapsed-blocks")||"[]");if(E)S.includes(k)||S.push(k);else{let I=S.indexOf(k);I>-1&&S.splice(I,1)}localStorage.setItem("sidebar-collapsed-blocks",JSON.stringify(S))}})}),JSON.parse(localStorage.getItem("sidebar-collapsed-blocks")||"[]").forEach(y=>{let q=document.querySelector(`[data-block-id="${y}"]`);if(q&&!q.classList.contains("is-collapsed")){q.classList.add("is-collapsed");let E=q.querySelector("[data-side-toggle]");E&&(E.textContent="+")}})};return{initSidebar:()=>{b(),ie(),n(),T(),Z(),console.log("Sidebar initialized")},updateNavigationCounts:D}}function ja(p){return function(B,D){p&&(p.textContent=B,p.classList.add("is-visible"),D==="error"?p.style.background="#b42318":p.style.background="var(--ink)",setTimeout(()=>p.classList.remove("is-visible"),2400))}}function Ua({ui:p,apiFetch:U,showToast:B,windowRef:D}){let j=[],Z=n=>{p.notificationsPanel&&(p.notificationsPanel.classList.toggle("is-open",n),p.notificationsPanel.setAttribute("aria-hidden",n?"false":"true"),n?p.notificationsPanel.removeAttribute("inert"):p.notificationsPanel.setAttribute("inert",""))},X=()=>{if(!p.notificationsList)return;if(!j.length){p.notificationsList.innerHTML='<p class="muted">No notifications right now.</p>',p.notificationsBadge&&(p.notificationsBadge.textContent="",p.notificationsBadge.classList.add("is-hidden"));return}let n=j.filter(b=>!b.read).length;p.notificationsBadge&&(p.notificationsBadge.textContent=n?String(n):"",p.notificationsBadge.classList.toggle("is-hidden",n===0)),p.notificationsList.innerHTML=j.map(b=>{let T=b.title||b.type||"Update",M=b.message||b.body||"",f=b.created_at||b.createdAt||"";return`
          <button class="notification-item ${b.read?"":"is-unread"}" type="button" data-notification-id="${b.id||""}">
            <div class="notification-title">${T}</div>
            <div class="notification-body">${M}</div>
            <div class="notification-meta">${f}</div>
          </button>
        `}).join("")},ee=async()=>{try{let n=await U("/notifications");j=Array.isArray(n?.items)?n.items:n||[],X()}catch(n){if(n?.status===404){j=[],X();return}j=[],X(),D.location.hostname==="localhost"&&B("Notifications unavailable.","error")}},Y=async n=>{if(n)try{await U(`/notifications/${n}/read`,{method:"POST"}),j=j.map(b=>String(b.id)===String(n)?{...b,read:!0}:b),X()}catch{B("Failed to mark notification read.","error")}};return{bindNotifications:()=>{p.notificationsToggle&&p.notificationsToggle.addEventListener("click",()=>{let n=p.notificationsPanel?.classList.contains("is-open");Z(!n),n||ee()}),p.notificationsClose&&p.notificationsClose.addEventListener("click",()=>Z(!1)),p.notificationsList&&p.notificationsList.addEventListener("click",n=>{let b=n.target.closest("[data-notification-id]");b&&Y(b.dataset.notificationId)})},loadNotifications:ee}}function zn(){return typeof window>"u"?"":localStorage.getItem("adminApiBase")||""||document.body.dataset.apiBase||""}function Ha(){if(typeof window>"u")return"";let p=window.location.origin||"";if(!p.startsWith("http://localhost")&&!p.startsWith("http://127.0.0.1"))return"";let U=localStorage.getItem("adminEmail")||"";if(U)return U;let B=new URLSearchParams(window.location.search),D=B.get("adminEmail")||B.get("admin_email")||"";return D&&D.includes("@")?(localStorage.setItem("adminEmail",D),D):""}function Rn(){if(typeof window>"u")return"";try{return localStorage.getItem("adminEmail")||""}catch{return""}}function Fn(p={},U=""){let B={"Content-Type":"application/json",...p},D=U||Ha();return D&&(B["X-Admin-Email"]=D),B}async function It(p,U={}){let B=zn();if(!B)throw new Error("Missing API base");let D=B.endsWith("/")?B:`${B}/`,j=new URL(p.replace(/^\//,""),D),Z=D.startsWith("http://localhost")||D.startsWith("http://127.0.0.1"),X=Z?Rn():Ha(),ee=Fn(U.headers||{},X);Z&&X&&j.searchParams.set("admin_email",X);let Y=await fetch(j.toString(),{credentials:Z?"omit":"include",headers:ee,...U});if(!Y.ok){let ie=await Y.text(),n=new Error(ie||Y.statusText);throw n.status=Y.status,n}return await Y.json()}var Bn={orders:"Orders",quotes:"Quotes",tickets:"Tickets",contacts:"Contacts",products:"Products",inspirations:"Inspirations","media-library":"Media","cost-chart":"Cost Chart","diamond-price-chart":"Diamond Pricing"},jn=()=>{let p=document.querySelector("[data-sidebar]");if(!p)return;let U={sidebar:p,sidebarSearch:document.querySelector("[data-sidebar-search]"),appShell:document.querySelector(".app-shell"),notificationsToggle:document.querySelector("[data-notifications-toggle]"),notificationsPanel:document.querySelector("[data-notifications-panel]"),notificationsList:document.querySelector("[data-notifications-list]"),notificationsBadge:document.querySelector("[data-notifications-badge]"),notificationsClose:document.querySelector("[data-notifications-close]")},B=document.querySelector("[data-toast]"),D=ja(B),{initSidebar:j,updateNavigationCounts:Z}=Ba({ui:U,apiFetch:It,showToast:D}),{bindNotifications:X}=Ua({ui:U,apiFetch:It,showToast:D,windowRef:window}),ee=document.body.dataset.detailTab||"",Y=p.querySelector(`.side-link[data-tab="${ee}"]`);Y&&Y.classList.add("is-active");let ie=document.querySelector("[data-tab-title]");ie&&(ie.textContent=Bn[ee]||"Details"),p.querySelectorAll(".side-link[data-tab]").forEach(n=>{n.addEventListener("click",()=>{let b=n.dataset.tab||"";b&&(window.location.href=`/?tab=${encodeURIComponent(b)}`)})}),j(),X(),document.body.dataset.enableNavCounts!=="true"&&Z({})};jn();})();
