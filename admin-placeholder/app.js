"use strict";(()=>{var me="dashboard",et=new Set(["orders","quotes","tickets","products"]),A={tab:me,role:"",email:"",items:[],total:0,offset:0,limit:50,selectedId:"",selectedItem:null,selectedItems:[],originalValues:{},originalRaw:{},originalNotes:"",orderDetails:{},pendingChanges:[],confirmation:null,filters:{q:"",status:"",date_range:"",sort:"created_at",dir:"desc"}};function pe(){return typeof window>"u"?"":localStorage.getItem("adminApiBase")||""||document.body.dataset.apiBase||""}function oe(){if(typeof window>"u")return"";let e=window.location.origin||"";if(!e.startsWith("http://localhost")&&!e.startsWith("http://127.0.0.1"))return"";let t=localStorage.getItem("adminEmail")||"";if(t)return t;let o=new URLSearchParams(window.location.search),r=o.get("adminEmail")||o.get("admin_email")||"";return r&&r.includes("@")?(localStorage.setItem("adminEmail",r),r):""}function Ee(){if(typeof window>"u")return"";try{return localStorage.getItem("adminEmail")||""}catch{return""}}function Le(e={},t=""){let o={"Content-Type":"application/json",...e},r=t||oe();return r&&(o["X-Admin-Email"]=r),o}async function Q(e,t={}){let o=pe();if(!o)throw new Error("Missing API base");let r=o.endsWith("/")?o:`${o}/`,s=new URL(e.replace(/^\//,""),r),S=r.startsWith("http://localhost")||r.startsWith("http://127.0.0.1"),h=S?Ee():oe(),v=Le(t.headers||{},h);S&&h&&s.searchParams.set("admin_email",h);let d=await fetch(s.toString(),{credentials:S?"omit":"include",headers:v,...t});if(!d.ok){let p=await d.text(),f=new Error(p||d.statusText);throw f.status=d.status,f}return await d.json()}function tt(e){return function(o,r){e&&(e.textContent=o,e.classList.add("is-visible"),r==="error"?e.style.background="#b42318":e.style.background="var(--ink)",setTimeout(()=>e.classList.remove("is-visible"),2400))}}function rt({state:e,ui:t,listColumns:o,isBulkEnabled:r,canEditCurrentTab:s,getValue:S,getItemKey:h,escapeAttribute:v,normalizeImageUrl:d=p=>p}){function p(){if(!t.listHeader)return;let l=o[e.tab];if(!l)return;let m=r(),y=[];m&&y.push("44px"),y.push(...l.map(g=>g.key==="view"||g.key==="delete"?"90px":e.tab==="media-library"&&g.key==="url"?"minmax(200px, 2fr)":"minmax(120px, 1fr)"));let b=y.join(" ");t.listHeader.style.gridTemplateColumns=b;let w=[];if(m){let g=e.items.length>0&&e.selectedItems.length===e.items.length;w.push(`<div class="cell"><input type="checkbox" class="bulk-select" data-bulk-select-all ${g?"checked":""} /></div>`)}w.push(...l.map(g=>`<div>${g.label||""}</div>`)),t.listHeader.innerHTML=w.join("")}function f(){if(p(),!t.list)return;let l=e.tab==="cost-chart"||e.tab==="diamond-price-chart",m=new Set(["value","weight_min","weight_max","price_per_ct","row_number"]),y={tab:e.tab,hasColumns:Array.isArray(o[e.tab]),getValue:typeof S,getItemKey:typeof h,escapeAttribute:typeof v,isBulkEnabled:typeof r,canEditCurrentTab:typeof s};if(y.getValue!=="function"||y.getItemKey!=="function")throw console.error("List renderer miswired",y),new Error("List renderer miswired");if(!Array.isArray(e.items)){console.error("List items not array",{tab:e.tab,items:e.items}),t.list.innerHTML='<div class="list-row"><div class="cell">No results</div></div>',t.results.textContent="0 results";return}if(!e.items.length){t.list.innerHTML='<div class="list-row"><div class="cell">No results</div></div>',t.results.textContent="0 results";return}let b=o[e.tab]||[],w=r(),g=[];w&&g.push("44px"),g.push(...b.map(a=>a.key==="view"||a.key==="delete"?"90px":e.tab==="media-library"&&a.key==="url"?"minmax(200px, 2fr)":"minmax(120px, 1fr)"));let i=g.join(" ");try{t.list.innerHTML=e.items.map(a=>{let u=h(a),k=u||a.slug||a.id||a.request_id||a.email||a.row_number||a.media_id||"",q=[];if(w){let C=e.selectedItems.includes(u);q.push(`<div class="cell"><input type="checkbox" class="bulk-select" data-bulk-select-item="${v(u)}" ${C?"checked":""} /></div>`)}q.push(...b.map(C=>{if(C.key==="view"){let N=u?"":"disabled";return l&&s()?`<div class="cell inline-actions">
                    <button class="btn btn-ghost btn-small" data-inline-edit="${u}" ${N}>Edit</button>
                    <button class="btn btn-ghost btn-small" data-view="${u}" ${N}>View</button>
                  </div>`:`<div class="cell"><button class="btn btn-ghost" data-view="${u}" ${N}>View</button></div>`}if(C.key==="delete"){let N=s()?"":"disabled";return`<div class="cell"><button class="btn btn-ghost" data-delete="${u}" ${N}>Delete</button></div>`}if(C.key==="status"){let N=a.status||"NEW";return`<div class="cell"><span class="cell-label">${C.label}</span><span class="badge" data-status="${N}">${N}</span></div>`}if(e.tab==="media-library"&&C.key==="url"){let N=a.url||a.media_url||a.href||S(a,C.key),E=d(N||""),n=String(a.media_type||a.type||"").toLowerCase().includes("video")||/\.(mp4|webm|mov)$/i.test(E);return E?n?`<div class="cell media-thumb-cell"><span class="cell-label">${C.label}</span><div class="media-thumb media-thumb--video">Video</div></div>`:`<div class="cell media-thumb-cell"><span class="cell-label">${C.label}</span><img class="media-thumb" src="${v(E)}" alt="${v(a.label||a.media_id||"Media")}"></div>`:`<div class="cell"><span class="cell-label">${C.label}</span><span class="cell-muted">No preview</span></div>`}let P=S(a,C.key);if(l&&s()){let N=a.row_number??a.id??a.request_id??"",E=m.has(C.key)?"number":"text",I=C.key==="price_per_ct"||C.key==="value"?"0.01":"1";return`<div class="cell"><span class="cell-label">${C.label}</span><span class="inline-value" data-inline-display>${P}</span><input class="inline-input is-hidden" type="${E}" step="${I}" data-inline-field="${v(C.key)}" data-row-number="${v(N)}" value="${v(P)}" /></div>`}return`<div class="cell"><span class="cell-label">${C.label}</span><span>${P}</span></div>`}));let $=w&&e.selectedItems.includes(u)?"list-row is-selected":"list-row",T=l?' data-inline-row="true"':"";return`<div class="${$}" data-row="${v(k)}" data-slug="${v(a.slug||"")}" data-id="${v(a.id||"")}" style="grid-template-columns:${i}"${T}>${q.join("")}</div>`}).join("")}catch(a){throw console.error("List render failure",{error:a,debugInfo:y,columns:b,items:e.items}),a}t.results.textContent=`Showing ${e.items.length} of ${e.total}`}return{renderHeader:p,renderList:f}}function nt({state:e,ui:t,statusOptions:o,sortOptions:r,sortDefaults:s,isDashboardTab:S,getOrderStatusOptions:h,normalizeStatus:v}){function d(){if(!t.statusSelect)return;let l=v(e.selectedItem?.status),m=e.tab==="orders"?h():(o[e.tab]||[]).filter(y=>y!==l);m.length?t.statusSelect.innerHTML=m.map(y=>`<option value="${y}">${y}</option>`).join(""):t.statusSelect.innerHTML='<option value="">No status actions</option>'}function p(){let l=t.filters.find(w=>w.dataset.filter==="sort");if(!l)return;let m=r[e.tab]||r.orders,y=s[e.tab]||s.orders;m.map(w=>w.value).includes(e.filters.sort)||(e.filters.sort=y.sort),["asc","desc"].includes(e.filters.dir)||(e.filters.dir=y.dir),l.innerHTML=m.map(w=>`<option value="${w.value}">${w.label}</option>`).join(""),l.value=e.filters.sort}function f(){if(!t.filtersWrap)return;let l=t.filtersWrap.querySelector("[data-filter-status]"),m=t.filters.find(w=>w.dataset.filter==="status");if(!l||!m)return;let y=o[e.tab]||[];if(S()||!y.length){l.classList.add("is-hidden"),m.value="",e.filters.status="";return}l.classList.remove("is-hidden");let b=e.filters.status||"";m.innerHTML='<option value="">All statuses</option>'+y.map(w=>`<option value="${w}">${w}</option>`).join(""),m.value=y.includes(b)?b:"",e.filters.status=m.value}return{updateStatusOptions:d,updateSortOptions:p,updateStatusFilterOptions:f}}function at({ui:e,escapeHtml:t}){let o=()=>{e.drawer&&(e.drawer.classList.remove("is-open"),e.drawer.setAttribute("aria-hidden","true"),e.drawer.inert=!0,document.activeElement&&e.drawer.contains(document.activeElement)&&document.activeElement.blur())},r=()=>{if(!e.drawer)return;e.drawer.inert=!1,e.drawer.classList.add("is-open"),e.drawer.setAttribute("aria-hidden","false");let d=e.drawer.querySelector("button, [href], input, select, textarea, [tabindex]:not([tabindex='-1'])");d&&typeof d.focus=="function"&&d.focus({preventScroll:!0})},s=(d,p)=>d==="Images"?`<div class="detail-media"><span>${d}</span>${p}</div>`:`<div><span>${d}</span>${p}</div>`,S=(d,p)=>d.filter(([,f])=>p(f)).map(([f,l])=>s(f,l)).join("");return{closeDrawer:o,openDrawer:r,renderDetailRows:S,renderDetailSections:(d,p)=>d.map(f=>{let l=S(f.rows||[],p);return l?`<div class="detail-section">
          <p class="detail-section-title">${t(f.title)}</p>
          <div class="detail-grid">${l}</div>
        </div>`:""}).join(""),bindDrawerEvents:()=>{e.drawerClose&&e.drawerClose.addEventListener("click",o),e.drawer&&e.drawer.addEventListener("click",d=>{d.target===e.drawer&&o()}),e.detailGrid&&e.detailGrid.addEventListener("click",d=>{let p=d.target;if(!(p instanceof HTMLElement))return;let f=p.closest("[data-carousel-prev]"),l=p.closest("[data-carousel-next]");if(!f&&!l)return;let m=p.closest("[data-media-carousel]");if(!m)return;let y=m.querySelector("[data-carousel-track]");if(!(y instanceof HTMLElement))return;let b=f?-1:1;y.scrollBy({left:y.clientWidth*b,behavior:"smooth"})})}}}function ot({ui:e,loadCurrentView:t,closeDrawer:o}){function r(){if(document.querySelector(".shortcuts-modal"))return;let s=document.createElement("div");s.className="shortcuts-modal",s.innerHTML=`
      <div class="modal-card">
        <div class="modal-header">
          <h2>Keyboard Shortcuts</h2>
          <button class="btn btn-ghost" data-shortcuts-close type="button">Close</button>
        </div>
        <div class="shortcuts-list">
          <div class="shortcut-item"><kbd>Cmd/Ctrl + K</kbd><span>Focus search</span></div>
          <div class="shortcut-item"><kbd>Cmd/Ctrl + R</kbd><span>Refresh</span></div>
          <div class="shortcut-item"><kbd>Cmd/Ctrl + N</kbd><span>Add row (catalog)</span></div>
          <div class="shortcut-item"><kbd>Esc</kbd><span>Close drawer</span></div>
          <div class="shortcut-item"><kbd>\u2190 \u2192</kbd><span>Navigate pages</span></div>
          <div class="shortcut-item"><kbd>?</kbd><span>Show shortcuts</span></div>
        </div>
      </div>
    `,s.addEventListener("click",S=>{S.target===s&&s.remove()}),s.querySelector("[data-shortcuts-close]").addEventListener("click",()=>s.remove()),document.body.appendChild(s)}document.addEventListener("keydown",s=>{if(s.target instanceof HTMLElement&&s.target.matches("input, textarea, select"))return;if(s.key==="?"){r();return}if(s.code==="Escape"){o();return}if(s.code==="ArrowLeft"){e.prev&&e.prev.click();return}if(s.code==="ArrowRight"){e.next&&e.next.click();return}if(s.metaKey||s.ctrlKey)switch(s.code){case"KeyK":{let h=e.filters.find(v=>v.dataset.filter==="q");h&&(s.preventDefault(),h.focus());break}case"KeyR":s.preventDefault(),t();break;case"KeyN":s.preventDefault(),e.addRowButton&&!e.addRowWrap?.classList.contains("is-hidden")&&e.addRowButton.click();break}})}function it({apiFetch:e,ui:t,setTab:o,escapeHtml:r}){async function s(){if(t.dashboard){t.dashboard.innerHTML='<div class="dashboard-section"><h3>Loading dashboard...</h3></div>';try{let h=await e("/dashboard/metrics");if(!h.ok){t.dashboard.innerHTML='<div class="dashboard-section"><h3>Unable to load dashboard.</h3></div>';return}t.dashboard.innerHTML=S(h),t.dashboard.querySelectorAll("[data-dashboard-tab]").forEach(v=>{v.addEventListener("click",()=>{let d=v.dataset.dashboardTab;d&&o(d)})})}catch{t.dashboard.innerHTML='<div class="dashboard-section"><h3>Unable to load dashboard.</h3></div>'}}}function S(h){let v=h.recentOrders||[],d=h.actionRequired||[];return`
      <div class="dashboard-grid">
        <div class="metric-card">
          <h3>Today's Activity</h3>
          <div class="metric-value">${h.todayOrders||0}</div>
          <div class="metric-label">New Orders</div>
        </div>
        <div class="metric-card">
          <h3>Pending Quotes</h3>
          <div class="metric-value">${h.pendingQuotes||0}</div>
          <div class="metric-label">Awaiting Response</div>
        </div>
        <div class="metric-card">
          <h3>This Month</h3>
          <div class="metric-value">${h.monthlyRevenue||0}</div>
          <div class="metric-label">Revenue</div>
        </div>
        <div class="metric-card">
          <h3>Alerts</h3>
          <div class="metric-value ${h.lowStockCount>0?"warning":""}">${h.lowStockCount||0}</div>
          <div class="metric-label">Low Stock Items</div>
        </div>
      </div>
      <div class="dashboard-section">
        <h3>Recent Orders</h3>
        <div class="quick-list">
          ${v.length?v.map(p=>`
            <div class="quick-item">
              <div>
                <strong>${r(p.product||p.requestId||"Order")}</strong>
                <div class="quick-meta">${r(p.requestId||"")}</div>
              </div>
              <div class="quick-meta">${r(p.status||"")}</div>
            </div>`).join(""):'<div class="quick-meta">No recent orders.</div>'}
        </div>
      </div>
      <div class="dashboard-section">
        <h3>Action Required</h3>
        <div class="quick-list">
          ${d.length?d.map(p=>`
            <div class="quick-item">
              <div>
                <strong>${r(p.label||p.requestId||"Item")}</strong>
                <div class="quick-meta">${r(p.requestId||"")}</div>
              </div>
              <div class="quick-meta">${r(p.status||"")}</div>
            </div>`).join(""):'<div class="quick-meta">No actions required.</div>'}
        </div>
      </div>
    `}return{loadDashboard:s}}function st({state:e,ui:t,apiFetch:o,getActionEndpoint:r,showToast:s,renderList:S,loadList:h,isBulkEnabled:v,clearSelection:d}){function p(){if(!t.bulkActions)return;if(!v()||!e.selectedItems.length){t.bulkActions.classList.add("is-hidden"),t.bulkActions.innerHTML="";return}let m=f(e.tab);t.bulkActions.classList.remove("is-hidden"),t.bulkActions.innerHTML=`
      <div class="bulk-info">
        <span>${e.selectedItems.length} selected</span>
        <button class="btn-link" data-bulk-clear type="button">Clear</button>
      </div>
      <div class="bulk-buttons">
        ${m.map(y=>`<button class="btn ${y.danger?"btn-danger":""}" data-bulk-action="${y.action}" type="button">${y.label}</button>`).join("")}
      </div>
    `}function f(m){return{orders:[{action:"acknowledge",label:"Acknowledge"},{action:"cancel",label:"Cancel"},{action:"delete",label:"Delete",danger:!0}],quotes:[{action:"acknowledge",label:"Acknowledge"},{action:"drop",label:"Drop"},{action:"delete",label:"Delete",danger:!0}],tickets:[{action:"mark_resolved",label:"Resolve"},{action:"delete",label:"Delete",danger:!0}],products:[{action:"delete",label:"Delete",danger:!0}]}[m]||[]}async function l(m){if(!e.selectedItems.length)return;let y=f(e.tab).find(g=>g.action===m)?.label||m;if(!window.confirm(`Apply "${y}" to ${e.selectedItems.length} items?`))return;let b=r();if(!b){s("No bulk actions available.","error");return}let w=0;for(let g of e.selectedItems)try{(await o(b,{method:"POST",body:JSON.stringify({action:m,requestId:g})})).ok&&(w+=1)}catch{}s(`Updated ${w} of ${e.selectedItems.length} items`),d(),await h(),S()}return{updateBulkActions:p,handleBulkAction:l,getBulkActionsForTab:f}}function lt({state:e,listColumns:t,getItemKey:o,getValue:r,showToast:s}){function S(){return(t[e.tab]||[]).filter(d=>d.key!=="view"&&d.key!=="delete")}function h(v="csv"){if(v!=="csv")return;let d=e.selectedItems.length>0?e.items.filter(i=>e.selectedItems.includes(o(i))):e.items;if(!d.length){s("No rows to export.","error");return}let p=S(),f=p.map(i=>i.label||i.key),l=d.map(i=>p.map(a=>{let u=r(i,a.key),k=String(u??"");return k.includes(",")||k.includes('"')||k.includes(`
`)?`"${k.replace(/"/g,'""')}"`:k})),m=[f.join(","),...l.map(i=>i.join(","))].join(`
`),y=`${e.tab}-${Date.now()}.csv`,b=new Blob([m],{type:"text/csv;charset=utf-8"}),w=URL.createObjectURL(b),g=document.createElement("a");g.href=w,g.download=y,document.body.appendChild(g),g.click(),g.remove(),URL.revokeObjectURL(w),s(`Exported ${d.length} rows`)}return{exportData:h}}function ct(e){return e==="orders"?"/orders":e==="quotes"?"/quotes":e==="tickets"?"/tickets":e==="contacts"?"/contacts":e==="products"?"/products":e==="inspirations"?"/inspirations":e==="media-library"?"/media-library":e==="cost-chart"?"/cost-chart":e==="diamond-price-chart"?"/diamond-price-chart":`/${e}`}function dt(e){return e==="orders"?"/orders/action":e==="quotes"?"/quotes/action":e==="tickets"?"/tickets/action":e==="contacts"?"/contacts/action":e==="products"?"/products/action":e==="inspirations"?"/inspirations/action":e==="media-library"?"/media-library/action":e==="cost-chart"?"/cost-chart/action":e==="diamond-price-chart"?"/diamond-price-chart/action":""}function ut({state:e,storage:t,locationHref:o}){let r=d=>e.tab==="products"||e.tab==="inspirations"?d.slug||d.id||d.row_number||d.request_id||d.email||d.media_id||d.name||"":e.tab==="media-library"?d.media_id||d.row_number||d.id||"":d.request_id||d.email||d.row_number||d.slug||d.id||d.media_id||"",s=()=>e.selectedItem&&(e.selectedItem.request_id||e.selectedItem.email||e.selectedItem.row_number||e.selectedItem.slug||e.selectedItem.id||e.selectedItem.media_id)||"",S=(d,p)=>d==="orders"||d==="quotes"?{action:"delete",requestId:p}:d==="products"?{action:"delete",id:p,slug:p}:{action:"delete",requestId:p},h=d=>{switch(d){case"orders":return"order_detail";case"quotes":return"quote_detail";case"tickets":return"ticket_detail";case"products":return"product_detail";case"inspirations":return"inspiration_detail";case"contacts":return"contact_detail";case"media-library":return"media_detail";case"cost-chart":return"cost_chart_detail";case"diamond-price-chart":return"diamond_price_chart_detail";default:return"detail"}};return{buildDeletePayload:S,detailUrl:d=>{let p=e.tab||"orders",f=d||"";try{t?.setItem?.("adminDetailTab",p),t?.setItem?.("adminDetailId",f)}catch{}let l=new URL(h(p),o);return l.searchParams.set("id",f),l.toString()},getItemKey:r,getSelectedRecordId:s}}function ft({getLocalAdminEmail:e,storage:t,documentRef:o,windowRef:r}){let s=()=>{if(o.querySelector("[data-local-admin-prompt]"))return;let h=o.createElement("div");h.className="local-admin-banner",h.setAttribute("data-local-admin-prompt","true"),h.innerHTML=`
      <div class="local-admin-card">
        <div>
          <div class="local-admin-title">Local admin access</div>
          <div class="local-admin-sub">Enter an allowlisted email to enable local data.</div>
        </div>
        <div class="local-admin-form">
          <input type="email" placeholder="admin@email.com" aria-label="Admin email" />
          <button class="btn" type="button">Save</button>
        </div>
      </div>
    `,o.body.appendChild(h);let v=h.querySelector("input"),d=h.querySelector("button");v&&d&&(d.addEventListener("click",()=>{let p=String(v.value||"").trim();!p||!p.includes("@")||(t?.setItem?.("adminEmail",p),r.location.reload())}),v.addEventListener("keydown",p=>{p.key==="Enter"&&d.click()}),v.focus())};return{ensureLocalAdminAccess:()=>{if(typeof r>"u")return!0;let h=r.location.origin||"";return!(h.startsWith("http://localhost")||h.startsWith("http://127.0.0.1"))||e()?!0:(s(),!1)}}}function mt({windowRef:e}){return{getInitialTab:r=>new URLSearchParams(e.location.search).get("tab")||r,updateTabInUrl:r=>{let s=new URL(e.location.href);s.searchParams.set("tab",r),s.searchParams.delete("offset"),e.history.replaceState({},"",s)}}}function pt({ui:e}){let t="Connecting",o="",r=h=>{t=h,S()},s=h=>{o=h,S()},S=()=>{if(!e.syncLine)return;if(e.autoRefresh?.checked??!0){e.syncLine.textContent=t,e.refresh&&(e.refresh.disabled=!0,e.refresh.setAttribute("aria-disabled","true"),e.refresh.classList.add("is-disabled"));return}let v=o?` | Last sync ${o}`:"";e.syncLine.textContent=`${t}${v}`,e.refresh&&(e.refresh.disabled=!1,e.refresh.setAttribute("aria-disabled","false"),e.refresh.classList.remove("is-disabled"))};return{setLastSync:s,setSyncStatus:r,updateSyncLine:S}}function bt({state:e,ui:t,tabLabels:o,isDashboardTab:r,isConsultationsTab:s,loadConsultations:S,updateStatusOptions:h,updateStatusFilterOptions:v,updateSortOptions:d,updateBulkActions:p,loadDashboard:f,apiFetch:l,getTabEndpoint:m,renderList:y,getItemKey:b,populateDrawer:w,closeDrawer:g,setSyncStatus:i,setLastSync:a,showToast:u,pricingTabs:k,catalogTabs:q}){let $=()=>{if(!t.adminTabs.length)return;let n=e.role==="admin";if(t.adminTabs.forEach(c=>{c.classList.toggle("is-hidden",!n)}),!n&&t.adminTabs.some(c=>c.classList.contains("is-active"))){let c=t.tabs.find(_=>_.dataset.tab==="orders");c&&(t.tabs.forEach(_=>_.classList.remove("is-active")),c.classList.add("is-active"),e.tab="orders",h(),d())}},T=()=>{if(!t.addRowWrap)return;if(r()){t.addRowWrap.classList.add("is-hidden");return}let c=(e.role==="admin"||e.role==="ops")&&(k.has(e.tab)||q.has(e.tab));if(t.addRowWrap.classList.toggle("is-hidden",!c),t.addRowButton){let _={products:"Add product",inspirations:"Add inspiration","media-library":"Add media"};t.addRowButton.textContent=_[e.tab]||"Add row"}},C=()=>{let n=new URLSearchParams;return Object.entries(e.filters).forEach(([c,_])=>{_&&n.set(c,_)}),n.set("limit",String(e.limit)),n.set("offset",String(e.offset)),n.toString()},P=()=>{let n=r(),c=s?s():!1;t.dashboard&&t.dashboard.classList.toggle("is-hidden",!n),t.consultationsSection&&t.consultationsSection.classList.toggle("is-hidden",!c),t.filtersWrap&&t.filtersWrap.classList.toggle("is-hidden",n||c),t.listWrap&&t.listWrap.classList.toggle("is-hidden",n||c),t.bulkActions&&t.bulkActions.classList.toggle("is-hidden",n||c||!e.selectedItems.length),t.addRowWrap&&t.addRowWrap.classList.toggle("is-hidden",n||c)},N=async()=>{if(!e.isLoading){e.isLoading=!0,e.selectedItems=[],p(),i("Syncing");try{let n=await l(`${m(e.tab)}?${C()}`),c=Array.isArray(n?.items)?n.items:Array.isArray(n)?n:Array.isArray(n?.rows)?n.rows:[];if(Array.isArray(c)||console.warn("Unexpected list payload",{tab:e.tab,data:n}),e.items=c,e.total=Number.isFinite(n?.total)?n.total:Number.isFinite(n?.count)?n.count:c.length,y(),e.selectedId){let _=e.items.find(D=>b(D)===e.selectedId);_?w(_):(g(),e.selectedId="",e.selectedItem=null)}a(new Date().toLocaleTimeString()),i("Synced")}catch(n){let c=n?.message?` ${String(n.message).trim()}`:"";console.error("Load list failed",n),i("Error"),u(`Failed to load data.${c}`,"error")}finally{e.isLoading=!1}}},E=async()=>{if(P(),v(),r()){await f();return}if(s&&s()){S&&await S();return}await N()};return{buildQuery:C,loadCurrentView:E,loadList:N,setTab:n=>{let c=n||"orders";if(e.tab=c,e.offset=0,e.selectedItems=[],t.tabs.forEach(_=>{_.classList.toggle("is-active",_.dataset.tab===e.tab)}),t.tabTitle){let _=o?.[e.tab]||e.tab;t.tabTitle.textContent=_}h(),v(),d(),T(),p(),E()},updateAddRowVisibility:T,updateDashboardVisibility:P,updateTabVisibility:$}}function gt({state:e,ui:t,confirmFields:o,editFields:r,pricingTabs:s,canEditCurrentTab:S,actions:h,orderActionFlow:v,normalizeStatus:d,syncQuoteMetalInput:p,getEditValue:f}){let l=i=>{e.originalValues={},e.originalRaw={},o.forEach(a=>{let u=String(i[a.key]||"");e.originalRaw[a.key]=u,e.originalValues[a.key]=a.normalize(u)}),e.originalNotes=String(i.notes||"")},m=()=>{let i=[];return o.forEach(a=>{let u=f(a.key);if(!u&&!e.originalValues[a.key]||!u&&e.originalValues[a.key])return;let k=a.normalize(u),q=e.originalValues[a.key]||"";k!==q&&i.push({key:a.key,label:a.label,from:a.format(e.originalRaw[a.key]),to:a.format(u)})}),i},y=()=>{let i={};return p(),t.editFields.forEach(a=>{let u=a.dataset.field;u&&u!=="notes"&&r[e.tab].includes(u)&&a.value&&(i[u]=a.value.trim())}),i},b=()=>{let i=t.editFields.find(a=>a.dataset.field==="notes");return i?i.value.trim():""};return{collectConfirmChanges:m,collectEditableUpdates:y,getNotesValue:b,renderActions:()=>{let i=S(),a=e.tab==="orders"&&e.selectedItem?h.orders.filter(k=>k.action==="delete"?!0:(v[d(e.selectedItem.status)]||[]).includes(k.action)):h[e.tab];t.actionButtons.innerHTML=a.map(k=>{let q=i?"":"disabled";return`<button class="btn btn-ghost" data-action="${k.action}" data-confirm="${k.confirm}" ${q}>${k.label}</button>`}).join(""),t.actionButtons.style.display=a.length?"":"none";let u=!1;t.statusSelect&&(u=t.statusSelect.options.length>0&&t.statusSelect.options[0].value!=="",t.statusSelect.disabled=!i||!u),t.statusSave.disabled=!i||!u,t.primaryAction&&(t.primaryAction.disabled=!i),t.notesSave&&(t.notesSave.disabled=!i),t.editFields.forEach(k=>{k.disabled=!i}),t.detailsSave&&(t.detailsSave.disabled=!i),t.orderDetailsFields.forEach(k=>{k.disabled=!i})},setOriginalValues:l,updatePrimaryActionState:()=>{let i=S(),a=b()!==e.originalNotes.trim();if(t.notesSave&&(s.has(e.tab)||e.tab==="quotes"?t.notesSave.style.display="none":(t.notesSave.style.display="",t.notesSave.disabled=!i||!a)),!t.primaryAction)return;if(t.primaryAction.style.display=e.tab==="contacts"?"none":"",e.tab!=="orders"){let k=y();s.has(e.tab)&&(k.notes=b());let q=Object.keys(k).length>0||e.tab==="quotes"&&a;t.primaryAction.textContent="Save updates",t.primaryAction.disabled=!i||!q;return}t.primaryAction.textContent="Get Customer Confirmation";let u=m();e.pendingChanges=u,t.primaryAction.disabled=!i||u.length===0}}}var Ie={orders:["NEW","ACKNOWLEDGED","PENDING_CONFIRMATION","INVOICED","INVOICE_EXPIRED","INVOICE_PAID","PROCESSING","SHIPPED","DELIVERED","CANCELLED"],quotes:["NEW","ACKNOWLEDGED","QUOTED","QUOTE_ACTIONED","DROPPED"],tickets:["NEW","PENDING","RESOLVED"],contacts:[],products:[],inspirations:[],"media-library":[],"cost-chart":[],"diamond-price-chart":[]},qe={orders:[{key:"created_at",label:"Created"},{key:"request_id",label:"Request ID"},{key:"product_name",label:"Product"},{key:"status",label:"Status"},{key:"price",label:"Price"},{key:"timeline",label:"Timeline"},{key:"view",label:""},{key:"delete",label:""}],quotes:[{key:"created_at",label:"Created"},{key:"request_id",label:"Request ID"},{key:"product_name",label:"Product"},{key:"status",label:"Status"},{key:"price",label:"Price"},{key:"timeline",label:"Timeline"},{key:"view",label:""},{key:"delete",label:""}],tickets:[{key:"created_at",label:"Created"},{key:"request_id",label:"Request ID"},{key:"name",label:"Name"},{key:"email",label:"Email"},{key:"status",label:"Status"},{key:"subject",label:"Subject"},{key:"summary",label:"Summary"},{key:"view",label:""},{key:"delete",label:""}],contacts:[{key:"created_at",label:"Created"},{key:"name",label:"Name"},{key:"email",label:"Email"},{key:"phone",label:"Phone"},{key:"source",label:"Source"},{key:"request_id",label:"Request ID"},{key:"view",label:""}],products:[{key:"id",label:"ID"},{key:"name",label:"Name"},{key:"slug",label:"Slug"},{key:"category",label:"Category"},{key:"design_code",label:"Design code"},{key:"is_active",label:"Active"},{key:"view",label:""},{key:"delete",label:""}],inspirations:[{key:"id",label:"ID"},{key:"name",label:"Name"},{key:"slug",label:"Slug"},{key:"categories",label:"Category"},{key:"design_code",label:"Design code"},{key:"is_active",label:"Active"},{key:"view",label:""}],"media-library":[{key:"media_id",label:"Media ID"},{key:"label",label:"Label"},{key:"media_type",label:"Type"},{key:"url",label:"Preview"},{key:"view",label:""}],"cost-chart":[{key:"row_number",label:"Row"},{key:"key",label:"Key"},{key:"value",label:"Value"},{key:"unit",label:"Unit"},{key:"notes",label:"Notes"},{key:"view",label:""}],"diamond-price-chart":[{key:"row_number",label:"Row"},{key:"clarity",label:"Clarity"},{key:"color",label:"Color"},{key:"weight_min",label:"Min ct"},{key:"weight_max",label:"Max ct"},{key:"price_per_ct",label:"Price/ct"},{key:"view",label:""}]},ht={orders:[{value:"created_at",label:"Created"},{value:"status",label:"Status"},{value:"price",label:"Price"},{value:"timeline",label:"Timeline"},{value:"name",label:"Name"},{value:"request_id",label:"Request ID"}],quotes:[{value:"created_at",label:"Created"},{value:"status",label:"Status"},{value:"price",label:"Price"},{value:"timeline",label:"Timeline"},{value:"name",label:"Name"},{value:"request_id",label:"Request ID"}],tickets:[{value:"created_at",label:"Created"},{value:"status",label:"Status"},{value:"name",label:"Name"},{value:"email",label:"Email"},{value:"subject",label:"Subject"}],contacts:[{value:"created_at",label:"Created"},{value:"name",label:"Name"},{value:"email",label:"Email"},{value:"source",label:"Source"}],products:[{value:"name",label:"Name"},{value:"slug",label:"Slug"},{value:"category",label:"Category"},{value:"design_code",label:"Design code"},{value:"is_active",label:"Active"}],inspirations:[{value:"name",label:"Name"},{value:"slug",label:"Slug"},{value:"categories",label:"Category"},{value:"design_code",label:"Design code"},{value:"is_active",label:"Active"}],"media-library":[{value:"media_id",label:"Media ID"},{value:"label",label:"Label"},{value:"media_type",label:"Type"}],"cost-chart":[{value:"row_number",label:"Row"},{value:"key",label:"Key"},{value:"value",label:"Value"}],"diamond-price-chart":[{value:"row_number",label:"Row"},{value:"clarity",label:"Clarity"},{value:"color",label:"Color"},{value:"weight_min",label:"Min ct"},{value:"price_per_ct",label:"Price/ct"}]},yt={orders:{sort:"created_at",dir:"desc"},quotes:{sort:"created_at",dir:"desc"},tickets:{sort:"created_at",dir:"desc"},contacts:{sort:"created_at",dir:"desc"},products:{sort:"name",dir:"asc"},inspirations:{sort:"name",dir:"asc"},"media-library":{sort:"media_id",dir:"asc"},"cost-chart":{sort:"row_number",dir:"asc"},"diamond-price-chart":{sort:"row_number",dir:"asc"}},wt={orders:[{action:"acknowledge",label:"Acknowledge",confirm:"Mark as acknowledged?"},{action:"send_invoice",label:"Send invoice",confirm:"Send invoice and mark invoiced?"},{action:"mark_paid",label:"Mark paid",confirm:"Confirm payment received?"},{action:"mark_invoice_expired",label:"Mark invoice expired",confirm:"Mark invoice as expired?"},{action:"mark_processing",label:"Mark processing",confirm:"Move order into processing?"},{action:"mark_shipped",label:"Mark shipped",confirm:"Mark as shipped?"},{action:"mark_delivered",label:"Mark delivered",confirm:"Mark as delivered?"},{action:"cancel",label:"Cancel order",confirm:"Cancel this order?"},{action:"delete",label:"Delete",confirm:"Delete this order? This cannot be undone."}],quotes:[{action:"acknowledge",label:"Acknowledge",confirm:"Mark as acknowledged?"},{action:"submit_quote",label:"Send quote link",confirm:"Send quote link to customer?"},{action:"refresh_quote",label:"Refresh quote link",confirm:"Send a refreshed quote link?"},{action:"mark_actioned",label:"Mark quote actioned",confirm:"Mark quote as actioned?"},{action:"drop",label:"Drop",confirm:"Drop this quote?"},{action:"delete",label:"Delete",confirm:"Delete this quote? This cannot be undone."}],tickets:[{action:"mark_pending",label:"Mark pending",confirm:"Mark as pending?"},{action:"mark_resolved",label:"Mark resolved",confirm:"Mark as resolved?"},{action:"delete",label:"Delete",confirm:"Delete this ticket? This cannot be undone."}],contacts:[],products:[{action:"delete",label:"Delete",confirm:"Delete this product? This cannot be undone."}],inspirations:[],"media-library":[],"cost-chart":[],"diamond-price-chart":[]},Ce={orders:["price","timeline","timeline_adjustment_weeks","metal","metal_weight","metal_weight_adjustment","stone","stone_weight","notes"],quotes:["price","timeline","timeline_adjustment_weeks","metal","metal_weight","stone","stone_weight","diamond_breakdown","size","quote_metal_options","quote_option_1_clarity","quote_option_1_color","quote_option_1_price_18k","quote_option_2_clarity","quote_option_2_color","quote_option_2_price_18k","quote_option_3_clarity","quote_option_3_color","quote_option_3_price_18k","quote_discount_type","quote_discount_percent","notes"],tickets:["notes"],contacts:[],products:[],inspirations:[],"media-library":[],"cost-chart":["key","value","unit","notes"],"diamond-price-chart":["clarity","color","weight_min","weight_max","price_per_ct","notes"]},vt=["shipping_method","shipping_carrier","tracking_number","tracking_url","shipping_status","delivery_eta","shipping_notes","certificates","care_details","warranty_details","service_details"],St=["shipping_carrier","tracking_number","certificates","care_details","warranty_details","service_details"],kt={NEW:["ACKNOWLEDGED","CANCELLED"],ACKNOWLEDGED:["PENDING_CONFIRMATION","INVOICED","CANCELLED"],PENDING_CONFIRMATION:["INVOICED","CANCELLED"],INVOICED:["INVOICE_PAID","INVOICE_EXPIRED","CANCELLED"],INVOICE_EXPIRED:["INVOICED","CANCELLED"],INVOICE_PAID:["PROCESSING","SHIPPED"],PROCESSING:["SHIPPED"],SHIPPED:["DELIVERED"],DELIVERED:[],CANCELLED:["INVOICED"]},_t={NEW:["acknowledge","cancel"],ACKNOWLEDGED:["send_invoice","cancel"],PENDING_CONFIRMATION:["send_invoice","cancel"],INVOICED:["mark_paid","mark_invoice_expired","cancel"],INVOICE_EXPIRED:["send_invoice","cancel"],INVOICE_PAID:["mark_processing","mark_shipped"],PROCESSING:["mark_shipped"],SHIPPED:["mark_delivered"],DELIVERED:[],CANCELLED:["send_invoice"]},De={orders:"Order",quotes:"Quote",tickets:"Customer ticket",contacts:"Contact",products:"Product",inspirations:"Inspiration","media-library":"Media library","cost-chart":"Cost chart","diamond-price-chart":"Diamond price chart"},be=new Set(["cost-chart","diamond-price-chart"]),xe=new Set(["products","inspirations","media-library"]),ge=[{clarity:"quote_option_1_clarity",color:"quote_option_1_color",price:"quote_option_1_price_18k"},{clarity:"quote_option_2_clarity",color:"quote_option_2_color",price:"quote_option_2_price_18k"},{clarity:"quote_option_3_clarity",color:"quote_option_3_color",price:"quote_option_3_price_18k"}],Et=new Set(ge.map(e=>e.price)),Ae=new Set(["metal","metal_weight","stone_weight","diamond_breakdown","timeline","timeline_adjustment_weeks","quote_discount_type","quote_discount_percent",...ge.flatMap(e=>[e.clarity,e.color])]);function ie(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function se(e){return ie(e).replace(/`/g,"&#96;")}function Lt(e,t=""){let o=String(e||"").trim();if(!o)return"";if(/^(https?:|data:|blob:)/i.test(o)){try{let r=new URL(o);if(t&&(r.hostname==="business.heerawalla.com"||r.hostname==="admin-api.heerawalla.com"))return`${t}${r.pathname}${r.search||""}`}catch{return o}return o}return o.startsWith("//")?`https:${o}`:t?o.startsWith("/")?`${t}${o}`:`${t}/${o}`:o}function Ne(e){if(!e)return"--";let t=new Date(e);return Number.isNaN(t.getTime())?String(e):t.toLocaleString()}function he(e){if(e==null||e==="")return"--";let t=Number(String(e).replace(/[^0-9.]/g,""));return Number.isNaN(t)?String(e):t.toLocaleString("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0})}function Re(e){let t=String(e||"").replace(/\D/g,"");return t?t.length===10?`(${t.slice(0,3)}) ${t.slice(3,6)}-${t.slice(6)}`:t.length===11&&t.startsWith("1")?`+1 (${t.slice(1,4)}) ${t.slice(4,7)}-${t.slice(7)}`:t.length>11?`+${t}`:t:"--"}function ne(e){return String(e||"").trim().toLowerCase()}function le(e){let t=String(e||"").trim();if(!t)return"";let o=Number(t);return Number.isNaN(o)?t.toLowerCase():String(o)}function It(e){let t=String(e||"").replace(/[^0-9.]/g,"");if(!t)return"";let o=Number(t);return Number.isNaN(o)?t:String(o)}function $e(e){let t=ne(e);return t?t.includes("rush")?"rush":t.includes("standard")?"standard":t:""}function Oe(e){return String(e||"").trim()}function qt(e){let t=String(e||"").trim();if(!t)return"";let o=Number(t);return Number.isNaN(o)?t:`${o} ct`}function Te(e){let t=String(e||"").trim();if(!t)return"";let o=Number(t);return Number.isNaN(o)?t:`${o} g`}function Pe(e){let t=String(e||"").trim();if(!t)return"";let o=Number(t);return Number.isNaN(o)?t:`${o>0?"+":""}${o} g`}function ze(e){let t=String(e||"").trim();if(!t)return"";let o=Number(t);return Number.isNaN(o)?t:o?`${o} week${o===1?"":"s"} delay`:"No delay"}function Me(e){let t=$e(e);return t?t==="rush"?"Rush":t==="standard"?"Standard":e:""}function ye(e){return e!=null&&String(e).trim()!==""}function Ct({state:e,ui:t,escapeAttribute:o,isFilled:r,normalizeText:s,getEditField:S,getEditValue:h,loadCatalog:v,resolveCatalogEntry:d}){let p=n=>{let c=n?.sizing||n?.sizing_details||n?.sizing_info||n?.size_details||n?.size_info;if(!c)return{};if(typeof c=="object")return c;if(typeof c=="string")try{let _=JSON.parse(c);if(_&&typeof _=="object")return _}catch{return{}}return{}},f=(n,c,_,D)=>{for(let z of D){let M=n?n[z]:"";if(r(M))return M;let W=c?c[z]:"";if(r(W))return W;let H=_?_[z]:"";if(r(H))return H}return""},l=n=>[n?.notes,n?.customer_notes,n?.request_notes,n?.size,n?.size_details,n?.sizeDetails,n?.body,n?.email_body,n?.email_text,n?.request_body,n?.quote_body,n?.summary,n?.summary_text,n?.details,n?.inquiry,n?.message].filter(r).join(`
`),m=n=>{if(!r(n))return{};let c=_=>{let D=n.match(_);return D&&D[1]?D[1].trim():""};return{ring:c(/\bring(?:\s*size)?\s*:\s*([^|\n,;]+)/i),wrist:c(/\b(?:wrist|bracelet)(?:\s*size)?\s*:\s*([^|\n,;]+)/i),neck:c(/\b(?:neck|necklace|chain)(?:\s*(?:size|length))?\s*:\s*([^|\n,;]+)/i),earring:c(/\bearrings?(?:\s*(?:style|type|size|preference))?\s*:\s*([^|\n,;]+)/i)}},y=n=>{let c=p(n),_=[],D=m(l(n)),z=f(n,c,D,["ring_size","ring","ringSize"]),M=f(n,c,D,["wrist_size","wrist","bracelet_size","bracelet"]),W=f(n,c,D,["neck_size","neck","chain_size","chain_length","necklace_size","necklace_length"]),H=f(n,c,D,["earring_style","earring_type","earring","earring_size"]);return r(z)&&_.push(["Ring size",z]),r(M)&&_.push(["Wrist size",M]),r(W)&&_.push(["Neck/chain size",W]),r(H)&&_.push(["Earring style",H]),!_.length&&r(n?.size)&&_.push(["Size",n.size]),_},b=n=>{let c=n?.tags,_=(Array.isArray(c)?c:String(c||"").split(/[|,;\n]/)).map(G=>String(G||"").trim().toLowerCase()).filter(Boolean),D=G=>G.some(O=>_.includes(O)),z=D(["set","sets"]),M=D(["ring","rings","band","bands"]),W=D(["bracelet","bracelets","bangle","bangles","wrist"]),H=D(["pendant","pendants","necklace","necklaces","chain","chains"]);if(_.length){let G=z&&!M&&!W&&!H;return{ring:M||G,bracelet:W||G,chain:H||G}}let j=String(n?.category||n?.categories||"").toLowerCase().replace(/\s+/g," ");return j.includes("set")?{ring:!0,bracelet:!0,chain:!0}:{ring:j.includes("ring")||j.includes("band"),bracelet:j.includes("bracelet")||j.includes("bangle"),chain:j.includes("pendant")||j.includes("necklace")||j.includes("chain")}},w=n=>{let c=[];return r(n.ring)&&c.push(`Ring size: ${n.ring}`),r(n.bracelet)&&c.push(`Bracelet size: ${n.bracelet}`),r(n.chain)&&c.push(`Chain size: ${n.chain}`),c.join(" | ")},g=!1,i=()=>{if(g)return;let n=S("size");if(!n)return;let c={ring:t.sizeRing?t.sizeRing.value.trim():"",bracelet:t.sizeBracelet?t.sizeBracelet.value.trim():"",chain:t.sizeChain?t.sizeChain.value.trim():""},_=w(c);_&&(n.value=_)},a=n=>{let c=(_,D)=>{if(!_)return;let z=_.closest(".field");z&&z.classList.toggle("is-hidden",!D)};if(e.tab!=="quotes"){c(t.sizeRing,!1),c(t.sizeBracelet,!1),c(t.sizeChain,!1);return}c(t.sizeRing,!!n?.ring),c(t.sizeBracelet,!!n?.bracelet),c(t.sizeChain,!!n?.chain)},u=async n=>{if(e.tab!=="quotes")return;let c=await v(),_=d(n,c),D=p(n),z=m(l(n));g=!0;let M=f(n,D,z,["ring_size","ring","ringSize"]),W=f(n,D,z,["wrist_size","wrist","bracelet_size","bracelet"]),H=f(n,D,z,["neck_size","neck","chain_size","chain_length","necklace_size","necklace_length"]),j=b(_);!j.ring&&!j.bracelet&&!j.chain&&(j={ring:r(M),bracelet:r(W),chain:r(H)}),a(j),t.sizeRing&&(t.sizeRing.value=M),t.sizeBracelet&&(t.sizeBracelet.value=W),t.sizeChain&&(t.sizeChain.value=H),g=!1},k=()=>t.editFields.find(n=>n.dataset.field==="diamond_breakdown"),q=n=>n?String(n).split(/\n|;|,/).map(c=>c.trim()).filter(Boolean).map(c=>{let _=c.match(/([0-9]*\.?[0-9]+)\s*(?:ct)?\s*[xX]\s*([0-9]*\.?[0-9]+)/i);if(_)return{weight:_[1],count:_[2]};let D=c.match(/[0-9]*\.?[0-9]+/g)||[];return D.length>=2?{weight:D[0],count:D[1]}:D.length===1?{weight:D[0],count:"1"}:null}).filter(Boolean):[],$=n=>n.map(c=>{let _=String(c.weight||"").trim(),D=String(c.count||"").trim();return!_||!D?"":`${_} x ${D}`}).filter(Boolean).join(`
`),T=()=>t.diamondBreakdownRows?Array.from(t.diamondBreakdownRows.querySelectorAll("[data-diamond-row]")).map(n=>{let c=n.querySelector("[data-diamond-weight]")?.value?.trim()||"",_=n.querySelector("[data-diamond-count]")?.value?.trim()||"";return{weight:c,count:_}}):[],C=!1,P=()=>{if(C)return;let n=k();if(!n)return;let c=T();C=!0,n.value=$(c),C=!1},N=n=>{if(t.diamondBreakdownRows){if(!n.length){t.diamondBreakdownRows.innerHTML='<p class="muted">No diamond pieces yet. Add a row to begin.</p>';return}t.diamondBreakdownRows.innerHTML=n.map((c,_)=>`
          <div class="diamond-row" data-diamond-row data-row-index="${_}">
            <input type="text" data-diamond-weight placeholder="0.10" value="${o(c.weight||"")}" />
            <span>ct x</span>
            <input type="text" data-diamond-count placeholder="1" value="${o(c.count||"")}" />
            <button class="btn btn-ghost" type="button" data-diamond-remove>Remove</button>
          </div>`).join("")}};return{applySizingVisibility:a,buildSizingRows:y,getDiamondBreakdownField:k,getDiamondRowsFromDom:T,refreshSizingInputs:u,renderDiamondBreakdownRows:N,setDiamondBreakdownRowsFromField:()=>{let n=k();if(!n)return;let c=q(n.value);N(c)},syncDiamondBreakdownField:P,syncSizingToSizeField:i,toggleDiamondBreakdownVisibility:()=>{t.diamondBreakdown&&t.diamondBreakdown.classList.toggle("is-hidden",e.tab!=="quotes")}}}function Dt({item:e,formatDate:t,formatPhone:o,formatPrice:r,formatDelayWeeks:s,formatGrams:S,formatSignedGrams:h,buildMetalWeightLabel:v,buildMetalWeightAdjustmentLabel:d,buildSizingRows:p,renderQuoteMediaSlot:f}){return[{title:"At a glance",rows:[["Request ID",e.request_id],["Created",t(e.created_at)],["Status",e.status],["Price",r(e.price)],["Timeline",e.timeline],["Timeline delay",s(e.timeline_adjustment_weeks)]]},{title:"Client",rows:[["Name",e.name],["Email",e.email],["Phone",o(e.phone)]]},{title:"Piece",rows:[["Product",e.product_name],["Images",f()],["Design code",e.design_code],["Metal",e.metal],[v(e.metal),S(e.metal_weight)],[d(e.metal),h(e.metal_weight_adjustment)],["Stone",e.stone],["Stone weight",e.stone_weight],["Diamond breakdown",e.diamond_breakdown]]},{title:"Sizing",rows:p(e)},{title:"Quote options",rows:[["Discount type",e.quote_discount_type],["Discount percent",e.quote_discount_percent]]},{title:"Address",rows:[["Address",e.address_line1],["City",e.city],["State",e.state],["Postal code",e.postal_code],["Country",e.country]]},{title:"Preferences",rows:[["Interests",e.interests],["Contact preference",e.contact_preference],["Subscription",e.subscription_status]]}]}function xt({apiBase:e,ui:t,normalizeImageUrl:o,escapeAttribute:r}){let s={data:null,promise:null},S=new Map,h=()=>e.replace(/\/admin\/?$/,""),v=i=>{if(!i)return"";try{let u=new URL(i,"https://www.heerawalla.com").pathname.split("/").filter(Boolean),k=u[u.length-1]||"";return k.toLowerCase()==="bespoke"&&u.length>1?u[u.length-2]||"":k}catch{return""}},d=i=>{if(!i)return"";try{let u=new URL(i,"https://www.heerawalla.com").pathname.split("/").filter(Boolean);return u.includes("inspirations")?"inspirations":u.includes("product")||u.includes("products")?"products":""}catch{return""}},p=i=>String(i||"uncategorized").split("/").map(a=>a.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"")||"uncategorized").filter(Boolean).join("/"),f=i=>{let a=p(i.category||"uncategorized"),u=`/images/products/${a}/${i.id}`,k=["img-hero-1.png","img-hero-1.jpeg","img-hero-1.jpg","img-hero-2.png","img-hero-2.jpeg","img-hero-2.jpg","img-hero-03.jpeg","img-1.png","img-1.jpeg","img-1.jpg","image-1.svg"].map(q=>`${u}/${q}`);return k.push(`/images/products/${a}/image-1.svg`),k.push("/images/products/placeholder.svg"),k},l=i=>{if(!i)return[o("/images/products/placeholder.svg")].filter(Boolean);let a=[];return i.hero_image&&a.push(i.hero_image),i.heroImage&&a.push(i.heroImage),Array.isArray(i.images)&&i.images.forEach(u=>a.push(u)),!a.length&&i.id&&i.category&&(a=f(i)),a.length||(a=["/images/products/placeholder.svg"]),Array.from(new Set(a.map(o).filter(Boolean)))},m=async()=>{if(s.data)return s.data;if(s.promise)return s.promise;let i=`${h()}/catalog?include=products,inspirations`;return s.promise=fetch(i).then(a=>a.json()).then(a=>(s.data=a||{},s.data)).catch(()=>(s.data={},s.data)).finally(()=>{s.promise=null}),s.promise},y=(i,a)=>{if(!a)return null;let u=i.product_url||"",k=v(u),q=d(u),$=i.design_code||"",T=i.product_name||"",C=Array.isArray(a.inspirations)?a.inspirations:[],P=Array.isArray(a.products)?a.products:[],N=n=>$&&(n.design_code||n.designCode||"").toLowerCase()===$.toLowerCase(),E=n=>T&&String(n.name||n.title||"").toLowerCase()===T.toLowerCase(),I=n=>k&&String(n.slug||"").toLowerCase()===k.toLowerCase();return q==="inspirations"?C.find(I)||C.find(N)||C.find(E)||null:q==="products"?P.find(I)||P.find(N)||P.find(E)||null:C.find(I)||P.find(I)||C.find(N)||P.find(N)||C.find(E)||P.find(E)||null},b=i=>{let a=Array.isArray(i)?i:[],u=r(o("/images/products/placeholder.svg"));return`
      <div class="media-carousel" data-media-carousel>
        <button class="carousel-btn" type="button" data-carousel-prev aria-label="Previous image">\u2039</button>
        <div class="media-track" data-carousel-track>${a.map(q=>`<div class="media-slide"><img src="${r(q)}" alt="" loading="lazy" onerror="this.onerror=null;this.src='${u}';"></div>`).join("")}</div>
        <button class="carousel-btn" type="button" data-carousel-next aria-label="Next image">\u203A</button>
      </div>`};return{collectImageUrls:l,getCatalogBase:h,loadCatalog:m,refreshQuoteMedia:async i=>{if(!t.detailGrid)return;let a=t.detailGrid.querySelector("[data-media-slot]");if(!a)return;let u=i.design_code||i.product_url||i.product_name||"";if(u&&S.has(u)){a.innerHTML=b(S.get(u));return}let k=await m(),q=y(i,k),$=l(q);u&&S.set(u,$),a.innerHTML=b($)},renderQuoteMediaSlot:()=>'<div class="media-slot" data-media-slot><span class="muted">Loading images...</span></div>',resolveCatalogEntry:y}}function At({state:e,ui:t,quoteOptionFields:o,quotePricingFields:r,quotePriceFields:s,isGoldOnlyQuote:S,getEditField:h,getEditValue:v,getCatalogBase:d,updatePrimaryActionState:p}){let f=null,l=!1,m=u=>{u&&(u.dataset.auto="false",u.dataset.manual="true")},y=u=>!(!u||u.dataset.manual==="true"&&u.value),b=()=>{e.tab==="quotes"&&o.forEach(u=>{let k=h(u.price);k&&(k.dataset.auto="true",k.dataset.manual="")})},w=()=>{if(e.tab!=="quotes"||!v("metal_weight"))return null;let k=S();if(!o.some(T=>!!(v(T.clarity)||v(T.color)))&&!k)return null;let $={};return r.forEach(T=>{let C=v(T);C&&($[T]=C)}),$},g=u=>{u&&(o.forEach(k=>{let q=u[k.price];if(!q)return;let $=h(k.price);y($)&&($.value=q,$.dataset.auto="true",$.dataset.manual="")}),p())},i=async()=>{if(e.tab!=="quotes"||l)return;let u=w();if(!u)return;let k={metal:u.metal||"",metal_weight:u.metal_weight||"",stone:u.stone||"",stone_weight:u.stone_weight||"",diamond_breakdown:u.diamond_breakdown||"",timeline:u.timeline||"",timeline_adjustment_weeks:u.timeline_adjustment_weeks||"",quote_discount_type:u.quote_discount_type||"",quote_discount_percent:u.quote_discount_percent||"",size:v("size")||"",size_label:"",size_ring:t.sizeRing?t.sizeRing.value.trim():"",size_bracelet:t.sizeBracelet?t.sizeBracelet.value.trim():"",size_chain:t.sizeChain?t.sizeChain.value.trim():""},q=d();l=!0;try{let $={},T=S(),C=o.map(async(P,N)=>{let E=u[P.clarity]||"",I=u[P.color]||"";if(!E&&!I&&!(T&&N===0))return;let n={...k,clarity:E,color:I},c=await fetch(`${q}/pricing/estimate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),_=await c.json().catch(()=>({}));!c.ok||!_?.ok||($[P.price]=String(_.price||""))});await Promise.all(C),g($)}catch{return}finally{l=!1}};return{markQuotePriceManual:m,resetQuoteAutoPricingState:b,scheduleQuotePricingUpdate:()=>{e.tab==="quotes"&&(f&&clearTimeout(f),f=setTimeout(()=>{i()},350))},quotePriceFields:s}}function Nt({modal:e}){if(!e)return{open:()=>{},close:()=>{},isOpen:()=>!1};let t=null,o=()=>{let h=e.querySelector("button, [href], input, select, textarea, [tabindex]:not([tabindex='-1'])")||e;h&&typeof h.focus=="function"&&h.focus()};return{open:()=>{t=document.activeElement,e.classList.add("is-open"),e.removeAttribute("inert"),e.setAttribute("aria-hidden","false"),requestAnimationFrame(o)},close:()=>{e.contains(document.activeElement)&&(t&&typeof t.focus=="function"?t.focus():document.body.focus?.()),e.classList.remove("is-open"),e.setAttribute("aria-hidden","true"),e.setAttribute("inert","")},isOpen:()=>e.classList.contains("is-open")}}function Rt({ui:e,escapeHtml:t,escapeAttribute:o,buildEtaLine:r,getEditValue:s}){let S=Nt({modal:e.confirmModal}),h=m=>m.map(y=>`
          <div class="confirm-row">
            <div class="confirm-field">${t(y.label)}</div>
            <div class="confirm-values">
              <span class="confirm-old">${t(y.from||"--")}</span>
              <span class="confirm-arrow">-></span>
              <span class="confirm-new">${t(y.to||"--")}</span>
            </div>
          </div>`).join(""),v=m=>m.map(y=>`
          <tr>
            <td style="padding:10px 0;border-bottom:1px solid #e5e7eb;">
              <div style="font-size:11px;letter-spacing:0.2em;text-transform:uppercase;color:#64748b;margin-bottom:6px;">
                ${t(y.label)}
              </div>
              <div style="font-size:14px;line-height:1.6;color:#0f172a;">
                <span style="color:#94a3b8;text-decoration:line-through;">${t(y.from||"--")}</span>
                <span style="color:#94a3b8;padding:0 8px;">-></span>
                <span style="font-weight:600;color:#0f172a;">${t(y.to||"--")}</span>
              </div>
            </td>
          </tr>`).join("");return{buildConfirmationEmail:(m,y,b)=>{let w=m.request_id||"",g=m.name||"there",i=m.product_name||"your order",a=s("timeline")||m.timeline||"",u=s("timeline_adjustment_weeks")||m.timeline_adjustment_weeks||"",k=r(a,u),q=w?`Heerawalla - Confirm order update (${w})`:"Heerawalla - Confirm order update",$=y.map(I=>`${I.label}: ${I.from||"--"} -> ${I.to||"--"}`),T=[`Hello ${g},`,"",`We reviewed your order for ${i}. Please confirm the updated details below (previous -> updated):`,"",...$,"",k,"",`Use your private confirmation link (Heerawalla.com/order_confirmation): ${b}`,"","Once confirmed, you will be guided to a secure checkout to reserve your piece.","Secure checkout supports major cards and wallets.","If anything looks incorrect, choose cancel on the confirmation page or reply to this email.","","Warm regards,","Heerawalla","www.heerawalla.com"].join(`
`),C=h(y),P=v(y),N=`<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body style="margin:0;padding:0;background:#f6f5f2;color:#0f172a;font-family:-apple-system, Segoe UI, Helvetica, Arial, sans-serif;">
  <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse;">
    <tr>
      <td align="center" style="padding:32px 16px;">
        <table role="presentation" width="600" cellpadding="0" cellspacing="0" style="border-collapse:collapse;background:#ffffff;border:1px solid #e5e7eb;">
          <tr>
            <td style="padding:36px 40px 28px 40px;">
              <div style="margin:0 0 16px 0;">
                <img src="https://www.heerawalla.com/images/engraving_mark.svg" width="36" height="36" alt="Heerawalla" style="display:block;">
              </div>
              <div style="font-size:12px;letter-spacing:0.32em;text-transform:uppercase;color:#64748b;margin-bottom:12px;">Heerawalla</div>
              <h1 style="margin:0 0 16px 0;font-size:22px;line-height:1.4;font-weight:600;color:#0f172a;">Please confirm your order update</h1>
              <p style="margin:0 0 16px 0;font-size:15px;line-height:1.7;color:#334155;">Hello ${t(g)},</p>
              <p style="margin:0 0 18px 0;font-size:15px;line-height:1.7;color:#334155;">
                We reviewed your order for ${t(i)}. Please confirm the updated details below (previous -> updated).
              </p>
              <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse;border:1px solid #e5e7eb;background:#fdfbf7;margin-bottom:18px;">
                <tbody>
                  ${P}
                </tbody>
              </table>
              <p style="margin:0 0 18px 0;font-size:14px;line-height:1.7;color:#334155;">
                ${t(k)}
              </p>
              <table role="presentation" cellpadding="0" cellspacing="0" style="margin:0 0 18px 0;">
                <tr>
                  <td style="background:#0f172a;border:1px solid #0f172a;">
                    <a href="${o(b)}" style="display:inline-block;padding:12px 22px;font-size:12px;letter-spacing:0.2em;text-transform:uppercase;color:#ffffff;text-decoration:none;">Review and confirm</a>
                  </td>
                </tr>
              </table>
              <p style="margin:0 0 6px 0;font-size:13px;line-height:1.7;color:#475569;">
                Use your private confirmation link at Heerawalla.com/order_confirmation.
              </p>
              <p style="margin:0 0 6px 0;font-size:13px;line-height:1.7;color:#475569;">
                Once confirmed, you will be guided to a secure checkout to reserve your piece.
              </p>
              <p style="margin:0 0 6px 0;font-size:13px;line-height:1.7;color:#475569;">
                Secure checkout supports major cards and wallets.
              </p>
              <p style="margin:0 0 24px 0;font-size:13px;line-height:1.7;color:#475569;">
                If anything looks incorrect, choose cancel on the confirmation page or reply to this email.
              </p>
              <div style="height:1px;background:#e5e7eb;margin:0 0 18px 0;"></div>
              <p style="margin:0 0 6px 0;font-size:14px;color:#0f172a;">Warm regards,</p>
              <p style="margin:0 0 10px 0;font-size:14px;font-weight:600;color:#0f172a;">Heerawalla</p>
              <p style="margin:0;font-size:12px;color:#64748b;">
                <a href="https://www.heerawalla.com" style="color:#64748b;text-decoration:underline;">www.heerawalla.com</a>
              </p>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`,E=`
      <div class="confirm-preview-card">
        <p class="confirm-title">Order update to confirm</p>
        <p class="confirm-sub">${t(i)}${w?` (${t(w)})`:""}</p>
        <div class="confirm-list">${C}</div>
        <a class="confirm-cta" href="${o(b)}" target="_blank" rel="noreferrer">Review and confirm</a>
        <p class="confirm-foot">${t(k)}</p>
        <p class="confirm-foot">
          Private confirmation link lets the customer confirm or cancel before secure checkout.
        </p>
      </div>`;return{subject:q,textBody:T,htmlBody:N,previewHtml:E}},resolveConfirmationUrl:m=>{let y=m.confirmationUrl||m.url||"";if(y)return y.startsWith("http")?y:y.startsWith("/")?`https://www.heerawalla.com${y}`:y;let b=m.token||m.confirmationToken||"";return b?`https://www.heerawalla.com/order_confirmation?token=${encodeURIComponent(b)}`:""},openConfirmModal:m=>{e.confirmModal&&(e.confirmTo.textContent=m.to,e.confirmSubject.textContent=m.subject,e.confirmPreview.innerHTML=m.previewHtml,S.open())},closeConfirmModal:()=>{S.close()}}}function $t({state:e,ui:t,apiFetch:o,orderDetailsFields:r}){let s=()=>{if(!t.orderDetailsSection)return;let p=e.tab==="orders";t.orderDetailsSection.classList.toggle("is-hidden",!p)},S=p=>{let f=t.orderDetailsFields.find(l=>l.dataset.orderDetailsField===p);return f?f.value.trim():""},h=()=>{let p={};return r.forEach(f=>{let l=S(f);l&&(p[f]=l)}),p},v=(p={})=>{e.orderDetails=p||{},t.orderDetailsFields.forEach(f=>{let l=f.dataset.orderDetailsField;if(!l)return;let m=l==="shipping_method"?"Express":"";f.value=p[l]||m})};return{applyOrderDetailsVisibility:s,collectOrderDetailsUpdates:h,loadOrderDetails:async p=>{if(!p||e.tab!=="orders"){v({});return}try{let f=await o(`/orders/details?request_id=${encodeURIComponent(p)}`);v(f.details||{})}catch{v({})}},populateOrderDetails:v}}function Ot({state:e,ui:t,normalizeText:o,getEditValue:r,getEditField:s}){let S=()=>"Metal weight (g)",h=()=>"Final Metal weight difference (g)",v=()=>{t.metalWeightLabel&&(t.metalWeightLabel.textContent=S()),t.metalWeightAdjustmentLabel&&(t.metalWeightAdjustmentLabel.textContent=h())},d=w=>{let g=o(w);return g.includes("platinum")?"Platinum":g.includes("14k")?"14K":g.includes("18k")?"18K":""},p=(w,g)=>{let i=s(w);if(!i)return;let a=i.closest(".field");a&&a.classList.toggle("is-hidden",!g)},f=()=>{if(e.tab!=="quotes")return!1;let w=Number(r("stone_weight")),g=r("diamond_breakdown"),i=!!String(g||"").trim();return(!Number.isFinite(w)||w<=0)&&!i},l=()=>{if(e.tab!=="quotes")return;let w=f();Array.from(document.querySelectorAll(".quote-option-card")).forEach((i,a)=>{a===0?i.classList.toggle("is-hidden",!1):i.classList.toggle("is-hidden",w)}),p("quote_option_1_clarity",!w),p("quote_option_1_color",!w)},m=()=>{if(e.tab!=="quotes")return;let w=o(r("quote_discount_type")),g=s("quote_discount_percent");if(!g)return;let i=w==="custom";g.disabled=!i},y=()=>{if(!t.quoteMetalInput)return;let w=r("metal"),g=d(w);if(g){b(g,w);return}let i=t.quoteMetals.filter(a=>a.checked).map(a=>a.value);t.quoteMetalInput.value=i.join(", ")},b=(w,g="")=>{if(!t.quoteMetalInput)return;let i=d(g),a=String(w||"").split(",").map(u=>u.trim()).filter(Boolean);i?(a.length=0,a.push(i)):a.length||a.push("18K"),t.quoteMetalInput.value=a.join(", "),t.quoteMetals.forEach(u=>{u.checked=a.includes(u.value),i?u.disabled=u.value!==i:u.disabled=!1})};return{applyDiscountControlState:m,applyGoldOnlyQuoteState:l,buildMetalWeightAdjustmentLabel:h,buildMetalWeightLabel:S,getRequestedMetalGroup:d,isGoldOnlyQuote:f,setQuoteMetalSelection:b,syncQuoteMetalInput:y,toggleFieldVisibility:p,updateMetalWeightLabels:v}}function Tt({state:e,ui:t,apiFetch:o,showToast:r,loadList:s,getActionEndpoint:S,getSelectedRecordId:h,collectEditableUpdates:v,getNotesValue:d,collectOrderDetailsUpdates:p,requiredShippingFields:f,pricingTabs:l,getEditField:m,collectConfirmChanges:y,buildConfirmationEmail:b,resolveConfirmationUrl:w,openConfirmModal:g,closeConfirmModal:i,loadOrderDetails:a}){let u=async E=>{if(e.tab!=="quotes")return!0;let I=v(),n=d();if(!Object.keys(I).length&&!n)return!0;let c=S();return c?(await o(c,{method:"POST",body:JSON.stringify({action:"edit",requestId:E,fields:I,notes:n})})).ok?!0:(r("Save failed","error"),!1):(r("No edits allowed.","error"),!1)};return{prepareConfirmation:async()=>{if(!e.selectedItem||!e.selectedItem.request_id){r("Missing request ID","error");return}let E=y();if(!E.length){r("No order updates to confirm.","error");return}t.confirmSend&&(t.confirmSend.disabled=!0);try{let I=await o("/orders/confirm",{method:"POST",body:JSON.stringify({requestId:e.selectedItem.request_id,changes:E,email:e.selectedItem.email||"",name:e.selectedItem.name||"",productName:e.selectedItem.product_name||""})}),n=w(I);if(!I.ok||!n)throw new Error("confirmation_failed");let c=b(e.selectedItem,E,n);e.pendingChanges=E,e.confirmation={confirmationUrl:n,emailPayload:c,changes:E},g({to:e.selectedItem.email||"--",subject:c.subject,previewHtml:c.previewHtml})}catch{r("Unable to build confirmation email.","error")}finally{t.confirmSend&&(t.confirmSend.disabled=!1)}},runAction:async E=>{let I=h();if(!I){r("Missing record ID","error");return}if(e.tab==="quotes"&&E==="refresh_quote"&&!await u(I))return;let n=e.tab==="orders"?p():{};if(e.tab==="orders"&&E==="mark_shipped"&&f.filter(M=>!n[M]).length){r("Add required fulfillment details before shipping.","error");return}let c={action:E};e.tab==="cost-chart"||e.tab==="diamond-price-chart"?c.rowNumber=I:c.requestId=I,e.tab==="orders"&&Object.keys(n).length&&(c.details=n),e.tab==="quotes"&&E==="submit_quote"&&(c.fields=v());let _=S();if(!_){r("No actions available.","error");return}(await o(_,{method:"POST",body:JSON.stringify(c)})).ok?(r("Action saved"),await s()):r("Action failed","error")},saveDetails:async()=>{let E=h();if(!E){r("Missing record ID","error");return}let I=v(),n=d();l.has(e.tab)&&(I.notes=n);let c={action:"edit",fields:I};e.tab==="cost-chart"||e.tab==="diamond-price-chart"?c.rowNumber=E:(c.requestId=E,c.notes=n);let _=S();if(!_){r("No edits allowed.","error");return}(await o(_,{method:"POST",body:JSON.stringify(c)})).ok?(r("Updates saved"),await s()):r("Update failed","error")},saveNotes:async()=>{if(l.has(e.tab)){r("Use Save updates for pricing notes.","error");return}let E=h();if(!E){r("Missing record ID","error");return}if(e.tab==="tickets"){let D=d();if(!D){r("Add a comment first.","error");return}if((await o("/tickets/action",{method:"POST",body:JSON.stringify({action:"add_note",requestId:E,note:D})})).ok){r("Comment added");let M=m("notes");M&&(M.value=""),await s()}else r("Comment failed","error");return}let n={action:"edit",notes:d()};e.tab==="cost-chart"||e.tab==="diamond-price-chart"?n.rowNumber=E:n.requestId=E;let c=S();if(!c){r("No edits allowed.","error");return}(await o(c,{method:"POST",body:JSON.stringify(n)})).ok?(r("Notes saved"),await s()):r("Notes failed","error")},saveOrderDetails:async()=>{if(!e.selectedItem||!e.selectedItem.request_id){r("Missing request ID","error");return}let E=p();if(!Object.keys(E).length){r("No fulfillment details to save.","error");return}let I={requestId:e.selectedItem.request_id,action:"edit",details:E};(await o("/orders/action",{method:"POST",body:JSON.stringify(I)})).ok?(r("Fulfillment details saved"),await a(e.selectedItem.request_id)):r("Fulfillment save failed","error")},saveStatus:async()=>{let E=h();if(!E){r("Missing record ID","error");return}let I=t.statusSelect.value;if(!I)return;let n=e.tab==="orders"?p():{};if(e.tab==="orders"&&I==="SHIPPED"&&f.filter(M=>!n[M]).length){r("Add required fulfillment details before shipping.","error");return}let c={requestId:E,action:"set_status",status:I};e.tab==="orders"&&Object.keys(n).length&&(c.details=n);let _=S();if(!_){r("No status updates available.","error");return}(await o(_,{method:"POST",body:JSON.stringify(c)})).ok?(r("Status updated"),await s()):r("Status failed","error")},sendConfirmation:async()=>{if(!e.selectedItem||!e.selectedItem.request_id){r("Missing request ID","error");return}if(!y().length){r("No order updates to confirm.","error");return}let I=e.confirmation;if(!I||!I.confirmationUrl){r("Open the confirmation preview first.","error");return}let n=I.emailPayload;if(!n){r("Confirmation email is missing.","error");return}let c=v(),_=d(),D={requestId:e.selectedItem.request_id,action:"request_confirmation",status:"PENDING_CONFIRMATION",notes:_,fields:c};if(!(await o("/orders/action",{method:"POST",body:JSON.stringify(D)})).ok){r("Update failed before email.","error");return}(await o("/email",{method:"POST",body:JSON.stringify({to:e.selectedItem.email||"",subject:n.subject,textBody:n.textBody,htmlBody:n.htmlBody,requestId:e.selectedItem.request_id,orderStatus:"PENDING_CONFIRMATION"})})).ok?(r("Confirmation sent"),i(),await s()):r("Email failed","error")}}}function Pt({ui:e,getApiBase:t,getStoredAdminEmail:o,getLocalAdminEmail:r,buildAdminHeaders:s,showToast:S,windowRef:h}){let v=(l,m)=>{l&&(l.disabled=!m,l.classList.toggle("is-disabled",!m),l.setAttribute("aria-disabled",m?"false":"true"))},d=l=>{e.deployStatus&&(e.deployStatus.textContent=l)},p=async()=>{let l=t();if(!l)throw new Error("Missing API base");let m=l.endsWith("/")?l:`${l}/`,y=new URL("deploy-site",m),b=m.startsWith("http://localhost")||m.startsWith("http://127.0.0.1"),w=b?o():r();b&&w&&y.searchParams.set("admin_email",w);let g=await fetch(y.toString(),{method:"POST",credentials:b?"omit":"include",headers:s({},w),body:"{}"}),i=null;try{i=await g.json()}catch{i=null}if(!g.ok){let a=i?.error||g.statusText;throw new Error(a)}return i||{ok:!0}};return{triggerSiteRebuild:async()=>{if(!(!e.triggerDeploy||!h.confirm("Trigger a site rebuild? This will run the deploy workflow."))){d("Dispatching..."),v(e.triggerDeploy,!1);try{let m=await p(),y=new Date().toLocaleTimeString();d(`Queued ${y}`);let b=m?.ok?"":` (${m?.error||"unknown"})`;S(`Rebuild triggered${b}`)}catch(m){let y=m?.message?String(m.message):"Rebuild failed";d("Failed"),S(y,"error")}finally{v(e.triggerDeploy,!0)}}}}}function zt({item:e,formatDate:t,formatPhone:o,getContactNotes:r}){return[["Created",t(e.created_at)],["Name",e.name],["Email",e.email],["Phone",o(e.phone)],["Type",e.type],["Subscribed",e.subscribed],["Sources",e.sources],["First seen",t(e.first_seen_at)],["Last seen",t(e.last_seen_at)],["Last source",e.last_source],["Unsubscribed at",t(e.unsubscribed_at)],["Unsubscribed reason",e.unsubscribed_reason],["Customer notes",r(e)],["Updated",t(e.updated_at)]]}function Mt({item:e,formatDate:t,formatPhone:o}){return[["Request ID",e.request_id],["Created",t(e.created_at)],["Status",e.status],["Name",e.name],["Email",e.email],["Phone",o(e.phone)],["Interests",e.interests],["Contact preference",e.contact_preference],["Customer notes",e.notes]]}function Bt({item:e,formatDate:t,formatPhone:o,formatPrice:r,formatDelayWeeks:s,formatGrams:S,formatSignedGrams:h,buildMetalWeightLabel:v,buildMetalWeightAdjustmentLabel:d,buildSizingRows:p,renderQuoteMediaSlot:f}){return[{title:"Request",rows:[["Request ID",e.request_id],["Created",t(e.created_at)],["Status",e.status]]},{title:"Client",rows:[["Name",e.name],["Email",e.email],["Phone",o(e.phone)]]},{title:"Piece",rows:[["Product",e.product_name],["Images",f()],["Design code",e.design_code],["Metal",e.metal],[v(e.metal),S(e.metal_weight)],[d(e.metal),h(e.metal_weight_adjustment)],["Stone",e.stone],["Stone weight",e.stone_weight],["Diamond breakdown",e.diamond_breakdown],...p(e)]},{title:"Timeline & Pricing",rows:[["Price",r(e.price)],["Timeline",e.timeline],["Timeline delay",s(e.timeline_adjustment_weeks)]]},{title:"Address",rows:[["Address",e.address_line1],["City",e.city],["State",e.state],["Postal code",e.postal_code],["Country",e.country]]},{title:"Preferences",rows:[["Interests",e.interests],["Contact preference",e.contact_preference],["Subscription",e.subscription_status]]}]}function Ft({item:e}){return[["Row",e.row_number],["Key",e.key],["Value",e.value],["Unit",e.unit],["Notes",e.notes]]}function jt({item:e}){return[["Row",e.row_number],["Clarity",e.clarity],["Color",e.color],["Weight min",e.weight_min],["Weight max",e.weight_max],["Price per ct",e.price_per_ct],["Notes",e.notes]]}function Ht(){return[]}function Wt(){return[]}function Ut(){return[]}function Vt({state:e,ui:t,setTab:o,loadCurrentView:r,setAutoRefresh:s,updateSyncLine:S,clearSelection:h,handleBulkAction:v,exportData:d,updateBulkActions:p,renderList:f,getItemKey:l,canEditCurrentTab:m,getActionEndpoint:y,showToast:b,apiFetch:w,buildDeletePayload:g,detailUrl:i,populateDrawer:a,openDrawer:u,bindDrawerEvents:k,runAction:q,triggerSiteRebuild:$,applyDiscountControlState:T,applyGoldOnlyQuoteState:C,setQuoteMetalSelection:P,syncQuoteMetalInput:N,updatePrimaryActionState:E,scheduleQuotePricingUpdate:I,getDiamondRowsFromDom:n,renderDiamondBreakdownRows:c,syncDiamondBreakdownField:_,setDiamondBreakdownRowsFromField:D,getDiamondBreakdownField:z,syncSizingToSizeField:M,prepareConfirmation:W,saveDetails:H,saveNotes:j,saveOrderDetails:G,saveStatus:O,closeConfirmModal:J,sendConfirmation:ee,quotePriceFields:te,quotePricingFields:re}){return{bindEvents:()=>{t.tabs.forEach(L=>{L.addEventListener("click",()=>{o(L.dataset.tab)})}),t.filters.forEach(L=>{L.addEventListener("change",()=>{L.dataset.filter==="limit"?e.limit=Number(L.value)||e.limit:e.filters[L.dataset.filter]=L.value.trim(),e.offset=0,r()}),L.tagName==="INPUT"&&L.addEventListener("input",()=>{L.dataset.filter!=="limit"&&(e.filters[L.dataset.filter]=L.value.trim()),e.offset=0,r()})}),t.prev.addEventListener("click",()=>{e.offset=Math.max(e.offset-e.limit,0),r()}),t.next.addEventListener("click",()=>{e.offset+e.limit>=e.total||(e.offset+=e.limit,r())}),t.refresh.addEventListener("click",()=>{t.autoRefresh?.checked||r()}),t.bulkActions&&t.bulkActions.addEventListener("click",L=>{let x=L.target;if(!(x instanceof HTMLElement))return;if(x.dataset.bulkClear!==void 0){h();return}let B=x.dataset.bulkAction;B&&v(B)}),t.exportButtons.length&&t.exportButtons.forEach(L=>{L.addEventListener("click",()=>{d(L.dataset.export||"csv")})}),t.autoRefresh&&t.autoRefresh.addEventListener("change",()=>{s(t.autoRefresh.checked),S()}),t.triggerDeploy&&t.triggerDeploy.addEventListener("click",$),t.list.addEventListener("click",L=>{let x=L.target;if(!(x instanceof HTMLElement)||x.closest(".inline-input"))return;if(x.dataset.inlineEdit){let F=x.closest(".list-row");if(!F||!m())return;let U=Array.from(F.querySelectorAll(".inline-input")),Xe=Array.from(F.querySelectorAll("[data-inline-display]")),gr=F.classList.contains("is-editing"),Ye=y();if(!Ye)return;if(!gr){F.classList.add("is-editing"),U.forEach(X=>X.classList.remove("is-hidden")),Xe.forEach(X=>X.classList.add("is-hidden"));let Z=U[0];Z&&(Z.focus(),Z.select());return}let _e=F.dataset.row||F.querySelector(".inline-input")?.dataset.rowNumber||"";if(!_e)return;let fe={};U.forEach(Z=>{let X=Z.dataset.inlineField||"";X&&(fe[X]=Z.value)}),w(Ye,{method:"POST",body:JSON.stringify({action:"edit",rowNumber:_e,fields:fe})}).then(Z=>{if(Z.ok){let X=e.items.find(V=>String(V.row_number)===String(_e));X&&Object.keys(fe).forEach(V=>{X[V]=fe[V]}),U.forEach(V=>{let Ze=V.closest(".cell")?.querySelector("[data-inline-display]");Ze&&(Ze.textContent=V.value)}),b("Saved"),F.classList.remove("is-editing"),U.forEach(V=>V.classList.add("is-hidden")),Xe.forEach(V=>V.classList.remove("is-hidden"));return}b("Update failed","error")}).catch(()=>{b("Update failed","error")});return}if(x instanceof HTMLInputElement&&x.hasAttribute("data-bulk-select-all")){let F=e.items.map(U=>l(U)).filter(Boolean);x.checked?e.selectedItems=F:e.selectedItems=[],p(),f();return}if(x instanceof HTMLInputElement&&x.dataset.bulkSelectItem!==void 0){let F=x.dataset.bulkSelectItem;if(!F)return;x.checked?e.selectedItems.includes(F)||e.selectedItems.push(F):e.selectedItems=e.selectedItems.filter(U=>U!==F),p(),f();return}let Y=x.dataset.delete;if(Y){if(!m()||!window.confirm("Delete this record? This cannot be undone."))return;let F=y();if(!F){b("No actions available.","error");return}w(F,{method:"POST",body:JSON.stringify(g(e.tab,Y))}).then(U=>{if(U.ok){b("Record deleted"),r();return}b("Delete failed","error")}).catch(()=>{b("Delete failed","error")});return}let Je=x.dataset.view;if(Je){window.location.href=i(Je);return}let ue=x.closest(".list-row");if(ue){if(e.tab==="cost-chart"||e.tab==="diamond-price-chart")return;let F=ue.dataset.row||ue.dataset.slug||ue.dataset.id||"";F?window.location.href=i(F):b("Missing record ID for detail view.","error")}}),t.list.addEventListener("keydown",L=>{let x=L.target;if(x instanceof HTMLInputElement&&x.classList.contains("inline-input")){if(L.key==="Enter"){L.preventDefault();let Y=x.closest(".list-row")?.querySelector("[data-inline-edit]");Y instanceof HTMLElement&&Y.click()}else if(L.key==="Escape"){L.preventDefault();let B=x.closest(".cell")?.querySelector("[data-inline-display]");B&&(x.value=B.textContent||"",B.classList.remove("is-hidden")),x.classList.add("is-hidden")}}}),t.addRowButton&&t.addRowButton.addEventListener("click",()=>{window.location.href=i("new")}),k(),t.actionButtons.addEventListener("click",L=>{let x=L.target;if(!(x instanceof HTMLElement))return;let B=x.dataset.action,Y=x.dataset.confirm;B&&(Y&&!window.confirm(Y)||q(B))}),t.editFields.forEach(L=>{let x=()=>{let B=L.dataset.field||"";B==="metal"&&(E(),P(t.quoteMetalInput?t.quoteMetalInput.value:"",L.value)),B==="quote_discount_type"&&T(),(B==="stone_weight"||B==="diamond_breakdown")&&C(),e.tab==="quotes"&&B&&(te.has(B)?L.value?(L.dataset.auto="false",L.dataset.manual="true"):(L.dataset.manual="",L.dataset.auto="true",I()):re.has(B)&&I()),E()};L.addEventListener("input",x),L.addEventListener("change",x)}),t.quoteMetals.forEach(L=>{L.addEventListener("change",()=>{N(),E()})}),t.diamondBreakdownAdd&&t.diamondBreakdownAdd.addEventListener("click",()=>{let L=n();L.push({weight:"",count:""}),c(L),I()}),t.diamondBreakdownRows&&(t.diamondBreakdownRows.addEventListener("input",L=>{L.target instanceof HTMLInputElement&&(!L.target.hasAttribute("data-diamond-weight")&&!L.target.hasAttribute("data-diamond-count")||(_(),E(),I()))}),t.diamondBreakdownRows.addEventListener("click",L=>{let x=L.target;if(!(x instanceof HTMLElement)||!x.hasAttribute("data-diamond-remove"))return;let B=x.closest("[data-diamond-row]");B&&B.remove(),_(),E(),I(),t.diamondBreakdownRows.querySelector("[data-diamond-row]")||c([])}));let ae=z();ae&&ae.addEventListener("input",()=>{D(),E(),I()}),[t.sizeRing,t.sizeBracelet,t.sizeChain].forEach(L=>{L&&["input","change"].forEach(x=>{L.addEventListener(x,()=>{M(),I(),E()})})}),t.primaryAction&&t.primaryAction.addEventListener("click",()=>{if(e.tab!=="orders"){window.confirm("Save updates to this record?")&&H();return}W()}),t.notesSave&&t.notesSave.addEventListener("click",()=>{window.confirm("Save internal notes?")&&j()}),t.detailsSave&&t.detailsSave.addEventListener("click",()=>{window.confirm("Save fulfillment details?")&&G()}),t.statusSave.addEventListener("click",()=>{window.confirm("Update status for this record?")&&O()}),t.confirmClose&&t.confirmClose.addEventListener("click",J),t.confirmModal&&t.confirmModal.addEventListener("click",L=>{L.target===t.confirmModal&&J()}),t.confirmSend&&t.confirmSend.addEventListener("click",()=>{window.confirm("Send confirmation to customer?")&&ee()})}}}function Qt({state:e,ui:t,tabLabels:o,detailFieldBuilders:r,detailSectionBuilders:s,editFields:S,formatDate:h,formatPhone:v,formatPrice:d,formatDelayWeeks:p,formatGrams:f,formatSignedGrams:l,buildMetalWeightLabel:m,buildMetalWeightAdjustmentLabel:y,buildSizingRows:b,renderDetailRows:w,renderDetailSections:g,renderQuoteMediaSlot:i,refreshQuoteMedia:a,refreshSizingInputs:u,updateMetalWeightLabels:k,setQuoteMetalSelection:q,setDiamondBreakdownRowsFromField:$,resetQuoteAutoPricingState:T,scheduleQuotePricingUpdate:C,applyOrderDetailsVisibility:P,applyQuoteVisibility:N,applyDiscountControlState:E,applyGoldOnlyQuoteState:I,updatePrimaryActionState:n,renderActions:c,updateStatusOptions:_,getContactNotes:D,setOriginalValues:z,toggleDiamondBreakdownVisibility:M,applySizingVisibility:W,isFilled:H}){let j=()=>{let O=new Set(S[e.tab]);t.editFields.forEach(J=>{let ee=J.closest(".field"),te=J.dataset.field||"",re=O.has(te);ee&&ee.classList.toggle("is-hidden",!re)}),t.editSection&&t.editSection.classList.toggle("is-hidden",O.size===0),N()};return{applyEditVisibility:j,populateDrawer:O=>{let J=O.request_id||O.email||O.row_number||O.slug||O.id||O.media_id||""||"Record";e.selectedId=J,e.selectedItem=O,z(O),e.pendingChanges=[],e.confirmation=null;let ee=o[e.tab]||e.tab;t.detailType.textContent=`${ee} details`,t.detailTitle.textContent=O.product_name||O.name||O.key||O.metal||O.clarity||J,t.detailSub.textContent=J;let te=e.tab==="contacts"||e.tab==="cost-chart"||e.tab==="diamond-price-chart"?"--":O.status||"NEW";t.detailStatus.textContent=te,t.detailStatus.dataset.status=te,_(),t.statusSelect&&t.statusSelect.options.length&&(t.statusSelect.value=t.statusSelect.options[0].value||"");let re={item:O,formatDate:h,formatPhone:v,formatPrice:d,formatDelayWeeks:p,formatGrams:f,formatSignedGrams:l,buildMetalWeightLabel:m,buildMetalWeightAdjustmentLabel:y,buildSizingRows:b,renderQuoteMediaSlot:i,getContactNotes:D},Ke=r[e.tab]?r[e.tab](re):[],ae=s[e.tab]?s[e.tab](re):[];ae.length?(t.detailGrid.classList.add("detail-sections"),t.detailGrid.innerHTML=g(ae,H)):(t.detailGrid.classList.remove("detail-sections"),t.detailGrid.innerHTML=w(Ke,H)),a(O),u(O),t.editFields.forEach(L=>{let x=L.dataset.field;if(x){if(x==="notes"){L.value=O.notes||"";return}L.value=O[x]||""}}),k(O.metal||""),q(O.quote_metal_options||"",O.metal||""),$(),T(),C(),j(),P(),N(),E(),I(),M(),W(null),c(),n()}}}function Gt({ui:e,apiFetch:t,showToast:o,windowRef:r}){let s=[],S=f=>{e.notificationsPanel&&(e.notificationsPanel.classList.toggle("is-open",f),e.notificationsPanel.setAttribute("aria-hidden",f?"false":"true"),f?e.notificationsPanel.removeAttribute("inert"):e.notificationsPanel.setAttribute("inert",""))},h=()=>{if(!e.notificationsList)return;if(!s.length){e.notificationsList.innerHTML='<p class="muted">No notifications right now.</p>',e.notificationsBadge&&(e.notificationsBadge.textContent="",e.notificationsBadge.classList.add("is-hidden"));return}let f=s.filter(l=>!l.read).length;e.notificationsBadge&&(e.notificationsBadge.textContent=f?String(f):"",e.notificationsBadge.classList.toggle("is-hidden",f===0)),e.notificationsList.innerHTML=s.map(l=>{let m=l.title||l.type||"Update",y=l.message||l.body||"",b=l.created_at||l.createdAt||"";return`
          <button class="notification-item ${l.read?"":"is-unread"}" type="button" data-notification-id="${l.id||""}">
            <div class="notification-title">${m}</div>
            <div class="notification-body">${y}</div>
            <div class="notification-meta">${b}</div>
          </button>
        `}).join("")},v=async()=>{try{let f=await t("/notifications");s=Array.isArray(f?.items)?f.items:f||[],h()}catch(f){if(f?.status===404){s=[],h();return}s=[],h(),r.location.hostname==="localhost"&&o("Notifications unavailable.","error")}},d=async f=>{if(f)try{await t(`/notifications/${f}/read`,{method:"POST"}),s=s.map(l=>String(l.id)===String(f)?{...l,read:!0}:l),h()}catch{o("Failed to mark notification read.","error")}};return{bindNotifications:()=>{e.notificationsToggle&&e.notificationsToggle.addEventListener("click",()=>{let f=e.notificationsPanel?.classList.contains("is-open");S(!f),f||v()}),e.notificationsClose&&e.notificationsClose.addEventListener("click",()=>S(!1)),e.notificationsList&&e.notificationsList.addEventListener("click",f=>{let l=f.target.closest("[data-notification-id]");l&&d(l.dataset.notificationId)})},loadNotifications:v}}function Kt({ui:e,apiFetch:t,showToast:o}){let r=()=>e.consultationsRange&&e.consultationsRange.value||"30",s=(f,l)=>{f&&(f.textContent=l??"--")},S=f=>{e.consultationsSource&&(e.consultationsSource.innerHTML=f.map(l=>{let m=l.total||0,y=l.became_quotes||0,b=m?(y/m*100).toFixed(1):"0.0";return`
          <tr>
            <td>${l.source||"Unknown"}</td>
            <td>${m}</td>
            <td>${l.completed||0}</td>
            <td>${y}</td>
            <td>${l.became_orders||0}</td>
            <td>${b}%</td>
          </tr>
        `}).join(""))},h=f=>{e.consultationsCampaign&&(e.consultationsCampaign.innerHTML=f.map(l=>{let m=l.bookings||0,y=l.conversions||0,b=m?(y/m*100).toFixed(1):"0.0";return`
          <tr>
            <td>${l.utm_campaign||"N/A"}</td>
            <td>${l.utm_source||"N/A"}</td>
            <td>${l.utm_medium||"N/A"}</td>
            <td>${m}</td>
            <td>${y}</td>
            <td>${b}%</td>
          </tr>
        `}).join(""))},v=f=>{e.consultationsHear&&(e.consultationsHear.innerHTML=f.map(l=>`
          <tr>
            <td>${l.how_heard_about_us||"Not specified"}</td>
            <td>${l.count||0}</td>
          </tr>
        `).join(""))},d=async()=>{let f=r();try{let l=await t(`/consultations/analytics?days=${f}`),m=l?.data||l;if(!m)throw new Error("Missing analytics data");let y=m.sourceStats||[],b=m.campaignStats||[],w=m.hearAboutStats||[],g=0,i=0,a=0,u=0;y.forEach(k=>{g+=k.total||0,i+=k.completed||0,a+=k.became_quotes||0,u+=k.became_orders||0}),s(e.consultationsTotal,g),s(e.consultationsCompleted,i),s(e.consultationsQuotes,a),s(e.consultationsOrders,u),S(y),h(b),v(w)}catch{o("Failed to load consultations analytics.","error")}};return{bindConsultations:()=>{e.consultationsRefresh&&e.consultationsRefresh.addEventListener("click",d),e.consultationsRange&&e.consultationsRange.addEventListener("change",d)},loadConsultations:d}}function Jt({ui:e,apiFetch:t,showToast:o}){let r=b=>{b&&Object.entries(b).forEach(([w,g])=>{let i=document.querySelector(`[data-count-${w}]`);if(!i)return;let a=Number(g)||0;i.textContent=String(a),i.style.display=a>0?"inline-flex":"none"})},s=async()=>{try{let b=await t("/navigation/counts");r(b||{})}catch(b){if(b?.status===404){r({});return}o("Failed to load sidebar counts.","error")}},S=()=>{s(),setInterval(s,3e4)},h=b=>{b.forEach(w=>{w.style.display="",w.classList.remove("search-highlight")}),document.querySelector(".side-search__no-results")?.remove()},v=(b,w)=>{let g=document.querySelector(".side-search__no-results");if(b&&!g){let i=document.querySelector(".side-search");if(!i)return;let a=document.createElement("div");a.className="side-search__no-results",a.innerHTML=`
        <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.3;margin-bottom:8px;">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <p>No sections matching<br/><strong>"${w}"</strong></p>
      `,i.after(a)}else!b&&g&&g.remove()},d=(b,w,g)=>{let i=!1;g.forEach(a=>{let u=Array.from(a.querySelectorAll(".side-link")),k=!1;if(u.forEach(q=>{let T=(q.querySelector(".side-link__label")?.textContent?.toLowerCase()||"").includes(b);q.style.display=T?"":"none",T?(q.classList.add("search-highlight"),k=!0,i=!0):q.classList.remove("search-highlight")}),k&&a.classList.contains("is-collapsed")){a.classList.remove("is-collapsed");let q=a.querySelector("[data-side-toggle]");q&&(q.textContent="-")}}),v(!i,b)},p=()=>{let b=e.sidebarSearch;if(!b)return;let w=Array.from(document.querySelectorAll(".side-link")),g=Array.from(document.querySelectorAll(".side-block"));b.addEventListener("input",i=>{let a=String(i.target.value||"").toLowerCase().trim();if(!a){h(w);return}d(a,w,g)}),b.addEventListener("keydown",i=>{i.key==="Escape"&&(b.value="",b.dispatchEvent(new Event("input")),b.blur())})},f=()=>{let b=Array.from(document.querySelectorAll(".side-link")),w=b.findIndex(g=>g.classList.contains("is-active"));w<0&&(w=0),document.addEventListener("keydown",g=>{if(!g.target.matches("input, textarea, select")){if((g.metaKey||g.ctrlKey)&&g.key.toLowerCase()==="k"){g.preventDefault(),e.sidebarSearch?.focus(),e.sidebarSearch?.select();return}if(g.altKey&&g.key>="1"&&g.key<="9"){g.preventDefault();let i=Number(g.key)-1;b[i]&&(b[i].click(),b[i].focus());return}g.altKey&&(g.key==="ArrowUp"||g.key==="ArrowDown")&&(g.preventDefault(),g.key==="ArrowUp"?w=w>0?w-1:b.length-1:w=w<b.length-1?w+1:0,b[w].click(),b[w].focus())}})},l=()=>{e.sidebar&&(e.sidebar.classList.remove("is-collapsed"),e.appShell?.classList.remove("sidebar-collapsed"))},m=()=>{document.querySelectorAll("[data-side-toggle]").forEach(g=>{g.addEventListener("click",()=>{let i=g.closest(".side-block");if(!i)return;let a=i.classList.toggle("is-collapsed");g.textContent=a?"+":"-";let u=i.dataset.blockId;if(u){let k=JSON.parse(localStorage.getItem("sidebar-collapsed-blocks")||"[]");if(a)k.includes(u)||k.push(u);else{let q=k.indexOf(u);q>-1&&k.splice(q,1)}localStorage.setItem("sidebar-collapsed-blocks",JSON.stringify(k))}})}),JSON.parse(localStorage.getItem("sidebar-collapsed-blocks")||"[]").forEach(g=>{let i=document.querySelector(`[data-block-id="${g}"]`);if(i&&!i.classList.contains("is-collapsed")){i.classList.add("is-collapsed");let a=i.querySelector("[data-side-toggle]");a&&(a.textContent="+")}})};return{initSidebar:()=>{l(),p(),f(),m(),S(),console.log("Sidebar initialized")},updateNavigationCounts:r}}var hr=[{key:"price",label:"Price",normalize:It,format:he},{key:"timeline",label:"Timeline",normalize:$e,format:Me},{key:"timeline_adjustment_weeks",label:"Timeline delay",normalize:le,format:ze},{key:"metal",label:"Metal",normalize:ne,format:Oe},{key:"metal_weight",label:"Metal weight (g)",normalize:le,format:Te},{key:"metal_weight_adjustment",label:"Final Metal weight difference (g)",normalize:le,format:Pe},{key:"stone",label:"Stone type",normalize:ne,format:Oe},{key:"stone_weight",label:"Stone weight",normalize:le,format:qt}],je=e=>{let t=String(e||"NEW").trim().toUpperCase();return t==="INVOICE_NOT_PAID"?"INVOICE_EXPIRED":t||"NEW"},yr=()=>{let e=je(A.selectedItem?.status);return(kt[e]||[]).filter(o=>o!=="PENDING_CONFIRMATION")};function He(){return A.tab==="orders"||A.tab==="quotes"?A.role==="admin"||A.role==="ops":A.tab==="tickets"?A.role==="admin"||A.role==="ops":A.tab==="cost-chart"||A.tab==="diamond-price-chart"?A.role==="admin":xe.has(A.tab)?A.role==="admin"||A.role==="ops":!1}var Xt=()=>A.tab===me,Yt=()=>A.tab==="consultations",wr=()=>Xt()||Yt(),vr=document.body.dataset.enableNavCounts==="true",Zt=()=>et.has(A.tab),R={syncLine:document.querySelector("[data-sync-line]"),userRole:document.querySelector("[data-user-role]"),userEmail:document.querySelector("[data-user-email]"),tabTitle:document.querySelector("[data-tab-title]"),autoRefresh:document.querySelector("[data-auto-refresh]"),tabs:Array.from(document.querySelectorAll("[data-tab]")),adminTabs:Array.from(document.querySelectorAll("[data-admin-only]")),dashboard:document.querySelector("[data-dashboard]"),filtersWrap:document.querySelector(".filters"),listWrap:document.querySelector(".list-wrap"),bulkActions:document.querySelector("[data-bulk-actions]"),addRowWrap:document.querySelector("[data-add-row-wrap]"),addRowButton:document.querySelector("[data-add-row]"),filters:Array.from(document.querySelectorAll("[data-filter]")),exportButtons:Array.from(document.querySelectorAll("[data-export]")),listHeader:document.querySelector("[data-list-header]"),list:document.querySelector("[data-list]"),results:document.querySelector("[data-results]"),prev:document.querySelector("[data-prev]"),next:document.querySelector("[data-next]"),refresh:document.querySelector("[data-refresh]"),drawer:document.querySelector("[data-drawer]"),drawerClose:document.querySelector("[data-drawer-close]"),detailType:document.querySelector("[data-detail-type]"),detailTitle:document.querySelector("[data-detail-title]"),detailSub:document.querySelector("[data-detail-sub]"),detailStatus:document.querySelector("[data-detail-status]"),statusSelect:document.querySelector("[data-status-select]"),statusSave:document.querySelector("[data-status-save]"),detailGrid:document.querySelector("[data-detail-grid]"),actionButtons:document.querySelector("[data-action-buttons]"),editSection:document.querySelector("[data-edit-section]"),quoteSection:document.querySelector("[data-quote-section]"),quoteMetals:Array.from(document.querySelectorAll('[data-quote-metals] input[type="checkbox"]')),quoteMetalInput:document.querySelector('[data-field="quote_metal_options"]'),metalWeightLabel:document.querySelector("[data-metal-weight-label]"),metalWeightAdjustmentLabel:document.querySelector("[data-metal-weight-adjustment-label]"),editFields:Array.from(document.querySelectorAll("[data-field]")),orderDetailsSection:document.querySelector("[data-order-details-section]"),orderDetailsFields:Array.from(document.querySelectorAll("[data-order-details-field]")),diamondBreakdown:document.querySelector("[data-diamond-breakdown]"),diamondBreakdownRows:document.querySelector("[data-diamond-breakdown-rows]"),diamondBreakdownAdd:document.querySelector("[data-diamond-breakdown-add]"),sizeRing:document.querySelector("[data-size-ring] input"),sizeBracelet:document.querySelector("[data-size-bracelet] input"),sizeChain:document.querySelector("[data-size-chain] input"),triggerDeploy:document.querySelector("[data-trigger-deploy]"),deployStatus:document.querySelector("[data-deploy-status]"),detailsSave:document.querySelector("[data-details-save]"),primaryAction:document.querySelector("[data-primary-action]"),notesSave:document.querySelector("[data-notes-save]"),confirmModal:document.querySelector("[data-confirm-modal]"),confirmClose:document.querySelector("[data-confirm-close]"),confirmTo:document.querySelector("[data-confirm-to]"),confirmSubject:document.querySelector("[data-confirm-subject]"),confirmPreview:document.querySelector("[data-confirm-preview]"),confirmSend:document.querySelector("[data-confirm-send]"),toast:document.querySelector("[data-toast]"),notificationsToggle:document.querySelector("[data-notifications-toggle]"),notificationsPanel:document.querySelector("[data-notifications-panel]"),notificationsList:document.querySelector("[data-notifications-list]"),notificationsBadge:document.querySelector("[data-notifications-badge]"),notificationsClose:document.querySelector("[data-notifications-close]"),consultationsSection:document.querySelector("[data-consultations]"),consultationsRange:document.querySelector("[data-consultations-range]"),consultationsRefresh:document.querySelector("[data-consultations-refresh]"),consultationsTotal:document.querySelector("[data-consultations-total]"),consultationsCompleted:document.querySelector("[data-consultations-completed]"),consultationsQuotes:document.querySelector("[data-consultations-quotes]"),consultationsOrders:document.querySelector("[data-consultations-orders]"),consultationsSource:document.querySelector("[data-consultations-source]"),consultationsCampaign:document.querySelector("[data-consultations-campaign]"),consultationsHear:document.querySelector("[data-consultations-hear]"),sidebar:document.querySelector("[data-sidebar]"),sidebarCollapse:document.querySelector("[data-sidebar-collapse]"),sidebarSearch:document.querySelector("[data-sidebar-search]"),appShell:document.querySelector(".app-shell")},K=tt(R.toast),{closeDrawer:er,openDrawer:Sr,renderDetailRows:kr,renderDetailSections:_r,bindDrawerEvents:Er}=at({ui:R,escapeHtml:ie}),{updateStatusOptions:tr,updateSortOptions:Lr,updateStatusFilterOptions:Ir}=nt({state:A,ui:R,statusOptions:Ie,sortOptions:ht,sortDefaults:yt,isDashboardTab:wr,getOrderStatusOptions:yr,normalizeStatus:je}),{buildDeletePayload:qr,detailUrl:Cr,getItemKey:ve,getSelectedRecordId:Dr}=ut({state:A,storage:typeof localStorage>"u"?null:localStorage,locationHref:window.location.href}),{renderList:Se}=rt({state:A,ui:R,listColumns:qe,isBulkEnabled:Zt,canEditCurrentTab:He,getValue:br,getItemKey:ve,normalizeImageUrl:rr,escapeAttribute:se}),{updateBulkActions:We,handleBulkAction:xr}=st({state:A,ui:R,apiFetch:Q,getActionEndpoint:Ve,showToast:K,renderList:Se,loadList:fr,isBulkEnabled:Zt,clearSelection:pr}),{exportData:Ar}=lt({state:A,listColumns:qe,getItemKey:ve,getValue:br,showToast:K}),ce=null,Ue=e=>{ce&&ce.setTab&&(ce.setTab(e),Ur(e))},{loadDashboard:Nr}=it({apiFetch:Q,ui:R,setTab:Ue,escapeHtml:ie}),Rr=pe(),$r=(document.body.dataset.siteBase||"https://www.heerawalla.com").replace(/\/$/,""),rr=e=>Lt(e,$r),Or=e=>ct(e),Ve=()=>dt(A.tab),we=localStorage.getItem("adminAutoRefresh")!=="false";R.autoRefresh&&(R.autoRefresh.checked=we);var Tr=e=>{we=e,localStorage.setItem("adminAutoRefresh",String(we))},{getCatalogBase:Pr,loadCatalog:zr,refreshQuoteMedia:Mr,renderQuoteMediaSlot:Br,resolveCatalogEntry:Fr}=xt({apiBase:Rr,ui:R,normalizeImageUrl:rr,escapeAttribute:se}),{ensureLocalAdminAccess:jr}=ft({getLocalAdminEmail:oe,storage:typeof localStorage>"u"?null:localStorage,documentRef:document,windowRef:window}),{setLastSync:Hr,setSyncStatus:Be,updateSyncLine:nr}=pt({ui:R}),{getInitialTab:Wr,updateTabInUrl:Ur}=mt({windowRef:window}),{applySizingVisibility:ar,buildSizingRows:Vr,getDiamondBreakdownField:Qr,getDiamondRowsFromDom:Gr,refreshSizingInputs:Kr,renderDiamondBreakdownRows:Jr,setDiamondBreakdownRowsFromField:or,syncDiamondBreakdownField:Xr,syncSizingToSizeField:Yr,toggleDiamondBreakdownVisibility:ir}=Ct({state:A,ui:R,escapeAttribute:se,isFilled:ye,normalizeText:ne,getEditField:ke,getEditValue:de,loadCatalog:zr,resolveCatalogEntry:Fr}),{applyDiscountControlState:sr,applyGoldOnlyQuoteState:Qe,buildMetalWeightAdjustmentLabel:Zr,buildMetalWeightLabel:en,getRequestedMetalGroup:fo,isGoldOnlyQuote:tn,setQuoteMetalSelection:lr,syncQuoteMetalInput:cr,toggleFieldVisibility:mo,updateMetalWeightLabels:rn}=Ot({state:A,ui:R,normalizeText:ne,getEditValue:de,getEditField:ke}),{collectConfirmChanges:nn,collectEditableUpdates:an,getNotesValue:on,renderActions:sn,setOriginalValues:ln,updatePrimaryActionState:Ge}=gt({state:A,ui:R,confirmFields:hr,editFields:Ce,pricingTabs:be,canEditCurrentTab:He,actions:wt,orderActionFlow:_t,normalizeStatus:je,syncQuoteMetalInput:cr,getEditValue:de}),{markQuotePriceManual:po,resetQuoteAutoPricingState:cn,scheduleQuotePricingUpdate:dr,quotePriceFields:dn}=At({state:A,ui:R,quoteOptionFields:ge,quotePricingFields:Ae,quotePriceFields:Et,isGoldOnlyQuote:tn,getEditField:ke,getEditValue:de,getCatalogBase:Pr,updatePrimaryActionState:Ge}),{buildConfirmationEmail:un,resolveConfirmationUrl:fn,openConfirmModal:mn,closeConfirmModal:ur}=Rt({ui:R,escapeHtml:ie,escapeAttribute:se,buildEtaLine:$n,getEditValue:de}),{applyOrderDetailsVisibility:pn,collectOrderDetailsUpdates:bn,loadOrderDetails:gn,populateOrderDetails:bo}=$t({state:A,ui:R,apiFetch:Q,orderDetailsFields:vt}),{prepareConfirmation:hn,runAction:yn,saveDetails:wn,saveNotes:vn,saveOrderDetails:Sn,saveStatus:kn,sendConfirmation:_n}=Tt({state:A,ui:R,apiFetch:Q,showToast:K,loadList:fr,getActionEndpoint:Ve,getSelectedRecordId:Dr,collectEditableUpdates:an,getNotesValue:on,collectOrderDetailsUpdates:bn,requiredShippingFields:St,pricingTabs:be,getEditField:ke,collectConfirmChanges:nn,buildConfirmationEmail:un,resolveConfirmationUrl:fn,openConfirmModal:mn,closeConfirmModal:ur,loadOrderDetails:gn}),{triggerSiteRebuild:En}=Pt({ui:R,getApiBase:pe,getStoredAdminEmail:Ee,getLocalAdminEmail:oe,buildAdminHeaders:Le,showToast:K,windowRef:window}),{bindNotifications:Ln}=Gt({ui:R,apiFetch:Q,showToast:K,windowRef:window}),{bindConsultations:In,loadConsultations:qn}=Kt({ui:R,apiFetch:Q,showToast:K}),{initSidebar:Cn,updateNavigationCounts:Dn}=Jt({ui:R,apiFetch:Q,showToast:K});ce=bt({state:A,ui:R,tabLabels:De,isDashboardTab:Xt,isConsultationsTab:Yt,loadConsultations:qn,updateStatusOptions:tr,updateStatusFilterOptions:Ir,updateSortOptions:Lr,updateBulkActions:We,loadDashboard:Nr,apiFetch:Q,getTabEndpoint:Or,renderList:Se,getItemKey:ve,populateDrawer:mr,closeDrawer:er,setSyncStatus:Be,setLastSync:Hr,showToast:K,pricingTabs:be,catalogTabs:xe});var{buildQuery:go,loadCurrentView:Fe,loadList:fr,updateAddRowVisibility:xn,updateDashboardVisibility:ho,updateTabVisibility:An}=ce,{populateDrawer:mr,applyEditVisibility:yo}=Qt({state:A,ui:R,tabLabels:De,detailFieldBuilders:{contacts:zt,tickets:Mt,"cost-chart":Ft,"diamond-price-chart":jt,products:Ht,inspirations:Wt,"media-library":Ut},detailSectionBuilders:{orders:Bt,quotes:Dt},editFields:Ce,formatDate:Ne,formatPhone:Re,formatPrice:he,formatDelayWeeks:ze,formatGrams:Te,formatSignedGrams:Pe,buildMetalWeightLabel:en,buildMetalWeightAdjustmentLabel:Zr,buildSizingRows:Vr,renderDetailRows:kr,renderDetailSections:_r,renderQuoteMediaSlot:Br,refreshQuoteMedia:Mr,refreshSizingInputs:Kr,updateMetalWeightLabels:rn,setQuoteMetalSelection:lr,setDiamondBreakdownRowsFromField:or,resetQuoteAutoPricingState:cn,scheduleQuotePricingUpdate:dr,applyOrderDetailsVisibility:pn,applyQuoteVisibility:On,applyDiscountControlState:sr,applyGoldOnlyQuoteState:Qe,updatePrimaryActionState:Ge,renderActions:sn,updateStatusOptions:tr,getContactNotes:Rn,setOriginalValues:ln,toggleDiamondBreakdownVisibility:ir,applySizingVisibility:ar,isFilled:ye}),{bindEvents:Nn}=Vt({state:A,ui:R,setTab:Ue,loadCurrentView:Fe,setAutoRefresh:Tr,updateSyncLine:nr,clearSelection:pr,handleBulkAction:xr,exportData:Ar,updateBulkActions:We,renderList:Se,getItemKey:ve,canEditCurrentTab:He,getActionEndpoint:Ve,showToast:K,apiFetch:Q,buildDeletePayload:qr,detailUrl:Cr,populateDrawer:mr,openDrawer:Sr,bindDrawerEvents:Er,runAction:yn,triggerSiteRebuild:En,applyDiscountControlState:sr,applyGoldOnlyQuoteState:Qe,setQuoteMetalSelection:lr,syncQuoteMetalInput:cr,updatePrimaryActionState:Ge,scheduleQuotePricingUpdate:dr,getDiamondRowsFromDom:Gr,renderDiamondBreakdownRows:Jr,syncDiamondBreakdownField:Xr,setDiamondBreakdownRowsFromField:or,getDiamondBreakdownField:Qr,syncSizingToSizeField:Yr,prepareConfirmation:hn,saveDetails:wn,saveNotes:vn,saveOrderDetails:Sn,saveStatus:kn,closeConfirmModal:ur,sendConfirmation:_n,quotePriceFields:dn,quotePricingFields:Ae});function pr(){A.selectedItems=[],We(),Se()}function Rn(e){if(!e)return"";let t=[e.notes,e.customer_notes,e.note,e.message,e.inquiry,e.details];for(let o of t)if(ye(o))return o;return""}function $n(e,t){let o=Me(e)||"Standard",r=Number(String(t||"").trim());return!Number.isNaN(r)&&r>0?`Estimated delivery after payment: ${o} + ${r} week${r===1?"":"s"}.`:`Estimated delivery after payment: ${o}.`}function ke(e){return R.editFields.find(t=>t.dataset.field===e)}function de(e){let t=R.editFields.find(o=>o.dataset.field===e);return t?t.value.trim():""}function On(){R.quoteSection&&(R.quoteSection.classList.toggle("is-hidden",A.tab!=="quotes"),ir(),Qe(),A.tab!=="quotes"&&ar(null))}function br(e,t){return t==="created_at"?Ne(e[t]):t==="price"?he(e[t]):t==="status"?e[t]||"--":t==="phone"?Re(e[t]):t==="is_active"?String(e[t]||"").toLowerCase()==="true"?"Yes":"No":e[t]||"--"}async function Tn(){try{let e=await Q("/me");A.role=e.role||"",A.email=e.email||"",R.userRole&&(R.userRole.textContent=A.role||"Unknown"),R.userEmail&&(R.userEmail.textContent=A.email||"Not authorized"),An(),xn(),Be("Connected")}catch{Be("Access blocked"),K("Access denied. Check Access policy.","error")}}async function Pn(){let e=Wr(A.tab);if(Nn(),Ln(),In(),Cn(),ot({ui:R,loadCurrentView:Fe,closeDrawer:er}),nr(),!jr())return;await Tn();let t=e&&(Ie[e]||e===me)?e:A.tab;if(Ue(t),vr||Dn({}),setInterval(()=>{document.hidden||!we||Fe()},6e4),window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"){window.addEventListener("load",()=>{let r=performance.getEntriesByType("navigation")[0],s=r&&Number.isFinite(r.duration)?r.duration:performance.now();console.log(`[perf] Page loaded in ${Math.round(s)}ms`)});let o=window.fetch;window.fetch=async(...r)=>{let s=performance.now(),S=await o(...r),h=performance.now();return console.log(`[perf] API call ${(h-s).toFixed(0)}ms`,r[0]),S}}}Pn();})();
