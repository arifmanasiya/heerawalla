"use strict";(()=>{var me="dashboard",et=new Set(["orders","quotes","tickets","products"]),x={tab:me,role:"",email:"",items:[],total:0,offset:0,limit:50,selectedId:"",selectedItem:null,selectedItems:[],originalValues:{},originalRaw:{},originalNotes:"",orderDetails:{},pendingChanges:[],confirmation:null,filters:{q:"",status:"",date_range:"",sort:"created_at",dir:"desc"}};function pe(){return typeof window>"u"?"":localStorage.getItem("adminApiBase")||""||document.body.dataset.apiBase||""}function oe(){if(typeof window>"u")return"";let e=window.location.origin||"";if(!e.startsWith("http://localhost")&&!e.startsWith("http://127.0.0.1"))return"";let t=localStorage.getItem("adminEmail")||"";if(t)return t;let o=new URLSearchParams(window.location.search),r=o.get("adminEmail")||o.get("admin_email")||"";return r&&r.includes("@")?(localStorage.setItem("adminEmail",r),r):""}function Ee(){if(typeof window>"u")return"";try{return localStorage.getItem("adminEmail")||""}catch{return""}}function Le(e={},t=""){let o={"Content-Type":"application/json",...e},r=t||oe();return r&&(o["X-Admin-Email"]=r),o}async function Q(e,t={}){let o=pe();if(!o)throw new Error("Missing API base");let r=o.endsWith("/")?o:`${o}/`,s=new URL(e.replace(/^\//,""),r),k=r.startsWith("http://localhost")||r.startsWith("http://127.0.0.1"),b=k?Ee():oe(),v=Le(t.headers||{},b);k&&b&&s.searchParams.set("admin_email",b);let u=await fetch(s.toString(),{credentials:k?"omit":"include",headers:v,...t});if(!u.ok){let g=await u.text(),d=new Error(g||u.statusText);throw d.status=u.status,d}return await u.json()}function tt(e){return function(o,r){e&&(e.textContent=o,e.classList.add("is-visible"),r==="error"?e.style.background="#b42318":e.style.background="var(--ink)",setTimeout(()=>e.classList.remove("is-visible"),2400))}}function rt({state:e,ui:t,listColumns:o,isBulkEnabled:r,canEditCurrentTab:s,getValue:k,getItemKey:b,escapeAttribute:v}){function u(){if(!t.listHeader)return;let d=o[e.tab];if(!d)return;let l=r(),f=[];l&&f.push("44px"),f.push(...d.map(h=>h.key==="view"||h.key==="delete"?"90px":"minmax(120px, 1fr)"));let y=f.join(" ");t.listHeader.style.gridTemplateColumns=y;let p=[];if(l){let h=e.items.length>0&&e.selectedItems.length===e.items.length;p.push(`<div class="cell"><input type="checkbox" class="bulk-select" data-bulk-select-all ${h?"checked":""} /></div>`)}p.push(...d.map(h=>`<div>${h.label||""}</div>`)),t.listHeader.innerHTML=p.join("")}function g(){if(u(),!t.list)return;let d=e.tab==="cost-chart"||e.tab==="diamond-price-chart",l=new Set(["value","weight_min","weight_max","price_per_ct","row_number"]),f={tab:e.tab,hasColumns:Array.isArray(o[e.tab]),getValue:typeof k,getItemKey:typeof b,escapeAttribute:typeof v,isBulkEnabled:typeof r,canEditCurrentTab:typeof s};if(f.getValue!=="function"||f.getItemKey!=="function")throw console.error("List renderer miswired",f),new Error("List renderer miswired");if(!Array.isArray(e.items)){console.error("List items not array",{tab:e.tab,items:e.items}),t.list.innerHTML='<div class="list-row"><div class="cell">No results</div></div>',t.results.textContent="0 results";return}if(!e.items.length){t.list.innerHTML='<div class="list-row"><div class="cell">No results</div></div>',t.results.textContent="0 results";return}let y=o[e.tab]||[],p=r(),h=[];p&&h.push("44px"),h.push(...y.map(n=>n.key==="view"||n.key==="delete"?"90px":"minmax(120px, 1fr)"));let w=h.join(" ");try{t.list.innerHTML=e.items.map(n=>{let i=b(n),m=i||n.slug||n.id||n.request_id||n.email||n.row_number||n.media_id||"",S=[];if(p){let A=e.selectedItems.includes(i);S.push(`<div class="cell"><input type="checkbox" class="bulk-select" data-bulk-select-item="${v(i)}" ${A?"checked":""} /></div>`)}S.push(...y.map(A=>{if(A.key==="view"){let N=i?"":"disabled";return d&&s()?`<div class="cell inline-actions">
                    <button class="btn btn-ghost btn-small" data-inline-edit="${i}" ${N}>Edit</button>
                    <button class="btn btn-ghost btn-small" data-view="${i}" ${N}>View</button>
                  </div>`:`<div class="cell"><button class="btn btn-ghost" data-view="${i}" ${N}>View</button></div>`}if(A.key==="delete"){let N=s()?"":"disabled";return`<div class="cell"><button class="btn btn-ghost" data-delete="${i}" ${N}>Delete</button></div>`}if(A.key==="status"){let N=n.status||"NEW";return`<div class="cell"><span class="cell-label">${A.label}</span><span class="badge" data-status="${N}">${N}</span></div>`}let O=k(n,A.key);if(d&&s()){let N=n.row_number??n.id??n.request_id??"",M=l.has(A.key)?"number":"text",L=A.key==="price_per_ct"||A.key==="value"?"0.01":"1";return`<div class="cell"><span class="cell-label">${A.label}</span><span class="inline-value" data-inline-display>${O}</span><input class="inline-input is-hidden" type="${M}" step="${L}" data-inline-field="${v(A.key)}" data-row-number="${v(N)}" value="${v(O)}" /></div>`}return`<div class="cell"><span class="cell-label">${A.label}</span><span>${O}</span></div>`}));let q=p&&e.selectedItems.includes(i)?"list-row is-selected":"list-row",$=d?' data-inline-row="true"':"";return`<div class="${q}" data-row="${v(m)}" data-slug="${v(n.slug||"")}" data-id="${v(n.id||"")}" style="grid-template-columns:${w}"${$}>${S.join("")}</div>`}).join("")}catch(n){throw console.error("List render failure",{error:n,debugInfo:f,columns:y,items:e.items}),n}t.results.textContent=`Showing ${e.items.length} of ${e.total}`}return{renderHeader:u,renderList:g}}function nt({state:e,ui:t,statusOptions:o,sortOptions:r,sortDefaults:s,isDashboardTab:k,getOrderStatusOptions:b,normalizeStatus:v}){function u(){if(!t.statusSelect)return;let l=v(e.selectedItem?.status),f=e.tab==="orders"?b():(o[e.tab]||[]).filter(y=>y!==l);f.length?t.statusSelect.innerHTML=f.map(y=>`<option value="${y}">${y}</option>`).join(""):t.statusSelect.innerHTML='<option value="">No status actions</option>'}function g(){let l=t.filters.find(h=>h.dataset.filter==="sort");if(!l)return;let f=r[e.tab]||r.orders,y=s[e.tab]||s.orders;f.map(h=>h.value).includes(e.filters.sort)||(e.filters.sort=y.sort),["asc","desc"].includes(e.filters.dir)||(e.filters.dir=y.dir),l.innerHTML=f.map(h=>`<option value="${h.value}">${h.label}</option>`).join(""),l.value=e.filters.sort}function d(){if(!t.filtersWrap)return;let l=t.filtersWrap.querySelector("[data-filter-status]"),f=t.filters.find(h=>h.dataset.filter==="status");if(!l||!f)return;let y=o[e.tab]||[];if(k()||!y.length){l.classList.add("is-hidden"),f.value="",e.filters.status="";return}l.classList.remove("is-hidden");let p=e.filters.status||"";f.innerHTML='<option value="">All statuses</option>'+y.map(h=>`<option value="${h}">${h}</option>`).join(""),f.value=y.includes(p)?p:"",e.filters.status=f.value}return{updateStatusOptions:u,updateSortOptions:g,updateStatusFilterOptions:d}}function at({ui:e,escapeHtml:t}){let o=()=>{e.drawer&&(e.drawer.classList.remove("is-open"),e.drawer.setAttribute("aria-hidden","true"),e.drawer.inert=!0,document.activeElement&&e.drawer.contains(document.activeElement)&&document.activeElement.blur())},r=()=>{if(!e.drawer)return;e.drawer.inert=!1,e.drawer.classList.add("is-open"),e.drawer.setAttribute("aria-hidden","false");let u=e.drawer.querySelector("button, [href], input, select, textarea, [tabindex]:not([tabindex='-1'])");u&&typeof u.focus=="function"&&u.focus({preventScroll:!0})},s=(u,g)=>u==="Images"?`<div class="detail-media"><span>${u}</span>${g}</div>`:`<div><span>${u}</span>${g}</div>`,k=(u,g)=>u.filter(([,d])=>g(d)).map(([d,l])=>s(d,l)).join("");return{closeDrawer:o,openDrawer:r,renderDetailRows:k,renderDetailSections:(u,g)=>u.map(d=>{let l=k(d.rows||[],g);return l?`<div class="detail-section">
          <p class="detail-section-title">${t(d.title)}</p>
          <div class="detail-grid">${l}</div>
        </div>`:""}).join(""),bindDrawerEvents:()=>{e.drawerClose&&e.drawerClose.addEventListener("click",o),e.drawer&&e.drawer.addEventListener("click",u=>{u.target===e.drawer&&o()}),e.detailGrid&&e.detailGrid.addEventListener("click",u=>{let g=u.target;if(!(g instanceof HTMLElement))return;let d=g.closest("[data-carousel-prev]"),l=g.closest("[data-carousel-next]");if(!d&&!l)return;let f=g.closest("[data-media-carousel]");if(!f)return;let y=f.querySelector("[data-carousel-track]");if(!(y instanceof HTMLElement))return;let p=d?-1:1;y.scrollBy({left:y.clientWidth*p,behavior:"smooth"})})}}}function ot({ui:e,loadCurrentView:t,closeDrawer:o}){function r(){if(document.querySelector(".shortcuts-modal"))return;let s=document.createElement("div");s.className="shortcuts-modal",s.innerHTML=`
      <div class="modal-card">
        <div class="modal-header">
          <h2>Keyboard Shortcuts</h2>
          <button class="btn btn-ghost" data-shortcuts-close type="button">Close</button>
        </div>
        <div class="shortcuts-list">
          <div class="shortcut-item"><kbd>Cmd/Ctrl + K</kbd><span>Focus search</span></div>
          <div class="shortcut-item"><kbd>Cmd/Ctrl + R</kbd><span>Refresh</span></div>
          <div class="shortcut-item"><kbd>Cmd/Ctrl + N</kbd><span>Add row (catalog)</span></div>
          <div class="shortcut-item"><kbd>Esc</kbd><span>Close drawer</span></div>
          <div class="shortcut-item"><kbd>\u2190 \u2192</kbd><span>Navigate pages</span></div>
          <div class="shortcut-item"><kbd>?</kbd><span>Show shortcuts</span></div>
        </div>
      </div>
    `,s.addEventListener("click",k=>{k.target===s&&s.remove()}),s.querySelector("[data-shortcuts-close]").addEventListener("click",()=>s.remove()),document.body.appendChild(s)}document.addEventListener("keydown",s=>{if(s.target instanceof HTMLElement&&s.target.matches("input, textarea, select"))return;if(s.key==="?"){r();return}if(s.code==="Escape"){o();return}if(s.code==="ArrowLeft"){e.prev&&e.prev.click();return}if(s.code==="ArrowRight"){e.next&&e.next.click();return}if(s.metaKey||s.ctrlKey)switch(s.code){case"KeyK":{let b=e.filters.find(v=>v.dataset.filter==="q");b&&(s.preventDefault(),b.focus());break}case"KeyR":s.preventDefault(),t();break;case"KeyN":s.preventDefault(),e.addRowButton&&!e.addRowWrap?.classList.contains("is-hidden")&&e.addRowButton.click();break}})}function it({apiFetch:e,ui:t,setTab:o,escapeHtml:r}){async function s(){if(t.dashboard){t.dashboard.innerHTML='<div class="dashboard-section"><h3>Loading dashboard...</h3></div>';try{let b=await e("/dashboard/metrics");if(!b.ok){t.dashboard.innerHTML='<div class="dashboard-section"><h3>Unable to load dashboard.</h3></div>';return}t.dashboard.innerHTML=k(b),t.dashboard.querySelectorAll("[data-dashboard-tab]").forEach(v=>{v.addEventListener("click",()=>{let u=v.dataset.dashboardTab;u&&o(u)})})}catch{t.dashboard.innerHTML='<div class="dashboard-section"><h3>Unable to load dashboard.</h3></div>'}}}function k(b){let v=b.recentOrders||[],u=b.actionRequired||[];return`
      <div class="dashboard-grid">
        <div class="metric-card">
          <h3>Today's Activity</h3>
          <div class="metric-value">${b.todayOrders||0}</div>
          <div class="metric-label">New Orders</div>
        </div>
        <div class="metric-card">
          <h3>Pending Quotes</h3>
          <div class="metric-value">${b.pendingQuotes||0}</div>
          <div class="metric-label">Awaiting Response</div>
        </div>
        <div class="metric-card">
          <h3>This Month</h3>
          <div class="metric-value">${b.monthlyRevenue||0}</div>
          <div class="metric-label">Revenue</div>
        </div>
        <div class="metric-card">
          <h3>Alerts</h3>
          <div class="metric-value ${b.lowStockCount>0?"warning":""}">${b.lowStockCount||0}</div>
          <div class="metric-label">Low Stock Items</div>
        </div>
      </div>
      <div class="dashboard-section">
        <h3>Recent Orders</h3>
        <div class="quick-list">
          ${v.length?v.map(g=>`
            <div class="quick-item">
              <div>
                <strong>${r(g.product||g.requestId||"Order")}</strong>
                <div class="quick-meta">${r(g.requestId||"")}</div>
              </div>
              <div class="quick-meta">${r(g.status||"")}</div>
            </div>`).join(""):'<div class="quick-meta">No recent orders.</div>'}
        </div>
      </div>
      <div class="dashboard-section">
        <h3>Action Required</h3>
        <div class="quick-list">
          ${u.length?u.map(g=>`
            <div class="quick-item">
              <div>
                <strong>${r(g.label||g.requestId||"Item")}</strong>
                <div class="quick-meta">${r(g.requestId||"")}</div>
              </div>
              <div class="quick-meta">${r(g.status||"")}</div>
            </div>`).join(""):'<div class="quick-meta">No actions required.</div>'}
        </div>
      </div>
    `}return{loadDashboard:s}}function st({state:e,ui:t,apiFetch:o,getActionEndpoint:r,showToast:s,renderList:k,loadList:b,isBulkEnabled:v,clearSelection:u}){function g(){if(!t.bulkActions)return;if(!v()||!e.selectedItems.length){t.bulkActions.classList.add("is-hidden"),t.bulkActions.innerHTML="";return}let f=d(e.tab);t.bulkActions.classList.remove("is-hidden"),t.bulkActions.innerHTML=`
      <div class="bulk-info">
        <span>${e.selectedItems.length} selected</span>
        <button class="btn-link" data-bulk-clear type="button">Clear</button>
      </div>
      <div class="bulk-buttons">
        ${f.map(y=>`<button class="btn ${y.danger?"btn-danger":""}" data-bulk-action="${y.action}" type="button">${y.label}</button>`).join("")}
      </div>
    `}function d(f){return{orders:[{action:"acknowledge",label:"Acknowledge"},{action:"cancel",label:"Cancel"},{action:"delete",label:"Delete",danger:!0}],quotes:[{action:"acknowledge",label:"Acknowledge"},{action:"drop",label:"Drop"},{action:"delete",label:"Delete",danger:!0}],tickets:[{action:"mark_resolved",label:"Resolve"},{action:"delete",label:"Delete",danger:!0}],products:[{action:"delete",label:"Delete",danger:!0}]}[f]||[]}async function l(f){if(!e.selectedItems.length)return;let y=d(e.tab).find(w=>w.action===f)?.label||f;if(!window.confirm(`Apply "${y}" to ${e.selectedItems.length} items?`))return;let p=r();if(!p){s("No bulk actions available.","error");return}let h=0;for(let w of e.selectedItems)try{(await o(p,{method:"POST",body:JSON.stringify({action:f,requestId:w})})).ok&&(h+=1)}catch{}s(`Updated ${h} of ${e.selectedItems.length} items`),u(),await b(),k()}return{updateBulkActions:g,handleBulkAction:l,getBulkActionsForTab:d}}function lt({state:e,listColumns:t,getItemKey:o,getValue:r,showToast:s}){function k(){return(t[e.tab]||[]).filter(u=>u.key!=="view"&&u.key!=="delete")}function b(v="csv"){if(v!=="csv")return;let u=e.selectedItems.length>0?e.items.filter(n=>e.selectedItems.includes(o(n))):e.items;if(!u.length){s("No rows to export.","error");return}let g=k(),d=g.map(n=>n.label||n.key),l=u.map(n=>g.map(i=>{let m=r(n,i.key),S=String(m??"");return S.includes(",")||S.includes('"')||S.includes(`
`)?`"${S.replace(/"/g,'""')}"`:S})),f=[d.join(","),...l.map(n=>n.join(","))].join(`
`),y=`${e.tab}-${Date.now()}.csv`,p=new Blob([f],{type:"text/csv;charset=utf-8"}),h=URL.createObjectURL(p),w=document.createElement("a");w.href=h,w.download=y,document.body.appendChild(w),w.click(),w.remove(),URL.revokeObjectURL(h),s(`Exported ${u.length} rows`)}return{exportData:b}}function ct(e){return e==="orders"?"/orders":e==="quotes"?"/quotes":e==="tickets"?"/tickets":e==="contacts"?"/contacts":e==="products"?"/products":e==="inspirations"?"/inspirations":e==="media-library"?"/media-library":e==="cost-chart"?"/cost-chart":e==="diamond-price-chart"?"/diamond-price-chart":`/${e}`}function dt(e){return e==="orders"?"/orders/action":e==="quotes"?"/quotes/action":e==="tickets"?"/tickets/action":e==="contacts"?"/contacts/action":e==="products"?"/products/action":e==="inspirations"?"/inspirations/action":e==="media-library"?"/media-library/action":e==="cost-chart"?"/cost-chart/action":e==="diamond-price-chart"?"/diamond-price-chart/action":""}function ut({state:e,storage:t,locationHref:o}){let r=u=>e.tab==="products"||e.tab==="inspirations"?u.slug||u.id||u.row_number||u.request_id||u.email||u.media_id||u.name||"":e.tab==="media-library"?u.media_id||u.row_number||u.id||"":u.request_id||u.email||u.row_number||u.slug||u.id||u.media_id||"",s=()=>e.selectedItem&&(e.selectedItem.request_id||e.selectedItem.email||e.selectedItem.row_number||e.selectedItem.slug||e.selectedItem.id||e.selectedItem.media_id)||"",k=(u,g)=>u==="orders"||u==="quotes"?{action:"delete",requestId:g}:u==="products"?{action:"delete",id:g,slug:g}:{action:"delete",requestId:g},b=u=>{switch(u){case"orders":return"order_detail";case"quotes":return"quote_detail";case"tickets":return"ticket_detail";case"products":return"product_detail";case"inspirations":return"inspiration_detail";case"contacts":return"contact_detail";case"media-library":return"media_detail";case"cost-chart":return"cost_chart_detail";case"diamond-price-chart":return"diamond_price_chart_detail";default:return"detail"}};return{buildDeletePayload:k,detailUrl:u=>{let g=e.tab||"orders",d=u||"";try{t?.setItem?.("adminDetailTab",g),t?.setItem?.("adminDetailId",d)}catch{}let l=new URL(b(g),o);return l.searchParams.set("id",d),l.toString()},getItemKey:r,getSelectedRecordId:s}}function ft({getLocalAdminEmail:e,storage:t,documentRef:o,windowRef:r}){let s=()=>{if(o.querySelector("[data-local-admin-prompt]"))return;let b=o.createElement("div");b.className="local-admin-banner",b.setAttribute("data-local-admin-prompt","true"),b.innerHTML=`
      <div class="local-admin-card">
        <div>
          <div class="local-admin-title">Local admin access</div>
          <div class="local-admin-sub">Enter an allowlisted email to enable local data.</div>
        </div>
        <div class="local-admin-form">
          <input type="email" placeholder="admin@email.com" aria-label="Admin email" />
          <button class="btn" type="button">Save</button>
        </div>
      </div>
    `,o.body.appendChild(b);let v=b.querySelector("input"),u=b.querySelector("button");v&&u&&(u.addEventListener("click",()=>{let g=String(v.value||"").trim();!g||!g.includes("@")||(t?.setItem?.("adminEmail",g),r.location.reload())}),v.addEventListener("keydown",g=>{g.key==="Enter"&&u.click()}),v.focus())};return{ensureLocalAdminAccess:()=>{if(typeof r>"u")return!0;let b=r.location.origin||"";return!(b.startsWith("http://localhost")||b.startsWith("http://127.0.0.1"))||e()?!0:(s(),!1)}}}function mt({windowRef:e}){return{getInitialTab:r=>new URLSearchParams(e.location.search).get("tab")||r,updateTabInUrl:r=>{let s=new URL(e.location.href);s.searchParams.set("tab",r),s.searchParams.delete("offset"),e.history.replaceState({},"",s)}}}function pt({ui:e}){let t="Connecting",o="",r=b=>{t=b,k()},s=b=>{o=b,k()},k=()=>{if(!e.syncLine)return;if(e.autoRefresh?.checked??!0){e.syncLine.textContent=t,e.refresh&&(e.refresh.disabled=!0,e.refresh.setAttribute("aria-disabled","true"),e.refresh.classList.add("is-disabled"));return}let v=o?` | Last sync ${o}`:"";e.syncLine.textContent=`${t}${v}`,e.refresh&&(e.refresh.disabled=!1,e.refresh.setAttribute("aria-disabled","false"),e.refresh.classList.remove("is-disabled"))};return{setLastSync:s,setSyncStatus:r,updateSyncLine:k}}function bt({state:e,ui:t,tabLabels:o,isDashboardTab:r,isConsultationsTab:s,loadConsultations:k,updateStatusOptions:b,updateStatusFilterOptions:v,updateSortOptions:u,updateBulkActions:g,loadDashboard:d,apiFetch:l,getTabEndpoint:f,renderList:y,getItemKey:p,populateDrawer:h,closeDrawer:w,setSyncStatus:n,setLastSync:i,showToast:m,pricingTabs:S,catalogTabs:q}){let $=()=>{if(!t.adminTabs.length)return;let a=e.role==="admin";if(t.adminTabs.forEach(c=>{c.classList.toggle("is-hidden",!a)}),!a&&t.adminTabs.some(c=>c.classList.contains("is-active"))){let c=t.tabs.find(_=>_.dataset.tab==="orders");c&&(t.tabs.forEach(_=>_.classList.remove("is-active")),c.classList.add("is-active"),e.tab="orders",b(),u())}},A=()=>{if(!t.addRowWrap)return;if(r()){t.addRowWrap.classList.add("is-hidden");return}let c=(e.role==="admin"||e.role==="ops")&&(S.has(e.tab)||q.has(e.tab));if(t.addRowWrap.classList.toggle("is-hidden",!c),t.addRowButton){let _={products:"Add product",inspirations:"Add inspiration","media-library":"Add media"};t.addRowButton.textContent=_[e.tab]||"Add row"}},O=()=>{let a=new URLSearchParams;return Object.entries(e.filters).forEach(([c,_])=>{_&&a.set(c,_)}),a.set("limit",String(e.limit)),a.set("offset",String(e.offset)),a.toString()},N=()=>{let a=r(),c=s?s():!1;t.dashboard&&t.dashboard.classList.toggle("is-hidden",!a),t.consultationsSection&&t.consultationsSection.classList.toggle("is-hidden",!c),t.filtersWrap&&t.filtersWrap.classList.toggle("is-hidden",a||c),t.listWrap&&t.listWrap.classList.toggle("is-hidden",a||c),t.bulkActions&&t.bulkActions.classList.toggle("is-hidden",a||c||!e.selectedItems.length),t.addRowWrap&&t.addRowWrap.classList.toggle("is-hidden",a||c)},M=async()=>{if(!e.isLoading){e.isLoading=!0,e.selectedItems=[],g(),n("Syncing");try{let a=await l(`${f(e.tab)}?${O()}`),c=Array.isArray(a?.items)?a.items:Array.isArray(a)?a:Array.isArray(a?.rows)?a.rows:[];if(Array.isArray(c)||console.warn("Unexpected list payload",{tab:e.tab,data:a}),e.items=c,e.total=Number.isFinite(a?.total)?a.total:Number.isFinite(a?.count)?a.count:c.length,y(),e.selectedId){let _=e.items.find(C=>p(C)===e.selectedId);_?h(_):(w(),e.selectedId="",e.selectedItem=null)}i(new Date().toLocaleTimeString()),n("Synced")}catch(a){let c=a?.message?` ${String(a.message).trim()}`:"";console.error("Load list failed",a),n("Error"),m(`Failed to load data.${c}`,"error")}finally{e.isLoading=!1}}},L=async()=>{if(N(),v(),r()){await d();return}if(s&&s()){k&&await k();return}await M()};return{buildQuery:O,loadCurrentView:L,loadList:M,setTab:a=>{let c=a||"orders";if(e.tab=c,e.offset=0,e.selectedItems=[],t.tabs.forEach(_=>{_.classList.toggle("is-active",_.dataset.tab===e.tab)}),t.tabTitle){let _=o?.[e.tab]||e.tab;t.tabTitle.textContent=_}b(),v(),u(),A(),g(),L()},updateAddRowVisibility:A,updateDashboardVisibility:N,updateTabVisibility:$}}function gt({state:e,ui:t,confirmFields:o,editFields:r,pricingTabs:s,canEditCurrentTab:k,actions:b,orderActionFlow:v,normalizeStatus:u,syncQuoteMetalInput:g,getEditValue:d}){let l=n=>{e.originalValues={},e.originalRaw={},o.forEach(i=>{let m=String(n[i.key]||"");e.originalRaw[i.key]=m,e.originalValues[i.key]=i.normalize(m)}),e.originalNotes=String(n.notes||"")},f=()=>{let n=[];return o.forEach(i=>{let m=d(i.key);if(!m&&!e.originalValues[i.key]||!m&&e.originalValues[i.key])return;let S=i.normalize(m),q=e.originalValues[i.key]||"";S!==q&&n.push({key:i.key,label:i.label,from:i.format(e.originalRaw[i.key]),to:i.format(m)})}),n},y=()=>{let n={};return g(),t.editFields.forEach(i=>{let m=i.dataset.field;m&&m!=="notes"&&r[e.tab].includes(m)&&i.value&&(n[m]=i.value.trim())}),n},p=()=>{let n=t.editFields.find(i=>i.dataset.field==="notes");return n?n.value.trim():""};return{collectConfirmChanges:f,collectEditableUpdates:y,getNotesValue:p,renderActions:()=>{let n=k(),i=e.tab==="orders"&&e.selectedItem?b.orders.filter(S=>S.action==="delete"?!0:(v[u(e.selectedItem.status)]||[]).includes(S.action)):b[e.tab];t.actionButtons.innerHTML=i.map(S=>{let q=n?"":"disabled";return`<button class="btn btn-ghost" data-action="${S.action}" data-confirm="${S.confirm}" ${q}>${S.label}</button>`}).join(""),t.actionButtons.style.display=i.length?"":"none";let m=!1;t.statusSelect&&(m=t.statusSelect.options.length>0&&t.statusSelect.options[0].value!=="",t.statusSelect.disabled=!n||!m),t.statusSave.disabled=!n||!m,t.primaryAction&&(t.primaryAction.disabled=!n),t.notesSave&&(t.notesSave.disabled=!n),t.editFields.forEach(S=>{S.disabled=!n}),t.detailsSave&&(t.detailsSave.disabled=!n),t.orderDetailsFields.forEach(S=>{S.disabled=!n})},setOriginalValues:l,updatePrimaryActionState:()=>{let n=k(),i=p()!==e.originalNotes.trim();if(t.notesSave&&(s.has(e.tab)||e.tab==="quotes"?t.notesSave.style.display="none":(t.notesSave.style.display="",t.notesSave.disabled=!n||!i)),!t.primaryAction)return;if(t.primaryAction.style.display=e.tab==="contacts"?"none":"",e.tab!=="orders"){let S=y();s.has(e.tab)&&(S.notes=p());let q=Object.keys(S).length>0||e.tab==="quotes"&&i;t.primaryAction.textContent="Save updates",t.primaryAction.disabled=!n||!q;return}t.primaryAction.textContent="Get Customer Confirmation";let m=f();e.pendingChanges=m,t.primaryAction.disabled=!n||m.length===0}}}var Ie={orders:["NEW","ACKNOWLEDGED","PENDING_CONFIRMATION","INVOICED","INVOICE_EXPIRED","INVOICE_PAID","PROCESSING","SHIPPED","DELIVERED","CANCELLED"],quotes:["NEW","ACKNOWLEDGED","QUOTED","QUOTE_ACTIONED","DROPPED"],tickets:["NEW","PENDING","RESOLVED"],contacts:[],products:[],inspirations:[],"media-library":[],"cost-chart":[],"diamond-price-chart":[]},qe={orders:[{key:"created_at",label:"Created"},{key:"request_id",label:"Request ID"},{key:"product_name",label:"Product"},{key:"status",label:"Status"},{key:"price",label:"Price"},{key:"timeline",label:"Timeline"},{key:"view",label:""},{key:"delete",label:""}],quotes:[{key:"created_at",label:"Created"},{key:"request_id",label:"Request ID"},{key:"product_name",label:"Product"},{key:"status",label:"Status"},{key:"price",label:"Price"},{key:"timeline",label:"Timeline"},{key:"view",label:""},{key:"delete",label:""}],tickets:[{key:"created_at",label:"Created"},{key:"request_id",label:"Request ID"},{key:"name",label:"Name"},{key:"email",label:"Email"},{key:"status",label:"Status"},{key:"subject",label:"Subject"},{key:"summary",label:"Summary"},{key:"view",label:""},{key:"delete",label:""}],contacts:[{key:"created_at",label:"Created"},{key:"name",label:"Name"},{key:"email",label:"Email"},{key:"phone",label:"Phone"},{key:"source",label:"Source"},{key:"request_id",label:"Request ID"},{key:"view",label:""}],products:[{key:"id",label:"ID"},{key:"name",label:"Name"},{key:"slug",label:"Slug"},{key:"category",label:"Category"},{key:"design_code",label:"Design code"},{key:"is_active",label:"Active"},{key:"view",label:""},{key:"delete",label:""}],inspirations:[{key:"id",label:"ID"},{key:"name",label:"Name"},{key:"slug",label:"Slug"},{key:"categories",label:"Category"},{key:"design_code",label:"Design code"},{key:"is_active",label:"Active"},{key:"view",label:""}],"media-library":[{key:"media_id",label:"Media ID"},{key:"label",label:"Label"},{key:"media_type",label:"Type"},{key:"url",label:"URL"},{key:"view",label:""}],"cost-chart":[{key:"row_number",label:"Row"},{key:"key",label:"Key"},{key:"value",label:"Value"},{key:"unit",label:"Unit"},{key:"notes",label:"Notes"},{key:"view",label:""}],"diamond-price-chart":[{key:"row_number",label:"Row"},{key:"clarity",label:"Clarity"},{key:"color",label:"Color"},{key:"weight_min",label:"Min ct"},{key:"weight_max",label:"Max ct"},{key:"price_per_ct",label:"Price/ct"},{key:"view",label:""}]},ht={orders:[{value:"created_at",label:"Created"},{value:"status",label:"Status"},{value:"price",label:"Price"},{value:"timeline",label:"Timeline"},{value:"name",label:"Name"},{value:"request_id",label:"Request ID"}],quotes:[{value:"created_at",label:"Created"},{value:"status",label:"Status"},{value:"price",label:"Price"},{value:"timeline",label:"Timeline"},{value:"name",label:"Name"},{value:"request_id",label:"Request ID"}],tickets:[{value:"created_at",label:"Created"},{value:"status",label:"Status"},{value:"name",label:"Name"},{value:"email",label:"Email"},{value:"subject",label:"Subject"}],contacts:[{value:"created_at",label:"Created"},{value:"name",label:"Name"},{value:"email",label:"Email"},{value:"source",label:"Source"}],products:[{value:"name",label:"Name"},{value:"slug",label:"Slug"},{value:"category",label:"Category"},{value:"design_code",label:"Design code"},{value:"is_active",label:"Active"}],inspirations:[{value:"name",label:"Name"},{value:"slug",label:"Slug"},{value:"categories",label:"Category"},{value:"design_code",label:"Design code"},{value:"is_active",label:"Active"}],"media-library":[{value:"media_id",label:"Media ID"},{value:"label",label:"Label"},{value:"media_type",label:"Type"}],"cost-chart":[{value:"row_number",label:"Row"},{value:"key",label:"Key"},{value:"value",label:"Value"}],"diamond-price-chart":[{value:"row_number",label:"Row"},{value:"clarity",label:"Clarity"},{value:"color",label:"Color"},{value:"weight_min",label:"Min ct"},{value:"price_per_ct",label:"Price/ct"}]},yt={orders:{sort:"created_at",dir:"desc"},quotes:{sort:"created_at",dir:"desc"},tickets:{sort:"created_at",dir:"desc"},contacts:{sort:"created_at",dir:"desc"},products:{sort:"name",dir:"asc"},inspirations:{sort:"name",dir:"asc"},"media-library":{sort:"media_id",dir:"asc"},"cost-chart":{sort:"row_number",dir:"asc"},"diamond-price-chart":{sort:"row_number",dir:"asc"}},wt={orders:[{action:"acknowledge",label:"Acknowledge",confirm:"Mark as acknowledged?"},{action:"send_invoice",label:"Send invoice",confirm:"Send invoice and mark invoiced?"},{action:"mark_paid",label:"Mark paid",confirm:"Confirm payment received?"},{action:"mark_invoice_expired",label:"Mark invoice expired",confirm:"Mark invoice as expired?"},{action:"mark_processing",label:"Mark processing",confirm:"Move order into processing?"},{action:"mark_shipped",label:"Mark shipped",confirm:"Mark as shipped?"},{action:"mark_delivered",label:"Mark delivered",confirm:"Mark as delivered?"},{action:"cancel",label:"Cancel order",confirm:"Cancel this order?"},{action:"delete",label:"Delete",confirm:"Delete this order? This cannot be undone."}],quotes:[{action:"acknowledge",label:"Acknowledge",confirm:"Mark as acknowledged?"},{action:"submit_quote",label:"Send quote link",confirm:"Send quote link to customer?"},{action:"refresh_quote",label:"Refresh quote link",confirm:"Send a refreshed quote link?"},{action:"mark_actioned",label:"Mark quote actioned",confirm:"Mark quote as actioned?"},{action:"drop",label:"Drop",confirm:"Drop this quote?"},{action:"delete",label:"Delete",confirm:"Delete this quote? This cannot be undone."}],tickets:[{action:"mark_pending",label:"Mark pending",confirm:"Mark as pending?"},{action:"mark_resolved",label:"Mark resolved",confirm:"Mark as resolved?"},{action:"delete",label:"Delete",confirm:"Delete this ticket? This cannot be undone."}],contacts:[],products:[{action:"delete",label:"Delete",confirm:"Delete this product? This cannot be undone."}],inspirations:[],"media-library":[],"cost-chart":[],"diamond-price-chart":[]},Ce={orders:["price","timeline","timeline_adjustment_weeks","metal","metal_weight","metal_weight_adjustment","stone","stone_weight","notes"],quotes:["price","timeline","timeline_adjustment_weeks","metal","metal_weight","stone","stone_weight","diamond_breakdown","size","quote_metal_options","quote_option_1_clarity","quote_option_1_color","quote_option_1_price_18k","quote_option_2_clarity","quote_option_2_color","quote_option_2_price_18k","quote_option_3_clarity","quote_option_3_color","quote_option_3_price_18k","quote_discount_type","quote_discount_percent","notes"],tickets:["notes"],contacts:[],products:[],inspirations:[],"media-library":[],"cost-chart":["key","value","unit","notes"],"diamond-price-chart":["clarity","color","weight_min","weight_max","price_per_ct","notes"]},vt=["shipping_method","shipping_carrier","tracking_number","tracking_url","shipping_status","delivery_eta","shipping_notes","certificates","care_details","warranty_details","service_details"],St=["shipping_carrier","tracking_number","certificates","care_details","warranty_details","service_details"],kt={NEW:["ACKNOWLEDGED","CANCELLED"],ACKNOWLEDGED:["PENDING_CONFIRMATION","INVOICED","CANCELLED"],PENDING_CONFIRMATION:["INVOICED","CANCELLED"],INVOICED:["INVOICE_PAID","INVOICE_EXPIRED","CANCELLED"],INVOICE_EXPIRED:["INVOICED","CANCELLED"],INVOICE_PAID:["PROCESSING","SHIPPED"],PROCESSING:["SHIPPED"],SHIPPED:["DELIVERED"],DELIVERED:[],CANCELLED:["INVOICED"]},_t={NEW:["acknowledge","cancel"],ACKNOWLEDGED:["send_invoice","cancel"],PENDING_CONFIRMATION:["send_invoice","cancel"],INVOICED:["mark_paid","mark_invoice_expired","cancel"],INVOICE_EXPIRED:["send_invoice","cancel"],INVOICE_PAID:["mark_processing","mark_shipped"],PROCESSING:["mark_shipped"],SHIPPED:["mark_delivered"],DELIVERED:[],CANCELLED:["send_invoice"]},De={orders:"Order",quotes:"Quote",tickets:"Customer ticket",contacts:"Contact",products:"Product",inspirations:"Inspiration","media-library":"Media library","cost-chart":"Cost chart","diamond-price-chart":"Diamond price chart"},be=new Set(["cost-chart","diamond-price-chart"]),xe=new Set(["products","inspirations","media-library"]),ge=[{clarity:"quote_option_1_clarity",color:"quote_option_1_color",price:"quote_option_1_price_18k"},{clarity:"quote_option_2_clarity",color:"quote_option_2_color",price:"quote_option_2_price_18k"},{clarity:"quote_option_3_clarity",color:"quote_option_3_color",price:"quote_option_3_price_18k"}],Et=new Set(ge.map(e=>e.price)),Ae=new Set(["metal","metal_weight","stone_weight","diamond_breakdown","timeline","timeline_adjustment_weeks","quote_discount_type","quote_discount_percent",...ge.flatMap(e=>[e.clarity,e.color])]);function ie(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function se(e){return ie(e).replace(/`/g,"&#96;")}function Lt(e,t=""){let o=String(e||"").trim();if(!o)return"";if(/^(https?:|data:|blob:)/i.test(o)){try{let r=new URL(o);if(t&&(r.hostname==="business.heerawalla.com"||r.hostname==="admin-api.heerawalla.com"))return`${t}${r.pathname}${r.search||""}`}catch{return o}return o}return o.startsWith("//")?`https:${o}`:t?o.startsWith("/")?`${t}${o}`:`${t}/${o}`:o}function Ne(e){if(!e)return"--";let t=new Date(e);return Number.isNaN(t.getTime())?String(e):t.toLocaleString()}function he(e){if(e==null||e==="")return"--";let t=Number(String(e).replace(/[^0-9.]/g,""));return Number.isNaN(t)?String(e):t.toLocaleString("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0})}function Re(e){let t=String(e||"").replace(/\D/g,"");return t?t.length===10?`(${t.slice(0,3)}) ${t.slice(3,6)}-${t.slice(6)}`:t.length===11&&t.startsWith("1")?`+1 (${t.slice(1,4)}) ${t.slice(4,7)}-${t.slice(7)}`:t.length>11?`+${t}`:t:"--"}function ne(e){return String(e||"").trim().toLowerCase()}function le(e){let t=String(e||"").trim();if(!t)return"";let o=Number(t);return Number.isNaN(o)?t.toLowerCase():String(o)}function It(e){let t=String(e||"").replace(/[^0-9.]/g,"");if(!t)return"";let o=Number(t);return Number.isNaN(o)?t:String(o)}function $e(e){let t=ne(e);return t?t.includes("rush")?"rush":t.includes("standard")?"standard":t:""}function Oe(e){return String(e||"").trim()}function qt(e){let t=String(e||"").trim();if(!t)return"";let o=Number(t);return Number.isNaN(o)?t:`${o} ct`}function Te(e){let t=String(e||"").trim();if(!t)return"";let o=Number(t);return Number.isNaN(o)?t:`${o} g`}function Pe(e){let t=String(e||"").trim();if(!t)return"";let o=Number(t);return Number.isNaN(o)?t:`${o>0?"+":""}${o} g`}function ze(e){let t=String(e||"").trim();if(!t)return"";let o=Number(t);return Number.isNaN(o)?t:o?`${o} week${o===1?"":"s"} delay`:"No delay"}function Me(e){let t=$e(e);return t?t==="rush"?"Rush":t==="standard"?"Standard":e:""}function ye(e){return e!=null&&String(e).trim()!==""}function Ct({state:e,ui:t,escapeAttribute:o,isFilled:r,normalizeText:s,getEditField:k,getEditValue:b,loadCatalog:v,resolveCatalogEntry:u}){let g=a=>{let c=a?.sizing||a?.sizing_details||a?.sizing_info||a?.size_details||a?.size_info;if(!c)return{};if(typeof c=="object")return c;if(typeof c=="string")try{let _=JSON.parse(c);if(_&&typeof _=="object")return _}catch{return{}}return{}},d=(a,c,_,C)=>{for(let P of C){let z=a?a[P]:"";if(r(z))return z;let W=c?c[P]:"";if(r(W))return W;let H=_?_[P]:"";if(r(H))return H}return""},l=a=>[a?.notes,a?.customer_notes,a?.request_notes,a?.size,a?.size_details,a?.sizeDetails,a?.body,a?.email_body,a?.email_text,a?.request_body,a?.quote_body,a?.summary,a?.summary_text,a?.details,a?.inquiry,a?.message].filter(r).join(`
`),f=a=>{if(!r(a))return{};let c=_=>{let C=a.match(_);return C&&C[1]?C[1].trim():""};return{ring:c(/\bring(?:\s*size)?\s*:\s*([^|\n,;]+)/i),wrist:c(/\b(?:wrist|bracelet)(?:\s*size)?\s*:\s*([^|\n,;]+)/i),neck:c(/\b(?:neck|necklace|chain)(?:\s*(?:size|length))?\s*:\s*([^|\n,;]+)/i),earring:c(/\bearrings?(?:\s*(?:style|type|size|preference))?\s*:\s*([^|\n,;]+)/i)}},y=a=>{let c=g(a),_=[],C=f(l(a)),P=d(a,c,C,["ring_size","ring","ringSize"]),z=d(a,c,C,["wrist_size","wrist","bracelet_size","bracelet"]),W=d(a,c,C,["neck_size","neck","chain_size","chain_length","necklace_size","necklace_length"]),H=d(a,c,C,["earring_style","earring_type","earring","earring_size"]);return r(P)&&_.push(["Ring size",P]),r(z)&&_.push(["Wrist size",z]),r(W)&&_.push(["Neck/chain size",W]),r(H)&&_.push(["Earring style",H]),!_.length&&r(a?.size)&&_.push(["Size",a.size]),_},p=a=>{let c=a?.tags,_=(Array.isArray(c)?c:String(c||"").split(/[|,;\n]/)).map(G=>String(G||"").trim().toLowerCase()).filter(Boolean),C=G=>G.some(T=>_.includes(T)),P=C(["set","sets"]),z=C(["ring","rings","band","bands"]),W=C(["bracelet","bracelets","bangle","bangles","wrist"]),H=C(["pendant","pendants","necklace","necklaces","chain","chains"]);if(_.length){let G=P&&!z&&!W&&!H;return{ring:z||G,bracelet:W||G,chain:H||G}}let j=String(a?.category||a?.categories||"").toLowerCase().replace(/\s+/g," ");return j.includes("set")?{ring:!0,bracelet:!0,chain:!0}:{ring:j.includes("ring")||j.includes("band"),bracelet:j.includes("bracelet")||j.includes("bangle"),chain:j.includes("pendant")||j.includes("necklace")||j.includes("chain")}},h=a=>{let c=[];return r(a.ring)&&c.push(`Ring size: ${a.ring}`),r(a.bracelet)&&c.push(`Bracelet size: ${a.bracelet}`),r(a.chain)&&c.push(`Chain size: ${a.chain}`),c.join(" | ")},w=!1,n=()=>{if(w)return;let a=k("size");if(!a)return;let c={ring:t.sizeRing?t.sizeRing.value.trim():"",bracelet:t.sizeBracelet?t.sizeBracelet.value.trim():"",chain:t.sizeChain?t.sizeChain.value.trim():""},_=h(c);_&&(a.value=_)},i=a=>{let c=(_,C)=>{if(!_)return;let P=_.closest(".field");P&&P.classList.toggle("is-hidden",!C)};if(e.tab!=="quotes"){c(t.sizeRing,!1),c(t.sizeBracelet,!1),c(t.sizeChain,!1);return}c(t.sizeRing,!!a?.ring),c(t.sizeBracelet,!!a?.bracelet),c(t.sizeChain,!!a?.chain)},m=async a=>{if(e.tab!=="quotes")return;let c=await v(),_=u(a,c),C=g(a),P=f(l(a));w=!0;let z=d(a,C,P,["ring_size","ring","ringSize"]),W=d(a,C,P,["wrist_size","wrist","bracelet_size","bracelet"]),H=d(a,C,P,["neck_size","neck","chain_size","chain_length","necklace_size","necklace_length"]),j=p(_);!j.ring&&!j.bracelet&&!j.chain&&(j={ring:r(z),bracelet:r(W),chain:r(H)}),i(j),t.sizeRing&&(t.sizeRing.value=z),t.sizeBracelet&&(t.sizeBracelet.value=W),t.sizeChain&&(t.sizeChain.value=H),w=!1},S=()=>t.editFields.find(a=>a.dataset.field==="diamond_breakdown"),q=a=>a?String(a).split(/\n|;|,/).map(c=>c.trim()).filter(Boolean).map(c=>{let _=c.match(/([0-9]*\.?[0-9]+)\s*(?:ct)?\s*[xX]\s*([0-9]*\.?[0-9]+)/i);if(_)return{weight:_[1],count:_[2]};let C=c.match(/[0-9]*\.?[0-9]+/g)||[];return C.length>=2?{weight:C[0],count:C[1]}:C.length===1?{weight:C[0],count:"1"}:null}).filter(Boolean):[],$=a=>a.map(c=>{let _=String(c.weight||"").trim(),C=String(c.count||"").trim();return!_||!C?"":`${_} x ${C}`}).filter(Boolean).join(`
`),A=()=>t.diamondBreakdownRows?Array.from(t.diamondBreakdownRows.querySelectorAll("[data-diamond-row]")).map(a=>{let c=a.querySelector("[data-diamond-weight]")?.value?.trim()||"",_=a.querySelector("[data-diamond-count]")?.value?.trim()||"";return{weight:c,count:_}}):[],O=!1,N=()=>{if(O)return;let a=S();if(!a)return;let c=A();O=!0,a.value=$(c),O=!1},M=a=>{if(t.diamondBreakdownRows){if(!a.length){t.diamondBreakdownRows.innerHTML='<p class="muted">No diamond pieces yet. Add a row to begin.</p>';return}t.diamondBreakdownRows.innerHTML=a.map((c,_)=>`
          <div class="diamond-row" data-diamond-row data-row-index="${_}">
            <input type="text" data-diamond-weight placeholder="0.10" value="${o(c.weight||"")}" />
            <span>ct x</span>
            <input type="text" data-diamond-count placeholder="1" value="${o(c.count||"")}" />
            <button class="btn btn-ghost" type="button" data-diamond-remove>Remove</button>
          </div>`).join("")}};return{applySizingVisibility:i,buildSizingRows:y,getDiamondBreakdownField:S,getDiamondRowsFromDom:A,refreshSizingInputs:m,renderDiamondBreakdownRows:M,setDiamondBreakdownRowsFromField:()=>{let a=S();if(!a)return;let c=q(a.value);M(c)},syncDiamondBreakdownField:N,syncSizingToSizeField:n,toggleDiamondBreakdownVisibility:()=>{t.diamondBreakdown&&t.diamondBreakdown.classList.toggle("is-hidden",e.tab!=="quotes")}}}function Dt({item:e,formatDate:t,formatPhone:o,formatPrice:r,formatDelayWeeks:s,formatGrams:k,formatSignedGrams:b,buildMetalWeightLabel:v,buildMetalWeightAdjustmentLabel:u,buildSizingRows:g,renderQuoteMediaSlot:d}){return[{title:"At a glance",rows:[["Request ID",e.request_id],["Created",t(e.created_at)],["Status",e.status],["Price",r(e.price)],["Timeline",e.timeline],["Timeline delay",s(e.timeline_adjustment_weeks)]]},{title:"Client",rows:[["Name",e.name],["Email",e.email],["Phone",o(e.phone)]]},{title:"Piece",rows:[["Product",e.product_name],["Images",d()],["Design code",e.design_code],["Metal",e.metal],[v(e.metal),k(e.metal_weight)],[u(e.metal),b(e.metal_weight_adjustment)],["Stone",e.stone],["Stone weight",e.stone_weight],["Diamond breakdown",e.diamond_breakdown]]},{title:"Sizing",rows:g(e)},{title:"Quote options",rows:[["Discount type",e.quote_discount_type],["Discount percent",e.quote_discount_percent]]},{title:"Address",rows:[["Address",e.address_line1],["City",e.city],["State",e.state],["Postal code",e.postal_code],["Country",e.country]]},{title:"Preferences",rows:[["Interests",e.interests],["Contact preference",e.contact_preference],["Subscription",e.subscription_status]]}]}function xt({apiBase:e,ui:t,normalizeImageUrl:o,escapeAttribute:r}){let s={data:null,promise:null},k=new Map,b=()=>e.replace(/\/admin\/?$/,""),v=n=>{if(!n)return"";try{let m=new URL(n,"https://www.heerawalla.com").pathname.split("/").filter(Boolean),S=m[m.length-1]||"";return S.toLowerCase()==="bespoke"&&m.length>1?m[m.length-2]||"":S}catch{return""}},u=n=>{if(!n)return"";try{let m=new URL(n,"https://www.heerawalla.com").pathname.split("/").filter(Boolean);return m.includes("inspirations")?"inspirations":m.includes("product")||m.includes("products")?"products":""}catch{return""}},g=n=>String(n||"uncategorized").split("/").map(i=>i.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"")||"uncategorized").filter(Boolean).join("/"),d=n=>{let i=g(n.category||"uncategorized"),m=`/images/products/${i}/${n.id}`,S=["img-hero-1.png","img-hero-1.jpeg","img-hero-1.jpg","img-hero-2.png","img-hero-2.jpeg","img-hero-2.jpg","img-hero-03.jpeg","img-1.png","img-1.jpeg","img-1.jpg","image-1.svg"].map(q=>`${m}/${q}`);return S.push(`/images/products/${i}/image-1.svg`),S.push("/images/products/placeholder.svg"),S},l=n=>{if(!n)return[o("/images/products/placeholder.svg")].filter(Boolean);let i=[];return n.hero_image&&i.push(n.hero_image),n.heroImage&&i.push(n.heroImage),Array.isArray(n.images)&&n.images.forEach(m=>i.push(m)),!i.length&&n.id&&n.category&&(i=d(n)),i.length||(i=["/images/products/placeholder.svg"]),Array.from(new Set(i.map(o).filter(Boolean)))},f=async()=>{if(s.data)return s.data;if(s.promise)return s.promise;let n=`${b()}/catalog?include=products,inspirations`;return s.promise=fetch(n).then(i=>i.json()).then(i=>(s.data=i||{},s.data)).catch(()=>(s.data={},s.data)).finally(()=>{s.promise=null}),s.promise},y=(n,i)=>{if(!i)return null;let m=n.product_url||"",S=v(m),q=u(m),$=n.design_code||"",A=n.product_name||"",O=Array.isArray(i.inspirations)?i.inspirations:[],N=Array.isArray(i.products)?i.products:[],M=a=>$&&(a.design_code||a.designCode||"").toLowerCase()===$.toLowerCase(),L=a=>A&&String(a.name||a.title||"").toLowerCase()===A.toLowerCase(),I=a=>S&&String(a.slug||"").toLowerCase()===S.toLowerCase();return q==="inspirations"?O.find(I)||O.find(M)||O.find(L)||null:q==="products"?N.find(I)||N.find(M)||N.find(L)||null:O.find(I)||N.find(I)||O.find(M)||N.find(M)||O.find(L)||N.find(L)||null},p=n=>{let i=Array.isArray(n)?n:[],m=r(o("/images/products/placeholder.svg"));return`
      <div class="media-carousel" data-media-carousel>
        <button class="carousel-btn" type="button" data-carousel-prev aria-label="Previous image">\u2039</button>
        <div class="media-track" data-carousel-track>${i.map(q=>`<div class="media-slide"><img src="${r(q)}" alt="" loading="lazy" onerror="this.onerror=null;this.src='${m}';"></div>`).join("")}</div>
        <button class="carousel-btn" type="button" data-carousel-next aria-label="Next image">\u203A</button>
      </div>`};return{collectImageUrls:l,getCatalogBase:b,loadCatalog:f,refreshQuoteMedia:async n=>{if(!t.detailGrid)return;let i=t.detailGrid.querySelector("[data-media-slot]");if(!i)return;let m=n.design_code||n.product_url||n.product_name||"";if(m&&k.has(m)){i.innerHTML=p(k.get(m));return}let S=await f(),q=y(n,S),$=l(q);m&&k.set(m,$),i.innerHTML=p($)},renderQuoteMediaSlot:()=>'<div class="media-slot" data-media-slot><span class="muted">Loading images...</span></div>',resolveCatalogEntry:y}}function At({state:e,ui:t,quoteOptionFields:o,quotePricingFields:r,quotePriceFields:s,isGoldOnlyQuote:k,getEditField:b,getEditValue:v,getCatalogBase:u,updatePrimaryActionState:g}){let d=null,l=!1,f=m=>{m&&(m.dataset.auto="false",m.dataset.manual="true")},y=m=>!(!m||m.dataset.manual==="true"&&m.value),p=()=>{e.tab==="quotes"&&o.forEach(m=>{let S=b(m.price);S&&(S.dataset.auto="true",S.dataset.manual="")})},h=()=>{if(e.tab!=="quotes"||!v("metal_weight"))return null;let S=k();if(!o.some(A=>!!(v(A.clarity)||v(A.color)))&&!S)return null;let $={};return r.forEach(A=>{let O=v(A);O&&($[A]=O)}),$},w=m=>{m&&(o.forEach(S=>{let q=m[S.price];if(!q)return;let $=b(S.price);y($)&&($.value=q,$.dataset.auto="true",$.dataset.manual="")}),g())},n=async()=>{if(e.tab!=="quotes"||l)return;let m=h();if(!m)return;let S={metal:m.metal||"",metal_weight:m.metal_weight||"",stone:m.stone||"",stone_weight:m.stone_weight||"",diamond_breakdown:m.diamond_breakdown||"",timeline:m.timeline||"",timeline_adjustment_weeks:m.timeline_adjustment_weeks||"",quote_discount_type:m.quote_discount_type||"",quote_discount_percent:m.quote_discount_percent||"",size:v("size")||"",size_label:"",size_ring:t.sizeRing?t.sizeRing.value.trim():"",size_bracelet:t.sizeBracelet?t.sizeBracelet.value.trim():"",size_chain:t.sizeChain?t.sizeChain.value.trim():""},q=u();l=!0;try{let $={},A=k(),O=o.map(async(N,M)=>{let L=m[N.clarity]||"",I=m[N.color]||"";if(!L&&!I&&!(A&&M===0))return;let a={...S,clarity:L,color:I},c=await fetch(`${q}/pricing/estimate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),_=await c.json().catch(()=>({}));!c.ok||!_?.ok||($[N.price]=String(_.price||""))});await Promise.all(O),w($)}catch{return}finally{l=!1}};return{markQuotePriceManual:f,resetQuoteAutoPricingState:p,scheduleQuotePricingUpdate:()=>{e.tab==="quotes"&&(d&&clearTimeout(d),d=setTimeout(()=>{n()},350))},quotePriceFields:s}}function Nt({modal:e}){if(!e)return{open:()=>{},close:()=>{},isOpen:()=>!1};let t=null,o=()=>{let b=e.querySelector("button, [href], input, select, textarea, [tabindex]:not([tabindex='-1'])")||e;b&&typeof b.focus=="function"&&b.focus()};return{open:()=>{t=document.activeElement,e.classList.add("is-open"),e.removeAttribute("inert"),e.setAttribute("aria-hidden","false"),requestAnimationFrame(o)},close:()=>{e.contains(document.activeElement)&&(t&&typeof t.focus=="function"?t.focus():document.body.focus?.()),e.classList.remove("is-open"),e.setAttribute("aria-hidden","true"),e.setAttribute("inert","")},isOpen:()=>e.classList.contains("is-open")}}function Rt({ui:e,escapeHtml:t,escapeAttribute:o,buildEtaLine:r,getEditValue:s}){let k=Nt({modal:e.confirmModal}),b=f=>f.map(y=>`
          <div class="confirm-row">
            <div class="confirm-field">${t(y.label)}</div>
            <div class="confirm-values">
              <span class="confirm-old">${t(y.from||"--")}</span>
              <span class="confirm-arrow">-></span>
              <span class="confirm-new">${t(y.to||"--")}</span>
            </div>
          </div>`).join(""),v=f=>f.map(y=>`
          <tr>
            <td style="padding:10px 0;border-bottom:1px solid #e5e7eb;">
              <div style="font-size:11px;letter-spacing:0.2em;text-transform:uppercase;color:#64748b;margin-bottom:6px;">
                ${t(y.label)}
              </div>
              <div style="font-size:14px;line-height:1.6;color:#0f172a;">
                <span style="color:#94a3b8;text-decoration:line-through;">${t(y.from||"--")}</span>
                <span style="color:#94a3b8;padding:0 8px;">-></span>
                <span style="font-weight:600;color:#0f172a;">${t(y.to||"--")}</span>
              </div>
            </td>
          </tr>`).join("");return{buildConfirmationEmail:(f,y,p)=>{let h=f.request_id||"",w=f.name||"there",n=f.product_name||"your order",i=s("timeline")||f.timeline||"",m=s("timeline_adjustment_weeks")||f.timeline_adjustment_weeks||"",S=r(i,m),q=h?`Heerawalla - Confirm order update (${h})`:"Heerawalla - Confirm order update",$=y.map(I=>`${I.label}: ${I.from||"--"} -> ${I.to||"--"}`),A=[`Hello ${w},`,"",`We reviewed your order for ${n}. Please confirm the updated details below (previous -> updated):`,"",...$,"",S,"",`Use your private confirmation link (Heerawalla.com/order_confirmation): ${p}`,"","Once confirmed, you will be guided to a secure checkout to reserve your piece.","Secure checkout supports major cards and wallets.","If anything looks incorrect, choose cancel on the confirmation page or reply to this email.","","Warm regards,","Heerawalla","www.heerawalla.com"].join(`
`),O=b(y),N=v(y),M=`<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body style="margin:0;padding:0;background:#f6f5f2;color:#0f172a;font-family:-apple-system, Segoe UI, Helvetica, Arial, sans-serif;">
  <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse;">
    <tr>
      <td align="center" style="padding:32px 16px;">
        <table role="presentation" width="600" cellpadding="0" cellspacing="0" style="border-collapse:collapse;background:#ffffff;border:1px solid #e5e7eb;">
          <tr>
            <td style="padding:36px 40px 28px 40px;">
              <div style="margin:0 0 16px 0;">
                <img src="https://www.heerawalla.com/images/engraving_mark.svg" width="36" height="36" alt="Heerawalla" style="display:block;">
              </div>
              <div style="font-size:12px;letter-spacing:0.32em;text-transform:uppercase;color:#64748b;margin-bottom:12px;">Heerawalla</div>
              <h1 style="margin:0 0 16px 0;font-size:22px;line-height:1.4;font-weight:600;color:#0f172a;">Please confirm your order update</h1>
              <p style="margin:0 0 16px 0;font-size:15px;line-height:1.7;color:#334155;">Hello ${t(w)},</p>
              <p style="margin:0 0 18px 0;font-size:15px;line-height:1.7;color:#334155;">
                We reviewed your order for ${t(n)}. Please confirm the updated details below (previous -> updated).
              </p>
              <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse;border:1px solid #e5e7eb;background:#fdfbf7;margin-bottom:18px;">
                <tbody>
                  ${N}
                </tbody>
              </table>
              <p style="margin:0 0 18px 0;font-size:14px;line-height:1.7;color:#334155;">
                ${t(S)}
              </p>
              <table role="presentation" cellpadding="0" cellspacing="0" style="margin:0 0 18px 0;">
                <tr>
                  <td style="background:#0f172a;border:1px solid #0f172a;">
                    <a href="${o(p)}" style="display:inline-block;padding:12px 22px;font-size:12px;letter-spacing:0.2em;text-transform:uppercase;color:#ffffff;text-decoration:none;">Review and confirm</a>
                  </td>
                </tr>
              </table>
              <p style="margin:0 0 6px 0;font-size:13px;line-height:1.7;color:#475569;">
                Use your private confirmation link at Heerawalla.com/order_confirmation.
              </p>
              <p style="margin:0 0 6px 0;font-size:13px;line-height:1.7;color:#475569;">
                Once confirmed, you will be guided to a secure checkout to reserve your piece.
              </p>
              <p style="margin:0 0 6px 0;font-size:13px;line-height:1.7;color:#475569;">
                Secure checkout supports major cards and wallets.
              </p>
              <p style="margin:0 0 24px 0;font-size:13px;line-height:1.7;color:#475569;">
                If anything looks incorrect, choose cancel on the confirmation page or reply to this email.
              </p>
              <div style="height:1px;background:#e5e7eb;margin:0 0 18px 0;"></div>
              <p style="margin:0 0 6px 0;font-size:14px;color:#0f172a;">Warm regards,</p>
              <p style="margin:0 0 10px 0;font-size:14px;font-weight:600;color:#0f172a;">Heerawalla</p>
              <p style="margin:0;font-size:12px;color:#64748b;">
                <a href="https://www.heerawalla.com" style="color:#64748b;text-decoration:underline;">www.heerawalla.com</a>
              </p>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`,L=`
      <div class="confirm-preview-card">
        <p class="confirm-title">Order update to confirm</p>
        <p class="confirm-sub">${t(n)}${h?` (${t(h)})`:""}</p>
        <div class="confirm-list">${O}</div>
        <a class="confirm-cta" href="${o(p)}" target="_blank" rel="noreferrer">Review and confirm</a>
        <p class="confirm-foot">${t(S)}</p>
        <p class="confirm-foot">
          Private confirmation link lets the customer confirm or cancel before secure checkout.
        </p>
      </div>`;return{subject:q,textBody:A,htmlBody:M,previewHtml:L}},resolveConfirmationUrl:f=>{let y=f.confirmationUrl||f.url||"";if(y)return y.startsWith("http")?y:y.startsWith("/")?`https://www.heerawalla.com${y}`:y;let p=f.token||f.confirmationToken||"";return p?`https://www.heerawalla.com/order_confirmation?token=${encodeURIComponent(p)}`:""},openConfirmModal:f=>{e.confirmModal&&(e.confirmTo.textContent=f.to,e.confirmSubject.textContent=f.subject,e.confirmPreview.innerHTML=f.previewHtml,k.open())},closeConfirmModal:()=>{k.close()}}}function $t({state:e,ui:t,apiFetch:o,orderDetailsFields:r}){let s=()=>{if(!t.orderDetailsSection)return;let g=e.tab==="orders";t.orderDetailsSection.classList.toggle("is-hidden",!g)},k=g=>{let d=t.orderDetailsFields.find(l=>l.dataset.orderDetailsField===g);return d?d.value.trim():""},b=()=>{let g={};return r.forEach(d=>{let l=k(d);l&&(g[d]=l)}),g},v=(g={})=>{e.orderDetails=g||{},t.orderDetailsFields.forEach(d=>{let l=d.dataset.orderDetailsField;if(!l)return;let f=l==="shipping_method"?"Express":"";d.value=g[l]||f})};return{applyOrderDetailsVisibility:s,collectOrderDetailsUpdates:b,loadOrderDetails:async g=>{if(!g||e.tab!=="orders"){v({});return}try{let d=await o(`/orders/details?request_id=${encodeURIComponent(g)}`);v(d.details||{})}catch{v({})}},populateOrderDetails:v}}function Ot({state:e,ui:t,normalizeText:o,getEditValue:r,getEditField:s}){let k=()=>"Metal weight (g)",b=()=>"Final Metal weight difference (g)",v=()=>{t.metalWeightLabel&&(t.metalWeightLabel.textContent=k()),t.metalWeightAdjustmentLabel&&(t.metalWeightAdjustmentLabel.textContent=b())},u=h=>{let w=o(h);return w.includes("platinum")?"Platinum":w.includes("14k")?"14K":w.includes("18k")?"18K":""},g=(h,w)=>{let n=s(h);if(!n)return;let i=n.closest(".field");i&&i.classList.toggle("is-hidden",!w)},d=()=>{if(e.tab!=="quotes")return!1;let h=Number(r("stone_weight")),w=r("diamond_breakdown"),n=!!String(w||"").trim();return(!Number.isFinite(h)||h<=0)&&!n},l=()=>{if(e.tab!=="quotes")return;let h=d();Array.from(document.querySelectorAll(".quote-option-card")).forEach((n,i)=>{i===0?n.classList.toggle("is-hidden",!1):n.classList.toggle("is-hidden",h)}),g("quote_option_1_clarity",!h),g("quote_option_1_color",!h)},f=()=>{if(e.tab!=="quotes")return;let h=o(r("quote_discount_type")),w=s("quote_discount_percent");if(!w)return;let n=h==="custom";w.disabled=!n},y=()=>{if(!t.quoteMetalInput)return;let h=r("metal"),w=u(h);if(w){p(w,h);return}let n=t.quoteMetals.filter(i=>i.checked).map(i=>i.value);t.quoteMetalInput.value=n.join(", ")},p=(h,w="")=>{if(!t.quoteMetalInput)return;let n=u(w),i=String(h||"").split(",").map(m=>m.trim()).filter(Boolean);n?(i.length=0,i.push(n)):i.length||i.push("18K"),t.quoteMetalInput.value=i.join(", "),t.quoteMetals.forEach(m=>{m.checked=i.includes(m.value),n?m.disabled=m.value!==n:m.disabled=!1})};return{applyDiscountControlState:f,applyGoldOnlyQuoteState:l,buildMetalWeightAdjustmentLabel:b,buildMetalWeightLabel:k,getRequestedMetalGroup:u,isGoldOnlyQuote:d,setQuoteMetalSelection:p,syncQuoteMetalInput:y,toggleFieldVisibility:g,updateMetalWeightLabels:v}}function Tt({state:e,ui:t,apiFetch:o,showToast:r,loadList:s,getActionEndpoint:k,getSelectedRecordId:b,collectEditableUpdates:v,getNotesValue:u,collectOrderDetailsUpdates:g,requiredShippingFields:d,pricingTabs:l,getEditField:f,collectConfirmChanges:y,buildConfirmationEmail:p,resolveConfirmationUrl:h,openConfirmModal:w,closeConfirmModal:n,loadOrderDetails:i}){let m=async L=>{if(e.tab!=="quotes")return!0;let I=v(),a=u();if(!Object.keys(I).length&&!a)return!0;let c=k();return c?(await o(c,{method:"POST",body:JSON.stringify({action:"edit",requestId:L,fields:I,notes:a})})).ok?!0:(r("Save failed","error"),!1):(r("No edits allowed.","error"),!1)};return{prepareConfirmation:async()=>{if(!e.selectedItem||!e.selectedItem.request_id){r("Missing request ID","error");return}let L=y();if(!L.length){r("No order updates to confirm.","error");return}t.confirmSend&&(t.confirmSend.disabled=!0);try{let I=await o("/orders/confirm",{method:"POST",body:JSON.stringify({requestId:e.selectedItem.request_id,changes:L,email:e.selectedItem.email||"",name:e.selectedItem.name||"",productName:e.selectedItem.product_name||""})}),a=h(I);if(!I.ok||!a)throw new Error("confirmation_failed");let c=p(e.selectedItem,L,a);e.pendingChanges=L,e.confirmation={confirmationUrl:a,emailPayload:c,changes:L},w({to:e.selectedItem.email||"--",subject:c.subject,previewHtml:c.previewHtml})}catch{r("Unable to build confirmation email.","error")}finally{t.confirmSend&&(t.confirmSend.disabled=!1)}},runAction:async L=>{let I=b();if(!I){r("Missing record ID","error");return}if(e.tab==="quotes"&&L==="refresh_quote"&&!await m(I))return;let a=e.tab==="orders"?g():{};if(e.tab==="orders"&&L==="mark_shipped"&&d.filter(z=>!a[z]).length){r("Add required fulfillment details before shipping.","error");return}let c={action:L};e.tab==="cost-chart"||e.tab==="diamond-price-chart"?c.rowNumber=I:c.requestId=I,e.tab==="orders"&&Object.keys(a).length&&(c.details=a),e.tab==="quotes"&&L==="submit_quote"&&(c.fields=v());let _=k();if(!_){r("No actions available.","error");return}(await o(_,{method:"POST",body:JSON.stringify(c)})).ok?(r("Action saved"),await s()):r("Action failed","error")},saveDetails:async()=>{let L=b();if(!L){r("Missing record ID","error");return}let I=v(),a=u();l.has(e.tab)&&(I.notes=a);let c={action:"edit",fields:I};e.tab==="cost-chart"||e.tab==="diamond-price-chart"?c.rowNumber=L:(c.requestId=L,c.notes=a);let _=k();if(!_){r("No edits allowed.","error");return}(await o(_,{method:"POST",body:JSON.stringify(c)})).ok?(r("Updates saved"),await s()):r("Update failed","error")},saveNotes:async()=>{if(l.has(e.tab)){r("Use Save updates for pricing notes.","error");return}let L=b();if(!L){r("Missing record ID","error");return}if(e.tab==="tickets"){let C=u();if(!C){r("Add a comment first.","error");return}if((await o("/tickets/action",{method:"POST",body:JSON.stringify({action:"add_note",requestId:L,note:C})})).ok){r("Comment added");let z=f("notes");z&&(z.value=""),await s()}else r("Comment failed","error");return}let a={action:"edit",notes:u()};e.tab==="cost-chart"||e.tab==="diamond-price-chart"?a.rowNumber=L:a.requestId=L;let c=k();if(!c){r("No edits allowed.","error");return}(await o(c,{method:"POST",body:JSON.stringify(a)})).ok?(r("Notes saved"),await s()):r("Notes failed","error")},saveOrderDetails:async()=>{if(!e.selectedItem||!e.selectedItem.request_id){r("Missing request ID","error");return}let L=g();if(!Object.keys(L).length){r("No fulfillment details to save.","error");return}let I={requestId:e.selectedItem.request_id,action:"edit",details:L};(await o("/orders/action",{method:"POST",body:JSON.stringify(I)})).ok?(r("Fulfillment details saved"),await i(e.selectedItem.request_id)):r("Fulfillment save failed","error")},saveStatus:async()=>{let L=b();if(!L){r("Missing record ID","error");return}let I=t.statusSelect.value;if(!I)return;let a=e.tab==="orders"?g():{};if(e.tab==="orders"&&I==="SHIPPED"&&d.filter(z=>!a[z]).length){r("Add required fulfillment details before shipping.","error");return}let c={requestId:L,action:"set_status",status:I};e.tab==="orders"&&Object.keys(a).length&&(c.details=a);let _=k();if(!_){r("No status updates available.","error");return}(await o(_,{method:"POST",body:JSON.stringify(c)})).ok?(r("Status updated"),await s()):r("Status failed","error")},sendConfirmation:async()=>{if(!e.selectedItem||!e.selectedItem.request_id){r("Missing request ID","error");return}if(!y().length){r("No order updates to confirm.","error");return}let I=e.confirmation;if(!I||!I.confirmationUrl){r("Open the confirmation preview first.","error");return}let a=I.emailPayload;if(!a){r("Confirmation email is missing.","error");return}let c=v(),_=u(),C={requestId:e.selectedItem.request_id,action:"request_confirmation",status:"PENDING_CONFIRMATION",notes:_,fields:c};if(!(await o("/orders/action",{method:"POST",body:JSON.stringify(C)})).ok){r("Update failed before email.","error");return}(await o("/email",{method:"POST",body:JSON.stringify({to:e.selectedItem.email||"",subject:a.subject,textBody:a.textBody,htmlBody:a.htmlBody,requestId:e.selectedItem.request_id,orderStatus:"PENDING_CONFIRMATION"})})).ok?(r("Confirmation sent"),n(),await s()):r("Email failed","error")}}}function Pt({ui:e,getApiBase:t,getStoredAdminEmail:o,getLocalAdminEmail:r,buildAdminHeaders:s,showToast:k,windowRef:b}){let v=(l,f)=>{l&&(l.disabled=!f,l.classList.toggle("is-disabled",!f),l.setAttribute("aria-disabled",f?"false":"true"))},u=l=>{e.deployStatus&&(e.deployStatus.textContent=l)},g=async()=>{let l=t();if(!l)throw new Error("Missing API base");let f=l.endsWith("/")?l:`${l}/`,y=new URL("deploy-site",f),p=f.startsWith("http://localhost")||f.startsWith("http://127.0.0.1"),h=p?o():r();p&&h&&y.searchParams.set("admin_email",h);let w=await fetch(y.toString(),{method:"POST",credentials:p?"omit":"include",headers:s({},h),body:"{}"}),n=null;try{n=await w.json()}catch{n=null}if(!w.ok){let i=n?.error||w.statusText;throw new Error(i)}return n||{ok:!0}};return{triggerSiteRebuild:async()=>{if(!(!e.triggerDeploy||!b.confirm("Trigger a site rebuild? This will run the deploy workflow."))){u("Dispatching..."),v(e.triggerDeploy,!1);try{let f=await g(),y=new Date().toLocaleTimeString();u(`Queued ${y}`);let p=f?.ok?"":` (${f?.error||"unknown"})`;k(`Rebuild triggered${p}`)}catch(f){let y=f?.message?String(f.message):"Rebuild failed";u("Failed"),k(y,"error")}finally{v(e.triggerDeploy,!0)}}}}}function zt({item:e,formatDate:t,formatPhone:o,getContactNotes:r}){return[["Created",t(e.created_at)],["Name",e.name],["Email",e.email],["Phone",o(e.phone)],["Type",e.type],["Subscribed",e.subscribed],["Sources",e.sources],["First seen",t(e.first_seen_at)],["Last seen",t(e.last_seen_at)],["Last source",e.last_source],["Unsubscribed at",t(e.unsubscribed_at)],["Unsubscribed reason",e.unsubscribed_reason],["Customer notes",r(e)],["Updated",t(e.updated_at)]]}function Mt({item:e,formatDate:t,formatPhone:o}){return[["Request ID",e.request_id],["Created",t(e.created_at)],["Status",e.status],["Name",e.name],["Email",e.email],["Phone",o(e.phone)],["Interests",e.interests],["Contact preference",e.contact_preference],["Customer notes",e.notes]]}function Bt({item:e,formatDate:t,formatPhone:o,formatPrice:r,formatDelayWeeks:s,formatGrams:k,formatSignedGrams:b,buildMetalWeightLabel:v,buildMetalWeightAdjustmentLabel:u,buildSizingRows:g,renderQuoteMediaSlot:d}){return[{title:"Request",rows:[["Request ID",e.request_id],["Created",t(e.created_at)],["Status",e.status]]},{title:"Client",rows:[["Name",e.name],["Email",e.email],["Phone",o(e.phone)]]},{title:"Piece",rows:[["Product",e.product_name],["Images",d()],["Design code",e.design_code],["Metal",e.metal],[v(e.metal),k(e.metal_weight)],[u(e.metal),b(e.metal_weight_adjustment)],["Stone",e.stone],["Stone weight",e.stone_weight],["Diamond breakdown",e.diamond_breakdown],...g(e)]},{title:"Timeline & Pricing",rows:[["Price",r(e.price)],["Timeline",e.timeline],["Timeline delay",s(e.timeline_adjustment_weeks)]]},{title:"Address",rows:[["Address",e.address_line1],["City",e.city],["State",e.state],["Postal code",e.postal_code],["Country",e.country]]},{title:"Preferences",rows:[["Interests",e.interests],["Contact preference",e.contact_preference],["Subscription",e.subscription_status]]}]}function Ft({item:e}){return[["Row",e.row_number],["Key",e.key],["Value",e.value],["Unit",e.unit],["Notes",e.notes]]}function jt({item:e}){return[["Row",e.row_number],["Clarity",e.clarity],["Color",e.color],["Weight min",e.weight_min],["Weight max",e.weight_max],["Price per ct",e.price_per_ct],["Notes",e.notes]]}function Ht(){return[]}function Wt(){return[]}function Ut(){return[]}function Vt({state:e,ui:t,setTab:o,loadCurrentView:r,setAutoRefresh:s,updateSyncLine:k,clearSelection:b,handleBulkAction:v,exportData:u,updateBulkActions:g,renderList:d,getItemKey:l,canEditCurrentTab:f,getActionEndpoint:y,showToast:p,apiFetch:h,buildDeletePayload:w,detailUrl:n,populateDrawer:i,openDrawer:m,bindDrawerEvents:S,runAction:q,triggerSiteRebuild:$,applyDiscountControlState:A,applyGoldOnlyQuoteState:O,setQuoteMetalSelection:N,syncQuoteMetalInput:M,updatePrimaryActionState:L,scheduleQuotePricingUpdate:I,getDiamondRowsFromDom:a,renderDiamondBreakdownRows:c,syncDiamondBreakdownField:_,setDiamondBreakdownRowsFromField:C,getDiamondBreakdownField:P,syncSizingToSizeField:z,prepareConfirmation:W,saveDetails:H,saveNotes:j,saveOrderDetails:G,saveStatus:T,closeConfirmModal:J,sendConfirmation:ee,quotePriceFields:te,quotePricingFields:re}){return{bindEvents:()=>{t.tabs.forEach(E=>{E.addEventListener("click",()=>{o(E.dataset.tab)})}),t.filters.forEach(E=>{E.addEventListener("change",()=>{E.dataset.filter==="limit"?e.limit=Number(E.value)||e.limit:e.filters[E.dataset.filter]=E.value.trim(),e.offset=0,r()}),E.tagName==="INPUT"&&E.addEventListener("input",()=>{E.dataset.filter!=="limit"&&(e.filters[E.dataset.filter]=E.value.trim()),e.offset=0,r()})}),t.prev.addEventListener("click",()=>{e.offset=Math.max(e.offset-e.limit,0),r()}),t.next.addEventListener("click",()=>{e.offset+e.limit>=e.total||(e.offset+=e.limit,r())}),t.refresh.addEventListener("click",()=>{t.autoRefresh?.checked||r()}),t.bulkActions&&t.bulkActions.addEventListener("click",E=>{let D=E.target;if(!(D instanceof HTMLElement))return;if(D.dataset.bulkClear!==void 0){b();return}let B=D.dataset.bulkAction;B&&v(B)}),t.exportButtons.length&&t.exportButtons.forEach(E=>{E.addEventListener("click",()=>{u(E.dataset.export||"csv")})}),t.autoRefresh&&t.autoRefresh.addEventListener("change",()=>{s(t.autoRefresh.checked),k()}),t.triggerDeploy&&t.triggerDeploy.addEventListener("click",$),t.list.addEventListener("click",E=>{let D=E.target;if(!(D instanceof HTMLElement)||D.closest(".inline-input"))return;if(D.dataset.inlineEdit){let F=D.closest(".list-row");if(!F||!f())return;let U=Array.from(F.querySelectorAll(".inline-input")),Xe=Array.from(F.querySelectorAll("[data-inline-display]")),br=F.classList.contains("is-editing"),Ye=y();if(!Ye)return;if(!br){F.classList.add("is-editing"),U.forEach(X=>X.classList.remove("is-hidden")),Xe.forEach(X=>X.classList.add("is-hidden"));let Z=U[0];Z&&(Z.focus(),Z.select());return}let _e=F.dataset.row||F.querySelector(".inline-input")?.dataset.rowNumber||"";if(!_e)return;let fe={};U.forEach(Z=>{let X=Z.dataset.inlineField||"";X&&(fe[X]=Z.value)}),h(Ye,{method:"POST",body:JSON.stringify({action:"edit",rowNumber:_e,fields:fe})}).then(Z=>{if(Z.ok){let X=e.items.find(V=>String(V.row_number)===String(_e));X&&Object.keys(fe).forEach(V=>{X[V]=fe[V]}),U.forEach(V=>{let Ze=V.closest(".cell")?.querySelector("[data-inline-display]");Ze&&(Ze.textContent=V.value)}),p("Saved"),F.classList.remove("is-editing"),U.forEach(V=>V.classList.add("is-hidden")),Xe.forEach(V=>V.classList.remove("is-hidden"));return}p("Update failed","error")}).catch(()=>{p("Update failed","error")});return}if(D instanceof HTMLInputElement&&D.hasAttribute("data-bulk-select-all")){let F=e.items.map(U=>l(U)).filter(Boolean);D.checked?e.selectedItems=F:e.selectedItems=[],g(),d();return}if(D instanceof HTMLInputElement&&D.dataset.bulkSelectItem!==void 0){let F=D.dataset.bulkSelectItem;if(!F)return;D.checked?e.selectedItems.includes(F)||e.selectedItems.push(F):e.selectedItems=e.selectedItems.filter(U=>U!==F),g(),d();return}let Y=D.dataset.delete;if(Y){if(!f()||!window.confirm("Delete this record? This cannot be undone."))return;let F=y();if(!F){p("No actions available.","error");return}h(F,{method:"POST",body:JSON.stringify(w(e.tab,Y))}).then(U=>{if(U.ok){p("Record deleted"),r();return}p("Delete failed","error")}).catch(()=>{p("Delete failed","error")});return}let Je=D.dataset.view;if(Je){window.location.href=n(Je);return}let ue=D.closest(".list-row");if(ue){if(e.tab==="cost-chart"||e.tab==="diamond-price-chart")return;let F=ue.dataset.row||ue.dataset.slug||ue.dataset.id||"";F?window.location.href=n(F):p("Missing record ID for detail view.","error")}}),t.list.addEventListener("keydown",E=>{let D=E.target;if(D instanceof HTMLInputElement&&D.classList.contains("inline-input")){if(E.key==="Enter"){E.preventDefault();let Y=D.closest(".list-row")?.querySelector("[data-inline-edit]");Y instanceof HTMLElement&&Y.click()}else if(E.key==="Escape"){E.preventDefault();let B=D.closest(".cell")?.querySelector("[data-inline-display]");B&&(D.value=B.textContent||"",B.classList.remove("is-hidden")),D.classList.add("is-hidden")}}}),t.addRowButton&&t.addRowButton.addEventListener("click",()=>{window.location.href=n("new")}),S(),t.actionButtons.addEventListener("click",E=>{let D=E.target;if(!(D instanceof HTMLElement))return;let B=D.dataset.action,Y=D.dataset.confirm;B&&(Y&&!window.confirm(Y)||q(B))}),t.editFields.forEach(E=>{let D=()=>{let B=E.dataset.field||"";B==="metal"&&(L(),N(t.quoteMetalInput?t.quoteMetalInput.value:"",E.value)),B==="quote_discount_type"&&A(),(B==="stone_weight"||B==="diamond_breakdown")&&O(),e.tab==="quotes"&&B&&(te.has(B)?E.value?(E.dataset.auto="false",E.dataset.manual="true"):(E.dataset.manual="",E.dataset.auto="true",I()):re.has(B)&&I()),L()};E.addEventListener("input",D),E.addEventListener("change",D)}),t.quoteMetals.forEach(E=>{E.addEventListener("change",()=>{M(),L()})}),t.diamondBreakdownAdd&&t.diamondBreakdownAdd.addEventListener("click",()=>{let E=a();E.push({weight:"",count:""}),c(E),I()}),t.diamondBreakdownRows&&(t.diamondBreakdownRows.addEventListener("input",E=>{E.target instanceof HTMLInputElement&&(!E.target.hasAttribute("data-diamond-weight")&&!E.target.hasAttribute("data-diamond-count")||(_(),L(),I()))}),t.diamondBreakdownRows.addEventListener("click",E=>{let D=E.target;if(!(D instanceof HTMLElement)||!D.hasAttribute("data-diamond-remove"))return;let B=D.closest("[data-diamond-row]");B&&B.remove(),_(),L(),I(),t.diamondBreakdownRows.querySelector("[data-diamond-row]")||c([])}));let ae=P();ae&&ae.addEventListener("input",()=>{C(),L(),I()}),[t.sizeRing,t.sizeBracelet,t.sizeChain].forEach(E=>{E&&["input","change"].forEach(D=>{E.addEventListener(D,()=>{z(),I(),L()})})}),t.primaryAction&&t.primaryAction.addEventListener("click",()=>{if(e.tab!=="orders"){window.confirm("Save updates to this record?")&&H();return}W()}),t.notesSave&&t.notesSave.addEventListener("click",()=>{window.confirm("Save internal notes?")&&j()}),t.detailsSave&&t.detailsSave.addEventListener("click",()=>{window.confirm("Save fulfillment details?")&&G()}),t.statusSave.addEventListener("click",()=>{window.confirm("Update status for this record?")&&T()}),t.confirmClose&&t.confirmClose.addEventListener("click",J),t.confirmModal&&t.confirmModal.addEventListener("click",E=>{E.target===t.confirmModal&&J()}),t.confirmSend&&t.confirmSend.addEventListener("click",()=>{window.confirm("Send confirmation to customer?")&&ee()})}}}function Qt({state:e,ui:t,tabLabels:o,detailFieldBuilders:r,detailSectionBuilders:s,editFields:k,formatDate:b,formatPhone:v,formatPrice:u,formatDelayWeeks:g,formatGrams:d,formatSignedGrams:l,buildMetalWeightLabel:f,buildMetalWeightAdjustmentLabel:y,buildSizingRows:p,renderDetailRows:h,renderDetailSections:w,renderQuoteMediaSlot:n,refreshQuoteMedia:i,refreshSizingInputs:m,updateMetalWeightLabels:S,setQuoteMetalSelection:q,setDiamondBreakdownRowsFromField:$,resetQuoteAutoPricingState:A,scheduleQuotePricingUpdate:O,applyOrderDetailsVisibility:N,applyQuoteVisibility:M,applyDiscountControlState:L,applyGoldOnlyQuoteState:I,updatePrimaryActionState:a,renderActions:c,updateStatusOptions:_,getContactNotes:C,setOriginalValues:P,toggleDiamondBreakdownVisibility:z,applySizingVisibility:W,isFilled:H}){let j=()=>{let T=new Set(k[e.tab]);t.editFields.forEach(J=>{let ee=J.closest(".field"),te=J.dataset.field||"",re=T.has(te);ee&&ee.classList.toggle("is-hidden",!re)}),t.editSection&&t.editSection.classList.toggle("is-hidden",T.size===0),M()};return{applyEditVisibility:j,populateDrawer:T=>{let J=T.request_id||T.email||T.row_number||T.slug||T.id||T.media_id||""||"Record";e.selectedId=J,e.selectedItem=T,P(T),e.pendingChanges=[],e.confirmation=null;let ee=o[e.tab]||e.tab;t.detailType.textContent=`${ee} details`,t.detailTitle.textContent=T.product_name||T.name||T.key||T.metal||T.clarity||J,t.detailSub.textContent=J;let te=e.tab==="contacts"||e.tab==="cost-chart"||e.tab==="diamond-price-chart"?"--":T.status||"NEW";t.detailStatus.textContent=te,t.detailStatus.dataset.status=te,_(),t.statusSelect&&t.statusSelect.options.length&&(t.statusSelect.value=t.statusSelect.options[0].value||"");let re={item:T,formatDate:b,formatPhone:v,formatPrice:u,formatDelayWeeks:g,formatGrams:d,formatSignedGrams:l,buildMetalWeightLabel:f,buildMetalWeightAdjustmentLabel:y,buildSizingRows:p,renderQuoteMediaSlot:n,getContactNotes:C},Ke=r[e.tab]?r[e.tab](re):[],ae=s[e.tab]?s[e.tab](re):[];ae.length?(t.detailGrid.classList.add("detail-sections"),t.detailGrid.innerHTML=w(ae,H)):(t.detailGrid.classList.remove("detail-sections"),t.detailGrid.innerHTML=h(Ke,H)),i(T),m(T),t.editFields.forEach(E=>{let D=E.dataset.field;if(D){if(D==="notes"){E.value=T.notes||"";return}E.value=T[D]||""}}),S(T.metal||""),q(T.quote_metal_options||"",T.metal||""),$(),A(),O(),j(),N(),M(),L(),I(),z(),W(null),c(),a()}}}function Gt({ui:e,apiFetch:t,showToast:o,windowRef:r}){let s=[],k=d=>{e.notificationsPanel&&(e.notificationsPanel.classList.toggle("is-open",d),e.notificationsPanel.setAttribute("aria-hidden",d?"false":"true"),d?e.notificationsPanel.removeAttribute("inert"):e.notificationsPanel.setAttribute("inert",""))},b=()=>{if(!e.notificationsList)return;if(!s.length){e.notificationsList.innerHTML='<p class="muted">No notifications right now.</p>',e.notificationsBadge&&(e.notificationsBadge.textContent="",e.notificationsBadge.classList.add("is-hidden"));return}let d=s.filter(l=>!l.read).length;e.notificationsBadge&&(e.notificationsBadge.textContent=d?String(d):"",e.notificationsBadge.classList.toggle("is-hidden",d===0)),e.notificationsList.innerHTML=s.map(l=>{let f=l.title||l.type||"Update",y=l.message||l.body||"",p=l.created_at||l.createdAt||"";return`
          <button class="notification-item ${l.read?"":"is-unread"}" type="button" data-notification-id="${l.id||""}">
            <div class="notification-title">${f}</div>
            <div class="notification-body">${y}</div>
            <div class="notification-meta">${p}</div>
          </button>
        `}).join("")},v=async()=>{try{let d=await t("/notifications");s=Array.isArray(d?.items)?d.items:d||[],b()}catch(d){if(d?.status===404){s=[],b();return}s=[],b(),r.location.hostname==="localhost"&&o("Notifications unavailable.","error")}},u=async d=>{if(d)try{await t(`/notifications/${d}/read`,{method:"POST"}),s=s.map(l=>String(l.id)===String(d)?{...l,read:!0}:l),b()}catch{o("Failed to mark notification read.","error")}};return{bindNotifications:()=>{e.notificationsToggle&&e.notificationsToggle.addEventListener("click",()=>{let d=e.notificationsPanel?.classList.contains("is-open");k(!d),d||v()}),e.notificationsClose&&e.notificationsClose.addEventListener("click",()=>k(!1)),e.notificationsList&&e.notificationsList.addEventListener("click",d=>{let l=d.target.closest("[data-notification-id]");l&&u(l.dataset.notificationId)})},loadNotifications:v}}function Kt({ui:e,apiFetch:t,showToast:o}){let r=()=>e.consultationsRange&&e.consultationsRange.value||"30",s=(d,l)=>{d&&(d.textContent=l??"--")},k=d=>{e.consultationsSource&&(e.consultationsSource.innerHTML=d.map(l=>{let f=l.total||0,y=l.became_quotes||0,p=f?(y/f*100).toFixed(1):"0.0";return`
          <tr>
            <td>${l.source||"Unknown"}</td>
            <td>${f}</td>
            <td>${l.completed||0}</td>
            <td>${y}</td>
            <td>${l.became_orders||0}</td>
            <td>${p}%</td>
          </tr>
        `}).join(""))},b=d=>{e.consultationsCampaign&&(e.consultationsCampaign.innerHTML=d.map(l=>{let f=l.bookings||0,y=l.conversions||0,p=f?(y/f*100).toFixed(1):"0.0";return`
          <tr>
            <td>${l.utm_campaign||"N/A"}</td>
            <td>${l.utm_source||"N/A"}</td>
            <td>${l.utm_medium||"N/A"}</td>
            <td>${f}</td>
            <td>${y}</td>
            <td>${p}%</td>
          </tr>
        `}).join(""))},v=d=>{e.consultationsHear&&(e.consultationsHear.innerHTML=d.map(l=>`
          <tr>
            <td>${l.how_heard_about_us||"Not specified"}</td>
            <td>${l.count||0}</td>
          </tr>
        `).join(""))},u=async()=>{let d=r();try{let l=await t(`/consultations/analytics?days=${d}`),f=l?.data||l;if(!f)throw new Error("Missing analytics data");let y=f.sourceStats||[],p=f.campaignStats||[],h=f.hearAboutStats||[],w=0,n=0,i=0,m=0;y.forEach(S=>{w+=S.total||0,n+=S.completed||0,i+=S.became_quotes||0,m+=S.became_orders||0}),s(e.consultationsTotal,w),s(e.consultationsCompleted,n),s(e.consultationsQuotes,i),s(e.consultationsOrders,m),k(y),b(p),v(h)}catch{o("Failed to load consultations analytics.","error")}};return{bindConsultations:()=>{e.consultationsRefresh&&e.consultationsRefresh.addEventListener("click",u),e.consultationsRange&&e.consultationsRange.addEventListener("change",u)},loadConsultations:u}}function Jt({ui:e,apiFetch:t,showToast:o}){let r=p=>{p&&Object.entries(p).forEach(([h,w])=>{let n=document.querySelector(`[data-count-${h}]`);if(!n)return;let i=Number(w)||0;n.textContent=String(i),n.style.display=i>0?"inline-flex":"none"})},s=async()=>{try{let p=await t("/navigation/counts");r(p||{})}catch(p){if(p?.status===404){r({});return}o("Failed to load sidebar counts.","error")}},k=()=>{s(),setInterval(s,3e4)},b=p=>{p.forEach(h=>{h.style.display="",h.classList.remove("search-highlight")}),document.querySelector(".side-search__no-results")?.remove()},v=(p,h)=>{let w=document.querySelector(".side-search__no-results");if(p&&!w){let n=document.querySelector(".side-search");if(!n)return;let i=document.createElement("div");i.className="side-search__no-results",i.innerHTML=`
        <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.3;margin-bottom:8px;">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <p>No sections matching<br/><strong>"${h}"</strong></p>
      `,n.after(i)}else!p&&w&&w.remove()},u=(p,h,w)=>{let n=!1;w.forEach(i=>{let m=Array.from(i.querySelectorAll(".side-link")),S=!1;if(m.forEach(q=>{let A=(q.querySelector(".side-link__label")?.textContent?.toLowerCase()||"").includes(p);q.style.display=A?"":"none",A?(q.classList.add("search-highlight"),S=!0,n=!0):q.classList.remove("search-highlight")}),S&&i.classList.contains("is-collapsed")){i.classList.remove("is-collapsed");let q=i.querySelector("[data-side-toggle]");q&&(q.textContent="-")}}),v(!n,p)},g=()=>{let p=e.sidebarSearch;if(!p)return;let h=Array.from(document.querySelectorAll(".side-link")),w=Array.from(document.querySelectorAll(".side-block"));p.addEventListener("input",n=>{let i=String(n.target.value||"").toLowerCase().trim();if(!i){b(h);return}u(i,h,w)}),p.addEventListener("keydown",n=>{n.key==="Escape"&&(p.value="",p.dispatchEvent(new Event("input")),p.blur())})},d=()=>{let p=Array.from(document.querySelectorAll(".side-link")),h=p.findIndex(w=>w.classList.contains("is-active"));h<0&&(h=0),document.addEventListener("keydown",w=>{if(!w.target.matches("input, textarea, select")){if((w.metaKey||w.ctrlKey)&&w.key.toLowerCase()==="k"){w.preventDefault(),e.sidebarSearch?.focus(),e.sidebarSearch?.select();return}if(w.altKey&&w.key>="1"&&w.key<="9"){w.preventDefault();let n=Number(w.key)-1;p[n]&&(p[n].click(),p[n].focus());return}w.altKey&&(w.key==="ArrowUp"||w.key==="ArrowDown")&&(w.preventDefault(),w.key==="ArrowUp"?h=h>0?h-1:p.length-1:h=h<p.length-1?h+1:0,p[h].click(),p[h].focus())}})},l=()=>{e.sidebar&&(e.sidebar.classList.remove("is-collapsed"),e.appShell?.classList.remove("sidebar-collapsed"))},f=()=>{document.querySelectorAll("[data-side-toggle]").forEach(w=>{w.addEventListener("click",()=>{let n=w.closest(".side-block");if(!n)return;let i=n.classList.toggle("is-collapsed");w.textContent=i?"+":"-";let m=n.dataset.blockId;if(m){let S=JSON.parse(localStorage.getItem("sidebar-collapsed-blocks")||"[]");if(i)S.includes(m)||S.push(m);else{let q=S.indexOf(m);q>-1&&S.splice(q,1)}localStorage.setItem("sidebar-collapsed-blocks",JSON.stringify(S))}})}),JSON.parse(localStorage.getItem("sidebar-collapsed-blocks")||"[]").forEach(w=>{let n=document.querySelector(`[data-block-id="${w}"]`);if(n&&!n.classList.contains("is-collapsed")){n.classList.add("is-collapsed");let i=n.querySelector("[data-side-toggle]");i&&(i.textContent="+")}})};return{initSidebar:()=>{l(),g(),d(),f(),k(),console.log("Sidebar initialized")},updateNavigationCounts:r}}var gr=[{key:"price",label:"Price",normalize:It,format:he},{key:"timeline",label:"Timeline",normalize:$e,format:Me},{key:"timeline_adjustment_weeks",label:"Timeline delay",normalize:le,format:ze},{key:"metal",label:"Metal",normalize:ne,format:Oe},{key:"metal_weight",label:"Metal weight (g)",normalize:le,format:Te},{key:"metal_weight_adjustment",label:"Final Metal weight difference (g)",normalize:le,format:Pe},{key:"stone",label:"Stone type",normalize:ne,format:Oe},{key:"stone_weight",label:"Stone weight",normalize:le,format:qt}],je=e=>{let t=String(e||"NEW").trim().toUpperCase();return t==="INVOICE_NOT_PAID"?"INVOICE_EXPIRED":t||"NEW"},hr=()=>{let e=je(x.selectedItem?.status);return(kt[e]||[]).filter(o=>o!=="PENDING_CONFIRMATION")};function He(){return x.tab==="orders"||x.tab==="quotes"?x.role==="admin"||x.role==="ops":x.tab==="tickets"?x.role==="admin"||x.role==="ops":x.tab==="cost-chart"||x.tab==="diamond-price-chart"?x.role==="admin":xe.has(x.tab)?x.role==="admin"||x.role==="ops":!1}var Xt=()=>x.tab===me,Yt=()=>x.tab==="consultations",yr=()=>Xt()||Yt(),wr=document.body.dataset.enableNavCounts==="true",Zt=()=>et.has(x.tab),R={syncLine:document.querySelector("[data-sync-line]"),userRole:document.querySelector("[data-user-role]"),userEmail:document.querySelector("[data-user-email]"),tabTitle:document.querySelector("[data-tab-title]"),autoRefresh:document.querySelector("[data-auto-refresh]"),tabs:Array.from(document.querySelectorAll("[data-tab]")),adminTabs:Array.from(document.querySelectorAll("[data-admin-only]")),dashboard:document.querySelector("[data-dashboard]"),filtersWrap:document.querySelector(".filters"),listWrap:document.querySelector(".list-wrap"),bulkActions:document.querySelector("[data-bulk-actions]"),addRowWrap:document.querySelector("[data-add-row-wrap]"),addRowButton:document.querySelector("[data-add-row]"),filters:Array.from(document.querySelectorAll("[data-filter]")),exportButtons:Array.from(document.querySelectorAll("[data-export]")),listHeader:document.querySelector("[data-list-header]"),list:document.querySelector("[data-list]"),results:document.querySelector("[data-results]"),prev:document.querySelector("[data-prev]"),next:document.querySelector("[data-next]"),refresh:document.querySelector("[data-refresh]"),drawer:document.querySelector("[data-drawer]"),drawerClose:document.querySelector("[data-drawer-close]"),detailType:document.querySelector("[data-detail-type]"),detailTitle:document.querySelector("[data-detail-title]"),detailSub:document.querySelector("[data-detail-sub]"),detailStatus:document.querySelector("[data-detail-status]"),statusSelect:document.querySelector("[data-status-select]"),statusSave:document.querySelector("[data-status-save]"),detailGrid:document.querySelector("[data-detail-grid]"),actionButtons:document.querySelector("[data-action-buttons]"),editSection:document.querySelector("[data-edit-section]"),quoteSection:document.querySelector("[data-quote-section]"),quoteMetals:Array.from(document.querySelectorAll('[data-quote-metals] input[type="checkbox"]')),quoteMetalInput:document.querySelector('[data-field="quote_metal_options"]'),metalWeightLabel:document.querySelector("[data-metal-weight-label]"),metalWeightAdjustmentLabel:document.querySelector("[data-metal-weight-adjustment-label]"),editFields:Array.from(document.querySelectorAll("[data-field]")),orderDetailsSection:document.querySelector("[data-order-details-section]"),orderDetailsFields:Array.from(document.querySelectorAll("[data-order-details-field]")),diamondBreakdown:document.querySelector("[data-diamond-breakdown]"),diamondBreakdownRows:document.querySelector("[data-diamond-breakdown-rows]"),diamondBreakdownAdd:document.querySelector("[data-diamond-breakdown-add]"),sizeRing:document.querySelector("[data-size-ring] input"),sizeBracelet:document.querySelector("[data-size-bracelet] input"),sizeChain:document.querySelector("[data-size-chain] input"),triggerDeploy:document.querySelector("[data-trigger-deploy]"),deployStatus:document.querySelector("[data-deploy-status]"),detailsSave:document.querySelector("[data-details-save]"),primaryAction:document.querySelector("[data-primary-action]"),notesSave:document.querySelector("[data-notes-save]"),confirmModal:document.querySelector("[data-confirm-modal]"),confirmClose:document.querySelector("[data-confirm-close]"),confirmTo:document.querySelector("[data-confirm-to]"),confirmSubject:document.querySelector("[data-confirm-subject]"),confirmPreview:document.querySelector("[data-confirm-preview]"),confirmSend:document.querySelector("[data-confirm-send]"),toast:document.querySelector("[data-toast]"),notificationsToggle:document.querySelector("[data-notifications-toggle]"),notificationsPanel:document.querySelector("[data-notifications-panel]"),notificationsList:document.querySelector("[data-notifications-list]"),notificationsBadge:document.querySelector("[data-notifications-badge]"),notificationsClose:document.querySelector("[data-notifications-close]"),consultationsSection:document.querySelector("[data-consultations]"),consultationsRange:document.querySelector("[data-consultations-range]"),consultationsRefresh:document.querySelector("[data-consultations-refresh]"),consultationsTotal:document.querySelector("[data-consultations-total]"),consultationsCompleted:document.querySelector("[data-consultations-completed]"),consultationsQuotes:document.querySelector("[data-consultations-quotes]"),consultationsOrders:document.querySelector("[data-consultations-orders]"),consultationsSource:document.querySelector("[data-consultations-source]"),consultationsCampaign:document.querySelector("[data-consultations-campaign]"),consultationsHear:document.querySelector("[data-consultations-hear]"),sidebar:document.querySelector("[data-sidebar]"),sidebarCollapse:document.querySelector("[data-sidebar-collapse]"),sidebarSearch:document.querySelector("[data-sidebar-search]"),appShell:document.querySelector(".app-shell")},K=tt(R.toast),{closeDrawer:er,openDrawer:vr,renderDetailRows:Sr,renderDetailSections:kr,bindDrawerEvents:_r}=at({ui:R,escapeHtml:ie}),{updateStatusOptions:tr,updateSortOptions:Er,updateStatusFilterOptions:Lr}=nt({state:x,ui:R,statusOptions:Ie,sortOptions:ht,sortDefaults:yt,isDashboardTab:yr,getOrderStatusOptions:hr,normalizeStatus:je}),{buildDeletePayload:Ir,detailUrl:qr,getItemKey:ve,getSelectedRecordId:Cr}=ut({state:x,storage:typeof localStorage>"u"?null:localStorage,locationHref:window.location.href}),{renderList:Se}=rt({state:x,ui:R,listColumns:qe,isBulkEnabled:Zt,canEditCurrentTab:He,getValue:pr,getItemKey:ve,escapeAttribute:se}),{updateBulkActions:We,handleBulkAction:Dr}=st({state:x,ui:R,apiFetch:Q,getActionEndpoint:Ve,showToast:K,renderList:Se,loadList:ur,isBulkEnabled:Zt,clearSelection:mr}),{exportData:xr}=lt({state:x,listColumns:qe,getItemKey:ve,getValue:pr,showToast:K}),ce=null,Ue=e=>{ce&&ce.setTab&&(ce.setTab(e),Ur(e))},{loadDashboard:Ar}=it({apiFetch:Q,ui:R,setTab:Ue,escapeHtml:ie}),Nr=pe(),Rr=(document.body.dataset.siteBase||"https://www.heerawalla.com").replace(/\/$/,""),$r=e=>Lt(e,Rr),Or=e=>ct(e),Ve=()=>dt(x.tab),we=localStorage.getItem("adminAutoRefresh")!=="false";R.autoRefresh&&(R.autoRefresh.checked=we);var Tr=e=>{we=e,localStorage.setItem("adminAutoRefresh",String(we))},{getCatalogBase:Pr,loadCatalog:zr,refreshQuoteMedia:Mr,renderQuoteMediaSlot:Br,resolveCatalogEntry:Fr}=xt({apiBase:Nr,ui:R,normalizeImageUrl:$r,escapeAttribute:se}),{ensureLocalAdminAccess:jr}=ft({getLocalAdminEmail:oe,storage:typeof localStorage>"u"?null:localStorage,documentRef:document,windowRef:window}),{setLastSync:Hr,setSyncStatus:Be,updateSyncLine:rr}=pt({ui:R}),{getInitialTab:Wr,updateTabInUrl:Ur}=mt({windowRef:window}),{applySizingVisibility:nr,buildSizingRows:Vr,getDiamondBreakdownField:Qr,getDiamondRowsFromDom:Gr,refreshSizingInputs:Kr,renderDiamondBreakdownRows:Jr,setDiamondBreakdownRowsFromField:ar,syncDiamondBreakdownField:Xr,syncSizingToSizeField:Yr,toggleDiamondBreakdownVisibility:or}=Ct({state:x,ui:R,escapeAttribute:se,isFilled:ye,normalizeText:ne,getEditField:ke,getEditValue:de,loadCatalog:zr,resolveCatalogEntry:Fr}),{applyDiscountControlState:ir,applyGoldOnlyQuoteState:Qe,buildMetalWeightAdjustmentLabel:Zr,buildMetalWeightLabel:en,getRequestedMetalGroup:fo,isGoldOnlyQuote:tn,setQuoteMetalSelection:sr,syncQuoteMetalInput:lr,toggleFieldVisibility:mo,updateMetalWeightLabels:rn}=Ot({state:x,ui:R,normalizeText:ne,getEditValue:de,getEditField:ke}),{collectConfirmChanges:nn,collectEditableUpdates:an,getNotesValue:on,renderActions:sn,setOriginalValues:ln,updatePrimaryActionState:Ge}=gt({state:x,ui:R,confirmFields:gr,editFields:Ce,pricingTabs:be,canEditCurrentTab:He,actions:wt,orderActionFlow:_t,normalizeStatus:je,syncQuoteMetalInput:lr,getEditValue:de}),{markQuotePriceManual:po,resetQuoteAutoPricingState:cn,scheduleQuotePricingUpdate:cr,quotePriceFields:dn}=At({state:x,ui:R,quoteOptionFields:ge,quotePricingFields:Ae,quotePriceFields:Et,isGoldOnlyQuote:tn,getEditField:ke,getEditValue:de,getCatalogBase:Pr,updatePrimaryActionState:Ge}),{buildConfirmationEmail:un,resolveConfirmationUrl:fn,openConfirmModal:mn,closeConfirmModal:dr}=Rt({ui:R,escapeHtml:ie,escapeAttribute:se,buildEtaLine:$n,getEditValue:de}),{applyOrderDetailsVisibility:pn,collectOrderDetailsUpdates:bn,loadOrderDetails:gn,populateOrderDetails:bo}=$t({state:x,ui:R,apiFetch:Q,orderDetailsFields:vt}),{prepareConfirmation:hn,runAction:yn,saveDetails:wn,saveNotes:vn,saveOrderDetails:Sn,saveStatus:kn,sendConfirmation:_n}=Tt({state:x,ui:R,apiFetch:Q,showToast:K,loadList:ur,getActionEndpoint:Ve,getSelectedRecordId:Cr,collectEditableUpdates:an,getNotesValue:on,collectOrderDetailsUpdates:bn,requiredShippingFields:St,pricingTabs:be,getEditField:ke,collectConfirmChanges:nn,buildConfirmationEmail:un,resolveConfirmationUrl:fn,openConfirmModal:mn,closeConfirmModal:dr,loadOrderDetails:gn}),{triggerSiteRebuild:En}=Pt({ui:R,getApiBase:pe,getStoredAdminEmail:Ee,getLocalAdminEmail:oe,buildAdminHeaders:Le,showToast:K,windowRef:window}),{bindNotifications:Ln}=Gt({ui:R,apiFetch:Q,showToast:K,windowRef:window}),{bindConsultations:In,loadConsultations:qn}=Kt({ui:R,apiFetch:Q,showToast:K}),{initSidebar:Cn,updateNavigationCounts:Dn}=Jt({ui:R,apiFetch:Q,showToast:K});ce=bt({state:x,ui:R,tabLabels:De,isDashboardTab:Xt,isConsultationsTab:Yt,loadConsultations:qn,updateStatusOptions:tr,updateStatusFilterOptions:Lr,updateSortOptions:Er,updateBulkActions:We,loadDashboard:Ar,apiFetch:Q,getTabEndpoint:Or,renderList:Se,getItemKey:ve,populateDrawer:fr,closeDrawer:er,setSyncStatus:Be,setLastSync:Hr,showToast:K,pricingTabs:be,catalogTabs:xe});var{buildQuery:go,loadCurrentView:Fe,loadList:ur,updateAddRowVisibility:xn,updateDashboardVisibility:ho,updateTabVisibility:An}=ce,{populateDrawer:fr,applyEditVisibility:yo}=Qt({state:x,ui:R,tabLabels:De,detailFieldBuilders:{contacts:zt,tickets:Mt,"cost-chart":Ft,"diamond-price-chart":jt,products:Ht,inspirations:Wt,"media-library":Ut},detailSectionBuilders:{orders:Bt,quotes:Dt},editFields:Ce,formatDate:Ne,formatPhone:Re,formatPrice:he,formatDelayWeeks:ze,formatGrams:Te,formatSignedGrams:Pe,buildMetalWeightLabel:en,buildMetalWeightAdjustmentLabel:Zr,buildSizingRows:Vr,renderDetailRows:Sr,renderDetailSections:kr,renderQuoteMediaSlot:Br,refreshQuoteMedia:Mr,refreshSizingInputs:Kr,updateMetalWeightLabels:rn,setQuoteMetalSelection:sr,setDiamondBreakdownRowsFromField:ar,resetQuoteAutoPricingState:cn,scheduleQuotePricingUpdate:cr,applyOrderDetailsVisibility:pn,applyQuoteVisibility:On,applyDiscountControlState:ir,applyGoldOnlyQuoteState:Qe,updatePrimaryActionState:Ge,renderActions:sn,updateStatusOptions:tr,getContactNotes:Rn,setOriginalValues:ln,toggleDiamondBreakdownVisibility:or,applySizingVisibility:nr,isFilled:ye}),{bindEvents:Nn}=Vt({state:x,ui:R,setTab:Ue,loadCurrentView:Fe,setAutoRefresh:Tr,updateSyncLine:rr,clearSelection:mr,handleBulkAction:Dr,exportData:xr,updateBulkActions:We,renderList:Se,getItemKey:ve,canEditCurrentTab:He,getActionEndpoint:Ve,showToast:K,apiFetch:Q,buildDeletePayload:Ir,detailUrl:qr,populateDrawer:fr,openDrawer:vr,bindDrawerEvents:_r,runAction:yn,triggerSiteRebuild:En,applyDiscountControlState:ir,applyGoldOnlyQuoteState:Qe,setQuoteMetalSelection:sr,syncQuoteMetalInput:lr,updatePrimaryActionState:Ge,scheduleQuotePricingUpdate:cr,getDiamondRowsFromDom:Gr,renderDiamondBreakdownRows:Jr,syncDiamondBreakdownField:Xr,setDiamondBreakdownRowsFromField:ar,getDiamondBreakdownField:Qr,syncSizingToSizeField:Yr,prepareConfirmation:hn,saveDetails:wn,saveNotes:vn,saveOrderDetails:Sn,saveStatus:kn,closeConfirmModal:dr,sendConfirmation:_n,quotePriceFields:dn,quotePricingFields:Ae});function mr(){x.selectedItems=[],We(),Se()}function Rn(e){if(!e)return"";let t=[e.notes,e.customer_notes,e.note,e.message,e.inquiry,e.details];for(let o of t)if(ye(o))return o;return""}function $n(e,t){let o=Me(e)||"Standard",r=Number(String(t||"").trim());return!Number.isNaN(r)&&r>0?`Estimated delivery after payment: ${o} + ${r} week${r===1?"":"s"}.`:`Estimated delivery after payment: ${o}.`}function ke(e){return R.editFields.find(t=>t.dataset.field===e)}function de(e){let t=R.editFields.find(o=>o.dataset.field===e);return t?t.value.trim():""}function On(){R.quoteSection&&(R.quoteSection.classList.toggle("is-hidden",x.tab!=="quotes"),or(),Qe(),x.tab!=="quotes"&&nr(null))}function pr(e,t){return t==="created_at"?Ne(e[t]):t==="price"?he(e[t]):t==="status"?e[t]||"--":t==="phone"?Re(e[t]):t==="is_active"?String(e[t]||"").toLowerCase()==="true"?"Yes":"No":e[t]||"--"}async function Tn(){try{let e=await Q("/me");x.role=e.role||"",x.email=e.email||"",R.userRole&&(R.userRole.textContent=x.role||"Unknown"),R.userEmail&&(R.userEmail.textContent=x.email||"Not authorized"),An(),xn(),Be("Connected")}catch{Be("Access blocked"),K("Access denied. Check Access policy.","error")}}async function Pn(){let e=Wr(x.tab);if(Nn(),Ln(),In(),Cn(),ot({ui:R,loadCurrentView:Fe,closeDrawer:er}),rr(),!jr())return;await Tn();let t=e&&(Ie[e]||e===me)?e:x.tab;if(Ue(t),wr||Dn({}),setInterval(()=>{document.hidden||!we||Fe()},6e4),window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"){window.addEventListener("load",()=>{let r=performance.getEntriesByType("navigation")[0],s=r&&Number.isFinite(r.duration)?r.duration:performance.now();console.log(`[perf] Page loaded in ${Math.round(s)}ms`)});let o=window.fetch;window.fetch=async(...r)=>{let s=performance.now(),k=await o(...r),b=performance.now();return console.log(`[perf] API call ${(b-s).toFixed(0)}ms`,r[0]),k}}}Pn();})();
