---
import "../styles/global.css";
import { withBase } from '../lib/paths';
const { title = 'Heerawalla | Fine jewelry crafted with precision', description = 'Luxury jewelry catalog with timeless, minimal design.', image } = Astro.props as { title?: string; description?: string; image?: string };
const siteOrigin = Astro.site?.origin || 'https://heerawalla.com';
const ogImage = image && image.startsWith('http') ? image : new URL(withBase(image || '/images/hero.png'), siteOrigin).toString();
const url = new URL(Astro.url.pathname, siteOrigin).toString();
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={url} />
    <link rel="icon" type="image/svg+xml" href={withBase('/favicon.svg')} />
    <link rel="shortcut icon" href={withBase('/favicon.svg')} />
  </head>
  <body class="min-h-screen bg-white text-ink">
    <slot />

    <script is:inline>
      (() => {
        const KEY_CURRENCY = 'hw-currency';
        const KEY_RATE = 'hw-usd-inr-rate';
        const ONE_DAY = 24 * 60 * 60 * 1000;
        const FALLBACK_RATE = 85;

        let currency = localStorage.getItem(KEY_CURRENCY) || 'USD';
        let rateInrPerUsd = null;

        const formatters = {
          USD: new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }),
          INR: new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' })
        };

        const apply = () => {
          document.documentElement.dataset.currency = currency;
          document.querySelectorAll('[data-price-inr]').forEach((el) => {
            const inr = Number(el.dataset.priceInr || 0);
            const rate = rateInrPerUsd || FALLBACK_RATE;
            const usd = rate ? (inr / rate) * 1.05 : 0; // add 5% after conversion
            const formatter = formatters[currency] || formatters.USD;
            const val = currency === 'INR' ? inr : usd;
            el.textContent = formatter.format(val || 0);
          });
        };

        const fetchRate = async () => {
          const cachedRaw = localStorage.getItem(KEY_RATE);
          if (cachedRaw) {
            try {
              const cached = JSON.parse(cachedRaw);
              if (cached.rate && cached.rate > 0 && cached.ts && Date.now() - cached.ts < ONE_DAY) {
                rateInrPerUsd = cached.rate;
                return;
              }
            } catch {}
          }
          const date = new Date(Date.now() - ONE_DAY).toISOString().slice(0, 10);
          const url = `https://api.exchangerate.host/${date}?base=USD&symbols=INR`;
          const fallback = FALLBACK_RATE;
          try {
            const res = await fetch(url);
            if (!res.ok) throw new Error('rate fetch failed');
            const data = await res.json();
            const rate = data?.rates?.INR;
            if (!rate || rate <= 0) throw new Error('bad rate');
            rateInrPerUsd = rate * 1.05;
            localStorage.setItem(KEY_RATE, JSON.stringify({ rate: rateInrPerUsd, ts: Date.now() }));
          } catch {
            rateInrPerUsd = fallback;
          }
        };

        window.addEventListener('hw:currency:update', (event) => {
          currency = event.detail;
          localStorage.setItem(KEY_CURRENCY, currency);
          apply();
        });

        fetchRate().then(apply).catch(apply);
      })();
    </script>
  </body>
</html>
