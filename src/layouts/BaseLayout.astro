---
import "../styles/global.css";
import { withBase } from '../lib/paths';

type Crumb = { label: string; href?: string };
const {
  title = 'Heerawalla | Fine jewelry crafted with precision',
  description = 'Luxury jewelry catalog with timeless, minimal design.',
  image,
  keywords,
  breadcrumbs
} = Astro.props as {
  title?: string;
  description?: string;
  image?: string;
  keywords?: string;
  breadcrumbs?: Crumb[];
};
const siteOrigin = Astro.site?.origin || 'https://heerawalla.com';
const ogImage = image && image.startsWith('http') ? image : new URL(withBase(image || '/images/hero.png'), siteOrigin).toString();
const logoImage = new URL(withBase('/images/engraving_mark.svg'), siteOrigin).toString();
const url = new URL(Astro.url.pathname, siteOrigin).toString();
const gaMeasurementId = import.meta.env.PUBLIC_GA_MEASUREMENT_ID ?? '';
const titleCase = (value: string) =>
  value
    .split(/[-_]/g)
    .map((word) => (word ? word[0].toUpperCase() + word.slice(1) : ''))
    .join(' ');
const buildCrumbs = () => {
  if (breadcrumbs?.length) return breadcrumbs;
  const segments = Astro.url.pathname.split('/').filter(Boolean);
  if (segments.length === 0) return [{ label: 'Home', href: withBase('/') }];
  const crumbs: Crumb[] = [{ label: 'Home', href: withBase('/') }];
  segments.forEach((seg, idx) => {
    const href = withBase(`/${segments.slice(0, idx + 1).join('/')}`);
    crumbs.push({ label: titleCase(seg), href });
  });
  return crumbs;
};
const crumbItems = buildCrumbs();
const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: crumbItems.map((crumb, index) => ({
    '@type': 'ListItem',
    position: index + 1,
    name: crumb.label,
    item: new URL(crumb.href || Astro.url.pathname, siteOrigin).toString()
  }))
};
const organizationSchema = {
  '@context': 'https://schema.org',
  '@type': 'Organization',
  name: 'Heerawalla',
  alternateName: [
    'Heerawala',
    'Hirawala',
    'Hirawalla',
    'Herowalla',
    'Herowala',
    'Hero Wala',
    'Hero Walla',
    'Heera Walla',
    'Heera Wala',
    'हीरावाला',
    'હીરાવાળા',
    'હીરાવાલા'
  ],
  url: siteOrigin,
  logo: logoImage
};
const websiteSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  name: 'Heerawalla',
  url: siteOrigin,
  publisher: {
    '@type': 'Organization',
    name: 'Heerawalla',
    logo: logoImage
  }
};
const breadcrumbJson = JSON.stringify(breadcrumbSchema);
const organizationJson = JSON.stringify(organizationSchema);
const websiteJson = JSON.stringify(websiteSchema);
void breadcrumbJson;
void organizationJson;
void websiteJson;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <meta name="description" content={description} />
    {keywords ? <meta name="keywords" content={keywords} /> : null}
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={url} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com https://challenges.cloudflare.com https://static.cloudflareinsights.com; connect-src 'self' https://www.google-analytics.com https://region1.google-analytics.com https://stats.g.doubleclick.net https://herawalla-email-atelier.arifmanasiya.workers.dev https://cloudflareinsights.com https://static.cloudflareinsights.com; img-src 'self' data: https:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; frame-src https://challenges.cloudflare.com;"
    />
    <link rel="icon" type="image/svg+xml" href={withBase('/images/engraving_mark.svg')} />
    <link rel="shortcut icon" href={withBase('/images/engraving_mark.svg')} />
    <link rel="apple-touch-icon" href={withBase('/images/engraving_mark.svg')} />
    <link rel="mask-icon" href={withBase('/images/engraving_mark.svg')} color="#0B1928" />
    {gaMeasurementId ? (
      <>
        <meta name="ga-measurement-id" content={gaMeasurementId} />
        <script async is:inline src={`https://www.googletagmanager.com/gtag/js?id=${gaMeasurementId}`}></script>
        <script defer is:inline src={withBase('/scripts/ga.js')}></script>
      </>
    ) : null}
    <script type="application/ld+json" is:inline>
      {organizationJson}
    </script>
    <script type="application/ld+json" is:inline>
      {breadcrumbJson}
    </script>
    <script type="application/ld+json" is:inline>
      {websiteJson}
    </script>
  </head>
  <body class="min-h-screen bg-white text-ink">
    <div
      id="legacy-browser-banner"
      role="alert"
      style="display:none"
      class="w-full bg-ink text-white text-xs uppercase tracking-[0.2em] px-6 py-3 text-center"
    >
      Your browser is out of date. For the best experience, please update your browser.
      <a
        href="https://browser-update.org/update.html"
        class="underline underline-offset-2"
        target="_blank"
        rel="noreferrer"
      >Update browser</a>
    </div>
    <slot />

    <script is:inline>
      (function () {
        var ua = navigator.userAgent;
        var isOld = false;
        var chromeMatch = ua.match(/Chrome\/(\d+)/);
        if (chromeMatch && !/Edg\//.test(ua)) {
          isOld = parseInt(chromeMatch[1], 10) < 90;
        }
        var edgeMatch = ua.match(/Edg\/(\d+)/);
        if (edgeMatch) {
          isOld = parseInt(edgeMatch[1], 10) < 90;
        }
        var firefoxMatch = ua.match(/Firefox\/(\d+)/);
        if (firefoxMatch) {
          isOld = parseInt(firefoxMatch[1], 10) < 90;
        }
        var safariMatch = ua.match(/Version\/(\d+).+Safari/);
        if (safariMatch && !/Chrome|Chromium|Edg/.test(ua)) {
          isOld = parseInt(safariMatch[1], 10) < 14;
        }
        if (!isOld) return;
        var banner = document.getElementById('legacy-browser-banner');
        if (!banner) return;
        banner.style.display = 'block';
      })();
    </script>

    <script is:inline>
      (() => {
        const isProtected = (target) => {
          if (!(target instanceof Element)) return false;
          return Boolean(target.closest('img[data-protected-image]'));
        };
        const stopIfProtected = (event) => {
          if (isProtected(event.target)) {
            event.preventDefault();
          }
        };
        document.addEventListener('contextmenu', stopIfProtected);
        document.addEventListener('dragstart', stopIfProtected);
      })();
    </script>

  </body>
</html>
