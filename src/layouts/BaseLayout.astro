---
import "../styles/global.css";
import { withBase } from '../lib/paths';
import { HERO_IMAGE_URL } from '../lib/placeholders';

type Crumb = { label: string; href?: string };
const {
  title = 'Heerawalla | Fine jewelry crafted with precision',
  description = 'Luxury jewelry catalog with timeless, minimal design.',
  image,
  keywords,
  breadcrumbs
} = Astro.props as {
  title?: string;
  description?: string;
  image?: string;
  keywords?: string;
  breadcrumbs?: Crumb[];
};
const siteOrigin = Astro.site?.origin || 'https://heerawalla.com';
const ogImage = image && image.startsWith('http') ? image : new URL(image || HERO_IMAGE_URL, siteOrigin).toString();
const logoImage = new URL(withBase('/favicon.svg'), siteOrigin).toString();
const url = new URL(Astro.url.pathname, siteOrigin).toString();
const gaMeasurementId = import.meta.env.PUBLIC_GA_MEASUREMENT_ID ?? '';
const metaPixelId = import.meta.env.PUBLIC_META_PIXEL_ID ?? '';
const isDev = import.meta.env.DEV;
const isLocalHost = Astro.url.hostname === 'localhost' || Astro.url.hostname === '127.0.0.1';
const devConnect = isDev || isLocalHost ? ' http://localhost:8787' : '';
const devImg = isDev || isLocalHost ? ' http://localhost:8787' : '';
const csp = `default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com https://connect.facebook.net https://challenges.cloudflare.com https://static.cloudflareinsights.com; script-src-elem 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com https://connect.facebook.net https://challenges.cloudflare.com https://static.cloudflareinsights.com; script-src-attr 'self' 'unsafe-inline'; connect-src 'self' https://www.google-analytics.com https://region1.google-analytics.com https://stats.g.doubleclick.net https://www.facebook.com https://herawalla-email-atelier.arifmanasiya.workers.dev https://admin-api.heerawalla.com https://cloudflareinsights.com https://static.cloudflareinsights.com${devConnect}; img-src 'self' data: https: https://www.facebook.com${devImg}; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; frame-src https://challenges.cloudflare.com;`;
const titleCase = (value: string) =>
  value
    .split(/[-_]/g)
    .map((word) => (word ? word[0].toUpperCase() + word.slice(1) : ''))
    .join(' ');
const buildCrumbs = () => {
  if (breadcrumbs?.length) return breadcrumbs;
  const segments = Astro.url.pathname.split('/').filter(Boolean);
  if (segments.length === 0) return [{ label: 'Home', href: withBase('/') }];
  const crumbs: Crumb[] = [{ label: 'Home', href: withBase('/') }];
  segments.forEach((seg, idx) => {
    const href = withBase(`/${segments.slice(0, idx + 1).join('/')}`);
    crumbs.push({ label: titleCase(seg), href });
  });
  return crumbs;
};
const crumbItems = buildCrumbs();
const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: crumbItems.map((crumb, index) => ({
    '@type': 'ListItem',
    position: index + 1,
    name: crumb.label,
    item: new URL(crumb.href || Astro.url.pathname, siteOrigin).toString()
  }))
};
const organizationSchema = {
  '@context': 'https://schema.org',
  '@type': 'Organization',
  name: 'Heerawalla',
  alternateName: [
    'Heerawala',
    'Hirawala',
    'Hirawalla',
    'Herowalla',
    'Herowala',
    'Hero Wala',
    'Hero Walla',
    'Heera Walla',
    'Heera Wala',
    'हीरावाला',
    'હીરાવાળા',
    'હીરાવાલા'
  ],
  url: siteOrigin,
  logo: logoImage
};
const websiteSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  name: 'Heerawalla',
  url: siteOrigin,
  publisher: {
    '@type': 'Organization',
    name: 'Heerawalla',
    logo: logoImage
  }
};
const breadcrumbJson = JSON.stringify(breadcrumbSchema);
const organizationJson = JSON.stringify(organizationSchema);
const websiteJson = JSON.stringify(websiteSchema);
void breadcrumbJson;
void organizationJson;
void websiteJson;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <meta name="description" content={description} />
    {keywords ? <meta name="keywords" content={keywords} /> : null}
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={url} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />
    <meta name="facebook-domain-verification" content="omtrqbw6qylnxiy3r1o3bptpeauo1w" />
    <meta http-equiv="Content-Security-Policy" content={csp} />
    <link rel="icon" type="image/svg+xml" href={logoImage} />
    <link rel="shortcut icon" href={logoImage} />
    <link rel="apple-touch-icon" href={logoImage} />
    <link rel="mask-icon" href={logoImage} color="#0B1928" />
    {gaMeasurementId ? (
      <>
        <meta name="ga-measurement-id" content={gaMeasurementId} />
        <script async is:inline src={`https://www.googletagmanager.com/gtag/js?id=${gaMeasurementId}`}></script>
        <script is:inline define:vars={{ gaMeasurementId }}>
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', gaMeasurementId, {
            send_page_view: true,
            cookie_flags: 'SameSite=None;Secure'
          });
        </script>
      </>
    ) : null}
    {metaPixelId ? (
      <>
        <script is:inline define:vars={{ metaPixelId }}>
          !function(f,b,e,v,n,t,s)
          {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
          n.callMethod.apply(n,arguments):n.queue.push(arguments)};
          if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
          n.queue=[];t=b.createElement(e);t.async=!0;
          t.src=v;s=b.getElementsByTagName(e)[0];
          s.parentNode.insertBefore(t,s)}(window, document,'script',
          'https://connect.facebook.net/en_US/fbevents.js');
          fbq('init', metaPixelId);
          fbq('track', 'PageView');
        </script>
        <noscript>
          <img
            height="1"
            width="1"
            style="display:none"
            src={`https://www.facebook.com/tr?id=${metaPixelId}&ev=PageView&noscript=1`}
            alt=""
          />
        </noscript>
      </>
    ) : null}
    <script type="application/ld+json" is:inline set:html={organizationJson} />
    <script type="application/ld+json" is:inline set:html={breadcrumbJson} />
    <script type="application/ld+json" is:inline set:html={websiteJson} />
  </head>
  <body class="min-h-screen bg-white text-ink">
    <div
      id="legacy-browser-banner"
      role="alert"
      style="display:none"
      class="w-full bg-ink text-white text-xs uppercase tracking-[0.2em] px-6 py-3 text-center"
    >
      Your browser is out of date. For the best experience, please update your browser.
      <a
        href="https://browser-update.org/update.html"
        class="underline underline-offset-2"
        target="_blank"
        rel="noreferrer"
      >Update browser</a>
    </div>
    <slot />

    <script is:inline>
      (function () {
        try {
          const params = new URLSearchParams(window.location.search);
          const marketingData = {
            utm_source: params.get('utm_source'),
            utm_medium: params.get('utm_medium'),
            utm_campaign: params.get('utm_campaign'),
            utm_content: params.get('utm_content'),
            utm_term: params.get('utm_term'),
            referrer: document.referrer || 'direct',
            landing_page: window.location.href,
            timestamp: new Date().toISOString()
          };

          if (!sessionStorage.getItem('heerawalla_marketing')) {
            sessionStorage.setItem('heerawalla_marketing', JSON.stringify(marketingData));
          }
        } catch (error) {
          console.error('Failed to initialize marketing attribution', error);
        }
      })();
    </script>

    <script is:inline>
      (function () {
        var ua = navigator.userAgent;
        var isOld = false;
        var chromeMatch = ua.match(/Chrome\/(\d+)/);
        if (chromeMatch && !/Edg\//.test(ua)) {
          isOld = parseInt(chromeMatch[1], 10) < 90;
        }
        var edgeMatch = ua.match(/Edg\/(\d+)/);
        if (edgeMatch) {
          isOld = parseInt(edgeMatch[1], 10) < 90;
        }
        var firefoxMatch = ua.match(/Firefox\/(\d+)/);
        if (firefoxMatch) {
          isOld = parseInt(firefoxMatch[1], 10) < 90;
        }
        var safariMatch = ua.match(/Version\/(\d+).+Safari/);
        if (safariMatch && !/Chrome|Chromium|Edg/.test(ua)) {
          isOld = parseInt(safariMatch[1], 10) < 14;
        }
        if (!isOld) return;
        var banner = document.getElementById('legacy-browser-banner');
        if (!banner) return;
        banner.style.display = 'block';
      })();
    </script>

    <script is:inline>
      (() => {
        const isProtected = (target) => {
          if (!(target instanceof Element)) return false;
          return Boolean(target.closest('img[data-protected-image]'));
        };
        const stopIfProtected = (event) => {
          if (isProtected(event.target)) {
            event.preventDefault();
          }
        };
        document.addEventListener('contextmenu', stopIfProtected);
        document.addEventListener('dragstart', stopIfProtected);
      })();
    </script>

  </body>
</html>
