---
import "../styles/global.css";
import { withBase } from '../lib/paths';

type Crumb = { label: string; href?: string };
const {
  title = 'Heerawalla | Fine jewelry crafted with precision',
  description = 'Luxury jewelry catalog with timeless, minimal design.',
  image,
  keywords,
  breadcrumbs
} = Astro.props as {
  title?: string;
  description?: string;
  image?: string;
  keywords?: string;
  breadcrumbs?: Crumb[];
};
const siteOrigin = Astro.site?.origin || 'https://heerawalla.com';
const ogImage = image && image.startsWith('http') ? image : new URL(withBase(image || '/images/hero.png'), siteOrigin).toString();
const logoImage = new URL(withBase('/images/engraving_mark.svg'), siteOrigin).toString();
const url = new URL(Astro.url.pathname, siteOrigin).toString();
const titleCase = (value: string) =>
  value
    .split(/[-_]/g)
    .map((word) => (word ? word[0].toUpperCase() + word.slice(1) : ''))
    .join(' ');
const buildCrumbs = () => {
  if (breadcrumbs?.length) return breadcrumbs;
  const segments = Astro.url.pathname.split('/').filter(Boolean);
  if (segments.length === 0) return [{ label: 'Home', href: withBase('/') }];
  const crumbs: Crumb[] = [{ label: 'Home', href: withBase('/') }];
  segments.forEach((seg, idx) => {
    const href = withBase(`/${segments.slice(0, idx + 1).join('/')}`);
    crumbs.push({ label: titleCase(seg), href });
  });
  return crumbs;
};
const crumbItems = buildCrumbs();
const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: crumbItems.map((crumb, index) => ({
    '@type': 'ListItem',
    position: index + 1,
    name: crumb.label,
    item: new URL(crumb.href || Astro.url.pathname, siteOrigin).toString()
  }))
};
const organizationSchema = {
  '@context': 'https://schema.org',
  '@type': 'Organization',
  name: 'Heerawalla',
  alternateName: [
    'Heerawala',
    'Hirawala',
    'Hirawalla',
    'Herowalla',
    'Herowala',
    'Hero Wala',
    'Hero Walla',
    'Heera Walla',
    'Heera Wala',
    'हीरावाला',
    'હીરાવાળા',
    'હીરાવાલા'
  ],
  url: siteOrigin,
  logo: logoImage
};
const websiteSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  name: 'Heerawalla',
  url: siteOrigin,
  publisher: {
    '@type': 'Organization',
    name: 'Heerawalla',
    logo: logoImage
  }
};
const breadcrumbJson = JSON.stringify(breadcrumbSchema);
const organizationJson = JSON.stringify(organizationSchema);
const websiteJson = JSON.stringify(websiteSchema);
void breadcrumbJson;
void organizationJson;
void websiteJson;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <meta name="description" content={description} />
    {keywords ? <meta name="keywords" content={keywords} /> : null}
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={url} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />
    <link rel="icon" type="image/svg+xml" href={withBase('/images/engraving_mark.svg')} />
    <link rel="shortcut icon" href={withBase('/images/engraving_mark.svg')} />
    <link rel="apple-touch-icon" href={withBase('/images/engraving_mark.svg')} />
    <link rel="mask-icon" href={withBase('/images/engraving_mark.svg')} color="#0B1928" />
    <script type="application/ld+json" is:inline>
      {organizationJson}
    </script>
    <script type="application/ld+json" is:inline>
      {breadcrumbJson}
    </script>
    <script type="application/ld+json" is:inline>
      {websiteJson}
    </script>
  </head>
  <body class="min-h-screen bg-white text-ink">
    <slot />

    <script is:inline>
      (() => {
        const isProtected = (target) => {
          if (!(target instanceof Element)) return false;
          return Boolean(target.closest('img[data-protected-image]'));
        };
        const stopIfProtected = (event) => {
          if (isProtected(event.target)) {
            event.preventDefault();
          }
        };
        document.addEventListener('contextmenu', stopIfProtected);
        document.addEventListener('dragstart', stopIfProtected);
      })();
    </script>

    <script is:inline>
      (() => {
        const pickers = Array.from(document.querySelectorAll('[data-mail-picker]'));
        if (pickers.length === 0) return;
        const isMobile = /Mobi|Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);
        const gmailDefault = 'https://mail.google.com/mail/?view=cm&fs=1&to=';
        const outlookDefault = 'https://outlook.office.com/mail/deeplink/compose?to=';

        const closeAll = () => {
          pickers.forEach((picker) => {
            picker.setAttribute('data-open', 'false');
            const menu = picker.querySelector('[data-mail-menu]');
            const trigger = picker.querySelector('[data-mail-trigger]');
            if (menu) menu.classList.add('hidden');
            if (trigger) trigger.setAttribute('aria-expanded', 'false');
          });
        };

        const formatCst = (value) => {
          const date = new Date(value);
          if (Number.isNaN(date.getTime())) return value;
          const parts = new Intl.DateTimeFormat('en-US', {
            timeZone: 'America/Chicago',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
          }).formatToParts(date);
          const get = (type) => parts.find((p) => p.type === type)?.value;
          return `${get('year')}-${get('month')}-${get('day')} ${get('hour')}:${get('minute')} CST`;
        };

        const buildMailData = (picker) => {
          const email = picker.getAttribute('data-email') || '';
          const baseSubject = picker.getAttribute('data-subject') || '';
          const baseBody = picker.getAttribute('data-body') || '';
          let subject = baseSubject;
          let body = baseBody;
          if (picker.getAttribute('data-mail-source') === 'form') {
            const form = picker.closest('form');
            if (form) {
              const data = new FormData(form);
              const name = String(data.get('name') || '').trim();
              const replyTo = String(data.get('email') || '').trim();
              const message = String(data.get('message') || '').trim();
              const consultation = String(data.get('consultation') || '').trim();
              const lines = [];
              if (name) lines.push(`Name: ${name}`);
              if (replyTo) lines.push(`Email: ${replyTo}`);
              if (consultation) lines.push(`Consultation: ${formatCst(consultation)}`);
              if (message) lines.push('', message);
              if (baseBody) lines.push('', baseBody);
              body = lines.length ? lines.join('\n') : baseBody;
              subject = baseSubject || (name ? `Inquiry from ${name}` : 'Heerawalla inquiry');
            }
          }
          return { email, subject, body };
        };

        const buildHref = (provider, email, subject, body, picker) => {
          if (provider === 'mailto') {
            return `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
          }
          if (provider === 'outlook') {
            const base = picker.getAttribute('data-outlook-base') || outlookDefault;
            return `${base}${encodeURIComponent(email)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
          }
          const base = picker.getAttribute('data-gmail-base') || gmailDefault;
          return `${base}${encodeURIComponent(email)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        };

        pickers.forEach((picker) => {
          const trigger = picker.querySelector('[data-mail-trigger]');
          const menu = picker.querySelector('[data-mail-menu]');
          if (!trigger || !menu) return;
          const isFormSource = picker.getAttribute('data-mail-source') === 'form';
          const form = isFormSource ? picker.closest('form') : null;

          trigger.setAttribute('aria-haspopup', 'menu');
          trigger.setAttribute('aria-expanded', 'false');

          if (isMobile) {
            menu.classList.add('hidden');
            trigger.addEventListener('click', (event) => {
              event.preventDefault();
              if (isFormSource && form && !form.checkValidity()) {
                form.reportValidity();
                return;
              }
              const { email, subject, body } = buildMailData(picker);
              const href = buildHref('mailto', email, subject, body, picker);
              window.location.href = href;
            });
            return;
          }

          trigger.addEventListener('click', (event) => {
            event.preventDefault();
            if (isFormSource && form && !form.checkValidity()) {
              form.reportValidity();
              return;
            }
            const isOpen = picker.getAttribute('data-open') === 'true';
            closeAll();
            if (!isOpen) {
              picker.setAttribute('data-open', 'true');
              menu.classList.remove('hidden');
              trigger.setAttribute('aria-expanded', 'true');
            }
          });

          menu.querySelectorAll('[data-mail-provider]').forEach((option) => {
            option.addEventListener('click', () => {
              if (isFormSource && form && !form.checkValidity()) {
                form.reportValidity();
                return;
              }
              const provider = option.getAttribute('data-mail-provider') || 'gmail';
              const { email, subject, body } = buildMailData(picker);
              const href = buildHref(provider, email, subject, body, picker);
              if (provider === 'mailto') {
                window.location.href = href;
              } else {
                window.open(href, '_blank', 'noopener');
              }
              closeAll();
            });
          });
        });

        document.addEventListener('click', (event) => {
          if (event.target.closest('[data-mail-picker]')) return;
          closeAll();
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape') {
            closeAll();
          }
        });
      })();
    </script>
  </body>
</html>
