---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { loadSiteConfig, getConfigValue } from '../lib/config';

const config = await loadSiteConfig();
const contactEmail = getConfigValue(config, 'contact_email', 'support@heerawalla.com');
const webmailComposeBase = getConfigValue(config, 'webmail_compose_url', 'https://mail.google.com/mail/?view=cm&fs=1&to=');
const consultationBookingLink = getConfigValue(
  config,
  'consultation_booking_link',
  'https://calendar.app.google/sJE4L6jMtc98ASF76'
);
const mailtoHref = `mailto:${contactEmail}`;
---

<BaseLayout title="Contact | Heerawalla" description="Reach Heerawalla client care for bespoke projects or purchase inquiries.">
  <Header />
  <main class="container py-12 space-y-8">
    <div class="space-y-2">
      <p class="text-xs uppercase tracking-[0.18em] text-slate-500">Contact</p>
      <h1 class="text-3xl font-semibold tracking-tight">We're here to help</h1>
      <p
        class="text-sm text-slate-500 max-w-2xl"
        data-contact-intro
        data-default-text="Send us a note about a piece you love or a bespoke request. We respond within one business day."
        data-consult-text="Send us a note about a piece you love, a bespoke request, or a service appointment. We respond within one business day."
      >
        Send us a note about a piece you love or a bespoke request. We respond within one business day.
      </p>
    </div>

    <form
      class="card p-6 space-y-4"
      action={mailtoHref}
      method="post"
      enctype="text/plain"
      data-contact-form
    >
      <div class="grid gap-4 md:grid-cols-2">
        <label class="text-sm space-y-1">
          <span class="text-slate-600">Name</span>
          <input required name="name" class="w-full rounded-lg border border-slate-200 px-3 py-2" />
        </label>
        <label class="text-sm space-y-1">
          <span class="text-slate-600">Email</span>
          <input required type="email" name="email" class="w-full rounded-lg border border-slate-200 px-3 py-2" />
        </label>
      </div>
      <label class="text-sm space-y-1">
        <span class="text-slate-600">Message</span>
        <textarea required name="message" rows="5" class="w-full rounded-lg border border-slate-200 px-3 py-2"></textarea>
      </label>
      <div class="border border-slate-200 p-2" data-consultation-block data-booking-link={consultationBookingLink}>
        <iframe
          src={consultationBookingLink}
          title="Heerawalla consultation booking"
          width="100%"
          height="640"
          frameborder="0"
          style="border:0"
          loading="lazy"
        ></iframe>
      </div>
      <input type="hidden" name="consultation" data-consultation-hidden />
      <div class="flex gap-3">
        <div
          class="relative"
          data-mail-picker
          data-email={contactEmail}
          data-gmail-base={webmailComposeBase}
          data-mail-source="form"
          data-consultation-cta
        >
          <button type="submit" class="btn btn-primary" data-mail-trigger>
            Request consultation
          </button>
          <div
            class="absolute left-0 top-full z-20 mt-2 w-48 border border-slate-200 bg-white shadow-md hidden"
            data-mail-menu
            role="menu"
          >
            <button type="button" class="w-full px-3 py-2 text-left text-xs uppercase tracking-[0.2em] text-slate-600 hover:text-ink" data-mail-provider="gmail" role="menuitem">Gmail</button>
            <button type="button" class="w-full px-3 py-2 text-left text-xs uppercase tracking-[0.2em] text-slate-600 hover:text-ink" data-mail-provider="outlook" role="menuitem">Outlook</button>
            <button type="button" class="w-full px-3 py-2 text-left text-xs uppercase tracking-[0.2em] text-slate-600 hover:text-ink" data-mail-provider="mailto" role="menuitem">Mail app</button>
          </div>
        </div>
        <div
          class="relative"
          data-mail-picker
          data-email={contactEmail}
          data-gmail-base={webmailComposeBase}
          data-subject="Heerawalla inquiry"
          data-body=""
        >
          <a class="btn btn-ghost" href={mailtoHref} data-mail-trigger>Email directly</a>
          <div
            class="absolute left-0 top-full z-20 mt-2 w-48 border border-slate-200 bg-white shadow-md hidden"
            data-mail-menu
            role="menu"
          >
            <button type="button" class="w-full px-3 py-2 text-left text-xs uppercase tracking-[0.2em] text-slate-600 hover:text-ink" data-mail-provider="gmail" role="menuitem">Gmail</button>
            <button type="button" class="w-full px-3 py-2 text-left text-xs uppercase tracking-[0.2em] text-slate-600 hover:text-ink" data-mail-provider="outlook" role="menuitem">Outlook</button>
            <button type="button" class="w-full px-3 py-2 text-left text-xs uppercase tracking-[0.2em] text-slate-600 hover:text-ink" data-mail-provider="mailto" role="menuitem">Mail app</button>
          </div>
        </div>
      </div>
      <p class="text-sm text-slate-500" data-contact-response-note>
        Prefer a complimentary email request? We reply to all messages within 24 to 48 hours.
      </p>
    </form>
  </main>
  <Footer />

  <script is:inline>
    (() => {
      const block = document.querySelector('[data-consultation-block]');
      const hidden = document.querySelector('[data-consultation-hidden]');
      if (!block || !hidden) return;
      const params = new URLSearchParams(window.location.search);
      const isConsult = params.get('intent') === 'consultation';
      const consultCta = document.querySelector('[data-consultation-cta]');
      const responseNote = document.querySelector('[data-contact-response-note]');
      const intro = document.querySelector('[data-contact-intro]');
      const bookingLink = block.getAttribute('data-booking-link') || '';
      if (!isConsult) {
        block.classList.add('hidden');
        hidden.value = '';
        if (consultCta) consultCta.classList.add('hidden');
        if (responseNote) responseNote.classList.remove('hidden');
        if (intro) {
          const text = intro.getAttribute('data-default-text');
          if (text) intro.textContent = text;
        }
        return;
      }
      block.classList.remove('hidden');
      hidden.value = bookingLink ? `Booking link: ${bookingLink}` : '';
      if (consultCta) consultCta.classList.remove('hidden');
      if (responseNote) responseNote.classList.add('hidden');
      if (intro) {
        const text = intro.getAttribute('data-consult-text');
        if (text) intro.textContent = text;
      }
    })();
  </script>
</BaseLayout>
