---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ProductCard from '../components/ProductCard.astro';
import { loadProductsWithMedia } from '../lib/products';
import { withBase } from '../lib/paths';
import { MEDIA_PLACEHOLDER_URL } from '../lib/placeholders';

const editionLabel = "Men's Jewelry";
const editionKey = 'men';
const editionGender = 'male';
const products = (await loadProductsWithMedia()).filter((product) => {
  const gender = (product.gender || '').toLowerCase();
  if (!gender) return false;
  return gender === editionGender || gender === 'unisex';
});
const heroImageById = Object.fromEntries(
  products
    .map((product) => [product.id, product.media.images[0]?.url])
    .filter((entry) => Boolean(entry[1]))
);
const placeholderImage = MEDIA_PLACEHOLDER_URL;
const seo = {
  primary: "men's jewelry",
  secondary: [
    "luxury men's jewelry",
    "men's gold jewelry",
    "men's diamond jewelry",
    "fine jewelry for men"
  ]
};
const catalogUrl = import.meta.env.PUBLIC_CATALOG_API_URL || '';
const catalogMode = (import.meta.env.PUBLIC_CATALOG_MODE || 'hybrid').toLowerCase();
const pricingApiBase = (() => {
  const preferred = import.meta.env.PUBLIC_PRICING_API_URL || import.meta.env.PUBLIC_CATALOG_API_URL || '';
  if (preferred && preferred.includes('://')) {
    try {
      return new URL(preferred).origin;
    } catch {
      return 'https://admin-api.heerawalla.com';
    }
  }
  return 'https://admin-api.heerawalla.com';
})();
const basePath = import.meta.env.BASE_URL || '/';
const metaTitle = `Heerawalla ${editionLabel} \u2014 Editions`;
const metaDescription =
  'Heerawalla men\u2019s jewelry balances strength and restraint, with architectural proportions and refined gold and diamond detail.';
const keywords = [seo.primary, ...seo.secondary].join(', ');
const breadcrumbs = [
  { label: 'Home', href: withBase('/') },
  { label: editionLabel }
];
---

<BaseLayout title={metaTitle} description={metaDescription} keywords={keywords} breadcrumbs={breadcrumbs}>
  <Header />

  <main class="max-w-7xl mx-auto px-6 py-12 space-y-12">
    <section class="space-y-4">
      <p class="text-xs uppercase tracking-[0.18em] text-slate-500">Edition</p>
      <h1 class="text-4xl font-semibold tracking-tight">{editionLabel}</h1>
      <p class="text-sm text-slate-600 max-w-2xl" data-design-description>
        Considered forms for measured confidence, anchored in precise geometry and enduring materials.
      </p>
      <div
        class="flex flex-wrap items-center gap-3 text-xs uppercase tracking-[0.2em] text-slate-500"
        data-design-filter
      >
        <span class="text-slate-400">Design Codes</span>
        <button
          type="button"
          class="min-h-[34px] px-3 py-1.5 border border-ink/15 rounded-none text-[10px] tracking-[0.2em] text-slate-500 data-[active=true]:border-[#b08c5a] data-[active=true]:text-ink data-[active=true]:bg-slate-50"
          data-code=""
          data-active="true"
          aria-pressed="true"
        >
          All
        </button>
        <button
          type="button"
          class="min-h-[34px] px-3 py-1.5 border border-ink/15 rounded-none text-[10px] tracking-[0.2em] text-slate-500 data-[active=true]:border-[#b08c5a] data-[active=true]:text-ink data-[active=true]:bg-slate-50"
          data-code="axis"
          data-design-desc="Axis is precise and grounded—architectural lines, measured weight, and quiet authority."
          data-active="false"
          aria-pressed="false"
        >
          Axis
        </button>
        <button
          type="button"
          class="min-h-[34px] px-3 py-1.5 border border-ink/15 rounded-none text-[10px] tracking-[0.2em] text-slate-500 data-[active=true]:border-[#b08c5a] data-[active=true]:text-ink data-[active=true]:bg-slate-50"
          data-code="continuum"
          data-design-desc="Continuum favors fluid motion—continuous curves, soft transitions, and calm refinement."
          data-active="false"
          aria-pressed="false"
        >
          Continuum
        </button>
        <button
          type="button"
          class="min-h-[34px] px-3 py-1.5 border border-ink/15 rounded-none text-[10px] tracking-[0.2em] text-slate-500 data-[active=true]:border-[#b08c5a] data-[active=true]:text-ink data-[active=true]:bg-slate-50"
          data-code="eclipse"
          data-design-desc="Eclipse is bold and magnetic—strong contrast, sculptural presence, and controlled intensity."
          data-active="false"
          aria-pressed="false"
        >
          Eclipse
        </button>
      </div>
    </section>

    <section class="border-t border-slate-200 pt-8">
      <div
        class={`grid gap-6 sm:grid-cols-2 lg:grid-cols-3${products.length ? '' : ' hidden'}`}
        data-product-grid
      >
        {products.map((product) => (
          <div data-product-card data-design-code={(product.design_code || '').toLowerCase()}>
            <ProductCard product={product} />
          </div>
        ))}
      </div>
      <p class={`text-sm text-slate-500${products.length ? ' hidden' : ''}`} data-product-empty>
        Selections are curated seasonally. The concierge can share availability.
      </p>
    </section>
  </main>

  <Footer />
</BaseLayout>

<script is:inline define:vars={{ catalogUrl, catalogMode, pricingApiBase, basePath, editionGender, heroImageById, placeholderImage }}>
  (() => {
    let catalogUrlValue = String(catalogUrl || '');
    const catalogModeValue = String(catalogMode || '').toLowerCase();
    const pricingApiBaseValue = String(pricingApiBase || '');
    if (!catalogUrlValue) {
      const host = window.location.hostname;
      if (host === 'localhost' || host === '127.0.0.1') {
        catalogUrlValue = 'http://localhost:8787/catalog';
      }
    }
    const basePathValue = String(basePath || '/');
    const editionGenderValue = String(editionGender || '');
    const heroImageByIdValue = heroImageById || {};
    const placeholderImageValue = String(placeholderImage || '');
    const grid = document.querySelector('[data-product-grid]');
    const empty = document.querySelector('[data-product-empty]');
    const container = document.querySelector('[data-design-filter]');
    if (!container) return;
    const buttons = Array.from(container.querySelectorAll('[data-code]'));
    const desc = document.querySelector('[data-design-description]');
    const defaultDesc = desc ? (desc.textContent || '').trim() : '';
    if (!buttons.length) return;

    const withBase = (path) => {
      const base = basePathValue || '/';
      const normalizedBase = base.endsWith('/') ? base : `${base}/`;
      const cleaned = path.replace(/^\/+/, '');
      return `${normalizedBase}${cleaned}`;
    };

    const resolvePricingBase = () => {
      let base = pricingApiBaseValue || '';
      if (!base) base = 'https://admin-api.heerawalla.com';
      const host = window.location.hostname;
      if ((host === 'localhost' || host === '127.0.0.1') && base.includes('admin-api.heerawalla.com')) {
        base = 'http://localhost:8787';
      }
      return base.replace(/\/$/, '');
    };

    const escapeHtml = (value) =>
      String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\"/g, '&quot;')
        .replace(/'/g, '&#39;');

    const parseList = (value) => {
      if (value === undefined || value === null) return [];
      if (Array.isArray(value)) {
        return value.map((item) => String(item).trim()).filter(Boolean);
      }
      const trimmed = String(value).trim();
      if (!trimmed) return [];
      if (trimmed.startsWith('[')) {
        try {
          const parsed = JSON.parse(trimmed);
          if (Array.isArray(parsed)) {
            return parsed.map((item) => String(item).trim()).filter(Boolean);
          }
        } catch {
          // fall back to delimiter parsing
        }
      }
      return trimmed
        .split('|')
        .map((item) => item.trim())
        .filter(Boolean);
    };

    const parseNumber = (value) => {
      if (value === undefined || value === null) return undefined;
      if (typeof value === 'number') return Number.isFinite(value) ? value : undefined;
      const trimmed = String(value).trim();
      if (!trimmed) return undefined;
      const parsed = Number(trimmed);
      return Number.isFinite(parsed) ? parsed : undefined;
    };

    const normalizeStoneType = (value) =>
      String(value || '')
        .replace(/diamond\\(s\\)/gi, 'Diamond')
        .replace(/diamonds?\\b/gi, 'Diamond')
        .replace(/\\s+/g, ' ')
        .trim();

    const buildStoneWeightFromOptions = (options) => {
      if (!Array.isArray(options) || !options.length) return { total: '', breakdown: '' };
      const groups = new Map();
      options.forEach((option) => {
        const sizeType = String(option.size_type || '').trim().toLowerCase() || 'size';
        const carat = Number(option.carat);
        const count = Number(option.count);
        if (!Number.isFinite(carat) || !Number.isFinite(count) || carat <= 0 || count <= 0) return;
        const entry = { carat, count };
        const existing = groups.get(sizeType) || { entries: [], isPrimary: false };
        existing.entries.push(entry);
        if (option.is_primary) existing.isPrimary = true;
        groups.set(sizeType, existing);
      });
      if (!groups.size) return { total: '', breakdown: '' };
      const ordered = Array.from(groups.entries());
      const primaryGroup = ordered.find(([, group]) => group.isPrimary) || ordered[0];
      const entries = primaryGroup ? primaryGroup[1].entries : [];
      const breakdown = entries.map((entry) => `${entry.carat} x ${entry.count}`).join(', ');
      const total = entries.reduce((sum, entry) => sum + entry.carat * entry.count, 0);
      return {
        total: total > 0 ? total.toFixed(2) : '',
        breakdown,
      };
    };

    const buildMetalWeightFromOptions = (options) => {
      if (!Array.isArray(options) || !options.length) return '';
      const primary = options.find((option) => option.is_primary) || options[0];
      const raw = primary ? String(primary.metal_weight || '').trim() : '';
      return raw;
    };

    const buildPricingPayload = (product) => {
      const stoneTypes = parseList(product.stone_types).map(normalizeStoneType).filter(Boolean);
      const lab = stoneTypes.find((item) => /lab/i.test(item));
      const natural = stoneTypes.find((item) => /natural/i.test(item));
      const stone = lab || natural || stoneTypes[0] || '';

      const metalOptions = parseList(product.metal_options || product.metals || product.metal);
      const metal = metalOptions[0] || product.metal || '18K Gold';

      const stoneOptionData = buildStoneWeightFromOptions(product.stone_options);
      const stoneWeight = stoneOptionData.total || String(product.stone_weight || product.carat || '');
      const diamondBreakdown = stoneOptionData.breakdown || '';

      const metalWeight =
        buildMetalWeightFromOptions(product.metal_weight_options) ||
        String(product.metal_weight || '').trim();

      const clarityOptions = parseList(product.clarity);
      const colorOptions = parseList(product.color);
      const cutOptions = parseList(product.cut);
      const clarity = clarityOptions.length ? clarityOptions[clarityOptions.length - 1] : '';
      const color = colorOptions.length ? colorOptions[colorOptions.length - 1] : '';
      const cut = cutOptions.length ? cutOptions[cutOptions.length - 1] : '';

      const tags = parseList(product.tags).map((tag) => tag.toLowerCase());
      const hasChainTag = tags.some((tag) => ['necklace', 'necklaces', 'pendant', 'pendants', 'chain', 'chains'].includes(tag));
      const sizeLabel = hasChainTag ? 'Chain length' : '';
      const size = hasChainTag ? '16\"' : '';

      return {
        metal,
        metal_weight: metalWeight,
        stone,
        stone_weight: stoneWeight,
        diamond_breakdown: diamondBreakdown,
        clarity,
        color,
        cut,
        size,
        size_label: sizeLabel,
      };
    };


    const formatCarat = (value) => {
      if (!value || Number.isNaN(value)) return '';
      if (Number.isInteger(value)) return value.toString();
      return value.toString();
    };

    const formatWeight = (value) => {
      if (!value || Number.isNaN(value)) return '';
      if (Number.isInteger(value)) return value.toString();
      return value.toString();
    };

    const normalizeMetalLabel = (value) => {
      if (!value) return '18K Gold';
      return String(value).replace(/\\s+/g, ' ').trim();
    };

    const clarityToMarketing = (value) => {
      if (!value) return '';
      const normalized = String(value).toLowerCase();
      if (normalized.includes('vvs1') && normalized.includes('vvs2')) {
        return 'excellent clarity (VVS1 or VVS2)';
      }
      if (normalized.includes('vvs')) {
        return 'excellent clarity (VVS)';
      }
      return String(value);
    };

    const cutToMarketing = (value) => {
      if (!value) return '';
      return `excellent cut${value ? ` (${value})` : ''}`;
    };

    const colorToMarketing = (value) => {
      if (!value) return '';
      return `color grade ${String(value).replace('/', ' or ')}`;
    };

    const slugify = (value) =>
      String(value || '')
        .split('/')
        .map((part) =>
          part.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '') || 'uncategorized'
        )
        .filter(Boolean)
        .join('/');

    const buildImageFallbacks = (product) => {
      const override = product.hero_image || heroImageByIdValue[product.id];
      if (override) {
        const overrideUrl =
          override.startsWith('http') || override.startsWith('/')
            ? override
            : override;
        return [overrideUrl, placeholderImageValue];
      }
      return [placeholderImageValue];
    };

    const buildEstimateTooltip = (product) => {
      const sections = [];
      const ariaParts = [];
      const diamondQualityText = 'IGI-certified.';
      sections.push({ label: 'Diamond Quality', text: diamondQualityText });
      ariaParts.push(`Diamond Quality. ${diamondQualityText}`);

      if (!sections.length) return null;
      return { sections, ariaLabel: ariaParts.join(' ') };
    };

    const buildProductCard = (product) => {
      const stoneTypes = parseList(product.stone_types).map(normalizeStoneType).filter(Boolean);
      const priceLabel = 'Pricing on request';

      const editionLabel = (() => {
        const gender = String(product.gender || '').toLowerCase();
        if (gender === 'women') return "Women's Edition";
        if (gender === 'men') return "Men's Edition";
        if (gender === 'unisex') return 'Unisex Edition';
        const category = product.category || '';
        const group = category.split('/')[0] || '';
        if (group === 'women') return "Women's Edition";
        if (group === 'men') return "Men's Edition";
        if (group === 'unisex') return 'Unisex Edition';
        return product.design_code || product.category || '';
      })();

      const tooltip = buildEstimateTooltip(product);
      const tooltipHtml = tooltip
        ? `<button type="button" class="estimate-info" aria-label="${escapeHtml(
            tooltip.ariaLabel
          )}">i<span class="estimate-tooltip" role="tooltip">${tooltip.sections
            .map(
              (section) =>
                `<span class="estimate-tooltip__section"><span class="estimate-tooltip__label">${escapeHtml(
                  section.label
                )}</span>${
                  section.text
                    ? `<span class="estimate-tooltip__text">${escapeHtml(section.text)}</span>`
                    : ''
                }${
                  section.items && section.items.length
                    ? `<span class="estimate-tooltip__list">${section.items
                        .map(
                          (item) =>
                            `<span class="estimate-tooltip__item">${escapeHtml(item)}</span>`
                        )
                        .join('')}</span>`
                    : ''
                }</span>`
            )
            .join('')}</span></button>`
        : '';

      const imageFallbacks = buildImageFallbacks(product);
      const imageSrc = imageFallbacks[0];
      const link = withBase(`/product/${product.slug}`);
      const designCode = String(product.design_code || '').toLowerCase();

      return `
        <div data-product-card data-design-code="${escapeHtml(designCode)}">
          <article class="card overflow-hidden group h-full flex flex-col" data-thumb-layout="column" data-thumb-layout-locked="true">
            <div class="thumb-media flex items-stretch gap-2 sm:gap-3 bg-white" data-thumb-media>
              <a href="${escapeHtml(link)}" class="thumb-main flex-1 flex items-stretch justify-end overflow-hidden" data-thumb-main>
                <div class="aspect-[3/4] w-full bg-white">
                  <img
                    src="${escapeHtml(imageSrc)}"
                    alt="${escapeHtml(product.name || '')}"
                    loading="lazy"
                    decoding="async"
                    fetchpriority="low"
                    sizes="(min-width: 1024px) 33vw, (min-width: 640px) 50vw, 100vw"
                    class="h-full w-full object-contain object-center transition duration-300 group-hover:scale-[1.02]"
                    data-main-image
                    data-default-src="${escapeHtml(imageSrc)}"
                    data-fallback-index="0"
                    data-image-fallbacks="${escapeHtml(imageFallbacks.join('|'))}"
                    data-protected-image
                  />
                </div>
              </a>
            </div>
            <div class="flex flex-col gap-2 p-4 flex-1">
              <div class="text-xs uppercase tracking-[0.12em] text-slate-500">${escapeHtml(
                editionLabel
              )}</div>
              <div class="flex items-start justify-between gap-3">
                <a href="${escapeHtml(link)}" class="text-lg font-semibold leading-snug hover:text-accent">
                  ${escapeHtml(product.name || '')}
                </a>
                <span class="flex items-center gap-2">
                <span
                  class="text-xs uppercase tracking-[0.18em] text-slate-500 whitespace-nowrap"
                  data-price
                  data-product-id="${escapeHtml(product.id || '')}"
                  data-product-slug="${escapeHtml(product.slug || '')}"
                >
                  ${escapeHtml(priceLabel)}
                </span>
                  ${tooltipHtml}
                </span>
              </div>
              <p class="text-sm text-slate-500 line-clamp-2">${escapeHtml(
                product.description || ''
              )}</p>
              <div class="mt-auto pt-2"></div>
            </div>
          </article>
        </div>
      `;
    };

    const applyImageFallbacks = (scope) => {
      const images = Array.from(scope.querySelectorAll('[data-image-fallbacks]'));
      images.forEach((img) => {
        img.addEventListener('error', () => {
          const list = (img.getAttribute('data-image-fallbacks') || '').split('|').filter(Boolean);
          const index = Number(img.getAttribute('data-fallback-index') || '0');
          const next = index + 1;
          if (!list.length || next >= list.length) return;
          img.setAttribute('data-fallback-index', String(next));
          img.setAttribute('src', list[next]);
        });
      });
    };

    const setActive = (code) => {
      buttons.forEach((button) => {
        const isActive = (button.dataset.code || '') === code;
        button.setAttribute('data-active', String(isActive));
        button.setAttribute('aria-pressed', String(isActive));
      });
    };

    const apply = (code) => {
      const target = (code || '').toLowerCase();
      const cards = Array.from(document.querySelectorAll('[data-product-card]'));
      cards.forEach((card) => {
        const cardCode = (card.dataset.designCode || '').toLowerCase();
        const visible = !target || cardCode === target;
        card.classList.toggle('hidden', !visible);
        card.toggleAttribute('data-hidden', !visible);
      });
      if (desc) {
        const active = buttons.find((button) => (button.dataset.code || '') === target);
        const nextDesc = active ? active.dataset.designDesc || '' : '';
        desc.textContent = nextDesc || defaultDesc;
      }
    };

    const params = new URLSearchParams(window.location.search);
    const initial =
      params.get('design_code') ||
      params.get('design-code') ||
      params.get('designCode') ||
      '';
    const normalized = initial.toLowerCase();
    let initialCode = '';
    let activeCode = '';
    initialCode = buttons.some((button) => (button.dataset.code || '') === normalized)
      ? normalized
      : '';
    activeCode = initialCode;

    setActive(activeCode);
    apply(activeCode);

    buttons.forEach((button) => {
      button.addEventListener('click', () => {
        const code = button.dataset.code || '';
        activeCode = code;
        setActive(code);
        apply(code);
      });
    });

    window.__hwApplyDesignFilter = () => apply(activeCode);

    const updatePrices = async (items) => {
      const base = resolvePricingBase();
      if (!base || !Array.isArray(items) || !items.length) return;
      const priceNodes = Array.from(document.querySelectorAll('[data-price]'));
      const bySlug = new Map(priceNodes.map((node) => [node.getAttribute('data-product-slug') || '', node]));
      const byId = new Map(priceNodes.map((node) => [node.getAttribute('data-product-id') || '', node]));
      await Promise.all(
        items.map(async (product) => {
          const slug = String(product.slug || '');
          const id = String(product.id || '');
          const target = bySlug.get(slug) || byId.get(id);
          if (!target) return;
          const payload = buildPricingPayload(product);
          if (!payload.metal_weight) return;
          target.textContent = 'Calculating...';
          try {
            const response = await fetch(`${base}/pricing/estimate`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (!response.ok) return;
            const data = await response.json();
            if (data && data.ok && typeof data.price === 'number') {
              const formatted = data.price.toLocaleString('en-US', {
                style: 'currency',
                currency: 'USD',
                maximumFractionDigits: 0
              });
              target.textContent = `Starting at ${formatted}`;
            }
          } catch {
            // Ignore pricing errors.
          }
        })
      );
    };

    const renderProducts = (items) => {
      if (!grid) return;
      grid.innerHTML = items.map(buildProductCard).join('');
      applyImageFallbacks(grid);
      grid.classList.toggle('hidden', items.length === 0);
      if (empty) {
        empty.classList.toggle('hidden', items.length !== 0);
      }
      apply(activeCode);
      updatePrices(items);
    };

    const fetchCatalog = async () => {
      if (!catalogUrlValue) return;
      const joiner = catalogUrlValue.includes('?') ? '&' : '?';
      const cacheBust = /localhost|127\\.0\\.0\\.1/i.test(catalogUrlValue)
        ? `&bust=${Date.now()}`
        : '';
      const url = `${catalogUrlValue}${joiner}include=products${cacheBust}`;
      try {
        const response = await fetch(url, { cache: 'no-store' });
        if (!response.ok) return;
        const data = await response.json();
        if (!data || !Array.isArray(data.products)) return;
        const items = data.products.filter((product) => {
          const gender = String(product.gender || '').toLowerCase();
          if (!gender) return false;
          return gender === editionGenderValue || gender === 'unisex';
        });
        if (catalogModeValue === 'ssr') {
          updatePrices(items);
        } else {
          renderProducts(items);
        }
      } catch {
        // Ignore catalog errors; fall back to static content.
      }
    };

    fetchCatalog();
  })();
</script>
