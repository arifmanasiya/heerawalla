---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Header from '../../../components/Header.astro';
import Footer from '../../../components/Footer.astro';
import { loadInspirations, INSPIRATION_DISCLAIMER, type Inspiration } from '../../../lib/inspirations';
import { withBase } from '../../../lib/paths';

export async function getStaticPaths() {
  const inspirations = await loadInspirations();
  return inspirations.map((item) => ({
    params: { slug: item.slug },
    props: { item }
  }));
}

const { item } = Astro.props as { item: Inspiration };
const metaTitle = `Request Quote | ${item.title} | Heerawalla`;
const metaDescription = `Request a bespoke quote inspired by ${item.title}. Email-only atelier process.`;
const inquiriesEmail = 'inquiries@heerawalla.com';
const defaultCategory = item.categories[0] || 'ring';
const inspirationsUrl = withBase('/inspirations');
const homeUrl = withBase('/');
const normalizeMetal = (value?: string) => {
  if (!value) return undefined;
  const label = value.toLowerCase();
  if (label.includes('platinum')) return 'Platinum';
  if (label.includes('white')) return '18K White Gold';
  if (label.includes('rose')) return '18K Rose Gold';
  if (label.includes('yellow')) return '18K Yellow Gold';
  if (label.includes('18k')) return value;
  return undefined;
};
const defaultMetalPreference =
  normalizeMetal(item.palette.find((entry) => entry.type === 'metal')?.label) ||
  normalizeMetal(item.metals[0]) ||
  '18K Yellow Gold';
const defaultStoneType = (() => {
  const label = item.palette.find((entry) => entry.type === 'stone')?.label?.toLowerCase() || '';
  if (label.includes('lab')) return 'Lab diamond';
  if (label.includes('natural')) return 'Natural diamond';
  if (label.includes('diamond')) return 'Lab diamond';
  return 'Gemstones';
})();
---

<BaseLayout title={metaTitle} description={metaDescription}>
  <Header />

  <main class="max-w-7xl mx-auto px-6 py-12 space-y-10">
    <div class="space-y-3">
      <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Inspirations</p>
      <h1 class="font-display text-4xl sm:text-5xl tracking-tight">Request a bespoke quote</h1>
      <p class="text-sm text-slate-600 max-w-2xl">
        Email-only communication is deliberate. Your details stay on this device and generate a composed email to our
        atelier.
      </p>
      <div class="text-xs uppercase tracking-[0.2em] text-slate-500">
        Inspiration: {item.title}
      </div>
    </div>

    <div class="grid gap-10 lg:grid-cols-[0.35fr_0.65fr] items-start">
      <aside class="space-y-6">
        <div class="space-y-2">
          <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Progress</p>
          <ol class="space-y-3 text-sm text-slate-600" data-step-list>
            <li data-step-label="1">1. Piece</li>
            <li data-step-label="2">2. Materials</li>
            <li data-step-label="3">3. Specs</li>
            <li data-step-label="4">4. Inspiration references</li>
            <li data-step-label="5">5. Review + Email</li>
          </ol>
        </div>
        <div class="border border-slate-200 p-4 space-y-3 text-sm text-slate-600">
          <div class="text-xs uppercase tracking-[0.2em] text-slate-500">Inspiration disclaimer</div>
          <p>{INSPIRATION_DISCLAIMER}</p>
        </div>
      </aside>

      <section class="space-y-6">
        <div class="flex items-center justify-between text-xs uppercase tracking-[0.2em] text-slate-500">
          <span data-step-indicator>Step 1 of 5</span>
          <label class="flex items-center gap-2">
            <input type="checkbox" class="h-4 w-4" data-save-draft />
            <span>Save Draft on this Device</span>
          </label>
        </div>

        <form class="space-y-8" data-quote-form>
          <section class="space-y-6" data-step="1">
            <div class="space-y-2">
              <h2 class="font-display text-2xl tracking-tight">Piece</h2>
              <p class="text-sm text-slate-500">Define the piece, occasion, and working budget.</p>
            </div>
            <div class="grid gap-4 sm:grid-cols-2">
              <label class="text-sm space-y-1">
                <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Category</span>
                <select class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="category">
                  <option value="ring" selected={defaultCategory === 'ring'}>Ring</option>
                  <option value="pendant" selected={defaultCategory === 'pendant'}>Pendant</option>
                  <option value="earrings" selected={defaultCategory === 'earrings'}>Earrings</option>
                  <option value="bracelet" selected={defaultCategory === 'bracelet'}>Bracelet</option>
                  <option value="necklace" selected={defaultCategory === 'necklace'}>Necklace</option>
                  <option value="set" selected={defaultCategory === 'set'}>Set</option>
                </select>
              </label>
              <label class="text-sm space-y-1">
                <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Occasion</span>
                <select class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="occasion">
                  <option value="Gift">Gift</option>
                  <option value="Engagement">Engagement</option>
                  <option value="Anniversary">Anniversary</option>
                  <option value="Self-purchase">Self-purchase</option>
                  <option value="Milestone">Milestone</option>
                </select>
              </label>
              <label class="text-sm space-y-1">
                <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Budget min</span>
                <div class="flex gap-2">
                  <select class="border border-slate-200 px-2 py-2 text-sm" data-field="currency">
                    <option value="USD">USD</option>
                    <option value="INR">INR</option>
                  </select>
                  <input type="number" min="0" class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="budgetMin" placeholder="e.g. 8000" required />
                </div>
              </label>
              <label class="text-sm space-y-1">
                <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Budget max</span>
                <input type="number" min="0" class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="budgetMax" placeholder="e.g. 15000" required />
              </label>
              <label class="text-sm space-y-1 sm:col-span-2">
                <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Timeline</span>
                <select class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="timeline">
                  <option value="Standard (4-6 weeks)">Standard (4-6 weeks)</option>
                  <option value="Rush (limited)">Rush (limited)</option>
                </select>
              </label>
            </div>
          </section>

          <section class="space-y-6 hidden" data-step="2">
            <div class="space-y-2">
              <h2 class="font-display text-2xl tracking-tight">Materials</h2>
              <p class="text-sm text-slate-500">Share metal and stone direction.</p>
            </div>
            <div class="grid gap-4 sm:grid-cols-2">
              <label class="text-sm space-y-1">
                <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Metal preference</span>
                <select class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="metal">
                  <option value="18K Yellow Gold" selected={defaultMetalPreference === '18K Yellow Gold'}>18K Yellow Gold</option>
                  <option value="18K White Gold" selected={defaultMetalPreference === '18K White Gold'}>18K White Gold</option>
                  <option value="18K Rose Gold" selected={defaultMetalPreference === '18K Rose Gold'}>18K Rose Gold</option>
                  <option value="Platinum" selected={defaultMetalPreference === 'Platinum'}>Platinum</option>
                </select>
              </label>
              <label class="text-sm space-y-1">
                <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Stone type</span>
                <select class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="stoneType">
                  <option value="Lab diamond" selected={defaultStoneType === 'Lab diamond'}>Lab diamond</option>
                  <option value="Natural diamond" selected={defaultStoneType === 'Natural diamond'}>Natural diamond</option>
                  <option value="Gemstones" selected={defaultStoneType === 'Gemstones'}>Gemstones</option>
                </select>
              </label>
              <label class="text-sm space-y-1">
                <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Center stone shape</span>
                <select class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="centerShape">
                  <option value="Round">Round</option>
                  <option value="Oval">Oval</option>
                  <option value="Pear">Pear</option>
                  <option value="Emerald cut">Emerald cut</option>
                  <option value="Cushion">Cushion</option>
                  <option value="Marquise">Marquise</option>
                  <option value="No preference">No preference</option>
                </select>
              </label>
              <label class="text-sm space-y-1">
                <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Center stone size range</span>
                <input class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="centerSize" placeholder="e.g. 1.5-2.0ct" />
              </label>
            </div>
          </section>

          <section class="space-y-6 hidden" data-step="3">
            <div class="space-y-2">
              <h2 class="font-display text-2xl tracking-tight">Specs</h2>
              <p class="text-sm text-slate-500">Sizing, scale, and intensity.</p>
            </div>
            <div class="grid gap-4 sm:grid-cols-2">
              <label class="text-sm space-y-1" data-size="ring">
                <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Ring size</span>
                <input class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="ringSize" placeholder="US size" required />
              </label>
              <label class="text-sm space-y-1" data-size="bracelet">
                <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Wrist size</span>
                <input class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="wristSize" placeholder="inches or mm" required />
              </label>
              <label class="text-sm space-y-1" data-size="necklace">
                <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Chain length</span>
                <input class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="chainLength" placeholder="e.g. 18 inches" required />
              </label>
              <label class="text-sm space-y-1" data-size="earrings">
                <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Earring preference</span>
                <input class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="earringPreference" placeholder="stud or drop" />
              </label>
              <label class="text-sm space-y-2 sm:col-span-2">
                <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Style intensity</span>
                <input type="range" min="0" max="100" value="35" class="w-full" data-field="styleIntensity" />
                <div class="flex justify-between text-xs text-slate-500">
                  <span>Minimal</span>
                  <span data-style-label>Balanced</span>
                  <span>Bold</span>
                </div>
              </label>
            </div>
          </section>

          <section class="space-y-6 hidden" data-step="4">
            <div class="space-y-3 hidden" data-link-section>
              {Array.from({ length: 5 }).map((_, index) => (
                <div class="grid gap-3 sm:grid-cols-[1.5fr_1fr]">
                  <input
                    class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm"
                    placeholder={`Inspiration link ${index + 1}`}
                    data-link={index}
                  />
                  <input
                    class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm"
                    placeholder="Note"
                    data-link-note={index}
                  />
                </div>
              ))}
            </div>
            <label class="text-sm space-y-1">
              <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Additional notes</span>
              <textarea class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm min-h-[120px]" data-field="notes"></textarea>
            </label>
          </section>

          <section class="space-y-6 hidden" data-step="5">
            <div class="space-y-2">
              <h2 class="font-display text-2xl tracking-tight">Review + Email</h2>
              <p class="text-sm text-slate-500">
                Review the email draft and send from your mail app. No data is stored by Heerawalla.
              </p>
            </div>
            <div class="space-y-4">
              <label class="text-sm space-y-1">
                <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Your name</span>
                <input class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="name" required />
              </label>
              <div class="grid gap-4 sm:grid-cols-2">
                <label class="text-sm space-y-1">
                  <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Preferred / CC email</span>
                  <input type="email" class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="email" required />
                </label>
                <label class="text-sm space-y-1">
                  <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Phone (optional)</span>
                  <input class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="phone" />
                </label>
              </div>
            </div>

            <div class="border border-slate-200 p-4 space-y-2 text-sm text-slate-600">
              <div class="text-xs uppercase tracking-[0.2em] text-slate-500">Email subject</div>
              <div class="font-semibold text-ink" data-email-subject></div>
            </div>
            <div class="border border-slate-200 p-4 space-y-2 text-sm text-slate-600">
              <div class="text-xs uppercase tracking-[0.2em] text-slate-500">Email body</div>
              <pre class="whitespace-pre-wrap text-sm text-slate-600" data-email-body></pre>
            </div>

            <label class="flex items-start gap-3 text-sm text-slate-600">
              <input type="checkbox" class="mt-1" data-disclaimer />
              <span>I acknowledge the inspiration disclaimer.</span>
            </label>
            <p class="text-sm text-slate-500 border border-slate-200 p-4">
              {INSPIRATION_DISCLAIMER}
            </p>

            <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
              <div
                class="relative inline-flex"
                data-mail-picker
                data-email={inquiriesEmail}
                data-subject=""
                data-body=""
              >
                <a
                  class="inline-flex items-center justify-center min-h-[44px] px-5 py-3 bg-ink text-white text-xs uppercase tracking-[0.2em] rounded-none focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ink focus-visible:ring-offset-2 focus-visible:ring-offset-white"
                  href={`mailto:${inquiriesEmail}`}
                  data-mail-trigger
                >
                  Send Enquiry in Email
                </a>
                <div
                  class="absolute left-0 top-full z-20 mt-2 w-48 border border-slate-200 bg-white shadow-md hidden"
                  data-mail-menu
                  role="menu"
                >
                  <button type="button" class="w-full px-3 py-2 text-left text-xs uppercase tracking-[0.2em] text-slate-600 hover:text-ink" data-mail-provider="gmail" role="menuitem">Gmail</button>
                  <button type="button" class="w-full px-3 py-2 text-left text-xs uppercase tracking-[0.2em] text-slate-600 hover:text-ink" data-mail-provider="outlook" role="menuitem">Outlook</button>
                  <button type="button" class="w-full px-3 py-2 text-left text-xs uppercase tracking-[0.2em] text-slate-600 hover:text-ink" data-mail-provider="mailto" role="menuitem">Mail app</button>
                </div>
              </div>
              <button
                type="button"
                class="inline-flex items-center justify-center min-h-[44px] px-5 py-3 border border-ink/20 text-xs uppercase tracking-[0.2em] text-ink rounded-none"
                data-copy-all
              >
                Copy Subject + Body
              </button>
              <button
                type="button"
                class="inline-flex items-center justify-center min-h-[44px] px-5 py-3 border border-ink/20 text-xs uppercase tracking-[0.2em] text-ink rounded-none"
                data-copy-body
              >
                Copy Just the Email Body
              </button>
            </div>
            <p class="text-xs text-slate-500">
              If your mail app does not open, copy the text and email us directly at {inquiriesEmail}.
            </p>
          </section>

          <div class="flex items-center justify-between">
            <button type="button" class="text-xs uppercase tracking-[0.2em] text-slate-500 hover:text-ink" data-prev>
              Back
            </button>
            <button type="button" class="text-xs uppercase tracking-[0.2em] text-slate-500 hover:text-ink" data-next>
              Next
            </button>
          </div>
        </form>
      </section>
    </div>
  </main>

  <Footer />
</BaseLayout>

<script is:inline define:vars={{ slug: item.slug, inspirationTitle: item.title, disclaimer: INSPIRATION_DISCLAIMER, inquiriesEmail, inspirationImage: item.heroImage, inspirationsUrl, homeUrl, defaultCategory }}>
  (() => {
    const form = document.querySelector('[data-quote-form]');
    if (!form) return;

    const steps = Array.from(form.querySelectorAll('[data-step]'));
    const stepLabels = Array.from(document.querySelectorAll('[data-step-label]'));
    const stepIndicator = document.querySelector('[data-step-indicator]');
    const prevBtn = form.querySelector('[data-prev]');
    const nextBtn = form.querySelector('[data-next]');
    const saveDraftToggle = document.querySelector('[data-save-draft]');
    const styleLabel = form.querySelector('[data-style-label]');
    const emailSubject = form.querySelector('[data-email-subject]');
    const emailBody = form.querySelector('[data-email-body]');
    const mailPicker = form.querySelector('[data-mail-picker]');
    const emailLink = form.querySelector('[data-mail-trigger]');
    const copyAll = form.querySelector('[data-copy-all]');
    const copyBody = form.querySelector('[data-copy-body]');
    const disclaimerCheck = form.querySelector('[data-disclaimer]');
    const linkSection = form.querySelector('[data-link-section]');
    const storageKey = `hw-inspiration-quote-${slug}`;
    const returnUrl = inspirationImage ? inspirationsUrl : homeUrl;
    let currentStep = 0;
    let allowStorage = false;

    const clamp = (value, min, max) => Math.min(Math.max(value, min), max);
    const styleFromIntensity = (value) => {
      const num = Number(value || 0);
      if (num <= 33) return 'Minimal';
      if (num <= 66) return 'Balanced';
      return 'Bold';
    };

    const sizeFields = {
      ring: form.querySelector('[data-size="ring"]'),
      bracelet: form.querySelector('[data-size="bracelet"]'),
      necklace: form.querySelector('[data-size="necklace"]'),
      earrings: form.querySelector('[data-size="earrings"]')
    };

    const updateSizeVisibility = (category) => {
      const showAll = category === 'set';
      Object.entries(sizeFields).forEach(([key, el]) => {
        if (!el) return;
        const show = showAll || key === category || (category === 'pendant' && key === 'necklace');
        el.classList.toggle('hidden', !show);
        el.setAttribute('aria-hidden', String(!show));
      });
    };

    const fieldValue = (selector) => {
      const el = form.querySelector(selector);
      if (!el) return '';
      return (el.value || '').trim();
    };

    const getLinks = () => {
      if (linkSection && linkSection.classList.contains('hidden')) return [];
      const links = [];
      form.querySelectorAll('[data-link]').forEach((input) => {
        const index = input.getAttribute('data-link');
        const value = (input.value || '').trim();
        const noteEl = form.querySelector(`[data-link-note="${index}"]`);
        const note = noteEl ? (noteEl.value || '').trim() : '';
        if (value) {
          links.push({ url: value, note });
        }
      });
      return links;
    };

    const buildEmail = () => {
      const category = fieldValue('[data-field="category"]') || 'Piece';
      const currency = fieldValue('[data-field="currency"]') || 'USD';
      const budgetMin = fieldValue('[data-field="budgetMin"]');
      const budgetMax = fieldValue('[data-field="budgetMax"]');
      const styleIntensity = fieldValue('[data-field="styleIntensity"]');
      const style = styleFromIntensity(styleIntensity);
      const subject = `Bespoke Quote Request — ${category} — ${style} — Budget ${currency}${budgetMin || '?'}-${budgetMax || '?'}`;

      const specs = [
        `Category: ${category}`,
        `Occasion: ${fieldValue('[data-field="occasion"]') || 'Not specified'}`,
        `Timeline: ${fieldValue('[data-field="timeline"]') || 'Standard'}`,
        `Style intensity: ${style}`,
        `Budget: ${currency} ${budgetMin || '?'}-${budgetMax || '?'}`
      ];

      const sizes = [];
      const ringSize = fieldValue('[data-field="ringSize"]');
      const wristSize = fieldValue('[data-field="wristSize"]');
      const chainLength = fieldValue('[data-field="chainLength"]');
      const earringPreference = fieldValue('[data-field="earringPreference"]');
      if (ringSize) sizes.push(`Ring size: ${ringSize}`);
      if (wristSize) sizes.push(`Wrist size: ${wristSize}`);
      if (chainLength) sizes.push(`Chain length: ${chainLength}`);
      if (earringPreference) sizes.push(`Earring preference: ${earringPreference}`);

      const materials = [
        `Metal: ${fieldValue('[data-field="metal"]') || 'Not specified'}`,
        `Stone type: ${fieldValue('[data-field="stoneType"]') || 'Not specified'}`,
        `Center stone shape: ${fieldValue('[data-field="centerShape"]') || 'Not specified'}`,
        `Center stone size: ${fieldValue('[data-field="centerSize"]') || 'Not specified'}`
      ];

      const links = getLinks();
      const linkLines = links.length
        ? links.map((link) => `- ${link.url}${link.note ? ` (${link.note})` : ''}`)
        : ['- None provided'];

      const notes = fieldValue('[data-field="notes"]') || 'None';
      const name = fieldValue('[data-field="name"]') || 'Name withheld';
      const email = fieldValue('[data-field="email"]') || 'Not provided';
      const phone = fieldValue('[data-field="phone"]') || 'Not provided';
      const attachmentNote = 'Attachments: Not accepted via web form. Please include links.';

      const acknowledgment =
        'I acknowledge that Heerawalla does not reproduce copyrighted designs. Inspiration references help us understand mood, proportion, and direction. Final designs are original Heerawalla creations.';
      const acknowledgmentLine = disclaimerCheck?.checked
        ? `Acknowledgment: ${acknowledgment}`
        : 'Acknowledgment: Pending';
      const origin = window.location.origin || '';
      const imageUrl = inspirationImage?.startsWith('http')
        ? inspirationImage
        : `${origin}${inspirationImage?.startsWith('/') ? '' : '/'}${inspirationImage || ''}`;
      const body = [
        'Hello Heerawalla,',
        '',
        `I would like to request a bespoke quote inspired by "${inspirationTitle}".`,
        `Inspiration image: ${imageUrl}`,
        '',
        'Specifications:',
        ...specs.map((line) => `- ${line}`),
        ...(sizes.length ? ['- ' + sizes.join(' | ')] : []),
        '',
        'Materials:',
        ...materials.map((line) => `- ${line}`),
        '',
        'Inspiration links:',
        ...linkLines,
        '',
        'Notes:',
        notes,
        '',
        attachmentNote,
        '',
        'Signature:',
        `Name: ${name}`,
        `Preferred/CC email: ${email}`,
        `Phone: ${phone}`,
        '',
        acknowledgmentLine
      ].join('\n');

      return { subject, body, style };
    };

    const updateEmail = () => {
      const { subject, body, style } = buildEmail();
      if (emailSubject) emailSubject.textContent = subject;
      if (emailBody) emailBody.textContent = body;
      if (mailPicker) {
        mailPicker.setAttribute('data-subject', subject);
        mailPicker.setAttribute('data-body', body);
      }
      if (emailLink) {
        const href = `mailto:${inquiriesEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        emailLink.setAttribute('href', href);
      }
      if (styleLabel) styleLabel.textContent = style;
      if (allowStorage) {
        const payload = collectDraft();
        localStorage.setItem(storageKey, JSON.stringify(payload));
      }
    };

    const collectDraft = () => {
      const payload = {};
      form.querySelectorAll('[data-field]').forEach((input) => {
        payload[input.getAttribute('data-field')] = input.value;
      });
      form.querySelectorAll('[data-link]').forEach((input) => {
        payload[`link-${input.getAttribute('data-link')}`] = input.value;
      });
      form.querySelectorAll('[data-link-note]').forEach((input) => {
        payload[`link-note-${input.getAttribute('data-link-note')}`] = input.value;
      });
      return payload;
    };

    const applyDraft = (payload) => {
      if (!payload) return;
      form.querySelectorAll('[data-field]').forEach((input) => {
        const key = input.getAttribute('data-field');
        if (key in payload) input.value = payload[key];
      });
      form.querySelectorAll('[data-link]').forEach((input) => {
        const key = `link-${input.getAttribute('data-link')}`;
        if (key in payload) input.value = payload[key];
      });
      form.querySelectorAll('[data-link-note]').forEach((input) => {
        const key = `link-note-${input.getAttribute('data-link-note')}`;
        if (key in payload) input.value = payload[key];
      });
    };

    const showStep = (index) => {
      currentStep = clamp(index, 0, steps.length - 1);
      steps.forEach((step, idx) => {
        step.classList.toggle('hidden', idx !== currentStep);
      });
      stepLabels.forEach((label, idx) => {
        label.classList.toggle('text-ink', idx === currentStep);
        label.classList.toggle('font-semibold', idx === currentStep);
      });
      if (stepIndicator) {
        stepIndicator.textContent = `Step ${currentStep + 1} of ${steps.length}`;
      }
      if (prevBtn) prevBtn.toggleAttribute('disabled', currentStep === 0);
      if (nextBtn) nextBtn.textContent = currentStep === steps.length - 1 ? 'Finish' : 'Next';
      updateEmail();
    };

    const validateStep = (index) => {
      const step = steps[index];
      if (!step) return true;
      const requiredFields = Array.from(step.querySelectorAll('[required], [data-required="true"]'));
      let firstInvalid = null;
      requiredFields.forEach((field) => {
        if (field.closest('.hidden') || field.closest('[aria-hidden="true"]')) return;
        if (typeof field.checkValidity === 'function' && !field.checkValidity()) {
          if (!firstInvalid) firstInvalid = field;
          return;
        }
        const value = 'value' in field ? (field.value || '').trim() : '';
        if (!value && !firstInvalid) {
          firstInvalid = field;
        }
      });
      if (firstInvalid) {
        if (typeof firstInvalid.reportValidity === 'function') {
          firstInvalid.reportValidity();
        }
        firstInvalid.focus();
        return false;
      }
      return true;
    };

    const enforceDisclaimer = () => {
      const allowed = disclaimerCheck ? disclaimerCheck.checked : false;
      [emailLink, copyAll, copyBody].forEach((btn) => {
        if (!btn) return;
        btn.classList.toggle('opacity-40', !allowed);
        btn.classList.toggle('pointer-events-none', !allowed);
        if (btn.tagName === 'A') {
          btn.setAttribute('aria-disabled', String(!allowed));
        } else {
          btn.toggleAttribute('disabled', !allowed);
        }
      });
    };

    const handleCopy = async (text) => {
      try {
        await navigator.clipboard.writeText(text);
      } catch (err) {
        console.warn('Copy failed', err);
      }
    };


    form.querySelectorAll('[data-field]').forEach((input) => {
      input.addEventListener('input', () => {
        if (input.getAttribute('data-field') === 'category') {
          updateSizeVisibility(input.value);
        }
        updateEmail();
      });
    });

    form.querySelectorAll('[data-link],[data-link-note]').forEach((input) => {
      input.addEventListener('input', updateEmail);
    });

    if (saveDraftToggle) {
      saveDraftToggle.addEventListener('change', () => {
        allowStorage = saveDraftToggle.checked;
        if (!allowStorage) {
          localStorage.removeItem(storageKey);
          return;
        }
        const existing = localStorage.getItem(storageKey);
        if (existing) {
          try {
            applyDraft(JSON.parse(existing));
          } catch {
            localStorage.removeItem(storageKey);
          }
        }
        updateEmail();
      });
    }

    if (prevBtn) {
      prevBtn.addEventListener('click', () => {
        if (currentStep === 0) {
          window.location.assign(returnUrl);
          return;
        }
        showStep(currentStep - 1);
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener('click', () => {
        if (!validateStep(currentStep)) return;
        if (currentStep >= steps.length - 1) {
          window.location.assign(returnUrl);
          return;
        }
        showStep(currentStep + 1);
      });
    }

    if (copyAll) {
      copyAll.addEventListener('click', () => {
        const subject = emailSubject ? emailSubject.textContent : '';
        const body = emailBody ? emailBody.textContent : '';
        handleCopy(`Subject: ${subject}\n\n${body}`);
      });
    }

    if (copyBody) {
      copyBody.addEventListener('click', () => {
        const body = emailBody ? emailBody.textContent : '';
        handleCopy(body);
      });
    }

    if (disclaimerCheck) {
      disclaimerCheck.addEventListener('change', enforceDisclaimer);
      disclaimerCheck.addEventListener('change', updateEmail);
    }


    if (linkSection) {
      const shouldHide = Boolean(inspirationImage);
      linkSection.classList.toggle('hidden', shouldHide);
    }
    updateSizeVisibility(defaultCategory);
    showStep(0);
    enforceDisclaimer();
    updateEmail();
  })();
</script>
