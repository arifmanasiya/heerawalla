---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { loadInspirations, type Inspiration } from '../../lib/inspirations';
import { withBase } from '../../lib/paths';
import { MEDIA_PLACEHOLDER_URL } from '../../lib/placeholders';

const metaTitle = 'Inspirations | Heerawalla';
const metaDescription =
  'A curated set of inspirations that guide bespoke commissions within Heerawalla language.';
const inspirations = await loadInspirations();
const catalogUrl = import.meta.env.PUBLIC_CATALOG_API_URL || '';
const catalogMode = (import.meta.env.PUBLIC_CATALOG_MODE || 'hybrid').toLowerCase();
const basePath = import.meta.env.BASE_URL || '/';

const uniqueValues = (items: string[][]) =>
  Array.from(new Set(items.flat().map((value) => value.trim()).filter(Boolean)));
const categories = uniqueValues(inspirations.map((item) => item.categories)).sort();
const genders = uniqueValues(inspirations.map((item) => item.genders)).sort();
const styles = uniqueValues(inspirations.map((item) => item.styles)).sort();
const motifs = uniqueValues(inspirations.map((item) => item.motifs)).sort();
const metals = uniqueValues(inspirations.map((item) => item.metals)).sort();

const formatNumber = (value: number) => {
  if (Number.isInteger(value)) return value.toString();
  return value.toString();
};

const buildEstimateMeta = (item: Inspiration) => {
  const sections: Array<{ label: string; text?: string; items?: string[] }> = [];
  const ariaParts: string[] = [];
  const diamondQualityText = 'IGI-certified.';
  if (item.stoneWeight || item.metalWeight) {
    sections.push({ label: 'Diamond Quality', text: diamondQualityText });
    ariaParts.push(`Diamond Quality. ${diamondQualityText}.`);
  }
  const tooltip = sections.length ? { sections, ariaLabel: ariaParts.join(' ') } : null;
  return { tooltip };
};
---

<BaseLayout title={metaTitle} description={metaDescription}>
  <Header />

  <main class="max-w-7xl mx-auto px-6 py-12 space-y-10">
    <header class="space-y-4">
      <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Inspirations</p>

      <h1 class="font-display text-4xl sm:text-5xl tracking-tight">
        Start with a mood. We'll craft the masterpiece.
      </h1>

      <p class="text-sm sm:text-base text-slate-600 max-w-2xl">
        Explore curated directions: silhouettes, motifs, and materials. Then request a bespoke quote. Every piece is designed and made as an original Heerawalla creation.
      </p>

      <p class="text-sm text-slate-500 max-w-2xl">
        Bring an image, a sketch, or a feeling. We translate it into a one-of-one design that is uniquely yours.
      </p>
    </header>

    <section class="max-w-3xl mt-10 space-y-6">
      <ol class="grid gap-6 sm:grid-cols-4">
        <li class="space-y-2">
          <p class="text-[10px] uppercase tracking-[0.24em] text-slate-500">Step 1</p>
          <h2 class="text-sm font-semibold tracking-tight">Choose a Direction</h2>
          <p class="text-sm text-slate-600">Select an inspiration or share your own reference.</p>
        </li>
        <li class="space-y-2">
          <p class="text-[10px] uppercase tracking-[0.24em] text-slate-500">Step 2</p>
          <h2 class="text-sm font-semibold tracking-tight">Request a Quote</h2>
          <p class="text-sm text-slate-600">Tell us your metal, stone, budget, and timeline.</p>
        </li>
        <li class="space-y-2">
          <p class="text-[10px] uppercase tracking-[0.24em] text-slate-500">Step 3</p>
          <h2 class="text-sm font-semibold tracking-tight">Design &amp; Confirm</h2>
          <p class="text-sm text-slate-600">We refine the concept and confirm details via email.</p>
        </li>
        <li class="space-y-2">
          <p class="text-[10px] uppercase tracking-[0.24em] text-slate-500">Step 4</p>
          <h2 class="text-sm font-semibold tracking-tight">Craft &amp; Deliver</h2>
          <p class="text-sm text-slate-600">Your one-of-one Heerawalla piece is handcrafted.</p>
        </li>
      </ol>
      <div class="space-y-2 text-sm text-slate-500 max-w-2xl">
        <p>Each request begins a private email conversation with our atelier.</p>
        <p>We contact you only regarding your design.</p>
      </div>
      <p class="text-xs text-slate-500">
        You can expect a personal reply from our atelier at
        <span class="font-medium">atelier@heerawalla.com</span>
        within 1-2 business days.
      </p>
    </section>

    <section class="grid gap-6 border-t border-slate-200 pt-6">
      <div class="card border border-slate-200 bg-white p-4 space-y-3">
        <div class="flex items-center justify-between">
          <p class="text-[11px] uppercase tracking-[0.28em] text-slate-500">Filters</p>
          <button
            type="button"
            class="text-[11px] uppercase tracking-[0.28em] text-slate-500 hover:text-ink"
            data-filter-toggle
            aria-controls="inspiration-filters"
            aria-expanded="false"
          >
            Show filters
          </button>
        </div>
        <div id="inspiration-filters" class="space-y-4 hidden" data-filter-panel>
          <div class="grid gap-3">
            <label class="text-xs uppercase tracking-[0.2em] text-slate-500 space-y-1">
              <span>Category</span>
              <select class="w-full rounded-none border border-slate-200 bg-white px-3 py-2 text-sm" data-filter="category">
                <option value="">All</option>
                {categories.map((item) => (
                  <option value={item}>{item}</option>
                ))}
              </select>
            </label>
            <label class="text-xs uppercase tracking-[0.2em] text-slate-500 space-y-1">
              <span>Gender</span>
              <select class="w-full rounded-none border border-slate-200 bg-white px-3 py-2 text-sm" data-filter="gender">
                <option value="">All</option>
                {genders.map((item) => (
                  <option value={item}>{item}</option>
                ))}
              </select>
            </label>
            <label class="text-xs uppercase tracking-[0.2em] text-slate-500 space-y-1">
              <span>Style</span>
              <select class="w-full rounded-none border border-slate-200 bg-white px-3 py-2 text-sm" data-filter="style">
                <option value="">All</option>
                {styles.map((item) => (
                  <option value={item}>{item}</option>
                ))}
              </select>
            </label>
            <label class="text-xs uppercase tracking-[0.2em] text-slate-500 space-y-1">
              <span>Motif</span>
              <select class="w-full rounded-none border border-slate-200 bg-white px-3 py-2 text-sm" data-filter="motif">
                <option value="">All</option>
                {motifs.map((item) => (
                  <option value={item}>{item}</option>
                ))}
              </select>
            </label>
            <label class="text-xs uppercase tracking-[0.2em] text-slate-500 space-y-1">
              <span>Metal tone</span>
              <select class="w-full rounded-none border border-slate-200 bg-white px-3 py-2 text-sm" data-filter="metal">
                <option value="">All</option>
                {metals.map((item) => (
                  <option value={item}>{item}</option>
                ))}
              </select>
            </label>
          </div>
          <button
            type="button"
            class="text-xs uppercase tracking-[0.2em] text-slate-500 hover:text-ink"
            data-filter-clear
          >
            Clear filters
          </button>
        </div>
      </div>

      <div class="space-y-6">
        <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-3" data-inspiration-grid>
          {inspirations.map((item) => {
            const estimate = buildEstimateMeta(item);
            return (
              <article
                class="border border-slate-200 bg-white flex flex-col"
                data-inspiration-card
                data-categories={item.categories.join(',')}
                data-genders={item.genders.join(',')}
                data-styles={item.styles.join(',')}
                data-motifs={item.motifs.join(',')}
                data-metals={item.metals.join(',')}
              >
                <a href={withBase(`/inspirations/${item.slug}`)} class="block">
                  <div class="aspect-[3/4] w-full overflow-hidden bg-white">
                    <img
                      src={item.heroImage?.startsWith('http') ? item.heroImage : withBase(item.heroImage)}
                      alt={`${item.title} inspiration`}
                      loading="lazy"
                      decoding="async"
                      fetchpriority="low"
                      sizes="(min-width: 1280px) 33vw, (min-width: 768px) 50vw, 100vw"
                      class="h-full w-full object-cover"
                    />
                  </div>
                </a>
                <div class="flex-1 p-4 space-y-3">
                  <div class="space-y-1">
                    <div class="flex items-start justify-between gap-3">
                      <h2 class="text-lg font-semibold tracking-tight">{item.title}</h2>
                      {estimate.tooltip ? (
                        <span class="flex items-center gap-2">
                          <button
                            type="button"
                            class="estimate-info"
                            aria-label={estimate.tooltip.ariaLabel}
                          >
                            i
                            <span class="estimate-tooltip" role="tooltip">
                              {estimate.tooltip.sections.map((section) => (
                                <span class="estimate-tooltip__section">
                                  <span class="estimate-tooltip__label">{section.label}</span>
                                  {section.text ? (
                                    <span class="estimate-tooltip__text">{section.text}</span>
                                  ) : null}
                                  {section.items?.length ? (
                                    <span class="estimate-tooltip__list">
                                      {section.items.map((item) => (
                                        <span class="estimate-tooltip__item">{item}</span>
                                      ))}
                                    </span>
                                  ) : null}
                                </span>
                              ))}
                            </span>
                          </button>
                        </span>
                      ) : null}
                    </div>
                    <p class="text-sm text-slate-500">{item.description}</p>
                  </div>
                  <div class="flex flex-wrap gap-2 text-[10px] uppercase tracking-[0.18em] text-slate-500">
                    {item.tags.slice(0, 3).map((tag) => (
                      <span class="border border-slate-200 px-2 py-1">{tag}</span>
                    ))}
                  </div>
                </div>
                <div class="flex items-center justify-between border-t border-slate-200 px-4 py-3 text-xs uppercase tracking-[0.2em] text-slate-500">
                  <a href={withBase(`/inspirations/${item.slug}`)} class="hover:text-ink">View</a>
                  <a
                    href={withBase(`/inspirations/${item.slug}/bespoke`)}
                    class="hover:text-ink"
                    data-analytics-event="cta_click"
                    data-analytics-label="Request Bespoke"
                    data-analytics-location="inspiration-grid"
                  >
                    Request bespoke
                  </a>
                </div>
              </article>
            );
          })}
        </div>
        <p class="text-sm text-slate-500 hidden" data-inspiration-empty>
          No inspirations match your filters. Clear the filters to start again.
        </p>
      </div>
    </section>
  </main>

  <Footer />
</BaseLayout>

<script is:inline define:vars={{ catalogUrl, catalogMode, basePath }}>
  (() => {
    let catalogUrlValue = String(catalogUrl || '');
    const catalogModeValue = String(catalogMode || '').toLowerCase();
    if (!catalogUrlValue) {
      const host = window.location.hostname;
      if (host === 'localhost' || host === '127.0.0.1') {
        catalogUrlValue = 'http://localhost:8787/catalog';
      }
    }
    const basePathValue = String(basePath || '/');
    const grid = document.querySelector('[data-inspiration-grid]');
    const empty = document.querySelector('[data-inspiration-empty]');
    const selects = Array.from(document.querySelectorAll('[data-filter]'));
    const clear = document.querySelector('[data-filter-clear]');
    const filterToggle = document.querySelector('[data-filter-toggle]');
    const filterPanel = document.querySelector('[data-filter-panel]');
    if (!grid || selects.length === 0) return;

    const withBase = (path) => {
      const base = basePathValue || '/';
      const normalizedBase = base.endsWith('/') ? base : `${base}/`;
      const cleaned = path.replace(/^\/+/, '');
      return `${normalizedBase}${cleaned}`;
    };

    const escapeHtml = (value) =>
      String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\"/g, '&quot;')
        .replace(/'/g, '&#39;');

    const formatNumber = (value) => {
      if (!Number.isFinite(value)) return '';
      if (Number.isInteger(value)) return value.toString();
      return value.toString();
    };

    const buildEstimateMeta = (item) => {
      const sections = [];
      const ariaParts = [];
      const diamondQualityText = 'IGI-certified.';
      if (item.stoneWeight || item.metalWeight) {
        sections.push({ label: 'Diamond Quality', text: diamondQualityText });
        ariaParts.push(`Diamond Quality. ${diamondQualityText}.`);
      }
      const tooltip = sections.length ? { sections, ariaLabel: ariaParts.join(' ') } : null;
      return { tooltip };
    };

    const getValues = () => {
      const values = {};
      selects.forEach((select) => {
        values[select.getAttribute('data-filter')] = select.value;
      });
      return values;
    };

    const matchesFilter = (value, list) => {
      if (!value) return true;
      return list.includes(value.toLowerCase());
    };

    const apply = () => {
      const filters = getValues();
      let visible = 0;
      const cards = Array.from(document.querySelectorAll('[data-inspiration-card]'));
      cards.forEach((card) => {
        const categories = (card.getAttribute('data-categories') || '').toLowerCase().split(',');
        const genders = (card.getAttribute('data-genders') || '').toLowerCase().split(',');
        const styles = (card.getAttribute('data-styles') || '').toLowerCase().split(',');
        const motifs = (card.getAttribute('data-motifs') || '').toLowerCase().split(',');
        const metals = (card.getAttribute('data-metals') || '').toLowerCase().split(',');
        const match =
          matchesFilter(filters.category, categories) &&
          matchesFilter(filters.gender, genders) &&
          matchesFilter(filters.style, styles) &&
          matchesFilter(filters.motif, motifs) &&
          matchesFilter(filters.metal, metals);
        card.classList.toggle('hidden', !match);
        if (match) visible += 1;
      });
      if (empty) {
        empty.classList.toggle('hidden', visible !== 0);
      }
    };

    selects.forEach((select) => {
      select.addEventListener('change', apply);
    });

    if (clear) {
      clear.addEventListener('click', () => {
        selects.forEach((select) => {
          select.value = '';
        });
        apply();
      });
    }

    if (filterToggle && filterPanel) {
      filterToggle.addEventListener('click', () => {
        const isOpen = !filterPanel.classList.contains('hidden');
        filterPanel.classList.toggle('hidden', isOpen);
        filterToggle.setAttribute('aria-expanded', String(!isOpen));
        filterToggle.textContent = isOpen ? 'Show filters' : 'Hide filters';
      });
    }

    apply();

    const setOptions = (select, values) => {
      const current = select.value;
      select.innerHTML = '<option value=\"\">All</option>';
      values.forEach((value) => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        select.appendChild(option);
      });
      if (current && values.includes(current)) {
        select.value = current;
      } else {
        select.value = '';
      }
    };

    const renderInspirations = (items) => {
      const cardsHtml = items
        .map((item) => {
          const estimate = buildEstimateMeta(item);
          const tooltipHtml = estimate.tooltip
            ? `<button type="button" class="estimate-info" aria-label="${escapeHtml(
                estimate.tooltip.ariaLabel
              )}">i<span class="estimate-tooltip" role="tooltip">${estimate.tooltip.sections
                .map(
                  (section) =>
                    `<span class="estimate-tooltip__section"><span class="estimate-tooltip__label">${escapeHtml(
                      section.label
                    )}</span>${
                      section.text
                        ? `<span class="estimate-tooltip__text">${escapeHtml(section.text)}</span>`
                        : ''
                    }${
                      section.items && section.items.length
                        ? `<span class="estimate-tooltip__list">${section.items
                            .map(
                              (entry) =>
                                `<span class="estimate-tooltip__item">${escapeHtml(entry)}</span>`
                            )
                            .join('')}</span>`
                        : ''
                    }</span>`
                )
                .join('')}</span></button>`
            : '';
          const heroImage = item.heroImage
            ? (String(item.heroImage).startsWith('http')
                ? item.heroImage
                : withBase(item.heroImage))
            : MEDIA_PLACEHOLDER_URL;
          const title = escapeHtml(item.title || '');
          const shortDesc = escapeHtml(item.description || '');
          const tags = (item.tags || []).slice(0, 3);
          const categories = (item.categories || []).join(',');
          const genders = (item.genders || []).join(',');
          const styles = (item.styles || []).join(',');
          const motifs = (item.motifs || []).join(',');
          const metals = (item.metals || []).join(',');
          const link = withBase(`/inspirations/${item.slug}`);
          const bespokeLink = withBase(`/inspirations/${item.slug}/bespoke`);
          return `
            <article
              class="border border-slate-200 bg-white flex flex-col"
              data-inspiration-card
              data-categories="${escapeHtml(categories)}"
              data-genders="${escapeHtml(genders)}"
              data-styles="${escapeHtml(styles)}"
              data-motifs="${escapeHtml(motifs)}"
              data-metals="${escapeHtml(metals)}"
            >
              <a href="${escapeHtml(link)}" class="block">
                <div class="aspect-[3/4] w-full overflow-hidden bg-white">
                  <img
                    src="${escapeHtml(heroImage)}"
                    alt="${title} inspiration"
                    loading="lazy"
                    decoding="async"
                    fetchpriority="low"
                    sizes="(min-width: 1280px) 33vw, (min-width: 768px) 50vw, 100vw"
                    class="h-full w-full object-cover"
                  />
                </div>
              </a>
              <div class="flex-1 p-4 space-y-3">
                <div class="space-y-1">
                  <div class="flex items-start justify-between gap-3">
                    <h2 class="text-lg font-semibold tracking-tight">${title}</h2>
                    ${tooltipHtml ? `<span class="flex items-center gap-2">${tooltipHtml}</span>` : ''}
                  </div>
                  <p class="text-sm text-slate-500">${shortDesc}</p>
                </div>
                <div class="flex flex-wrap gap-2 text-[10px] uppercase tracking-[0.18em] text-slate-500">
                  ${tags.map((tag) => `<span class="border border-slate-200 px-2 py-1">${escapeHtml(tag)}</span>`).join('')}
                </div>
              </div>
              <div class="flex items-center justify-between border-t border-slate-200 px-4 py-3 text-xs uppercase tracking-[0.2em] text-slate-500">
                <a href="${escapeHtml(link)}" class="hover:text-ink">View</a>
                <a
                  href="${escapeHtml(bespokeLink)}"
                  class="hover:text-ink"
                  data-analytics-event="cta_click"
                  data-analytics-label="Request Bespoke"
                  data-analytics-location="inspiration-grid"
                >
                  Request bespoke
                </a>
              </div>
            </article>
          `;
        })
        .join('');

      grid.innerHTML = cardsHtml;
      apply();
    };

    const refreshFilters = (items) => {
      const uniqueValues = (values) =>
        Array.from(new Set(values.flat().map((value) => String(value).trim()).filter(Boolean))).sort();
      const categories = uniqueValues(items.map((item) => item.categories || []));
      const genders = uniqueValues(items.map((item) => item.genders || []));
      const styles = uniqueValues(items.map((item) => item.styles || []));
      const motifs = uniqueValues(items.map((item) => item.motifs || []));
      const metals = uniqueValues(items.map((item) => item.metals || []));

      selects.forEach((select) => {
        const key = select.getAttribute('data-filter');
        if (key === 'category') setOptions(select, categories);
        if (key === 'gender') setOptions(select, genders);
        if (key === 'style') setOptions(select, styles);
        if (key === 'motif') setOptions(select, motifs);
        if (key === 'metal') setOptions(select, metals);
      });
    };

    const fetchCatalog = async () => {
      if (!catalogUrlValue) return;
      const joiner = catalogUrlValue.includes('?') ? '&' : '?';
      const url = `${catalogUrlValue}${joiner}include=inspirations&bust=${Date.now()}`;
      try {
        const response = await fetch(url, { cache: 'no-store' });
        if (!response.ok) return;
        const data = await response.json();
        if (!data || !Array.isArray(data.inspirations)) return;
        refreshFilters(data.inspirations);
        renderInspirations(data.inspirations);
      } catch {
        // Ignore catalog errors; fall back to static content.
      }
    };

    fetchCatalog();
  })();
</script>
