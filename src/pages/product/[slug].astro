---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import { loadProductsWithMedia, type ProductWithMedia } from '../../lib/products';
import { withBase } from '../../lib/paths';

export async function getStaticPaths() {
  const products = await loadProductsWithMedia();
  return products.map((product) => ({
    params: { slug: product.slug },
    props: { product }
  }));
}

const { product } = Astro.props as { product: ProductWithMedia };
const catalogUrl = import.meta.env.PUBLIC_CATALOG_API_URL || '';
const catalogMode = (import.meta.env.PUBLIC_CATALOG_MODE || 'hybrid').toLowerCase();
const primaryMedia = product.media.images[0]?.url || product.media.videos[0]?.url;
const rawImage = primaryMedia;
const fallback = withBase('/images/products/placeholder.svg');
const image = rawImage ? (rawImage.startsWith('http') ? rawImage : withBase(rawImage)) : fallback;
const imageMeta = product.media.images.map((m) => ({ url: m.url, description: m.description || '' }));
const imageCount = imageMeta.length;
const applyDiscount = (value: number, pct?: number) => {
  const ratio = 1 + (pct ?? 0) / 100;
  return Math.round(value * ratio * 100) / 100;
};
const roundTo99 = (value: number) => {
  if (!Number.isFinite(value)) return value;
  const lower = Math.floor(value / 100) * 100 + 99;
  const upper = Math.ceil(value / 100) * 100 + 99;
  return Math.abs(value - lower) <= Math.abs(value - upper) ? lower : upper;
};
const parseList = (value?: string) => {
  if (!value) return [];
  return value
    .split('|')
    .map((item) => item.trim())
    .filter(Boolean);
};
const normalizeStoneType = (value: string) =>
  value
    .replace(/diamond\(s\)/gi, 'Diamond')
    .replace(/diamonds?\b/gi, 'Diamond')
    .replace(/\s+/g, ' ')
    .trim();
const baseUsd = product.price_usd_natural;
const labDiscountPct = product.lab_discount_pct ?? -20;
const metal14DiscountPct = product.metal_14k_discount_pct ?? -5;
const platinumPremiumPct = product.metal_platinum_premium ?? 10;
const labUsd = applyDiscount(baseUsd, labDiscountPct);
const platinumUsd = applyDiscount(baseUsd, platinumPremiumPct);
const platinumLabUsd = applyDiscount(labUsd, platinumPremiumPct);
const baseUsdRounded = roundTo99(baseUsd);
const labUsdRounded = roundTo99(labUsd);
const stoneTypes = parseList(product.stone_types).map(normalizeStoneType).filter(Boolean);
const naturalAvailable = stoneTypes.some((item) => /natural/i.test(item));
const labAvailable = stoneTypes.some((item) => /lab/i.test(item));
const naturalStoneLabel =
  stoneTypes.find((item) => /natural/i.test(item)) || 'Natural Diamond';
const labStoneLabel =
  stoneTypes.find((item) => /lab/i.test(item)) || 'Lab Grown Diamond';
const diamondDefault = labAvailable ? 'lab' : naturalAvailable ? 'natural' : 'lab';
const defaultDiamondUsd = diamondDefault === 'lab' ? labUsd : baseUsd;
const defaultUsd = roundTo99(applyDiscount(defaultDiamondUsd, metal14DiscountPct));
const diamondDefaultLabel = diamondDefault === 'lab' ? labStoneLabel : naturalStoneLabel;
const usdFormatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
const metal18Label = (product.metal || '18K Gold').replace(/14K/gi, '18K');
const metal14Label = metal18Label.replace(/18K/gi, '14K');
const metalPlatinumLabel = 'Platinum';
const designCode = product.design_code || 'Signature';
const designCodeSlug = designCode.toLowerCase();
const isDesignCode = ['axis', 'continuum', 'eclipse'].includes(designCodeSlug);
const designCodeHref = (() => {
  if (!isDesignCode) return withBase('/inspirations');
  const category = product.category || '';
  if (category.startsWith('men/')) {
    return withBase(`/mens-jewelry?design_code=${designCodeSlug}`);
  }
  if (category.startsWith('women/')) {
    return withBase(`/womens-jewelry?design_code=${designCodeSlug}`);
  }
  if (category.startsWith('unisex/')) {
    return withBase(`/womens-jewelry?design_code=${designCodeSlug}`);
  }
  return withBase(`/womens-jewelry?design_code=${designCodeSlug}`);
})();
const editionHrefMap: Record<string, string> = {
  women: withBase('/womens-jewelry'),
  men: withBase('/mens-jewelry')
};
const editionLabel = (() => {
  const category = product.category || '';
  const group = category.split('/')[0] || '';
  if (group === 'women') return "Women's Edition";
  if (group === 'men') return "Men's Edition";
  if (group === 'unisex') return 'Unisex Edition';
  return product.collection || product.category || '';
})();
const groupLabel = editionLabel || product.collection || product.category || '';
const editionKey = (product.category || '').split('/')[0] || '';
const editionHref = editionHrefMap[editionKey];
const groupLineLabel = editionHref ? 'Edition' : 'Collection';
const breadcrumbCrumbs = [
  { label: 'Home', href: withBase('/') },
  { label: designCode, href: designCodeHref, kind: 'design-code' },
  ...(editionHref ? [{ label: editionLabel, href: editionHref }] : []),
  { label: product.name }
];
const bespokeHref = withBase(`/bespoke/${product.slug}`);
const productSlug = product.slug;

const offers = [
  ...(naturalAvailable
    ? [
        {
          '@type': 'Offer',
          price: baseUsdRounded,
          priceCurrency: 'USD',
          availability: 'https://schema.org/InStock'
        }
      ]
    : []),
  ...(labAvailable && (!naturalAvailable || labUsd !== baseUsd)
    ? [
        {
          '@type': 'Offer',
          price: labUsdRounded,
          priceCurrency: 'USD',
          availability: 'https://schema.org/InStock'
        }
      ]
    : [])
];
const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Product',
  name: product.name,
  image: product.media.images.length
    ? product.media.images.map((m) => m.url)
    : [image],
  description: product.description,
  sku: product.id,
  brand: { '@type': 'Brand', name: 'Heerawalla' },
  offers
};
const jsonLdString = JSON.stringify(jsonLd);
void jsonLdString;
---

<BaseLayout
  title={`${product.name} | Heerawalla`}
  description={product.description}
  breadcrumbs={breadcrumbCrumbs}
>
  <Header />
  <main class="container py-10 space-y-8">
    <Breadcrumbs crumbs={breadcrumbCrumbs} />
    <div class="grid gap-8 lg:grid-cols-2 items-start">
      <div class="card relative bg-white">
        <div class="relative flex items-center justify-center overflow-hidden rounded-2xl bg-white">
          <img
            src={image}
            alt={product.name}
            class="block max-h-[70vh] w-auto max-w-full object-contain"
            loading="lazy"
            decoding="async"
            fetchpriority="high"
            data-product-image
            data-product-image-meta={JSON.stringify(imageMeta)}
            data-protected-image
          />
        </div>
        {imageCount > 1 ? (
          <button
            type="button"
            class="absolute left-3 top-1/2 -translate-y-1/2 inline-flex h-10 w-10 items-center justify-center rounded-full border border-white/70 bg-white/90 text-lg font-semibold text-ink shadow-sm backdrop-blur transition hover:bg-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ink"
            data-image-prev
            aria-label="Previous image"
          >
            &larr;
          </button>
        ) : null}
        {imageCount > 1 ? (
          <button
            type="button"
            class="absolute right-3 top-1/2 -translate-y-1/2 inline-flex h-10 w-10 items-center justify-center rounded-full border border-white/70 bg-white/90 text-lg font-semibold text-ink shadow-sm backdrop-blur transition hover:bg-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ink"
            data-image-next
            aria-label="Next image"
          >
            &rarr;
          </button>
        ) : null}
      </div>
      <div class="space-y-6">
        <div>
          <h1 class="text-3xl font-semibold tracking-tight">{product.name}</h1>
        </div>
        <div class="flex flex-wrap items-center gap-2 text-xs uppercase tracking-[0.18em] text-slate-500">
          <a href={designCodeHref} class="hover:text-ink">{designCode}</a>
          {groupLabel ? <span aria-hidden="true">|</span> : null}
          {groupLabel ? <span>{groupLabel}</span> : null}
        </div>
        <div class="space-y-2">
          <div class="flex items-center gap-4">
            <span
              class="text-xl font-semibold"
              data-price-usd-base={baseUsd}
              data-lab-discount={labDiscountPct}
              data-platinum-premium={platinumPremiumPct}
              data-metal-14k-discount={metal14DiscountPct}
              data-metal-default="14k"
              data-diamond-default={diamondDefault}
              data-natural-available={naturalAvailable}
              data-lab-available={labAvailable}
              id="price-display"
            >
              {usdFormatter.format(defaultUsd)}
            </span>
            <span class="text-sm text-slate-500 flex items-center gap-2">
              <span
                data-metal-label
                data-metal-18={metal18Label}
                data-metal-14={metal14Label}
                data-metal-platinum={metalPlatinumLabel}
              >
                {metal14Label}
              </span>
              <span class="relative group">
                <button
                  type="button"
                  class="inline-flex h-4 w-4 items-center justify-center rounded-full border border-slate-300 text-[10px] text-slate-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ink focus-visible:ring-offset-2 focus-visible:ring-offset-white"
                  aria-describedby="gold-tooltip"
                >
                  i
                </button>
                <span
                  id="gold-tooltip"
                  role="tooltip"
                  class="pointer-events-none absolute left-1/2 top-full z-10 mt-2 w-60 -translate-x-1/2 border border-slate-200 bg-white px-3 py-2 text-[11px] leading-relaxed text-slate-600 opacity-0 transition-opacity duration-200 group-hover:opacity-100 group-focus-within:opacity-100"
                >
                  For daily wear, 14K offers added durability; 18K brings richer color, and platinum adds a bright, weighty finish.
                </span>
              </span>
              <span class="relative group inline-flex items-center gap-1">
                <span
                  data-diamond-label
                  data-diamond-natural={naturalStoneLabel}
                  data-diamond-lab={labStoneLabel}
                >
                  {diamondDefaultLabel}
                </span>
                <button
                  type="button"
                  class="inline-flex h-4 w-4 items-center justify-center rounded-full border border-slate-300 text-[10px] text-slate-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ink focus-visible:ring-offset-2 focus-visible:ring-offset-white"
                  aria-describedby="diamond-quality-tooltip"
                >
                  i
                </button>
                <span
                  id="diamond-quality-tooltip"
                  class="pointer-events-none absolute left-1/2 top-full z-10 mt-2 w-60 -translate-x-1/2 border border-slate-200 bg-white px-3 py-2 text-[11px] leading-relaxed text-slate-600 opacity-0 transition-opacity duration-200 group-hover:opacity-100 group-focus-within:opacity-100"
                  role="tooltip"
                >
                  Pricing reflects top-quality diamonds (ideal cut, VVS1-VVS2, E-F color).
                </span>
              </span>
            </span>
          </div>
          <div class="flex items-center gap-2 text-xs uppercase tracking-[0.2em] text-slate-500">
            <span>Estimated price</span>
            <div class="relative group">
              <button
                type="button"
                class="inline-flex h-4 w-4 items-center justify-center rounded-full border border-slate-300 text-[10px] text-slate-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ink focus-visible:ring-offset-2 focus-visible:ring-offset-white"
                aria-describedby="price-tooltip"
              >
                i
              </button>
              <span
                id="price-tooltip"
                role="tooltip"
                class="pointer-events-none absolute left-1/2 top-full z-10 mt-2 w-60 -translate-x-1/2 border border-slate-200 bg-white px-3 py-2 text-[11px] leading-relaxed text-slate-600 opacity-0 transition-opacity duration-200 group-hover:opacity-100 group-focus-within:opacity-100"
              >
                Final pricing is confirmed after consultation based on metal, diamond choice, and sizing.
              </span>
            </div>
          </div>
          {naturalAvailable && labAvailable ? (
            <div class="flex flex-wrap gap-2 text-xs text-slate-500 items-center">
              <span class="px-2 py-1 rounded-full bg-slate-100 text-slate-700">Stone Type</span>
              <button type="button" class="px-2 py-1 rounded-full border border-slate-200" data-price-toggle="natural">{naturalStoneLabel}</button>
              <button type="button" class="px-2 py-1 rounded-full border border-slate-200" data-price-toggle="lab">{labStoneLabel}</button>
            </div>
          ) : naturalAvailable || labAvailable ? (
            <div class="flex flex-wrap gap-2 text-xs text-slate-500 items-center">
              <span class="px-2 py-1 rounded-full bg-slate-100 text-slate-700">Stone Type</span>
              <span class="text-xs uppercase tracking-[0.18em] text-slate-500">
                {naturalAvailable ? naturalStoneLabel : labStoneLabel}
              </span>
            </div>
          ) : null}
          <div class="flex flex-wrap gap-2 text-xs text-slate-500 items-center">
            <span class="px-2 py-1 rounded-full bg-slate-100 text-slate-700">Metal Type</span>
            <button type="button" class="px-2 py-1 rounded-full border border-slate-200" data-metal-toggle="18k">{metal18Label}</button>
            <button type="button" class="px-2 py-1 rounded-full border border-slate-200" data-metal-toggle="14k">{metal14Label}</button>
            <button type="button" class="px-2 py-1 rounded-full border border-slate-200" data-metal-toggle="platinum">{metalPlatinumLabel}</button>
          </div>
        </div>
        <p class="text-sm leading-relaxed text-slate-600 whitespace-pre-line" data-product-description>
          {product.description}
        </p>

        <div class="space-y-3">
          <div class="flex flex-wrap gap-3">
            <a
              class="btn btn-primary"
              href={bespokeHref}
              data-bespoke-link
              data-bespoke-base={bespokeHref}
            >
              Request final quote
            </a>
            <a class="btn btn-ghost" href={withBase('/contact?intent=consultation')}>Book a consultation</a>
          </div>
        </div>
        <div class="border-t border-slate-200 pt-4 text-sm text-slate-500 space-y-2">
          <div class="text-xs uppercase tracking-[0.2em] text-slate-500">How checkout works</div>
          <p>1) You request a quote and confirm your preferred details.</p>
          <p>2) A concierge validates availability, sizing, and pricing.</p>
          <p>3) We email a secure payment link. Your piece is reserved once paid.</p>
        </div>
      </div>
    </div>
  </main>
  <Footer />

  <script type="application/ld+json" is:inline>
    {jsonLdString}
  </script>
  <script is:inline>
    (() => {
      const mainImage = document.querySelector('[data-product-image]');
      if (!mainImage) return;
      const rawList = mainImage.getAttribute('data-product-image-meta') || '[]';
      let imageMeta = [];
      try {
        imageMeta = JSON.parse(rawList);
      } catch {
        return;
      }
      if (!Array.isArray(imageMeta) || imageMeta.length === 0) return;
      const prevBtn = document.querySelector('[data-image-prev]');
      const nextBtn = document.querySelector('[data-image-next]');
      const descEl = document.querySelector('[data-product-description]');
      const heroText = imageMeta[0]?.description || '';
      const defaultText = heroText || (descEl ? descEl.textContent || '' : '');
      let index = imageMeta.findIndex((item) => item?.url === (mainImage.getAttribute('src') || ''));
      if (index < 0) index = 0;

      const setIndex = (nextIndex) => {
        const count = imageMeta.length;
        index = ((nextIndex % count) + count) % count;
        const next = imageMeta[index];
        if (next?.url) {
          mainImage.setAttribute('src', next.url);
        }
        if (descEl) {
          descEl.textContent = next?.description || defaultText;
        }
      };

      if (descEl) {
        descEl.textContent = defaultText;
      }
      setIndex(index);

      if (imageMeta.length > 1) {
        if (prevBtn) {
          prevBtn.addEventListener('click', () => setIndex(index - 1));
        }
        if (nextBtn) {
          nextBtn.addEventListener('click', () => setIndex(index + 1));
        }
      }
    })();
  </script>
  <script is:inline>
    (() => {
      const priceEl = document.getElementById('price-display');
      if (!priceEl) return;
      const readState = () => ({
        baseUsd: Number(priceEl.dataset.priceUsdBase || 0),
        labDiscount: Number(priceEl.dataset.labDiscount || -20),
        platinumPremium: Number(priceEl.dataset.platinumPremium || 10),
        metal14Discount: Number(priceEl.dataset.metal14kDiscount || -5),
        naturalAvailable: priceEl.dataset.naturalAvailable !== 'false',
        labAvailable: priceEl.dataset.labAvailable !== 'false',
        diamondDefault: priceEl.dataset.diamondDefault || '',
        metalDefault: priceEl.dataset.metalDefault || ''
      });
      let diamondMode = 'natural';
      let metalMode = '14k';
      const metalLabel = document.querySelector('[data-metal-label]');
      const bespokeLink = document.querySelector('[data-bespoke-link]');
      const bespokeBase = bespokeLink ? (bespokeLink.getAttribute('data-bespoke-base') || bespokeLink.getAttribute('href') || '') : '';
      const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
      const applyDiscount = (value, pct) => Math.round(value * (1 + pct / 100) * 100) / 100;
      const roundTo99 = (value) => {
        if (!Number.isFinite(value)) return value;
        const lower = Math.floor(value / 100) * 100 + 99;
        const upper = Math.ceil(value / 100) * 100 + 99;
        return Math.abs(value - lower) <= Math.abs(value - upper) ? lower : upper;
      };
      const priceToggles = Array.from(document.querySelectorAll('[data-price-toggle]'));
      const metalToggles = Array.from(document.querySelectorAll('[data-metal-toggle]'));
      const setToggleAvailability = (state) => {
        priceToggles.forEach((btn) => {
          const mode = btn.dataset.priceToggle || 'natural';
          const isAvailable = mode === 'lab' ? state.labAvailable : state.naturalAvailable;
          if (!isAvailable) {
            btn.setAttribute('disabled', 'true');
            btn.classList.add('opacity-40', 'cursor-not-allowed', 'pointer-events-none');
          } else {
            btn.removeAttribute('disabled');
            btn.classList.remove('opacity-40', 'cursor-not-allowed', 'pointer-events-none');
          }
        });
      };
      const syncModes = (state, refreshDefaults) => {
        if (refreshDefaults) {
          diamondMode = state.diamondDefault || (state.labAvailable ? 'lab' : 'natural');
          metalMode = state.metalDefault || metalMode || '14k';
        }
        if (diamondMode === 'lab' && !state.labAvailable) diamondMode = 'natural';
        if (diamondMode === 'natural' && !state.naturalAvailable) diamondMode = state.labAvailable ? 'lab' : 'natural';
      };
      const apply = (refreshDefaults) => {
        const state = readState();
        setToggleAvailability(state);
        syncModes(state, refreshDefaults);
        let price = state.baseUsd;
        if (diamondMode === 'lab') {
          price = applyDiscount(price, state.labDiscount);
        }
        if (metalMode === '14k') {
          price = applyDiscount(price, state.metal14Discount);
        }
        if (metalMode === 'platinum') {
          price = applyDiscount(price, state.platinumPremium);
        }
        priceEl.textContent = formatter.format(roundTo99(price));
        priceToggles.forEach((btn) => {
          btn.classList.toggle('bg-ink', btn.dataset.priceToggle === diamondMode);
          btn.classList.toggle('text-white', btn.dataset.priceToggle === diamondMode);
        });
        metalToggles.forEach((btn) => {
          btn.classList.toggle('bg-ink', btn.dataset.metalToggle === metalMode);
          btn.classList.toggle('text-white', btn.dataset.metalToggle === metalMode);
        });
        if (metalLabel) {
          const label =
            metalMode === '14k'
              ? metalLabel.getAttribute('data-metal-14')
              : metalMode === 'platinum'
                ? metalLabel.getAttribute('data-metal-platinum')
                : metalLabel.getAttribute('data-metal-18');
          if (label) metalLabel.textContent = label;
        }
        const diamondLabel = document.querySelector('[data-diamond-label]');
        if (diamondLabel) {
          const label =
            diamondMode === 'lab'
              ? diamondLabel.getAttribute('data-diamond-lab')
              : diamondLabel.getAttribute('data-diamond-natural');
          if (label) diamondLabel.textContent = label;
        }
        if (bespokeLink && bespokeBase) {
          const params = new URLSearchParams();
          params.set('metal', metalMode);
          params.set('stone', diamondMode);
          params.set('source', 'product');
          bespokeLink.setAttribute('href', `${bespokeBase}?${params.toString()}`);
        }
      };
      priceToggles.forEach((btn) => {
        const mode = btn.dataset.priceToggle || 'natural';
        btn.addEventListener('click', () => {
          diamondMode = mode;
          apply(false);
        });
      });
      metalToggles.forEach((btn) => {
        btn.addEventListener('click', () => {
          metalMode = btn.dataset.metalToggle || '18k';
          apply(false);
        });
      });
      apply(true);
      window.__hwApplyPricing = () => apply(false);
      window.__hwRefreshPricingDefaults = () => apply(true);
    })();
  </script>
  <script is:inline define:vars={{ catalogUrl, catalogMode, productSlug }}>
    (() => {
      const catalogUrl = String(catalogUrl || '');
      const catalogMode = String(catalogMode || '').toLowerCase();
      const productSlug = String(productSlug || '');
      if (!catalogUrl || catalogMode === 'ssr' || !productSlug) return;

      const priceEl = document.getElementById('price-display');
      if (!priceEl) return;
      const metalLabel = document.querySelector('[data-metal-label]');
      const diamondLabel = document.querySelector('[data-diamond-label]');
      const naturalToggle = document.querySelector('[data-price-toggle="natural"]');
      const labToggle = document.querySelector('[data-price-toggle="lab"]');
      const metal18Toggle = document.querySelector('[data-metal-toggle="18k"]');
      const metal14Toggle = document.querySelector('[data-metal-toggle="14k"]');
      const metalPlatinumToggle = document.querySelector('[data-metal-toggle="platinum"]');

      const parseList = (value) => {
        if (!value) return [];
        return String(value)
          .split('|')
          .map((item) => item.trim())
          .filter(Boolean);
      };

      const normalizeStoneType = (value) =>
        String(value || '')
          .replace(/diamond\\(s\\)/gi, 'Diamond')
          .replace(/diamonds?\\b/gi, 'Diamond')
          .replace(/\\s+/g, ' ')
          .trim();

      const parseNumber = (value) => {
        if (value === undefined || value === null) return undefined;
        if (typeof value === 'number') return Number.isFinite(value) ? value : undefined;
        const trimmed = String(value).trim();
        if (!trimmed) return undefined;
        const parsed = Number(trimmed);
        return Number.isFinite(parsed) ? parsed : undefined;
      };

      const updatePricingFromProduct = (item) => {
        const stoneTypes = parseList(item.stone_types).map(normalizeStoneType).filter(Boolean);
        const naturalAvailable = stoneTypes.some((entry) => /natural/i.test(entry));
        const labAvailable = stoneTypes.some((entry) => /lab/i.test(entry));
        const naturalStoneLabel =
          stoneTypes.find((entry) => /natural/i.test(entry)) || 'Natural Diamond';
        const labStoneLabel =
          stoneTypes.find((entry) => /lab/i.test(entry)) || 'Lab Grown Diamond';
        const metal18Label = String(item.metal || '18K Gold').replace(/14K/gi, '18K');
        const metal14Label = metal18Label.replace(/18K/gi, '14K');

        priceEl.dataset.priceUsdBase = String(parseNumber(item.price_usd_natural) || 0);
        priceEl.dataset.labDiscount = String(
          parseNumber(item.lab_discount_pct ?? -20) ?? -20
        );
        priceEl.dataset.platinumPremium = String(
          parseNumber(item.metal_platinum_premium ?? 10) ?? 10
        );
        priceEl.dataset.metal14kDiscount = String(
          parseNumber(item.metal_14k_discount_pct ?? -5) ?? -5
        );
        priceEl.dataset.naturalAvailable = String(naturalAvailable);
        priceEl.dataset.labAvailable = String(labAvailable);
        priceEl.dataset.diamondDefault = labAvailable ? 'lab' : naturalAvailable ? 'natural' : 'lab';

        if (metalLabel) {
          metalLabel.setAttribute('data-metal-18', metal18Label);
          metalLabel.setAttribute('data-metal-14', metal14Label);
          metalLabel.setAttribute('data-metal-platinum', 'Platinum');
        }
        if (diamondLabel) {
          diamondLabel.setAttribute('data-diamond-natural', naturalStoneLabel);
          diamondLabel.setAttribute('data-diamond-lab', labStoneLabel);
        }
        if (naturalToggle) {
          naturalToggle.textContent = naturalStoneLabel;
        }
        if (labToggle) {
          labToggle.textContent = labStoneLabel;
        }
        if (metal18Toggle) {
          metal18Toggle.textContent = metal18Label;
        }
        if (metal14Toggle) {
          metal14Toggle.textContent = metal14Label;
        }
        if (metalPlatinumToggle) {
          metalPlatinumToggle.textContent = 'Platinum';
        }

        if (window.__hwRefreshPricingDefaults) {
          window.__hwRefreshPricingDefaults();
        } else if (window.__hwApplyPricing) {
          window.__hwApplyPricing();
        }
      };

      const fetchCatalog = async () => {
        const joiner = catalogUrl.includes('?') ? '&' : '?';
        const url = `${catalogUrl}${joiner}include=products`;
        try {
          const response = await fetch(url, { cache: 'no-store' });
          if (!response.ok) return;
          const data = await response.json();
          if (!data || !Array.isArray(data.products)) return;
          const match = data.products.find((entry) => entry && entry.slug === productSlug);
          if (!match) return;
          updatePricingFromProduct(match);
        } catch {
          // Ignore catalog errors; fall back to SSR data.
        }
      };

      fetchCatalog();
    })();
  </script>
  <script is:inline>
    (() => {
      const link = document.querySelector('[data-breadcrumb-kind="design-code"]');
      if (!(link instanceof HTMLAnchorElement)) return;
      const ref = document.referrer;
      if (!ref) return;
      try {
        const url = new URL(ref);
        if (url.origin !== window.location.origin) return;
        const path = url.pathname;
        const allowed = ['/mens-jewelry', '/womens-jewelry', '/inspirations'];
        if (!allowed.some((prefix) => path.startsWith(prefix))) return;
        link.setAttribute('href', `${url.pathname}${url.search}${url.hash}`);
      } catch {
        // Ignore invalid referrers.
      }
    })();
  </script>
</BaseLayout>
