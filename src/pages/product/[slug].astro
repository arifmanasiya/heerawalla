---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import { loadProducts } from '../../lib/products';
import type { Product } from '../../lib/schema';

export async function getStaticPaths() {
  const products = await loadProducts();
  return products.map((product) => ({
    params: { slug: product.slug },
    props: { product }
  }));
}

const { product } = Astro.props as { product: Product };
const rawImage = product.image?.trim();
const image = rawImage ? (rawImage.startsWith('http') ? rawImage : rawImage) : '/images/products/placeholder.svg';
const priceData = {
  usd: product.price_usd,
  inr: product.price_inr
};

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Product',
  name: product.name,
  image,
  description: product.description,
  sku: product.id,
  brand: { '@type': 'Brand', name: 'Heerawalla' },
  offers: [
    {
      '@type': 'Offer',
      price: product.price_usd,
      priceCurrency: 'USD',
      availability: 'https://schema.org/InStock'
    },
    {
      '@type': 'Offer',
      price: product.price_inr,
      priceCurrency: 'INR',
      availability: 'https://schema.org/InStock'
    }
  ]
};
const jsonLdString = JSON.stringify(jsonLd);
void jsonLdString;
---

<BaseLayout title={`${product.name} | Heerawalla`} description={product.description}>
  <Header />
  <main class="container py-10 space-y-8">
    <Breadcrumbs crumbs={[{ label: 'Home', href: '/' }, { label: 'Collections', href: '/collections' }, { label: product.name }]} />
    <div class="grid gap-8 lg:grid-cols-2">
      <div class="card overflow-hidden">
        <img src={image} alt={product.name} class="w-full h-full object-cover" loading="lazy" />
      </div>
      <div class="space-y-6">
        <div>
          <p class="text-xs uppercase tracking-[0.18em] text-slate-500">{product.collection || product.category}</p>
          <h1 class="text-3xl font-semibold tracking-tight">{product.name}</h1>
        </div>
        <div class="flex items-center gap-4">
          <span
            class="text-xl font-semibold"
            data-price-usd={priceData.usd}
            data-price-inr={priceData.inr}
          ></span>
          <span class="text-sm text-slate-500">{product.metal}</span>
        </div>
        <p class="text-sm leading-relaxed text-slate-600 whitespace-pre-line">{product.description}</p>

        <div class="space-y-3">
          <div class="text-sm font-semibold">Details</div>
          <ul class="text-sm text-slate-600 list-disc list-inside space-y-1">
            <li>Metal: {product.metal || 'Precious metal'}</li>
            <li>Collection: {product.collection || 'Signature'}</li>
            <li>Category: {product.category || 'Jewelry'}</li>
          </ul>
        </div>

        <div class="flex flex-wrap gap-3">
          <a class="btn btn-primary" href={`mailto:hello@heerawalla.com?subject=Inquiry: ${encodeURIComponent(product.name)}`}>
            Inquire
          </a>
          <a class="btn btn-ghost" href="/contact">Book a consultation</a>
        </div>
      </div>
    </div>
  </main>
  <Footer />

  <script type="application/ld+json" is:inline>
    {jsonLdString}
  </script>
</BaseLayout>
