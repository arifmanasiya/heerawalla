---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import { loadProductsWithMedia, type ProductWithMedia } from '../../lib/products';
import { loadSiteConfig, getConfigValue } from '../../lib/config';
import { withBase } from '../../lib/paths';

export async function getStaticPaths() {
  const products = await loadProductsWithMedia();
  return products.map((product) => ({
    params: { slug: product.slug },
    props: { product }
  }));
}

const { product } = Astro.props as { product: ProductWithMedia };
const config = await loadSiteConfig();
const atelierApiBase = getConfigValue(config, 'atelier_api_base', 'https://admin-api.heerawalla.com');
const catalogUrl = import.meta.env.PUBLIC_CATALOG_API_URL || '';
const catalogMode = (import.meta.env.PUBLIC_CATALOG_MODE || 'hybrid').toLowerCase();
const primaryMedia = product.media.images[0]?.url || product.media.videos[0]?.url;
const rawImage = primaryMedia;
const fallback = withBase('/images/products/placeholder.svg');
const image = rawImage ? (rawImage.startsWith('http') ? rawImage : withBase(rawImage)) : fallback;
const imageMeta = product.media.images.map((m) => ({ url: m.url, description: m.description || '' }));
const imageCount = imageMeta.length;
const applyDiscount = (value: number, pct?: number) => {
  const ratio = 1 + (pct ?? 0) / 100;
  return Math.round(value * ratio * 100) / 100;
};
const roundTo99 = (value: number) => {
  if (!Number.isFinite(value)) return value;
  const lower = Math.floor(value / 100) * 100 + 99;
  const upper = Math.ceil(value / 100) * 100 + 99;
  return Math.abs(value - lower) <= Math.abs(value - upper) ? lower : upper;
};
const parseList = (value?: string) => {
  if (value === undefined || value === null) return [];
  if (Array.isArray(value)) {
    return value.map((item) => String(item).trim()).filter(Boolean);
  }
  if (typeof value === 'string') {
    return value
      .split(/[|,]/)
      .map((item) => item.trim())
      .filter(Boolean);
  }
  if (typeof value === 'number' || typeof value === 'boolean') {
    return [String(value)];
  }
  return [];
};
const normalizeStoneType = (value: string) =>
  value
    .replace(/diamond\(s\)/gi, 'Diamond')
    .replace(/diamonds?\b/gi, 'Diamond')
    .replace(/\s+/g, ' ')
    .trim();
const baseUsd = product.price_usd_natural;
const labDiscountPct = product.lab_discount_pct ?? -20;
const metal14DiscountPct = product.metal_14k_discount_pct ?? -5;
const platinumPremiumPct = product.metal_platinum_premium ?? 10;
const labUsd = applyDiscount(baseUsd, labDiscountPct);
const baseUsdRounded = roundTo99(baseUsd);
const labUsdRounded = roundTo99(labUsd);
const stoneTypes = parseList(product.stone_type_options || product.stone_types)
  .map(normalizeStoneType)
  .filter(Boolean);
const naturalAvailable = stoneTypes.some((item) => /natural/i.test(item));
const labAvailable = stoneTypes.some((item) => /lab/i.test(item));
const naturalStoneLabel =
  stoneTypes.find((item) => /natural/i.test(item)) || 'Natural Diamond';
const labStoneLabel =
  stoneTypes.find((item) => /lab/i.test(item)) || 'Lab Grown Diamond';
const stoneOptions = [
  ...(naturalAvailable
    ? [{ value: naturalStoneLabel, label: naturalStoneLabel, mode: 'natural' }]
    : []),
  ...(labAvailable ? [{ value: labStoneLabel, label: labStoneLabel, mode: 'lab' }] : [])
];
const hasStoneOptions = stoneOptions.length > 0;
const parseOptionList = (value: unknown) => {
  if (value === null || value === undefined) return [];
  if (Array.isArray(value)) {
    return value.map((item) => String(item).trim()).filter(Boolean);
  }
  if (typeof value === 'string') {
    return value
      .split('|')
      .map((item) => item.trim())
      .filter(Boolean);
  }
  if (typeof value === 'number' || typeof value === 'boolean') {
    return [String(value)];
  }
  return [];
};
const stoneWeightOptions = parseOptionList(
  product.stone_weight_range || (product.stone_weight === undefined ? '' : String(product.stone_weight))
);
const hasStoneWeight = stoneWeightOptions.length > 0;
const metalWeightOptions = parseOptionList(
  product.metal_weight_range || (product.metal_weight === undefined ? '' : String(product.metal_weight))
);
const hasMetalWeight = metalWeightOptions.length > 0;
const clarityOptions = parseList(product.clarity_range || product.clarity);
const colorOptions = parseList(product.color_range || product.color);
const cutOptions = parseList(product.cut_range || product.cut);
const diamondDefault = hasStoneOptions
  ? labAvailable
    ? labStoneLabel
    : naturalAvailable
      ? naturalStoneLabel
      : naturalStoneLabel
  : naturalStoneLabel;
const defaultDiamondUsd = /lab/i.test(diamondDefault) ? labUsd : baseUsd;
const metalOptionLabels = parseList(product.metal_options || product.metals || product.metal);
const metalOptions =
  metalOptionLabels.length > 0
    ? metalOptionLabels.map((label) => ({ value: label, label }))
    : (() => {
        const metalBase = product.metal || '18K Gold';
        const normalized = metalBase.toLowerCase();
        const colors = [];
        if (normalized.includes('yellow')) colors.push('Yellow');
        if (normalized.includes('white')) colors.push('White');
        if (normalized.includes('rose')) colors.push('Rose');
        const palette = colors.length ? colors : ['Yellow', 'White'];
        return [
          ...palette.map((color) => ({
            value: `18K ${color} Gold`,
            label: `18K ${color} Gold`
          })),
          ...palette.map((color) => ({
            value: `14K ${color} Gold`,
            label: `14K ${color} Gold`
          })),
          { value: 'Platinum', label: 'Platinum' }
        ];
      })();
const defaultMetalValue = metalOptions[0]?.value || '18K Gold';
const defaultMetalLabel = metalOptions[0]?.label || defaultMetalValue;
const diamondDefaultLabel = diamondDefault === 'lab' ? labStoneLabel : naturalStoneLabel;
const defaultUsd = Number.isFinite(defaultDiamondUsd) && defaultDiamondUsd > 0
  ? roundTo99(defaultDiamondUsd)
  : null;
const usdFormatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
const designCode = product.design_code || 'Signature';
const designCodeSlug = designCode.toLowerCase();
const isDesignCode = ['axis', 'continuum', 'eclipse'].includes(designCodeSlug);
const designCodeHref = (() => {
  if (!isDesignCode) return withBase('/inspirations');
  const category = product.category || '';
  if (category.startsWith('men/')) {
    return withBase(`/mens-jewelry?design_code=${designCodeSlug}`);
  }
  if (category.startsWith('women/')) {
    return withBase(`/womens-jewelry?design_code=${designCodeSlug}`);
  }
  if (category.startsWith('unisex/')) {
    return withBase(`/womens-jewelry?design_code=${designCodeSlug}`);
  }
  return withBase(`/womens-jewelry?design_code=${designCodeSlug}`);
})();
const editionHrefMap: Record<string, string> = {
  women: withBase('/womens-jewelry'),
  men: withBase('/mens-jewelry')
};
const editionLabel = (() => {
  const category = product.category || '';
  const group = category.split('/')[0] || '';
  if (group === 'women') return "Women's Edition";
  if (group === 'men') return "Men's Edition";
  if (group === 'unisex') return 'Unisex Edition';
  return product.collection || product.category || '';
})();
const groupLabel = editionLabel || product.collection || product.category || '';
const editionKey = (product.category || '').split('/')[0] || '';
const editionHref = editionHrefMap[editionKey];
const breadcrumbCrumbs = [
  { label: 'Home', href: withBase('/') },
  { label: designCode, href: designCodeHref, kind: 'design-code' },
  ...(editionHref ? [{ label: editionLabel, href: editionHref }] : []),
  { label: product.name }
];
const bespokeHref = withBase(`/bespoke/${product.slug}`);

const sizeSpec = (() => {
  const tags = (() => {
    const base = parseList(product.tags).map((tag) => tag.toLowerCase());
    if (base.length) return base;
    const category = (product.category || '').split('/').pop();
    return category ? [category.toLowerCase()] : [];
  })();
  const hasTag = (values: string[]) => values.some((value) => tags.includes(value));
  if (hasTag(['ring', 'rings', 'band', 'bands'])) {
    return {
      label: 'Ring size',
      options: ['4', '4.5', '5', '5.5', '6', '6.5', '7', '7.5', '8', '8.5', '9', '9.5', '10', '10.5', '11', '11.5', '12']
    };
  }
  if (hasTag(['bracelet', 'bracelets', 'bangle', 'bangles'])) {
    return {
      label: 'Bracelet length',
      options: ['6"', '6.5"', '7"', '7.5"', '8"']
    };
  }
  if (hasTag(['necklace', 'necklaces', 'pendant', 'pendants', 'chain', 'chains'])) {
    return {
      label: 'Chain length',
      options: ['16"', '18"', '20"', '22"', '24"']
    };
  }
  if (hasTag(['earring', 'earrings'])) {
    return {
      label: 'Earring size',
      options: ['Standard']
    };
  }
  return null;
})();
const productSlug = product.slug;

const offers = [
  ...(naturalAvailable
    ? [
        {
          '@type': 'Offer',
          price: baseUsdRounded,
          priceCurrency: 'USD',
          availability: 'https://schema.org/InStock'
        }
      ]
    : []),
  ...(labAvailable && (!naturalAvailable || labUsd !== baseUsd)
    ? [
        {
          '@type': 'Offer',
          price: labUsdRounded,
          priceCurrency: 'USD',
          availability: 'https://schema.org/InStock'
        }
      ]
    : [])
];
const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Product',
  name: product.name,
  image: product.media.images.length
    ? product.media.images.map((m) => m.url)
    : [image],
  description: product.description,
  sku: product.id,
  brand: { '@type': 'Brand', name: 'Heerawalla' },
  offers
};
const jsonLdString = JSON.stringify(jsonLd);
void jsonLdString;
---

<BaseLayout
  title={`${product.name} | Heerawalla`}
  description={product.description}
  breadcrumbs={breadcrumbCrumbs}
>
  <Header />
  <main class="container py-10 space-y-8">
    <Breadcrumbs crumbs={breadcrumbCrumbs} />
    <div class="grid gap-8 lg:grid-cols-2 items-start">
      <div class="card relative bg-white">
        <div class="relative flex items-center justify-center overflow-hidden rounded-2xl bg-white">
          <img
            src={image}
            alt={product.name}
            class="block max-h-[70vh] w-auto max-w-full object-contain"
            loading="lazy"
            decoding="async"
            fetchpriority="high"
            data-product-image
            data-product-image-meta={JSON.stringify(imageMeta)}
            data-protected-image
          />
        </div>
        {imageCount > 1 ? (
          <button
            type="button"
            class="absolute left-3 top-1/2 -translate-y-1/2 inline-flex h-10 w-10 items-center justify-center rounded-full border border-white/70 bg-white/90 text-lg font-semibold text-ink shadow-sm backdrop-blur transition hover:bg-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ink"
            data-image-prev
            aria-label="Previous image"
          >
            &larr;
          </button>
        ) : null}
        {imageCount > 1 ? (
          <button
            type="button"
            class="absolute right-3 top-1/2 -translate-y-1/2 inline-flex h-10 w-10 items-center justify-center rounded-full border border-white/70 bg-white/90 text-lg font-semibold text-ink shadow-sm backdrop-blur transition hover:bg-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ink"
            data-image-next
            aria-label="Next image"
          >
            &rarr;
          </button>
        ) : null}
      </div>
      <div class="space-y-6">
        <div>
          <h1 class="text-3xl font-semibold tracking-tight">{product.name}</h1>
        </div>
        <div class="flex flex-wrap items-center gap-2 text-xs uppercase tracking-[0.18em] text-slate-500">
          <a href={designCodeHref} class="hover:text-ink">{designCode}</a>
          {groupLabel ? <span aria-hidden="true">|</span> : null}
          {groupLabel ? <span>{groupLabel}</span> : null}
        </div>
        <div class="space-y-2">
          <div class="flex items-center gap-4">
            <span
              class="text-xl font-semibold"
              data-pricing-api={atelierApiBase}
              data-price-base={baseUsd}
              data-lab-discount-pct={labDiscountPct}
              data-metal-14k-discount-pct={metal14DiscountPct}
              data-platinum-premium-pct={platinumPremiumPct}
              data-metal-default={defaultMetalValue}
              data-diamond-default={diamondDefault}
              id="price-display"
            >
              {defaultUsd ? usdFormatter.format(defaultUsd) : '--'}
            </span>
            <span class="text-sm text-slate-500 flex items-center gap-2">
              <span data-selected-metal>{defaultMetalLabel}</span>
              <span class="relative group">
                <button
                  type="button"
                  class="inline-flex h-4 w-4 items-center justify-center rounded-full border border-slate-300 text-[10px] text-slate-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ink focus-visible:ring-offset-2 focus-visible:ring-offset-white"
                  aria-describedby="gold-tooltip"
                >
                  i
                </button>
                <span
                  id="gold-tooltip"
                  role="tooltip"
                  class="pointer-events-none absolute left-0 top-full z-10 mt-2 w-60 max-w-[90vw] translate-x-0 border border-slate-200 bg-white px-3 py-2 text-[11px] leading-relaxed text-slate-600 opacity-0 transition-opacity duration-200 group-hover:opacity-100 group-focus-within:opacity-100 sm:left-1/2 sm:-translate-x-1/2"
                >
                  For daily wear, 14K offers added durability; 18K brings richer color, and platinum adds a bright, weighty finish.
                </span>
              </span>
              <span
                class={`relative group inline-flex items-center gap-1${hasStoneOptions ? '' : ' hidden'}`}
                data-stone-summary
              >
                <span data-selected-stone>{diamondDefaultLabel}</span>
                <button
                  type="button"
                  class="inline-flex h-4 w-4 items-center justify-center rounded-full border border-slate-300 text-[10px] text-slate-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ink focus-visible:ring-offset-2 focus-visible:ring-offset-white"
                  aria-describedby="diamond-quality-tooltip"
                >
                  i
                </button>
                <span
                  id="diamond-quality-tooltip"
                  class="pointer-events-none absolute left-0 top-full z-10 mt-2 w-60 max-w-[90vw] translate-x-0 border border-slate-200 bg-white px-3 py-2 text-[11px] leading-relaxed text-slate-600 opacity-0 transition-opacity duration-200 group-hover:opacity-100 group-focus-within:opacity-100 sm:left-1/2 sm:-translate-x-1/2"
                  role="tooltip"
                >
                  Pricing reflects top-quality diamonds (ideal cut, VVS1-VVS2, E-F color).
                </span>
              </span>
            </span>
          </div>
          <div class="flex items-center gap-2 text-xs uppercase tracking-[0.2em] text-slate-500">
            <span>Estimated price</span>
            <div class="relative group">
              <button
                type="button"
                class="inline-flex h-4 w-4 items-center justify-center rounded-full border border-slate-300 text-[10px] text-slate-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ink focus-visible:ring-offset-2 focus-visible:ring-offset-white"
                aria-describedby="price-tooltip"
              >
                i
              </button>
              <span
                id="price-tooltip"
                role="tooltip"
                class="pointer-events-none absolute left-0 top-full z-10 mt-2 w-60 max-w-[90vw] translate-x-0 border border-slate-200 bg-white px-3 py-2 text-[11px] leading-relaxed text-slate-600 opacity-0 transition-opacity duration-200 group-hover:opacity-100 group-focus-within:opacity-100 sm:left-1/2 sm:-translate-x-1/2"
              >
                Final pricing is confirmed after consultation based on metal, diamond choice, and sizing.
              </span>
            </div>
          </div>
          <div class="grid gap-3 sm:grid-cols-2">
            <label
              class={`text-sm space-y-1${hasStoneOptions ? '' : ' hidden'}`}
              data-stone-field
            >
              <span class="text-xs uppercase tracking-[0.18em] text-slate-500">Stone Type</span>
              <select
                class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm text-ink"
                data-stone-select
                disabled={!hasStoneOptions}
              >
                {stoneOptions.length ? (
                  stoneOptions.map((option) => (
                    <option value={option.value} selected={option.value === diamondDefault}>
                      {option.label}
                    </option>
                  ))
                ) : (
                  <option value="">None</option>
                )}
              </select>
            </label>
            <label class="text-sm space-y-1">
              <span class="text-xs uppercase tracking-[0.18em] text-slate-500">Metal Type</span>
              <select
                class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm text-ink"
                data-metal-select
              >
                {metalOptions.map((option) => (
                  <option value={option.value} selected={option.value === defaultMetalValue}>
                    {option.label}
                  </option>
                ))}
              </select>
            </label>
            <label
              class={`text-sm space-y-1${hasStoneWeight ? '' : ' hidden'}`}
              data-stone-weight-field
            >
              <span class="text-xs uppercase tracking-[0.18em] text-slate-500">Stone Weight</span>
              <select
                class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm text-ink"
                data-stone-weight-select
                disabled={!hasStoneWeight}
              >
                {stoneWeightOptions.length ? (
                  stoneWeightOptions.map((option) => (
                    <option value={option} selected={stoneWeightOptions[0] === option}>
                      {option}
                    </option>
                  ))
                ) : (
                  <option value="">Not specified</option>
                )}
              </select>
              <span class="text-xs text-slate-500" data-stone-weight-total></span>
            </label>
            <label
              class={`text-sm space-y-1${hasMetalWeight ? '' : ' hidden'}`}
              data-metal-weight-field
            >
              <span class="text-xs uppercase tracking-[0.18em] text-slate-500">Metal Weight</span>
              <select
                class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm text-ink"
                data-metal-weight-select
                disabled={!hasMetalWeight}
              >
                {metalWeightOptions.length ? (
                  metalWeightOptions.map((option) => (
                    <option value={option} selected={metalWeightOptions[0] === option}>
                      {option} g
                    </option>
                  ))
                ) : (
                  <option value="">Not specified</option>
                )}
              </select>
            </label>
            <label
              class={`text-sm space-y-1${clarityOptions.length ? '' : ' hidden'}`}
              data-clarity-field
            >
              <span class="text-xs uppercase tracking-[0.18em] text-slate-500">Clarity</span>
              <select class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm text-ink" data-clarity-select>
                {clarityOptions.length ? (
                  clarityOptions.map((option) => (
                    <option value={option} selected={clarityOptions[0] === option}>
                      {option}
                    </option>
                  ))
                ) : (
                  <option value="">Standard</option>
                )}
              </select>
            </label>
            <label
              class={`text-sm space-y-1${colorOptions.length ? '' : ' hidden'}`}
              data-color-field
            >
              <span class="text-xs uppercase tracking-[0.18em] text-slate-500">Color</span>
              <select class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm text-ink" data-color-select>
                {colorOptions.length ? (
                  colorOptions.map((option) => (
                    <option value={option} selected={colorOptions[0] === option}>
                      {option}
                    </option>
                  ))
                ) : (
                  <option value="">Standard</option>
                )}
              </select>
            </label>
            <label
              class={`text-sm space-y-1${cutOptions.length ? '' : ' hidden'}`}
              data-cut-field
            >
              <span class="text-xs uppercase tracking-[0.18em] text-slate-500">Cut</span>
              <select class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm text-ink" data-cut-select>
                {cutOptions.length ? (
                  cutOptions.map((option) => (
                    <option value={option} selected={cutOptions[0] === option}>
                      {option}
                    </option>
                  ))
                ) : (
                  <option value="">Standard</option>
                )}
              </select>
            </label>
            <label
              class={`text-sm space-y-1${sizeSpec ? '' : ' hidden'}`}
              data-size-field
            >
              <span class="text-xs uppercase tracking-[0.18em] text-slate-500" data-size-label>
                {sizeSpec?.label || 'Size'}
              </span>
              <select
                class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm text-ink"
                data-size-select
                data-size-required={sizeSpec?.options?.length ? 'true' : 'false'}
                disabled={!sizeSpec}
              >
                {sizeSpec?.options?.length ? (
                  <>
                    <option value="" selected>Select {sizeSpec.label.toLowerCase()}</option>
                    {sizeSpec.options.map((option) => (
                      <option value={option}>{option}</option>
                    ))}
                  </>
                ) : (
                  <option value="">Not applicable</option>
                )}
              </select>
              <span class="text-xs text-slate-500" data-size-helper></span>
            </label>
          </div>
        </div>
        <p class="text-sm leading-relaxed text-slate-600 whitespace-pre-line" data-product-description>
          {product.description}
        </p>

        <div class="space-y-3">
          <div class="flex flex-wrap gap-3">
            <a
              class="btn btn-primary"
              href={bespokeHref}
              data-bespoke-link
              data-bespoke-base={bespokeHref}
            >
              Begin purchase
            </a>
            <a class="btn btn-ghost" href={withBase('/how-it-works')}>How it works</a>
          </div>
          <div class="text-xs text-rose-600 hidden" data-size-warning></div>
        </div>
      </div>
    </div>
  </main>
  <Footer />

  <script type="application/ld+json" is:inline>
    {jsonLdString}
  </script>
  <script is:inline>
    (() => {
      const mainImage = document.querySelector('[data-product-image]');
      if (!mainImage) return;
      const rawList = mainImage.getAttribute('data-product-image-meta') || '[]';
      let imageMeta = [];
      try {
        imageMeta = JSON.parse(rawList);
      } catch {
        return;
      }
      if (!Array.isArray(imageMeta) || imageMeta.length === 0) return;
      const prevBtn = document.querySelector('[data-image-prev]');
      const nextBtn = document.querySelector('[data-image-next]');
      const descEl = document.querySelector('[data-product-description]');
      const heroText = imageMeta[0]?.description || '';
      const defaultText = heroText || (descEl ? descEl.textContent || '' : '');
      let index = imageMeta.findIndex((item) => item?.url === (mainImage.getAttribute('src') || ''));
      if (index < 0) index = 0;

      const setIndex = (nextIndex) => {
        const count = imageMeta.length;
        index = ((nextIndex % count) + count) % count;
        const next = imageMeta[index];
        if (next?.url) {
          mainImage.setAttribute('src', next.url);
        }
        if (descEl) {
          descEl.textContent = next?.description || defaultText;
        }
      };

      if (descEl) {
        descEl.textContent = defaultText;
      }
      setIndex(index);

      if (imageMeta.length > 1) {
        if (prevBtn) {
          prevBtn.addEventListener('click', () => setIndex(index - 1));
        }
        if (nextBtn) {
          nextBtn.addEventListener('click', () => setIndex(index + 1));
        }
      }
    })();
  </script>
  <script is:inline>
    (() => {
      const priceEl = document.getElementById('price-display');
      if (!priceEl) return;
      const stoneSelect = document.querySelector('[data-stone-select]');
      const metalSelect = document.querySelector('[data-metal-select]');
      const stoneWeightSelect = document.querySelector('[data-stone-weight-select]');
      const metalWeightSelect = document.querySelector('[data-metal-weight-select]');
      const claritySelect = document.querySelector('[data-clarity-select]');
      const colorSelect = document.querySelector('[data-color-select]');
      const cutSelect = document.querySelector('[data-cut-select]');
      const sizeSelect = document.querySelector('[data-size-select]');
      const stoneSummary = document.querySelector('[data-stone-summary]');
      const stoneField = document.querySelector('[data-stone-field]');
      const stoneWeightTotal = document.querySelector('[data-stone-weight-total]');
      const sizeHelper = document.querySelector('[data-size-helper]');
      const selectedMetal = document.querySelector('[data-selected-metal]');
      const selectedStone = document.querySelector('[data-selected-stone]');
      const bespokeLink = document.querySelector('[data-bespoke-link]');
      const pricingApi = (priceEl.dataset.pricingApi || '').replace(/\/$/, '');
      const baseUsd = Number(priceEl.dataset.priceBase || '');
      const labDiscountPct = Number(priceEl.dataset.labDiscountPct || '');
      const metal14DiscountPct = Number(priceEl.dataset.metal14kDiscountPct || '');
      const platinumPremiumPct = Number(priceEl.dataset.platinumPremiumPct || '');
      const bespokeBase = bespokeLink ? (bespokeLink.getAttribute('data-bespoke-base') || bespokeLink.getAttribute('href') || '') : '';
      const sizeLabelEl = document.querySelector('[data-size-label]');
      const sizeWarning = document.querySelector('[data-size-warning]');
      const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
      const roundTo99 = (value) => {
        if (!Number.isFinite(value)) return value;
        const rounded = Math.round(value / 100) * 100;
        return rounded > 0 ? rounded - 1 : value;
      };
      const applyPercent = (value, percent) => value * (1 + percent / 100);
      const computeFallbackPrice = () => {
        if (!Number.isFinite(baseUsd) || baseUsd <= 0) return null;
        let price = baseUsd;
        const stoneLabel = stoneSelect ? stoneSelect.value : '';
        if (stoneLabel && /lab/i.test(stoneLabel)) {
          price = applyPercent(price, Number.isFinite(labDiscountPct) ? labDiscountPct : -20);
        }
        const metalLabel = metalSelect ? metalSelect.value : '';
        if (/14k/i.test(metalLabel)) {
          price = applyPercent(price, Number.isFinite(metal14DiscountPct) ? metal14DiscountPct : -5);
        } else if (/platinum/i.test(metalLabel)) {
          price = applyPercent(price, Number.isFinite(platinumPremiumPct) ? platinumPremiumPct : 10);
        }
        return roundTo99(price);
      };
      const setSelectValue = (select, value) => {
        if (!select) return;
        const options = Array.from(select.options);
        if (!options.length) return;
        const match = options.find((option) => option.value === value);
        select.value = match ? value : options[0].value;
      };
      const parseBreakdown = (value) => {
        if (!value) return [];
        return String(value)
          .split(/\\n|;|,|\\|/)
          .map((entry) => entry.trim())
          .filter(Boolean)
          .map((entry) => {
            const match = entry.match(/([0-9]*\\.?[0-9]+)\\s*(?:ct)?\\s*[xX]\\s*([0-9]*\\.?[0-9]+)/);
            if (match) {
              return { weight: Number(match[1]), count: Number(match[2]) };
            }
            const numbers = entry.match(/[0-9]*\\.?[0-9]+/g) || [];
            if (numbers.length >= 2) {
              const first = Number(numbers[0]);
              const second = Number(numbers[1]);
              const weight = first <= second ? first : second;
              const count = first <= second ? second : first;
              return { weight, count };
            }
            if (numbers.length === 1) {
              return { weight: Number(numbers[0]), count: 1 };
            }
            return { weight: 0, count: 0 };
          })
          .filter((entry) => Number.isFinite(entry.weight) && entry.weight > 0 && Number.isFinite(entry.count) && entry.count > 0);
      };
      const getStoneWeightTotals = () => {
        if (!stoneWeightSelect || !stoneWeightSelect.value) return { total: 0, isBreakdown: false };
        const raw = String(stoneWeightSelect.value || '');
        const breakdown = parseBreakdown(raw);
        if (breakdown.length) {
          const total = breakdown.reduce((sum, piece) => sum + piece.weight * piece.count, 0);
          return { total, isBreakdown: true };
        }
        const numeric = Number(raw.replace(/[^0-9.]/g, ''));
        return { total: Number.isFinite(numeric) ? numeric : 0, isBreakdown: false };
      };
      const getSelectLabel = (select) => {
        if (!select) return '';
        const option = select.options[select.selectedIndex];
        return option ? option.textContent || '' : '';
      };
      const isSizeRequired = () =>
        sizeSelect && sizeSelect.getAttribute('data-size-required') === 'true';
      const sizeLabel = () => (sizeLabelEl ? (sizeLabelEl.textContent || '').trim() : 'size');
      const setPurchaseState = (showMessage) => {
        if (!bespokeLink) return true;
        const missingSize = isSizeRequired() && sizeSelect && !sizeSelect.value;
        if (missingSize) {
          bespokeLink.setAttribute('aria-disabled', 'true');
          bespokeLink.dataset.disabled = 'true';
          bespokeLink.classList.add('opacity-60', 'cursor-not-allowed');
          if (sizeWarning && showMessage) {
            sizeWarning.textContent = `Select ${sizeLabel().toLowerCase()} to begin purchase.`;
            sizeWarning.classList.remove('hidden');
          }
          return false;
        }
        bespokeLink.removeAttribute('aria-disabled');
        delete bespokeLink.dataset.disabled;
        bespokeLink.classList.remove('opacity-60', 'cursor-not-allowed');
        if (sizeWarning) {
          sizeWarning.classList.add('hidden');
        }
        return true;
      };
      const buildPayload = () => ({
        metal: metalSelect ? metalSelect.value : '',
        metal_weight: metalWeightSelect ? metalWeightSelect.value : '',
        stone: stoneSelect ? stoneSelect.value : '',
        stone_weight: (() => {
          if (!stoneWeightSelect) return '';
          const totals = getStoneWeightTotals();
          if (totals.isBreakdown && totals.total > 0) {
            return totals.total.toFixed(2);
          }
          return stoneWeightSelect.value || '';
        })(),
        diamond_breakdown: (() => {
          if (!stoneWeightSelect) return '';
          const totals = getStoneWeightTotals();
          if (totals.isBreakdown) {
            return stoneWeightSelect.value || '';
          }
          return '';
        })(),
        size: sizeSelect ? sizeSelect.value : '',
        size_label: sizeLabelEl ? sizeLabelEl.textContent || '' : '',
        clarity: claritySelect ? claritySelect.value : '',
        color: colorSelect ? colorSelect.value : '',
        cut: cutSelect ? cutSelect.value : ''
      });
      let refreshToken = 0;
      const refreshPrice = async () => {
        const payload = buildPayload();
        const fallbackPrice = computeFallbackPrice();
        if (!pricingApi || !payload.metal_weight) {
          if (Number.isFinite(fallbackPrice)) {
            priceEl.textContent = formatter.format(fallbackPrice);
          } else {
            priceEl.textContent = '--';
          }
          return;
        }
        const requestId = ++refreshToken;
        priceEl.textContent = 'Calculating...';
        try {
          const response = await fetch(`${pricingApi}/pricing/estimate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await response.json().catch(() => ({}));
          if (requestId !== refreshToken) return;
          if (!response.ok || !data?.ok) {
            if (Number.isFinite(fallbackPrice)) {
              priceEl.textContent = formatter.format(fallbackPrice);
            } else {
              priceEl.textContent = '--';
            }
            return;
          }
          priceEl.textContent = formatter.format(data.price || 0);
        } catch {
          if (requestId !== refreshToken) return;
          if (Number.isFinite(fallbackPrice)) {
            priceEl.textContent = formatter.format(fallbackPrice);
          } else {
            priceEl.textContent = '--';
          }
        }
      };
      const apply = (refreshDefaults) => {
        const hasStoneOptions = Boolean(stoneSelect && stoneSelect.options.length);
        if (refreshDefaults) {
          if (stoneSelect && hasStoneOptions) {
            const defaultStone = priceEl.dataset.diamondDefault || stoneSelect.value;
            setSelectValue(stoneSelect, defaultStone);
          }
          if (metalSelect) {
            setSelectValue(metalSelect, priceEl.dataset.metalDefault || metalSelect.value);
          }
        }
        if (stoneField) {
          stoneField.classList.toggle('hidden', !hasStoneOptions);
        }
        if (stoneSummary) {
          stoneSummary.classList.toggle('hidden', !hasStoneOptions);
        }
        if (stoneWeightTotal) {
          const totals = getStoneWeightTotals();
          if (totals.total > 0) {
            stoneWeightTotal.textContent = `Total: ${totals.total.toFixed(2)} ct`;
          } else {
            stoneWeightTotal.textContent = '';
          }
        }
        if (sizeHelper) {
          sizeHelper.textContent = '';
        }
        refreshPrice();
        if (selectedMetal && metalSelect) {
          selectedMetal.textContent = getSelectLabel(metalSelect);
        }
        if (selectedStone && stoneSelect && hasStoneOptions) {
          selectedStone.textContent = getSelectLabel(stoneSelect);
        }
        if (bespokeLink && bespokeBase) {
          const params = new URLSearchParams();
          if (metalSelect?.value) params.set('metal', metalSelect.value);
          if (hasStoneOptions && stoneSelect?.value) params.set('stone', stoneSelect.value);
          if (stoneWeightSelect && stoneWeightSelect.value) {
            params.set('stoneWeight', stoneWeightSelect.value);
          }
          if (metalWeightSelect && metalWeightSelect.value) {
            params.set('metalWeight', metalWeightSelect.value);
          }
          if (claritySelect && claritySelect.value) {
            params.set('clarity', claritySelect.value);
          }
          if (colorSelect && colorSelect.value) {
            params.set('color', colorSelect.value);
          }
          if (cutSelect && cutSelect.value) {
            params.set('cut', cutSelect.value);
          }
          if (sizeSelect && sizeSelect.value) {
            params.set('size', sizeSelect.value);
          }
          if (priceEl.textContent) {
            params.set('price', priceEl.textContent.replace(/[^0-9.]/g, ''));
          }
          params.set('source', 'product');
          bespokeLink.setAttribute('href', `${bespokeBase}?${params.toString()}`);
        }
        setPurchaseState(false);
      };
      if (stoneSelect) {
        stoneSelect.addEventListener('change', () => apply(false));
      }
      if (metalSelect) {
        metalSelect.addEventListener('change', () => apply(false));
      }
      if (stoneWeightSelect) {
        stoneWeightSelect.addEventListener('change', () => apply(false));
      }
      if (metalWeightSelect) {
        metalWeightSelect.addEventListener('change', () => apply(false));
      }
      if (claritySelect) {
        claritySelect.addEventListener('change', () => apply(false));
      }
      if (colorSelect) {
        colorSelect.addEventListener('change', () => apply(false));
      }
      if (cutSelect) {
        cutSelect.addEventListener('change', () => apply(false));
      }
      if (sizeSelect) {
        sizeSelect.addEventListener('change', () => apply(false));
      }
      if (bespokeLink) {
        bespokeLink.addEventListener('click', (event) => {
          if (!setPurchaseState(true)) {
            event.preventDefault();
          }
        });
      }
      apply(true);
      window.__hwApplyPricing = () => apply(false);
      window.__hwRefreshPricingDefaults = () => apply(true);
    })();
  </script>
  <script is:inline define:vars={{ catalogUrl, catalogMode, productSlug }}>
    (() => {
      const catalogUrlValue = String(catalogUrl || '');
      const catalogModeValue = String(catalogMode || '').toLowerCase();
      const productSlugValue = String(productSlug || '');
      if (!catalogUrlValue || catalogModeValue === 'ssr' || !productSlugValue) return;

      const priceEl = document.getElementById('price-display');
      if (!priceEl) return;
      const stoneField = document.querySelector('[data-stone-field]');
      const stoneSelect = document.querySelector('[data-stone-select]');
      const metalSelect = document.querySelector('[data-metal-select]');
      const stoneWeightField = document.querySelector('[data-stone-weight-field]');
      const stoneWeightSelect = document.querySelector('[data-stone-weight-select]');
      const metalWeightField = document.querySelector('[data-metal-weight-field]');
      const metalWeightSelect = document.querySelector('[data-metal-weight-select]');
      const clarityField = document.querySelector('[data-clarity-field]');
      const claritySelect = document.querySelector('[data-clarity-select]');
      const colorField = document.querySelector('[data-color-field]');
      const colorSelect = document.querySelector('[data-color-select]');
      const cutField = document.querySelector('[data-cut-field]');
      const cutSelect = document.querySelector('[data-cut-select]');
      const sizeField = document.querySelector('[data-size-field]');
      const sizeSelect = document.querySelector('[data-size-select]');
      const sizeLabel = document.querySelector('[data-size-label]');

      const parseList = (value) => {
        if (!value) return [];
        return String(value)
          .split(/[|,]/)
          .map((item) => item.trim())
          .filter(Boolean);
      };
      const parseOptionList = (value) => {
        if (!value) return [];
        return String(value)
          .split('|')
          .map((item) => item.trim())
          .filter(Boolean);
      };

      const normalizeStoneType = (value) =>
        String(value || '')
          .replace(/diamond\\(s\\)/gi, 'Diamond')
          .replace(/diamonds?\\b/gi, 'Diamond')
          .replace(/\\s+/g, ' ')
          .trim();

      const parseMetalColors = (value) => {
        const normalized = String(value || '').toLowerCase();
        const colors = [];
        if (normalized.includes('yellow')) colors.push('yellow');
        if (normalized.includes('white')) colors.push('white');
        if (normalized.includes('rose')) colors.push('rose');
        return colors.length ? colors : ['yellow', 'white'];
      };

      const buildMetalOptions = (value, fallbackLabel) => {
        const list = parseList(value);
        if (list.length) {
          return list.map((label) => ({ value: label, label }));
        }
        const colors = parseMetalColors(fallbackLabel);
        return [
          ...colors.map((color) => ({
            value: `18K ${color.charAt(0).toUpperCase() + color.slice(1)} Gold`,
            label: `18K ${color.charAt(0).toUpperCase() + color.slice(1)} Gold`
          })),
          ...colors.map((color) => ({
            value: `14K ${color.charAt(0).toUpperCase() + color.slice(1)} Gold`,
            label: `14K ${color.charAt(0).toUpperCase() + color.slice(1)} Gold`
          })),
          { value: 'Platinum', label: 'Platinum' }
        ];
      };

      const parseNumber = (value) => {
        if (value === undefined || value === null) return undefined;
        if (typeof value === 'number') return Number.isFinite(value) ? value : undefined;
        const trimmed = String(value).trim();
        if (!trimmed) return undefined;
        const parsed = Number(trimmed);
        return Number.isFinite(parsed) ? parsed : undefined;
      };

      const setSelectOptions = (select, options, selectedValue, placeholderLabel) => {
        if (!select) return;
        select.innerHTML = '';
        if (placeholderLabel) {
          const placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.textContent = placeholderLabel;
          if (!selectedValue) placeholder.selected = true;
          select.appendChild(placeholder);
        }
        options.forEach((option) => {
          const el = document.createElement('option');
          el.value = option.value;
          el.textContent = option.label;
          if (selectedValue && option.value === selectedValue) {
            el.selected = true;
          }
          select.appendChild(el);
        });
        if (selectedValue) {
          select.value = selectedValue;
        }
      };

      const buildSizeSpec = (tagsValue, categoryValue) => {
        const tags = (() => {
          const base = parseList(tagsValue).map((tag) => tag.toLowerCase());
          if (base.length) return base;
          const category = String(categoryValue || '').split('/').pop();
          return category ? [category.toLowerCase()] : [];
        })();
        const hasTag = (values) => values.some((entry) => tags.includes(entry));
        if (hasTag(['ring', 'rings', 'band', 'bands'])) {
          return {
            label: 'Ring size',
            options: ['4', '4.5', '5', '5.5', '6', '6.5', '7', '7.5', '8', '8.5', '9', '9.5', '10', '10.5', '11', '11.5', '12']
          };
        }
        if (hasTag(['bracelet', 'bracelets', 'bangle', 'bangles'])) {
          return {
            label: 'Bracelet length',
            options: ['6"', '6.5"', '7"', '7.5"', '8"']
          };
        }
        if (hasTag(['necklace', 'necklaces', 'pendant', 'pendants', 'chain', 'chains'])) {
          return {
            label: 'Chain length',
            options: ['16"', '18"', '20"', '22"', '24"']
          };
        }
        if (hasTag(['earring', 'earrings'])) {
          return {
            label: 'Earring size',
            options: ['Standard']
          };
        }
        return null;
      };

      const updatePricingFromProduct = (item) => {
        const stoneTypes = parseList(item.stone_type_options || item.stone_types)
          .map(normalizeStoneType)
          .filter(Boolean);
        const naturalAvailable = stoneTypes.some((entry) => /natural/i.test(entry));
        const labAvailable = stoneTypes.some((entry) => /lab/i.test(entry));
        const naturalStoneLabel =
          stoneTypes.find((entry) => /natural/i.test(entry)) || 'Natural Diamond';
        const labStoneLabel =
          stoneTypes.find((entry) => /lab/i.test(entry)) || 'Lab Grown Diamond';
        const metalOptions = buildMetalOptions(item.metal_options || item.metals, item.metal || '18K Gold');
        const defaultMetalValue = metalOptions[0]?.value || '18K Gold';
        const stoneOptions = [
          ...(naturalAvailable ? [{ value: naturalStoneLabel, label: naturalStoneLabel }] : []),
          ...(labAvailable ? [{ value: labStoneLabel, label: labStoneLabel }] : [])
        ];
        const stoneWeightOptions = parseOptionList(item.stone_weight_range || item.stone_weight).map((option) => ({
          value: option,
          label: option
        }));
        const metalWeightOptions = parseOptionList(item.metal_weight_range || item.metal_weight).map((option) => ({
          value: option,
          label: option
        }));
        const clarityOptions = parseList(item.clarity_range || item.clarity).map((option) => ({
          value: option,
          label: option
        }));
        const colorOptions = parseList(item.color_range || item.color).map((option) => ({
          value: option,
          label: option
        }));
        const cutOptions = parseList(item.cut_range || item.cut).map((option) => ({
          value: option,
          label: option
        }));
        const sizeSpec = buildSizeSpec(item.tags, item.category || item.categories);

        if (stoneTypes.length) {
          priceEl.dataset.diamondDefault = labAvailable ? labStoneLabel : naturalStoneLabel;
        }
        priceEl.dataset.metalDefault = defaultMetalValue;

        if (stoneSelect && stoneTypes.length) {
          setSelectOptions(
            stoneSelect,
            stoneOptions,
            priceEl.dataset.diamondDefault || (labAvailable ? labStoneLabel : naturalStoneLabel)
          );
          stoneSelect.disabled = stoneOptions.length === 0;
        }
        if (stoneField && stoneTypes.length) {
          stoneField.classList.toggle('hidden', stoneOptions.length === 0);
        }
        if (metalSelect) {
          setSelectOptions(metalSelect, metalOptions, defaultMetalValue);
        }
        if (stoneWeightSelect) {
          setSelectOptions(stoneWeightSelect, stoneWeightOptions, stoneWeightOptions[0]?.value);
          stoneWeightSelect.disabled = stoneWeightOptions.length === 0;
        }
        if (stoneWeightField) {
          stoneWeightField.classList.toggle('hidden', stoneWeightOptions.length === 0);
        }
        if (metalWeightSelect) {
          setSelectOptions(metalWeightSelect, metalWeightOptions, metalWeightOptions[0]?.value);
          metalWeightSelect.disabled = metalWeightOptions.length === 0;
        }
        if (metalWeightField) {
          metalWeightField.classList.toggle('hidden', metalWeightOptions.length === 0);
        }
        if (claritySelect) {
          setSelectOptions(claritySelect, clarityOptions, clarityOptions[0]?.value);
          claritySelect.disabled = clarityOptions.length === 0;
        }
        if (clarityField) {
          clarityField.classList.toggle('hidden', clarityOptions.length === 0);
        }
        if (colorSelect) {
          setSelectOptions(colorSelect, colorOptions, colorOptions[0]?.value);
          colorSelect.disabled = colorOptions.length === 0;
        }
        if (colorField) {
          colorField.classList.toggle('hidden', colorOptions.length === 0);
        }
        if (cutSelect) {
          setSelectOptions(cutSelect, cutOptions, cutOptions[0]?.value);
          cutSelect.disabled = cutOptions.length === 0;
        }
        if (cutField) {
          cutField.classList.toggle('hidden', cutOptions.length === 0);
        }
        if (sizeField && sizeSelect && sizeLabel) {
          if (sizeSpec) {
            sizeField.classList.remove('hidden');
            sizeSelect.disabled = false;
            sizeLabel.textContent = sizeSpec.label;
            const sizeOptions = sizeSpec.options.map((option) => ({ value: option, label: option }));
            setSelectOptions(sizeSelect, sizeOptions, '', `Select ${sizeSpec.label.toLowerCase()}`);
          } else if (!sizeSelect.options.length) {
            sizeField.classList.add('hidden');
            sizeSelect.disabled = true;
          }
        }

        if (window.__hwRefreshPricingDefaults) {
          window.__hwRefreshPricingDefaults();
        } else if (window.__hwApplyPricing) {
          window.__hwApplyPricing();
        }
      };

      const fetchCatalog = async () => {
        const joiner = catalogUrlValue.includes('?') ? '&' : '?';
        const url = `${catalogUrlValue}${joiner}include=products`;
        try {
          const response = await fetch(url, { cache: 'no-store' });
          if (!response.ok) return;
          const data = await response.json();
          if (!data || !Array.isArray(data.products)) return;
          const match = data.products.find((entry) => entry && entry.slug === productSlugValue);
          if (!match) return;
          updatePricingFromProduct(match);
        } catch {
          // Ignore catalog errors; fall back to SSR data.
        }
      };

      fetchCatalog();
    })();
  </script>
  <script is:inline>
    (() => {
      const link = document.querySelector('[data-breadcrumb-kind="design-code"]');
      if (!(link instanceof HTMLAnchorElement)) return;
      const ref = document.referrer;
      if (!ref) return;
      try {
        const url = new URL(ref);
        if (url.origin !== window.location.origin) return;
        const path = url.pathname;
        const allowed = ['/mens-jewelry', '/womens-jewelry', '/inspirations'];
        if (!allowed.some((prefix) => path.startsWith(prefix))) return;
        link.setAttribute('href', `${url.pathname}${url.search}${url.hash}`);
      } catch {
        // Ignore invalid referrers.
      }
    })();
  </script>
</BaseLayout>
