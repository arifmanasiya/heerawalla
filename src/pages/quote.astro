---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { loadSiteConfig, getConfigValue } from '../lib/config';

const config = await loadSiteConfig();
const quoteApiBase = getConfigValue(
  config,
  'quote_api_base',
  getConfigValue(config, 'order_confirmation_api_base', 'https://admin-api.heerawalla.com')
);
const ordersEmail = getConfigValue(config, 'orders_email', 'orders@heerawalla.com');
---

<BaseLayout
  title="Quote Review | Heerawalla"
  description="Review your private Heerawalla quote and begin purchase."
>
  <Header />

  <main class="container py-12 space-y-12">
    <section class="grid gap-10 lg:grid-cols-[1.1fr_0.9fr] items-start">
      <div class="space-y-4">
        <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Private quote</p>
        <h1 class="font-display text-4xl sm:text-5xl tracking-tight text-ink">Your personal quote</h1>
        <p class="text-sm text-slate-600 max-w-xl">
          Review the curated stone and metal options below. Select your preferred combination to begin purchase.
        </p>

        <div class="border border-slate-200 bg-white p-6 space-y-5" data-quote data-quote-api={quoteApiBase}>
          <div class="text-xs uppercase tracking-[0.2em] text-slate-500">Status</div>
          <p class="text-sm text-slate-600" data-quote-status>Loading your quote details...</p>

          <div class="border-t border-slate-200 pt-4 space-y-4" data-quote-summary>
            <div class="grid gap-1">
              <div class="text-[10px] uppercase tracking-[0.2em] text-slate-500">Request</div>
              <div class="text-sm font-medium text-ink" data-quote-id>--</div>
            </div>
            <div class="grid gap-1">
              <div class="text-[10px] uppercase tracking-[0.2em] text-slate-500">Product</div>
              <div class="text-sm text-ink" data-quote-product>--</div>
            </div>
            <div class="grid gap-1">
              <div class="text-[10px] uppercase tracking-[0.2em] text-slate-500">Client</div>
              <div class="text-sm text-ink" data-quote-name>--</div>
            </div>
          </div>

          <div class="space-y-3">
            <div class="text-xs uppercase tracking-[0.2em] text-slate-500">Select metal</div>
            <div class="flex flex-wrap gap-2" data-quote-metals></div>
          </div>

          <div class="space-y-3">
            <div class="text-xs uppercase tracking-[0.2em] text-slate-500">Quote options</div>
            <div class="border border-slate-200 bg-white" data-quote-table>
              <div class="px-4 py-3 text-sm text-slate-500">Awaiting quote options.</div>
            </div>
          </div>

          <p class="text-xs text-slate-500" data-quote-expiry>
            Your private link is valid for 72 hours.
          </p>
        </div>
      </div>

      <aside class="space-y-4">
        <div class="card border border-slate-200 p-6 space-y-4">
          <div class="text-xs uppercase tracking-[0.3em] text-slate-500">How to proceed</div>
          <ul class="text-sm text-slate-600 space-y-2">
            <li>Select your preferred metal to see the updated prices.</li>
            <li>Choose an option to begin purchase and reserve the piece.</li>
            <li>Your link is private and expires in 72 hours.</li>
          </ul>
        </div>
        <div class="border border-slate-200 bg-white p-5 text-sm text-slate-600 space-y-2">
          <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Need assistance?</p>
          <p>
            Reply to the quote email or reach us at
            <a class="underline text-ink" href={`mailto:${ordersEmail}`}>{ordersEmail}</a>.
          </p>
        </div>
      </aside>
    </section>
  </main>

  <Footer />
</BaseLayout>

<script is:inline>
  (() => {
    const root = document.querySelector('[data-quote]');
    if (!root) return;
    const statusEl = root.querySelector('[data-quote-status]');
    const requestEl = root.querySelector('[data-quote-id]');
    const productEl = root.querySelector('[data-quote-product]');
    const nameEl = root.querySelector('[data-quote-name]');
    const metalsEl = root.querySelector('[data-quote-metals]');
    const tableEl = root.querySelector('[data-quote-table]');
    const expiryEl = root.querySelector('[data-quote-expiry]');
    const apiBase = root.getAttribute('data-quote-api') || '';
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token') || params.get('t') || params.get('quote');

    const setStatus = (message, tone) => {
      if (!statusEl) return;
      statusEl.textContent = message;
      statusEl.classList.remove('text-slate-600', 'text-rose-600', 'text-emerald-600');
      if (tone === 'error') {
        statusEl.classList.add('text-rose-600');
      } else if (tone === 'success') {
        statusEl.classList.add('text-emerald-600');
      } else {
        statusEl.classList.add('text-slate-600');
      }
    };

    const formatMoney = (value) => {
      if (value === undefined || value === null || Number.isNaN(Number(value))) return '--';
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(
        Number(value)
      );
    };

    const requestJson = async (path, options = {}) => {
      if (!apiBase) throw new Error('missing_api');
      const base = apiBase.replace(/\/$/, '');
      const response = await fetch(`${base}${path}`, {
        headers: { 'Content-Type': 'application/json' },
        ...options,
      });
      if (!response.ok) {
        const text = await response.text();
        throw new Error(text || 'request_failed');
      }
      return await response.json();
    };

    if (!token) {
      setStatus('This quote link is missing or invalid. Please contact the concierge.', 'error');
      return;
    }

    let quoteData = null;
    let selectedMetal = '';

    const renderMetals = (metals) => {
      if (!metalsEl) return;
      metalsEl.innerHTML = '';
      metals.forEach((metal) => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className =
          'px-4 py-2 rounded-full border text-xs uppercase tracking-[0.2em] ' +
          (metal === selectedMetal ? 'border-ink bg-ink text-white' : 'border-slate-200 text-slate-600');
        button.textContent = metal;
        button.addEventListener('click', () => {
          selectedMetal = metal;
          renderMetals(metals);
          renderTable();
        });
        metalsEl.appendChild(button);
      });
    };

    const renderTable = () => {
      if (!tableEl || !quoteData) return;
      const options = quoteData.options || [];
      if (!options.length) {
        tableEl.innerHTML = '<div class="px-4 py-3 text-sm text-slate-500">No quote options available.</div>';
        return;
      }
      const headerCells = options
        .map((option, index) => {
          const label = [option.clarity, option.color].filter(Boolean).join(' Â· ') || `Option ${index + 1}`;
          return `<th class="px-4 py-3 text-left text-xs uppercase tracking-[0.2em] text-slate-500 border-b border-slate-200">${label}</th>`;
        })
        .join('');
      const priceCells = options
        .map((option) => {
          const price = option.prices?.[selectedMetal] ?? option.price18k;
          return `<td class="px-4 py-4 text-lg font-medium text-ink border-b border-slate-200">${formatMoney(price)}</td>`;
        })
        .join('');
      const actionCells = options
        .map(
          (_, index) =>
            `<td class="px-4 py-4 border-b border-slate-200"><button class="btn btn-primary w-full" data-quote-select="${index}">Begin purchase</button></td>`
        )
        .join('');

      tableEl.innerHTML = `
        <table class="w-full text-sm">
          <thead>
            <tr>${headerCells}</tr>
          </thead>
          <tbody>
            <tr><td class="px-4 py-2 text-xs uppercase tracking-[0.2em] text-slate-500 border-b border-slate-200">Price (${selectedMetal})</td>${priceCells}</tr>
            <tr><td class="px-4 py-2 text-xs uppercase tracking-[0.2em] text-slate-500">Action</td>${actionCells}</tr>
          </tbody>
        </table>
      `;

      tableEl.querySelectorAll('[data-quote-select]').forEach((button) => {
        button.addEventListener('click', async () => {
          const optionIndex = Number(button.getAttribute('data-quote-select'));
          setStatus('Confirming your selection...', 'success');
          try {
            const result = await requestJson('/quotes/confirmation/accept', {
              method: 'POST',
              body: JSON.stringify({ token, metal: selectedMetal, optionIndex }),
            });
            const paymentUrl = result.paymentUrl || result.checkoutUrl || result.url;
            if (paymentUrl) {
              window.location.href = paymentUrl;
              return;
            }
            setStatus('Selection received. We will follow up with secure checkout.', 'success');
          } catch (error) {
            setStatus('We could not confirm this selection. Please contact the concierge.', 'error');
          }
        });
      });
    };

    const loadQuote = async () => {
      setStatus('Loading your quote details...');
      try {
        const data = await requestJson(`/quotes/confirmation?token=${encodeURIComponent(token)}`);
        quoteData = data;
        const status = data.status || 'pending';

        if (requestEl) requestEl.textContent = data.requestId || '--';
        if (productEl) productEl.textContent = data.productName || '--';
        if (nameEl) nameEl.textContent = data.name || '--';
        if (expiryEl && data.expiresAt) {
          const expiresAt = new Date(data.expiresAt);
          if (!Number.isNaN(expiresAt.getTime())) {
            expiryEl.textContent = `Quote valid until ${expiresAt.toLocaleString()}.`;
          }
        }

        if (status !== 'pending') {
          const statusMessage =
            status === 'accepted'
              ? 'This quote has already been used. We will follow up with secure checkout.'
              : 'This quote link has already been used or expired.';
          setStatus(statusMessage, status === 'accepted' ? 'success' : 'error');
          return;
        }

        const metals = Array.isArray(data.metals) && data.metals.length ? data.metals : ['18K'];
        selectedMetal = data.selectedMetal || metals[0];
        renderMetals(metals);
        renderTable();
        setStatus('Select your preferred metal and option to continue.', 'success');
      } catch (error) {
        setStatus('We could not load your quote. Please contact the concierge.', 'error');
      }
    };

    loadQuote();
  })();
</script>
