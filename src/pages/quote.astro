---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { loadSiteConfig, getConfigValue } from '../lib/config';

const config = await loadSiteConfig();
const quoteApiBase = getConfigValue(
  config,
  'quote_api_base',
  getConfigValue(config, 'order_confirmation_api_base', 'https://admin-api.heerawalla.com')
);
const ordersEmail = getConfigValue(config, 'orders_email', 'atelier@heerawalla.com');
---

<BaseLayout
  title="Quote Review | Heerawalla"
  description="Review your private Heerawalla quote and begin purchase."
>
  <Header />

  <main class="container py-12 space-y-12">
    <section class="grid gap-10 lg:grid-cols-[1.1fr_0.9fr] items-start">
      <div class="space-y-4">
        <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Private quote</p>
        <h1 class="font-display text-4xl sm:text-5xl tracking-tight text-ink">Your personal quote</h1>
        <p class="text-sm text-slate-600 max-w-xl">
          Review the curated stone and metal options below. Select your preferred combination to begin purchase.
        </p>

        <div class="border border-slate-200 bg-white p-6 space-y-5" data-quote data-quote-api={quoteApiBase}>
          <div class="text-xs uppercase tracking-[0.2em] text-slate-500">Status</div>
          <p class="text-sm text-slate-600" data-quote-status>Loading your quote details...</p>

          <div class="border-t border-slate-200 pt-4 space-y-4" data-quote-summary>
            <div class="grid gap-1">
              <div class="text-[10px] uppercase tracking-[0.2em] text-slate-500">Request</div>
              <div class="text-sm font-medium text-ink" data-quote-id>--</div>
            </div>
            <div class="grid gap-1">
              <div class="text-[10px] uppercase tracking-[0.2em] text-slate-500">Product</div>
              <div class="text-sm text-ink" data-quote-product>--</div>
            </div>
            <div class="grid gap-1">
              <div class="text-[10px] uppercase tracking-[0.2em] text-slate-500">Client</div>
              <div class="text-sm text-ink" data-quote-name>--</div>
            </div>
          </div>

          <div class="space-y-3">
            <div class="text-xs uppercase tracking-[0.2em] text-slate-500">Select metal</div>
            <div class="flex flex-wrap gap-2" data-quote-metals></div>
          </div>

          <div class="space-y-3">
            <div class="text-xs uppercase tracking-[0.2em] text-slate-500">Quote options</div>
            <div class="border border-slate-200 bg-white" data-quote-table>
              <div class="px-4 py-3 text-sm text-slate-500">Awaiting quote options.</div>
            </div>
          </div>

          <p class="text-xs text-slate-500" data-quote-expiry>
            Your private link is valid for 72 hours.
          </p>
        </div>
      </div>

      <aside class="space-y-4">
        <div class="card border border-slate-200 p-6 space-y-4">
          <div class="text-xs uppercase tracking-[0.3em] text-slate-500">Your piece</div>
          <div class="grid gap-3" data-quote-media>
            <div class="aspect-[4/3] w-full rounded-2xl bg-slate-100 text-sm text-slate-400 flex items-center justify-center">
              Loading images...
            </div>
          </div>
          <div class="space-y-3 text-sm text-slate-600">
            <div class="flex items-start justify-between gap-4">
              <span class="text-slate-500">Metal</span>
              <span class="text-ink font-medium text-right" data-quote-metal>--</span>
            </div>
            <div class="flex items-start justify-between gap-4">
              <span class="text-slate-500">Metal weight</span>
              <span class="text-ink font-medium text-right" data-quote-metal-weight>--</span>
            </div>
            <div class="space-y-2">
              <div class="text-[10px] uppercase tracking-[0.2em] text-slate-500">Diamonds</div>
              <ul class="list-disc pl-4 space-y-1 text-sm text-slate-600" data-quote-diamonds>
                <li>--</li>
              </ul>
            </div>
          </div>
          <div class="border-t border-slate-200 pt-4 space-y-3 text-sm text-slate-600">
            <div>
              <div class="text-[10px] uppercase tracking-[0.2em] text-slate-500">Warranty</div>
              <p>1 year workmanship warranty.</p>
            </div>
            <div>
              <div class="text-[10px] uppercase tracking-[0.2em] text-slate-500">Discounts</div>
              <p data-quote-discount>--</p>
            </div>
            <div>
              <div class="text-[10px] uppercase tracking-[0.2em] text-slate-500">Taxes</div>
              <p>Sales tax is calculated at checkout based on your delivery state.</p>
            </div>
          </div>
        </div>
        <div class="card border border-slate-200 p-6 space-y-4">
          <div class="text-xs uppercase tracking-[0.3em] text-slate-500">How to proceed</div>
          <ul class="text-sm text-slate-600 space-y-2">
            <li>Review the piece details and the quality guide.</li>
            <li>Choose your preferred quality for the jewelry.</li>
            <li>Make payment to confirm the order.</li>
          </ul>
        </div>
        <div class="border border-slate-200 bg-white p-5 text-sm text-slate-600 space-y-2">
          <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Need assistance?</p>
          <p>
            Reply to the quote email or reach us at
            <a class="underline text-ink" href={`mailto:${ordersEmail}`}>{ordersEmail}</a>.
          </p>
        </div>
      </aside>
    </section>
  </main>

  <div class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/40 px-6" data-quote-modal>
    <div class="w-full max-w-lg rounded-2xl border border-slate-200 bg-white p-6 shadow-xl">
      <div class="text-xs uppercase tracking-[0.2em] text-slate-500">Confirm selection</div>
      <h2 class="mt-2 text-2xl font-display text-ink" data-quote-modal-title>Review your selection</h2>
      <p class="mt-3 text-sm text-slate-600" data-quote-modal-copy>
        Please confirm this is the exact combination you want before continuing to checkout.
      </p>
      <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-ink" data-quote-modal-summary></div>
      <div class="mt-6 flex flex-wrap items-center justify-end gap-3">
        <button class="btn btn-ghost" type="button" data-quote-modal-cancel>Change selection</button>
        <button class="btn btn-primary" type="button" data-quote-modal-confirm>Confirm &amp; continue</button>
      </div>
    </div>
  </div>

  <Footer />
</BaseLayout>

<script is:inline>
  (() => {
    const root = document.querySelector('[data-quote]');
    if (!root) return;
    const statusEl = root.querySelector('[data-quote-status]');
    const requestEl = root.querySelector('[data-quote-id]');
    const productEl = root.querySelector('[data-quote-product]');
    const nameEl = root.querySelector('[data-quote-name]');
    const mediaEl = document.querySelector('[data-quote-media]');
    const metalEl = document.querySelector('[data-quote-metal]');
    const metalWeightEl = document.querySelector('[data-quote-metal-weight]');
    const diamondsEl = document.querySelector('[data-quote-diamonds]');
    const discountEl = document.querySelector('[data-quote-discount]');
    const metalsEl = root.querySelector('[data-quote-metals]');
    const tableEl = root.querySelector('[data-quote-table]');
    const expiryEl = root.querySelector('[data-quote-expiry]');
    const modalEl = document.querySelector('[data-quote-modal]');
    const modalTitleEl = document.querySelector('[data-quote-modal-title]');
    const modalCopyEl = document.querySelector('[data-quote-modal-copy]');
    const modalSummaryEl = document.querySelector('[data-quote-modal-summary]');
    const modalCancelEl = document.querySelector('[data-quote-modal-cancel]');
    const modalConfirmEl = document.querySelector('[data-quote-modal-confirm]');
    const apiBase = root.getAttribute('data-quote-api') || '';
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token') || params.get('t') || params.get('quote');

    const setStatus = (message, tone) => {
      if (!statusEl) return;
      statusEl.textContent = message;
      statusEl.classList.remove('text-slate-600', 'text-rose-600', 'text-emerald-600');
      if (tone === 'error') {
        statusEl.classList.add('text-rose-600');
      } else if (tone === 'success') {
        statusEl.classList.add('text-emerald-600');
      } else {
        statusEl.classList.add('text-slate-600');
      }
    };

    const formatMoney = (value) => {
      if (value === undefined || value === null || Number.isNaN(Number(value))) return '--';
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(
        Number(value)
      );
    };

    const formatGrams = (value) => {
      if (value === undefined || value === null || value === '') return '--';
      const number = Number(value);
      if (Number.isNaN(number)) return `${value} g`;
      return `${number} g`;
    };

    const formatSignedGrams = (value) => {
      if (value === undefined || value === null || value === '') return '';
      const number = Number(value);
      if (Number.isNaN(number)) return String(value);
      const sign = number > 0 ? '+' : '';
      return `${sign}${number} g`;
    };

    const parseDiamondBreakdown = (value) => {
      if (!value) return [];
      return String(value)
        .split(/\n|;|,/)
        .map((entry) => entry.trim())
        .filter(Boolean)
        .map((entry) => {
          const match = entry.match(/([0-9]*\.?[0-9]+)\s*(?:ct)?\s*[xA-]\s*([0-9]*\.?[0-9]+)/i);
          if (match) {
            return { weight: Number(match[1]), count: Number(match[2]) };
          }
          const numbers = entry.match(/[0-9]*\.?[0-9]+/g) || [];
          if (numbers.length >= 2) {
            const first = Number(numbers[0]);
            const second = Number(numbers[1]);
            const weight = first <= second ? first : second;
            const count = first <= second ? second : first;
            return { weight, count };
          }
          if (numbers.length === 1) {
            return { weight: Number(numbers[0]), count: 1 };
          }
          return { weight: 0, count: 0 };
        })
        .filter((entry) => Number.isFinite(entry.weight) && entry.weight > 0 && Number.isFinite(entry.count) && entry.count > 0);
    };

    const renderDiamondBreakdown = (value, fallbackWeight) => {
      if (!diamondsEl) return;
      const pieces = parseDiamondBreakdown(value);
      const fallback = Number(fallbackWeight);
      if (!pieces.length && Number.isFinite(fallback) && fallback > 0) {
        pieces.push({ weight: fallback, count: 1 });
      }
      if (!pieces.length) {
        diamondsEl.innerHTML = '<li>No diamonds included</li>';
        return;
      }
      diamondsEl.innerHTML = pieces
        .map((piece) => `<li>${piece.weight} ct x ${piece.count}</li>`)
        .join('');
    };

    const requestJsonWithStatus = async (path, options = {}) => {
      if (!apiBase) throw new Error('missing_api');
      const base = apiBase.replace(/\/$/, '');
      const response = await fetch(`${base}${path}`, {
        headers: { 'Content-Type': 'application/json' },
        ...options,
      });
      const text = await response.text();
      let data = null;
      try {
        data = text ? JSON.parse(text) : null;
      } catch {
        data = null;
      }
      return { ok: response.ok, status: response.status, data };
    };

    if (!token) {
      setStatus('This quote link is missing or invalid. Please contact the concierge.', 'error');
      return;
    }

    let quoteData = null;
    let selectedMetal = '';
    let pendingSelection = null;
    const catalogCache = { data: null, promise: null };

    const getCatalogBase = () => apiBase.replace(/\/admin\/?$/, '');

    const extractSlug = (url) => {
      if (!url) return '';
      try {
        const parsed = new URL(url, 'https://www.heerawalla.com');
        const parts = parsed.pathname.split('/').filter(Boolean);
        const last = parts[parts.length - 1] || '';
        if (last.toLowerCase() === 'bespoke' && parts.length > 1) {
          return parts[parts.length - 2] || '';
        }
        return last;
      } catch {
        return '';
      }
    };

    const extractCatalogType = (url) => {
      if (!url) return '';
      try {
        const parsed = new URL(url, 'https://www.heerawalla.com');
        const parts = parsed.pathname.split('/').filter(Boolean);
        if (parts.includes('inspirations')) return 'inspirations';
        if (parts.includes('product') || parts.includes('products')) return 'products';
        return '';
      } catch {
        return '';
      }
    };

    const loadCatalog = async () => {
      if (catalogCache.data) return catalogCache.data;
      if (catalogCache.promise) return catalogCache.promise;
      const url = `${getCatalogBase()}/catalog?include=products,inspirations`;
      catalogCache.promise = fetch(url)
        .then((response) => response.json())
        .then((data) => {
          catalogCache.data = data || {};
          return catalogCache.data;
        })
        .catch(() => {
          catalogCache.data = {};
          return catalogCache.data;
        })
        .finally(() => {
          catalogCache.promise = null;
        });
      return catalogCache.promise;
    };

    const collectImageUrls = (entry) => {
      if (!entry) return [];
      const candidates = [];
      if (entry.hero_image) candidates.push(entry.hero_image);
      if (entry.heroImage) candidates.push(entry.heroImage);
      if (Array.isArray(entry.images)) {
        entry.images.forEach((image) => candidates.push(image));
      }
      return Array.from(new Set(candidates.filter(Boolean)));
    };

    const resolveCatalogEntry = (data, catalog) => {
      if (!catalog || !data) return null;
      const url = data.productUrl || '';
      const slug = extractSlug(url);
      const type = extractCatalogType(url);
      const designCode = data.designCode || '';
      const name = data.productName || '';
      const inspirations = Array.isArray(catalog.inspirations) ? catalog.inspirations : [];
      const products = Array.isArray(catalog.products) ? catalog.products : [];
      const byDesignCode = (entry) =>
        designCode &&
        String(entry.design_code || entry.designCode || '').toLowerCase() === designCode.toLowerCase();
      const byName = (entry) =>
        name && String(entry.name || entry.title || '').toLowerCase() === name.toLowerCase();
      const bySlug = (entry) => slug && String(entry.slug || '').toLowerCase() === slug.toLowerCase();
      if (type === 'inspirations') {
        return inspirations.find(bySlug) || inspirations.find(byDesignCode) || inspirations.find(byName) || null;
      }
      if (type === 'products') {
        return products.find(bySlug) || products.find(byDesignCode) || products.find(byName) || null;
      }
      return (
        inspirations.find(bySlug) ||
        products.find(bySlug) ||
        inspirations.find(byDesignCode) ||
        products.find(byDesignCode) ||
        inspirations.find(byName) ||
        products.find(byName) ||
        null
      );
    };

    const renderMedia = (images) => {
      if (!mediaEl) return;
      if (!images.length) {
        mediaEl.innerHTML =
          '<div class="aspect-[4/3] w-full rounded-2xl bg-slate-100 text-sm text-slate-400 flex items-center justify-center">No images available</div>';
        return;
      }
      if (images.length === 1) {
        const src = images[0];
        mediaEl.innerHTML = `<img class="w-full rounded-2xl object-cover" src="${src}" alt="" loading="lazy">`;
        return;
      }
      const slides = images
        .map(
          (src) =>
            `<div class="snap-start shrink-0 w-64">
              <img class="w-full h-40 rounded-2xl object-cover" src="${src}" alt="" loading="lazy">
            </div>`
        )
        .join('');
      mediaEl.innerHTML = `
        <div class="flex gap-3 overflow-x-auto pb-2 snap-x snap-mandatory">
          ${slides}
        </div>
      `;
    };

    const refreshQuoteMedia = async (data) => {
      if (!mediaEl) return;
      const catalog = await loadCatalog();
      const entry = resolveCatalogEntry(data, catalog);
      const images = collectImageUrls(entry);
      renderMedia(images);
    };

    const updateSpecs = (data) => {
      if (metalEl) metalEl.textContent = data.metal || '--';
      if (metalWeightEl) {
        const base = formatGrams(data.metalWeight);
        const adjustment = formatSignedGrams(data.metalWeightAdjustment);
        metalWeightEl.textContent = adjustment ? `${base} (${adjustment})` : base;
      }
      renderDiamondBreakdown(data.diamondBreakdown, data.stoneWeight);
      if (discountEl) {
        discountEl.textContent = data.discountSummary || 'No discount applied';
      }
    };

    const formatOptionLabel = (option, index) => {
      return [option?.clarity, option?.color].filter(Boolean).join(' / ') || `Option ${index + 1}`;
    };

    const getEmotionLabel = (index) => {
      const labels = ['Pure Luxury', 'Premium Quality', 'Standard Quality'];
      return labels[index] || `Option ${index + 1}`;
    };

    const describeClarity = (clarity) => {
      const value = String(clarity || '').toUpperCase();
      if (value.includes('VVS')) return 'Near flawless clarity with exceptional brilliance.';
      if (value.includes('VS')) return 'Very small inclusions for a crisp, bright sparkle.';
      if (value.includes('SI')) return 'Slight inclusions with beautiful presence.';
      return 'Carefully selected diamonds for lasting brilliance.';
    };

    const describeColor = (color) => {
      const value = String(color || '').toUpperCase();
      if (value.includes('E') && value.includes('F')) return 'Colorless, crisp white tone.';
      if (value.includes('F') && value.includes('G')) return 'Near colorless with a soft glow.';
      if (value.includes('G') || value.includes('I')) return 'Near colorless with a gentle warmth.';
      return 'Balanced tone selected for a refined look.';
    };

    const buildQualityDescription = (option) => {
      return `${describeClarity(option?.clarity)} ${describeColor(option?.color)}`;
    };

    const formatSelectionSummary = (selection) => {
      if (!quoteData || !selection) return '';
      const option = quoteData.options?.[selection.optionIndex];
      const label = formatOptionLabel(option, selection.optionIndex);
      const price = option ? option.prices?.[selection.metal] ?? option.price18k : null;
      return `Metal: ${selection.metal} · Option: ${label} · Price: ${formatMoney(price)}`;
    };

    const openModal = (title, copy, summary, confirmLabel) => {
      if (!modalEl) return;
      if (modalTitleEl) modalTitleEl.textContent = title;
      if (modalCopyEl) modalCopyEl.textContent = copy;
      if (modalSummaryEl) modalSummaryEl.textContent = summary;
      if (modalConfirmEl) modalConfirmEl.textContent = confirmLabel;
      modalEl.classList.remove('hidden');
      modalEl.classList.add('flex');
    };

    const closeModal = () => {
      if (!modalEl) return;
      modalEl.classList.add('hidden');
      modalEl.classList.remove('flex');
      pendingSelection = null;
    };

    const renderMetals = (metals) => {
      if (!metalsEl) return;
      metalsEl.innerHTML = '';
      metals.forEach((metal) => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className =
          'px-4 py-2 rounded-full border text-xs uppercase tracking-[0.2em] ' +
          (metal === selectedMetal ? 'border-ink bg-ink text-white' : 'border-slate-200 text-slate-600');
        button.textContent = metal;
        button.addEventListener('click', () => {
          selectedMetal = metal;
          renderMetals(metals);
          renderTable();
        });
        metalsEl.appendChild(button);
      });
    };

    const renderTable = () => {
      if (!tableEl || !quoteData) return;
      const options = quoteData.options || [];
      if (!options.length) {
        tableEl.innerHTML = '<div class="px-4 py-3 text-sm text-slate-500">No quote options available.</div>';
        return;
      }
      const hasSelection = quoteData.selectedOption !== null && quoteData.selectedOption !== undefined;
      const selectionLabel = hasSelection
        ? formatOptionLabel(options[quoteData.selectedOption], quoteData.selectedOption)
        : '';
      const selectionPrice = hasSelection
        ? options[quoteData.selectedOption].prices?.[quoteData.selectedMetal] ?? options[quoteData.selectedOption].price18k
        : null;
      const selectionNotice = hasSelection
        ? `
          <div class="border-b border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-700">
            Current selection: <span class="font-medium text-ink">${selectionLabel}</span> in
            <span class="font-medium text-ink">${quoteData.selectedMetal}</span> at
            <span class="font-medium text-ink">${formatMoney(selectionPrice)}</span>.
            <button class="ml-3 underline text-ink" type="button" data-quote-resume>Continue to checkout</button>
          </div>`
        : '';
      const isGoldOnly =
        options.length === 1 &&
        !String(options[0]?.clarity || '').trim() &&
        !String(options[0]?.color || '').trim();
      const headerCells = options
        .map((option, index) => {
          if (isGoldOnly) {
            return `
              <th class="px-4 py-3 text-left border-b border-slate-200">
                <div class="text-[10px] uppercase tracking-[0.2em] text-slate-500">Gold only</div>
                <div class="mt-1 text-sm font-medium text-ink">Price quote</div>
                <div class="mt-1 text-xs text-slate-500 leading-relaxed">Diamond details are not applicable.</div>
              </th>
            `;
          }
          const label = formatOptionLabel(option, index);
          const emotion = getEmotionLabel(index);
          const description = buildQualityDescription(option);
          return `
            <th class="px-4 py-3 text-left border-b border-slate-200">
              <div class="text-[10px] uppercase tracking-[0.2em] text-amber-700">${emotion}</div>
              <div class="mt-1 text-sm font-medium text-ink">${label}</div>
              <div class="mt-1 text-xs text-slate-500 leading-relaxed">${description}</div>
            </th>
          `;
        })
        .join('');
      const priceCells = options
        .map((option) => {
          const price = option.prices?.[selectedMetal] ?? option.price18k;
          return `<td class="px-4 py-4 text-lg font-medium text-ink border-b border-slate-200">${formatMoney(price)}</td>`;
        })
        .join('');
      const actionCells = options
        .map(
          (_, index) =>
            `<td class="px-4 py-4 border-b border-slate-200"><button class="btn btn-primary w-full" data-quote-select="${index}">Begin purchase</button></td>`
        )
        .join('');

      tableEl.innerHTML = `
        ${selectionNotice}
        <table class="w-full text-sm">
          <thead>
            <tr>${headerCells}</tr>
          </thead>
          <tbody>
            <tr>${priceCells}</tr>
            <tr>${actionCells}</tr>
          </tbody>
        </table>
      `;

      const handleSelection = (optionIndex) => {
        const selection = { optionIndex, metal: selectedMetal };
        const hasExisting = quoteData.selectedOption !== null && quoteData.selectedOption !== undefined;
        const isChange =
          hasExisting &&
          (quoteData.selectedOption !== optionIndex || (quoteData.selectedMetal || '') !== selectedMetal);
        const copy = isChange
          ? 'You are about to change your previous selection. If you already started checkout, this will replace that invoice.'
          : 'Please confirm this is the exact combination you want before continuing to checkout.';
        const summary = formatSelectionSummary(selection);
        pendingSelection = { ...selection, confirm: isChange };
        openModal('Review your selection', copy, summary, isChange ? 'Confirm & switch' : 'Confirm & continue');
      };

      tableEl.querySelectorAll('[data-quote-select]').forEach((button) => {
        button.addEventListener('click', () => {
          const optionIndex = Number(button.getAttribute('data-quote-select'));
          handleSelection(optionIndex);
        });
      });

      const resumeButton = tableEl.querySelector('[data-quote-resume]');
      if (resumeButton && hasSelection) {
        resumeButton.addEventListener('click', () => {
          handleSelection(quoteData.selectedOption);
        });
      }
    };

    const handleExpiredQuote = (data) => {
      const redirectUrl = data?.redirectUrl || '';
      if (redirectUrl) {
        setStatus('This quote link has been updated. Redirecting to the latest version...', 'error');
        setTimeout(() => {
          window.location.href = redirectUrl;
        }, 1500);
        return true;
      }
      setStatus('This quote link has expired. Please contact the concierge.', 'error');
      return true;
    };

    const loadQuote = async () => {
      setStatus('Loading your quote details...');
      try {
        const response = await requestJsonWithStatus(`/quotes/confirmation?token=${encodeURIComponent(token)}`);
        if (!response.ok) {
          const errorData = response.data || {};
          if (errorData.error === 'expired') {
            handleExpiredQuote(errorData);
            return;
          }
          setStatus('We could not load your quote. Please contact the concierge.', 'error');
          return;
        }
        const data = response.data || {};
        quoteData = data;
        const status = data.status || 'pending';

        if (requestEl) requestEl.textContent = data.requestId || '--';
        if (productEl) productEl.textContent = data.productName || '--';
        if (nameEl) nameEl.textContent = data.name || '--';
        updateSpecs(data);
        refreshQuoteMedia(data);
        if (expiryEl && data.expiresAt) {
          const expiresAt = new Date(data.expiresAt);
          if (!Number.isNaN(expiresAt.getTime())) {
            expiryEl.textContent =
              `Your quote link is valid until ${expiresAt.toLocaleString()}. ` +
              "We reserve the right to adjust pricing on quotes that have not been acted upon as market conditions shift.";
          }
        }

        if (status === 'expired') {
          handleExpiredQuote(data);
          return;
        }

        const metals = Array.isArray(data.metals) && data.metals.length ? data.metals : ['18K'];
        selectedMetal = data.selectedMetal || metals[0];
        renderMetals(metals);
        renderTable();
        if (status === 'selected' || status === 'accepted') {
          setStatus('Selection saved. You can update your choice before checkout.', 'success');
        } else {
          setStatus('Select your preferred metal and option to continue.', 'success');
        }
      } catch (error) {
        setStatus('We could not load your quote. Please contact the concierge.', 'error');
      }
    };

    if (modalCancelEl) {
      modalCancelEl.addEventListener('click', () => {
        closeModal();
      });
    }
    if (modalConfirmEl) {
      modalConfirmEl.addEventListener('click', async () => {
        if (!pendingSelection) return;
        const { optionIndex, metal, confirm } = pendingSelection;
        setStatus('Confirming your selection...', 'success');
        try {
          const result = await requestJsonWithStatus('/quotes/confirmation/accept', {
            method: 'POST',
            body: JSON.stringify({ token, metal, optionIndex, confirm }),
          });
          if (!result.ok) {
            if (result.data && result.data.error === 'confirm_required') {
              openModal(
                'Confirm selection change',
                'Please confirm you want to replace your prior selection before continuing.',
                formatSelectionSummary({ optionIndex, metal }),
                'Confirm & switch'
              );
              pendingSelection = { optionIndex, metal, confirm: true };
              return;
            }
            setStatus('We could not confirm this selection. Please contact the concierge.', 'error');
            closeModal();
            return;
          }
          const data = result.data || {};
          quoteData = {
            ...quoteData,
            status: data.status || quoteData.status,
            selectedMetal: data.selectedMetal || metal,
            selectedOption:
              data.selectedOption !== undefined && data.selectedOption !== null
                ? data.selectedOption
                : optionIndex,
            selectedPrice: data.selectedPrice || quoteData.selectedPrice,
          };
          selectedMetal = quoteData.selectedMetal || selectedMetal;
          renderMetals(quoteData.metals || []);
          renderTable();
          const paymentUrl = data.paymentUrl || data.checkoutUrl || data.url;
          closeModal();
          if (paymentUrl) {
            window.location.href = paymentUrl;
            return;
          }
          setStatus('Selection saved. We will follow up with secure checkout.', 'success');
        } catch (error) {
          setStatus('We could not confirm this selection. Please contact the concierge.', 'error');
          closeModal();
        }
      });
    }

    loadQuote();
  })();
</script>

<style>
  :global(body) {
    overflow-x: hidden;
  }
</style>
