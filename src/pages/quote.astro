---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { loadSiteConfig, getConfigValue } from '../lib/config';

const config = await loadSiteConfig();
const quoteApiBase = getConfigValue(
  config,
  'quote_api_base',
  getConfigValue(config, 'order_confirmation_api_base', 'https://admin-api.heerawalla.com')
);
const ordersEmail = getConfigValue(config, 'orders_email', 'orders@heerawalla.com');
---

<BaseLayout
  title="Quote Review | Heerawalla"
  description="Review your private Heerawalla quote and begin purchase."
>
  <Header />

  <main class="container py-12 space-y-12">
    <section class="grid gap-10 lg:grid-cols-[1.1fr_0.9fr] items-start">
      <div class="space-y-4">
        <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Private quote</p>
        <h1 class="font-display text-4xl sm:text-5xl tracking-tight text-ink">Your personal quote</h1>
        <p class="text-sm text-slate-600 max-w-xl">
          Review the curated stone and metal options below. Select your preferred combination to begin purchase.
        </p>

        <div class="border border-slate-200 bg-white p-6 space-y-5" data-quote data-quote-api={quoteApiBase}>
          <div class="text-xs uppercase tracking-[0.2em] text-slate-500">Status</div>
          <p class="text-sm text-slate-600" data-quote-status>Loading your quote details...</p>

          <div class="border-t border-slate-200 pt-4 space-y-4" data-quote-summary>
            <div class="grid gap-1">
              <div class="text-[10px] uppercase tracking-[0.2em] text-slate-500">Request</div>
              <div class="text-sm font-medium text-ink" data-quote-id>--</div>
            </div>
            <div class="grid gap-1">
              <div class="text-[10px] uppercase tracking-[0.2em] text-slate-500">Product</div>
              <div class="text-sm text-ink" data-quote-product>--</div>
            </div>
            <div class="grid gap-1">
              <div class="text-[10px] uppercase tracking-[0.2em] text-slate-500">Client</div>
              <div class="text-sm text-ink" data-quote-name>--</div>
            </div>
          </div>

          <div class="space-y-3">
            <div class="text-xs uppercase tracking-[0.2em] text-slate-500">Select metal</div>
            <div class="flex flex-wrap gap-2" data-quote-metals></div>
          </div>

          <div class="space-y-3">
            <div class="text-xs uppercase tracking-[0.2em] text-slate-500">Quote options</div>
            <div class="border border-slate-200 bg-white" data-quote-table>
              <div class="px-4 py-3 text-sm text-slate-500">Awaiting quote options.</div>
            </div>
          </div>

          <p class="text-xs text-slate-500" data-quote-expiry>
            Your private link is valid for 72 hours.
          </p>
        </div>
      </div>

      <aside class="space-y-4">
        <div class="card border border-slate-200 p-6 space-y-4">
          <div class="text-xs uppercase tracking-[0.3em] text-slate-500">How to proceed</div>
          <ul class="text-sm text-slate-600 space-y-2">
            <li>Select your preferred metal to see the updated prices.</li>
            <li>Choose an option to begin purchase and reserve the piece.</li>
            <li>Your link is private and expires in 72 hours.</li>
          </ul>
        </div>
        <div class="border border-slate-200 bg-white p-5 text-sm text-slate-600 space-y-2">
          <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Need assistance?</p>
          <p>
            Reply to the quote email or reach us at
            <a class="underline text-ink" href={`mailto:${ordersEmail}`}>{ordersEmail}</a>.
          </p>
        </div>
      </aside>
    </section>
  </main>

  <div class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/40 px-6" data-quote-modal>
    <div class="w-full max-w-lg rounded-2xl border border-slate-200 bg-white p-6 shadow-xl">
      <div class="text-xs uppercase tracking-[0.2em] text-slate-500">Confirm selection</div>
      <h2 class="mt-2 text-2xl font-display text-ink" data-quote-modal-title>Review your selection</h2>
      <p class="mt-3 text-sm text-slate-600" data-quote-modal-copy>
        Please confirm this is the exact combination you want before continuing to checkout.
      </p>
      <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-ink" data-quote-modal-summary></div>
      <div class="mt-6 flex flex-wrap items-center justify-end gap-3">
        <button class="btn btn-ghost" type="button" data-quote-modal-cancel>Change selection</button>
        <button class="btn btn-primary" type="button" data-quote-modal-confirm>Confirm &amp; continue</button>
      </div>
    </div>
  </div>

  <Footer />
</BaseLayout>

<script is:inline>
  (() => {
    const root = document.querySelector('[data-quote]');
    if (!root) return;
    const statusEl = root.querySelector('[data-quote-status]');
    const requestEl = root.querySelector('[data-quote-id]');
    const productEl = root.querySelector('[data-quote-product]');
    const nameEl = root.querySelector('[data-quote-name]');
    const metalsEl = root.querySelector('[data-quote-metals]');
    const tableEl = root.querySelector('[data-quote-table]');
    const expiryEl = root.querySelector('[data-quote-expiry]');
    const modalEl = document.querySelector('[data-quote-modal]');
    const modalTitleEl = document.querySelector('[data-quote-modal-title]');
    const modalCopyEl = document.querySelector('[data-quote-modal-copy]');
    const modalSummaryEl = document.querySelector('[data-quote-modal-summary]');
    const modalCancelEl = document.querySelector('[data-quote-modal-cancel]');
    const modalConfirmEl = document.querySelector('[data-quote-modal-confirm]');
    const apiBase = root.getAttribute('data-quote-api') || '';
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token') || params.get('t') || params.get('quote');

    const setStatus = (message, tone) => {
      if (!statusEl) return;
      statusEl.textContent = message;
      statusEl.classList.remove('text-slate-600', 'text-rose-600', 'text-emerald-600');
      if (tone === 'error') {
        statusEl.classList.add('text-rose-600');
      } else if (tone === 'success') {
        statusEl.classList.add('text-emerald-600');
      } else {
        statusEl.classList.add('text-slate-600');
      }
    };

    const formatMoney = (value) => {
      if (value === undefined || value === null || Number.isNaN(Number(value))) return '--';
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(
        Number(value)
      );
    };

    const requestJson = async (path, options = {}) => {
      if (!apiBase) throw new Error('missing_api');
      const base = apiBase.replace(/\/$/, '');
      const response = await fetch(`${base}${path}`, {
        headers: { 'Content-Type': 'application/json' },
        ...options,
      });
      if (!response.ok) {
        const text = await response.text();
        throw new Error(text || 'request_failed');
      }
      return await response.json();
    };

    const requestJsonWithStatus = async (path, options = {}) => {
      if (!apiBase) throw new Error('missing_api');
      const base = apiBase.replace(/\/$/, '');
      const response = await fetch(`${base}${path}`, {
        headers: { 'Content-Type': 'application/json' },
        ...options,
      });
      const text = await response.text();
      let data = null;
      try {
        data = text ? JSON.parse(text) : null;
      } catch {
        data = null;
      }
      return { ok: response.ok, status: response.status, data };
    };

    if (!token) {
      setStatus('This quote link is missing or invalid. Please contact the concierge.', 'error');
      return;
    }

    let quoteData = null;
    let selectedMetal = '';
    let pendingSelection = null;

    const formatOptionLabel = (option, index) => {
      return [option?.clarity, option?.color].filter(Boolean).join(' / ') || `Option ${index + 1}`;
    };

    const formatSelectionSummary = (selection) => {
      if (!quoteData || !selection) return '';
      const option = quoteData.options?.[selection.optionIndex];
      const label = formatOptionLabel(option, selection.optionIndex);
      const price = option ? option.prices?.[selection.metal] ?? option.price18k : null;
      return `Metal: ${selection.metal} · Option: ${label} · Price: ${formatMoney(price)}`;
    };

    const openModal = (title, copy, summary, confirmLabel) => {
      if (!modalEl) return;
      if (modalTitleEl) modalTitleEl.textContent = title;
      if (modalCopyEl) modalCopyEl.textContent = copy;
      if (modalSummaryEl) modalSummaryEl.textContent = summary;
      if (modalConfirmEl) modalConfirmEl.textContent = confirmLabel;
      modalEl.classList.remove('hidden');
      modalEl.classList.add('flex');
    };

    const closeModal = () => {
      if (!modalEl) return;
      modalEl.classList.add('hidden');
      modalEl.classList.remove('flex');
      pendingSelection = null;
    };

    const renderMetals = (metals) => {
      if (!metalsEl) return;
      metalsEl.innerHTML = '';
      metals.forEach((metal) => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className =
          'px-4 py-2 rounded-full border text-xs uppercase tracking-[0.2em] ' +
          (metal === selectedMetal ? 'border-ink bg-ink text-white' : 'border-slate-200 text-slate-600');
        button.textContent = metal;
        button.addEventListener('click', () => {
          selectedMetal = metal;
          renderMetals(metals);
          renderTable();
        });
        metalsEl.appendChild(button);
      });
    };

    const renderTable = () => {
      if (!tableEl || !quoteData) return;
      const options = quoteData.options || [];
      if (!options.length) {
        tableEl.innerHTML = '<div class="px-4 py-3 text-sm text-slate-500">No quote options available.</div>';
        return;
      }
      const hasSelection = quoteData.selectedOption !== null && quoteData.selectedOption !== undefined;
      const selectionLabel = hasSelection
        ? formatOptionLabel(options[quoteData.selectedOption], quoteData.selectedOption)
        : '';
      const selectionPrice = hasSelection
        ? options[quoteData.selectedOption].prices?.[quoteData.selectedMetal] ?? options[quoteData.selectedOption].price18k
        : null;
      const selectionNotice = hasSelection
        ? `
          <div class="border-b border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-700">
            Current selection: <span class="font-medium text-ink">${selectionLabel}</span> in
            <span class="font-medium text-ink">${quoteData.selectedMetal}</span> at
            <span class="font-medium text-ink">${formatMoney(selectionPrice)}</span>.
            <button class="ml-3 underline text-ink" type="button" data-quote-resume>Continue to checkout</button>
          </div>`
        : '';
      const headerCells = options
        .map((option, index) => {
          const label = formatOptionLabel(option, index);
          return `<th class="px-4 py-3 text-left text-xs uppercase tracking-[0.2em] text-slate-500 border-b border-slate-200">${label}</th>`;
        })
        .join('');
      const priceCells = options
        .map((option) => {
          const price = option.prices?.[selectedMetal] ?? option.price18k;
          return `<td class="px-4 py-4 text-lg font-medium text-ink border-b border-slate-200">${formatMoney(price)}</td>`;
        })
        .join('');
      const actionCells = options
        .map(
          (_, index) =>
            `<td class="px-4 py-4 border-b border-slate-200"><button class="btn btn-primary w-full" data-quote-select="${index}">Begin purchase</button></td>`
        )
        .join('');

      tableEl.innerHTML = `
        ${selectionNotice}
        <table class="w-full text-sm">
          <thead>
            <tr><th class="px-4 py-3 text-left text-xs uppercase tracking-[0.2em] text-slate-500 border-b border-slate-200"></th>${headerCells}</tr>
          </thead>
          <tbody>
            <tr><td class="px-4 py-2 text-xs uppercase tracking-[0.2em] text-slate-500 border-b border-slate-200">Price (${selectedMetal})</td>${priceCells}</tr>
            <tr><td class="px-4 py-2 text-xs uppercase tracking-[0.2em] text-slate-500">Action</td>${actionCells}</tr>
          </tbody>
        </table>
      `;

      const handleSelection = (optionIndex) => {
        const selection = { optionIndex, metal: selectedMetal };
        const hasExisting = quoteData.selectedOption !== null && quoteData.selectedOption !== undefined;
        const isChange =
          hasExisting &&
          (quoteData.selectedOption !== optionIndex || (quoteData.selectedMetal || '') !== selectedMetal);
        const copy = isChange
          ? 'You are about to change your previous selection. If you already started checkout, this will replace that invoice.'
          : 'Please confirm this is the exact combination you want before continuing to checkout.';
        const summary = formatSelectionSummary(selection);
        pendingSelection = { ...selection, confirm: isChange };
        openModal('Review your selection', copy, summary, isChange ? 'Confirm & switch' : 'Confirm & continue');
      };

      tableEl.querySelectorAll('[data-quote-select]').forEach((button) => {
        button.addEventListener('click', () => {
          const optionIndex = Number(button.getAttribute('data-quote-select'));
          handleSelection(optionIndex);
        });
      });

      const resumeButton = tableEl.querySelector('[data-quote-resume]');
      if (resumeButton && hasSelection) {
        resumeButton.addEventListener('click', () => {
          handleSelection(quoteData.selectedOption);
        });
      }
    };

    const loadQuote = async () => {
      setStatus('Loading your quote details...');
      try {
        const data = await requestJson(`/quotes/confirmation?token=${encodeURIComponent(token)}`);
        quoteData = data;
        const status = data.status || 'pending';

        if (requestEl) requestEl.textContent = data.requestId || '--';
        if (productEl) productEl.textContent = data.productName || '--';
        if (nameEl) nameEl.textContent = data.name || '--';
        if (expiryEl && data.expiresAt) {
          const expiresAt = new Date(data.expiresAt);
          if (!Number.isNaN(expiresAt.getTime())) {
            expiryEl.textContent = `Quote valid until ${expiresAt.toLocaleString()}.`;
          }
        }

        if (status === 'expired') {
          setStatus('This quote link has expired. Please contact the concierge.', 'error');
          return;
        }

        const metals = Array.isArray(data.metals) && data.metals.length ? data.metals : ['18K'];
        selectedMetal = data.selectedMetal || metals[0];
        renderMetals(metals);
        renderTable();
        if (status === 'selected' || status === 'accepted') {
          setStatus('Selection saved. You can update your choice before checkout.', 'success');
        } else {
          setStatus('Select your preferred metal and option to continue.', 'success');
        }
      } catch (error) {
        const message = String(error || '');
        if (message.includes('expired')) {
          setStatus('This quote link has expired. Please contact the concierge.', 'error');
          return;
        }
        setStatus('We could not load your quote. Please contact the concierge.', 'error');
      }
    };

    if (modalCancelEl) {
      modalCancelEl.addEventListener('click', () => {
        closeModal();
      });
    }
    if (modalConfirmEl) {
      modalConfirmEl.addEventListener('click', async () => {
        if (!pendingSelection) return;
        const { optionIndex, metal, confirm } = pendingSelection;
        setStatus('Confirming your selection...', 'success');
        try {
          const result = await requestJsonWithStatus('/quotes/confirmation/accept', {
            method: 'POST',
            body: JSON.stringify({ token, metal, optionIndex, confirm }),
          });
          if (!result.ok) {
            if (result.data && result.data.error === 'confirm_required') {
              openModal(
                'Confirm selection change',
                'Please confirm you want to replace your prior selection before continuing.',
                formatSelectionSummary({ optionIndex, metal }),
                'Confirm & switch'
              );
              pendingSelection = { optionIndex, metal, confirm: true };
              return;
            }
            setStatus('We could not confirm this selection. Please contact the concierge.', 'error');
            closeModal();
            return;
          }
          const data = result.data || {};
          quoteData = {
            ...quoteData,
            status: data.status || quoteData.status,
            selectedMetal: data.selectedMetal || metal,
            selectedOption:
              data.selectedOption !== undefined && data.selectedOption !== null
                ? data.selectedOption
                : optionIndex,
            selectedPrice: data.selectedPrice || quoteData.selectedPrice,
          };
          selectedMetal = quoteData.selectedMetal || selectedMetal;
          renderMetals(quoteData.metals || []);
          renderTable();
          const paymentUrl = data.paymentUrl || data.checkoutUrl || data.url;
          closeModal();
          if (paymentUrl) {
            window.location.href = paymentUrl;
            return;
          }
          setStatus('Selection saved. We will follow up with secure checkout.', 'success');
        } catch (error) {
          setStatus('We could not confirm this selection. Please contact the concierge.', 'error');
          closeModal();
        }
      });
    }

    loadQuote();
  })();
</script>
