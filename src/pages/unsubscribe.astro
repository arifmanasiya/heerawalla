---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { loadSiteConfig, getConfigValue } from '../lib/config';

const config = await loadSiteConfig();
const atelierApiBase = getConfigValue(
  config,
  'atelier_api_base',
  'https://admin-api.heerawalla.com'
);
---

<BaseLayout title="Unsubscribe | Heerawalla" description="Manage your Heerawalla email preferences.">
  <Header />

  <main class="container py-12 space-y-10">
    <div class="grid gap-10 lg:grid-cols-[1.1fr_1fr] items-start">
      <div class="space-y-4">
        <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Unsubscribe</p>
        <h1 class="font-display text-4xl sm:text-5xl tracking-tight text-ink">Update your preferences</h1>
        <p class="text-sm text-slate-600 max-w-xl">
          Enter the email address you want to remove from Heerawalla updates.
        </p>
        <p class="text-xs text-slate-500">
          If you change your mind later, you can always rejoin at Heerawalla.com/join.
        </p>
      </div>

      <form class="card border border-slate-200 p-6 space-y-4" data-unsubscribe-form data-atelier-api={atelierApiBase}>
        <label class="text-xs uppercase tracking-[0.2em] text-slate-500">
          Email
          <input
            type="email"
            name="email"
            required
            class="mt-2 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm normal-case tracking-normal text-ink"
            placeholder="you@example.com"
            data-unsubscribe-email
          />
        </label>
        <label class="text-xs uppercase tracking-[0.2em] text-slate-500">
          Reason (optional)
          <textarea
            name="reason"
            rows="3"
            class="mt-2 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm normal-case tracking-normal text-ink"
            placeholder="Tell us what wasn't working"
            data-unsubscribe-reason
          ></textarea>
        </label>
        <div class="flex items-center gap-3">
          <button type="submit" class="btn btn-primary" data-unsubscribe-submit>Unsubscribe</button>
          <p class="text-xs text-slate-500" data-unsubscribe-status></p>
        </div>
      </form>
    </div>
  </main>

  <Footer />
</BaseLayout>

<script is:inline>
  (() => {
    const form = document.querySelector('[data-unsubscribe-form]');
    if (!form) return;
    const emailInput = form.querySelector('[data-unsubscribe-email]');
    const reasonInput = form.querySelector('[data-unsubscribe-reason]');
    const submitButton = form.querySelector('[data-unsubscribe-submit]');
    const status = form.querySelector('[data-unsubscribe-status]');
    const apiBase = form.getAttribute('data-atelier-api') || '';

    const setStatus = (message) => {
      if (status) status.textContent = message;
    };

    const params = new URLSearchParams(window.location.search);
    const presetEmail = params.get('email');
    if (presetEmail && emailInput) {
      emailInput.value = presetEmail;
    }

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const email = emailInput?.value.trim() || '';
      const reason = reasonInput?.value.trim() || '';

      if (!email) {
        setStatus('Email is required.');
        return;
      }
      if (!apiBase) {
        setStatus('Unsubscribe service is unavailable.');
        return;
      }

      if (submitButton) submitButton.setAttribute('disabled', 'true');
      setStatus('Updating...');
      try {
        const response = await fetch(`${apiBase.replace(/\/$/, '')}/unsubscribe`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email,
            reason,
            pageUrl: window.location.href,
          }),
        });
        if (!response.ok) {
          setStatus('Unable to update right now.');
          return;
        }
        form.reset();
        setStatus('You have been unsubscribed.');
      } catch {
        setStatus('Unable to update right now.');
      } finally {
        if (submitButton) submitButton.removeAttribute('disabled');
      }
    });
  })();
</script>
