---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { loadProductsWithMedia, type ProductWithMedia } from '../../lib/products';
import { withBase } from '../../lib/paths';
import { loadSiteConfig, getConfigValue } from '../../lib/config';

export async function getStaticPaths() {
  const products = await loadProductsWithMedia();
  return products.map((product) => ({
    params: { slug: product.slug },
    props: { product }
  }));
}

const { product } = Astro.props as { product: ProductWithMedia };
const turnstileSiteKey = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY || '';
const config = await loadSiteConfig();
const atelierApiBase = getConfigValue(config, 'atelier_api_base', 'https://admin-api.heerawalla.com');
const metaTitle = `Begin purchase | ${product.name} | Heerawalla`;
const metaDescription = `Confirm sizing and preferred details for ${product.name}.`;
const categoryKey = (product.category || '').split('/').pop() || '';

const parseList = (value?: string) => {
  if (!value) return [];
  return value
    .split('|')
    .map((item) => item.trim())
    .filter(Boolean);
};
const normalizeStoneType = (value: string) =>
  value
    .replace(/diamond\(s\)/gi, 'Diamond')
    .replace(/diamonds?\b/gi, 'Diamond')
    .replace(/\s+/g, ' ')
    .trim();

const stoneTypes = parseList(product.stone_types).map(normalizeStoneType).filter(Boolean);
const naturalStoneLabel =
  stoneTypes.find((item) => /natural/i.test(item)) || 'Natural Diamond';
const labStoneLabel =
  stoneTypes.find((item) => /lab/i.test(item)) || 'Lab Grown Diamond';
const metal18Label = (product.metal || '18K Gold').replace(/14K/gi, '18K');
const metal14Label = metal18Label.replace(/18K/gi, '14K');
const metalPlatinumLabel = 'Platinum';
const productUrl = Astro.site
  ? new URL(withBase(`/product/${product.slug}`), Astro.site).toString()
  : withBase(`/product/${product.slug}`);
---

<BaseLayout title={metaTitle} description={metaDescription}>
  <Header />
  <main class="container py-10 space-y-8">
    <div class="space-y-2">
      <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Begin purchase</p>
      <h1 class="font-display text-3xl sm:text-4xl tracking-tight">Review your selections</h1>
      <p class="text-sm text-slate-600">
        Confirm sizing and your preferred details. No payment is required yet.
      </p>
    </div>

    <section class="border border-slate-200 p-5 space-y-3 bg-white">
      <div class="text-xs uppercase tracking-[0.2em] text-slate-500">Selected piece</div>
      <div class="text-lg font-semibold">{product.name}</div>
      <div class="text-sm text-slate-600" data-selection-summary>Selections will appear here.</div>
    </section>

    <form class="space-y-6" data-bespoke-form data-atelier-api={atelierApiBase}>
      <input type="hidden" data-product-name value={product.name} />
      <input type="hidden" data-product-url value={productUrl} />
      <input type="hidden" data-design-code value={product.design_code || ''} />
      <input type="hidden" data-category value={categoryKey} />
      <input type="hidden" data-metal-18 value={metal18Label} />
      <input type="hidden" data-metal-14 value={metal14Label} />
      <input type="hidden" data-metal-platinum value={metalPlatinumLabel} />
      <input type="hidden" data-stone-natural value={naturalStoneLabel} />
      <input type="hidden" data-stone-lab value={labStoneLabel} />

      <div class="grid gap-4 sm:grid-cols-2">
        <label class="text-sm space-y-1">
          <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Your name</span>
          <input class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="name" required />
        </label>
        <label class="text-sm space-y-1">
          <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Email</span>
          <input type="email" class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="email" required />
        </label>
        <label class="text-sm space-y-1 sm:col-span-2">
          <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Phone</span>
          <input class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="phone" required />
        </label>
        <label class="text-sm space-y-1 sm:col-span-2">
          <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Address line 1</span>
          <input class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="addressLine1" required />
        </label>
        <label class="text-sm space-y-1 sm:col-span-2">
          <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Address line 2 (optional)</span>
          <input class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="addressLine2" />
        </label>
        <label class="text-sm space-y-1">
          <span class="text-xs uppercase tracking-[0.2em] text-slate-500">City</span>
          <input class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="city" required />
        </label>
        <label class="text-sm space-y-1">
          <span class="text-xs uppercase tracking-[0.2em] text-slate-500">State / Region</span>
          <input class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="state" required />
        </label>
        <label class="text-sm space-y-1">
          <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Postal code</span>
          <input class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="postalCode" required />
        </label>
        <label class="text-sm space-y-1">
          <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Country</span>
          <input class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="country" required />
        </label>
        <label class="text-sm space-y-1 sm:col-span-2">
          <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Preferred timeline</span>
          <select class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="timeline">
            <option value="Standard">Standard</option>
            <option value="Rush">Rush</option>
          </select>
        </label>
      </div>

      {turnstileSiteKey ? (
        <div class="cf-turnstile" data-sitekey={turnstileSiteKey} data-theme="light"></div>
      ) : null}

      <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
        <a class="btn btn-ghost" data-back-link href={productUrl}>Back to selections</a>
        <button
          type="submit"
          class="inline-flex items-center justify-center min-h-[44px] px-5 py-3 bg-ink text-white text-xs uppercase tracking-[0.2em] rounded-none"
          data-submit
        >
          Send request
        </button>
      </div>
      <p class="text-xs text-slate-500 hidden" data-status></p>
      <p class="text-xs text-slate-500">We reply within 1-2 business days.</p>
    </form>
  </main>
  <Footer />
</BaseLayout>

<script is:inline define:vars={{ turnstileSiteKey }}>
  (function () {
    const form = document.querySelector('[data-bespoke-form]');
    if (!form) return;
    const apiBase = form.dataset.atelierApi || '';
    const orderUrl = apiBase ? `${apiBase.replace(/\/$/, '')}/order` : '';

    const selectionSummary = document.querySelector('[data-selection-summary]');
    const getValue = (selector) => {
      const input = form.querySelector(selector);
      return input ? String(input.value || '') : '';
    };
    const productName = getValue('[data-product-name]');
    const productUrl = getValue('[data-product-url]');
    const designCode = getValue('[data-design-code]');
    const categoryRaw = getValue('[data-category]').toLowerCase();
    const metal18 = getValue('[data-metal-18]');
    const metal14 = getValue('[data-metal-14]');
    const metalPlatinum = getValue('[data-metal-platinum]');
    const stoneNatural = getValue('[data-stone-natural]');
    const stoneLab = getValue('[data-stone-lab]');
    const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });

    const params = new URLSearchParams(window.location.search);
    const metalParam = params.get('metal') || '14k';
    const stoneMode = params.get('stone') || 'natural';
    const rawSize = params.get('size') || '';
    const stoneWeight = params.get('stoneWeight') || '';
    const metalWeight = params.get('metalWeight') || '';
    const priceParam = params.get('price') || '';
    const priceValue = Number(priceParam);
    const priceDisplay =
      Number.isFinite(priceValue) && priceValue > 0 ? formatter.format(priceValue) : '';
    const metalLabel = (() => {
      const normalized = metalParam.toLowerCase();
      if (normalized.includes('plat')) return metalPlatinum;
      if (normalized.includes('14')) return metal14;
      if (normalized.includes('18')) return metal18;
      return metalParam || metal18;
    })();
    const metalValue = metalParam || metalLabel;
    const stoneLabel = stoneMode === 'lab' ? stoneLab : stoneNatural;

    const normalizeCategory = (value) => (value || '').toLowerCase().trim();
    const isIn = (value, list) => list.indexOf(value) >= 0;
    const category = normalizeCategory(categoryRaw);
    const categoryKey = category.split('/').pop() || '';
    const resolveSizeKey = () => {
      if (isIn(categoryKey, ['ring', 'rings', 'band', 'bands'])) return 'ring';
      if (isIn(categoryKey, ['bracelet', 'bracelets'])) return 'bracelet';
      if (isIn(categoryKey, ['necklace', 'necklaces', 'pendant', 'pendants'])) return 'necklace';
      if (isIn(categoryKey, ['earring', 'earrings'])) return 'earrings';
      if (isIn(categoryKey, ['set', 'sets'])) return 'generic';
      return 'generic';
    };
    const sizeKey = resolveSizeKey();
    const normalizeSizeValue = (value, key) => {
      const normalized = String(value || '').trim();
      if (!normalized) return '';
      if (key === 'necklace' || key === 'bracelet') {
        if (normalized.endsWith('"')) return `${normalized.replace(/"$/, '')} in`;
        if (/^\d+(\.\d+)?$/.test(normalized)) return `${normalized} in`;
      }
      return normalized;
    };
    const labelForSizeKey = (key) => {
      if (key === 'ring') return 'Ring size';
      if (key === 'bracelet') return 'Wrist size';
      if (key === 'necklace') return 'Chain length';
      if (key === 'earrings') return 'Earring preference';
      return 'Sizing';
    };
    const sizeValue = normalizeSizeValue(rawSize, sizeKey);
    if (selectionSummary) {
      const parts = [];
      if (metalLabel) parts.push(`Metal: ${metalLabel}`);
      if (stoneLabel) parts.push(`Stone: ${stoneLabel}`);
      if (stoneWeight) parts.push(`Stone weight: ${stoneWeight}`);
      if (sizeValue) parts.push(`Size: ${sizeValue}`);
      if (priceDisplay) parts.push(`Price: ${priceDisplay}`);
      if (metalWeight) parts.push(`Metal weight: ${metalWeight} g`);
      selectionSummary.textContent = parts.length ? parts.join(' | ') : 'Selections will appear here.';
    }
    const backLink = form.querySelector('[data-back-link]');
    if (backLink && productUrl) {
      const searchParams = new URLSearchParams();
      if (params.get('metal')) searchParams.set('metal', params.get('metal'));
      if (params.get('stone')) searchParams.set('stone', params.get('stone'));
      if (params.get('size')) searchParams.set('size', params.get('size'));
      if (params.get('stoneWeight')) searchParams.set('stoneWeight', params.get('stoneWeight'));
      const suffix = searchParams.toString();
      backLink.setAttribute('href', suffix ? `${productUrl}?${suffix}` : productUrl);
    }

    const statusEl = form.querySelector('[data-status]');
    const submitBtn = form.querySelector('[data-submit]');

    const requestId = () => {
      const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let id = '';
      for (let i = 0; i < 6; i += 1) {
        id += alphabet[Math.floor(Math.random() * alphabet.length)];
      }
      return id;
    };

    const getTurnstileToken = () => {
      const tokenEl = form.querySelector('[name="cf-turnstile-response"]');
      return tokenEl ? (tokenEl.value || '').trim() : '';
    };

    const setStatus = (message, tone = 'neutral') => {
      if (!statusEl) return;
      statusEl.textContent = message;
      statusEl.classList.remove('hidden');
      statusEl.classList.remove('text-slate-500', 'text-red-600', 'text-emerald-600');
      if (tone === 'error') {
        statusEl.classList.add('text-red-600');
      } else if (tone === 'success') {
        statusEl.classList.add('text-emerald-600');
      } else {
        statusEl.classList.add('text-slate-500');
      }
    };

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const sizeLabel = labelForSizeKey(sizeKey);
      const nameField = form.querySelector('[data-field="name"]');
      const emailField = form.querySelector('[data-field="email"]');
      const phoneField = form.querySelector('[data-field="phone"]');
      const addressLine1Field = form.querySelector('[data-field="addressLine1"]');
      const addressLine2Field = form.querySelector('[data-field="addressLine2"]');
      const cityField = form.querySelector('[data-field="city"]');
      const stateField = form.querySelector('[data-field="state"]');
      const postalField = form.querySelector('[data-field="postalCode"]');
      const countryField = form.querySelector('[data-field="country"]');
      const timelineField = form.querySelector('[data-field="timeline"]');
      const name = nameField ? String(nameField.value || '').trim() : '';
      const email = emailField ? String(emailField.value || '').trim() : '';
      const phoneRaw = phoneField ? String(phoneField.value || '').trim() : '';
      const phone = phoneRaw.replace(/\D/g, '');
      const addressLine1 = addressLine1Field ? String(addressLine1Field.value || '').trim() : '';
      const addressLine2 = addressLine2Field ? String(addressLine2Field.value || '').trim() : '';
      const city = cityField ? String(cityField.value || '').trim() : '';
      const state = stateField ? String(stateField.value || '').trim() : '';
      const postalCode = postalField ? String(postalField.value || '').trim() : '';
      const country = countryField ? String(countryField.value || '').trim() : '';
      const timeline = timelineField ? String(timelineField.value || '').trim() || 'Standard' : 'Standard';

      if (!name || !email || !phone || !addressLine1 || !city || !state || !postalCode || !country) {
        setStatus('Please complete contact and shipping details before sending.', 'error');
        return;
      }

      if (turnstileSiteKey && !getTurnstileToken()) {
        setStatus('Please complete the verification step before sending.', 'error');
        return;
      }

      const id = requestId();
      const subject = `Heerawalla purchase request: ${productName} [HW-REQ:${id}]`;
        const lines = [
          `Name: ${name}`,
          `Email: ${email}`,
          phone ? `Phone: ${phone}` : '',
          designCode ? `Design code: ${designCode}` : '',
          metalValue ? `Metal: ${metalValue}` : '',
          stoneLabel ? `Stone: ${stoneLabel}` : '',
          stoneWeight ? `Stone weight: ${stoneWeight}` : '',
          metalWeight ? `Metal weight: ${metalWeight} g` : '',
          sizeValue ? `${sizeLabel}: ${sizeValue}` : '',
          priceDisplay ? `Estimated price: ${priceDisplay}` : '',
          `Timeline: ${timeline}`,
          `Shipping address: ${addressLine1}`,
          addressLine2 ? `Address line 2: ${addressLine2}` : '',
          `City: ${city}`,
          `State/Region: ${state}`,
          `Postal code: ${postalCode}`,
          `Country: ${country}`,
          `Heerawalla Request ID: ${id}`,
          productUrl ? `Product link: ${productUrl}` : ''
        ].filter(Boolean);
      const body = lines.join('\n');

      if (submitBtn) submitBtn.setAttribute('disabled', 'true');
      setStatus('Sending your request...', 'neutral');

      try {
        if (!orderUrl) {
          setStatus('Order service is unavailable. Please try again later.', 'error');
          if (submitBtn) submitBtn.removeAttribute('disabled');
          return;
        }
        const response = await fetch(orderUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            subject,
            body,
            email,
            name,
            phone,
            requestId: id,
            turnstileToken: getTurnstileToken(),
            source: 'order',
            productName,
            productUrl,
            designCode,
            metal: metalValue,
            stone: stoneLabel,
            stoneWeight,
            metalWeight,
            size: sizeValue,
            price: Number.isFinite(priceValue) && priceValue > 0 ? String(priceValue) : '',
            timeline,
            addressLine1,
            addressLine2,
            city,
            state,
            postalCode,
            country
          })
        });
        const result = await response.json();
        if (!response.ok || !result.ok) {
          throw new Error(result.error || 'send_failed');
        }
        setStatus('Request received. Please check your email for confirmation.', 'success');
      } catch (error) {
        setStatus('We could not send your request. Please try again.', 'error');
        if (submitBtn) submitBtn.removeAttribute('disabled');
      }
    });
  })();
</script>

{turnstileSiteKey ? (
  <script is:inline src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
) : null}
