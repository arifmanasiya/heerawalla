---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { loadProductsWithMedia, type ProductWithMedia } from '../../lib/products';
import { withBase } from '../../lib/paths';

export async function getStaticPaths() {
  const products = await loadProductsWithMedia();
  return products.map((product) => ({
    params: { slug: product.slug },
    props: { product }
  }));
}

const { product } = Astro.props as { product: ProductWithMedia };
const turnstileSiteKey = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY || '';
const metaTitle = `Request final quote | ${product.name} | Heerawalla`;
const metaDescription = `Finalize sizing and request a quote for ${product.name}.`;
const categoryKey = (product.category || '').split('/').pop() || '';

const parseList = (value?: string) => {
  if (!value) return [];
  return value
    .split('|')
    .map((item) => item.trim())
    .filter(Boolean);
};
const normalizeStoneType = (value: string) =>
  value
    .replace(/diamond\(s\)/gi, 'Diamond')
    .replace(/diamonds?\b/gi, 'Diamond')
    .replace(/\s+/g, ' ')
    .trim();

const stoneTypes = parseList(product.stone_types).map(normalizeStoneType).filter(Boolean);
const naturalStoneLabel =
  stoneTypes.find((item) => /natural/i.test(item)) || 'Natural Diamond';
const labStoneLabel =
  stoneTypes.find((item) => /lab/i.test(item)) || 'Lab Grown Diamond';
const metal18Label = (product.metal || '18K Gold').replace(/14K/gi, '18K');
const metal14Label = metal18Label.replace(/18K/gi, '14K');
const metalPlatinumLabel = 'Platinum';
const productUrl = Astro.site
  ? new URL(withBase(`/product/${product.slug}`), Astro.site).toString()
  : withBase(`/product/${product.slug}`);
---

<BaseLayout title={metaTitle} description={metaDescription}>
  <Header />
  <main class="container py-10 space-y-8">
    <div class="space-y-2">
      <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Finalize quote</p>
      <h1 class="font-display text-3xl sm:text-4xl tracking-tight">Request final quote</h1>
      <p class="text-sm text-slate-600">
        You have already selected the piece. Please confirm sizing and share your contact details.
      </p>
    </div>

    <section class="border border-slate-200 p-5 space-y-3 bg-white">
      <div class="text-xs uppercase tracking-[0.2em] text-slate-500">Selected piece</div>
      <div class="text-lg font-semibold">{product.name}</div>
      <div class="text-sm text-slate-600" data-selection-summary>Selections will appear here.</div>
    </section>

    <form class="space-y-6" data-bespoke-form>
      <input type="hidden" data-product-name value={product.name} />
      <input type="hidden" data-product-url value={productUrl} />
      <input type="hidden" data-design-code value={product.design_code || ''} />
      <input type="hidden" data-category value={categoryKey} />
      <input type="hidden" data-metal-18 value={metal18Label} />
      <input type="hidden" data-metal-14 value={metal14Label} />
      <input type="hidden" data-metal-platinum value={metalPlatinumLabel} />
      <input type="hidden" data-stone-natural value={naturalStoneLabel} />
      <input type="hidden" data-stone-lab value={labStoneLabel} />

      <div class="grid gap-4 sm:grid-cols-2" data-size-group>
        <label class="text-sm space-y-1 sm:col-span-2 hidden" data-size-field="generic">
          <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Sizing details</span>
          <input
            class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm"
            data-size-input
            placeholder="Ring size, wrist size, chain length, etc."
          />
        </label>
        <label class="text-sm space-y-1 hidden" data-size-field="ring">
          <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Ring size</span>
          <select class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-size-input>
            <option value="" disabled selected>Select a size</option>
            <option value="4">4</option>
            <option value="4.5">4.5</option>
            <option value="5">5</option>
            <option value="5.5">5.5</option>
            <option value="6">6</option>
            <option value="6.5">6.5</option>
            <option value="7">7</option>
            <option value="7.5">7.5</option>
            <option value="8">8</option>
            <option value="8.5">8.5</option>
            <option value="9">9</option>
            <option value="9.5">9.5</option>
            <option value="10">10</option>
            <option value="10.5">10.5</option>
            <option value="11">11</option>
            <option value="11.5">11.5</option>
            <option value="12">12</option>
            <option value="12.5">12.5</option>
          </select>
        </label>
        <label class="text-sm space-y-1 hidden" data-size-field="bracelet">
          <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Wrist size</span>
          <select class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-size-input>
            <option value="" disabled selected>Select a size</option>
            <option value="5.5 in">5.5 in</option>
            <option value="5.75 in">5.75 in</option>
            <option value="6 in">6 in</option>
            <option value="6.25 in">6.25 in</option>
            <option value="6.5 in">6.5 in</option>
            <option value="6.75 in">6.75 in</option>
            <option value="7 in">7 in</option>
            <option value="7.25 in">7.25 in</option>
            <option value="7.5 in">7.5 in</option>
            <option value="7.75 in">7.75 in</option>
            <option value="8 in">8 in</option>
          </select>
        </label>
        <label class="text-sm space-y-1 hidden" data-size-field="necklace">
          <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Chain length</span>
          <select class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-size-input>
            <option value="" disabled selected>Select a length</option>
            <option value="16 in">16 in</option>
            <option value="18 in">18 in</option>
            <option value="20 in">20 in</option>
            <option value="22 in">22 in</option>
            <option value="24 in">24 in</option>
          </select>
        </label>
        <label class="text-sm space-y-1 hidden" data-size-field="earrings">
          <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Earring preference</span>
          <select class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-size-input>
            <option value="" disabled selected>Select a style</option>
            <option value="Stud">Stud</option>
            <option value="Drop">Drop</option>
            <option value="Hoop">Hoop</option>
            <option value="No preference">No preference</option>
          </select>
        </label>
      </div>

      <div class="grid gap-4 sm:grid-cols-2">
        <label class="text-sm space-y-1">
          <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Your name</span>
          <input class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="name" required />
        </label>
        <label class="text-sm space-y-1">
          <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Email</span>
          <input type="email" class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="email" required />
        </label>
        <label class="text-sm space-y-1 sm:col-span-2">
          <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Phone (optional)</span>
          <input class="w-full rounded-none border border-slate-200 px-3 py-2 text-sm" data-field="phone" />
        </label>
      </div>

      {turnstileSiteKey ? (
        <div class="cf-turnstile" data-sitekey={turnstileSiteKey} data-theme="light"></div>
      ) : null}

      <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
        <button
          type="submit"
          class="inline-flex items-center justify-center min-h-[44px] px-5 py-3 bg-ink text-white text-xs uppercase tracking-[0.2em] rounded-none"
          data-submit
        >
          Send request
        </button>
      </div>
      <p class="text-xs text-slate-500 hidden" data-status></p>
      <p class="text-xs text-slate-500">We reply within 1-2 business days.</p>
    </form>
  </main>
  <Footer />
</BaseLayout>

<script is:inline define:vars={{ turnstileSiteKey }}>
  (function () {
    const form = document.querySelector('[data-bespoke-form]');
    if (!form) return;

    const selectionSummary = document.querySelector('[data-selection-summary]');
    const getValue = (selector) => {
      const input = form.querySelector(selector);
      return input ? String(input.value || '') : '';
    };
    const productName = getValue('[data-product-name]');
    const productUrl = getValue('[data-product-url]');
    const designCode = getValue('[data-design-code]');
    const categoryRaw = getValue('[data-category]').toLowerCase();
    const metal18 = getValue('[data-metal-18]');
    const metal14 = getValue('[data-metal-14]');
    const metalPlatinum = getValue('[data-metal-platinum]');
    const stoneNatural = getValue('[data-stone-natural]');
    const stoneLab = getValue('[data-stone-lab]');

    const params = new URLSearchParams(window.location.search);
    const metalMode = params.get('metal') || '14k';
    const stoneMode = params.get('stone') || 'natural';
    const metalLabel = metalMode === 'platinum' ? metalPlatinum : metalMode === '14k' ? metal14 : metal18;
    const stoneLabel = stoneMode === 'lab' ? stoneLab : stoneNatural;

    if (selectionSummary) {
      const parts = [];
      if (metalLabel) parts.push(`Metal: ${metalLabel}`);
      if (stoneLabel) parts.push(`Stone: ${stoneLabel}`);
      selectionSummary.textContent = parts.length ? parts.join(' â€¢ ') : 'Selections will appear here.';
    }

    const sizeFields = Array.prototype.slice.call(form.querySelectorAll('[data-size-field]'));
    const normalizeCategory = (value) => (value || '').toLowerCase().trim();
    const isIn = (value, list) => list.indexOf(value) >= 0;
    const category = normalizeCategory(categoryRaw);
    const categoryKey = category.split('/').pop() || '';
    const resolveSizeKey = () => {
      if (isIn(categoryKey, ['ring', 'rings', 'band', 'bands'])) return 'ring';
      if (isIn(categoryKey, ['bracelet', 'bracelets'])) return 'bracelet';
      if (isIn(categoryKey, ['necklace', 'necklaces', 'pendant', 'pendants'])) return 'necklace';
      if (isIn(categoryKey, ['earring', 'earrings'])) return 'earrings';
      if (isIn(categoryKey, ['set', 'sets'])) return 'generic';
      return 'generic';
    };
    const sizeKey = resolveSizeKey();
    const getSizeInput = (field) => field.querySelector('[data-size-input]');
    sizeFields.forEach((field) => {
      const key = field.getAttribute('data-size-field') || '';
      const show = key === sizeKey;
      field.classList.toggle('hidden', !show);
      const input = getSizeInput(field);
      if (input) {
        if (show) {
          input.setAttribute('required', 'true');
        } else {
          input.removeAttribute('required');
        }
      }
    });

    const statusEl = form.querySelector('[data-status]');
    const submitBtn = form.querySelector('[data-submit]');

    const requestId = () => {
      const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let id = '';
      for (let i = 0; i < 6; i += 1) {
        id += alphabet[Math.floor(Math.random() * alphabet.length)];
      }
      return id;
    };

    const getTurnstileToken = () => {
      const tokenEl = form.querySelector('[name="cf-turnstile-response"]');
      return tokenEl ? (tokenEl.value || '').trim() : '';
    };

    const setStatus = (message, isError) => {
      if (!statusEl) return;
      statusEl.textContent = message;
      statusEl.classList.remove('hidden');
      statusEl.classList.toggle('text-red-600', Boolean(isError));
    };

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const activeField = sizeFields.find((field) => !field.classList.contains('hidden'));
      const activeInput = activeField ? getSizeInput(activeField) : null;
      const sizeLabelEl = activeField ? activeField.querySelector('span') : null;
      const sizeLabel = sizeLabelEl ? sizeLabelEl.textContent || 'Sizing' : 'Sizing';
      const nameField = form.querySelector('[data-field="name"]');
      const emailField = form.querySelector('[data-field="email"]');
      const phoneField = form.querySelector('[data-field="phone"]');
      const size = activeInput ? String(activeInput.value || '').trim() : '';
      const name = nameField ? String(nameField.value || '').trim() : '';
      const email = emailField ? String(emailField.value || '').trim() : '';
      const phone = phoneField ? String(phoneField.value || '').trim() : '';

      if (!size || !name || !email) {
        setStatus('Please complete sizing, name, and email before sending.', true);
        return;
      }

      if (turnstileSiteKey && !getTurnstileToken()) {
        setStatus('Please complete the verification step before sending.', true);
        return;
      }

      const id = requestId();
      const subject = `Heerawalla quote request: ${productName} [HW-REQ:${id}]`;
      const lines = [
        `Name: ${name}`,
        `Email: ${email}`,
        phone ? `Phone: ${phone}` : '',
        designCode ? `Design code: ${designCode}` : '',
        metalLabel ? `Metal: ${metalLabel}` : '',
        stoneLabel ? `Stone: ${stoneLabel}` : '',
        `${sizeLabel}: ${size}`,
        `Heerawalla Request ID: ${id}`,
        productUrl ? `Product link: ${productUrl}` : ''
      ].filter(Boolean);
      const body = lines.join('\n');

      if (submitBtn) submitBtn.setAttribute('disabled', 'true');
      setStatus('Sending your request...', false);

      try {
        const response = await fetch('https://herawalla-email-atelier.arifmanasiya.workers.dev/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            subject,
            body,
            email,
            name,
            requestId: id,
            turnstileToken: getTurnstileToken()
          })
        });
        const result = await response.json();
        if (!response.ok || !result.ok) {
          throw new Error(result.error || 'send_failed');
        }
        setStatus('Request received. Please check your email for confirmation.', false);
      } catch (error) {
        setStatus('We could not send your request. Please try again.', true);
        if (submitBtn) submitBtn.removeAttribute('disabled');
      }
    });
  })();
</script>

{turnstileSiteKey ? (
  <script is:inline src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
) : null}
