---
import type { ProductWithMedia } from '../lib/products';
import { withBase } from '../lib/paths';
const { product, showThumbnails = false } = Astro.props as {
  product: ProductWithMedia;
  showThumbnails?: boolean;
};
const rawImage = product.media.images[0]?.url;
const fallback = withBase('/images/products/placeholder.svg');
const image = rawImage ? rawImage : fallback;
const thumbnails = showThumbnails ? product.media.images.slice(1) : [];
const visibleThumbs = showThumbnails ? thumbnails.slice(0, 4) : [];
const hasThumbs = showThumbnails && visibleThumbs.length > 0;
const hasMoreThumbs = showThumbnails && thumbnails.length > 4;
const usdFormatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
const parseList = (value?: string) => {
  if (!value) return [];
  return value
    .split('|')
    .map((item) => item.trim())
    .filter(Boolean);
};
const normalizeStoneType = (value: string) =>
  value
    .replace(/diamond\(s\)/gi, 'Diamond')
    .replace(/diamonds?\b/gi, 'Diamond')
    .replace(/\s+/g, ' ')
    .trim();
const roundTo99 = (value: number) => {
  if (!Number.isFinite(value)) return value;
  const lower = Math.floor(value / 100) * 100 + 99;
  const upper = Math.ceil(value / 100) * 100 + 99;
  return Math.abs(value - lower) <= Math.abs(value - upper) ? lower : upper;
};
const applyDiscount = (value: number, pct?: number) => {
  const ratio = 1 + (pct ?? 0) / 100;
  return Math.round(value * ratio * 100) / 100;
};
const baseUsd = product.price_usd_natural;
const labDiscountPct = product.lab_discount_pct ?? -20;
const metal14DiscountPct = product.metal_14k_discount_pct ?? -5;
const platinumPremiumPct = product.metal_platinum_premium ?? 10;
const stoneTypes = parseList(product.stone_types).map(normalizeStoneType).filter(Boolean);
const naturalAvailable = stoneTypes.some((item) => /natural/i.test(item));
const labAvailable = stoneTypes.some((item) => /lab/i.test(item));
const priceOptions: Array<{ label: string; price: number }> = [];
if (naturalAvailable) {
  priceOptions.push({ label: '18K Natural', price: roundTo99(baseUsd) });
  priceOptions.push({
    label: '14K Natural',
    price: roundTo99(applyDiscount(baseUsd, metal14DiscountPct))
  });
  priceOptions.push({
    label: 'Platinum Natural',
    price: roundTo99(applyDiscount(baseUsd, platinumPremiumPct))
  });
}
if (labAvailable) {
  const labUsd = applyDiscount(baseUsd, labDiscountPct);
  priceOptions.push({ label: '18K Lab Grown', price: roundTo99(labUsd) });
  priceOptions.push({
    label: '14K Lab Grown',
    price: roundTo99(applyDiscount(labUsd, metal14DiscountPct))
  });
  priceOptions.push({
    label: 'Platinum Lab Grown',
    price: roundTo99(applyDiscount(labUsd, platinumPremiumPct))
  });
}
const startingPrice = priceOptions.length
  ? priceOptions.reduce((best, option) => (option.price < best.price ? option : best))
  : { label: '18K Natural', price: roundTo99(baseUsd) };
const editionLabel = (() => {
  const category = product.category || '';
  const group = category.split('/')[0] || '';
  if (group === 'women') return "Women's Edition";
  if (group === 'men') return "Men's Edition";
  if (group === 'unisex') return 'Unisex Edition';
  return product.collection || product.category || '';
})();
const formatCarat = (value: number | undefined) => {
  if (!value || Number.isNaN(value)) return '';
  if (Number.isInteger(value)) return value.toString();
  return value.toString();
};
const formatWeight = (value: number | undefined) => {
  if (!value || Number.isNaN(value)) return '';
  if (Number.isInteger(value)) return value.toString();
  return value.toString();
};
const normalizeMetalLabel = (value: string | undefined) => {
  if (!value) return '18K Gold';
  return value.replace(/\s+/g, ' ').trim();
};
const clarityToMarketing = (value: string | undefined) => {
  if (!value) return '';
  const normalized = value.toLowerCase();
  if (normalized.includes('vvs1') && normalized.includes('vvs2')) {
    return 'excellent clarity (VVS1 or VVS2)';
  }
  if (normalized.includes('vvs')) {
    return 'excellent clarity (VVS)';
  }
  return value;
};
const cutToMarketing = (value: string | undefined) => {
  if (!value) return '';
  return `excellent cut${value ? ` (${value})` : ''}`;
};
const colorToMarketing = (value: string | undefined) => {
  if (!value) return '';
  return `color grade ${value.replace('/', ' or ')}`;
};
const buildEstimateTooltip = () => {
  const sections: Array<{ label: string; text?: string; items?: string[] }> = [];
  const ariaParts: string[] = [];
  const diamondParts: string[] = [];
  const clarity = clarityToMarketing(product.clarity);
  const cut = cutToMarketing(product.cut);
  const color = colorToMarketing(product.color);
  if (clarity) diamondParts.push(clarity);
  if (cut) diamondParts.push(cut);
  if (color) diamondParts.push(color);

  const stoneWeight = product.stone_weight ?? product.carat;
  const caratText = formatCarat(stoneWeight);
  const diamondQualityText = diamondParts.length
    ? caratText
      ? `${caratText}ct TW, IGI-certified, ${diamondParts.join(', ')}`
      : `IGI-certified, ${diamondParts.join(', ')}`
    : '';
  if (diamondQualityText) {
    sections.push({ label: 'Diamond Quality', text: diamondQualityText });
    ariaParts.push(`Diamond Quality. ${diamondQualityText}.`);
  }

  if (stoneTypes.length) {
    sections.push({ label: 'Diamond Options', items: stoneTypes });
    ariaParts.push(`Diamond Options. ${stoneTypes.join('; ')}.`);
  }

  const metal18Label = normalizeMetalLabel(product.metal);
  const metal14Label = metal18Label.replace(/18K/gi, '14K');
  const metalPlatinumLabel = 'Platinum';
  const metalOptionItems = Array.from(
    new Set([metal18Label, metal14Label, metalPlatinumLabel].filter(Boolean))
  );
  const metalWeightText = formatWeight(product.metal_weight);
  if (metalWeightText) {
    metalOptionItems.push(`Approx. metal weight: ${metalWeightText}g`);
  }
  if (metalOptionItems.length) {
    sections.push({ label: 'Metal Options', items: metalOptionItems });
    ariaParts.push(`Metal Options. ${metalOptionItems.join('; ')}.`);
  }

  if (priceOptions.length) {
    const optionItems = priceOptions.map(
      (option) => `${option.label}: ${usdFormatter.format(option.price)}`
    );
    sections.push({ label: 'Price Options', items: optionItems });
    ariaParts.push(`Price Options. ${optionItems.join('; ')}.`);
  }

  if (!sections.length) return { sections: [], ariaLabel: '' };
  return { sections, ariaLabel: ariaParts.join(' ') };
};
const estimateTooltip = buildEstimateTooltip();
---

<article
  class="card overflow-hidden group h-full flex flex-col"
  data-thumb-layout="column"
  data-thumb-layout-locked="true"
>
  <div class="thumb-media flex items-stretch gap-2 sm:gap-3 bg-white" data-thumb-media>
    {hasThumbs ? (
      <div class="thumb-strip-wrap relative overflow-hidden" data-thumb-strip-wrap>
        <div
          class="thumb-strip flex shrink-0 flex-col gap-2 sm:gap-3 pr-2"
          data-thumb-strip
        >
          {visibleThumbs.map((thumb, index) => (
            <button
              type="button"
              class="thumb-button h-16 w-16 sm:h-20 sm:w-20 border border-slate-200 bg-white overflow-hidden focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ink focus-visible:ring-offset-2 focus-visible:ring-offset-white"
              data-thumb-src={thumb.url}
              aria-pressed="false"
            >
              <img
                src={thumb.url}
                alt={`${product.name} thumbnail ${index + 1}`}
                loading="lazy"
                decoding="async"
                fetchpriority="low"
                class="h-full w-full object-contain bg-white"
                data-protected-image
              />
            </button>
          ))}
        </div>
        {hasMoreThumbs ? (
          <a
            href={withBase(`/product/${product.slug}`)}
            class="thumb-more absolute bottom-2 right-2 inline-flex h-7 w-7 items-center justify-center rounded-full border border-slate-200 bg-white/95 text-[11px] text-slate-600 shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ink focus-visible:ring-offset-2 focus-visible:ring-offset-white"
            aria-label="View full gallery"
            title="Click to see all images and product details"
          >
            <span aria-hidden="true">â†’</span>
          </a>
        ) : null}
      </div>
    ) : null}
    <a
      href={withBase(`/product/${product.slug}`)}
      class="thumb-main flex-1 flex items-stretch justify-end overflow-hidden"
      data-thumb-main
    >
      <div class="aspect-[3/4] w-full bg-white">
        <img
          src={image}
          alt={product.name}
          loading="lazy"
          decoding="async"
          fetchpriority="low"
          sizes="(min-width: 1024px) 33vw, (min-width: 640px) 50vw, 100vw"
          class="h-full w-full object-contain object-center transition duration-300 group-hover:scale-[1.02]"
          data-main-image
          data-default-src={image}
          data-protected-image
        />
      </div>
    </a>
  </div>
  <div class="flex flex-col gap-2 p-4 flex-1">
    <div class="text-xs uppercase tracking-[0.12em] text-slate-500">{editionLabel}</div>
    <div class="flex items-start justify-between gap-3">
      <a href={`/product/${product.slug}`} class="text-lg font-semibold leading-snug hover:text-accent">
        {product.name}
      </a>
      <span class="flex items-center gap-2">
        <span class="text-xs uppercase tracking-[0.18em] text-slate-500 whitespace-nowrap">
          {`Starting ${usdFormatter.format(startingPrice.price)}`}
        </span>
        {estimateTooltip.sections.length ? (
          <button
            type="button"
            class="estimate-info"
            aria-label={estimateTooltip.ariaLabel}
          >
            i
            <span class="estimate-tooltip" role="tooltip">
              {estimateTooltip.sections.map((section) => (
                <span class="estimate-tooltip__section">
                  <span class="estimate-tooltip__label">{section.label}</span>
                  {section.text ? (
                    <span class="estimate-tooltip__text">{section.text}</span>
                  ) : null}
                  {section.items?.length ? (
                    <span class="estimate-tooltip__list">
                      {section.items.map((item) => (
                        <span class="estimate-tooltip__item">{item}</span>
                      ))}
                    </span>
                  ) : null}
                </span>
              ))}
            </span>
          </button>
        ) : null}
      </span>
    </div>
    <p class="text-sm text-slate-500 line-clamp-2">{product.description}</p>
    <div class="mt-auto pt-2"></div>
  </div>
</article>

<script is:inline>
  (() => {
    if (window.__hwThumbInit) return;
    window.__hwThumbInit = true;

    const initLayout = (main) => {
      const card = main.closest('article');
      if (!card || card.dataset.thumbLayoutLocked === 'true') return;
      const apply = () => {
        if (card.dataset.thumbLayoutLocked === 'true') return;
        if (!main.naturalWidth || !main.naturalHeight) return;
        const layout = main.naturalHeight > main.naturalWidth ? 'row' : 'column';
        card.setAttribute('data-thumb-layout', layout);
        card.dataset.thumbLayoutLocked = 'true';
      };
      if (main.complete && main.naturalWidth) {
        apply();
      } else {
        main.addEventListener('load', apply, { once: true });
      }
    };

    document.querySelectorAll('[data-main-image]').forEach((main) => {
      initLayout(main);
    });

    const resetThumb = (card) => {
      if (!card) return;
      const main = card.querySelector('[data-main-image]');
      const defaultSrc = main?.getAttribute('data-default-src');
      if (!main || !defaultSrc) return;
      if (main.getAttribute('src') === defaultSrc) return;
      main.setAttribute('src', defaultSrc);
      card.querySelectorAll('[data-thumb-src]').forEach((el) => {
        el.setAttribute('aria-pressed', 'false');
        el.classList.remove('ring-1', 'ring-ink');
      });
      delete card.dataset.thumbLocked;
    };

    const applyThumb = (button) => {
      const card = button.closest('[data-product-card]') || button.closest('article');
      if (!card) return;
      const main = card.querySelector('[data-main-image]');
      const nextSrc = button.getAttribute('data-thumb-src');
      if (!main || !nextSrc) return;
      main.setAttribute('src', nextSrc);
      card.querySelectorAll('[data-thumb-src]').forEach((el) => {
        el.setAttribute('aria-pressed', String(el === button));
        el.classList.toggle('ring-1', el === button);
        el.classList.toggle('ring-ink', el === button);
      });
    };

    const applyThumbIfUnlocked = (button) => {
      const card = button.closest('[data-product-card]') || button.closest('article');
      if (!card) return;
      if (card.dataset.thumbLocked === 'true') return;
      applyThumb(button);
    };

    const toggleThumbLock = (button) => {
      const card = button.closest('[data-product-card]') || button.closest('article');
      if (!card) return;
      const isActive = button.getAttribute('aria-pressed') === 'true';
      const isLocked = card.dataset.thumbLocked === 'true';
      if (isLocked && isActive) {
        resetThumb(card);
        return;
      }
      applyThumb(button);
      card.dataset.thumbLocked = 'true';
    };

    const isTouch = window.matchMedia('(hover: none)').matches;

    document.addEventListener('mouseover', (event) => {
      const button = event.target.closest('[data-thumb-src]');
      if (!button) return;
      if (button.contains(event.relatedTarget)) return;
      applyThumbIfUnlocked(button);
    });

    document.addEventListener('focusin', (event) => {
      const button = event.target.closest('[data-thumb-src]');
      if (button) applyThumbIfUnlocked(button);
    });

    document.addEventListener('click', (event) => {
      const button = event.target.closest('[data-thumb-src]');
      if (!button) return;
      event.preventDefault();
      toggleThumbLock(button);
    });

    document.addEventListener('click', (event) => {
      const mainLink = event.target.closest('[data-thumb-main]');
      if (!mainLink || !isTouch) return;
      const card = mainLink.closest('[data-product-card]') || mainLink.closest('article');
      if (!card || card.dataset.thumbLocked !== 'true') return;
      event.preventDefault();
      resetThumb(card);
    });

    document.addEventListener('mouseout', (event) => {
      const strip = event.target.closest('[data-thumb-strip]');
      if (!strip) return;
      if (strip.contains(event.relatedTarget)) return;
      const card = strip.closest('[data-product-card]') || strip.closest('article');
      if (card?.dataset.thumbLocked === 'true') return;
      resetThumb(card);
    });

    document.addEventListener('focusout', (event) => {
      const strip = event.target.closest('[data-thumb-strip]');
      if (!strip) return;
      if (strip.contains(event.relatedTarget)) return;
      const card = strip.closest('[data-product-card]') || strip.closest('article');
      if (card?.dataset.thumbLocked === 'true') return;
      resetThumb(card);
    });

    })();
</script>

<style is:global>
  [data-thumb-layout='column'] [data-thumb-media] {
    flex-direction: row;
  }

  [data-thumb-layout='row'] [data-thumb-media] {
    flex-direction: column;
  }

  [data-thumb-layout='column'] [data-thumb-strip-wrap] {
    width: 4rem;
    overflow: hidden;
    flex: 0 0 auto;
    align-self: stretch;
  }

  [data-thumb-layout='column'] [data-thumb-strip] {
    width: 4rem;
    flex-direction: column;
    padding: 0.5rem 0 0.5rem 0.5rem;
    height: 100%;
    overflow-y: hidden;
    overflow-x: hidden;
    scrollbar-width: none;
  }

  [data-thumb-layout='column'] [data-thumb-strip]::-webkit-scrollbar {
    display: none;
  }

  [data-thumb-layout='row'] [data-thumb-strip-wrap] {
    width: calc((4rem * 3) + (0.5rem * 2));
    overflow: hidden;
    flex: 0 0 auto;
    align-self: flex-start;
  }

  [data-thumb-layout='row'] [data-thumb-strip] {
    width: 100%;
    flex-direction: row;
    flex-wrap: nowrap;
    padding: 0.5rem 0.75rem 0.75rem;
    max-width: calc((4rem * 3) + (0.5rem * 2));
    overflow-x: auto;
    overflow-y: hidden;
    scrollbar-width: none;
  }

  [data-thumb-layout='row'] [data-thumb-strip]::-webkit-scrollbar {
    display: none;
  }

  @media (min-width: 640px) {
    [data-thumb-layout='column'] [data-thumb-strip-wrap] {
      width: 5rem;
    }

    [data-thumb-layout='column'] [data-thumb-strip] {
      width: 5rem;
      padding: 0.75rem 0 0.75rem 0.75rem;
      height: 100%;
    }

    [data-thumb-layout='row'] [data-thumb-strip-wrap] {
      width: calc((6rem * 3) + (0.5rem * 2));
    }

    [data-thumb-layout='row'] [data-thumb-strip] {
      padding: 0.75rem;
      max-width: calc((5rem * 3) + (0.75rem * 2));
    }

  }

  [data-thumb-layout='row'] [data-thumb-main] {
    order: 1;
    justify-content: center;
  }

  [data-thumb-layout='row'] [data-thumb-strip] {
    order: 2;
  }
</style>
