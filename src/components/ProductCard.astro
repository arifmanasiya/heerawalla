---
import type { ProductWithMedia } from '../lib/products';
import { withBase } from '../lib/paths';
const { product } = Astro.props as { product: ProductWithMedia };
const rawImage = product.media.images[0]?.url;
const fallback = withBase('/images/products/placeholder.svg');
const image = rawImage ? rawImage : fallback;
const thumbnails = product.media.images.slice(1, 4);
const hasThumbs = thumbnails.length > 0;
---

<article class="card overflow-hidden group h-full flex flex-col" data-thumb-layout="column">
  <div class="thumb-media flex gap-2 sm:gap-3 bg-white" data-thumb-media>
    {hasThumbs ? (
      <div
        class="thumb-strip flex shrink-0 gap-2 sm:gap-3"
        data-thumb-strip
      >
        {thumbnails.map((thumb, index) => (
          <button
            type="button"
            class="thumb-button border border-slate-200 bg-white overflow-hidden focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ink focus-visible:ring-offset-2 focus-visible:ring-offset-white"
            data-thumb-src={thumb.url}
            aria-pressed="false"
          >
            <img
              src={thumb.url}
              alt={`${product.name} thumbnail ${index + 1}`}
              loading="lazy"
              class="h-full w-full object-contain bg-white"
            />
          </button>
        ))}
      </div>
    ) : null}
    <a
      href={withBase(`/product/${product.slug}`)}
      class="thumb-main flex-1 flex items-center justify-end overflow-hidden"
      data-thumb-main
    >
      <div class="aspect-square w-full bg-white">
        <img
          src={image}
          alt={product.name}
          loading="lazy"
          class="h-full w-full object-contain object-right transition duration-300 group-hover:scale-[1.02]"
          data-main-image
          data-default-src={image}
        />
      </div>
    </a>
  </div>
  <div class="flex flex-col gap-2 p-4 flex-1">
    <div class="text-xs uppercase tracking-[0.12em] text-slate-500">{product.collection || product.category}</div>
    <a href={`/product/${product.slug}`} class="text-lg font-semibold leading-snug hover:text-accent">
      {product.name}
    </a>
    <p class="text-sm text-slate-500 line-clamp-2">{product.description}</p>
    <div class="mt-auto flex items-center justify-between pt-2">
      <span
        class="font-semibold text-sm"
        data-price-inr={product.price_inr_natural}
      ></span>
      <span class="text-xs uppercase tracking-[0.14em] text-slate-400">{product.metal}</span>
    </div>
  </div>
</article>

<script is:inline>
  (() => {
    if (window.__hwThumbInit) return;
    window.__hwThumbInit = true;

    const initLayout = (main) => {
      const card = main.closest('article');
      if (!card || card.dataset.thumbLayoutLocked === 'true') return;
      const apply = () => {
        if (card.dataset.thumbLayoutLocked === 'true') return;
        if (!main.naturalWidth || !main.naturalHeight) return;
        const layout = main.naturalHeight > main.naturalWidth ? 'row' : 'column';
        card.setAttribute('data-thumb-layout', layout);
        card.dataset.thumbLayoutLocked = 'true';
      };
      if (main.complete && main.naturalWidth) {
        apply();
      } else {
        main.addEventListener('load', apply, { once: true });
      }
    };

    document.querySelectorAll('[data-main-image]').forEach((main) => {
      initLayout(main);
    });

    const applyThumb = (button) => {
      const card = button.closest('[data-product-card]') || button.closest('article');
      if (!card) return;
      const main = card.querySelector('[data-main-image]');
      const nextSrc = button.getAttribute('data-thumb-src');
      if (!main || !nextSrc) return;
      if (main.getAttribute('src') === nextSrc) return;
      main.setAttribute('src', nextSrc);
      card.querySelectorAll('[data-thumb-src]').forEach((el) => {
        el.setAttribute('aria-pressed', String(el === button));
        el.classList.toggle('ring-1', el === button);
        el.classList.toggle('ring-ink', el === button);
      });
    };

    const resetThumb = (card) => {
      if (!card) return;
      const main = card.querySelector('[data-main-image]');
      const defaultSrc = main?.getAttribute('data-default-src');
      if (!main || !defaultSrc) return;
      if (main.getAttribute('src') === defaultSrc) return;
      main.setAttribute('src', defaultSrc);
      card.querySelectorAll('[data-thumb-src]').forEach((el) => {
        el.setAttribute('aria-pressed', 'false');
        el.classList.remove('ring-1', 'ring-ink');
      });
    };

    document.addEventListener('click', (event) => {
      const button = event.target.closest('[data-thumb-src]');
      if (button) applyThumb(button);
    });

    document.addEventListener('pointerover', (event) => {
      const button = event.target.closest('[data-thumb-src]');
      if (button) applyThumb(button);
    });

    document.addEventListener('focusin', (event) => {
      const button = event.target.closest('[data-thumb-src]');
      if (button) applyThumb(button);
    });

    document.addEventListener('pointerout', (event) => {
      const strip = event.target.closest('[data-thumb-strip]');
      if (!strip) return;
      if (event.pointerType && event.pointerType !== 'mouse' && event.pointerType !== 'pen') return;
      if (strip.contains(event.relatedTarget)) return;
      const card = strip.closest('[data-product-card]') || strip.closest('article');
      resetThumb(card);
    });

    document.addEventListener('focusout', (event) => {
      const strip = event.target.closest('[data-thumb-strip]');
      if (!strip) return;
      if (strip.contains(event.relatedTarget)) return;
      const card = strip.closest('[data-product-card]') || strip.closest('article');
      resetThumb(card);
    });
  })();
</script>

<style is:global>
  [data-thumb-layout='column'] [data-thumb-media] {
    flex-direction: row;
  }

  [data-thumb-layout='row'] [data-thumb-media] {
    flex-direction: column;
  }

  [data-thumb-layout='column'] [data-thumb-strip] {
    width: 5rem;
    flex-direction: column;
    padding: 0.5rem 0 0.5rem 0.5rem;
  }

  [data-thumb-layout='row'] [data-thumb-strip] {
    width: 100%;
    flex-direction: row;
    flex-wrap: wrap;
    padding: 0.5rem 0.75rem 0.75rem;
  }

  [data-thumb-layout='column'] [data-thumb-strip] .thumb-button {
    width: 100%;
    height: 5rem;
  }

  [data-thumb-layout='row'] [data-thumb-strip] .thumb-button {
    width: 5rem;
    height: 5rem;
  }

  @media (min-width: 640px) {
    [data-thumb-layout='column'] [data-thumb-strip] {
      width: 6rem;
      padding: 0.75rem 0 0.75rem 0.75rem;
    }

    [data-thumb-layout='row'] [data-thumb-strip] {
      padding: 0.75rem;
    }

    [data-thumb-layout='column'] [data-thumb-strip] .thumb-button {
      height: 6rem;
    }

    [data-thumb-layout='row'] [data-thumb-strip] .thumb-button {
      width: 6rem;
      height: 6rem;
    }
  }

  [data-thumb-layout='row'] [data-thumb-main] {
    order: 1;
    justify-content: center;
  }

  [data-thumb-layout='row'] [data-thumb-strip] {
    order: 2;
  }
</style>
