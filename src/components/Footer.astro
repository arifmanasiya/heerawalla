---
import { withBase } from '../lib/paths';
import { loadSiteConfig, getConfigValue } from '../lib/config';

const config = await loadSiteConfig();
const atelierApiBase = getConfigValue(
  config,
  'atelier_api_base',
  'https://herawalla-email-atelier.arifmanasiya.workers.dev'
);
const joinInterests = [
  { value: 'Design codes - Men', label: 'Design codes (Men)' },
  { value: 'Design codes - Women', label: 'Design codes (Women)' },
  { value: 'Inspirations', label: 'Inspirations' },
  { value: 'Bespoke & Custom', label: 'Bespoke & Custom' },
  { value: 'Drops & Events', label: 'Drops & Events' },
];
---

<footer class="mt-16 border-t border-slate-200 bg-white">
  <div class="container py-10 grid gap-8 md:grid-cols-4">
    <div class="space-y-3">
      <a href={withBase('/')} class="text-lg font-semibold tracking-tight hover:text-accent">Heerawalla</a>
      <p class="text-sm text-slate-500">Timeless pieces crafted with precision and care.</p>
      <svg
        viewBox="0 0 128 128"
        class="h-6 w-6 text-ink/70"
        aria-hidden="true"
      >
        <circle cx="64" cy="64" r="46" stroke="currentColor" stroke-width="10" fill="none"/>
        <line x1="64" y1="10" x2="64" y2="118" stroke="currentColor" stroke-width="9" stroke-linecap="round"/>
      </svg>
    </div>
    <div>
      <div class="text-sm font-semibold mb-3">Explore</div>
      <ul class="space-y-2 text-sm text-slate-600">
        <li><a href={withBase('/inspirations')} class="hover:text-accent">Inspirations</a></li>
        <li><a href={withBase('/about')} class="hover:text-accent">About</a></li>
      </ul>
    </div>
    <div>
      <div class="text-sm font-semibold mb-3">Support</div>
      <ul class="space-y-2 text-sm text-slate-600">
        <li><a href={withBase('/policies')} class="hover:text-accent">Policies</a></li>
        <li><a href={withBase('/faq')} class="hover:text-accent">FAQ</a></li>
        <li><a href={withBase('/sizing')} class="hover:text-accent">Sizing Guide</a></li>
        <li><a href={withBase('/diamond-quality')} class="hover:text-accent">Diamond Quality Guide</a></li>
        <li><a href={withBase('/gold-purity')} class="hover:text-accent">Gold Purity Guide</a></li>
        <li><a href={withBase('/jewelry-care')} class="hover:text-accent">Jewelry Care</a></li>
        <li><a href={withBase('/contact')} class="hover:text-accent">Contact</a></li>
      </ul>
    </div>
    <div class="space-y-3">
      <div class="text-sm font-semibold">Newsletter</div>
      <p class="text-sm text-slate-500">Sign up to hear about limited drops and bespoke services.</p>
      <form class="space-y-3" data-join-form data-atelier-api={atelierApiBase}>
        <label class="text-xs uppercase tracking-[0.2em] text-slate-500">
          Email
          <input
            type="email"
            name="email"
            required
            class="mt-2 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm normal-case tracking-normal text-ink"
            placeholder="you@example.com"
            data-join-email
          />
        </label>
        <label class="text-xs uppercase tracking-[0.2em] text-slate-500">
          Phone (optional)
          <input
            type="tel"
            name="phone"
            class="mt-2 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm normal-case tracking-normal text-ink"
            placeholder="+1 312 555 0198"
            data-join-phone
          />
        </label>
        <fieldset class="space-y-2">
          <legend class="text-xs uppercase tracking-[0.2em] text-slate-500">Design interests</legend>
          <div class="grid gap-2 text-sm text-slate-600">
            {joinInterests.map((option) => (
              <label class="flex items-center gap-2">
                <input type="checkbox" value={option.value} class="h-4 w-4" data-join-interest />
                {option.label}
              </label>
            ))}
          </div>
        </fieldset>
        <div class="flex items-center gap-3">
          <button type="submit" class="btn btn-primary" data-join-submit>Join</button>
          <p class="text-xs text-slate-500" data-join-status></p>
        </div>
      </form>
    </div>
  </div>
<div class="border-t border-slate-200 py-4 text-center text-xs text-slate-500">&copy; {new Date().getFullYear()} Heerawalla. All rights reserved.</div>
</footer>

<script is:inline>
  (() => {
    const form = document.querySelector('[data-join-form]');
    if (!form) return;
    const emailInput = form.querySelector('[data-join-email]');
    const phoneInput = form.querySelector('[data-join-phone]');
    const interestInputs = Array.from(form.querySelectorAll('[data-join-interest]'));
    const submitButton = form.querySelector('[data-join-submit]');
    const status = form.querySelector('[data-join-status]');
    const apiBase = form.getAttribute('data-atelier-api') || '';

    const setStatus = (message) => {
      if (status) status.textContent = message;
    };

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const email = emailInput?.value.trim() || '';
      const phone = phoneInput?.value.trim() || '';
      const interests = interestInputs.filter((input) => input.checked).map((input) => input.value);

      if (!email) {
        setStatus('Email is required.');
        return;
      }
      if (!interests.length) {
        setStatus('Select at least one interest.');
        return;
      }
      if (!apiBase) {
        setStatus('Join service is unavailable.');
        return;
      }

      if (submitButton) submitButton.setAttribute('disabled', 'true');
      setStatus('Submitting...');
      try {
        const response = await fetch(`${apiBase.replace(/\/$/, '')}/subscribe`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email,
            phone,
            interests,
            source: 'newsletter',
            pageUrl: window.location.href,
          }),
        });
        if (!response.ok) {
          setStatus('Unable to join right now.');
          return;
        }
        form.reset();
        setStatus('Thanks. You are on the list.');
      } catch {
        setStatus('Unable to join right now.');
      } finally {
        if (submitButton) submitButton.removeAttribute('disabled');
      }
    });
  })();
</script>
